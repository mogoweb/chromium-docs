<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/WebPage">
<head>
<meta http-equiv="X-UA-Compatible" content="chrome=1" />
<script type="text/javascript">/* Copyright 2008 Google. */ (function() { var e="wtsrt_",g="tbsd_",h="tbnd_",k="start",l="_wtsrt",m="_tbnd",n="CSI/";(function(){function f(a){this.t={};this.tick=function(a,c,b){this.t[a]=[void 0!=b?b:(new Date).getTime(),c];if(void 0==b)try{window.console.timeStamp(n+a)}catch(d){}};this.tick(k,null,a)}var a;window.performance&&(a=window.performance.timing);var p=a?new f(a.responseStart):new f;window.jstiming={Timer:f,load:p};if(a){var c=a.navigationStart,d=a.responseStart;0<c&&d>=c&&(window.jstiming.srt=d-c)}if(a){var b=window.jstiming.load;0<c&&d>=c&&(b.tick(l,void 0,c),b.tick(e,l,d),b.tick(g,e))}try{a=null,
window.chrome&&window.chrome.csi&&(a=Math.floor(window.chrome.csi().pageT),b&&0<c&&(b.tick(m,void 0,window.chrome.csi().startE),b.tick(h,m,c))),null==a&&window.gtbExternal&&(a=window.gtbExternal.pageT()),null==a&&window.external&&(a=window.external.pageT,b&&0<c&&(b.tick(m,void 0,window.external.startE),b.tick(h,m,c))),a&&(window.jstiming.pt=a)}catch(q){}})(); })()
</script>
<link rel="shortcut icon" href="http://www.chromium.org/_/rsrc/1354323194313/favicon.ico" type="image/x-icon" />
<link rel="apple-touch-icon" href="http://www.gstatic.com/sites/p/56e332/system/app/images/apple-touch-icon.png" type="image/png" />
<script type="text/javascript">/* Copyright 2008 Google. */ (function() { var d="",g="__duration__",h="function";function k(c){return document.getElementById(c)}window.byId=k;function l(c){return c.replace(/^\s+|\s+$/g,d)}window.trim=l;var m=[],n=0;window.JOT_addListener=function(c,a,b){var e=new String(n++);c={eventName:c,handler:a,compId:b,key:e};m.push(c);return e};window.JOT_removeListenerByKey=function(c){for(var a=0;a<m.length;a++)if(m[a].key==c){m.splice(a,1);break}};
window.JOT_removeAllListenersForName=function(c){for(var a=0;a<m.length;a++)m[a].eventName==c&&m.splice(a,1)};window.JOT_postEvent=function(c,a,b){var e={eventName:c,eventSrc:a||{},payload:b||{}};if(window.JOT_fullyLoaded)for(a=m.length,b=0;b<a&&b<m.length;b++){var f=m[b];f&&f.eventName==c&&(e.listenerCompId=f.compId||d,(f=typeof f.handler==h?f.handler:window[f.handler])&&f(e))}else window.JOT_delayedEvents.push({eventName:c,eventSrc:a,payload:b})};window.JOT_delayedEvents=[];
window.JOT_fullyLoaded=!1;window.JOT_formatRelativeToNow=function(c,a){var b=((new Date).getTime()-c)/6E4;if(1440<=b||0>b)return null;var e=0;60<=b&&(b/=60,e=2);2<=b&&e++;return a?window.JOT_siteRelTimeStrs[e].replace(g,Math.floor(b)):window.JOT_userRelTimeStrs[e].replace(g,Math.floor(b))}; })()
</script>
<script>

  

  var breadcrumbs = [{"path":"/nativeclient","deleted":false,"title":"Native Client","dir":"ltr"},{"path":"/nativeclient/how-tos","deleted":false,"title":"2: How Tos","dir":"ltr"},{"path":"/nativeclient/how-tos/how-to-write-assembler-for-x86-nacl-platform","deleted":false,"title":"How to write assembler for x86 NaCl platform.","dir":"ltr"}];
  var JOT_clearDotPath = 'http://www.gstatic.com/sites/p/56e332/system/app/images/cleardot.gif';

  
  var JOT_userRelTimeStrs = ["a minute ago","__duration__ minutes ago","an hour ago","__duration__ hours ago"];

  
  

  

  var webspace = {"enableAnalytics":true,"pageSharingId":"jotspot_page","enableUniversalAnalytics":false,"sharingPolicy":"OPENED_WITH_INDICATOR","siteTitle":"The Chromium Projects","isStartPageEnabled":true,"adsensePublisherId":null,"features":{"languageSelectDefaultTextSetToDefault":true,"validateClientGvizDataSourceUrls":true,"moreMobileStyleImprovements":true,"newInsertMenuIcons":true,"accessibleSortingButtons":true,"domainAnalyticsInGAOnly":true,"noCaptcha":true,"fileCabinetScreenReaderFix":true,"updatedTosAndPrivacyLinks":null,"pageDrafts":false,"mobileOrientationFix":true,"plusBadge":false,"pdfEmbedSupport":false,"jsClickFix":true},"isPublic":true,"isConsumer":false,"serverFlags":{"cajaBaseUrl":"//www.gstatic.com/caja","cajaDebugMode":false},"onepickBaseUrl":"https://docs.google.com","domainAnalyticsAccountId":"","plusPageId":"","signInUrl":"https://www.google.com/a/SelectSession?continue\u003dhttp://sites.google.com/a/chromium.org/dev/nativeclient/how-tos/how-to-write-assembler-for-x86-nacl-platform\u0026service\u003djotspot","analyticsAccountId":"UA-5484340-1","scottyUrl":"/_/upload","homePath":"/","siteNoticeUrlEnabled":null,"plusPageUrl":"","adsensePromoClickedOrSiteIneligible":true,"csiReportUri":"http://csi.gstatic.com/csi","sharingId":"jotspot","termsUrl":"//www.google.com/intl/en/policies/terms/","gvizVersion":1,"editorResources":{"sitelayout":["http://www.gstatic.com/sites/p/56e332/system/app/css/sitelayouteditor.css"],"text":["http://www.gstatic.com/sites/p/56e332/system/js/codemirror.js","http://www.gstatic.com/sites/p/56e332/system/app/css/codemirror_css.css","http://www.gstatic.com/sites/p/56e332/system/js/trog_edit__en.js","http://www.gstatic.com/sites/p/56e332/system/app/css/trogedit.css","/_/rsrc/1441580320000/system/app/css/editor.css","http://www.gstatic.com/sites/p/56e332/system/app/css/codeeditor.css","/_/rsrc/1441580320000/system/app/css/camelot/editor-jfk-wlb.css"]},"sharingUrlPrefix":"/_/sharing","isAdsenseEnabled":true,"domain":"chromium.org","baseUri":"","name":"dev","siteTemplateId":false,"siteNoticeRevision":null,"siteNoticeUrlAddress":null,"siteNoticeMessage":null,"page":{"isRtlLocale":false,"canDeleteWebspace":null,"isPageDraft":null,"parentPath":"/nativeclient/how-tos","parentWuid":"wuid:gx:4d01c286433f1e06","siteLocale":"en","timeZone":"America/Los_Angeles","type":"text","title":"How to write assembler for x86 NaCl platform.","locale":"en","wuid":"wuid:gx:2d8613b25f3d6dc0","revision":10,"path":"/nativeclient/how-tos/how-to-write-assembler-for-x86-nacl-platform","isSiteRtlLocale":false,"pageInheritsPermissions":null,"name":"how-to-write-assembler-for-x86-nacl-platform","canChangePath":true,"state":"","properties":{},"bidiEnabled":false,"currentTemplate":{"path":"/system/app/pagetemplates/text","title":"Web Page"}},"canPublishScriptToAnyone":true,"user":{"keyboardShortcuts":true,"sessionIndex":"","guest_":true,"displayNameOrEmail":"guest","userName":"guest","uid":"","renderMobile":false,"domain":"","namespace":"","hasWriteAccess":false,"namespaceUser":false,"primaryEmail":"guest","hasAdminAccess":false},"gadgets":{"baseUri":"/system/app/pages/gadgets"}};
  webspace.page.breadcrumbs = breadcrumbs;

  
  var JOT_siteRelTimeStrs = ["a minute ago","__duration__ minutes ago","an hour ago","__duration__ hours ago"];

</script>
<script type="text/javascript">
                window.jstiming.load.tick('scl');
              </script>
<meta name="title" content="How to write assembler for x86 NaCl platform. - The Chromium Projects" />
<meta itemprop="name" content="How to write assembler for x86 NaCl platform. - The Chromium Projects" />
<meta property="og:title" content="How to write assembler for x86 NaCl platform. - The Chromium Projects" />
<meta name="description" content="Home of the Chromium Open Source Project" />
<meta itemprop="description" content="Home of the Chromium Open Source Project" />
<meta id="meta-tag-description" property="og:description" content="Home of the Chromium Open Source Project" />
<style type="text/css">
</style>
<link rel="stylesheet" type="text/css" href="http://www.gstatic.com/sites/p/56e332/system/app/themes/beigeandblue/standard-css-beigeandblue-ltr-ltr.css" />
<link rel="stylesheet" type="text/css" href="http://www.chromium.org/_/rsrc/1441580320000/system/app/css/overlay.css?cb=beigeandblueundefineda100%25%25150goog-ws-leftthemedefaultstandard" />
<link rel="stylesheet" type="text/css" href="http://www.chromium.org/_/rsrc/1441580320000/system/app/css/camelot/allthemes-view.css" />
<!--[if IE]>
          <link rel="stylesheet" type="text/css" href="/system/app/css/camelot/allthemes%2die.css" />
        <![endif]-->
<title>How to write assembler for x86 NaCl platform. - The Chromium Projects</title>
<meta itemprop="image" content="/_/rsrc/1438879449147/config/customLogo.gif?revision=3" />
<meta property="og:image" content="/_/rsrc/1438879449147/config/customLogo.gif?revision=3" />
<script type="text/javascript">
                window.jstiming.load.tick('cl');
              </script>
</head>
<body xmlns="http://www.google.com/ns/jotspot" id="body" class=" en            ">
<div id="sites-page-toolbar" class="sites-header-divider">
<div xmlns="http://www.w3.org/1999/xhtml" id="sites-status" class="sites-status" style="display:none;"><div id="sites-notice" class="sites-notice" role="status" aria-live="assertive"> </div></div>
</div>
<div id="sites-chrome-everything-scrollbar">
<div id="sites-chrome-everything" class="">
<div id="sites-chrome-page-wrapper" style="direction: ltr">
<div id="sites-chrome-page-wrapper-inside">
<div xmlns="http://www.w3.org/1999/xhtml" id="sites-chrome-header-wrapper" style="height:auto;">
<table id="sites-chrome-header" class="sites-layout-hbox" cellspacing="0" style="height:auto;">
<tr class="sites-header-primary-row" id="sites-chrome-userheader">
<td id="sites-header-title" class="" role="banner"><div class="sites-header-cell-buffer-wrapper"><a href="http://www.chromium.org/" id="sites-chrome-userheader-logo"><img id="logo-img-id" src="http://www.chromium.org/_/rsrc/1438879449147/config/customLogo.gif?revision=3" alt="The Chromium Projects" class="sites-logo  " /></a><h2><a href="http://www.chromium.org/" dir="ltr" id="sites-chrome-userheader-title">The Chromium Projects</a></h2></div></td><td class="sites-layout-searchbox  "><div class="sites-header-cell-buffer-wrapper"><form id="sites-searchbox-form" action="http://www.chromium.org/system/app/pages/search" role="search"><input type="hidden" id="sites-searchbox-scope" name="scope" value="search-site" /><input type="text" id="jot-ui-searchInput" name="q" size="20" value="" aria-label="Search this site" /><div id="sites-searchbox-button-set" class="goog-inline-block"><div role="button" id="sites-searchbox-search-button" class="goog-inline-block jfk-button jfk-button-standard" tabindex="0">Search this site</div></div></form></div></td>
</tr>
<tr class="sites-header-secondary-row" id="sites-chrome-horizontal-nav">
<td colspan="2" id="sites-chrome-header-horizontal-nav-container" role="navigation">
</td>
</tr>
</table>
</div>
<div id="sites-chrome-main-wrapper">
<div id="sites-chrome-main-wrapper-inside">
<table id="sites-chrome-main" class="sites-layout-hbox" cellspacing="0" cellpadding="{scmCellpadding}" border="0">
<tr>
<td id="sites-chrome-sidebar-left" class="sites-layout-sidebar-left initial" style="width:150px">
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_7648876402527094" class="sites-embed" role="navigation"><div class="sites-embed-content sites-sidebar-nav"><ul role="navigation" jotId="navList"><li class="nav-first "><div dir="ltr" style="padding-left: 5px;"><a href="http://www.chromium.org/chromium-projects" jotId="wuid:gx:10ae433dadbbab13" class="sites-navigation-link">Home</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="../../Home.html" jotId="wuid:gx:43582b9d2029d3af" class="sites-navigation-link">Chromium</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="../../chromium-os.html" jotId="wuid:gx:83df2ab1f8880ba" class="sites-navigation-link">Chromium OS</a></div></li></ul></div></div>
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_14720868319272995" class="sites-embed" role="navigation"><h4 class="sites-embed-title">Quick links</h4><div class="sites-embed-content sites-sidebar-nav"><ul role="navigation" jotId="navList"><li class="nav-first "><div dir="ltr" style="padding-left: 5px;"><a href="../../for-testers/bug-reporting-guidelines.html" class="sites-navigation-link">Report bugs</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="../../developers/discussion-groups.html" class="sites-navigation-link">Discuss</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="http://www.chromium.org/system/app/pages/sitemap/hierarchy" jotId="wuid:gx:4b58a9a350ad12f" class="sites-navigation-link">网站地图</a></div></li></ul></div></div>
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_19690813310444355" class="sites-embed" role="navigation"><h4 class="sites-embed-title">Other sites</h4><div class="sites-embed-content sites-sidebar-nav"><ul role="navigation" jotId="navList"><li class="nav-first "><div dir="ltr" style="padding-left: 5px;"><a href="http://blog.chromium.org/" class="sites-navigation-link">Chromium Blog</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="http://code.google.com/chrome/extensions/" class="sites-navigation-link">Google Chrome Extensions</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="https://developers.google.com/chrome/chrome-frame/" class="sites-navigation-link">Google Chrome Frame</a></div></li></ul></div></div>
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_19695218559354544" class="sites-embed" role="complementary"><h4 class="sites-embed-title"></h4><div class="sites-embed-content sites-embed-content-sidebar-textbox"><div dir="ltr"><span style="font-size:x-small">Except as otherwise </span><a href="http://developers.google.com/site-policies.html#restrictions"><span style="font-size:x-small">noted</span></a><span style="font-size:x-small">, the content of this page is licensed under a </span><a href="http://creativecommons.org/licenses/by/2.5/"><span style="font-size:x-small">Creative Commons Attribution 2.5 license</span></a><span style="font-size:x-small">, and examples are licensed under the </span><a href="http://src.chromium.org/viewvc/chrome/trunk/src/LICENSE" target="_blank"><span style="font-size:x-small">BSD License</span></a><span style="font-size:x-small">.<br /></span></div></div></div>
</td>
<td id="sites-canvas-wrapper">
<div id="sites-canvas" role="main">
<div id="goog-ws-editor-toolbar-container"> </div>
<div xmlns="http://www.w3.org/1999/xhtml" id="title-crumbs" style="">
<A href="../../nativeclient.html" dir="ltr">Native Client</A>‎ &gt; ‎<A href="http://www.chromium.org/nativeclient/how-tos" dir="ltr">2: How Tos</A>‎ &gt; ‎
  </div>
<h3 xmlns="http://www.w3.org/1999/xhtml" id="sites-page-title-header" style="" align="left">
<span id="sites-page-title" dir="ltr" tabindex="-1" style="outline: none">How to write assembler for x86 NaCl platform.</span>
</h3>
<div id="sites-canvas-main" class="sites-canvas-main">
<div id="sites-canvas-main-content">
<table xmlns="http://www.w3.org/1999/xhtml" cellspacing="0" class="sites-layout-name-one-column sites-layout-hbox"><tbody><tr><td class="sites-layout-tile sites-tile-name-content-1"><div dir="ltr"><div><span style="background-color:transparent;font-size:10pt">Before we'll go any further let me remid you that NaCl is OS-independent but CPU-dependent technology while pNaCl is both OS-independent and CPU-independent technology. Assembler is, of course, CPU-dependent and as such is not suitable for pNaCl.</span></div><div><br /></div><div>Ok. So we are dealing with NaCl and want to write some kind of assembler program.</div><div><br /></div><div>First of all, I don't plan to explain here how to write your program entirley in assembler languge.</div><div><br /></div><div>It's doable, but quite hard and rarely needed. I'll concentrate on a case of C/C++ program “with some assebler on the side”.</div><div><br /></div><div>Ok, so we want to call some assembler instruction not available via intrinsic. Let's use <font face="courier new, monospace">cpuid</font> for our simple example.</div><div><br /></div><div><font face="courier new, monospace">$ cat cpuid.c</font></div><div><font face="courier new, monospace">#include &lt;stdint.h&gt;</font></div><div><font face="courier new, monospace">#include &lt;stdio.h&gt;</font></div><div><font face="courier new, monospace"><br /></font></div><div><font face="courier new, monospace">int main() {</font></div><div><font face="courier new, monospace">  volatile uint32_t reg[4];</font></div><div><font face="courier new, monospace">  __asm__ __volatile__(</font></div><div><font face="courier new, monospace">      "cpuid"</font></div><div><font face="courier new, monospace">      : "=a"(reg[3]), "=b"(reg[0]), "=c"(reg[2]), "=d"(reg[1])</font></div><div><font face="courier new, monospace">      : "a"(0)</font></div><div><font face="courier new, monospace">      : "cc");</font></div><div><font face="courier new, monospace">  printf("%s\n", (char *)reg);</font></div><div><font face="courier new, monospace">}</font></div><div><font face="courier new, monospace">$ pepper_33/toolchain/linux_x86_newlib/bin/i686-nacl-gcc cpuid.c -o cpuid-32.nexe</font></div><div><font face="courier new, monospace">$ pepper_33/toolchain/linux_x86_newlib/bin/x86_64-nacl-gcc cpuid.c -o cpuid-64.nexe</font></div><div><font face="courier new, monospace">$ pepper_33/tools/sel_ldr.py cpuid-32.nexe</font></div><div><font face="courier new, monospace">DEBUG MODE ENABLED (bypass acl)</font></div><div><font face="courier new, monospace">GenuineIntel</font></div><div><font face="courier new, monospace">$ pepper_33/tools/sel_ldr.py cpuid-64.nexe</font></div><div><font face="courier new, monospace">DEBUG MODE ENABLED (bypass acl)</font></div><div><font face="courier new, monospace">GenuineIntel</font></div><div><br /></div><div>Looks like we can easily call <font face="courier new, monospace">cpuid</font> from our NaCl program. How cool is that? Well, cool enough to write some simple program. In 32 bit mode. If you are lucky. In 64 bit mode. If you <b>very</b> lucky.</div><div><br /></div><div>Why? It's easy: only provably safe code can be executed on NaCl platform. And sooner or later you'll write code which will be declared UNSAFE by NaCl and it'll refuse to run it. In particular NaCl does not allow you to use arbitrary instructions in your code. Only whitelisted “<span style="font-size:10pt;background-color:transparent">safe</span><span style="font-size:10pt;background-color:transparent">”</span> instructions are allowed.</div><div><br /></div><div>Where is the list of safe instructions? <a href="https://codereview.chromium.org/49183002/patch/2530001/2540004">Here it is.</a> This file is created automatically and lists all single instructions allowed in x86 32 bit NaCl mode. If you use instructions from it - you are golden, if you use instructions not mentioned there then validator will reject your code.</div><div><br /></div><div>There are a lot of instructions in this list and you can do a lot of things using them, but couple of instructions are suspiciously missing: <font face="courier new, monospace">call</font> and <font face="courier new, monospace">ret</font>. Well, call is there but only as <font face="courier new, monospace">call %eip</font> (which basically means “<span style="background-color:transparent;font-size:10pt">call with any 32bit offset</span><span style="background-color:transparent;font-size:10pt">” </span><span style="background-color:transparent;font-size:10pt">since script used to generate said list always uses offset equal to zero for the simplification), but <font face="courier new, monospace">ret</font> is not present at all</span><span style="background-color:transparent;font-size:10pt">—and this <b>not</b> an error in script!</span></div><div><span style="background-color:transparent;font-size:10pt"><br /></span></div><div><span style="background-color:transparent;font-size:10pt">Why would you need a <font face="courier new, monospace">call</font> without <font face="courier new, monospace">ret</font>? How could you return from function? And can you ever call function indirecly? Contemporary technologies use function pointers (in different forms) quite extensively. The answer to this question brings us to a <i>superinstruction</i> notion.</span></div><div><span style="background-color:transparent;font-size:10pt"><br /></span></div><div><span style="background-color:transparent;font-size:10pt">In 32 bit case there are exactly two <i>superinstructions</i>: <font face="courier new, monospace">naclcall</font> and <font face="courier new, monospace">nacljmp</font>. They can be used with any 32 bit general purpose register (and only register, never memory!) to do an indirect jump. And </span><span style="background-color:transparent"><font face="courier new, monospace">i686-nacl-as</font></span><span style="background-color:transparent;font-size:10pt"> also gives you the <font face="courier new, monospace">naclret</font> macro which simply calls </span><span style="background-color:transparent;font-size:10pt"><font face="courier new, monospace">pop %ecx</font> and then <font face="courier new, monospace">nacljmp %ecx</font> (<font face="courier new, monospace">%ecx</font> is picked because it's neither caller-saved register not callee-saved register in x86 ELF ABI).</span></div><div><span style="background-color:transparent;font-size:10pt"><br /></span></div><div><span style="background-color:transparent;font-size:10pt">There are nothing magical in <font face="courier new, monospace">naclret</font>, but <font face="courier new, monospace">naclcall</font> and <font face="courier new, monospace">nacljmp</font> <b>are</b> magical. How come? Let's see:</span></div><div><span style="background-color:transparent"><font face="courier new, monospace">$ cat nacljmp.s</font></span></div><div><span style="background-color:transparent"><font face="courier new, monospace"><div>nacljmp %eax</div><div><span style="background-color:transparent;font-size:10pt">$ pepper_33/toolchain/linux_x86_newlib/bin/i686-nacl-as nacljmp.s -o nacljmp.o</span></div></font></span></div><div><span style="background-color:transparent;font-size:10pt"><font face="courier new, monospace">$ pepper_33/toolchain/linux_x86_newlib/bin/i686-nacl-objdump -d nacljmp.o</font></span></div><div><div><font face="courier new, monospace"><br /></font></div><div><font face="courier new, monospace">nacljmp.o:     file format elf32-i386-nacl</font></div><div><font face="courier new, monospace"><br /></font></div><div><span style="background-color:transparent;font-size:10pt"><font face="courier new, monospace">Disassembly of section .text:</font></span></div><div><font face="courier new, monospace"><br /></font></div><div><font face="courier new, monospace">00000000 &lt;.text&gt;:</font></div><div><font face="courier new, monospace">   0:<span style="white-space:pre"> </span>83 e0 e0             <span style="white-space:pre"> </span>and    $0xffffffe0,%eax</font></div><div><font face="courier new, monospace">   3:<span style="white-space:pre"> </span>ff e0                <span style="white-space:pre"> </span>jmp    *%eax</font></div></div><div><br /></div><div>As you can see this <i style="background-color:transparent;font-size:10pt">superinstruction </i><span style="background-color:transparent;font-size:10pt">actually combines two different instructions: <font face="courier new, monospace">and</font> and <font face="courier new, monospace">jmp</font>. This combination guarantees that target address for nacljmp is always aligned: you can not use <font face="courier new, monospace">nacljmp</font> (or <font face="courier new, monospace">naclcall</font>) to jump in the middle of 32-byte <i>bundle</i>. And i686-nacl-as guarantees that instructions in your code will never straggle boundary of such <i>bundle</i>. These two facts combined mean that code can be <b>statically</b> disassebled and verified. Which in turn means that NaCl validator does not effect performance of your code at all: it does it's work once, and then your code is executed by CPU directly without additional overhead (bundles and lack of <font face="courier new, monospace">ret</font> will create some small overhead, of course, but it's very small). That's really, really cool. There is one tiny problem though: what happens if address which you are using as a target is not actually aligned? IOW: how can <font face="courier new, monospace">call</font> work in this scheme. The answer is simple: <font face="courier new, monospace">call</font> is magical in <font face="courier new, monospace">i686-nacl-as</font>, too (and <font face="courier new, monospace">naclcall</font> is doubly magical): <font face="courier new, monospace">i686-nacl-as</font> always moves it to the end of bundle which means that address in stack is properly aligned.</span></div><div><span style="background-color:transparent;font-size:10pt"><br /></span></div><div><span style="background-color:transparent;font-size:10pt">And now our description of 32 bit nacl assembler is essentially complete. You have the whitelist of instructions, you use <font face="courier new, monospace">naclcall</font>, <font face="courier new, monospace">nacljmp</font> and <font face="courier new, monospace">naclret</font> where needed and that's it.</span></div><div><span style="background-color:transparent;font-size:10pt"><br /></span></div><div><span style="background-color:transparent;font-size:10pt">Now we are switching to 64 bit case. Before we'll discuss it we need to think a bit. All our manipulations work if <b>all</b> the code in your process adheres to the NaCl rules</span><span style="background-color:transparent">… but not all code in NaCl process image are like that! NaCl loaders include bunch of code compiled with a normal (non-NaCl) compiler and, more importantly, it's linked with system libraries which most definitely can not be recompiled with NaCl compiler (well</span><span style="background-color:transparent;font-size:10pt">… under Linux they could, but this approach will not work with MacOS or Windows). One jump to stray aligned <font face="courier new, monospace">ret</font></span><span style="background-color:transparent">—and the whole system is compromised. How <b>that</b> problem is solved? In 32 bit case the answer is simple: <b><i>segment registers</i></b>! <i>Segment registers</i> are used to limit the reach of your code and that means that <i>untrusted code</i>, indeed, can not call <i>trusted code</i> (at least directly). There are some tiny pieces of <i>trusted code</i> injected in <i>untrusted zone</i> (<i>trampolines</i> and <i>springboards</i>) which are used to manage communication between trusted code and untrusted code but you never deal with these directly.</span></div><div><span style="background-color:transparent"><br /></span></div><div><span style="background-color:transparent">But in 64 bit case this plan will not work! There are no segments in 64 bit mode!</span></div><div><span style="background-color:transparent"><br /></span></div><div>Right - and this is why 64 bit mode is significantly more involved and complicated. <a href="https://codereview.chromium.org/49183002/patch/2530001/2540005">Here is the whitelist</a>. Let's take a look on a simple <font face="courier new, monospace">mov</font> instruction. In 32 bit mode it was described as</div><div>  <font face="courier new, monospace">Instruction: 89 XX  mov [%eax..%edi],[%eax..%edi or memory]</font></div><div>Very simple instruction straight from Intel's (or AMD) manual. Any 32 bit general-purpose register can be moved to general-purpose register or memory. In 64 bit case the same instruction is described quite differently:</div><div>  <font face="courier new, monospace">Instruction: [REX:40..47]? 89 XX  mov [%eax..%r15d],[%eax..%ebx|%esi..%r14d or memory]</font></div><div>That is: any 32 bit register can be moved to any 32bit register<span style="background-color:transparent;font-size:10pt">… except for <font face="courier new, monospace">%rbp</font>, <font face="courier new, monospace">%rsp</font> and <font face="courier new, monospace">%r15</font>. Uhm... Why? What makes these registers special? Answer: they point to the <i>untrusted zone</i>. <font face="courier new, monospace">%r15</font> always points to the beginning of the untrusted zone (and can not be changed) while <font face="courier new, monospace">%rbp</font> and <font face="courier new, monospace">%rsp</font> can point to arbitrary point in the <i>untrusted zone</i></span><span style="background-color:transparent;font-size:10pt">—but can only be changed by a limited set of instructions.</span></div><div><span style="background-color:transparent;font-size:10pt"><br /></span></div><div><span style="background-color:transparent;font-size:10pt">Why do we do that? How can it limit memory accesses and make sure they never reach out of the <i>unstrusted zone</i>? Does at mean that you can only access memory placed on a fixed distance from <font face="courier new, monospace">%r15</font>, <font face="courier new, monospace">%rbp</font>, or <font face="courier new, monospace">%rsp</font>? It'll be quite inefficient!</span></div><div><span style="background-color:transparent;font-size:10pt"><br /></span></div><div><span style="background-color:transparent;font-size:10pt">Yes, it'll be inefficiant and that's why we introduce yet another concept: concept of <font face="courier new, monospace">restricted register</font>. Conceptually <font face="courier new, monospace">restricted register</font> is just a register which is guaranteed to be in the interval from <font face="courier new, monospace">0</font> to </span><span style="background-color:transparent"><font face="courier new, monospace">4'294'967'295</font>. But, again, we don't try to create complex data models at the validation time. Instead we have a very simple rule: one instruction can produce restricted register while another one can consume restricted register</span><span style="background-color:transparent;font-size:10pt">—and these two instructions must be <i>immediately adjacent in the same bundle</i>. Here we use the interesting property of x86-64 ISA: any instruction which stores to 32bit register automatically cleans up top half of the corresponding 64bit register. That's what notes </span><span style="background-color:transparent"><font face="courier new, monospace">input_rr=</font></span><span style="background-color:transparent;font-size:10pt"><font face="courier new, monospace">…</font> and <font face="courier new, monospace">output_rr=</font></span><span style="font-family:courier new,monospace">…</span><span style="background-color:transparent;font-size:10pt"> mean in the whitelist. They show which instruction produce </span><span style="font-family:courier new,monospace;background-color:transparent;font-size:10pt">restricted register </span><span style="background-color:transparent;font-size:10pt">and which instructions consume </span><span style="font-family:courier new,monospace;background-color:transparent;font-size:10pt">restricted register</span><span style="background-color:transparent;font-size:10pt">. Note that while many instructions can produce <font face="courier new, monospace">%rbp</font> and/or <font face="courier new, monospace">%rsp</font> as restricted register only few instruction accept <font face="courier new, monospace">%rbp</font> and/or <font face="courier new, monospace">%rsp</font> as restricted register. Which means that most %rbp and/or %rsp modifications are done as two-step operation: first you are doing something with <font face="courier new, monospace">%<b>e</b>bp</font> or <font face="courier new, monospace">%<b>e</b>sp</font>, then you immediatery add <font face="courier new, monospace">%<b>r</b>15</font> to <font face="courier new, monospace">%<b>r</b>bp</font> or <font face="courier new, monospace">%<b>r</b>sp</font> using lea or add.</span></div><div><span style="background-color:transparent;font-size:10pt"><br /></span></div><div><span style="background-color:transparent;font-size:10pt">This is all well and good, but here we have a complication: validator knows that such tightly tied instructions must reside in a single bundle, but <font face="courier new, monospace">x86_64-nacl-as</font> does not know that! It will happily place these two instructions into a different bundles and then code will be rejected by validator.</span></div><div><span style="background-color:transparent;font-size:10pt"><br /></span></div><div><span style="background-color:transparent;font-size:10pt">How can we solve that problem? This is done with human's assistance. If you want to </span><span style="background-color:transparent">“</span><span style="background-color:transparent;font-size:10pt">glue two instruction together</span><span style="background-color:transparent;font-size:10pt">”</span><span style="background-color:transparent;font-size:10pt"> you need to use the following construct:</span></div><div><span style="background-color:transparent;font-size:10pt"><br /></span></div><div><span style="background-color:transparent"><div style="font-size:10pt"><font face="courier new, monospace">.bundle_lock</font></div><div style="font-size:10pt"><font face="courier new, monospace">    lea (%rax,%rbx),%ecx</font></div><div style="font-size:10pt"><font face="courier new, monospace">    mov (%rbp,%rcx),%edx</font></div><div style="font-size:10pt"><font face="courier new, monospace">    mov (%r15,%rdx),%rax</font></div><div style="font-size:10pt"><font face="courier new, monospace">.bundle_unlock</font></div><div style="font-size:10pt"><br /></div><div style="font-size:10pt">There are couple of interesting things to note here:</div><div style="font-size:10pt"><ul><li><font face="courier new, monospace" style="font-size:10pt;background-color:transparent">lea</font><span style="font-size:10pt;background-color:transparent"> with 32 bit address registers is forbidden, use 64 bit version with 32 bit register as destination—it's shorter and is just as effective.</span></li><li><span style="font-size:10pt;background-color:transparent">you can chain more than two instructions together</span><span style="font-size:10pt;background-color:transparent">—but you can not reuse restricted register again. This sequence will be rejected:<br /><div style="font-size:10pt"><div><font face="courier new, monospace">.bundle_lock</font></div><div><font face="courier new, monospace">    lea (%rax,%rbx),%ecx</font></div><div><font face="courier new, monospace">    mov (%rbp,%rcx),%edx</font></div><div><font face="courier new, monospace">    mov (%r15,%rcx),%rax</font></div><div><font face="courier new, monospace">.bundle_unlock</font></div></div></span></li></ul></div><div style="font-size:10pt">This is all well and good but how can you do that in the inline assembler when you refer the arguments? When you use <font face="courier new, monospace">%0</font> will give you either 32 bit register or 64 bit register (depending on what size argument was supplied to <font face="courier new, monospace">asm</font> directive) and here we often need to deal with 32 bit registers and their 64 bit siblings!</div><div style="font-size:10pt"><br /></div><div style="font-size:10pt">Actually GCC always had the appropriate mechanism, it's not NaCl-specific at all, it's just such mix of sizes is not common in “normal” programs. Consider:</div><div style="font-size:10pt"><br /></div><div style="font-size:10pt"><div><font face="courier new, monospace">$ cat sizes_test.c </font></div><div><font face="courier new, monospace">int foo() {</font></div><div><font face="courier new, monospace">  int i;</font></div><div><font face="courier new, monospace">  long long ll;</font></div><div><font face="courier new, monospace">  asm("mov %q0,%0"::"r"(i));</font></div><div><font face="courier new, monospace">  asm("mov %q0,%0"::"r"(ll));</font></div><div><font face="courier new, monospace">  asm("mov %k0,%0"::"r"(i));</font></div><div><font face="courier new, monospace">  asm("mov %k0,%0"::"r"(ll));</font></div><div><font face="courier new, monospace">}</font></div></div><div><font face="courier new, monospace">$ gcc -S -O2 sizes_test.c -o-</font></div><div><font face="courier new, monospace">…</font></div><div><div><font face="courier new, monospace">foo:</font></div><div><font face="courier new, monospace">.LFB0:</font></div><div><font face="courier new, monospace"><span style="white-space:pre"> </span>.cfi_startproc</font></div><div><font face="courier new, monospace"><span style="white-space:pre"> </span>movl<span style="white-space:pre"> </span>$1, %eax</font></div><div><font face="courier new, monospace">#APP</font></div><div><font face="courier new, monospace"># 4 "sizes_test.c" 1</font></div><div><font face="courier new, monospace"><span style="white-space:pre"> </span>mov %rax,%eax</font></div><div><font face="courier new, monospace"># 0 "" 2</font></div><div><font face="courier new, monospace">#NO_APP</font></div><div><font face="courier new, monospace"><span style="white-space:pre"> </span>movl<span style="white-space:pre"> </span>$1, %eax</font></div><div><font face="courier new, monospace">#APP</font></div><div><font face="courier new, monospace"># 5 "sizes_test.c" 1</font></div><div><font face="courier new, monospace"><span style="white-space:pre"> </span>mov %rax,%rax</font></div><div><font face="courier new, monospace"># 0 "" 2</font></div><div><font face="courier new, monospace"># 6 "sizes_test.c" 1</font></div><div><font face="courier new, monospace"><span style="white-space:pre"> </span>mov %eax,%eax</font></div><div><font face="courier new, monospace"># 0 "" 2</font></div><div><font face="courier new, monospace">#NO_APP</font></div><div><font face="courier new, monospace"><span style="white-space:pre"> </span>movl<span style="white-space:pre"> </span>$1, %eax</font></div><div><font face="courier new, monospace">#APP</font></div><div><font face="courier new, monospace"># 7 "sizes_test.c" 1</font></div><div><font face="courier new, monospace"><span style="white-space:pre"> </span>mov %eax,%rax</font></div><div><font face="courier new, monospace"># 0 "" 2</font></div><div><font face="courier new, monospace">#NO_APP</font></div><div><font face="courier new, monospace"><span style="white-space:pre"> </span>ret</font></div><div><font face="courier new, monospace"><span style="white-space:pre"> </span>.cfi_endproc</font></div></div><div><span style="background-color:transparent;font-size:10pt"><font face="courier new, monospace">…</font></span></div><div><span style="background-color:transparent;font-size:10pt"><br /></span></div><div><span style="background-color:transparent;font-size:10pt">As you can see it's not hard to ask assembler to produce 32 bit or 64 bit registers on demand. Just keep in mind that NaCl used ILP32 model which means that by default it'll produce 32 bit registers there! Which probably means that you'll use <font face="courier new, monospace">q</font> modifier significanly more often then <font face="courier new, monospace">k</font> modifier.</span></div><div><span style="background-color:transparent;font-size:10pt"><br /></span></div><div><span style="background-color:transparent;font-size:10pt">Note that </span><span style="font-family:courier new,monospace;background-color:transparent;font-size:10pt">.bundle_lock</span><span style="background-color:transparent;font-size:10pt">/</span><span style="font-family:courier new,monospace;background-color:transparent;font-size:10pt">.bundle_unlock</span><span style="background-color:transparent;font-size:10pt"> machinery is only available in NaCl SDK starting from PPAPI 33. Before that you were forced to use <font face="courier new, monospace">%nacl</font> pseudo-prefix and and bunch of special instructions to produce validateable code <a href="http://www.chromium.org/nativeclient/design-documents/nacl-sfi-model-on-x86-64-systems">as explaines in the SFI document</a>. This approach was slower (because it was impossible to combine address calculation with register restriction) and more cryptic, but if you need to deal with PPAPI 32 or below then it's your only choice.</span></div><div><span style="background-color:transparent;font-size:10pt"><br /></span></div></span></div></div></td></tr></tbody></table>
</div> 
</div> 
<div id="sites-canvas-bottom-panel">
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_page-subpages"> </div>
<div id="sites-attachments-container">
</div>
<a xmlns="http://www.w3.org/1999/xhtml" name="page-comments"></a>
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_page-comments"><div class="sites-comment-docos-wrapper"><div class="sites-comment-docos"><div class="sites-comment-docos-background"></div><div class="sites-comment-docos-header"><div class="sites-comment-docos-header-title">Comments</div></div><div id="sites-comment-docos-pane" class="sites-comment-docos-pane"></div></div></div></div>
</div>
</div> 
</td> 
</tr>
</table> 
</div> 
</div> 
<div id="sites-chrome-footer-wrapper">
<div id="sites-chrome-footer-wrapper-inside">
<div id="sites-chrome-footer">
</div>
</div>
</div>
</div> 
</div> 
<div id="sites-chrome-adminfooter-container">
<div xmlns="http://www.w3.org/1999/xhtml" class="sites-adminfooter" role="navigation"><p><a class="sites-system-link" href="https://www.google.com/a/UniversalLogin?service=jotspot&amp;continue=http://sites.google.com/a/chromium.org/dev/nativeclient/how-tos/how-to-write-assembler-for-x86-nacl-platform">Sign in</a><span aria-hidden="true">|</span><a class="sites-system-link" href="http://www.chromium.org/system/app/pages/recentChanges">Recent Site Activity</a><span aria-hidden="true">|</span><a class="sites-system-link" href="http://www.chromium.org/system/app/pages/reportAbuse" target="_blank">Report Abuse</a><span aria-hidden="true">|</span><a class="sites-system-link" href="javascript:;" onclick="window.open(webspace.printUrl)">Print Page</a><span aria-hidden="true">|</span><span class="sites-system-link">Powered By</span> <b class="powered-by"><a href="http://sites.google.com">Google Sites</a></b></p></div>
</div>
</div> 
</div> 
<div id="sites-chrome-onebar-footer">
</div>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
    window.jstiming.load.tick('sjl');
  </script>
<script xmlns="http://www.w3.org/1999/xhtml" src="http://www.gstatic.com/sites/p/56e332/system/js/jot_min_view__en.js"></script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
    window.jstiming.load.tick('jl');
  </script>
<script xmlns="http://www.w3.org/1999/xhtml">
      
          sites.core.Analytics.createTracker();
          sites.core.Analytics.trackPageview();
        
    </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
                    sites.Searchbox.initialize(
                        'sites-searchbox-search-button',
                        {"object":[]}['object'],
                        'search-site',
                        {"label":"Configure search options...","url":"/system/app/pages/admin/settings"});
                  </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
      gsites.HoverPopupMenu.createSiteDropdownMenus('sites-header-nav-dropdown', false);
    </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript" defer="true">
            JOT_setupNav("7648876402527094", "Navigation", false);
            JOT_addListener('titleChange', 'JOT_NAVIGATION_titleChange', 'COMP_7648876402527094');
          </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript" defer="true">
            JOT_setupNav("14720868319272995", "Quick links", false);
            JOT_addListener('titleChange', 'JOT_NAVIGATION_titleChange', 'COMP_14720868319272995');
          </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript" defer="true">
            JOT_setupNav("19690813310444355", "Other sites", false);
            JOT_addListener('titleChange', 'JOT_NAVIGATION_titleChange', 'COMP_19690813310444355');
          </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
              new sites.CommentPane('//docs.google.com/comments/d/AAHRpnXvrAwjAfmld0ObrebBiGRq9yViw-n71pBlNR9DAKB_s0DD8buryo2ZsbPzXLXDhZYxDvkPfmgxqfc3t05fRy7XwJAe5AiDhR2jX80Sa39tlMGDFGbT609OLV4FcTc6sBvvwX5zE/api/js?anon=true',
                  false, false);
            </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
  setTimeout(function() {
    var fingerprint = gsites.date.TimeZone.getFingerprint([]);
    gsites.Xhr.send('http://www.chromium.org/_/tz', null, null, 'GET', null, null, { afjstz: fingerprint });
  }, 500);
</script>
<script xmlns="http://www.w3.org/1999/xhtml">
                    window.onload = function() {
                      if (false) {
                        JOT_setMobilePreview();
                      }
                      var loadTimer = window.jstiming.load;
                      loadTimer.tick("ol");
                      loadTimer["name"] = "load," + webspace.page.type + ",user_page";
                      window.jstiming.report(loadTimer, {}, 'http://csi.gstatic.com/csi');
                    }
                  </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
        JOT_insertAnalyticsCode(false,
            false);
      </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
    var maestroRunner = new gsites.pages.view.SitesMaestroRunner(
        webspace, "en");
    maestroRunner.initListeners();
    maestroRunner.installEditRender();
  </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript" defer="true">
  //<![CDATA[
    // Decorate any fastUI buttons on the page with a class of 'goog-button'.
    if (webspace.user.hasWriteAccess) {
      JOT_decorateButtons();
    }

    // Fires delayed events.
    (function() {
      JOT_fullyLoaded = true;
      var delayedEvents = JOT_delayedEvents;
      for (var x = 0; x < delayedEvents.length; x++) {
        var event = delayedEvents[x];
        JOT_postEvent(event.eventName, event.eventSrc, event.payload);
      }
      JOT_delayedEvents = null;
      JOT_postEvent('pageLoaded');
    })();
  //]]>
</script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
    JOT_postEvent('decorateGvizCharts');
  </script>
<script type="text/javascript">
          JOT_setupPostRenderingManager();
        </script>
<script type="text/javascript">
          JOT_postEvent('renderPlus', null, 'sites-chrome-main');
        </script>
<div id="server-timer-div" style="display:none"> </div>
<script type="text/javascript">
          window.jstiming.load.tick('render');
          JOT_postEvent('usercontentrendered', this);
        </script>
</body>
</html>
