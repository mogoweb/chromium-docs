<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/WebPage">
<head>
<meta http-equiv="X-UA-Compatible" content="chrome=1" />
<script type="text/javascript">/* Copyright 2008 Google. */ (function() { var e="wtsrt_",g="tbsd_",h="tbnd_",k="start",l="_wtsrt",m="_tbnd",n="CSI/";(function(){function f(a){this.t={};this.tick=function(a,c,b){this.t[a]=[void 0!=b?b:(new Date).getTime(),c];if(void 0==b)try{window.console.timeStamp(n+a)}catch(d){}};this.tick(k,null,a)}var a;window.performance&&(a=window.performance.timing);var p=a?new f(a.responseStart):new f;window.jstiming={Timer:f,load:p};if(a){var c=a.navigationStart,d=a.responseStart;0<c&&d>=c&&(window.jstiming.srt=d-c)}if(a){var b=window.jstiming.load;0<c&&d>=c&&(b.tick(l,void 0,c),b.tick(e,l,d),b.tick(g,e))}try{a=null,
window.chrome&&window.chrome.csi&&(a=Math.floor(window.chrome.csi().pageT),b&&0<c&&(b.tick(m,void 0,window.chrome.csi().startE),b.tick(h,m,c))),null==a&&window.gtbExternal&&(a=window.gtbExternal.pageT()),null==a&&window.external&&(a=window.external.pageT,b&&0<c&&(b.tick(m,void 0,window.external.startE),b.tick(h,m,c))),a&&(window.jstiming.pt=a)}catch(q){}})(); })()
</script>
<link rel="shortcut icon" href="/_/rsrc/1354323194313/favicon.ico" type="image/x-icon" />
<link rel="apple-touch-icon" href="https://ssl.gstatic.com/sites/p/56e332/system/app/images/apple-touch-icon.png" type="image/png" />
<script type="text/javascript">/* Copyright 2008 Google. */ (function() { var d="",g="__duration__",h="function";function k(c){return document.getElementById(c)}window.byId=k;function l(c){return c.replace(/^\s+|\s+$/g,d)}window.trim=l;var m=[],n=0;window.JOT_addListener=function(c,a,b){var e=new String(n++);c={eventName:c,handler:a,compId:b,key:e};m.push(c);return e};window.JOT_removeListenerByKey=function(c){for(var a=0;a<m.length;a++)if(m[a].key==c){m.splice(a,1);break}};
window.JOT_removeAllListenersForName=function(c){for(var a=0;a<m.length;a++)m[a].eventName==c&&m.splice(a,1)};window.JOT_postEvent=function(c,a,b){var e={eventName:c,eventSrc:a||{},payload:b||{}};if(window.JOT_fullyLoaded)for(a=m.length,b=0;b<a&&b<m.length;b++){var f=m[b];f&&f.eventName==c&&(e.listenerCompId=f.compId||d,(f=typeof f.handler==h?f.handler:window[f.handler])&&f(e))}else window.JOT_delayedEvents.push({eventName:c,eventSrc:a,payload:b})};window.JOT_delayedEvents=[];
window.JOT_fullyLoaded=!1;window.JOT_formatRelativeToNow=function(c,a){var b=((new Date).getTime()-c)/6E4;if(1440<=b||0>b)return null;var e=0;60<=b&&(b/=60,e=2);2<=b&&e++;return a?window.JOT_siteRelTimeStrs[e].replace(g,Math.floor(b)):window.JOT_userRelTimeStrs[e].replace(g,Math.floor(b))}; })()
</script>
<script>

  

  var breadcrumbs = [{"path":"/nativeclient","deleted":false,"title":"Native Client","dir":"ltr"},{"path":"/nativeclient/how-tos","deleted":false,"title":"2: How Tos","dir":"ltr"},{"path":"/nativeclient/how-tos/debugging-documentation","deleted":false,"title":"Debugging Documentation","dir":"ltr"},{"path":"/nativeclient/how-tos/debugging-documentation/running-under-valgrind","deleted":false,"title":"Running under Valgrind","dir":"ltr"}];
  var JOT_clearDotPath = 'https://ssl.gstatic.com/sites/p/56e332/system/app/images/cleardot.gif';

  
  var JOT_userRelTimeStrs = ["a minute ago","__duration__ minutes ago","an hour ago","__duration__ hours ago"];

  
  

  

  var webspace = {"enableAnalytics":true,"pageSharingId":"jotspot_page","enableUniversalAnalytics":false,"sharingPolicy":"OPENED_WITH_INDICATOR","siteTitle":"The Chromium Projects","isStartPageEnabled":true,"adsensePublisherId":null,"features":{"languageSelectDefaultTextSetToDefault":true,"validateClientGvizDataSourceUrls":true,"moreMobileStyleImprovements":true,"newInsertMenuIcons":true,"accessibleSortingButtons":true,"domainAnalyticsInGAOnly":true,"noCaptcha":true,"fileCabinetScreenReaderFix":true,"updatedTosAndPrivacyLinks":null,"pageDrafts":false,"mobileOrientationFix":true,"plusBadge":false,"pdfEmbedSupport":false,"jsClickFix":true},"isPublic":true,"isConsumer":false,"serverFlags":{"cajaBaseUrl":"//www.gstatic.com/caja","cajaDebugMode":false},"onepickBaseUrl":"https://docs.google.com","domainAnalyticsAccountId":"","plusPageId":"","signInUrl":"https://www.google.com/a/SelectSession?continue\u003dhttps://sites.google.com/a/chromium.org/dev/nativeclient/how-tos/debugging-documentation/running-under-valgrind\u0026service\u003djotspot","analyticsAccountId":"UA-5484340-1","scottyUrl":"/_/upload","homePath":"/","siteNoticeUrlEnabled":null,"plusPageUrl":"","adsensePromoClickedOrSiteIneligible":true,"csiReportUri":"https://gg.google.com/csi","sharingId":"jotspot","termsUrl":"//www.google.com/intl/en/policies/terms/","gvizVersion":1,"editorResources":{"sitelayout":["https://ssl.gstatic.com/sites/p/56e332/system/app/css/sitelayouteditor.css"],"text":["https://ssl.gstatic.com/sites/p/56e332/system/js/codemirror.js","https://ssl.gstatic.com/sites/p/56e332/system/app/css/codemirror_css.css","https://ssl.gstatic.com/sites/p/56e332/system/js/trog_edit__en.js","https://ssl.gstatic.com/sites/p/56e332/system/app/css/trogedit.css","/_/rsrc/1441580320000/system/app/css/editor.css","https://ssl.gstatic.com/sites/p/56e332/system/app/css/codeeditor.css","/_/rsrc/1441580320000/system/app/css/camelot/editor-jfk-wlb.css"]},"sharingUrlPrefix":"/_/sharing","isAdsenseEnabled":true,"domain":"chromium.org","baseUri":"","name":"dev","siteTemplateId":false,"siteNoticeRevision":null,"siteNoticeUrlAddress":null,"siteNoticeMessage":null,"page":{"isRtlLocale":false,"canDeleteWebspace":null,"isPageDraft":null,"parentPath":"/nativeclient/how-tos/debugging-documentation","parentWuid":"wuid:gx:cd55916fee69690","siteLocale":"en","timeZone":"America/Los_Angeles","type":"text","title":"Running under Valgrind","locale":"en","wuid":"wuid:gx:3c9a1f8f7ba075bb","revision":6,"path":"/nativeclient/how-tos/debugging-documentation/running-under-valgrind","isSiteRtlLocale":false,"pageInheritsPermissions":null,"name":"running-under-valgrind","canChangePath":true,"state":"","properties":{},"bidiEnabled":false,"currentTemplate":{"path":"/system/app/pagetemplates/text","title":"Web Page"}},"canPublishScriptToAnyone":true,"user":{"keyboardShortcuts":true,"sessionIndex":"","guest_":true,"displayNameOrEmail":"guest","userName":"guest","uid":"","renderMobile":false,"domain":"","namespace":"","hasWriteAccess":false,"namespaceUser":false,"primaryEmail":"guest","hasAdminAccess":false},"gadgets":{"baseUri":"/system/app/pages/gadgets"}};
  webspace.page.breadcrumbs = breadcrumbs;

  
  var JOT_siteRelTimeStrs = ["a minute ago","__duration__ minutes ago","an hour ago","__duration__ hours ago"];

</script>
<script type="text/javascript">
                window.jstiming.load.tick('scl');
              </script>
<meta name="title" content="Running under Valgrind - The Chromium Projects" />
<meta itemprop="name" content="Running under Valgrind - The Chromium Projects" />
<meta property="og:title" content="Running under Valgrind - The Chromium Projects" />
<meta name="description" content="Home of the Chromium Open Source Project" />
<meta itemprop="description" content="Home of the Chromium Open Source Project" />
<meta id="meta-tag-description" property="og:description" content="Home of the Chromium Open Source Project" />
<style type="text/css">
</style>
<link rel="stylesheet" type="text/css" href="https://ssl.gstatic.com/sites/p/56e332/system/app/themes/beigeandblue/standard-css-beigeandblue-ltr-ltr.css" />
<link rel="stylesheet" type="text/css" href="/_/rsrc/1441580320000/system/app/css/overlay.css?cb=beigeandblueundefineda100%25%25150goog-ws-leftthemedefaultstandard" />
<link rel="stylesheet" type="text/css" href="/_/rsrc/1441580320000/system/app/css/camelot/allthemes-view.css" />
<!--[if IE]>
          <link rel="stylesheet" type="text/css" href="/system/app/css/camelot/allthemes%2die.css" />
        <![endif]-->
<title>Running under Valgrind - The Chromium Projects</title>
<meta itemprop="image" content="/_/rsrc/1438879449147/config/customLogo.gif?revision=3" />
<meta property="og:image" content="/_/rsrc/1438879449147/config/customLogo.gif?revision=3" />
<script type="text/javascript">
                window.jstiming.load.tick('cl');
              </script>
</head>
<body xmlns="http://www.google.com/ns/jotspot" id="body" class=" en            ">
<div id="sites-page-toolbar" class="sites-header-divider">
<div xmlns="http://www.w3.org/1999/xhtml" id="sites-status" class="sites-status" style="display:none;"><div id="sites-notice" class="sites-notice" role="status" aria-live="assertive"> </div></div>
</div>
<div id="sites-chrome-everything-scrollbar">
<div id="sites-chrome-everything" class="">
<div id="sites-chrome-page-wrapper" style="direction: ltr">
<div id="sites-chrome-page-wrapper-inside">
<div xmlns="http://www.w3.org/1999/xhtml" id="sites-chrome-header-wrapper" style="height:auto;">
<table id="sites-chrome-header" class="sites-layout-hbox" cellspacing="0" style="height:auto;">
<tr class="sites-header-primary-row" id="sites-chrome-userheader">
<td id="sites-header-title" class="" role="banner"><div class="sites-header-cell-buffer-wrapper"><a href="https://www.chromium.org/" id="sites-chrome-userheader-logo"><img id="logo-img-id" src="/_/rsrc/1438879449147/config/customLogo.gif?revision=3" alt="The Chromium Projects" class="sites-logo  " /></a><h2><a href="https://www.chromium.org/" dir="ltr" id="sites-chrome-userheader-title">The Chromium Projects</a></h2></div></td><td class="sites-layout-searchbox  "><div class="sites-header-cell-buffer-wrapper"><form id="sites-searchbox-form" action="/system/app/pages/search" role="search"><input type="hidden" id="sites-searchbox-scope" name="scope" value="search-site" /><input type="text" id="jot-ui-searchInput" name="q" size="20" value="" aria-label="Search this site" /><div id="sites-searchbox-button-set" class="goog-inline-block"><div role="button" id="sites-searchbox-search-button" class="goog-inline-block jfk-button jfk-button-standard" tabindex="0">Search this site</div></div></form></div></td>
</tr>
<tr class="sites-header-secondary-row" id="sites-chrome-horizontal-nav">
<td colspan="2" id="sites-chrome-header-horizontal-nav-container" role="navigation">
</td>
</tr>
</table>
</div>
<div id="sites-chrome-main-wrapper">
<div id="sites-chrome-main-wrapper-inside">
<table id="sites-chrome-main" class="sites-layout-hbox" cellspacing="0" cellpadding="{scmCellpadding}" border="0">
<tr>
<td id="sites-chrome-sidebar-left" class="sites-layout-sidebar-left initial" style="width:150px">
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_7648876402527094" class="sites-embed" role="navigation"><div class="sites-embed-content sites-sidebar-nav"><ul role="navigation" jotId="navList"><li class="nav-first "><div dir="ltr" style="padding-left: 5px;"><a href="/chromium-projects" jotId="wuid:gx:10ae433dadbbab13" class="sites-navigation-link">Home</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="/Home" jotId="wuid:gx:43582b9d2029d3af" class="sites-navigation-link">Chromium</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="/chromium-os" jotId="wuid:gx:83df2ab1f8880ba" class="sites-navigation-link">Chromium OS</a></div></li></ul></div></div>
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_14720868319272995" class="sites-embed" role="navigation"><h4 class="sites-embed-title">Quick links</h4><div class="sites-embed-content sites-sidebar-nav"><ul role="navigation" jotId="navList"><li class="nav-first "><div dir="ltr" style="padding-left: 5px;"><a href="http://www.chromium.org/for-testers/bug-reporting-guidelines" class="sites-navigation-link">Report bugs</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="http://www.chromium.org/developers/discussion-groups" class="sites-navigation-link">Discuss</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="/system/app/pages/sitemap/hierarchy" jotId="wuid:gx:4b58a9a350ad12f" class="sites-navigation-link">网站地图</a></div></li></ul></div></div>
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_19690813310444355" class="sites-embed" role="navigation"><h4 class="sites-embed-title">Other sites</h4><div class="sites-embed-content sites-sidebar-nav"><ul role="navigation" jotId="navList"><li class="nav-first "><div dir="ltr" style="padding-left: 5px;"><a href="http://blog.chromium.org/" class="sites-navigation-link">Chromium Blog</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="http://code.google.com/chrome/extensions/" class="sites-navigation-link">Google Chrome Extensions</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="https://developers.google.com/chrome/chrome-frame/" class="sites-navigation-link">Google Chrome Frame</a></div></li></ul></div></div>
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_19695218559354544" class="sites-embed" role="complementary"><h4 class="sites-embed-title"></h4><div class="sites-embed-content sites-embed-content-sidebar-textbox"><div dir="ltr"><span style="font-size:x-small">Except as otherwise </span><a href="http://developers.google.com/site-policies.html#restrictions"><span style="font-size:x-small">noted</span></a><span style="font-size:x-small">, the content of this page is licensed under a </span><a href="http://creativecommons.org/licenses/by/2.5/"><span style="font-size:x-small">Creative Commons Attribution 2.5 license</span></a><span style="font-size:x-small">, and examples are licensed under the </span><a href="http://src.chromium.org/viewvc/chrome/trunk/src/LICENSE" target="_blank"><span style="font-size:x-small">BSD License</span></a><span style="font-size:x-small">.<br /></span></div></div></div>
</td>
<td id="sites-canvas-wrapper">
<div id="sites-canvas" role="main">
<div id="goog-ws-editor-toolbar-container"> </div>
<div xmlns="http://www.w3.org/1999/xhtml" id="title-crumbs" style="">
<A href="/nativeclient" dir="ltr">Native Client</A>‎ &gt; ‎<A href="/nativeclient/how-tos" dir="ltr">2: How Tos</A>‎ &gt; ‎<A href="/nativeclient/how-tos/debugging-documentation" dir="ltr">Debugging Documentation</A>‎ &gt; ‎
  </div>
<h3 xmlns="http://www.w3.org/1999/xhtml" id="sites-page-title-header" style="" align="left">
<span id="sites-page-title" dir="ltr" tabindex="-1" style="outline: none">Running under Valgrind</span>
</h3>
<div id="sites-canvas-main" class="sites-canvas-main">
<div id="sites-canvas-main-content">
<table xmlns="http://www.w3.org/1999/xhtml" cellspacing="0" class="sites-layout-name-one-column sites-layout-hbox"><tbody><tr><td class="sites-layout-tile sites-tile-name-content-1"><div dir="ltr"><div>It is possible to run Valgrind/Memcheck and ThreadSanitizer on NaCl. Valgrind can now debug both trusted and untrusted code.</div><div><br /></div><div>Currently, Valgrind for NaCl is supported only on Linux x86_64.</div><div><br /></div><div><h3><a name="TOC-Terminology"></a>Terminology</h3><div><ul><li><b>Valgrind</b> is a binary translation system.</li><li><b>Memcheck</b> is a Valgrind-based memory error detector which finds these bugs:</li><ul><li>Memory leaks</li><li>Uninitialized memory reads</li><li>Out of bound memory accesses</li><li>Accesses to free-ed heap</li><li>Some more</li></ul><li><a href="http://code.google.com/p/data-race-test/wiki/ThreadSanitizer">ThreadSanitizer</a> <span style="font-family:arial,sans-serif;line-height:16px">is a data race detector for C/C++ programs. ThreadSanitizer for NaCl is implemented as a Valgrind tool.</span></li></ul><font face="arial, sans-serif"><span style="line-height:16px"><br /></span></font></div></div><h3><a name="TOC-Buildbots"></a><font face="arial, sans-serif"><span style="line-height:16px">Buildbots</span></font></h3><div><font face="arial, sans-serif"><span style="line-height:16px">Bots that run NativeClient tests with Memcheck and ThreadSanitizer can be found on the NaCl waterfall:</span></font></div><div><a href="http://build.chromium.org/p/client.nacl/waterfall?builder=lucid-64-newlib-dbg-valgrind">http://build.chromium.org/p/client.nacl/waterfall?builder=lucid-64-newlib-dbg-valgrind</a></div><div><a href="http://build.chromium.org/p/client.nacl/waterfall?builder=lucid-64-newlib-dbg-valgrind">http://build.chromium.org/p/client.nacl/waterfall?builder=lucid-64-glibc-dbg-valgrind</a></div><div><a href="http://build.chromium.org/p/client.nacl.chrome/waterfall?builder=lucid64-valgrind-nacl-chrome">http://build.chromium.org/p/client.nacl.chrome/waterfall?builder=lucid64-valgrind-nacl-chrome</a></div><div><a href="http://build.chromium.org/p/client.nacl.chrome/waterfall?builder=lucid64-tsan-nacl-chrome">http://build.chromium.org/p/client.nacl.chrome/waterfall?builder=lucid64-tsan-nacl-chrome</a></div><div><br /></div><h3><a name="TOC-Running-Valgrind-Memcheck"></a>Running Valgrind/Memcheck</h3><div>From a NativeClient source checkout, Valgrind can be run with the following command:</div><div><pre><span style="font-family:Courier New,courier,monotype"><div class="sites-codeblock sites-codesnippet-block"><code>./scons --nacl_glibc --mode=dbg-host,nacl platform=x86-64 buildbot=memcheck memcheck_bot_tests</code></div></span></pre></div><p><code>buildbot=memcheck </code>is an alias for</p><div class="sites-codeblock sites-codesnippet-block"><p style="text-align:left;line-height:13px;background-color:rgb(239,239,239)"><code>run_under=src/third_party/valgrind/memcheck.sh,--error-exitcode=1</code></p><p style="text-align:left;line-height:13px;background-color:rgb(239,239,239)"><code>scale_timeout=20</code></p><p style="text-align:left;line-height:13px;background-color:rgb(239,239,239)"><code>running_on_valgrind=True</code></p></div><ul style="padding-left:25px;max-width:62em"><li style="font-family:arial,sans-serif;margin-bottom:0.3em"><tt style="font-family:Monaco,DejaVu Sans Mono,Bitstream Vera Sans Mono,Lucida Console,monospace;font-size:12px;max-width:66em">run_under</tt> allows you to pass the name of the tool under which you want to run tests. If the tool has options, pass them after comma: 'tool,--opt1,--opt2'. (the tool name and the parameters can not contain commas)</li><li style="font-family:arial,sans-serif;margin-bottom:0.3em"><tt style="font-family:Monaco,DejaVu Sans Mono,Bitstream Vera Sans Mono,Lucida Console,monospace;font-size:12px;max-width:66em">scale_timeout=20</tt> multiplies all timeouts by 20 (Remember, valgrind is slow!).</li><li style="font-family:arial,sans-serif;margin-bottom:0.3em"><tt style="font-family:Monaco,DejaVu Sans Mono,Bitstream Vera Sans Mono,Lucida Console,monospace;font-size:12px;max-width:66em">running_on_valgrind=True</tt> modifies test behaviour in a way suitable for Valgrind: reduce iteration count for long loops, disable some tests. When building with Newlib toolchain, this option also links <code>libvalgrind.a</code> to all test binaries. With GLibC toolchain this is done in runtime by the tool itself.</li><li style="font-family:arial,sans-serif;margin-bottom:0.3em"><tt style="font-family:Monaco,DejaVu Sans Mono,Bitstream Vera Sans Mono,Lucida Console,monospace;font-size:12px;max-width:66em">src/third_party/valgrind/bin/memcheck.sh</tt> is a modified valgrind binary which can run on <a href="http://code.google.com/p/nativeclient/wiki/NaCl" style="color:rgb(0,0,204)">NaCl</a>.</li><li style="font-family:arial,sans-serif;margin-bottom:0.3em">The most useful valgrind parameters:</li><ul style="font-family:arial,sans-serif;padding-left:25px;max-width:62em"><li style="margin-bottom:0.3em"><tt style="font-family:Monaco,DejaVu Sans Mono,Bitstream Vera Sans Mono,Lucida Console,monospace;font-size:12px;max-width:66em">--log-file=&lt;file_name&gt;</tt>: put warnings to a file instead of <tt style="font-family:Monaco,DejaVu Sans Mono,Bitstream Vera Sans Mono,Lucida Console,monospace;font-size:12px;max-width:66em">stderr</tt>.</li><li style="margin-bottom:0.3em"><tt style="font-family:Monaco,DejaVu Sans Mono,Bitstream Vera Sans Mono,Lucida Console,monospace;font-size:12px;max-width:66em">--error-exitcode=&lt;N&gt;</tt>: if at least one warning is reported, exit with this error code (by default, valgrind uses the program's exit code)</li><li style="margin-bottom:0.3em"><tt style="font-family:Monaco,DejaVu Sans Mono,Bitstream Vera Sans Mono,Lucida Console,monospace;font-size:12px;max-width:66em">--leak-check=no|yes|full</tt>: Perform leak checking (default: yes)</li></ul></ul><p><br /></p><p>For more options, see the Memcheck manual or type</p><div class="sites-codeblock sites-codesnippet-block"><code>src/third_party/valgrind/bin/memcheck.sh --help</code></div><div><br /></div><div><h3><a name="TOC-Running-ThreadSanitizer"></a>Running ThreadSanitizer</h3><div>From a NativeClient source checkout, Valgrind can be run with the following command:</div><div><pre><span><div class="sites-codeblock sites-codesnippet-block"><span style="color:rgb(0,96,0)">./scons --nacl_glibc --mode=dbg-host,nacl platform=x86-64 buildbot=tsan tsan_bot_tests</span></div></span></pre></div><font face="arial, sans-serif"><code>buildbot=tsan</code> works almost the same way as <code>buildbot=memcheck</code>, but the tool at <code>src/third_party/valgrind/tsan.sh</code> is used instead.</font><ul style="padding-left:25px;max-width:62em;font-family:arial,sans-serif"><ul style="padding-left:25px;max-width:62em"></ul></ul></div><div><font face="arial, sans-serif">ThreadSanitizer has a different set of options, see </font><a href="http://code.google.com/p/data-race-test/wiki/ThreadSanitizer">http://code.google.com/p/data-race-test/wiki/ThreadSanitizer</a> for reference.</div><div><br /></div><div>One important difference from Memcheck is that ThreadSanitizer for NaCl can detect either race in the trusted, or in untrusted code, but not both at the same time. <code>buildbot=tsan</code> detects races in the untrusted code. </div><div><br /></div><div>To look for races in the trusted code, use <code>buildbot=tsan-trusted:</code></div><div><span style="color:rgb(0,96,0);font-family:monospace;line-height:13px;white-space:pre;background-color:rgb(239,239,239)"><div class="sites-codeblock sites-codesnippet-block"><code>./scons --nacl_glibc --mode=dbg-host,nacl platform=x86-64 buildbot=tsan-trusted tsan_bot_tests</code></div></span></div><div><br /></div><div><br /></div><div>Add <code>--nacl-untrusted </code>to detect races in the untrusted code.</div><div><h3 style="font-family:Arial,Verdana,sans-serif"><a name="TOC-1"></a><span style="font-size:16px"><br /></span></h3><h3 style="font-family:Arial,Verdana,sans-serif"><a name="TOC-Running-Valgrind-and-ThreadSanitizer-manually"></a><span style="font-size:16px">Running Valgrind and ThreadSanitizer manually</span></h3><p style="line-height:1.25em;max-width:64em;font-family:arial,sans-serif">If you want to run a <a href="http://code.google.com/p/nativeclient/wiki/NaCl" style="color:rgb(0,0,204)">NaCl</a> binary under valgrind w/o using scons (for example, with NaCl SDK):</p><ul style="padding-left:25px;max-width:62em"><li style="font-family:arial,sans-serif;margin-bottom:0.3em">build the binary in valgrind mode:</li><ul style="font-family:arial,sans-serif;padding-left:25px;max-width:62em"><li><span style="font-family:arial,sans-serif">add </span><tt style="font-family:Monaco,DejaVu Sans Mono,Bitstream Vera Sans Mono,Lucida Console,monospace;font-size:12px;max-width:66em">-g</tt><span style="font-family:arial,sans-serif"> to compilation flags;</span></li><li style="margin-bottom:0.3em">for better results, disable optimization by adding -O0 to compilation flags;</li><li style="margin-bottom:0.3em">(<font color="#ff0000">only with Newlib</font>) add <tt style="font-family:Monaco,DejaVu Sans Mono,Bitstream Vera Sans Mono,Lucida Console,monospace;font-size:12px;max-width:66em">-Wl,-u,have_nacl_valgrind_interceptors -lvalgrind</tt> to link flags;</li></ul><li style="font-family:arial,sans-serif;margin-bottom:0.3em">run <tt style="font-family:Monaco,DejaVu Sans Mono,Bitstream Vera Sans Mono,Lucida Console,monospace;font-size:12px;max-width:66em">sel_ldr</tt> under <tt style="font-family:Monaco,DejaVu Sans Mono,Bitstream Vera Sans Mono,Lucida Console,monospace;font-size:12px;max-width:66em">memcheck.sh:</tt></li><ul><li style="font-family:arial,sans-serif;margin-bottom:0.3em"><tt style="font-family:Monaco,DejaVu Sans Mono,Bitstream Vera Sans Mono,Lucida Console,monospace;font-size:12px;max-width:66em">Make sure that you are running a debug sel_ldr</tt></li></ul></ul></div><div class="sites-codeblock sites-codesnippet-block"><p><span style="font-family:Courier New,courier,monotype;white-space:pre"><code>src/third_party/valgrind/memcheck.sh scons-out/dbg-linux-x86-64/staging/sel_ldr -cc -Q -a -- toolchain/linux_x86/x86_64-nacl/lib/runnable-ld.so \</code></span></p><p><span style="font-family:Courier New,courier,monotype;white-space:pre"><code>    --library-path scons-out/nacl-x86-64-glibc/lib:toolchain/linux_x86/x86_64-nacl/lib &lt;test nexe&gt; &lt;test arguments&gt;</code></span></p></div><div style="font-family:Arial,Verdana,sans-serif;white-space:normal"><span style="font-family:Arial,Verdana,sans-serif;white-space:normal"><br /></span></div><ul><li>-cc disables validator completely. This significantly speeds up test execution.</li><li>-Q disables platform qualification tests. This is needed to convince NaCl to run with a writable code segment, which is always the case under Valgrind.</li></ul><pre><span style="font-family:Arial,Verdana,sans-serif;white-space:normal">Essentially, this is a normal sel_ldr command line with some addtitional options and the <code>memcheck.sh</code> wrapper at the start. Some test may require a slightly different command line (ex. -B &lt;irt path&gt;). Please consult buildbot output for the most up-to-date info at</span></pre><pre><font face="Arial, Verdana, sans-serif"><span style="white-space:normal"><a href="http://build.chromium.org/p/client.nacl/builders/lucid-64-glibc-dbg-valgrind/builds/1103/steps/memcheck/logs/stdio">http://build.chromium.org/p/client.nacl/builders/lucid-64-glibc-dbg-valgrind/builds/1103/steps/memcheck/logs/stdio</a> (change the revision number to a recent one).</span></font></pre><h3><a name="TOC-2"></a><br /></h3><h3><a name="TOC-Implementation-details"></a>Implementation details</h3><pre><h3><a name="TOC-Valgrind-treats-the-NaCl-process-sel_ldr-as-any-other-regular-Linux-process.-The-only-difference-is-when-NaCl-mmaps-84G-for-untrusted-region-Valgrind-ignores-this-allocation.-So-initially-all-memory-within-untrusted-region-is-treated-by-Memcheck-as-unacces"></a><span style="font-family:arial,sans-serif;font-size:13px;font-weight:normal;line-height:16px;white-space:normal">Valgrind treats the</span><span style="font-family:arial,sans-serif;font-size:13px;font-weight:normal;line-height:16px;white-space:normal"> NaCl</span><span style="font-family:arial,sans-serif;font-size:13px;font-weight:normal;line-height:16px;white-space:normal"> </span><span style="font-family:arial,sans-serif;font-size:13px;font-weight:normal;line-height:16px;white-space:normal">process (</span><tt style="font-weight:normal;line-height:16px;white-space:normal;font-family:Monaco,DejaVu Sans Mono,Bitstream Vera Sans Mono,Lucida Console,monospace;font-size:12px;max-width:66em">sel_ldr</tt><span style="font-family:arial,sans-serif;font-size:13px;font-weight:normal;line-height:16px;white-space:normal">) as any other regular Linux process. The only difference is when</span><span style="font-family:arial,sans-serif;font-size:13px;font-weight:normal;line-height:16px;white-space:normal"> </span><a href="http://code.google.com/p/nativeclient/wiki/NaCl" style="font-family:arial,sans-serif;font-size:13px;font-weight:normal;line-height:16px;white-space:normal;color:rgb(0,0,204)">NaCl</a><span style="font-family:arial,sans-serif;font-size:13px;font-weight:normal;line-height:16px;white-space:normal"> </span><span style="font-family:arial,sans-serif;font-size:13px;font-weight:normal;line-height:16px;white-space:normal">mmaps 84G for untrusted region, Valgrind ignores this allocation. So, initially, all memory within untrusted region is treated by Memcheck as unaccessible.</span></h3><p style="line-height:1.25em;max-width:64em;font-family:arial,sans-serif;white-space:normal">Later, we call <a href="http://valgrind.org/docs/manual/mc-manual.html#mc-manual.clientreqs" rel="nofollow" style="color:rgb(0,0,204)">VALGRIND_MAKE_MEM_UNDEFINED</a> in few places in the trusted code to tell valgrind that a specific portion of those 84G is accessible. This annotation is applied to memory locations where we put the untrusted code.</p><p style="line-height:1.25em;max-width:64em;font-family:arial,sans-serif;white-space:normal">We intercept untrusted memory allocations (malloc, realloc, calloc, free) in untrusted/valgrind/valgrind_interceptors.c and notify Memcheck about them with client requests. These interceptors are compiled with the NaCl toolchain. With GlibC they are built as a dynamic shared library and preloaded into the process by Valgrind. Newlib toolchain does not support dynamic linking, and requires that the interceptors are statically linked into the test program.</p><h3><a name="TOC-3"></a><br /></h3><h3><a name="TOC-Changes-in-valgrind"></a>Changes in valgrind</h3><h2 style="font-size:large;border-top-width:0px;border-right-width:0px;border-bottom-width:0px;border-left-width:0px;border-style:initial;border-color:initial;padding-left:0px;max-width:700px;font-family:arial,sans-serif;white-space:normal"><a name="Changes_in_valgrind"></a></h2><p style="line-height:1.25em;max-width:64em;font-family:arial,sans-serif;white-space:normal">The patch to make valgrind work for <a href="http://code.google.com/p/nativeclient/wiki/NaCl" style="color:rgb(0,0,204)">NaCl</a> (both trusted and untrusted code) is in progress. Here is a short summary.</p><ul style="padding-left:25px;max-width:62em;font-family:arial,sans-serif;white-space:normal"><li style="margin-bottom:0.3em">Allow mmap of 88G:</li><ul style="padding-left:25px;max-width:62em"><li style="margin-bottom:0.3em">Change N_PRIMARY_BITS from 19 to 22 in memcheck/mc_main.c, set magic constants accordingly.</li><li style="margin-bottom:0.3em">Ignore all mmaps greater than 84G (notify_tool_of_mmap in coregrind/m_syswrap/syswrap-generic.c)</li><li style="margin-bottom:0.3em">Set <tt style="font-family:Monaco,DejaVu Sans Mono,Bitstream Vera Sans Mono,Lucida Console,monospace;font-size:12px;max-width:66em">aspacem_maxAddr = (Addr)0x4000000000 - 1; // 256G</tt> (coregrind/m_aspacemgr/aspacemgr-linux.c)</li></ul><li style="margin-bottom:0.3em">Increase VG_N_SEGMENTS and VG_N_SEGNAMES.</li><li style="margin-bottom:0.3em">Increase VG_N_THREADS in include/pub_tool_threadstate.h (from 500 to 10000).</li><li style="margin-bottom:0.3em">Notify Valgrind about the <a href="http://code.google.com/p/nativeclient/wiki/NaCl" style="color:rgb(0,0,204)">NaCl</a>'s untrusted memory region:</li><ul style="padding-left:25px;max-width:62em"><li style="margin-bottom:0.3em">add one more client request VG_USERREQNACL_MEM_START (coregrind/pub_core_clreq.h and coregrind/m_scheduler/scheduler.c)</li><li style="margin-bottom:0.3em">Intercept <a href="http://code.google.com/p/nativeclient/wiki/NaCl" style="color:rgb(0,0,204)">NaCl</a>'s StopForDebuggerInit (coregrind/m_replacemalloc/vg_replace_malloc.c).</li></ul><li style="margin-bottom:0.3em">Load debug info from .nexe file:</li><ul style="padding-left:25px;max-width:62em"><li style="margin-bottom:0.3em">Modify di_notify_mmap (coregrind/m_debuginfo/debuginfo.c)</li></ul><li style="margin-bottom:0.3em">valgrind.h, see here: <a href="http://code.google.com/p/nativeclient/source/browse/trunk/src/native_client/src/third_party/valgrind/nacl_valgrind.h" rel="nofollow" style="color:rgb(0,0,204)">http://code.google.com/p/nativeclient/source/browse/trunk/src/native_client/src/third_party/valgrind/nacl_valgrind.h</a></li></ul><p style="line-height:1.25em;max-width:64em;font-family:arial,sans-serif;white-space:normal"><br /></p><h3><a name="TOC-GLibC-support"></a>GLibC support</h3><div><span style="font-family:arial,sans-serif;white-space:normal">To read debug info from untrusted DSOs, significant changes were made to both Valgrind and the untrusted loader (runnable-ld.so).</span></div><div><span style="font-family:arial,sans-serif;white-space:normal"><br /></span></div><div><span style="font-family:arial,sans-serif;white-space:normal">Normally, Valgrind observes all mmap() calls by the programs and looks for three mappings (rw, rx, and ro) from the same file. At this point it identifies the file as a DSO and attempts to read symbols from it. This method does not work with NaCl because the code is copied into the untrusted address space after validation, instead of being mapped directly from a file. Also, large regions are mapped 64K at a time for Windows compatibility reasons.</span></div><div><span style="font-family:arial,sans-serif;white-space:normal"><br /></span></div><div><span style="font-family:arial,sans-serif;white-space:normal">To help Valgrind detect loading of an untrusted DSO, several hooks were added to the dynamic loader: </span><a href="http://git.chromium.org/gitweb/?p=native_client/nacl-glibc.git;a=blob;f=sysdeps/nacl/nacl_dyncode_valgrind.c">nacl_dyncode_valgrind.c</a></div><div><span style="font-family:arial,sans-serif;white-space:normal">These are two pairs of an empty function and a corresponding Valgrind interceptor. During normal execution (w/o Valgrind) the empty function is used adding very little overhead. Valgrind runtime magic replaces it with the interceptor, which sends mapping parameters to the Valgrind core and helps it build a correct view of the process address space.</span></div><div><br /></div></pre><div></div></div></td></tr></tbody></table>
</div> 
</div> 
<div id="sites-canvas-bottom-panel">
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_page-subpages"> </div>
<div id="sites-attachments-container">
</div>
<a xmlns="http://www.w3.org/1999/xhtml" name="page-comments"></a>
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_page-comments"><div class="sites-comment-docos-wrapper"><div class="sites-comment-docos"><div class="sites-comment-docos-background"></div><div class="sites-comment-docos-header"><div class="sites-comment-docos-header-title">Comments</div></div><div id="sites-comment-docos-pane" class="sites-comment-docos-pane"></div></div></div></div>
</div>
</div> 
</td> 
</tr>
</table> 
</div> 
</div> 
<div id="sites-chrome-footer-wrapper">
<div id="sites-chrome-footer-wrapper-inside">
<div id="sites-chrome-footer">
</div>
</div>
</div>
</div> 
</div> 
<div id="sites-chrome-adminfooter-container">
<div xmlns="http://www.w3.org/1999/xhtml" class="sites-adminfooter" role="navigation"><p><a class="sites-system-link" href="https://www.google.com/a/UniversalLogin?service=jotspot&amp;continue=https://sites.google.com/a/chromium.org/dev/nativeclient/how-tos/debugging-documentation/running-under-valgrind">Sign in</a><span aria-hidden="true">|</span><a class="sites-system-link" href="/system/app/pages/recentChanges">Recent Site Activity</a><span aria-hidden="true">|</span><a class="sites-system-link" href="/system/app/pages/reportAbuse" target="_blank">Report Abuse</a><span aria-hidden="true">|</span><a class="sites-system-link" href="javascript:;" onclick="window.open(webspace.printUrl)">Print Page</a><span aria-hidden="true">|</span><span class="sites-system-link">Powered By</span> <b class="powered-by"><a href="http://sites.google.com">Google Sites</a></b></p></div>
</div>
</div> 
</div> 
<div id="sites-chrome-onebar-footer">
</div>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
    window.jstiming.load.tick('sjl');
  </script>
<script xmlns="http://www.w3.org/1999/xhtml" src="https://ssl.gstatic.com/sites/p/56e332/system/js/jot_min_view__en.js"></script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
    window.jstiming.load.tick('jl');
  </script>
<script xmlns="http://www.w3.org/1999/xhtml">
      
          sites.core.Analytics.createTracker();
          sites.core.Analytics.trackPageview();
        
    </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
                    sites.Searchbox.initialize(
                        'sites-searchbox-search-button',
                        {"object":[]}['object'],
                        'search-site',
                        {"label":"Configure search options...","url":"/system/app/pages/admin/settings"});
                  </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
      gsites.HoverPopupMenu.createSiteDropdownMenus('sites-header-nav-dropdown', false);
    </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript" defer="true">
            JOT_setupNav("7648876402527094", "Navigation", false);
            JOT_addListener('titleChange', 'JOT_NAVIGATION_titleChange', 'COMP_7648876402527094');
          </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript" defer="true">
            JOT_setupNav("14720868319272995", "Quick links", false);
            JOT_addListener('titleChange', 'JOT_NAVIGATION_titleChange', 'COMP_14720868319272995');
          </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript" defer="true">
            JOT_setupNav("19690813310444355", "Other sites", false);
            JOT_addListener('titleChange', 'JOT_NAVIGATION_titleChange', 'COMP_19690813310444355');
          </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
              new sites.CommentPane('//docs.google.com/comments/d/AAHRpnXvrAwjAfmld0ObrebBiGRq94KZe05K4NUhVqU22BYBFoYyoofeag3D4MXgBjQHAmmVPphApgowXrvq-k6cxNpKG2-SKw-gsVVSdVayYrriOB66g0TpnL8WASPqrRYoUcZfdDKOq/api/js?anon=true',
                  false, false);
            </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
  setTimeout(function() {
    var fingerprint = gsites.date.TimeZone.getFingerprint([]);
    gsites.Xhr.send('https://www.chromium.org/_/tz', null, null, 'GET', null, null, { afjstz: fingerprint });
  }, 500);
</script>
<script xmlns="http://www.w3.org/1999/xhtml">
                    window.onload = function() {
                      if (false) {
                        JOT_setMobilePreview();
                      }
                      var loadTimer = window.jstiming.load;
                      loadTimer.tick("ol");
                      loadTimer["name"] = "load," + webspace.page.type + ",user_page";
                      window.jstiming.report(loadTimer, {}, 'https://gg.google.com/csi');
                    }
                  </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
        JOT_insertAnalyticsCode(false,
            false);
      </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
    var maestroRunner = new gsites.pages.view.SitesMaestroRunner(
        webspace, "en");
    maestroRunner.initListeners();
    maestroRunner.installEditRender();
  </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript" defer="true">
  //<![CDATA[
    // Decorate any fastUI buttons on the page with a class of 'goog-button'.
    if (webspace.user.hasWriteAccess) {
      JOT_decorateButtons();
    }

    // Fires delayed events.
    (function() {
      JOT_fullyLoaded = true;
      var delayedEvents = JOT_delayedEvents;
      for (var x = 0; x < delayedEvents.length; x++) {
        var event = delayedEvents[x];
        JOT_postEvent(event.eventName, event.eventSrc, event.payload);
      }
      JOT_delayedEvents = null;
      JOT_postEvent('pageLoaded');
    })();
  //]]>
</script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
    JOT_postEvent('decorateGvizCharts');
  </script>
<script type="text/javascript">
          JOT_setupPostRenderingManager();
        </script>
<script type="text/javascript">
          JOT_postEvent('renderPlus', null, 'sites-chrome-main');
        </script>
<div id="server-timer-div" style="display:none"> </div>
<script type="text/javascript">
          window.jstiming.load.tick('render');
          JOT_postEvent('usercontentrendered', this);
        </script>
</body>
</html>
