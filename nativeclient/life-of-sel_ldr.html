<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/WebPage">
<head>
<meta http-equiv="X-UA-Compatible" content="chrome=1" />
<script type="text/javascript">/* Copyright 2008 Google. */ (function() { var e="wtsrt_",g="tbsd_",h="tbnd_",k="start",l="_wtsrt",m="_tbnd",n="CSI/";(function(){function f(a){this.t={};this.tick=function(a,c,b){this.t[a]=[void 0!=b?b:(new Date).getTime(),c];if(void 0==b)try{window.console.timeStamp(n+a)}catch(d){}};this.tick(k,null,a)}var a;window.performance&&(a=window.performance.timing);var p=a?new f(a.responseStart):new f;window.jstiming={Timer:f,load:p};if(a){var c=a.navigationStart,d=a.responseStart;0<c&&d>=c&&(window.jstiming.srt=d-c)}if(a){var b=window.jstiming.load;0<c&&d>=c&&(b.tick(l,void 0,c),b.tick(e,l,d),b.tick(g,e))}try{a=null,
window.chrome&&window.chrome.csi&&(a=Math.floor(window.chrome.csi().pageT),b&&0<c&&(b.tick(m,void 0,window.chrome.csi().startE),b.tick(h,m,c))),null==a&&window.gtbExternal&&(a=window.gtbExternal.pageT()),null==a&&window.external&&(a=window.external.pageT,b&&0<c&&(b.tick(m,void 0,window.external.startE),b.tick(h,m,c))),a&&(window.jstiming.pt=a)}catch(q){}})(); })()
</script>
<link rel="shortcut icon" href="http://www.chromium.org/_/rsrc/1354323194313/favicon.ico" type="image/x-icon" />
<link rel="apple-touch-icon" href="http://www.gstatic.com/sites/p/56e332/system/app/images/apple-touch-icon.png" type="image/png" />
<script type="text/javascript">/* Copyright 2008 Google. */ (function() { var d="",g="__duration__",h="function";function k(c){return document.getElementById(c)}window.byId=k;function l(c){return c.replace(/^\s+|\s+$/g,d)}window.trim=l;var m=[],n=0;window.JOT_addListener=function(c,a,b){var e=new String(n++);c={eventName:c,handler:a,compId:b,key:e};m.push(c);return e};window.JOT_removeListenerByKey=function(c){for(var a=0;a<m.length;a++)if(m[a].key==c){m.splice(a,1);break}};
window.JOT_removeAllListenersForName=function(c){for(var a=0;a<m.length;a++)m[a].eventName==c&&m.splice(a,1)};window.JOT_postEvent=function(c,a,b){var e={eventName:c,eventSrc:a||{},payload:b||{}};if(window.JOT_fullyLoaded)for(a=m.length,b=0;b<a&&b<m.length;b++){var f=m[b];f&&f.eventName==c&&(e.listenerCompId=f.compId||d,(f=typeof f.handler==h?f.handler:window[f.handler])&&f(e))}else window.JOT_delayedEvents.push({eventName:c,eventSrc:a,payload:b})};window.JOT_delayedEvents=[];
window.JOT_fullyLoaded=!1;window.JOT_formatRelativeToNow=function(c,a){var b=((new Date).getTime()-c)/6E4;if(1440<=b||0>b)return null;var e=0;60<=b&&(b/=60,e=2);2<=b&&e++;return a?window.JOT_siteRelTimeStrs[e].replace(g,Math.floor(b)):window.JOT_userRelTimeStrs[e].replace(g,Math.floor(b))}; })()
</script>
<script>

  

  var breadcrumbs = [{"path":"/nativeclient","deleted":false,"title":"Native Client","dir":"ltr"},{"path":"/nativeclient/life-of-sel_ldr","deleted":false,"title":"The life of sel_ldr","dir":"ltr"}];
  var JOT_clearDotPath = 'http://www.gstatic.com/sites/p/56e332/system/app/images/cleardot.gif';

  
  var JOT_userRelTimeStrs = ["a minute ago","__duration__ minutes ago","an hour ago","__duration__ hours ago"];

  
  

  

  var webspace = {"enableAnalytics":true,"pageSharingId":"jotspot_page","enableUniversalAnalytics":false,"sharingPolicy":"OPENED_WITH_INDICATOR","siteTitle":"The Chromium Projects","isStartPageEnabled":true,"adsensePublisherId":null,"features":{"languageSelectDefaultTextSetToDefault":true,"validateClientGvizDataSourceUrls":true,"moreMobileStyleImprovements":true,"newInsertMenuIcons":true,"accessibleSortingButtons":true,"domainAnalyticsInGAOnly":true,"noCaptcha":true,"fileCabinetScreenReaderFix":true,"updatedTosAndPrivacyLinks":null,"pageDrafts":false,"mobileOrientationFix":true,"plusBadge":false,"pdfEmbedSupport":false,"jsClickFix":true},"isPublic":true,"isConsumer":false,"serverFlags":{"cajaBaseUrl":"//www.gstatic.com/caja","cajaDebugMode":false},"onepickBaseUrl":"https://docs.google.com","domainAnalyticsAccountId":"","plusPageId":"","signInUrl":"https://www.google.com/a/SelectSession?continue\u003dhttp://sites.google.com/a/chromium.org/dev/nativeclient/life-of-sel_ldr\u0026service\u003djotspot","analyticsAccountId":"UA-5484340-1","scottyUrl":"/_/upload","homePath":"/","siteNoticeUrlEnabled":null,"plusPageUrl":"","adsensePromoClickedOrSiteIneligible":true,"csiReportUri":"http://csi.gstatic.com/csi","sharingId":"jotspot","termsUrl":"//www.google.com/intl/en/policies/terms/","gvizVersion":1,"editorResources":{"sitelayout":["http://www.gstatic.com/sites/p/56e332/system/app/css/sitelayouteditor.css"],"text":["http://www.gstatic.com/sites/p/56e332/system/js/codemirror.js","http://www.gstatic.com/sites/p/56e332/system/app/css/codemirror_css.css","http://www.gstatic.com/sites/p/56e332/system/js/trog_edit__en.js","http://www.gstatic.com/sites/p/56e332/system/app/css/trogedit.css","/_/rsrc/1441580320000/system/app/css/editor.css","http://www.gstatic.com/sites/p/56e332/system/app/css/codeeditor.css","/_/rsrc/1441580320000/system/app/css/camelot/editor-jfk-wlb.css"]},"sharingUrlPrefix":"/_/sharing","isAdsenseEnabled":true,"domain":"chromium.org","baseUri":"","name":"dev","siteTemplateId":false,"siteNoticeRevision":null,"siteNoticeUrlAddress":null,"siteNoticeMessage":null,"page":{"isRtlLocale":false,"canDeleteWebspace":null,"isPageDraft":null,"parentPath":"/nativeclient","parentWuid":"wuid:gx:4e999fa9833074a1","siteLocale":"en","timeZone":"America/Los_Angeles","type":"text","title":"The life of sel_ldr","locale":"en","wuid":"wuid:gx:58b5710bdc056e66","revision":15,"path":"/nativeclient/life-of-sel_ldr","isSiteRtlLocale":false,"pageInheritsPermissions":null,"name":"life-of-sel_ldr","canChangePath":true,"state":"","properties":{},"bidiEnabled":false,"currentTemplate":{"path":"/system/app/pagetemplates/text","title":"Web Page"}},"canPublishScriptToAnyone":true,"user":{"keyboardShortcuts":true,"sessionIndex":"","guest_":true,"displayNameOrEmail":"guest","userName":"guest","uid":"","renderMobile":false,"domain":"","namespace":"","hasWriteAccess":false,"namespaceUser":false,"primaryEmail":"guest","hasAdminAccess":false},"gadgets":{"baseUri":"/system/app/pages/gadgets"}};
  webspace.page.breadcrumbs = breadcrumbs;

  
  var JOT_siteRelTimeStrs = ["a minute ago","__duration__ minutes ago","an hour ago","__duration__ hours ago"];

</script>
<script type="text/javascript">
                window.jstiming.load.tick('scl');
              </script>
<meta name="title" content="The life of sel_ldr - The Chromium Projects" />
<meta itemprop="name" content="The life of sel_ldr - The Chromium Projects" />
<meta property="og:title" content="The life of sel_ldr - The Chromium Projects" />
<meta name="description" content="Home of the Chromium Open Source Project" />
<meta itemprop="description" content="Home of the Chromium Open Source Project" />
<meta id="meta-tag-description" property="og:description" content="Home of the Chromium Open Source Project" />
<style type="text/css">
</style>
<link rel="stylesheet" type="text/css" href="http://www.gstatic.com/sites/p/56e332/system/app/themes/beigeandblue/standard-css-beigeandblue-ltr-ltr.css" />
<link rel="stylesheet" type="text/css" href="http://www.chromium.org/_/rsrc/1441580320000/system/app/css/overlay.css?cb=beigeandblueundefineda100%25%25150goog-ws-leftthemedefaultstandard" />
<link rel="stylesheet" type="text/css" href="http://www.chromium.org/_/rsrc/1441580320000/system/app/css/camelot/allthemes-view.css" />
<!--[if IE]>
          <link rel="stylesheet" type="text/css" href="/system/app/css/camelot/allthemes%2die.css" />
        <![endif]-->
<title>The life of sel_ldr - The Chromium Projects</title>
<meta itemprop="image" content="/_/rsrc/1438879449147/config/customLogo.gif?revision=3" />
<meta property="og:image" content="/_/rsrc/1438879449147/config/customLogo.gif?revision=3" />
<script type="text/javascript">
                window.jstiming.load.tick('cl');
              </script>
</head>
<body xmlns="http://www.google.com/ns/jotspot" id="body" class=" en            ">
<div id="sites-page-toolbar" class="sites-header-divider">
<div xmlns="http://www.w3.org/1999/xhtml" id="sites-status" class="sites-status" style="display:none;"><div id="sites-notice" class="sites-notice" role="status" aria-live="assertive"> </div></div>
</div>
<div id="sites-chrome-everything-scrollbar">
<div id="sites-chrome-everything" class="">
<div id="sites-chrome-page-wrapper" style="direction: ltr">
<div id="sites-chrome-page-wrapper-inside">
<div xmlns="http://www.w3.org/1999/xhtml" id="sites-chrome-header-wrapper" style="height:auto;">
<table id="sites-chrome-header" class="sites-layout-hbox" cellspacing="0" style="height:auto;">
<tr class="sites-header-primary-row" id="sites-chrome-userheader">
<td id="sites-header-title" class="" role="banner"><div class="sites-header-cell-buffer-wrapper"><a href="http://www.chromium.org/" id="sites-chrome-userheader-logo"><img id="logo-img-id" src="http://www.chromium.org/_/rsrc/1438879449147/config/customLogo.gif?revision=3" alt="The Chromium Projects" class="sites-logo  " /></a><h2><a href="http://www.chromium.org/" dir="ltr" id="sites-chrome-userheader-title">The Chromium Projects</a></h2></div></td><td class="sites-layout-searchbox  "><div class="sites-header-cell-buffer-wrapper"><form id="sites-searchbox-form" action="http://www.chromium.org/system/app/pages/search" role="search"><input type="hidden" id="sites-searchbox-scope" name="scope" value="search-site" /><input type="text" id="jot-ui-searchInput" name="q" size="20" value="" aria-label="Search this site" /><div id="sites-searchbox-button-set" class="goog-inline-block"><div role="button" id="sites-searchbox-search-button" class="goog-inline-block jfk-button jfk-button-standard" tabindex="0">Search this site</div></div></form></div></td>
</tr>
<tr class="sites-header-secondary-row" id="sites-chrome-horizontal-nav">
<td colspan="2" id="sites-chrome-header-horizontal-nav-container" role="navigation">
</td>
</tr>
</table>
</div>
<div id="sites-chrome-main-wrapper">
<div id="sites-chrome-main-wrapper-inside">
<table id="sites-chrome-main" class="sites-layout-hbox" cellspacing="0" cellpadding="{scmCellpadding}" border="0">
<tr>
<td id="sites-chrome-sidebar-left" class="sites-layout-sidebar-left initial" style="width:150px">
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_7648876402527094" class="sites-embed" role="navigation"><div class="sites-embed-content sites-sidebar-nav"><ul role="navigation" jotId="navList"><li class="nav-first "><div dir="ltr" style="padding-left: 5px;"><a href="http://www.chromium.org/chromium-projects" jotId="wuid:gx:10ae433dadbbab13" class="sites-navigation-link">Home</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="../Home.html" jotId="wuid:gx:43582b9d2029d3af" class="sites-navigation-link">Chromium</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="../chromium-os.html" jotId="wuid:gx:83df2ab1f8880ba" class="sites-navigation-link">Chromium OS</a></div></li></ul></div></div>
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_14720868319272995" class="sites-embed" role="navigation"><h4 class="sites-embed-title">Quick links</h4><div class="sites-embed-content sites-sidebar-nav"><ul role="navigation" jotId="navList"><li class="nav-first "><div dir="ltr" style="padding-left: 5px;"><a href="../for-testers/bug-reporting-guidelines.html" class="sites-navigation-link">Report bugs</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="../developers/discussion-groups.html" class="sites-navigation-link">Discuss</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="http://www.chromium.org/system/app/pages/sitemap/hierarchy" jotId="wuid:gx:4b58a9a350ad12f" class="sites-navigation-link">网站地图</a></div></li></ul></div></div>
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_19690813310444355" class="sites-embed" role="navigation"><h4 class="sites-embed-title">Other sites</h4><div class="sites-embed-content sites-sidebar-nav"><ul role="navigation" jotId="navList"><li class="nav-first "><div dir="ltr" style="padding-left: 5px;"><a href="http://blog.chromium.org/" class="sites-navigation-link">Chromium Blog</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="http://code.google.com/chrome/extensions/" class="sites-navigation-link">Google Chrome Extensions</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="https://developers.google.com/chrome/chrome-frame/" class="sites-navigation-link">Google Chrome Frame</a></div></li></ul></div></div>
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_19695218559354544" class="sites-embed" role="complementary"><h4 class="sites-embed-title"></h4><div class="sites-embed-content sites-embed-content-sidebar-textbox"><div dir="ltr"><span style="font-size:x-small">Except as otherwise </span><a href="http://developers.google.com/site-policies.html#restrictions"><span style="font-size:x-small">noted</span></a><span style="font-size:x-small">, the content of this page is licensed under a </span><a href="http://creativecommons.org/licenses/by/2.5/"><span style="font-size:x-small">Creative Commons Attribution 2.5 license</span></a><span style="font-size:x-small">, and examples are licensed under the </span><a href="http://src.chromium.org/viewvc/chrome/trunk/src/LICENSE" target="_blank"><span style="font-size:x-small">BSD License</span></a><span style="font-size:x-small">.<br /></span></div></div></div>
</td>
<td id="sites-canvas-wrapper">
<div id="sites-canvas" role="main">
<div id="goog-ws-editor-toolbar-container"> </div>
<div xmlns="http://www.w3.org/1999/xhtml" id="title-crumbs" style="">
<A href="../nativeclient.html" dir="ltr">Native Client</A>‎ &gt; ‎
  </div>
<h3 xmlns="http://www.w3.org/1999/xhtml" id="sites-page-title-header" style="" align="left">
<span id="sites-page-title" dir="ltr" tabindex="-1" style="outline: none">The life of sel_ldr</span>
</h3>
<div id="sites-canvas-main" class="sites-canvas-main">
<div id="sites-canvas-main-content">
<table xmlns="http://www.w3.org/1999/xhtml" cellspacing="0" class="sites-layout-name-one-column sites-layout-hbox"><tbody><tr><td class="sites-layout-tile sites-tile-name-content-1"><div dir="ltr">sel_ldr stands for Secure ELF Loader and is the heart of Native Client. The plugin (or other supervisor) starts sel_ldr, loads nacl module, opens SRPC channels, communicates and terminates sel_ldr at the end.<div><br /></div><div><b><span style="font-size:medium">Starting sel_ldr</span></b></div><div><br /></div><div>In order to start sel_ldr, we need to create a <span style="font-family:monospace;font-size:medium;white-space:pre">socketpair(AF_UNIX, SOCK_DGRAM, 0, fds)</span> and pass the one side of it to sel_ldr.</div><div>The minimal set of sel_ldr arguments is:</div><div><br /></div><div><font face="'courier new', monospace">sel_ldr -i D:5 -X 5 -- nacl_module &lt;nacl_module_args&gt;</font></div><div><br /></div><div>where D=fds[0] is the file descriptor of the above socketpair half. This socketpair is the service socket which will be used to obtain some descriptors from sel_ldr.<br /><div><br /></div></div><div><span style="font-size:medium"><b>Receiving a bound socket</b></span></div><div><br /></div><div>The first action we need to do is to receive a bound socket that will be used to open SRPC channels. It's very simple, we need just to call recvmsg on the plugin's half of the above socketpair. The simplification of <font face="'courier new', monospace">src/nonnacl_util/sel_ldr_launcher.cc::GetSockAddr</font> method:</div><div><br /></div><div><font face="'courier new', monospace">int* control = (int*)calloc(100, sizeof(int));</font></div><div><font face="'courier new', monospace">struct iovec iov;</font></div><div><font face="'courier new', monospace"><br /></font></div><div><font face="'courier new', monospace">iov.iov_base = calloc(100, 1);</font></div><div><font face="'courier new', monospace">iov.iov_len = 100;</font></div><div><font face="'courier new', monospace"><br /></font></div><div><font face="'courier new', monospace">struct msghdr msg;</font></div><div><font face="'courier new', monospace">msg.msg_name = NULL;</font></div><div><font face="'courier new', monospace">msg.msg_namelen = 0;</font></div><div><font face="'courier new', monospace">msg.msg_iov = &amp;iov;</font></div><div><font face="'courier new', monospace">msg.msg_iovlen = 1;</font></div><div><font face="'courier new', monospace">msg.msg_control = control;</font></div><div><font face="'courier new', monospace">msg.msg_controllen = 100 * sizeof(int);</font></div><div><font face="'courier new', monospace">msg.msg_flags = 0;</font></div><div><font face="'courier new', monospace"><br /></font></div><div><font face="'courier new', monospace">recvmsg(fds[1], &amp;msg, 0)</font></div><div><font face="'courier new', monospace"><br /></font></div><div><font face="'courier new', monospace">int bound_socket = control[4]; // This is the socket we wanted to receive</font></div><div><font face="'courier new', monospace">// NOTE: this is a hacky code, it does not check for errors, so it should not be used in production.</font></div><div><br /></div><div>See <font face="'courier new', monospace">man recvmsg</font> for more details.</div><div><br /></div><div>Also, you can look into <a href="http://ptspts.blogspot.com/2009/11/fuse-protocol-tutorial-for-linux-26.html">fuse tutorial</a>. They also start fusermount with a socketpair like above and receive the file descriptor to communicate with the kernel. That documentation could be a good explanation why does it work this way.</div><div><br /></div><div><b><span style="font-size:medium">Opening SRPC channels</span></b></div><div><br /></div><div>The plugin opens 2 SRPC channels: trusted_command, and untrusted. The first one is used to pass commands to the trusted part of sel_ldr. It is opened first and we need to do the following:</div><div><br /></div><div>1. Create a DGRAM socket pair like we did in the first paragraph</div><div>2. Send a half of the socket pair to bound_socket via sendmsg (see below for a code snippet)</div><div>3. Use the other half of the socket pair as the descriptor for SRPC channel</div><div><br /></div><div>Sending a file descriptor is very similar to receiving:</div><div><br /></div><div><br /></div><div><span style="font-family:monospace;font-size:medium;white-space:pre">int srpc_fds[2];</span></div><div><span style="font-family:monospace;font-size:medium;white-space:pre">socketpair(AF_UNIX, SOCK_DGRAM, 0, srpc_fds)</span></div><div><div><font face="'courier new', monospace">int* control = (int*)calloc(100, sizeof(int));</font></div><div><font face="'courier new', monospace">control[0] = 20;</font></div><div><font face="'courier new', monospace">control[1] = 0;</font></div><div><font face="'courier new', monospace">control[2] = 1;</font></div><div><font face="'courier new', monospace">control[3] = 1;</font></div><div><font face="'courier new', monospace">control[4] = srpc_fds[0]; // Sending the half of the socket pair</font></div><div><font face="'courier new', monospace">struct iovec iov;</font></div><div><font face="'courier new', monospace"><br /></font></div><div><font face="'courier new', monospace">char* base = (char*) calloc(100, 1);</font></div><div><font face="'courier new', monospace">base[0] = 'c';</font></div><div><font face="'courier new', monospace">iov.iov_base = base</font></div><div><font face="'courier new', monospace">iov.iov_len = 1;</font></div><div><font face="'courier new', monospace"><br /></font></div><div><font face="'courier new', monospace">struct msghdr msg;</font></div><div><font face="'courier new', monospace">msg.msg_name = NULL;</font></div><div><font face="'courier new', monospace">msg.msg_namelen = 0;</font></div><div><font face="'courier new', monospace">msg.msg_iov = &amp;iov;</font></div><div><font face="'courier new', monospace">msg.msg_iovlen = 1;</font></div><div><font face="'courier new', monospace">msg.msg_control = control;</font></div><div><font face="'courier new', monospace">msg.msg_controllen = 20;</font></div><div><font face="'courier new', monospace">msg.msg_flags = 0;</font></div><div><font face="'courier new', monospace"><br /></font></div><div><font face="'courier new', monospace">sendmsg(bound_socket, &amp;msg, 0)</font></div></div><div><font face="'courier new', monospace"><br /></font></div><div><font face="'courier new', monospace">// srpc_fds[1] is the fd to use for SRPC communication</font></div><div><font face="'courier new', monospace"><br /></font></div><div><font face="arial, sans-serif">So, the first SRPC channel is opened and we will call it trusted_command channel. The first what we should do with it is to call SRPC method service_discovery::C to get the list of available SRPC methods for this channel. service_discovery method always has index 0, so we can do it w/o the knowledge of the available methods.</font></div><div><font face="arial, sans-serif"><br /></font></div><div><font face="arial, sans-serif">To read about SRPC, go to <a href="../system/errors/NodeNotFound%3Fsuri=wuid:gx:3e5ac6935bee42c7.html" class="disabled">Using Simple RPC to Implement Native Client Services</a>, the <a href="http://nativeclient.googlecode.com/svn/data/docs_tarball/nacl/googleclient/native_client/scons-out/doc/html/group___s_r_p_c.html">reference</a> or </font><font face="'courier new', monospace">native_client/src/shared/srpc</font><font face="arial, sans-serif"> in the Native Client sources. Take a look into native_client/src/shared/srpc/rpc_serialize.c to get understanding of SRPC marshalling.</font></div><div><font face="arial, sans-serif"><br /></font></div><div><font face="arial, sans-serif">To call SRPC method we need to sendmsg with the serialized SRPC call and after that recvmsg to get the answer. In the simplest case of service_discovery::C we need to send the following:</font></div><div><font face="arial, sans-serif"><br /></font></div><div><font face="'courier new', monospace">iov = [{"\1\336\300\323\0\0\0\0\0\0\0\0\0\0\0\0", 16}, {"\2\0\332\300\0\0\0\0\0\0\0\0\1\0\0\0\0\0\0\0\0\1\0\0\0C\240\17\0\0", 30}]</font></div><div><font face="arial, sans-serif"><br /></font></div><div><font face="arial, sans-serif">The first string is an SRPC banner that is constant.</font></div><div><font face="arial, sans-serif">The second string has the following format (according to </font><font face="'courier new', monospace">native_client/src/shared/srpc/rpc_serialize.c</font><font face="arial, sans-serif">):</font></div><div><font face="arial, sans-serif"><br /></font></div><div><font face="arial, sans-serif"><div><font face="'courier new', monospace">/*</font></div><div><font face="'courier new', monospace"> * Message formats:</font></div><div><font face="'courier new', monospace"> * SRPC communicates using two main message types, requests and responses.</font></div><div><font face="'courier new', monospace"> * Both are communicated with an rpc (header) prepended.</font></div><div><font face="'courier new', monospace"> *</font></div><div><font face="'courier new', monospace"> * rpc:</font></div><div><font face="'courier new', monospace"> *   protocol               - (uint32_t) 4 bytes</font></div><div><font face="'courier new', monospace"> *   message id             - (uint64_t) 8 bytes</font></div><div><font face="'courier new', monospace"> *   request/response       - (uint8_t) 1 byte</font></div><div><font face="'courier new', monospace"> *   rpc method index       - (uint32_t) 4 bytes</font></div><div><font face="'courier new', monospace"> *   return code            - (uint32_t) 4 bytes (only sent for responses)</font></div><div><font face="'courier new', monospace"> *</font></div><div><font face="'courier new', monospace"> * request:</font></div><div><font face="'courier new', monospace"> *   #args                  - (uint32_t) 4 bytes</font></div><div><font face="'courier new', monospace"> *   #args * (arg value)    - varying size defined by interface below</font></div><div><font face="'courier new', monospace"> *   #rets                  - (uint32_t) 4 bytes</font></div><div><font face="'courier new', monospace"> *   #rets * (arg template) - varying size defined by interface below</font></div><div><font face="'courier new', monospace"> *</font></div><div><font face="'courier new', monospace"> * response:</font></div><div><font face="'courier new', monospace"> *   #rets                  - (uint32_t) 4 bytes</font></div><div><font face="'courier new', monospace"> *   #rets * (arg value)    - varying size defined by interface below</font></div><div><font face="'courier new', monospace"> *</font></div><div><font face="'courier new', monospace"> */</font></div><div><br /></div><div>When we sent service_discover::C message, sel_ldr will reply with something like:</div><div><br /></div><div><font face="'courier new', monospace">msg_iov(2)=[</font></div><div><font face="'courier new', monospace"> {"\1\336\300\323\0\0\0\0\0\0\0\0\0\0\0\0", 16},</font></div><div><font face="'courier new', monospace"> {"\2\0\332\300\0\0\0\0\0\0\0\0\0\0\0\0\0\0\1\0\0\1\0\0\0CM\0\0\0service_discovery::C\nhard_shutdown::\nstart_module::i\nlog:is:\nload_module:h:\n\0", 107}</font></div><div><font face="'courier new', monospace">]</font></div><div><br /></div><div>As we can see, the first 16 bytes are still the SRPC banner. The second string contains the list of methods:</div><div><br /></div><div><font face="'courier new', monospace">service_discovery::C</font></div><div><font face="'courier new', monospace">hard_shutdown::</font></div><div><font face="'courier new', monospace">start_module::i</font></div><div><font face="'courier new', monospace">log:is:</font></div><div><font face="'courier new', monospace">load_module:h:</font></div><div><br /></div><div>Before we can open the untrusted SRPC channel, we need to start a NaCl module. Currently, sel_ldr has been validated and initialized nacl_module but not started it.</div><div><br /></div><div>As we can see, start_module has the index 2, so the corresponding message (omitting the banner) is:<br /><font face="'courier new', monospace">"\2\0\332\300\0\0\0\0\0\0\0\0\1\2\0\0\0\0\0\0\0\1\0\0\0i"</font></div><div><font face="'courier new', monospace"><br /></font></div><div>Sel_ldr will reply with:</div><div><font face="'courier new', monospace">"\2\0\332\300\0\0\0\0\0\0\0\0\0\2\0\0\0\0\1\0\0\1\0\0\0i\0\0\0\0"</font></div><div><font face="'courier new', monospace"><br /></font></div><div>Now we can open the untrusted SRPC channel. It's completely the same procedure as opening the trusted_command channel: make a socket pair, sent it to the bound socket, obtain the list of methods via service_discovery::C. When it's done, everything is initialized. NaCl module has been started to work and sel_ldr will be alive until the termination of untrusted program (represented by a NaCl module) or until the supervisor (e.g. the plugin) tells to sel_ldr that it needs to shutdown.</div><div><br /></div><div>Hopefully, this information will be needed to just a few developers which are working on implementing alternative plugins for Native Client or other sandboxing libraries (for example, for server-side NaCl).</div><div><br /></div><div>Note, that this is a low level information which were obtained with strace. All the process could be changed over time and there were the changes last three months. So, it's more likely an overview of what's happening, nothing more.</div><div><br /></div><div><br /></div></font></div></div></td></tr></tbody></table>
</div> 
</div> 
<div id="sites-canvas-bottom-panel">
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_page-subpages"> </div>
<div id="sites-attachments-container">
</div>
<a xmlns="http://www.w3.org/1999/xhtml" name="page-comments"></a>
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_page-comments"><div class="sites-comment-docos-wrapper"><div class="sites-comment-docos"><div class="sites-comment-docos-background"></div><div class="sites-comment-docos-header"><div class="sites-comment-docos-header-title">Comments</div></div><div id="sites-comment-docos-pane" class="sites-comment-docos-pane"></div></div></div></div>
</div>
</div> 
</td> 
</tr>
</table> 
</div> 
</div> 
<div id="sites-chrome-footer-wrapper">
<div id="sites-chrome-footer-wrapper-inside">
<div id="sites-chrome-footer">
</div>
</div>
</div>
</div> 
</div> 
<div id="sites-chrome-adminfooter-container">
<div xmlns="http://www.w3.org/1999/xhtml" class="sites-adminfooter" role="navigation"><p><a class="sites-system-link" href="https://www.google.com/a/UniversalLogin?service=jotspot&amp;continue=http://sites.google.com/a/chromium.org/dev/nativeclient/life-of-sel_ldr">Sign in</a><span aria-hidden="true">|</span><a class="sites-system-link" href="http://www.chromium.org/system/app/pages/recentChanges">Recent Site Activity</a><span aria-hidden="true">|</span><a class="sites-system-link" href="http://www.chromium.org/system/app/pages/reportAbuse" target="_blank">Report Abuse</a><span aria-hidden="true">|</span><a class="sites-system-link" href="javascript:;" onclick="window.open(webspace.printUrl)">Print Page</a><span aria-hidden="true">|</span><span class="sites-system-link">Powered By</span> <b class="powered-by"><a href="http://sites.google.com">Google Sites</a></b></p></div>
</div>
</div> 
</div> 
<div id="sites-chrome-onebar-footer">
</div>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
    window.jstiming.load.tick('sjl');
  </script>
<script xmlns="http://www.w3.org/1999/xhtml" src="http://www.gstatic.com/sites/p/56e332/system/js/jot_min_view__en.js"></script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
    window.jstiming.load.tick('jl');
  </script>
<script xmlns="http://www.w3.org/1999/xhtml">
      
          sites.core.Analytics.createTracker();
          sites.core.Analytics.trackPageview();
        
    </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
                    sites.Searchbox.initialize(
                        'sites-searchbox-search-button',
                        {"object":[]}['object'],
                        'search-site',
                        {"label":"Configure search options...","url":"/system/app/pages/admin/settings"});
                  </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
      gsites.HoverPopupMenu.createSiteDropdownMenus('sites-header-nav-dropdown', false);
    </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript" defer="true">
            JOT_setupNav("7648876402527094", "Navigation", false);
            JOT_addListener('titleChange', 'JOT_NAVIGATION_titleChange', 'COMP_7648876402527094');
          </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript" defer="true">
            JOT_setupNav("14720868319272995", "Quick links", false);
            JOT_addListener('titleChange', 'JOT_NAVIGATION_titleChange', 'COMP_14720868319272995');
          </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript" defer="true">
            JOT_setupNav("19690813310444355", "Other sites", false);
            JOT_addListener('titleChange', 'JOT_NAVIGATION_titleChange', 'COMP_19690813310444355');
          </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
              new sites.CommentPane('//docs.google.com/comments/d/AAHRpnXvrAwjAfmld0ObrebBiGRq9j30TVPrk31En36vY6-auIS5pKDLZPZ80nlDLXQbTp-oFUur_omu5H3DDuSeO1BWnGK7qJ0PB_7VmzR_w7ThabsWXbngUO2U4lBX8dd6TuMbmhCsF/api/js?anon=true',
                  false, false);
            </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
  setTimeout(function() {
    var fingerprint = gsites.date.TimeZone.getFingerprint([]);
    gsites.Xhr.send('http://www.chromium.org/_/tz', null, null, 'GET', null, null, { afjstz: fingerprint });
  }, 500);
</script>
<script xmlns="http://www.w3.org/1999/xhtml">
                    window.onload = function() {
                      if (false) {
                        JOT_setMobilePreview();
                      }
                      var loadTimer = window.jstiming.load;
                      loadTimer.tick("ol");
                      loadTimer["name"] = "load," + webspace.page.type + ",user_page";
                      window.jstiming.report(loadTimer, {}, 'http://csi.gstatic.com/csi');
                    }
                  </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
        JOT_insertAnalyticsCode(false,
            false);
      </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
    var maestroRunner = new gsites.pages.view.SitesMaestroRunner(
        webspace, "en");
    maestroRunner.initListeners();
    maestroRunner.installEditRender();
  </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript" defer="true">
  //<![CDATA[
    // Decorate any fastUI buttons on the page with a class of 'goog-button'.
    if (webspace.user.hasWriteAccess) {
      JOT_decorateButtons();
    }

    // Fires delayed events.
    (function() {
      JOT_fullyLoaded = true;
      var delayedEvents = JOT_delayedEvents;
      for (var x = 0; x < delayedEvents.length; x++) {
        var event = delayedEvents[x];
        JOT_postEvent(event.eventName, event.eventSrc, event.payload);
      }
      JOT_delayedEvents = null;
      JOT_postEvent('pageLoaded');
    })();
  //]]>
</script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
    JOT_postEvent('decorateGvizCharts');
  </script>
<script type="text/javascript">
          JOT_setupPostRenderingManager();
        </script>
<script type="text/javascript">
          JOT_postEvent('renderPlus', null, 'sites-chrome-main');
        </script>
<div id="server-timer-div" style="display:none"> </div>
<script type="text/javascript">
          window.jstiming.load.tick('render');
          JOT_postEvent('usercontentrendered', this);
        </script>
</body>
</html>
