<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/WebPage">
<head>
<meta http-equiv="X-UA-Compatible" content="chrome=1" />
<script type="text/javascript">/* Copyright 2008 Google. */ (function() { var e="wtsrt_",g="tbsd_",h="tbnd_",k="start",l="_wtsrt",m="_tbnd",n="CSI/";(function(){function f(a){this.t={};this.tick=function(a,c,b){this.t[a]=[void 0!=b?b:(new Date).getTime(),c];if(void 0==b)try{window.console.timeStamp(n+a)}catch(d){}};this.tick(k,null,a)}var a;window.performance&&(a=window.performance.timing);var p=a?new f(a.responseStart):new f;window.jstiming={Timer:f,load:p};if(a){var c=a.navigationStart,d=a.responseStart;0<c&&d>=c&&(window.jstiming.srt=d-c)}if(a){var b=window.jstiming.load;0<c&&d>=c&&(b.tick(l,void 0,c),b.tick(e,l,d),b.tick(g,e))}try{a=null,
window.chrome&&window.chrome.csi&&(a=Math.floor(window.chrome.csi().pageT),b&&0<c&&(b.tick(m,void 0,window.chrome.csi().startE),b.tick(h,m,c))),null==a&&window.gtbExternal&&(a=window.gtbExternal.pageT()),null==a&&window.external&&(a=window.external.pageT,b&&0<c&&(b.tick(m,void 0,window.external.startE),b.tick(h,m,c))),a&&(window.jstiming.pt=a)}catch(q){}})(); })()
</script>
<link rel="shortcut icon" href="http://www.chromium.org/_/rsrc/1354323194313/favicon.ico" type="image/x-icon" />
<link rel="apple-touch-icon" href="http://www.gstatic.com/sites/p/56e332/system/app/images/apple-touch-icon.png" type="image/png" />
<script type="text/javascript">/* Copyright 2008 Google. */ (function() { var d="",g="__duration__",h="function";function k(c){return document.getElementById(c)}window.byId=k;function l(c){return c.replace(/^\s+|\s+$/g,d)}window.trim=l;var m=[],n=0;window.JOT_addListener=function(c,a,b){var e=new String(n++);c={eventName:c,handler:a,compId:b,key:e};m.push(c);return e};window.JOT_removeListenerByKey=function(c){for(var a=0;a<m.length;a++)if(m[a].key==c){m.splice(a,1);break}};
window.JOT_removeAllListenersForName=function(c){for(var a=0;a<m.length;a++)m[a].eventName==c&&m.splice(a,1)};window.JOT_postEvent=function(c,a,b){var e={eventName:c,eventSrc:a||{},payload:b||{}};if(window.JOT_fullyLoaded)for(a=m.length,b=0;b<a&&b<m.length;b++){var f=m[b];f&&f.eventName==c&&(e.listenerCompId=f.compId||d,(f=typeof f.handler==h?f.handler:window[f.handler])&&f(e))}else window.JOT_delayedEvents.push({eventName:c,eventSrc:a,payload:b})};window.JOT_delayedEvents=[];
window.JOT_fullyLoaded=!1;window.JOT_formatRelativeToNow=function(c,a){var b=((new Date).getTime()-c)/6E4;if(1440<=b||0>b)return null;var e=0;60<=b&&(b/=60,e=2);2<=b&&e++;return a?window.JOT_siteRelTimeStrs[e].replace(g,Math.floor(b)):window.JOT_userRelTimeStrs[e].replace(g,Math.floor(b))}; })()
</script>
<script>

  

  var breadcrumbs = [{"path":"/nativeclient","deleted":false,"title":"Native Client","dir":"ltr"},{"path":"/nativeclient/pnacl","deleted":false,"title":"PNaCl","dir":"ltr"},{"path":"/nativeclient/pnacl/aligned-bundling-support-in-llvm","deleted":false,"title":"Aligned bundling support in LLVM","dir":"ltr"}];
  var JOT_clearDotPath = 'http://www.gstatic.com/sites/p/56e332/system/app/images/cleardot.gif';

  
  var JOT_userRelTimeStrs = ["a minute ago","__duration__ minutes ago","an hour ago","__duration__ hours ago"];

  
  

  

  var webspace = {"enableAnalytics":true,"pageSharingId":"jotspot_page","enableUniversalAnalytics":false,"sharingPolicy":"OPENED_WITH_INDICATOR","siteTitle":"The Chromium Projects","isStartPageEnabled":true,"adsensePublisherId":null,"features":{"languageSelectDefaultTextSetToDefault":true,"validateClientGvizDataSourceUrls":true,"moreMobileStyleImprovements":true,"newInsertMenuIcons":true,"accessibleSortingButtons":true,"domainAnalyticsInGAOnly":true,"noCaptcha":true,"fileCabinetScreenReaderFix":true,"updatedTosAndPrivacyLinks":null,"pageDrafts":false,"mobileOrientationFix":true,"plusBadge":false,"pdfEmbedSupport":false,"jsClickFix":true},"isPublic":true,"isConsumer":false,"serverFlags":{"cajaBaseUrl":"//www.gstatic.com/caja","cajaDebugMode":false},"onepickBaseUrl":"https://docs.google.com","domainAnalyticsAccountId":"","plusPageId":"","signInUrl":"https://www.google.com/a/SelectSession?continue\u003dhttp://sites.google.com/a/chromium.org/dev/nativeclient/pnacl/aligned-bundling-support-in-llvm\u0026service\u003djotspot","analyticsAccountId":"UA-5484340-1","scottyUrl":"/_/upload","homePath":"/","siteNoticeUrlEnabled":null,"plusPageUrl":"","adsensePromoClickedOrSiteIneligible":true,"csiReportUri":"http://csi.gstatic.com/csi","sharingId":"jotspot","termsUrl":"//www.google.com/intl/en/policies/terms/","gvizVersion":1,"editorResources":{"sitelayout":["http://www.gstatic.com/sites/p/56e332/system/app/css/sitelayouteditor.css"],"text":["http://www.gstatic.com/sites/p/56e332/system/js/codemirror.js","http://www.gstatic.com/sites/p/56e332/system/app/css/codemirror_css.css","http://www.gstatic.com/sites/p/56e332/system/js/trog_edit__en.js","http://www.gstatic.com/sites/p/56e332/system/app/css/trogedit.css","/_/rsrc/1441580320000/system/app/css/editor.css","http://www.gstatic.com/sites/p/56e332/system/app/css/codeeditor.css","/_/rsrc/1441580320000/system/app/css/camelot/editor-jfk-wlb.css"]},"sharingUrlPrefix":"/_/sharing","isAdsenseEnabled":true,"domain":"chromium.org","baseUri":"","name":"dev","siteTemplateId":false,"siteNoticeRevision":null,"siteNoticeUrlAddress":null,"siteNoticeMessage":null,"page":{"isRtlLocale":false,"canDeleteWebspace":null,"isPageDraft":null,"parentPath":"/nativeclient/pnacl","parentWuid":"wuid:gx:1c9f2315777aacf6","siteLocale":"en","timeZone":"America/Los_Angeles","type":"text","title":"Aligned bundling support in LLVM","locale":"en","wuid":"wuid:gx:4db3a8f21a2552a","revision":16,"path":"/nativeclient/pnacl/aligned-bundling-support-in-llvm","isSiteRtlLocale":false,"pageInheritsPermissions":null,"name":"aligned-bundling-support-in-llvm","canChangePath":true,"state":"","properties":{},"bidiEnabled":false,"currentTemplate":{"path":"/system/app/pagetemplates/text","title":"Web Page"}},"canPublishScriptToAnyone":true,"user":{"keyboardShortcuts":true,"sessionIndex":"","guest_":true,"displayNameOrEmail":"guest","userName":"guest","uid":"","renderMobile":false,"domain":"","namespace":"","hasWriteAccess":false,"namespaceUser":false,"primaryEmail":"guest","hasAdminAccess":false},"gadgets":{"baseUri":"/system/app/pages/gadgets"}};
  webspace.page.breadcrumbs = breadcrumbs;

  
  var JOT_siteRelTimeStrs = ["a minute ago","__duration__ minutes ago","an hour ago","__duration__ hours ago"];

</script>
<script type="text/javascript">
                window.jstiming.load.tick('scl');
              </script>
<meta name="title" content="Aligned bundling support in LLVM - The Chromium Projects" />
<meta itemprop="name" content="Aligned bundling support in LLVM - The Chromium Projects" />
<meta property="og:title" content="Aligned bundling support in LLVM - The Chromium Projects" />
<meta name="description" content="Home of the Chromium Open Source Project" />
<meta itemprop="description" content="Home of the Chromium Open Source Project" />
<meta id="meta-tag-description" property="og:description" content="Home of the Chromium Open Source Project" />
<style type="text/css">
</style>
<link rel="stylesheet" type="text/css" href="http://www.gstatic.com/sites/p/56e332/system/app/themes/beigeandblue/standard-css-beigeandblue-ltr-ltr.css" />
<link rel="stylesheet" type="text/css" href="http://www.chromium.org/_/rsrc/1441580320000/system/app/css/overlay.css?cb=beigeandblueundefineda100%25%25150goog-ws-leftthemedefaultstandard" />
<link rel="stylesheet" type="text/css" href="http://www.chromium.org/_/rsrc/1441580320000/system/app/css/camelot/allthemes-view.css" />
<!--[if IE]>
          <link rel="stylesheet" type="text/css" href="/system/app/css/camelot/allthemes%2die.css" />
        <![endif]-->
<title>Aligned bundling support in LLVM - The Chromium Projects</title>
<meta itemprop="image" content="http://www.chromium.org/_/rsrc/1355526290127/nativeclient/pnacl/aligned-bundling-support-in-llvm/Fragment%20padding.png.1355408184699.png" />
<meta property="og:image" content="http://www.chromium.org/_/rsrc/1355526290127/nativeclient/pnacl/aligned-bundling-support-in-llvm/Fragment%20padding.png.1355408184699.png" />
<script type="text/javascript">
                window.jstiming.load.tick('cl');
              </script>
</head>
<body xmlns="http://www.google.com/ns/jotspot" id="body" class=" en            ">
<div id="sites-page-toolbar" class="sites-header-divider">
<div xmlns="http://www.w3.org/1999/xhtml" id="sites-status" class="sites-status" style="display:none;"><div id="sites-notice" class="sites-notice" role="status" aria-live="assertive"> </div></div>
</div>
<div id="sites-chrome-everything-scrollbar">
<div id="sites-chrome-everything" class="">
<div id="sites-chrome-page-wrapper" style="direction: ltr">
<div id="sites-chrome-page-wrapper-inside">
<div xmlns="http://www.w3.org/1999/xhtml" id="sites-chrome-header-wrapper" style="height:auto;">
<table id="sites-chrome-header" class="sites-layout-hbox" cellspacing="0" style="height:auto;">
<tr class="sites-header-primary-row" id="sites-chrome-userheader">
<td id="sites-header-title" class="" role="banner"><div class="sites-header-cell-buffer-wrapper"><a href="http://www.chromium.org/" id="sites-chrome-userheader-logo"><img id="logo-img-id" src="http://www.chromium.org/_/rsrc/1438879449147/config/customLogo.gif?revision=3" alt="The Chromium Projects" class="sites-logo  " /></a><h2><a href="http://www.chromium.org/" dir="ltr" id="sites-chrome-userheader-title">The Chromium Projects</a></h2></div></td><td class="sites-layout-searchbox  "><div class="sites-header-cell-buffer-wrapper"><form id="sites-searchbox-form" action="http://www.chromium.org/system/app/pages/search" role="search"><input type="hidden" id="sites-searchbox-scope" name="scope" value="search-site" /><input type="text" id="jot-ui-searchInput" name="q" size="20" value="" aria-label="Search this site" /><div id="sites-searchbox-button-set" class="goog-inline-block"><div role="button" id="sites-searchbox-search-button" class="goog-inline-block jfk-button jfk-button-standard" tabindex="0">Search this site</div></div></form></div></td>
</tr>
<tr class="sites-header-secondary-row" id="sites-chrome-horizontal-nav">
<td colspan="2" id="sites-chrome-header-horizontal-nav-container" role="navigation">
</td>
</tr>
</table>
</div>
<div id="sites-chrome-main-wrapper">
<div id="sites-chrome-main-wrapper-inside">
<table id="sites-chrome-main" class="sites-layout-hbox" cellspacing="0" cellpadding="{scmCellpadding}" border="0">
<tr>
<td id="sites-chrome-sidebar-left" class="sites-layout-sidebar-left initial" style="width:150px">
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_7648876402527094" class="sites-embed" role="navigation"><div class="sites-embed-content sites-sidebar-nav"><ul role="navigation" jotId="navList"><li class="nav-first "><div dir="ltr" style="padding-left: 5px;"><a href="http://www.chromium.org/chromium-projects" jotId="wuid:gx:10ae433dadbbab13" class="sites-navigation-link">Home</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="../../Home.html" jotId="wuid:gx:43582b9d2029d3af" class="sites-navigation-link">Chromium</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="../../chromium-os.html" jotId="wuid:gx:83df2ab1f8880ba" class="sites-navigation-link">Chromium OS</a></div></li></ul></div></div>
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_14720868319272995" class="sites-embed" role="navigation"><h4 class="sites-embed-title">Quick links</h4><div class="sites-embed-content sites-sidebar-nav"><ul role="navigation" jotId="navList"><li class="nav-first "><div dir="ltr" style="padding-left: 5px;"><a href="../../for-testers/bug-reporting-guidelines.html" class="sites-navigation-link">Report bugs</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="../../developers/discussion-groups.html" class="sites-navigation-link">Discuss</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="http://www.chromium.org/system/app/pages/sitemap/hierarchy" jotId="wuid:gx:4b58a9a350ad12f" class="sites-navigation-link">网站地图</a></div></li></ul></div></div>
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_19690813310444355" class="sites-embed" role="navigation"><h4 class="sites-embed-title">Other sites</h4><div class="sites-embed-content sites-sidebar-nav"><ul role="navigation" jotId="navList"><li class="nav-first "><div dir="ltr" style="padding-left: 5px;"><a href="http://blog.chromium.org/" class="sites-navigation-link">Chromium Blog</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="http://code.google.com/chrome/extensions/" class="sites-navigation-link">Google Chrome Extensions</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="https://developers.google.com/chrome/chrome-frame/" class="sites-navigation-link">Google Chrome Frame</a></div></li></ul></div></div>
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_19695218559354544" class="sites-embed" role="complementary"><h4 class="sites-embed-title"></h4><div class="sites-embed-content sites-embed-content-sidebar-textbox"><div dir="ltr"><span style="font-size:x-small">Except as otherwise </span><a href="http://developers.google.com/site-policies.html#restrictions"><span style="font-size:x-small">noted</span></a><span style="font-size:x-small">, the content of this page is licensed under a </span><a href="http://creativecommons.org/licenses/by/2.5/"><span style="font-size:x-small">Creative Commons Attribution 2.5 license</span></a><span style="font-size:x-small">, and examples are licensed under the </span><a href="http://src.chromium.org/viewvc/chrome/trunk/src/LICENSE" target="_blank"><span style="font-size:x-small">BSD License</span></a><span style="font-size:x-small">.<br /></span></div></div></div>
</td>
<td id="sites-canvas-wrapper">
<div id="sites-canvas" role="main">
<div id="goog-ws-editor-toolbar-container"> </div>
<div xmlns="http://www.w3.org/1999/xhtml" id="title-crumbs" style="">
<A href="../../nativeclient.html" dir="ltr">Native Client</A>‎ &gt; ‎<A href="../pnacl.html" dir="ltr">PNaCl</A>‎ &gt; ‎
  </div>
<h3 xmlns="http://www.w3.org/1999/xhtml" id="sites-page-title-header" style="" align="left">
<span id="sites-page-title" dir="ltr" tabindex="-1" style="outline: none">Aligned bundling support in LLVM</span>
</h3>
<div id="sites-canvas-main" class="sites-canvas-main">
<div id="sites-canvas-main-content">
<table xmlns="http://www.w3.org/1999/xhtml" cellspacing="0" class="sites-layout-name-one-column sites-layout-hbox"><tbody><tr><td class="sites-layout-tile sites-tile-name-content-1"><div dir="ltr"><div><span style="font-size:10pt">This document describes the proposal to add aligned instruction bundle support (in short - "bundling") in LLVM and its implementation in the MC module.</span></div><div><span style="font-size:10pt"><br /></span></div><div><span style="font-size:10pt"><div><div class="sites-embed-align-left-wrapping-off"><div class="sites-embed-border-off sites-embed" style="width:250px;"><div class="sites-embed-content sites-embed-type-toc"><div class="goog-toc sites-embed-toc-maxdepth-6"><p>Contents</p><ol class="goog-toc"><li class="goog-toc"><a href="aligned-bundling-support-in-llvm.html#TOC-Specification"><strong>1 </strong>Specification</a></li><li class="goog-toc"><a href="aligned-bundling-support-in-llvm.html#TOC-Implementation-in-LLVM-MC"><strong>2 </strong>Implementation in LLVM MC</a><ol class="goog-toc"><li class="goog-toc"><a href="aligned-bundling-support-in-llvm.html#TOC-Parsing-and-emitting-sections-and-fragments"><strong>2.1 </strong>Parsing and emitting sections and fragments</a></li><li class="goog-toc"><a href="aligned-bundling-support-in-llvm.html#TOC-Laying-out-fragments"><strong>2.2 </strong>Laying out fragments</a></li><li class="goog-toc"><a href="aligned-bundling-support-in-llvm.html#TOC-Writing-fragments-to-the-object-file"><strong>2.3 </strong>Writing fragments to the object file</a></li></ol></li><li class="goog-toc"><a href="aligned-bundling-support-in-llvm.html#TOC-Performance-impacts"><strong>3 </strong>Performance impacts</a><ol class="goog-toc"><li class="goog-toc"><a href="aligned-bundling-support-in-llvm.html#TOC-Memory-consumption-of-fragment-objects"><strong>3.1 </strong>Memory consumption of fragment objects</a></li><li class="goog-toc"><a href="aligned-bundling-support-in-llvm.html#TOC-Assembler-runtime"><strong>3.2 </strong>Assembler runtime</a></li><li class="goog-toc"><a href="aligned-bundling-support-in-llvm.html#TOC-Emitting-instructions"><strong>3.3 </strong>Emitting instructions</a></li></ol></li></ol></div></div></div></div></div><br /></span></div><h2><a name="TOC-Specification"></a>Specification</h2><p>For the purpose of supporting the Software Fault Isolation (SFI) mechanisms required by Native Client, the following directives are added to the LLVM assembler:</p><div class="sites-codeblock sites-codesnippet-block"><p><code>.bundle_align_mode &lt;num&gt;</code></p><p><code>.bundle_lock &lt;option&gt;</code></p><p><code>.bundle_unlock</code></p></div><p>With the following semantics:</p><p>When aligned instruction bundle mode ("bundling" in short) is enabled (<code>.bundle_align_mode</code> was encountered with an argument &gt; 0, which is the power of 2 to which the bundle size is equal), single instructions and groups of instructions between <code>.bundle_lock</code> and <code>.bundle_unlock</code> directives cannot cross a bundle boundary.</p><p>Furthermore, the <code>.bundle_lock</code> directive supports the <code>align_to_end </code>option, which means that the group has to end at a bundle boundary.<br /></p><p>For example, consider the following:</p><div></div><div class="sites-codeblock sites-codesnippet-block"><div><span style="color:rgb(34,34,34)"><font face="times new roman, serif"><code>.bundle_align_mode 4</code></font></span></div><div><span style="color:rgb(34,34,34)"><font face="times new roman, serif"><code>mov1</code></font></span></div><div><span style="color:rgb(34,34,34)"><font face="times new roman, serif"><code>mov2</code></font></span></div><div><span style="color:rgb(34,34,34)"><font face="times new roman, serif"><code>mov3</code></font></span></div></div><br /><div><font face="times new roman, serif"><br style="color:rgb(34,34,34)" /></font></div><div><span style="font-family:arial,sans-serif"><span style="color:rgb(34,34,34)">Assuming that each of the <code>mov</code> instructions is 7 bytes long and <code>mov1</code> is aligned to a 16-byte boundary, two bytes of NOP padding will be inserted between <code>mov2</code> and <code>mov3</code> to make sure that <code>mov3</code> does not cross a 16-byte bundle boundary.</span></span></div><div><span style="font-family:arial,sans-serif"><br style="color:rgb(34,34,34)" /></span></div><div><span style="font-family:arial,sans-serif"><span style="color:rgb(34,34,34)">A slightly modified example:</span></span></div><div><font face="times new roman, serif"><br style="color:rgb(34,34,34)" /></font></div><div></div><div class="sites-codeblock sites-codesnippet-block"><div><span style="color:rgb(34,34,34)"><font face="times new roman, serif"><code>.bundle_align_mode 4</code></font></span></div><div><span style="color:rgb(34,34,34)"><font face="times new roman, serif"><code>mov1</code></font></span></div><div><span style="color:rgb(34,34,34)"><font face="times new roman, serif"><code>.bundle_lock</code></font></span></div><div><span style="color:rgb(34,34,34)"><font face="times new roman, serif"><code>mov2</code></font></span></div><div><span style="color:rgb(34,34,34)"><font face="times new roman, serif"><code>mov3</code></font></span></div><div><span style="color:rgb(34,34,34)"><font face="times new roman, serif"><code>.bundle_unlock</code></font></span></div></div><div><span style="font-family:arial,sans-serif"><br style="color:rgb(34,34,34)" /></span></div><div><span style="font-family:arial,sans-serif"><span style="color:rgb(34,34,34)">Here, since the bundle-locked sequence <code>mov2 mov3</code> cannot cross a bundle boundary, 9 bytes of NOP padding will be inserted between <code>mov1</code> and <code>mov2</code>.<br /><br />An example to demonstrate the <code>align_to_end</code> option:<br /><br /></span></span><div></div><div class="sites-codeblock sites-codesnippet-block"><div><span style="color:rgb(34,34,34)"><font face="times new roman, serif"><code>.bundle_align_mode 4</code></font></span></div><div><span style="color:rgb(34,34,34)"><font face="times new roman, serif"><code>mov1</code><br /><font face="times new roman, serif"><code>mov2</code></font><br /></font></span></div><div><span style="color:rgb(34,34,34)"><font face="times new roman, serif"><code>.bundle_lock a</code><font face="times new roman, serif"><code>lign_to_end</code></font><br /></font></span></div><div><span style="color:rgb(34,34,34)"><font face="times new roman, serif"><code>mov</code><font face="times new roman, serif"><code>3</code></font></font></span></div><div><span style="color:rgb(34,34,34)"><font face="times new roman, serif"><code>mov</code><font face="times new roman, serif"><code>4</code></font></font></span></div><div><span style="color:rgb(34,34,34)"><font face="times new roman, serif"><code>.bundle_unlock</code></font></span></div></div><br />Normally, only two bytes of NOP padding would be required between <code>mov2</code> and <code>mov3</code> to ensure that bundle-locked sequence does not cross a bundle boundary. However, since <code>align_to_end</code> was provided, an additional two bytes of NOP padding will be inserted so that the sequence ends at a boundary.<br /><br /></div><div><span style="font-family:arial,sans-serif"><br style="color:rgb(34,34,34)" /></span></div><div><span style="font-family:arial,sans-serif"><span style="color:rgb(34,34,34)">For information on how this ability is used for software fault isolation by Native Client, see the following resources:</span></span></div><ul><li><span style="font-family:arial,sans-serif"><a href="http://src.chromium.org/viewvc/native_client/data/site/NaCl_SFI.pdf" style="color:rgb(17,85,204)" target="_blank">http://src.chromium.org/viewvc/native_client/data/site/NaCl_SFI.pdf</a><span style="color:rgb(34,34,34)"> [PDF link]</span></span></li><li><span style="font-family:arial,sans-serif"><a href="../reference/arm-overview.html#TOC-The-Native-Client-Solution:-Bundles-" style="color:rgb(17,85,204)" target="_blank">http://www.chromium.org/nativeclient/reference/arm-overview#TOC-The-Native-Client-Solution:-Bundles-</a></span></li><li><span style="font-family:arial,sans-serif"><span style="color:rgb(34,34,34)">Other papers listed at</span><font style="color:rgb(17,85,204)"><a href="../reference/research-papers.html" style="color:rgb(17,85,204)" target="_blank"> http://www.chromium.org/nativeclient/reference/research-papers</a></font></span></li></ul><h2><a name="TOC-Implementation-in-LLVM-MC"></a>Implementation in LLVM MC</h2><div><br /></div><div>As proposed, bundling is a feature of the assembler. Therefore, it is implemented in the MC module of LLVM. Specifically, the following parts are affected:</div><div><ul><li>The assembler parser is modified to parse the new directives and emit appropriate commands to streamers.</li><li>The assembly streamer (used for printing out disassembly) is modified to emit textual directives back from streamer commands.</li><li>The object streamers are modified to act upon the bundling commands to affect the assembly process.</li><ul><li>Note: at this point support has only been added to the ELF object streamer. This is done to answer the immediate needs of NaCl and to reduce the complexity of the initial patch. At a later point, bundling support can also be added to the MachO and COFF streamers, if someone is interested.</li></ul><li>The main assembler logic is modified to support bundling.</li></ul></div><div>The following description will focus on the path: <i>Text assembly -&gt; ELF object streamer -&gt; Assembly -&gt; Object file emission</i>. This path can be roughly divided to three stages:</div><div><ol><li><span style="font-size:10pt">Parse bundling directives and emit a sequence of sections (<code>MCSectionData</code>) and fragments (<code>MCFragment</code> derivatives) that represent the input. </span></li><li><span style="font-size:10pt">Perform layout of the fragments to be valid w.r.t. relaxation and bundling.</span></li><li><span style="font-size:10pt">Write the output object.</span></li></ol><h3><a name="TOC-Parsing-and-emitting-sections-and-fragments"></a>Parsing and emitting sections and fragments</h3></div><div>In order to implement bundling, we use the existing assembly parsing facilities in MC, adding support for the new directives. The existing section and fragment abstractions are used, with some flags added to keep the state of the bundling directives encountered. Specifically:</div><div><ul><li>A <code>BundleAlignSize</code> field is added to <code>MCAssembler</code>. When the<code> .bundle_align_mode</code> directive is parsed, this field is populated with the bundle alignment size (2 to the power of the argument of <code>.bundle_align_mode</code>). Setting this field is currently allowed once per assembly file. Subsequent <code>.bundle_align_mode</code> directives will be rejected as errors.</li><li>The following state fields are added to MCSectionData and managed by the code parsing <code>.bundle_lock</code> and <code>.bundle_unlock</code>:</li><ul><li><code>BundleLockState</code>: keeps track of whether the currently parsed code is in a bundle-locked group (between<code> .bundle_lock</code> and<code> .bundle_unlock</code> directives) and whether the group has to be aligned to bundle end.<br /></li><li><code>BundleGroupBeforeFirstInst</code>: keeps track of whether the next instruction parsed will be the first in a bundle-locked group.</li><ul><li>Turned on when <code>.bundle_lock</code> is encountered</li><li>Turned off when an instruction is emitted in the streamer</li></ul></ul></ul></div><div>When bundling mode is turned on in the assembler (<code>BundleAlignSize</code> &gt; 0), the following rules apply to emitting fragments:</div><div><ul><li>All instructions are emitted into separate fragments (either data or instruction fragments, depending on whether they are candidates for relaxation). This is essential because each instruction may potentially need to be padded to obey bundling rules when layout is performed (details below). Bundling does not apply to non-instructions like data, alignment directives, etc.</li><li>Instructions in bundle-locked groups get emitted into the same data fragment, since they are all part of the same group which has to be moved and padded together.</li><ul><li>To make this possible, all potentially relaxable instructions inside bundle-locked groups are relaxed before emission, so that they won't need relaxation in the future.</li><li>While in theory the above means the code can become larger than necessary, in practice instructions actually requiring relaxation won't usually appear in bundle-locked groups, so the practical cost is very low. The gain is a significant simplification of the implementation.</li></ul></ul><h3><a name="TOC-Laying-out-fragments"></a>Laying out fragments</h3></div><div>Bundling blends well into the existing layout mechanism in the MC assembler, since its effects are somewhat similar to relaxation. Some fragments may need to grow due to padding, which may require re-layout of subsequent fragments and recomputation of fixups. Therefore, the MC assembler employs an iterative layout algorithm. The following diagram will help explain the layout of fragments w.r.t. bundling:</div><div><br /></div><div><div style="display:block;text-align:center;margin-right:auto;margin-left:auto"><a href="aligned-bundling-support-in-llvm/Fragment&#32;padding.png.1355408184699.png%3Fattredirects=0" imageanchor="1"><img border="0" src="../../_/rsrc/1355526290127/nativeclient/pnacl/aligned-bundling-support-in-llvm/Fragment&#32;padding.png.1355408184699.png" /></a></div><br /></div><div><br /></div><div><div style="text-align:center;margin-right:auto;margin-left:auto"></div><ul><li>When layout on a fragment is performed, the fragment's offset and size are computed.</li><li>The following steps apply only if:</li><ul><li>Bundling is enabled</li><li>The fragment contains instructions (we don't pad data and alignment fragments)</li><ul><li>For this purpose, a boolean predicate <code>hasInstructions</code> is added to <code>MCFragment</code></li></ul></ul><li>If it's determined that the fragment will cross a bundle boundary, padding is required.</li><ul><li>The required amount of padding is computed and stored in the <code>BundlePudding</code> field of the fragment.<br />This field is restricted to <code>uint8_t</code>, in order to save space in the mainstream case (bundling disabled). In practice, fragments of larger size will not be encountered (bundling is done at most on small groups of a few instructions).</li><li>The fragment offset is set to point after the padding, at the start of the actual fragment. This way the following invariant still holds:<br /><span style="font-size:10pt"><code>fragment offset + fragment size </code></span><span style="font-size:10pt"><code>= offset of next fragment</code> <br /></span></li></ul><li><span style="font-size:10pt">Padding is also required if the <code>align_to_end</code> option is provided to a bundle-locked group.</span></li></ul><div>Note
 that since we create a single data fragment for a bundle-locked group, 
the above applies to such groups as well as single instructions.</div><div><br /></div></div><h3><a name="TOC-Writing-fragments-to-the-object-file"></a>Writing fragments to the object file</h3><div><i>Note: the write target of the assembler is abstracted into a stream object, which can also write into memory. "Object file" here implies this stream.</i></div><div><br /></div><div>In the last step, the assembler writes the list of fragments into sections according to their layout order. In this step, the <code>BundlePadding</code> field created during layout is used to add NOP padding (by calling <code>writeNopData</code> on the target-specific assembler backend) of appropriate size before fragments that require it.</div><div><br /></div><h2><a name="TOC-Performance-impacts"></a>Performance impacts</h2><div>It's interesting to study the performance impact of adding the bundling feature on MC's assembler normal operation (without actual bundling directives).</div><div><br /></div><h3><a name="TOC-Memory-consumption-of-fragment-objects"></a>Memory consumption of fragment objects</h3><div><br /></div><div>Amount of bytes needed for the various MCFragment objects on x86-64:</div><div><br /></div><div><table border="1" bordercolor="#888" cellspacing="0" style="border-collapse:collapse;border-color:rgb(136,136,136);border-width:1px"><tbody><tr><td style="width:162px;height:30px"> <b>Fragment type</b></td><td style="width:124px;height:30px"><b> Without bundling</b></td><td style="width:94px;height:30px"><b> With bundling</b></td></tr><tr><td style="width:162px;height:16px"><code>MCFragment</code></td><td style="width:124px;height:16px"><code> 64</code></td><td style="width:94px;height:16px"><code> 64</code></td></tr><tr><td style="width:162px;height:15px"><code>MCRelaxableFragment</code></td><td style="width:124px;height:15px"><code> 320</code></td><td style="width:94px;height:15px"><code> 320</code></td></tr><tr><td style="width:162px;height:15px"><code>MCDataFragment</code></td><td style="width:124px;height:15px"><code> 240</code></td><td style="width:94px;height:15px"><code> 240</code></td></tr></tbody></table><br /></div><div>Explanation: the single-byte<code> BundlePadding</code> field in <code>MCEncodedFragment</code> was placed in space reserved for alignment earlier. The same was done for the boolean <code>HasInstructions</code> in <code>MCDataFragment</code>.</div><h3><a name="TOC-Assembler-runtime"></a>Assembler runtime</h3><div><br /></div><div><code>llvm-mc</code> was run on a large assembly file (produced by compiling gcc 3.5 into a single assembly file) as follows:</div><div><br /></div><div><div class="sites-codeblock sites-codesnippet-block"><code>sudo nice -n -20 perf stat -r 10 llvm-mc -filetype=obj gcc.s -o gcc.o</code></div></div><div><br /></div><div>There were no noticeable difference in the runtime of <code>llvm-mc</code> with and without the bundling patch.</div><div><br /></div><div><b><font size="4">Alternative implementation</font></b></div><div><br /></div><div>Bundling is similar to relaxation in many aspects which simplifies the implementation. While the performance impact of bundling is negligible as shown, the interaction of these two mechanisms can have a negative effect on memory consumption. When bundling is used, most instructions need to be put in their own fragment. That's because before we have decided the sizes of jumps, we don’t know the relative positions of other instructions, as we might need to insert bundle padding NOPs between them. The only exception are bundle-locked superinstruction sequences which can be stored in a single fragment.</div><div><br /></div><div>Since there's a memory overhead for storing a fragment, the use of bundling with relaxation significantly increases memory overhead. When translating pexe, pnacl-llc uses <i>K * nexe size</i> memory. <span style="background-color:transparent">The experimental results show that the value of K is ~17 with the fixed cost of ~50MB. Given that, with the maximum <i>pexe</i> size limited currently to 64MB, </span><span style="color:rgb(0,96,0);font-family:monospace;font-size:13.3333330154419px">pnacl-llc</span><span style="background-color:transparent"> would need over 1.1GB of address space which is significantly more than 768MB that will be available when </span><span style="color:rgb(0,96,0);font-family:monospace;font-size:13.3333330154419px;background-color:transparent">pnacl-llc</span><span style="font-size:10pt;background-color:transparent"> starts using IRT.</span></div><div><span style="background-color:transparent"><br /></span></div><div><span style="background-color:transparent">Therefore, one way to reduce the memory consumption is to disable jump relaxation. In that case, we know that size of all instructions from the beginning and we can write the bundle padding NOPs directly into the fragments while emitting the instructions, thus reducing the number of fragments needed.</span></div><div><h3><a name="TOC-Emitting-instructions"></a>Emitting instructions</h3></div><div>We have implemented the alternative bundle padding scheme in LLVM MC. Currently, this implementation is only being used when the <span style="color:rgb(0,96,0);font-family:monospace;font-size:13.3333330154419px;background-color:transparent">-mc-relax-all</span><span style="font-size:10pt;background-color:transparent"> flag is used. The large bulk of implementation is in the </span><span style="color:rgb(0,96,0);font-family:monospace;font-size:13.3333330154419px;background-color:transparent">MCELFStreamer::mergeFragment</span><span style="font-size:10pt;background-color:transparent"> method. We reuse the existing code and emit instructions into their own fragment. We also reuse the existing logic </span><span style="font-size:13.3333330154419px;background-color:transparent">for calculating bundle boundaries and necessary bundle padding</span><span style="font-size:10pt;background-color:transparent">. However, when the jump relaxation is disabled, instead of adding each fragment into the list of fragments held by </span><span style="font-size:13.3333330154419px;color:rgb(0,96,0);font-family:monospace;background-color:transparent">MCSectionData</span><span style="font-size:10pt;background-color:transparent">, we merge it with the current fragment.</span></div></div></td></tr></tbody></table>
</div> 
</div> 
<div id="sites-canvas-bottom-panel">
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_page-subpages"> </div>
<div id="sites-attachments-container">
</div>
<a xmlns="http://www.w3.org/1999/xhtml" name="page-comments"></a>
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_page-comments"><div class="sites-comment-docos-wrapper"><div class="sites-comment-docos"><div class="sites-comment-docos-background"></div><div class="sites-comment-docos-header"><div class="sites-comment-docos-header-title">Comments</div></div><div id="sites-comment-docos-pane" class="sites-comment-docos-pane"></div></div></div></div>
</div>
</div> 
</td> 
</tr>
</table> 
</div> 
</div> 
<div id="sites-chrome-footer-wrapper">
<div id="sites-chrome-footer-wrapper-inside">
<div id="sites-chrome-footer">
</div>
</div>
</div>
</div> 
</div> 
<div id="sites-chrome-adminfooter-container">
<div xmlns="http://www.w3.org/1999/xhtml" class="sites-adminfooter" role="navigation"><p><a class="sites-system-link" href="https://www.google.com/a/UniversalLogin?service=jotspot&amp;continue=http://sites.google.com/a/chromium.org/dev/nativeclient/pnacl/aligned-bundling-support-in-llvm">Sign in</a><span aria-hidden="true">|</span><a class="sites-system-link" href="http://www.chromium.org/system/app/pages/recentChanges">Recent Site Activity</a><span aria-hidden="true">|</span><a class="sites-system-link" href="http://www.chromium.org/system/app/pages/reportAbuse" target="_blank">Report Abuse</a><span aria-hidden="true">|</span><a class="sites-system-link" href="javascript:;" onclick="window.open(webspace.printUrl)">Print Page</a><span aria-hidden="true">|</span><span class="sites-system-link">Powered By</span> <b class="powered-by"><a href="http://sites.google.com">Google Sites</a></b></p></div>
</div>
</div> 
</div> 
<div id="sites-chrome-onebar-footer">
</div>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
    window.jstiming.load.tick('sjl');
  </script>
<script xmlns="http://www.w3.org/1999/xhtml" src="http://www.gstatic.com/sites/p/56e332/system/js/jot_min_view__en.js"></script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
    window.jstiming.load.tick('jl');
  </script>
<script xmlns="http://www.w3.org/1999/xhtml">
      
          sites.core.Analytics.createTracker();
          sites.core.Analytics.trackPageview();
        
    </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
                    sites.Searchbox.initialize(
                        'sites-searchbox-search-button',
                        {"object":[]}['object'],
                        'search-site',
                        {"label":"Configure search options...","url":"/system/app/pages/admin/settings"});
                  </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
      gsites.HoverPopupMenu.createSiteDropdownMenus('sites-header-nav-dropdown', false);
    </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript" defer="true">
            JOT_setupNav("7648876402527094", "Navigation", false);
            JOT_addListener('titleChange', 'JOT_NAVIGATION_titleChange', 'COMP_7648876402527094');
          </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript" defer="true">
            JOT_setupNav("14720868319272995", "Quick links", false);
            JOT_addListener('titleChange', 'JOT_NAVIGATION_titleChange', 'COMP_14720868319272995');
          </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript" defer="true">
            JOT_setupNav("19690813310444355", "Other sites", false);
            JOT_addListener('titleChange', 'JOT_NAVIGATION_titleChange', 'COMP_19690813310444355');
          </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
              new sites.CommentPane('//docs.google.com/comments/d/AAHRpnXukca4jaDOG9SuQz_G8t7HlMngMGCUuS5UbXvYhDqUVEqZXUhU4QLJY5Ac2ATTXw01yLq3XpN-OYbEs1wvHLfzewo6xWi9k7WMwgPJJZgpLU-5vSA6wK18w5wnV6Y03S24sLl9_/api/js?anon=true',
                  false, false);
            </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
  setTimeout(function() {
    var fingerprint = gsites.date.TimeZone.getFingerprint([]);
    gsites.Xhr.send('http://www.chromium.org/_/tz', null, null, 'GET', null, null, { afjstz: fingerprint });
  }, 500);
</script>
<script xmlns="http://www.w3.org/1999/xhtml">
                    window.onload = function() {
                      if (false) {
                        JOT_setMobilePreview();
                      }
                      var loadTimer = window.jstiming.load;
                      loadTimer.tick("ol");
                      loadTimer["name"] = "load," + webspace.page.type + ",user_page";
                      window.jstiming.report(loadTimer, {}, 'http://csi.gstatic.com/csi');
                    }
                  </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
        JOT_insertAnalyticsCode(false,
            false);
      </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
    var maestroRunner = new gsites.pages.view.SitesMaestroRunner(
        webspace, "en");
    maestroRunner.initListeners();
    maestroRunner.installEditRender();
  </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript" defer="true">
  //<![CDATA[
    // Decorate any fastUI buttons on the page with a class of 'goog-button'.
    if (webspace.user.hasWriteAccess) {
      JOT_decorateButtons();
    }

    // Fires delayed events.
    (function() {
      JOT_fullyLoaded = true;
      var delayedEvents = JOT_delayedEvents;
      for (var x = 0; x < delayedEvents.length; x++) {
        var event = delayedEvents[x];
        JOT_postEvent(event.eventName, event.eventSrc, event.payload);
      }
      JOT_delayedEvents = null;
      JOT_postEvent('pageLoaded');
    })();
  //]]>
</script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
    JOT_postEvent('decorateGvizCharts');
  </script>
<script type="text/javascript">
          JOT_setupPostRenderingManager();
        </script>
<script type="text/javascript">
          JOT_postEvent('renderPlus', null, 'sites-chrome-main');
        </script>
<div id="server-timer-div" style="display:none"> </div>
<script type="text/javascript">
          window.jstiming.load.tick('render');
          JOT_postEvent('usercontentrendered', this);
        </script>
</body>
</html>
