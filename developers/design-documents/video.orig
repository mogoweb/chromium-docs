<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/WebPage">
<head>
<meta http-equiv="X-UA-Compatible" content="chrome=1" />
<script type="text/javascript">/* Copyright 2008 Google. */ (function() { var e="wtsrt_",g="tbsd_",h="tbnd_",k="start",l="_wtsrt",m="_tbnd",n="CSI/";(function(){function f(a){this.t={};this.tick=function(a,c,b){this.t[a]=[void 0!=b?b:(new Date).getTime(),c];if(void 0==b)try{window.console.timeStamp(n+a)}catch(d){}};this.tick(k,null,a)}var a;window.performance&&(a=window.performance.timing);var p=a?new f(a.responseStart):new f;window.jstiming={Timer:f,load:p};if(a){var c=a.navigationStart,d=a.responseStart;0<c&&d>=c&&(window.jstiming.srt=d-c)}if(a){var b=window.jstiming.load;0<c&&d>=c&&(b.tick(l,void 0,c),b.tick(e,l,d),b.tick(g,e))}try{a=null,
window.chrome&&window.chrome.csi&&(a=Math.floor(window.chrome.csi().pageT),b&&0<c&&(b.tick(m,void 0,window.chrome.csi().startE),b.tick(h,m,c))),null==a&&window.gtbExternal&&(a=window.gtbExternal.pageT()),null==a&&window.external&&(a=window.external.pageT,b&&0<c&&(b.tick(m,void 0,window.external.startE),b.tick(h,m,c))),a&&(window.jstiming.pt=a)}catch(q){}})(); })()
</script>
<link rel="shortcut icon" href="/_/rsrc/1354323194313/favicon.ico" type="image/x-icon" />
<link rel="apple-touch-icon" href="http://www.gstatic.com/sites/p/56e332/system/app/images/apple-touch-icon.png" type="image/png" />
<script type="text/javascript">/* Copyright 2008 Google. */ (function() { var d="",g="__duration__",h="function";function k(c){return document.getElementById(c)}window.byId=k;function l(c){return c.replace(/^\s+|\s+$/g,d)}window.trim=l;var m=[],n=0;window.JOT_addListener=function(c,a,b){var e=new String(n++);c={eventName:c,handler:a,compId:b,key:e};m.push(c);return e};window.JOT_removeListenerByKey=function(c){for(var a=0;a<m.length;a++)if(m[a].key==c){m.splice(a,1);break}};
window.JOT_removeAllListenersForName=function(c){for(var a=0;a<m.length;a++)m[a].eventName==c&&m.splice(a,1)};window.JOT_postEvent=function(c,a,b){var e={eventName:c,eventSrc:a||{},payload:b||{}};if(window.JOT_fullyLoaded)for(a=m.length,b=0;b<a&&b<m.length;b++){var f=m[b];f&&f.eventName==c&&(e.listenerCompId=f.compId||d,(f=typeof f.handler==h?f.handler:window[f.handler])&&f(e))}else window.JOT_delayedEvents.push({eventName:c,eventSrc:a,payload:b})};window.JOT_delayedEvents=[];
window.JOT_fullyLoaded=!1;window.JOT_formatRelativeToNow=function(c,a){var b=((new Date).getTime()-c)/6E4;if(1440<=b||0>b)return null;var e=0;60<=b&&(b/=60,e=2);2<=b&&e++;return a?window.JOT_siteRelTimeStrs[e].replace(g,Math.floor(b)):window.JOT_userRelTimeStrs[e].replace(g,Math.floor(b))}; })()
</script>
<script>

  

  var breadcrumbs = [{"path":"/developers","deleted":false,"title":"For Developers","dir":"ltr"},{"path":"/developers/design-documents","deleted":false,"title":"Design Documents","dir":"ltr"},{"path":"/developers/design-documents/video","deleted":false,"title":"Video","dir":"ltr"}];
  var JOT_clearDotPath = 'http://www.gstatic.com/sites/p/56e332/system/app/images/cleardot.gif';

  
  var JOT_userRelTimeStrs = ["a minute ago","__duration__ minutes ago","an hour ago","__duration__ hours ago"];

  
  

  

  var webspace = {"enableAnalytics":true,"pageSharingId":"jotspot_page","enableUniversalAnalytics":false,"sharingPolicy":"OPENED_WITH_INDICATOR","siteTitle":"The Chromium Projects","isStartPageEnabled":true,"adsensePublisherId":null,"features":{"languageSelectDefaultTextSetToDefault":true,"validateClientGvizDataSourceUrls":true,"moreMobileStyleImprovements":true,"newInsertMenuIcons":true,"accessibleSortingButtons":true,"domainAnalyticsInGAOnly":true,"noCaptcha":true,"fileCabinetScreenReaderFix":true,"updatedTosAndPrivacyLinks":null,"pageDrafts":false,"mobileOrientationFix":true,"plusBadge":false,"pdfEmbedSupport":false,"jsClickFix":true},"isPublic":true,"isConsumer":false,"serverFlags":{"cajaBaseUrl":"//www.gstatic.com/caja","cajaDebugMode":false},"onepickBaseUrl":"https://docs.google.com","domainAnalyticsAccountId":"","plusPageId":"","signInUrl":"https://www.google.com/a/SelectSession?continue\u003dhttp://sites.google.com/a/chromium.org/dev/developers/design-documents/video\u0026service\u003djotspot","analyticsAccountId":"UA-5484340-1","scottyUrl":"/_/upload","homePath":"/","siteNoticeUrlEnabled":null,"plusPageUrl":"","adsensePromoClickedOrSiteIneligible":true,"csiReportUri":"http://csi.gstatic.com/csi","sharingId":"jotspot","termsUrl":"//www.google.com/intl/en/policies/terms/","gvizVersion":1,"editorResources":{"sitelayout":["http://www.gstatic.com/sites/p/56e332/system/app/css/sitelayouteditor.css"],"text":["http://www.gstatic.com/sites/p/56e332/system/js/codemirror.js","http://www.gstatic.com/sites/p/56e332/system/app/css/codemirror_css.css","http://www.gstatic.com/sites/p/56e332/system/js/trog_edit__en.js","http://www.gstatic.com/sites/p/56e332/system/app/css/trogedit.css","/_/rsrc/1441580320000/system/app/css/editor.css","http://www.gstatic.com/sites/p/56e332/system/app/css/codeeditor.css","/_/rsrc/1441580320000/system/app/css/camelot/editor-jfk-wlb.css"]},"sharingUrlPrefix":"/_/sharing","isAdsenseEnabled":true,"domain":"chromium.org","baseUri":"","name":"dev","siteTemplateId":false,"siteNoticeRevision":null,"siteNoticeUrlAddress":null,"siteNoticeMessage":null,"page":{"isRtlLocale":false,"canDeleteWebspace":null,"isPageDraft":null,"parentPath":"/developers/design-documents","parentWuid":"wuid:gx:359ef223e0fb14ac","siteLocale":"en","timeZone":"America/Los_Angeles","type":"text","title":"Video","locale":"en","wuid":"wuid:gx:38cb9e4bae7cd898","revision":23,"path":"/developers/design-documents/video","isSiteRtlLocale":false,"pageInheritsPermissions":null,"name":"video","canChangePath":true,"state":"","properties":{},"bidiEnabled":false,"currentTemplate":{"path":"/system/app/pagetemplates/text","title":"Web Page"}},"canPublishScriptToAnyone":true,"user":{"keyboardShortcuts":true,"sessionIndex":"","guest_":true,"displayNameOrEmail":"guest","userName":"guest","uid":"","renderMobile":false,"domain":"","namespace":"","hasWriteAccess":false,"namespaceUser":false,"primaryEmail":"guest","hasAdminAccess":false},"gadgets":{"baseUri":"/system/app/pages/gadgets"}};
  webspace.page.breadcrumbs = breadcrumbs;

  
  var JOT_siteRelTimeStrs = ["a minute ago","__duration__ minutes ago","an hour ago","__duration__ hours ago"];

</script>
<script type="text/javascript">
                window.jstiming.load.tick('scl');
              </script>
<meta name="title" content="Video - The Chromium Projects" />
<meta itemprop="name" content="Video - The Chromium Projects" />
<meta property="og:title" content="Video - The Chromium Projects" />
<meta name="description" content="Home of the Chromium Open Source Project" />
<meta itemprop="description" content="Home of the Chromium Open Source Project" />
<meta id="meta-tag-description" property="og:description" content="Home of the Chromium Open Source Project" />
<style type="text/css">
</style>
<link rel="stylesheet" type="text/css" href="http://www.gstatic.com/sites/p/56e332/system/app/themes/beigeandblue/standard-css-beigeandblue-ltr-ltr.css" />
<link rel="stylesheet" type="text/css" href="/_/rsrc/1441580320000/system/app/css/overlay.css?cb=beigeandblueundefineda100%25%25150goog-ws-leftthemedefaultstandard" />
<link rel="stylesheet" type="text/css" href="/_/rsrc/1441580320000/system/app/css/camelot/allthemes-view.css" />
<!--[if IE]>
          <link rel="stylesheet" type="text/css" href="/system/app/css/camelot/allthemes%2die.css" />
        <![endif]-->
<title>Video - The Chromium Projects</title>
<meta itemprop="image" content="http://www.chromium.org/_/rsrc/1259798424559/developers/design-documents/video/video_stack_arch.png" />
<meta property="og:image" content="http://www.chromium.org/_/rsrc/1259798424559/developers/design-documents/video/video_stack_arch.png" />
<script type="text/javascript">
                window.jstiming.load.tick('cl');
              </script>
</head>
<body xmlns="http://www.google.com/ns/jotspot" id="body" class=" en            ">
<div id="sites-page-toolbar" class="sites-header-divider">
<div xmlns="http://www.w3.org/1999/xhtml" id="sites-status" class="sites-status" style="display:none;"><div id="sites-notice" class="sites-notice" role="status" aria-live="assertive"> </div></div>
</div>
<div id="sites-chrome-everything-scrollbar">
<div id="sites-chrome-everything" class="">
<div id="sites-chrome-page-wrapper" style="direction: ltr">
<div id="sites-chrome-page-wrapper-inside">
<div xmlns="http://www.w3.org/1999/xhtml" id="sites-chrome-header-wrapper" style="height:auto;">
<table id="sites-chrome-header" class="sites-layout-hbox" cellspacing="0" style="height:auto;">
<tr class="sites-header-primary-row" id="sites-chrome-userheader">
<td id="sites-header-title" class="" role="banner"><div class="sites-header-cell-buffer-wrapper"><a href="http://www.chromium.org/" id="sites-chrome-userheader-logo"><img id="logo-img-id" src="/_/rsrc/1438879449147/config/customLogo.gif?revision=3" alt="The Chromium Projects" class="sites-logo  " /></a><h2><a href="http://www.chromium.org/" dir="ltr" id="sites-chrome-userheader-title">The Chromium Projects</a></h2></div></td><td class="sites-layout-searchbox  "><div class="sites-header-cell-buffer-wrapper"><form id="sites-searchbox-form" action="/system/app/pages/search" role="search"><input type="hidden" id="sites-searchbox-scope" name="scope" value="search-site" /><input type="text" id="jot-ui-searchInput" name="q" size="20" value="" aria-label="Search this site" /><div id="sites-searchbox-button-set" class="goog-inline-block"><div role="button" id="sites-searchbox-search-button" class="goog-inline-block jfk-button jfk-button-standard" tabindex="0">Search this site</div></div></form></div></td>
</tr>
<tr class="sites-header-secondary-row" id="sites-chrome-horizontal-nav">
<td colspan="2" id="sites-chrome-header-horizontal-nav-container" role="navigation">
</td>
</tr>
</table>
</div>
<div id="sites-chrome-main-wrapper">
<div id="sites-chrome-main-wrapper-inside">
<table id="sites-chrome-main" class="sites-layout-hbox" cellspacing="0" cellpadding="{scmCellpadding}" border="0">
<tr>
<td id="sites-chrome-sidebar-left" class="sites-layout-sidebar-left initial" style="width:150px">
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_7648876402527094" class="sites-embed" role="navigation"><div class="sites-embed-content sites-sidebar-nav"><ul role="navigation" jotId="navList"><li class="nav-first "><div dir="ltr" style="padding-left: 5px;"><a href="/chromium-projects" jotId="wuid:gx:10ae433dadbbab13" class="sites-navigation-link">Home</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="/Home" jotId="wuid:gx:43582b9d2029d3af" class="sites-navigation-link">Chromium</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="/chromium-os" jotId="wuid:gx:83df2ab1f8880ba" class="sites-navigation-link">Chromium OS</a></div></li></ul></div></div>
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_14720868319272995" class="sites-embed" role="navigation"><h4 class="sites-embed-title">Quick links</h4><div class="sites-embed-content sites-sidebar-nav"><ul role="navigation" jotId="navList"><li class="nav-first "><div dir="ltr" style="padding-left: 5px;"><a href="http://www.chromium.org/for-testers/bug-reporting-guidelines" class="sites-navigation-link">Report bugs</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="http://www.chromium.org/developers/discussion-groups" class="sites-navigation-link">Discuss</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="/system/app/pages/sitemap/hierarchy" jotId="wuid:gx:fe204a485666144" class="sites-navigation-link">Sitemap</a></div></li></ul></div></div>
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_19690813310444355" class="sites-embed" role="navigation"><h4 class="sites-embed-title">Other sites</h4><div class="sites-embed-content sites-sidebar-nav"><ul role="navigation" jotId="navList"><li class="nav-first "><div dir="ltr" style="padding-left: 5px;"><a href="http://blog.chromium.org/" class="sites-navigation-link">Chromium Blog</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="http://code.google.com/chrome/extensions/" class="sites-navigation-link">Google Chrome Extensions</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="https://developers.google.com/chrome/chrome-frame/" class="sites-navigation-link">Google Chrome Frame</a></div></li></ul></div></div>
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_19695218559354544" class="sites-embed" role="complementary"><h4 class="sites-embed-title"></h4><div class="sites-embed-content sites-embed-content-sidebar-textbox"><div dir="ltr"><span style="font-size:x-small">Except as otherwise </span><a href="http://developers.google.com/site-policies.html#restrictions"><span style="font-size:x-small">noted</span></a><span style="font-size:x-small">, the content of this page is licensed under a </span><a href="http://creativecommons.org/licenses/by/2.5/"><span style="font-size:x-small">Creative Commons Attribution 2.5 license</span></a><span style="font-size:x-small">, and examples are licensed under the </span><a href="http://src.chromium.org/viewvc/chrome/trunk/src/LICENSE" target="_blank"><span style="font-size:x-small">BSD License</span></a><span style="font-size:x-small">.<br /></span></div></div></div>
</td>
<td id="sites-canvas-wrapper">
<div id="sites-canvas" role="main">
<div id="goog-ws-editor-toolbar-container"> </div>
<div xmlns="http://www.w3.org/1999/xhtml" id="title-crumbs" style="">
<A href="/developers" dir="ltr">For Developers</A>‎ &gt; ‎<A href="/developers/design-documents" dir="ltr">Design Documents</A>‎ &gt; ‎
  </div>
<h3 xmlns="http://www.w3.org/1999/xhtml" id="sites-page-title-header" style="" align="left">
<span id="sites-page-title" dir="ltr" tabindex="-1" style="outline: none">Video</span>
</h3>
<div id="sites-canvas-main" class="sites-canvas-main">
<div id="sites-canvas-main-content">
<table xmlns="http://www.w3.org/1999/xhtml" cellspacing="0" class="sites-layout-name-one-column sites-layout-hbox"><tbody><tr><td class="sites-layout-tile sites-tile-name-content-1"><div dir="ltr"><h2 style="text-align:center"><a name="TOC-Interested-in-helping-out-Check-out-our-bugs-New-to-Chromium-GoodFirstBug-is-your-friend-"></a><span style="background-color:rgb(255,255,0)">Interested in helping out?  Check out our </span><a href="http://code.google.com/p/chromium/issues/list?q=Feature:Media" target="_blank"><span style="background-color:rgb(255,255,0)">bugs</span></a><span style="background-color:rgb(255,255,0)">!  New to Chromium?  </span><span style="background-color:rgb(255,255,0)"><a href="http://code.google.com/p/chromium/issues/list?q=Feature:Media+Hotlist:GoodFirstBug">GoodFirstBug</a></span><span style="background-color:rgb(255,255,0)"> is your friend!</span></h2><div>Filing a new bug: <a href="http://code.google.com/p/chromium/issues/entry?template=Audio/Video%20Issue" target="_blank">Template</a> </div><div><br />Preamble</div>
<div>Last updated December 2009.</div>
<div><br />
</div>
<div>Current contributors:</div>
<div>  - ajwong@chromium.org</div>
<div>  - fbarchard@chromium.org</div>
<div>  - hclam@chromium.org</div>
<div>  - scherkus@chromium.org (author)</div>
<div><br />
</div>
<div>Previous contributors:</div>
<div>  - kylep@chromium.org</div>
<div>  - millam@chromium.org</div>
<div>  - ralphl@chromium.org</div>
<div><br />
</div>
<div>With special thanks to... (ping me if you wish to be added/removed)</div>
<div>  - Alexander Strange (ffmpeg-mt maintainer)</div>
<div>  - Alex Converse (FFmpeg help and patch upstreaming)</div>
<div>  - Dominic Jodoin (HelpWanted bug fixing)</div>
<div>  - Eric Carlson (WebKit video expert)</div>
<div>  - Countless Chromium and Google engineers!</div>
<div><br />
</div>
<div>Specifications:</div>
<div>  - <a href="http://www.whatwg.org/specs/web-apps/current-work/#htmlaudioelement" rel="nofollow">HTMLAudioElement</a></div>
<div>  - <a href="http://www.whatwg.org/specs/web-apps/current-work/#htmlmediaelement" rel="nofollow">HTMLMediaElement</a></div>
<div>  - <a href="http://www.whatwg.org/specs/web-apps/current-work/#htmlvideoelement" rel="nofollow">HTMLVideoElement</a></div>
<h3><a name="TOC-Overview"></a>Overview</h3>
<div>There are three major components to Chromium's video implementation:</div>
<div>
<ul><li>Pipeline</li>
<ul><li>Chromium's implementation of a media playback engine</li>
<li>Handles audio/video synchronization and resource fetching</li></ul>
<li>FFmpeg</li>
<ul><li>Open source library used for container parsing and audio/video decoding</li></ul>
<li>WebKit</li>
<ul><li>Implements the HTML and Javascript bindings as specified by WHATWG</li>
<li>Handles rendering the user agent controls</li>
<li>Provides a MediaPlayerPrivate interface for port-specific implementations of a media playback engine</li></ul></ul>
<h4><a name="TOC-Pipeline"></a>Pipeline</h4>
<div>The pipeline is a pull-based media playback engine that abstracts each step of media playback into 6 different filters: data source, demuxing, audio decoding, video decoding, audio rendering, and video rendering.  The pipeline manages the lifetime of the filters and exposes a <a href="http://src.chromium.org/viewvc/chrome/trunk/src/media/base/pipeline.h">simple thread-safe interface</a> to clients.  The filters are connected together to form a filter graph.</div>
<div><br />
</div>
<div>Design goals:</div>
<div>  - Use Chromium threading constructs such as <a href="http://src.chromium.org/viewvc/chrome/trunk/src/base/message_loop/message_loop.h">MessageLoop</a></div>
<div>  - Filters do not determine threading model</div>
<div>  - All filter actions are asynchronous and use callbacks to signal completion</div>
<div>  - Upstream filters are oblivious to downstream filters (i.e., DataSource is unaware of Demuxer)</div>
<div>  - Prefer explicit types and methods over general types and methods (i.e., prefer <font face="'courier new', monospace">foo-&gt;Bar()</font> over <font face="'courier new', monospace">foo-&gt;SendMessage(MSG_BAR)</font>)</div>
<div>  - Can run inside security sandbox</div>
<div>  - Runs on Windows, Mac and Linux on x86 and ARM</div>
<div>  - Supports arbitrary audio/video codecs</div>
<div><br />
</div>
<div>Design non-goals:</div>
<div>  - Querying for filter capabilities</div>
<div>  - Dynamic loading of filters via shared libraries</div>
<div>  - Buffer management negotiation</div>
<div>  - Building arbitrary filter graphs</div>
<div>  - Supporting filters beyond the scope of media playback</div>
<div><br />
</div>
<div>The original research into supporting video in Chromium started in September 2008.  Before deciding to implement our own media playback engine we considered the following alternative technologies:</div>
<div>  - DirectShow (Windows specific, cannot run inside sandbox without major hacking)</div>
<div>  - GStreamer (Windows support questionable at the time, extra ~2MB of DLLs due to library dependencies, targets many of our non-goals)</div>
<div>  - VLC (cannot use due to GPL)</div>
<div>  - MPlayer (cannot use due to GPL)</div>
<div>  - OpenMAX (complete overkill for our purposes)</div>
<div>  - liboggplay (specific to Ogg Theora/Vorbis)</div>
<div><br />
</div>
<div>Our approach was to write our own media playback engine that was audio/video codec agnostic and focused on playback.  Using FFmpeg avoids both the use of proprietary/commercial codecs and allows Chromium's media engine to support a wide variety of formats depending on FFmpeg's build configuration.</div>
<div><br />
</div>
</div>
<div style="display:block;margin-right:auto;margin-left:auto;text-align:center"><a href="http://www.chromium.org/developers/design-documents/video/video_stack_arch.png?attredirects=0" imageanchor="1"><img border="0" src="http://www.chromium.org/_/rsrc/1259798424559/developers/design-documents/video/video_stack_arch.png" /></a></div>
<div><br />
</div>
<div>As previously mentioned, the pipeline is completely pull-based and relies on the sound card to drive playback.  As the sound card requests additional data, the audio renderer requests decoded audio data from the audio decoder, which requests encoded buffers from the demuxer, which reads from the data source, and so on.  As decoded audio data data is fed into the sound card the pipeline's global clock is updated.  The video renderer polls the global clock to determine when to request decoded frames from the video decoder and when to render new frames to the video display.  In the absence of a sound card or an audio track, the system clock is used to drive video decoding and rendering.  Relevant source code: <a href="http://src.chromium.org/viewvc/chrome/trunk/src/media">/src/media</a>, <a href="http://src.chromium.org/viewvc/chrome/trunk/src/media/base/filters.h">filters.h</a>, <a href="http://src.chromium.org/viewvc/chrome/trunk/src/media/base/clock.h">clock.h</a>, <a href="http://src.chromium.org/viewvc/chrome/trunk/src/media/filters/decoder_base.h">decoder_base.h</a>, <a href="http://src.chromium.org/viewvc/chrome/trunk/src/media/filters/audio_renderer_base.h">audio_renderer_base.h</a>, <a href="http://src.chromium.org/viewvc/chrome/trunk/src/media/filters/video_renderer_base.h">video_renderer_base.h</a>.</div>
<div><br />
</div>
<div>The pipeline uses a state machine to handle playback and events such as pausing, seeking, and stopping.  A state transition typically consists of notifying all filters of the event and waiting for completion callbacks before completing the transition (diagram from <a href="http://src.chromium.org/viewvc/chrome/trunk/src/media/base/pipeline_impl.h">pipeline_impl.h</a>):</div>
<div><span style="font-family:Times;font-size:medium">
<pre style="word-wrap:break-word;white-space:pre-wrap">   [ *Created ]
         | Start()
         V
   [ InitXXX (for each filter) ]
         |
         V
   [ Seeking (for each filter) ] &lt;----------------------.
         |                                              |
         V                                              |
   [ Starting (for each filter) ]                       |
         |                                              |
         V      Seek()                                  |
   [ Started ] --------&gt; [ Pausing (for each filter) ] -'
         |                                              |
         |   NotifyEnded()                Seek()        |
         `-------------&gt; [ Ended ] ---------------------'

                  SetError()
   [ Any State ] -------------&gt; [ Error ]
         |          Stop()
         '--------------------&gt; [ Stopped ]</pre>
</span></div>
<div>The pull-based design allows pause to be implemented by setting the playback rate to zero, causing the audio and video renderers to stop requesting data from upstream filters.  Without any pending requests the entire pipeline enters an implicit paused state.
</div>
<h4><a name="TOC-FFmpeg"></a>FFmpeg</h4>
<div>After many rounds of internal testing, we decided to use the <a href="http://gitorious.org/ffmpeg/ffmpeg-mt" rel="nofollow">ffmpeg-mt branch</a> of FFmpeg, which implements parallel frame-level decoding for many popular codecs.  Although FFmpeg supports parallel slice-level decoding for H.264, it requires the content to be encoded with slices and also does not work for other video formats.  We discovered a significant performance increase on multi-core systems using ffmpeg-mt to decode H.264 content compared to vanilla FFmpeg.  FFmpeg is used to implement our demuxer, audio and video decoders.  Relevant source code: <a href="http://src.chromium.org/viewvc/chrome/trunk/deps/third_party/ffmpeg">/deps/third_party/ffmpeg</a>, <a href="http://src.chromium.org/viewvc/chrome/trunk/src/media/filters/ffmpeg_demuxer.h">ffmpeg_demuxer.h</a>, <a href="http://src.chromium.org/viewvc/chrome/trunk/src/media/filters/ffmpeg_audio_decoder.h">ffmpeg_audio_decoder.h</a>, <a href="http://src.chromium.org/viewvc/chrome/trunk/src/media/filters/ffmpeg_video_decoder.h">ffmpeg_video_decoder.h</a>.</div>
<h4><a name="TOC-WebKit"></a>WebKit</h4>
<div>WebKit contains the actual implementation of HTML5 audio and video as <a href="http://www.whatwg.org/specs/web-apps/current-work/#htmlmediaelement" rel="nofollow">specified by WHATWG</a>.  WebKit allows ports to provide a custom media player that handles decoding and playback.  In Chromium's case we use the pipeline described in this document.  WebKit is also responsible for compositing the video and rendering the user agent default controls.  Relevant source code: <a href="http://trac.webkit.org/browser/trunk/WebCore/html/HTMLMediaElement.h" rel="nofollow">HTMLMediaElement.h</a>, <a href="http://trac.webkit.org/browser/trunk/WebCore/html/HTMLMediaElement.idl" rel="nofollow">HTMLMediaElement.idl</a>,  <a href="http://trac.webkit.org/browser/trunk/WebCore/platform/graphics/MediaPlayer.h" rel="nofollow">MediaPlayer.h</a>, <a href="http://trac.webkit.org/browser/trunk/WebCore/platform/graphics/MediaPlayerPrivate.h" rel="nofollow">MediaPlayerPrivate.h</a>, <a href="http://trac.webkit.org/browser/trunk/WebCore/rendering/RenderMedia.h" rel="nofollow">RenderMedia.h</a>, <a href="http://trac.webkit.org/browser/trunk/WebCore/rendering/RenderMediaControlsChromium.h" rel="nofollow">RenderMediaControlsChromium.h</a>, <a href="http://src.chromium.org/viewvc/chrome/trunk/src/webkit/glue/webmediaplayer_impl.h">webmediaplayer_impl.h</a>.</div>
<div><br />
</div>
<div>TODO(scherkus): draw a diagram showing how we get from HTMLMediaElement to WebMediaPlayerImpl.</div>
<div><br />
</div>
<h3><a name="TOC-Integration"></a>Integration</h3>
<div>The following diagram shows the current integration of the media playback pipeline into WebKit and Chromium browser.</div>
<div><br />
</div>
<div>
<table border="1" bordercolor="#888" cellspacing="0" style="border-collapse:collapse;border-top-color:rgb(136,136,136);border-right-color:rgb(136,136,136);border-bottom-color:rgb(136,136,136);border-left-color:rgb(136,136,136);border-top-width:1px;border-right-width:1px;border-bottom-width:1px;border-left-width:1px">
<tbody>
<tr>
<td>
<img border="0" src="http://www.chromium.org/_/rsrc/1259966540019/developers/design-documents/video/video_stack_chrome.png" />
</td>
<td style="width:379px;height:577px"> <br />
<br />
(1) WebKit requests to create a media player, which in Chromium's case creates WebMediaPlayerImpl and Pipeline.<br />
<br />
(2) BufferedDataSource requests to fetch the current video URL via ResourceLoader.<br />
<br />
(3) ResourceDispatcher forwards the request to the browser process.<br />
<br />
(4) A URLRequest is created for the request, which may already have cached data present in HttpCache.  Data is sent back to BufferedDataSource as it becomes available.<br />
<br />
(5) FFmpeg demuxes and decodes audio/video data.<br />
<br />
(6) Due to sandboxing, AudioRendererImpl cannot open an audio device directly and requests the browser to open the device on its behalf.<br />
<br />
(7) The browser opens a new audio device and forwards audio callbacks to the corresponding render process.<br />
<br />
(8) Invalidates are sent to WebKit as new frames are available.</td>
</tr>
</tbody>
</table>
<br />
</div>
<div>
<h2><a name="TOC-Unwritten-Documentation"></a>Unwritten Documentation</h2>
</div>
<div>Playback rate implementation and pitch-preserved audio</div>
<div><br />
</div>
<div>Resource fetching, buffering and sparse caching</div>
<div><br />
</div>
<div>Audio IPC layer</div>
<div><br />
</div>
<div>YUV conversion</div>
<div><br />
</div>
<div>FFmpeg parallel frame-level benchmarks</div>
<div><br />
</div>
<div>Captioning proposal</div>
<div><br />
</div>
<div>Fullscreen proposal</div>
<div><br />
</div>
<div>Hardware acceleration proposal</div></div></td></tr></tbody></table>
</div> 
</div> 
<div id="sites-canvas-bottom-panel">
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_page-subpages"> </div>
<div id="sites-attachments-container">
<div xmlns="http://www.w3.org/1999/xhtml" id="sites-attachments">
<div class="sites-attachments-row"><div class="sites-attachments-icon" style="left:0px;"><span aria-label="Attachments" title="Attachments"><div class="sites-translucent sites-symbol" aria-hidden="true">Č</div></span></div><div id="sites-attachments-update-div" class="sites-attachments-inner-div" style="display:none;"><span class="sites-attachments-update-icon"><img src="http://www.gstatic.com/sites/p/56e332/system/app/images/spinner.gif" /></span><div class="sites-attachments-update-text">Updating...</div></div></div><div class="sites-attachments-separator"></div>
<div id="attachment-wuid:gx:75b2ceab14ef6aad"><div class="sites-attachments-row"><div class="sites-attachments-icon sites-attachments-icon-accessible" style="left:5px"><div class="sites-translucent sites-symbol" aria-label="File" title="File">ċ</div></div><div class="sites-attachments-inner-div"><div class="sites-attachments-name">video_stack_arch.graffle <div class="sites-translucent">(50k)</div></div><div class="sites-attachments-author">Andrew Scherkus, <div class="sites-translucent">Dec 4, 2009, 12:08 PM</div></div></div><div class="sites-attachments-version sites-attachments-version-accessible"><a href="/system/app/pages/admin/revisions?wuid=wuid:gx:75b2ceab14ef6aad">v.1</a></div><div id="attachment-download-wuid:gx:75b2ceab14ef6aad" class="sites-attachments-icon sites-attachments-icon-accessible" style="right:0px"><a href="/developers/design-documents/video/video_stack_arch.graffle?attredirects=0&amp;d=1" aria-label="Download video_stack_arch.graffle" title="Download" role="button"><span class="sites-symbol" aria-hidden="true">ď</span></a></div></div><div class="sites-attachments-separator"></div></div>
<div id="attachment-wuid:gx:18d00ea3bf8245f7"><div class="sites-attachments-row"><div class="sites-attachments-icon sites-attachments-icon-accessible" style="left:5px"><div class="sites-translucent sites-symbol" aria-label="File" title="File">ċ</div></div><div class="sites-attachments-inner-div"><div class="sites-attachments-name">video_stack_chrome.graffle <div class="sites-translucent">(92k)</div></div><div class="sites-attachments-author">Andrew Scherkus, <div class="sites-translucent">Dec 4, 2009, 2:42 PM</div></div></div><div class="sites-attachments-version sites-attachments-version-accessible"><a href="/system/app/pages/admin/revisions?wuid=wuid:gx:18d00ea3bf8245f7">v.2</a></div><div id="attachment-download-wuid:gx:18d00ea3bf8245f7" class="sites-attachments-icon sites-attachments-icon-accessible" style="right:0px"><a href="/developers/design-documents/video/video_stack_chrome.graffle?attredirects=0&amp;d=1" aria-label="Download video_stack_chrome.graffle" title="Download" role="button"><span class="sites-symbol" aria-hidden="true">ď</span></a></div></div><div class="sites-attachments-separator"></div></div>
<div style="height: 10px"></div>
</div>
</div>
<a xmlns="http://www.w3.org/1999/xhtml" name="page-comments"></a>
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_page-comments"><div class="sites-comment-docos-wrapper"><div class="sites-comment-docos"><div class="sites-comment-docos-background"></div><div class="sites-comment-docos-header"><div class="sites-comment-docos-header-title">Comments</div></div><div id="sites-comment-docos-pane" class="sites-comment-docos-pane"></div></div></div></div>
</div>
</div> 
</td> 
</tr>
</table> 
</div> 
</div> 
<div id="sites-chrome-footer-wrapper">
<div id="sites-chrome-footer-wrapper-inside">
<div id="sites-chrome-footer">
</div>
</div>
</div>
</div> 
</div> 
<div id="sites-chrome-adminfooter-container">
<div xmlns="http://www.w3.org/1999/xhtml" class="sites-adminfooter" role="navigation"><p><a class="sites-system-link" href="https://www.google.com/a/UniversalLogin?service=jotspot&amp;continue=http://sites.google.com/a/chromium.org/dev/developers/design-documents/video">Sign in</a><span aria-hidden="true">|</span><a class="sites-system-link" href="/system/app/pages/recentChanges">Recent Site Activity</a><span aria-hidden="true">|</span><a class="sites-system-link" href="/system/app/pages/reportAbuse" target="_blank">Report Abuse</a><span aria-hidden="true">|</span><a class="sites-system-link" href="javascript:;" onclick="window.open(webspace.printUrl)">Print Page</a><span aria-hidden="true">|</span><span class="sites-system-link">Powered By</span> <b class="powered-by"><a href="http://sites.google.com">Google Sites</a></b></p></div>
</div>
</div> 
</div> 
<div id="sites-chrome-onebar-footer">
</div>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
    window.jstiming.load.tick('sjl');
  </script>
<script xmlns="http://www.w3.org/1999/xhtml" src="http://www.gstatic.com/sites/p/56e332/system/js/jot_min_view__en.js"></script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
    window.jstiming.load.tick('jl');
  </script>
<script xmlns="http://www.w3.org/1999/xhtml">
      
          sites.core.Analytics.createTracker();
          sites.core.Analytics.trackPageview();
        
    </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
                    sites.Searchbox.initialize(
                        'sites-searchbox-search-button',
                        {"object":[]}['object'],
                        'search-site',
                        {"label":"Configure search options...","url":"/system/app/pages/admin/settings"});
                  </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
      gsites.HoverPopupMenu.createSiteDropdownMenus('sites-header-nav-dropdown', false);
    </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript" defer="true">
            JOT_setupNav("7648876402527094", "Navigation", false);
            JOT_addListener('titleChange', 'JOT_NAVIGATION_titleChange', 'COMP_7648876402527094');
          </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript" defer="true">
            JOT_setupNav("14720868319272995", "Quick links", false);
            JOT_addListener('titleChange', 'JOT_NAVIGATION_titleChange', 'COMP_14720868319272995');
          </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript" defer="true">
            JOT_setupNav("19690813310444355", "Other sites", false);
            JOT_addListener('titleChange', 'JOT_NAVIGATION_titleChange', 'COMP_19690813310444355');
          </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
              new sites.CommentPane('//docs.google.com/comments/d/AAHRpnXvrAwjAfmld0ObrebBiGRq9GkEOp75TJ1kMFCNvDZtpT2Ip1-Tmay2xoCbSB_Z91Ta9i1bG1GBVfblSeYfYzZW6oUU1iMITFjVSXDnsvUwsKZzNb0HdpWHdsA9Xz7JHUsVgQfm1/api/js?anon=true',
                  false, false);
            </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
  setTimeout(function() {
    var fingerprint = gsites.date.TimeZone.getFingerprint([]);
    gsites.Xhr.send('http://www.chromium.org/_/tz', null, null, 'GET', null, null, { afjstz: fingerprint });
  }, 500);
</script>
<script xmlns="http://www.w3.org/1999/xhtml">
                    window.onload = function() {
                      if (false) {
                        JOT_setMobilePreview();
                      }
                      var loadTimer = window.jstiming.load;
                      loadTimer.tick("ol");
                      loadTimer["name"] = "load," + webspace.page.type + ",user_page";
                      window.jstiming.report(loadTimer, {}, 'http://csi.gstatic.com/csi');
                    }
                  </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
        JOT_insertAnalyticsCode(false,
            false);
      </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
    var maestroRunner = new gsites.pages.view.SitesMaestroRunner(
        webspace, "en");
    maestroRunner.initListeners();
    maestroRunner.installEditRender();
  </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript" defer="true">
  //<![CDATA[
    // Decorate any fastUI buttons on the page with a class of 'goog-button'.
    if (webspace.user.hasWriteAccess) {
      JOT_decorateButtons();
    }

    // Fires delayed events.
    (function() {
      JOT_fullyLoaded = true;
      var delayedEvents = JOT_delayedEvents;
      for (var x = 0; x < delayedEvents.length; x++) {
        var event = delayedEvents[x];
        JOT_postEvent(event.eventName, event.eventSrc, event.payload);
      }
      JOT_delayedEvents = null;
      JOT_postEvent('pageLoaded');
    })();
  //]]>
</script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
    JOT_postEvent('decorateGvizCharts');
  </script>
<script type="text/javascript">
          JOT_setupPostRenderingManager();
        </script>
<script type="text/javascript">
          JOT_postEvent('renderPlus', null, 'sites-chrome-main');
        </script>
<div id="server-timer-div" style="display:none"> </div>
<script type="text/javascript">
          window.jstiming.load.tick('render');
          JOT_postEvent('usercontentrendered', this);
        </script>
</body>
</html>
