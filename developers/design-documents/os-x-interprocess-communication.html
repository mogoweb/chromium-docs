<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/WebPage">
<head>
<meta http-equiv="X-UA-Compatible" content="chrome=1" />
<script type="text/javascript">/* Copyright 2008 Google. */ (function() { var e="wtsrt_",g="tbsd_",h="tbnd_",k="start",l="_wtsrt",m="_tbnd",n="CSI/";(function(){function f(a){this.t={};this.tick=function(a,c,b){this.t[a]=[void 0!=b?b:(new Date).getTime(),c];if(void 0==b)try{window.console.timeStamp(n+a)}catch(d){}};this.tick(k,null,a)}var a;window.performance&&(a=window.performance.timing);var p=a?new f(a.responseStart):new f;window.jstiming={Timer:f,load:p};if(a){var c=a.navigationStart,d=a.responseStart;0<c&&d>=c&&(window.jstiming.srt=d-c)}if(a){var b=window.jstiming.load;0<c&&d>=c&&(b.tick(l,void 0,c),b.tick(e,l,d),b.tick(g,e))}try{a=null,
window.chrome&&window.chrome.csi&&(a=Math.floor(window.chrome.csi().pageT),b&&0<c&&(b.tick(m,void 0,window.chrome.csi().startE),b.tick(h,m,c))),null==a&&window.gtbExternal&&(a=window.gtbExternal.pageT()),null==a&&window.external&&(a=window.external.pageT,b&&0<c&&(b.tick(m,void 0,window.external.startE),b.tick(h,m,c))),a&&(window.jstiming.pt=a)}catch(q){}})(); })()
</script>
<link rel="shortcut icon" href="../../_/rsrc/1354323194313/favicon.ico" type="image/x-icon" />
<link rel="apple-touch-icon" href="https://ssl.gstatic.com/sites/p/56e332/system/app/images/apple-touch-icon.png" type="image/png" />
<script type="text/javascript">/* Copyright 2008 Google. */ (function() { var d="",g="__duration__",h="function";function k(c){return document.getElementById(c)}window.byId=k;function l(c){return c.replace(/^\s+|\s+$/g,d)}window.trim=l;var m=[],n=0;window.JOT_addListener=function(c,a,b){var e=new String(n++);c={eventName:c,handler:a,compId:b,key:e};m.push(c);return e};window.JOT_removeListenerByKey=function(c){for(var a=0;a<m.length;a++)if(m[a].key==c){m.splice(a,1);break}};
window.JOT_removeAllListenersForName=function(c){for(var a=0;a<m.length;a++)m[a].eventName==c&&m.splice(a,1)};window.JOT_postEvent=function(c,a,b){var e={eventName:c,eventSrc:a||{},payload:b||{}};if(window.JOT_fullyLoaded)for(a=m.length,b=0;b<a&&b<m.length;b++){var f=m[b];f&&f.eventName==c&&(e.listenerCompId=f.compId||d,(f=typeof f.handler==h?f.handler:window[f.handler])&&f(e))}else window.JOT_delayedEvents.push({eventName:c,eventSrc:a,payload:b})};window.JOT_delayedEvents=[];
window.JOT_fullyLoaded=!1;window.JOT_formatRelativeToNow=function(c,a){var b=((new Date).getTime()-c)/6E4;if(1440<=b||0>b)return null;var e=0;60<=b&&(b/=60,e=2);2<=b&&e++;return a?window.JOT_siteRelTimeStrs[e].replace(g,Math.floor(b)):window.JOT_userRelTimeStrs[e].replace(g,Math.floor(b))}; })()
</script>
<script>

  

  var breadcrumbs = [{"path":"/developers","deleted":false,"title":"For Developers","dir":"ltr"},{"path":"/developers/design-documents","deleted":false,"title":"Design Documents","dir":"ltr"},{"path":"/developers/design-documents/os-x-interprocess-communication","deleted":false,"title":"Mach based OS X Interprocess Communication (Obsolete)","dir":"ltr"}];
  var JOT_clearDotPath = 'https://ssl.gstatic.com/sites/p/56e332/system/app/images/cleardot.gif';

  
  var JOT_userRelTimeStrs = ["a minute ago","__duration__ minutes ago","an hour ago","__duration__ hours ago"];

  
  

  

  var webspace = {"enableAnalytics":true,"pageSharingId":"jotspot_page","enableUniversalAnalytics":false,"sharingPolicy":"OPENED_WITH_INDICATOR","siteTitle":"The Chromium Projects","isStartPageEnabled":true,"adsensePublisherId":null,"features":{"languageSelectDefaultTextSetToDefault":true,"validateClientGvizDataSourceUrls":true,"moreMobileStyleImprovements":true,"newInsertMenuIcons":true,"accessibleSortingButtons":true,"domainAnalyticsInGAOnly":true,"noCaptcha":true,"fileCabinetScreenReaderFix":true,"updatedTosAndPrivacyLinks":null,"pageDrafts":false,"mobileOrientationFix":true,"plusBadge":false,"pdfEmbedSupport":false,"jsClickFix":true},"isPublic":true,"isConsumer":false,"serverFlags":{"cajaBaseUrl":"//www.gstatic.com/caja","cajaDebugMode":false},"onepickBaseUrl":"https://docs.google.com","domainAnalyticsAccountId":"","plusPageId":"","signInUrl":"https://www.google.com/a/SelectSession?continue\u003dhttps://sites.google.com/a/chromium.org/dev/developers/design-documents/os-x-interprocess-communication\u0026service\u003djotspot","analyticsAccountId":"UA-5484340-1","scottyUrl":"/_/upload","homePath":"/","siteNoticeUrlEnabled":null,"plusPageUrl":"","adsensePromoClickedOrSiteIneligible":true,"csiReportUri":"https://gg.google.com/csi","sharingId":"jotspot","termsUrl":"//www.google.com/intl/en/policies/terms/","gvizVersion":1,"editorResources":{"sitelayout":["https://ssl.gstatic.com/sites/p/56e332/system/app/css/sitelayouteditor.css"],"text":["https://ssl.gstatic.com/sites/p/56e332/system/js/codemirror.js","https://ssl.gstatic.com/sites/p/56e332/system/app/css/codemirror_css.css","https://ssl.gstatic.com/sites/p/56e332/system/js/trog_edit__en.js","https://ssl.gstatic.com/sites/p/56e332/system/app/css/trogedit.css","/_/rsrc/1441580320000/system/app/css/editor.css","https://ssl.gstatic.com/sites/p/56e332/system/app/css/codeeditor.css","/_/rsrc/1441580320000/system/app/css/camelot/editor-jfk-wlb.css"]},"sharingUrlPrefix":"/_/sharing","isAdsenseEnabled":true,"domain":"chromium.org","baseUri":"","name":"dev","siteTemplateId":false,"siteNoticeRevision":null,"siteNoticeUrlAddress":null,"siteNoticeMessage":null,"page":{"isRtlLocale":false,"canDeleteWebspace":null,"isPageDraft":null,"parentPath":"/developers/design-documents","parentWuid":"wuid:gx:359ef223e0fb14ac","siteLocale":"en","timeZone":"America/Los_Angeles","type":"text","title":"Mach based OS X Interprocess Communication (Obsolete)","locale":"en","wuid":"wuid:gx:55b745536ae28e75","revision":11,"path":"/developers/design-documents/os-x-interprocess-communication","isSiteRtlLocale":false,"pageInheritsPermissions":null,"name":"os-x-interprocess-communication","canChangePath":true,"state":"","properties":{},"bidiEnabled":false,"currentTemplate":{"path":"/system/app/pagetemplates/text","title":"Web Page"}},"canPublishScriptToAnyone":true,"user":{"keyboardShortcuts":true,"sessionIndex":"","guest_":true,"displayNameOrEmail":"guest","userName":"guest","uid":"","renderMobile":false,"domain":"","namespace":"","hasWriteAccess":false,"namespaceUser":false,"primaryEmail":"guest","hasAdminAccess":false},"gadgets":{"baseUri":"/system/app/pages/gadgets"}};
  webspace.page.breadcrumbs = breadcrumbs;

  
  var JOT_siteRelTimeStrs = ["a minute ago","__duration__ minutes ago","an hour ago","__duration__ hours ago"];

</script>
<script type="text/javascript">
                window.jstiming.load.tick('scl');
              </script>
<meta name="title" content="Mach based OS X Interprocess Communication (Obsolete) - The Chromium Projects" />
<meta itemprop="name" content="Mach based OS X Interprocess Communication (Obsolete) - The Chromium Projects" />
<meta property="og:title" content="Mach based OS X Interprocess Communication (Obsolete) - The Chromium Projects" />
<meta name="description" content="Home of the Chromium Open Source Project" />
<meta itemprop="description" content="Home of the Chromium Open Source Project" />
<meta id="meta-tag-description" property="og:description" content="Home of the Chromium Open Source Project" />
<style type="text/css">
</style>
<link rel="stylesheet" type="text/css" href="https://ssl.gstatic.com/sites/p/56e332/system/app/themes/beigeandblue/standard-css-beigeandblue-ltr-ltr.css" />
<link rel="stylesheet" type="text/css" href="../../_/rsrc/1441580320000/system/app/css/overlay.css%3Fcb=beigeandblueundefineda100%2525%2525150goog-ws-leftthemedefaultstandard.css" />
<link rel="stylesheet" type="text/css" href="../../_/rsrc/1441580320000/system/app/css/camelot/allthemes-view.css" />
<!--[if IE]>
          <link rel="stylesheet" type="text/css" href="/system/app/css/camelot/allthemes%2die.css" />
        <![endif]-->
<title>Mach based OS X Interprocess Communication (Obsolete) - The Chromium Projects</title>
<meta itemprop="image" content="/_/rsrc/1438879449147/config/customLogo.gif?revision=3" />
<meta property="og:image" content="/_/rsrc/1438879449147/config/customLogo.gif?revision=3" />
<script type="text/javascript">
                window.jstiming.load.tick('cl');
              </script>
</head>
<body xmlns="http://www.google.com/ns/jotspot" id="body" class=" en            ">
<div id="sites-page-toolbar" class="sites-header-divider">
<div xmlns="http://www.w3.org/1999/xhtml" id="sites-status" class="sites-status" style="display:none;"><div id="sites-notice" class="sites-notice" role="status" aria-live="assertive"> </div></div>
</div>
<div id="sites-chrome-everything-scrollbar">
<div id="sites-chrome-everything" class="">
<div id="sites-chrome-page-wrapper" style="direction: ltr">
<div id="sites-chrome-page-wrapper-inside">
<div xmlns="http://www.w3.org/1999/xhtml" id="sites-chrome-header-wrapper" style="height:auto;">
<table id="sites-chrome-header" class="sites-layout-hbox" cellspacing="0" style="height:auto;">
<tr class="sites-header-primary-row" id="sites-chrome-userheader">
<td id="sites-header-title" class="" role="banner"><div class="sites-header-cell-buffer-wrapper"><a href="../../index.html" id="sites-chrome-userheader-logo"><img id="logo-img-id" src="../../_/rsrc/1438879449147/config/customLogo.gif%3Frevision=3" alt="The Chromium Projects" class="sites-logo  " /></a><h2><a href="../../index.html" dir="ltr" id="sites-chrome-userheader-title">The Chromium Projects</a></h2></div></td><td class="sites-layout-searchbox  "><div class="sites-header-cell-buffer-wrapper"><form id="sites-searchbox-form" action="https://www.chromium.org/system/app/pages/search" role="search"><input type="hidden" id="sites-searchbox-scope" name="scope" value="search-site" /><input type="text" id="jot-ui-searchInput" name="q" size="20" value="" aria-label="Search this site" /><div id="sites-searchbox-button-set" class="goog-inline-block"><div role="button" id="sites-searchbox-search-button" class="goog-inline-block jfk-button jfk-button-standard" tabindex="0">Search this site</div></div></form></div></td>
</tr>
<tr class="sites-header-secondary-row" id="sites-chrome-horizontal-nav">
<td colspan="2" id="sites-chrome-header-horizontal-nav-container" role="navigation">
</td>
</tr>
</table>
</div>
<div id="sites-chrome-main-wrapper">
<div id="sites-chrome-main-wrapper-inside">
<table id="sites-chrome-main" class="sites-layout-hbox" cellspacing="0" cellpadding="{scmCellpadding}" border="0">
<tr>
<td id="sites-chrome-sidebar-left" class="sites-layout-sidebar-left initial" style="width:150px">
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_7648876402527094" class="sites-embed" role="navigation"><div class="sites-embed-content sites-sidebar-nav"><ul role="navigation" jotId="navList"><li class="nav-first "><div dir="ltr" style="padding-left: 5px;"><a href="../../chromium-projects.html" jotId="wuid:gx:10ae433dadbbab13" class="sites-navigation-link">Home</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="../../Home.1.html" jotId="wuid:gx:43582b9d2029d3af" class="sites-navigation-link">Chromium</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="../../chromium-os.1.html" jotId="wuid:gx:83df2ab1f8880ba" class="sites-navigation-link">Chromium OS</a></div></li></ul></div></div>
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_14720868319272995" class="sites-embed" role="navigation"><h4 class="sites-embed-title">Quick links</h4><div class="sites-embed-content sites-sidebar-nav"><ul role="navigation" jotId="navList"><li class="nav-first "><div dir="ltr" style="padding-left: 5px;"><a href="../../for-testers/bug-reporting-guidelines.html" class="sites-navigation-link">Report bugs</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="../discussion-groups.html" class="sites-navigation-link">Discuss</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="../../system/app/pages/sitemap/hierarchy.html" jotId="wuid:gx:4b58a9a350ad12f" class="sites-navigation-link">网站地图</a></div></li></ul></div></div>
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_19690813310444355" class="sites-embed" role="navigation"><h4 class="sites-embed-title">Other sites</h4><div class="sites-embed-content sites-sidebar-nav"><ul role="navigation" jotId="navList"><li class="nav-first "><div dir="ltr" style="padding-left: 5px;"><a href="http://blog.chromium.org/" class="sites-navigation-link">Chromium Blog</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="http://code.google.com/chrome/extensions/" class="sites-navigation-link">Google Chrome Extensions</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="https://developers.google.com/chrome/chrome-frame/" class="sites-navigation-link">Google Chrome Frame</a></div></li></ul></div></div>
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_19695218559354544" class="sites-embed" role="complementary"><h4 class="sites-embed-title"></h4><div class="sites-embed-content sites-embed-content-sidebar-textbox"><div dir="ltr"><span style="font-size:x-small">Except as otherwise </span><a href="http://developers.google.com/site-policies.html#restrictions"><span style="font-size:x-small">noted</span></a><span style="font-size:x-small">, the content of this page is licensed under a </span><a href="http://creativecommons.org/licenses/by/2.5/"><span style="font-size:x-small">Creative Commons Attribution 2.5 license</span></a><span style="font-size:x-small">, and examples are licensed under the </span><a href="http://src.chromium.org/viewvc/chrome/trunk/src/LICENSE" target="_blank"><span style="font-size:x-small">BSD License</span></a><span style="font-size:x-small">.<br /></span></div></div></div>
</td>
<td id="sites-canvas-wrapper">
<div id="sites-canvas" role="main">
<div id="goog-ws-editor-toolbar-container"> </div>
<div xmlns="http://www.w3.org/1999/xhtml" id="title-crumbs" style="">
<A href="../../developers.1.html" dir="ltr">For Developers</A>‎ &gt; ‎<A href="../design-documents.1.html" dir="ltr">Design Documents</A>‎ &gt; ‎
  </div>
<h3 xmlns="http://www.w3.org/1999/xhtml" id="sites-page-title-header" style="" align="left">
<span id="sites-page-title" dir="ltr" tabindex="-1" style="outline: none">Mach based OS X Interprocess Communication (Obsolete)</span>
</h3>
<div id="sites-canvas-main" class="sites-canvas-main">
<div id="sites-canvas-main-content">
<table xmlns="http://www.w3.org/1999/xhtml" cellspacing="0" class="sites-layout-name-one-column sites-layout-hbox"><tbody><tr><td class="sites-layout-tile sites-tile-name-content-1"><div dir="ltr"><div style="text-align:right"><div style="text-align:center">
<h2><a name="TOC-Mach-based-IPC-Design"></a><u><font size="5">Mach based IPC Design</font></u><br /></h2>
</div><br /></div><u>Current status of this design:</u><br />The design described here is currently not used on OS X.  Please see the <a href="inter-process-communication.html">Interprocess Communication</a> design doc for coverage of the current implementation for all platforms.<br /><br />A reference implementation of Mach based IPC including a kqueue bridge can be found in <a href="http://code.google.com/p/chromium/issues/detail?id=5308" target="_blank">issue 5308</a>.<div><br /></div><div>In 2015, another consideration was given to using Mach IPC, and <a href="https://docs.google.com/a/chromium.org/document/d/14-twSrkEhgPI87Pi757auoRhzFYRPqbzdHorHhJn0Kk/edit#">the results of that survey are here</a>.<br /><br /><u>Rationale for not using Mach based IPC:</u><br />Chrome handles network communication and IPC messages on the same thread.  Sockets are waited on using kqueues via libevent.<br />Although there is a constant defined in the kqueue headers on OS X (<span style="font-family:courier new,monospace">EVFILTER_MACH</span> in <span style="font-family:courier new,monospace">sys/event.h</span>), there is currently no way to block on both a socket and a mach port at once, this means that our only option is to spawn another thread to bridge Mach messages to kqueue.  Our reference implementation does this by opening a pipe between both threads and writing a byte each time a Mach message is received.<br /><br />Because of this extra step, we now need to pay the price both of receiving a Mach message and communicating via a pipe between threads.  We've timed this approach and found it to be 10uSec slower on Desktops &amp; 20uSecs faster on laptops than a pure pipe based implementation.<br /><br />If you look at the measurements at the bottom of this document, you can see that most of the messages Chrome sends are very small.  So the performance benefits of Mach messages over pipes are negligible.<br /><br />Thus our decision at this time is to use the same approach as Linux.  If we run into problems at a later date with a pipe-based implementation we can revert to the Mach-based one.<br /><div style="text-align:right">
</div>
<br /><h3 style="text-align:center"><a name="TOC-Mach-based-IPC:"></a><u>Mach based IPC:</u></h3>
<div style="text-align:right">
</div>
  Summary of departures from current Windows architecture:
<div style="text-align:right">
</div>
<div style="text-align:right">
</div>
<br /><u>PC::Channel:</u>
<div style="text-align:right">
</div> This class basically needs to be rewritten to use Mach ports, we
require a bidirectional communication mechanism able to
transfer arbitrarily sized messages.  This means we need to create two
Mach ports (Server-&gt;Client &amp; Client-&gt;Server).
<div style="text-align:right">
</div>
<br />
<div style="text-align:right">
</div>
<u>Establishing</u><u> Communications:</u>
<div style="text-align:right">
</div>
  (From chrome/common/ipc_channel.h)
<div style="text-align:right">
</div>
<p style="margin:0px;font-family:Monaco;font-style:normal;font-variant:normal;font-weight:normal;line-height:normal;font-size-adjust:none;font-stretch:normal">
<font size="1"> </font><span style="color:rgb(170,13,145)">enum</span><font size="1"> Mode { </font>
</p>
<p style="margin:0px;font-family:Monaco;font-style:normal;font-variant:normal;font-weight:normal;line-height:normal;font-size-adjust:none;font-stretch:normal">
<font size="1">     MODE_SERVER, </font>
</p>
<p style="margin:0px;font-family:Monaco;font-style:normal;font-variant:normal;font-weight:normal;line-height:normal;font-size-adjust:none;font-stretch:normal">
<font size="1">     MODE_CLIENT </font>
</p>
<p style="margin:0px;font-family:Monaco;font-style:normal;font-variant:normal;font-weight:normal;line-height:normal;font-size-adjust:none;font-stretch:normal">
<font size="1">   }; </font>
</p>
<div style="text-align:right">
</div>
<span style="font-family:Monaco"><font size="1">IPC::Channel::Channel(</font><span style="color:rgb(170,13,145)">const</span><font size="1"> std::wstring&amp; channel_id, Mode mode, Listener* listener);</font></span>
<div style="text-align:right">
</div>
<span style="font-family:Monaco"><font size="1"> </font>
<p style="margin:0px;font-family:Monaco;font-style:normal;font-variant:normal;font-weight:normal;line-height:normal;font-size-adjust:none;font-stretch:normal">
<font size="1"> </font><span style="color:rgb(170,13,145)">bool</span><font size="1"> Connect(); </font>
</p>
<font size="1"> </font>
<p style="margin:0px;font-family:Monaco;font-style:normal;font-variant:normal;font-weight:normal;line-height:normal;font-size-adjust:none;font-stretch:normal">
</p></span><br /><span style="font-family:Monaco"><p style="margin:0px;font-family:Monaco;font-style:normal;font-variant:normal;font-weight:normal;line-height:normal;font-size-adjust:none;font-stretch:normal"><font size="1">
</font>
</p>
<font size="1"> </font></span>
<div style="text-align:right">
</div> When a Channel is created in Server mode it creates a Mach port
and registers it with the Bootstrap server using the channel_id
prefixed with the string 'chrome_'.  It then sets <span style="font-family:Monaco"><font size="1">waiting_connect_</font></span> to false.
<div style="text-align:right">
</div>
<div style="text-align:left">
When a Child process is started, it's passed the channel id and an authorization token via stdin (since that's not visible to other processes on the system).
</div>
<br />
<div style="text-align:right">
</div> When a Channel is opened in Client mode, the Channel ID is
looked up on the Bootstrap server.  The client then creates a Mach port
for incoming messages, it sends a Hello message to the server
containing port rights to its incoming port and the authorization token sent over the pipe.
<div style="text-align:right">
</div>
  Upon receiving a Hello message, the Server verifies the token, if it's valid, it stores the send port rights and sets <span style="font-family:Monaco"><font size="1">waiting_connect_</font></span> to false.
<div style="text-align:right">
</div>
<div style="text-align:right">
</div>
<br />Server-&gt;Client.
<div style="text-align:right">
</div>
<div style="text-align:right">
</div>
<u>Sending Messages:</u>
<div style="text-align:right">
</div>
  (From chrome/common/ipc_channel.h)
<div style="text-align:right">
</div>
<p style="margin:0px;font-family:Monaco;font-style:normal;font-variant:normal;font-weight:normal;line-height:normal;font-size-adjust:none;font-stretch:normal">
<font size="1">  </font><span style="color:rgb(170,13,145)">bool</span><font size="1"> Send(Message* message); </font>
</p>
<p style="margin:0px;font-family:Monaco;font-style:normal;font-variant:normal;font-weight:normal;line-height:normal;font-size-adjust:none;font-stretch:normal">
<font size="1"><br />
</font>
</p>
<div style="text-align:right">
</div>
  Mach ports have a fixed queue size, we want to be able to send arbitrary numbers of messages without blocking.
<div style="text-align:right">
</div> Messages to send over the wire are queued up on the Server side
in an std::vector&lt;Message*&gt;, we specify a timeout value when
sending a Mach message, if the send times out then we set a delayed
task to attempt to resend the message after a delta.
<div style="text-align:right">
</div>
  When IPC::Channel::Send() is called, we attempt to send out all the messages in our outgoing queue until we block.
<div style="text-align:right">
</div>
<br />
<div style="text-align:right">
</div>
<u>Receiving messages:</u>
<div style="text-align:right">
</div> Messages can be an size up to 256MB, this presents a problems
since we don't want to allocate a 256MB buffer to receive messages
into.
<div style="text-align:right">
</div>
  We can allocate an input buffer of a reasonable size, and specify the <span style="font-family:Times"><font size="3">MACH_RCV_LARGE </font><span style="font-family:Verdana"><font size="2">flag
when receiving messages, if the message doesn't fit into our buffer
then we get a chance to dynamically allocate a new receive buffer and
stick our data in there.</font></span></span>
<div style="text-align:right">
</div> We will probably also want to look at large messages and send
those over as OOL transfer (OS X Internals 9.5.5) so that they're
transferred with copy-on-write semantics.
<div style="text-align:right">
</div>
<br />
<div style="text-align:right">
</div>
<u>Security:<br /></u>The initial security token provides security in the face of rogue client processes trying to connect back to a server, we can use the OS X Authorization Services API &amp; AuthorizationMakeExternalForm() to generate the token.<br />
<div style="text-align:right">
</div> We can make use of Mach's sender security token (OS X Internals
9.2.2.3) to prevent processes not owned by the user from communicating
with the server.<br /><br />
<div style="text-align:center"><h2><a name="TOC-Rationale-for-using-Mach-ports:"></a><u><font size="4">Rationale for using Mach ports:</font></u></h2>
</div>
<font size="3"><u>Current Windows implementation:</u></font><br /><div>
<br />
The IPC::Channel object (chrome/common/ipc_channel.h) sends/receives
discrete messages [length/byte array] over a bidirectional named pipe.<br />
<br />
  Messages are limited to be less than 256MB, but can otherwise be of arbitrary size.<br />
<br />
The pipe name is passed as a parameter to new rendering processes. 
This is useful for debugging purposes since you can connect an
arbitrary rendering process to a browser instance.<br />
<br />
<u>Sharing resources between processes:</u><br />
<br />
  Windows OS Handles can be shared between processes by calling <span style="font-family:Courier New">DuplicateHandle()</span>,
this duplicates the handle into the target process and returns an ID
valid in that process.  This ID can then be sent as POD over the IPC
Channel .  This is very convenient since it means that they can just be
wrapped in an arbitrary messagen and send over the wire, but it's a
very Windows-specific capability.  There are currently 45 calls to <span style="font-family:Courier New">DuplicateHandle()</span> in the code (Not all of these are necessarily used for IPC).<br />
<br />
<u><font size="3">OS X Implementation:</font></u><br />
<br />
  We basically have two options for implementation here worth discussing:<br />
<br />
<u>FIFO:</u><br />
<u>Advantages:</u><br />
<ul><li>
      Very close to the current Windows implementation.
    </li><li>
      Might be shareable with Linux port.
    </li><li>
      Access control via full file system owner/permissions/ACL semantics
    </li></ul>
<br />
<u>Disadvantages:</u><br />
<ul><li>
      Provides no mechanism to transmit mach semaphores and other system resources over the connection.
    </li><li>
      Messy, lives in the file system.
    </li><li>
      OS X may have quirks that prevent us from sharing the implementation with Linux.
    </li></ul>
<br />
<u>Mach ports:</u><br />
<u>Advantages:</u><br />
<ul><li>
      Fast:
    </li><ul><li>
        pretty much any other IPC API we might use is already layered on top of this.
      </li><li>
        Does everything it can to remap memory rather than copy data.
      </li><li>
        Facilities to send over mem. buffers by remapping them via copy-on-write (OOL).
      </li></ul><li>
      Secure - bunch of security primitives.
    </li><li>
      Allows us to send unnamed system resources such as semaphores and shared memory regions to another process.
    </li></ul>
<br />
<u>Disadvantages:</u><br />
<ul><li>
      OS X Specific.
    </li><li>
      Message based rather than stream based so if we get large messages we potentially need to copy them multiple times.
    </li></ul>
<div style="text-align:right">
<br /></div><div style="text-align:center"><h2><a name="TOC-Performance-Considerations"></a><u>Performance Considerations</u></h2></div><br /><div> What follows are the results of some benchmarks we ran contrasting Mach messaging and FIFO's.<br />
<br /> We tested Mach ports using both inline &amp; out of line (OOL) data transfer.  Inline transfer means the payload is transferred as part of the message and copied into the receiving process.  OOL remaps the memory area using copy-on-write semantics.<div><br /> The executive summary is that Mach messages are faster than FIFOs on OS X, especially if we transfer messages larger than a certain threshold using OOL.<br /></div><br /><u>Technical Detail:</u><div><br /> The tables below contain the results from the following test programs:<br /></div><ul><li>Mach - spawn two processes and send mach messages containing an inline buffer of the requisite size between them.</li><li>Mach OOL - Same as MachPerf but sends the data OOL.</li><li>FIFO - spawn a new process and read/write data over a FIFO.</li></ul><div><br /> Our testing methodology was to send over 2000 messages, times are in uSec and the ones shown represent the 98th percentile of the measured data.  Variance of all values is ~10uSec, possibly higher.<br /><br /><u>Discussion:</u><br /></div><br />Inline Mach messages take a performance hit for message sizes &gt;5K, below that they are ~1.5X FIFOS on a 4 core Mac desktop and 280%-1000% faster than FIFOs a Laptop.<br /><div>  <br /> The desktop/laptop difference is something we see consistently.<br /><br />OOL transfer has a constant overhead of ~30uSec which appears to be a clear win over any method that copies data between processes.<u><br /></u></div><br /><u>The data (times in uSec +/- 10uSec):</u><br /><br />Laptop:<br />
<br /><span style="font-family:courier new,monospace">Packet Size (bytes)  Mach    Mach OOL   FIFO           % min(Mach,Mach OOL) better than FIFO</span><br style="font-family:courier new,monospace" /><span style="font-family:courier new,monospace">100                  29      35         112            386                 </span><br style="font-family:courier new,monospace" />
<span style="font-family:courier new,monospace">200                  10      37         121            1210                </span><br style="font-family:courier new,monospace" /><span style="font-family:courier new,monospace">500                  11      36         124            1127                </span><br style="font-family:courier new,monospace" />
<span style="font-family:courier new,monospace">1024                 9       36         115            1277                </span><br style="font-family:courier new,monospace" /><span style="font-family:courier new,monospace">2048                 28      37         131            467                 </span><br style="font-family:courier new,monospace" />
<span style="font-family:courier new,monospace">3072                 11      39         129            1172                </span><br style="font-family:courier new,monospace" /><span style="font-family:courier new,monospace">4096                 11      29         128            1163                </span><br style="font-family:courier new,monospace" />
<span style="font-family:courier new,monospace">5120                 13      31         127            976                 </span><br style="font-family:courier new,monospace" /><span style="font-family:courier new,monospace">6144                 51      30         134            446                 </span><br style="font-family:courier new,monospace" />
<span style="font-family:courier new,monospace">7168                 46      30         133            443                 </span><br style="font-family:courier new,monospace" /><span style="font-family:courier new,monospace">8192                 51      32         215            671                 </span><br style="font-family:courier new,monospace" />
<span style="font-family:courier new,monospace">9216                 57      30         218            726                 </span><br style="font-family:courier new,monospace" /><span style="font-family:courier new,monospace">1048576              1477    29         2873           9906                </span><br style="font-family:courier new,monospace" />
<span style="font-family:courier new,monospace">5242880              11079   39         10924          28010               </span><br style="font-family:courier new,monospace" /><span style="font-family:courier new,monospace">7340032              15144   38         14184          37326               </span><br style="font-family:courier new,monospace" />
<span style="font-family:courier new,monospace">                                                   </span><br />Desktop:                      <div dir="ltr">                     <br />                                                   <br />
<span style="font-family:courier new,monospace">Packet Size (bytes)  Mach    Mach OOL   FIFO           % min(Mach,Mach OOL) better than FIFO</span><br style="font-family:courier new,monospace" /><span style="font-family:courier new,monospace">100                  10      26         29             290                 </span><br style="font-family:courier new,monospace" />
<span style="font-family:courier new,monospace">200                  11      26         30             272                 </span><br style="font-family:courier new,monospace" /><span style="font-family:courier new,monospace">500                  12      29         30             250                 </span><br style="font-family:courier new,monospace" />
<span style="font-family:courier new,monospace">1024                 11      34         30             272                 </span><br style="font-family:courier new,monospace" /><span style="font-family:courier new,monospace">2048                 15      36         31             206                 </span><br style="font-family:courier new,monospace" />
<span style="font-family:courier new,monospace">3072                 16      39         32             200                 </span><br style="font-family:courier new,monospace" /><span style="font-family:courier new,monospace">4096                 14      29         36             257                 </span><br style="font-family:courier new,monospace" />
<span style="font-family:courier new,monospace">5120                 19      25         37             194                 </span><br style="font-family:courier new,monospace" /><span style="font-family:courier new,monospace">6144                 66      27         34             125                 </span><br style="font-family:courier new,monospace" />
<span style="font-family:courier new,monospace">7168                 53      26         38             146                 </span><br style="font-family:courier new,monospace" /><span style="font-family:courier new,monospace">8192                 70      26         59             226                 </span><br style="font-family:courier new,monospace" />
<span style="font-family:courier new,monospace">9216                 81      25         66             264                 </span><br style="font-family:courier new,monospace" /><span style="font-family:courier new,monospace">1048576              1822    33         2623           7948                </span><br style="font-family:courier new,monospace" />
<span style="font-family:courier new,monospace">5242880              11536   37         13125          35472               </span><br style="font-family:courier new,monospace" /><span style="font-family:courier new,monospace">7340032              15693   41         17960          43804</span></div><br /></div><div><br /></div><div><span style="text-decoration:underline">Distribution of IPC Message Sizes In The Current Windows Implementation</span></div><div><br /></div><div>The following histogram was added to IPC::Channel::Send(), and measures an hour long browsing session including Gmail, YouTube, Hulu, CNN and other random sites. We see that:</div><div><ul><li>90% of messages are less than 65 bytes</li><li>99.9% of messages are less than 2400 bytes</li></ul></div><div><span style="font-family:arial;font-size:13px"><div><span style="font-family:courier new,monospace">Histogram: IPC.MessageSize recorded 37573 samples, average = 86.4, standard deviation = 329.5</span></div><div><span style="font-family:courier new,monospace">     0 ... </span></div><div><span style="font-family:courier new,monospace">    12 ---------------------O                                                    (4387 = 11.7%) {0.0%}</span></div><div><span style="font-family:courier new,monospace">    16 ----O                                                                     (990 = 2.6%) {11.7%}</span></div><div><span style="font-family:courier new,monospace">    21 -----------------------------------O                                      (9307 = 24.8%) {14.3%}</span></div><div><span style="font-family:courier new,monospace">    28 O                                                                         (10 = 0.0%) {39.1%}</span></div><div><span style="font-family:courier new,monospace">    37 O                                                                         (8 = 0.0%) {39.1%}</span></div><div><span style="font-family:courier new,monospace">    49 ------------------------------------------------------------------------O (19123 = 50.9%) {39.1%}</span></div><div><span style="font-family:courier new,monospace">    65 --O                                                                       (614 = 1.6%) {90.0%}</span></div><div><span style="font-family:courier new,monospace">    86 O                                                                         (38 = 0.1%) {91.7%}</span></div><div><span style="font-family:courier new,monospace">   113 O                                                                         (113 = 0.3%) {91.8%}</span></div><div><span style="font-family:courier new,monospace">   149 O                                                                         (34 = 0.1%) {92.1%}</span></div><div><span style="font-family:courier new,monospace">   196 O                                                                         (110 = 0.3%) {92.2%}</span></div><div><span style="font-family:courier new,monospace">   258 --O                                                                       (663 = 1.8%) {92.4%}</span></div><div><span style="font-family:courier new,monospace">   340 ---O                                                                      (783 = 2.1%) {94.2%}</span></div><div><span style="font-family:courier new,monospace">   448 --O                                                                       (653 = 1.7%) {96.3%}</span></div><div><span style="font-family:courier new,monospace">   590 --O                                                                       (443 = 1.2%) {98.0%}</span></div><div><span style="font-family:courier new,monospace">   777 -O                                                                        (198 = 0.5%) {99.2%}</span></div><div><span style="font-family:courier new,monospace">  1023 O                                                                         (72 = 0.2%) {99.7%}</span></div><div><span style="font-family:courier new,monospace">  1347 O                                                                         (6 = 0.0%) {99.9%}</span></div><div><span style="font-family:courier new,monospace">  1774 O                                                                         (5 = 0.0%) {99.9%}</span></div><div><span style="font-family:courier new,monospace">  2336 O                                                                         (1 = 0.0%) {100.0%}</span></div><div><span style="font-family:courier new,monospace">  3077 ... </span></div><div><span style="font-family:courier new,monospace"> 12196 O                                                                         (15 = 0.0%) {100.0%}</span></div><div><span style="font-family:courier new,monospace"> 16063 ... </span></div></span></div><div><br /></div></div></div></div></td></tr></tbody></table>
</div> 
</div> 
<div id="sites-canvas-bottom-panel">
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_page-subpages"> </div>
<div id="sites-attachments-container">
</div>
<a xmlns="http://www.w3.org/1999/xhtml" name="page-comments"></a>
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_page-comments"><div class="sites-comment-docos-wrapper"><div class="sites-comment-docos"><div class="sites-comment-docos-background"></div><div class="sites-comment-docos-header"><div class="sites-comment-docos-header-title">Comments</div></div><div id="sites-comment-docos-pane" class="sites-comment-docos-pane"></div></div></div></div>
</div>
</div> 
</td> 
</tr>
</table> 
</div> 
</div> 
<div id="sites-chrome-footer-wrapper">
<div id="sites-chrome-footer-wrapper-inside">
<div id="sites-chrome-footer">
</div>
</div>
</div>
</div> 
</div> 
<div id="sites-chrome-adminfooter-container">
<div xmlns="http://www.w3.org/1999/xhtml" class="sites-adminfooter" role="navigation"><p><a class="sites-system-link" href="https://www.google.com/a/UniversalLogin?service=jotspot&amp;continue=https://sites.google.com/a/chromium.org/dev/developers/design-documents/os-x-interprocess-communication">Sign in</a><span aria-hidden="true">|</span><a class="sites-system-link" href="../../system/app/pages/recentChanges.html">Recent Site Activity</a><span aria-hidden="true">|</span><a class="sites-system-link" href="../../system/app/pages/reportAbuse.html" target="_blank">Report Abuse</a><span aria-hidden="true">|</span><a class="sites-system-link" href="javascript:;" onclick="window.open(webspace.printUrl)">Print Page</a><span aria-hidden="true">|</span><span class="sites-system-link">Powered By</span> <b class="powered-by"><a href="http://sites.google.com">Google Sites</a></b></p></div>
</div>
</div> 
</div> 
<div id="sites-chrome-onebar-footer">
</div>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
    window.jstiming.load.tick('sjl');
  </script>
<script xmlns="http://www.w3.org/1999/xhtml" src="https://ssl.gstatic.com/sites/p/56e332/system/js/jot_min_view__en.js"></script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
    window.jstiming.load.tick('jl');
  </script>
<script xmlns="http://www.w3.org/1999/xhtml">
      
          sites.core.Analytics.createTracker();
          sites.core.Analytics.trackPageview();
        
    </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
                    sites.Searchbox.initialize(
                        'sites-searchbox-search-button',
                        {"object":[]}['object'],
                        'search-site',
                        {"label":"Configure search options...","url":"/system/app/pages/admin/settings"});
                  </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
      gsites.HoverPopupMenu.createSiteDropdownMenus('sites-header-nav-dropdown', false);
    </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript" defer="true">
            JOT_setupNav("7648876402527094", "Navigation", false);
            JOT_addListener('titleChange', 'JOT_NAVIGATION_titleChange', 'COMP_7648876402527094');
          </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript" defer="true">
            JOT_setupNav("14720868319272995", "Quick links", false);
            JOT_addListener('titleChange', 'JOT_NAVIGATION_titleChange', 'COMP_14720868319272995');
          </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript" defer="true">
            JOT_setupNav("19690813310444355", "Other sites", false);
            JOT_addListener('titleChange', 'JOT_NAVIGATION_titleChange', 'COMP_19690813310444355');
          </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
              new sites.CommentPane('//docs.google.com/comments/d/AAHRpnXvrAwjAfmld0ObrebBiGRq9vCfxJLovdBMHSQsNNEnqCsHS4iut6KLIeYFN0vdFZ8yg7DFdwdDCDJ1Awnk39xJtiADc0qhMrsiVwSQC3dWDi_cCS5ihTzhPUKauDpeBKg-8NqTK/api/js?anon=true',
                  false, false);
            </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
  setTimeout(function() {
    var fingerprint = gsites.date.TimeZone.getFingerprint([]);
    gsites.Xhr.send('https://www.chromium.org/_/tz', null, null, 'GET', null, null, { afjstz: fingerprint });
  }, 500);
</script>
<script xmlns="http://www.w3.org/1999/xhtml">
                    window.onload = function() {
                      if (false) {
                        JOT_setMobilePreview();
                      }
                      var loadTimer = window.jstiming.load;
                      loadTimer.tick("ol");
                      loadTimer["name"] = "load," + webspace.page.type + ",user_page";
                      window.jstiming.report(loadTimer, {}, 'https://gg.google.com/csi');
                    }
                  </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
        JOT_insertAnalyticsCode(false,
            false);
      </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
    var maestroRunner = new gsites.pages.view.SitesMaestroRunner(
        webspace, "en");
    maestroRunner.initListeners();
    maestroRunner.installEditRender();
  </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript" defer="true">
  //<![CDATA[
    // Decorate any fastUI buttons on the page with a class of 'goog-button'.
    if (webspace.user.hasWriteAccess) {
      JOT_decorateButtons();
    }

    // Fires delayed events.
    (function() {
      JOT_fullyLoaded = true;
      var delayedEvents = JOT_delayedEvents;
      for (var x = 0; x < delayedEvents.length; x++) {
        var event = delayedEvents[x];
        JOT_postEvent(event.eventName, event.eventSrc, event.payload);
      }
      JOT_delayedEvents = null;
      JOT_postEvent('pageLoaded');
    })();
  //]]>
</script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
    JOT_postEvent('decorateGvizCharts');
  </script>
<script type="text/javascript">
          JOT_setupPostRenderingManager();
        </script>
<script type="text/javascript">
          JOT_postEvent('renderPlus', null, 'sites-chrome-main');
        </script>
<div id="server-timer-div" style="display:none"> </div>
<script type="text/javascript">
          window.jstiming.load.tick('render');
          JOT_postEvent('usercontentrendered', this);
        </script>
</body>
</html>
