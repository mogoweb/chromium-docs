<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/WebPage">
<head>
<meta http-equiv="X-UA-Compatible" content="chrome=1" />
<script type="text/javascript">/* Copyright 2008 Google. */ (function() { var e="wtsrt_",g="tbsd_",h="tbnd_",k="start",l="_wtsrt",m="_tbnd",n="CSI/";(function(){function f(a){this.t={};this.tick=function(a,c,b){this.t[a]=[void 0!=b?b:(new Date).getTime(),c];if(void 0==b)try{window.console.timeStamp(n+a)}catch(d){}};this.tick(k,null,a)}var a;window.performance&&(a=window.performance.timing);var p=a?new f(a.responseStart):new f;window.jstiming={Timer:f,load:p};if(a){var c=a.navigationStart,d=a.responseStart;0<c&&d>=c&&(window.jstiming.srt=d-c)}if(a){var b=window.jstiming.load;0<c&&d>=c&&(b.tick(l,void 0,c),b.tick(e,l,d),b.tick(g,e))}try{a=null,
window.chrome&&window.chrome.csi&&(a=Math.floor(window.chrome.csi().pageT),b&&0<c&&(b.tick(m,void 0,window.chrome.csi().startE),b.tick(h,m,c))),null==a&&window.gtbExternal&&(a=window.gtbExternal.pageT()),null==a&&window.external&&(a=window.external.pageT,b&&0<c&&(b.tick(m,void 0,window.external.startE),b.tick(h,m,c))),a&&(window.jstiming.pt=a)}catch(q){}})(); })()
</script>
<link rel="shortcut icon" href="../../_/rsrc/1354323194313/favicon.ico" type="image/x-icon" />
<link rel="apple-touch-icon" href="https://ssl.gstatic.com/sites/p/56e332/system/app/images/apple-touch-icon.png" type="image/png" />
<script type="text/javascript">/* Copyright 2008 Google. */ (function() { var d="",g="__duration__",h="function";function k(c){return document.getElementById(c)}window.byId=k;function l(c){return c.replace(/^\s+|\s+$/g,d)}window.trim=l;var m=[],n=0;window.JOT_addListener=function(c,a,b){var e=new String(n++);c={eventName:c,handler:a,compId:b,key:e};m.push(c);return e};window.JOT_removeListenerByKey=function(c){for(var a=0;a<m.length;a++)if(m[a].key==c){m.splice(a,1);break}};
window.JOT_removeAllListenersForName=function(c){for(var a=0;a<m.length;a++)m[a].eventName==c&&m.splice(a,1)};window.JOT_postEvent=function(c,a,b){var e={eventName:c,eventSrc:a||{},payload:b||{}};if(window.JOT_fullyLoaded)for(a=m.length,b=0;b<a&&b<m.length;b++){var f=m[b];f&&f.eventName==c&&(e.listenerCompId=f.compId||d,(f=typeof f.handler==h?f.handler:window[f.handler])&&f(e))}else window.JOT_delayedEvents.push({eventName:c,eventSrc:a,payload:b})};window.JOT_delayedEvents=[];
window.JOT_fullyLoaded=!1;window.JOT_formatRelativeToNow=function(c,a){var b=((new Date).getTime()-c)/6E4;if(1440<=b||0>b)return null;var e=0;60<=b&&(b/=60,e=2);2<=b&&e++;return a?window.JOT_siteRelTimeStrs[e].replace(g,Math.floor(b)):window.JOT_userRelTimeStrs[e].replace(g,Math.floor(b))}; })()
</script>
<script>

  

  var breadcrumbs = [{"path":"/developers","deleted":false,"title":"For Developers","dir":"ltr"},{"path":"/developers/design-documents","deleted":false,"title":"Design Documents","dir":"ltr"},{"path":"/developers/design-documents/rappor","deleted":false,"title":"Rappor (Randomized Aggregatable Privacy Preserving Ordinal Responses)","dir":"ltr"}];
  var JOT_clearDotPath = 'https://ssl.gstatic.com/sites/p/56e332/system/app/images/cleardot.gif';

  
  var JOT_userRelTimeStrs = ["a minute ago","__duration__ minutes ago","an hour ago","__duration__ hours ago"];

  
  

  

  var webspace = {"enableAnalytics":true,"pageSharingId":"jotspot_page","enableUniversalAnalytics":false,"sharingPolicy":"OPENED_WITH_INDICATOR","siteTitle":"The Chromium Projects","isStartPageEnabled":true,"adsensePublisherId":null,"features":{"languageSelectDefaultTextSetToDefault":true,"validateClientGvizDataSourceUrls":true,"moreMobileStyleImprovements":true,"newInsertMenuIcons":true,"accessibleSortingButtons":true,"domainAnalyticsInGAOnly":true,"noCaptcha":true,"fileCabinetScreenReaderFix":true,"updatedTosAndPrivacyLinks":null,"pageDrafts":false,"mobileOrientationFix":true,"plusBadge":false,"pdfEmbedSupport":false,"jsClickFix":true},"isPublic":true,"isConsumer":false,"serverFlags":{"cajaBaseUrl":"//www.gstatic.com/caja","cajaDebugMode":false},"onepickBaseUrl":"https://docs.google.com","domainAnalyticsAccountId":"","plusPageId":"","signInUrl":"https://www.google.com/a/SelectSession?continue\u003dhttps://sites.google.com/a/chromium.org/dev/developers/design-documents/rappor\u0026service\u003djotspot","analyticsAccountId":"UA-5484340-1","scottyUrl":"/_/upload","homePath":"/","siteNoticeUrlEnabled":null,"plusPageUrl":"","adsensePromoClickedOrSiteIneligible":true,"csiReportUri":"https://gg.google.com/csi","sharingId":"jotspot","termsUrl":"//www.google.com/intl/en/policies/terms/","gvizVersion":1,"editorResources":{"sitelayout":["https://ssl.gstatic.com/sites/p/56e332/system/app/css/sitelayouteditor.css"],"text":["https://ssl.gstatic.com/sites/p/56e332/system/js/codemirror.js","https://ssl.gstatic.com/sites/p/56e332/system/app/css/codemirror_css.css","https://ssl.gstatic.com/sites/p/56e332/system/js/trog_edit__en.js","https://ssl.gstatic.com/sites/p/56e332/system/app/css/trogedit.css","/_/rsrc/1441580320000/system/app/css/editor.css","https://ssl.gstatic.com/sites/p/56e332/system/app/css/codeeditor.css","/_/rsrc/1441580320000/system/app/css/camelot/editor-jfk-wlb.css"]},"sharingUrlPrefix":"/_/sharing","isAdsenseEnabled":true,"domain":"chromium.org","baseUri":"","name":"dev","siteTemplateId":false,"siteNoticeRevision":null,"siteNoticeUrlAddress":null,"siteNoticeMessage":null,"page":{"isRtlLocale":false,"canDeleteWebspace":null,"isPageDraft":null,"parentPath":"/developers/design-documents","parentWuid":"wuid:gx:359ef223e0fb14ac","siteLocale":"en","timeZone":"America/Los_Angeles","type":"text","title":"Rappor (Randomized Aggregatable Privacy Preserving Ordinal Responses)","locale":"en","wuid":"wuid:gx:3bb701505dbc9e","revision":26,"path":"/developers/design-documents/rappor","isSiteRtlLocale":false,"pageInheritsPermissions":null,"name":"rappor","canChangePath":true,"state":"","properties":{},"bidiEnabled":false,"currentTemplate":{"path":"/system/app/pagetemplates/text","title":"Web Page"}},"canPublishScriptToAnyone":true,"user":{"keyboardShortcuts":true,"sessionIndex":"","guest_":true,"displayNameOrEmail":"guest","userName":"guest","uid":"","renderMobile":false,"domain":"","namespace":"","hasWriteAccess":false,"namespaceUser":false,"primaryEmail":"guest","hasAdminAccess":false},"gadgets":{"baseUri":"/system/app/pages/gadgets"}};
  webspace.page.breadcrumbs = breadcrumbs;

  
  var JOT_siteRelTimeStrs = ["a minute ago","__duration__ minutes ago","an hour ago","__duration__ hours ago"];

</script>
<script type="text/javascript">
                window.jstiming.load.tick('scl');
              </script>
<meta name="title" content="Rappor (Randomized Aggregatable Privacy Preserving Ordinal Responses) - The Chromium Projects" />
<meta itemprop="name" content="Rappor (Randomized Aggregatable Privacy Preserving Ordinal Responses) - The Chromium Projects" />
<meta property="og:title" content="Rappor (Randomized Aggregatable Privacy Preserving Ordinal Responses) - The Chromium Projects" />
<meta name="description" content="Home of the Chromium Open Source Project" />
<meta itemprop="description" content="Home of the Chromium Open Source Project" />
<meta id="meta-tag-description" property="og:description" content="Home of the Chromium Open Source Project" />
<style type="text/css">
</style>
<link rel="stylesheet" type="text/css" href="https://ssl.gstatic.com/sites/p/56e332/system/app/themes/beigeandblue/standard-css-beigeandblue-ltr-ltr.css" />
<link rel="stylesheet" type="text/css" href="../../_/rsrc/1441580320000/system/app/css/overlay.css%3Fcb=beigeandblueundefineda100%2525%2525150goog-ws-leftthemedefaultstandard.css" />
<link rel="stylesheet" type="text/css" href="../../_/rsrc/1441580320000/system/app/css/camelot/allthemes-view.css" />
<!--[if IE]>
          <link rel="stylesheet" type="text/css" href="/system/app/css/camelot/allthemes%2die.css" />
        <![endif]-->
<title>Rappor (Randomized Aggregatable Privacy Preserving Ordinal Responses) - The Chromium Projects</title>
<meta itemprop="image" content="/_/rsrc/1438879449147/config/customLogo.gif?revision=3" />
<meta property="og:image" content="/_/rsrc/1438879449147/config/customLogo.gif?revision=3" />
<script type="text/javascript">
                window.jstiming.load.tick('cl');
              </script>
</head>
<body xmlns="http://www.google.com/ns/jotspot" id="body" class=" en            ">
<div id="sites-page-toolbar" class="sites-header-divider">
<div xmlns="http://www.w3.org/1999/xhtml" id="sites-status" class="sites-status" style="display:none;"><div id="sites-notice" class="sites-notice" role="status" aria-live="assertive"> </div></div>
</div>
<div id="sites-chrome-everything-scrollbar">
<div id="sites-chrome-everything" class="">
<div id="sites-chrome-page-wrapper" style="direction: ltr">
<div id="sites-chrome-page-wrapper-inside">
<div xmlns="http://www.w3.org/1999/xhtml" id="sites-chrome-header-wrapper" style="height:auto;">
<table id="sites-chrome-header" class="sites-layout-hbox" cellspacing="0" style="height:auto;">
<tr class="sites-header-primary-row" id="sites-chrome-userheader">
<td id="sites-header-title" class="" role="banner"><div class="sites-header-cell-buffer-wrapper"><a href="../../index.html" id="sites-chrome-userheader-logo"><img id="logo-img-id" src="../../_/rsrc/1438879449147/config/customLogo.gif%3Frevision=3" alt="The Chromium Projects" class="sites-logo  " /></a><h2><a href="../../index.html" dir="ltr" id="sites-chrome-userheader-title">The Chromium Projects</a></h2></div></td><td class="sites-layout-searchbox  "><div class="sites-header-cell-buffer-wrapper"><form id="sites-searchbox-form" action="https://www.chromium.org/system/app/pages/search" role="search"><input type="hidden" id="sites-searchbox-scope" name="scope" value="search-site" /><input type="text" id="jot-ui-searchInput" name="q" size="20" value="" aria-label="Search this site" /><div id="sites-searchbox-button-set" class="goog-inline-block"><div role="button" id="sites-searchbox-search-button" class="goog-inline-block jfk-button jfk-button-standard" tabindex="0">Search this site</div></div></form></div></td>
</tr>
<tr class="sites-header-secondary-row" id="sites-chrome-horizontal-nav">
<td colspan="2" id="sites-chrome-header-horizontal-nav-container" role="navigation">
</td>
</tr>
</table>
</div>
<div id="sites-chrome-main-wrapper">
<div id="sites-chrome-main-wrapper-inside">
<table id="sites-chrome-main" class="sites-layout-hbox" cellspacing="0" cellpadding="{scmCellpadding}" border="0">
<tr>
<td id="sites-chrome-sidebar-left" class="sites-layout-sidebar-left initial" style="width:150px">
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_7648876402527094" class="sites-embed" role="navigation"><div class="sites-embed-content sites-sidebar-nav"><ul role="navigation" jotId="navList"><li class="nav-first "><div dir="ltr" style="padding-left: 5px;"><a href="../../chromium-projects.html" jotId="wuid:gx:10ae433dadbbab13" class="sites-navigation-link">Home</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="../../Home.1.html" jotId="wuid:gx:43582b9d2029d3af" class="sites-navigation-link">Chromium</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="../../chromium-os.1.html" jotId="wuid:gx:83df2ab1f8880ba" class="sites-navigation-link">Chromium OS</a></div></li></ul></div></div>
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_14720868319272995" class="sites-embed" role="navigation"><h4 class="sites-embed-title">Quick links</h4><div class="sites-embed-content sites-sidebar-nav"><ul role="navigation" jotId="navList"><li class="nav-first "><div dir="ltr" style="padding-left: 5px;"><a href="../../for-testers/bug-reporting-guidelines.html" class="sites-navigation-link">Report bugs</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="../discussion-groups.html" class="sites-navigation-link">Discuss</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="../../system/app/pages/sitemap/hierarchy.html" jotId="wuid:gx:4b58a9a350ad12f" class="sites-navigation-link">网站地图</a></div></li></ul></div></div>
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_19690813310444355" class="sites-embed" role="navigation"><h4 class="sites-embed-title">Other sites</h4><div class="sites-embed-content sites-sidebar-nav"><ul role="navigation" jotId="navList"><li class="nav-first "><div dir="ltr" style="padding-left: 5px;"><a href="http://blog.chromium.org/" class="sites-navigation-link">Chromium Blog</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="http://code.google.com/chrome/extensions/" class="sites-navigation-link">Google Chrome Extensions</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="https://developers.google.com/chrome/chrome-frame/" class="sites-navigation-link">Google Chrome Frame</a></div></li></ul></div></div>
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_19695218559354544" class="sites-embed" role="complementary"><h4 class="sites-embed-title"></h4><div class="sites-embed-content sites-embed-content-sidebar-textbox"><div dir="ltr"><span style="font-size:x-small">Except as otherwise </span><a href="http://developers.google.com/site-policies.html#restrictions"><span style="font-size:x-small">noted</span></a><span style="font-size:x-small">, the content of this page is licensed under a </span><a href="http://creativecommons.org/licenses/by/2.5/"><span style="font-size:x-small">Creative Commons Attribution 2.5 license</span></a><span style="font-size:x-small">, and examples are licensed under the </span><a href="http://src.chromium.org/viewvc/chrome/trunk/src/LICENSE" target="_blank"><span style="font-size:x-small">BSD License</span></a><span style="font-size:x-small">.<br /></span></div></div></div>
</td>
<td id="sites-canvas-wrapper">
<div id="sites-canvas" role="main">
<div id="goog-ws-editor-toolbar-container"> </div>
<div xmlns="http://www.w3.org/1999/xhtml" id="title-crumbs" style="">
<A href="../../developers.1.html" dir="ltr">For Developers</A>‎ &gt; ‎<A href="../design-documents.1.html" dir="ltr">Design Documents</A>‎ &gt; ‎
  </div>
<h3 xmlns="http://www.w3.org/1999/xhtml" id="sites-page-title-header" style="" align="left">
<span id="sites-page-title" dir="ltr" tabindex="-1" style="outline: none">Rappor (Randomized Aggregatable Privacy Preserving Ordinal Responses)</span>
</h3>
<div id="sites-canvas-main" class="sites-canvas-main">
<div id="sites-canvas-main-content">
<table xmlns="http://www.w3.org/1999/xhtml" cellspacing="0" class="sites-layout-name-one-column sites-layout-hbox"><tbody><tr><td class="sites-layout-tile sites-tile-name-content-1"><div dir="ltr"><div><span style="background-color:transparent;font-size:10pt">RAPPOR reports consist of randomly generated data that is biased based on data collected from the user.  Data from many users can be aggregated to learn information about the population, but little or nothing can be concluded about individual users from their reports.</span></div><div><span style="background-color:transparent;font-size:10pt"><br /></span></div><div><span style="background-color:transparent;font-size:10pt">Descriptions of individual metrics should be found in <a href="https://chromium.googlesource.com/chromium/src/+/master/tools/metrics/rappor/rappor.xml">tools/metrics/rappor/rappor.xml</a></span></div><div><br /></div><div>For full technical details of the algorithm, see <a href="http://static.googleusercontent.com/media/research.google.com/en/us/pubs/archive/42852.pdf">the RAPPOR paper</a>.</div><div><h2><a name="TOC-Algorithm"></a><span>Algorithm</span></h2><div>The first time the RapporService is started, a client will generate and save a random 128-byte secret key, which won't change and is never transmitted to the server.  It will also assign itself to a random cohort.</div><div><br /></div><div>For each metric we collect, we store a <a href="http://en.wikipedia.org/wiki/Bloom_filter">Bloom filter</a>, represented as an array of m bits.  Each cohort uses a different set of hash functions for the bloom filter. <span style="background-color:transparent;font-size:10pt">When the RapporService is passed a sample for recording, it sets bits in the Bloom filter for that metric.  For example, with the "Settings.HomePage2" metric, which is collected only for users who opt-in to UMA, our Bloom filter will be an array of 128 bits, and one or two of those bits will be set based on the eTLD+1 of the user's homepage.</span></div><div><br /></div><div>Once we have collected samples, and are ready to generate a report, we take the array of bits we've gathered for the metric and introduce two levels of noise by taking the following steps.</div><div><ol><li><span style="background-color:transparent;font-size:10pt">Add deterministic noise.</span></li><ol><li><span style="background-color:transparent;font-size:10pt">Create a deterministic psuedo-random function by passing the client's secret key, the metric name, and the bloom filter value into an HMAC_DRBG </span><span style="background-color:transparent;font-size:10pt">function.</span></li><li><span style="background-color:transparent;font-size:10pt">For each bit use this deterministic function to flip two weighted coins.</span></li><ol><li><span style="background-color:transparent;font-size:10pt">If the first is heads, replace the bit with the result of the second coin.</span></li><li><span style="background-color:transparent;font-size:10pt">Otherwise, leave the bit as is.</span></li></ol></ol><li>Add fresh random noise.</li><ol><li><span style="background-color:transparent;font-size:10pt">Using fresh randomness, flip two more coins, with different weights.</span></li><ol><li><span style="background-color:transparent;font-size:10pt">If the bit is true, report the result of the first coin flip.</span></li><li><span style="background-color:transparent;font-size:10pt">Otherwise, report the result of the second.</span></li></ol></ol></ol></div></div><div>The cohort that the client that belongs to and the results from the above process are sent to the server.</div><div><br /></div><div>The large amount of randomness means that we can't draw meaningful conclusions from a small number of reports.  Even if we aggregate many reports from the same user, they include the same pseudo-random noise in all of their reports of the same value, so we are effectively limited to one report for each distinct value.</div><div><br /></div><div><span style="color:rgb(38,38,38);font-family:arial,sans-serif;font-size:13px;line-height:16px">Indeed, even with infinite amounts of data on a RAPPOR statistic, there are strict bounds on how much information can be learned, as outlined in more detail at </span><span style="background-color:transparent"><font color="#262626" face="arial, sans-serif"><span style="line-height:16px"><a href="http://arxiv.org/abs/1407.6981">http://arxiv.org/abs/1407.6981</a>.  In particular, the data collected from any given user or client contains such significant uncertainty, and guarantees such strong deniability, as to prevent observers from drawing conclusions with any certainty.</span></font></span></div><div style="font-size:13.3333330154419px"><span style="font-size:13.3333330154419px;background-color:transparent"><font color="#262626" face="arial, sans-serif"><span style="line-height:16px"><br /></span></font></span><span style="white-space:pre-wrap;line-height:1.15;background-color:transparent"><font face="arial, sans-serif" size="4"><b>Adding metrics</b></font></span></div><div style="font-size:13.3333330154419px"><br /></div><div style="font-size:13.3333330154419px">To add a new rappor metric, you need to add a bit of code to collect your sample, and add your metric to <a href="https://chromium.googlesource.com/chromium/src/+/master/tools/metrics/rappor/rappor.xml" style="font-size:13.3333330154419px;background-color:transparent">tools/metrics/rappor/rappor.xml</a>.  <span style="font-size:13.3333330154419px;background-color:transparent"> </span><span style="font-size:13.3333330154419px;background-color:transparent"> Samples should be recorded on the UI thread of the browser process.  </span><span style="font-size:13.3333330154419px;background-color:transparent">For most use cases, you will want to use one of the helper methods in </span><a href="https://chromium.googlesource.com/chromium/src/+/master/components/rappor/rappor_utils.h" style="font-size:13.3333330154419px;background-color:transparent">components/rappor/rappor_utils.h</a> (formerly <a href="https://chromium.googlesource.com/chromium/src/+/master/chrome/browser/metrics/rappor/sampling.h" style="font-size:13.3333330154419px;background-color:transparent">chrome/browser/metrics/rappor/sampling.h</a>)<span style="font-size:13.3333330154419px;background-color:transparent"> e.g.</span></div><div style="font-size:13.3333330154419px"><font style="font-size:13.3333330154419px"><br /></font><div class="sites-codeblock sites-codesnippet-block"><p dir="ltr" style="font-size:13.3333330154419px;line-height:1.15;margin-top:0pt;margin-bottom:0pt"><span style="font-family:Courier New;vertical-align:baseline;white-space:pre-wrap;background-color:transparent"><font size="2"><code>#include "components/rappor/rappor_utils.h"</code></font></span></p><p dir="ltr" style="font-size:13.3333330154419px;line-height:1.15;margin-top:0pt;margin-bottom:0pt"><span style="font-family:Courier New;vertical-align:baseline;white-space:pre-wrap;background-color:transparent"><font size="2"><code><br /></code></font></span></p><p style="margin-top:0pt;margin-bottom:0pt"><span style="font-size:13.3333330154419px;line-height:1.15;font-family:Courier New;vertical-align:baseline;white-space:pre-wrap;background-color:transparent"><font size="2"><code>rappor::</code></font></span><font color="#006000" face="monospace" size="2"><span style="line-height:13.8000001907349px;white-space:pre-wrap">SampleDomainAndRegistryFromGURL(g_browser_process-&gt;rappor_service(),</span></font></p><p style="margin-top:0pt;margin-bottom:0pt"><font color="#006000" face="monospace" size="2"><span style="line-height:13.8000001907349px;white-space:pre-wrap"><span>    <span>    <span>    <span>    <span>    <span>    <span>    <span>    <span>    <span>    </span></span></span></span></span></span></span></span></span></span>"Settings.HomePage2", GURL(homepage_url));</span></font></p></div></div><div style="font-size:13.3333330154419px"><br /></div><div style="font-size:13.3333330154419px"><span style="font-size:13.3333330154419px;background-color:transparent">If you need to do something more specific you may need to call RapporService::RecordSample directly, e.g.</span></div><div style="font-size:13.3333330154419px"><font size="2"><br /></font><div class="sites-codeblock sites-codesnippet-block" style="font-size:13.3333330154419px"><p dir="ltr" style="line-height:1.15;margin-top:0pt;margin-bottom:0pt"><span style="font-family:Courier New;vertical-align:baseline;white-space:pre-wrap;background-color:transparent"><font size="2"><code>#include "components/rappor/rappor_service.h"</code></font></span></p><font size="2"><br /></font><table cellpadding="0" cellspacing="0" style="font-family:Arial,Helvetica,sans-serif;font-size:13px;line-height:normal;padding:5px"><tbody><tr><td style="white-space:pre;font-family:monospace;font-size:12px;color:blue"><code>g_browser_process-&gt;rappor_service()-&gt;RecordSample(
</code></td></tr><tr style="background-color:rgb(229,236,249)"><td></td></tr><tr><td style="white-space:pre;font-family:monospace;font-size:12px;color:blue"><code>    "MyCustomMetric",
</code></td></tr><tr style="background-color:rgb(229,236,249)"><td></td></tr><tr><td style="white-space:pre;font-family:monospace;font-size:12px;color:blue"><code>    rappor::ETLD_PLUS_ONE_RAPPOR_TYPE,
</code></td></tr><tr style="background-color:rgb(229,236,249)"><td></td></tr><tr><td style="white-space:pre;font-family:monospace;font-size:12px;color:blue"><code>    my_custom_metric_sample);</code></td></tr><tr><td style="white-space:pre;font-family:monospace;font-size:12px;color:blue"><code>);</code></td></tr></tbody></table></div></div><div style="font-size:13.3333330154419px"><br /></div><div style="font-size:13.3333330154419px">If you collect multiple samples for the same metric in one reporting interval (currently 30 minutes), a single sample will be randomly selected for generating the randomized report.</div><div style="font-size:13.3333330154419px"><br /></div><div style="font-size:13.3333330154419px">Remember to add documentation for your metric to <a href="https://chromium.googlesource.com/chromium/src/+/master/tools/metrics/rappor/rappor.xml" style="font-size:13.3333330154419px;background-color:transparent">tools/metrics/rappor/rappor.xml</a></div><div style="font-size:13.3333330154419px"><br /></div><div style="font-size:13.3333330154419px"><div style="font-size:13.3333330154419px"><div class="sites-codeblock sites-codesnippet-block" style="font-size:13.3333330154419px"><table cellpadding="0" cellspacing="0" style="font-family:Arial,Helvetica,sans-serif;font-size:13px;line-height:normal;padding:5px"><tbody><tr><td><font color="#006000" face="monospace"><span style="font-size:12px;white-space:pre">&lt;rappor-metric name="Settings.HomePage2" type="ETLD_PLUS_ONE"&gt;
  &lt;owner&gt;holte@chromium.org&lt;/owner&gt;
  &lt;summary&gt;
    The eTLD+1 of the prefs::kHomePage setting.  Recorded when a profile is
    loaded if the URL is valid and prefs::kHomePageIsNewTabPage is false.
  &lt;/summary&gt;
&lt;/rappor-metric&gt;</span></font></td></tr></tbody></table></div></div></div><div><br /></div><div><span><h2 dir="ltr" style="line-height:1.15;margin-top:10pt;margin-bottom:0pt"><a name="TOC-Code-overview"></a><span style="font-size:17px;font-family:Trebuchet MS;background-color:transparent;vertical-align:baseline;white-space:pre-wrap">Code overview</span></h2><br /><p dir="ltr" style="line-height:1.15;margin-top:0pt;margin-bottom:0pt"><font size="2"><span style="font-family:Arial;background-color:transparent;vertical-align:baseline;white-space:pre-wrap"><a href="https://codereview.chromium.org/49753002">CL/49753002</a> introduces a </span><span style="font-family:Courier New;background-color:transparent;vertical-align:baseline;white-space:pre-wrap"><code>RapporService</code></span><span style="font-family:Arial;background-color:transparent;vertical-align:baseline;white-space:pre-wrap"> object which is instantiated by the browser process object.  The service allows collection of RAPPOR metrics and periodically uploads reports to our servers.</span></font></p><h3 dir="ltr" style="line-height:1.15;margin-top:8pt;margin-bottom:0pt"><a name="TOC-Sample-Collection"></a><span style="font-family:Trebuchet MS;color:rgb(102,102,102);background-color:transparent;vertical-align:baseline;white-space:pre-wrap"><font size="2">Sample Collection</font></span></h3><div><br /></div><p dir="ltr" style="line-height:1.15;margin-top:0pt;margin-bottom:0pt"><span style="font-family:Arial;background-color:transparent;vertical-align:baseline;white-space:pre-wrap"><font size="2">In order to collect samples, we call <code>RapporService::RecordSample</code> to record samples of it.  </font></span><span style="line-height:1.15;font-size:10pt;font-family:Arial;vertical-align:baseline;white-space:pre-wrap;background-color:transparent"><font size="2">The first call to <code>RecordSample</code> after the browser starts or a report is generated will instantiate a new <code>RapporMetric</code> object to hold the data for that metric.  If subsequent calls to <code>RecordSample</code> are made for the same metric during the same reporting interval, one sample is randomly selected for generating the report. Calls to</font></span><span style="font-family:Arial;font-size:small;line-height:14.9499998092651px;white-space:pre-wrap;background-color:transparent"> </span><code style="font-size:10pt;line-height:normal;white-space:pre-wrap;background-color:transparent">RecordSample</code><span style="font-family:Arial;font-size:small;line-height:14.9499998092651px;white-space:pre-wrap;background-color:transparent"> should take place on the browser UI thread.</span></p></span><span><font size="2"><br /></font><p dir="ltr" style="line-height:1.15;margin-top:0pt;margin-bottom:0pt"><font size="2"><span style="font-family:Arial;background-color:transparent;vertical-align:baseline;white-space:pre-wrap">Currently, samples may only be collected in the browser process, but </span><span style="font-family:Courier New;background-color:transparent;vertical-align:baseline;white-space:pre-wrap"><code>RapporMetric</code></span><span style="font-family:Arial;background-color:transparent;vertical-align:baseline;white-space:pre-wrap">s could be serialized to IPC calls to enable collection from other processes.</span></font></p><h4 style="line-height:1.15;margin-top:8pt;margin-bottom:0pt"><a name="TOC-Report-generation-and-uploading"></a><span style="font-family:Trebuchet MS;color:rgb(102,102,102);background-color:transparent;vertical-align:baseline;white-space:pre-wrap"><font size="2">Report generation and uploading</font></span></h4><font size="2"><br /></font><p dir="ltr" style="margin-top:0pt;margin-bottom:0pt"><font size="2" style="line-height:1.15"><span style="font-family:Arial;background-color:transparent;vertical-align:baseline;white-space:pre-wrap">The other function of </span><span style="font-family:Courier New;background-color:transparent;vertical-align:baseline;white-space:pre-wrap"><code>RapporService</code> </span><span style="font-family:Arial;background-color:transparent;vertical-align:baseline;white-space:pre-wrap">is generating and uploading reports of the collected data</span><span style="font-family:Courier New;background-color:transparent;vertical-align:baseline;white-space:pre-wrap">. </span><span style="font-family:Arial;background-color:transparent;vertical-align:baseline;white-space:pre-wrap">First <code>RapporService::RegisterPrefs()</code> should be called to register</span><span style="font-family:Arial;vertical-align:baseline;white-space:pre-wrap"> </span><span style="font-family:Courier New;background-color:transparent;vertical-align:baseline;white-space:pre-wrap"><code>prefs::kRapporSecret</code></span></font> and <font size="2" style="line-height:1.15"><span style="font-family:Courier New;background-color:transparent;vertical-align:baseline;white-space:pre-wrap"><code>prefs::kRapporCohort</code></span><span style="font-family:Arial;background-color:transparent;vertical-align:baseline;white-space:pre-wrap">, and then <code>RapporService::Start()</code> may be called</span><span style="font-family:Arial;vertical-align:baseline;white-space:pre-wrap"> to begin generating reports.</span></font></p><font size="2"><br /></font><p dir="ltr" style="margin-top:0pt;margin-bottom:0pt"><font size="2" style="line-height:1.15"><span style="font-family:Arial;vertical-align:baseline;white-space:pre-wrap">The </span><span style="font-family:Courier New;background-color:transparent;vertical-align:baseline;white-space:pre-wrap"><code>RapporService</code></span><span style="font-family:Arial;vertical-align:baseline;white-space:pre-wrap"> generates a report shortly after it is started at fixed time intervals afterwards.  If any new </span><span style="font-family:Courier New;background-color:transparent;vertical-align:baseline;white-space:pre-wrap"><code>RapporMetrics</code></span><span style="font-family:Arial;background-color:transparent;vertical-align:baseline;white-space:pre-wrap">s </span><span style="font-family:Arial;vertical-align:baseline;white-space:pre-wrap"> have been created</span><span style="font-family:Arial;background-color:transparent;vertical-align:baseline;white-space:pre-wrap">, randomized data is generated for them by calling </span><span style="font-family:Courier New;background-color:transparent;vertical-align:baseline;white-space:pre-wrap"><code>RapporMetric</code></span><span style="font-family:Arial;background-color:transparent;vertical-align:baseline;white-space:pre-wrap"><code>::GetReport()</code> and recorded into a <code>RapporReports</code></span></font> proto<font size="2" style="line-height:1.15"><span style="font-family:Arial;background-color:transparent;vertical-align:baseline;white-space:pre-wrap">, and the </span><span style="font-family:Courier New;background-color:transparent;vertical-align:baseline;white-space:pre-wrap"><code>RapporMetric</code></span><span style="font-family:Arial;background-color:transparent;vertical-align:baseline;white-space:pre-wrap"> is deleted.</span></font></p><font size="2"><br /></font><div class="sites-codeblock sites-codesnippet-block"><table cellpadding="0" cellspacing="0" style="font-family:Arial,Helvetica,sans-serif;font-size:13px;line-height:normal;padding:5px"><tbody><tr><td style="white-space:pre;font-family:monospace;font-size:12px;color:blue"><code>message RapporReports {</code></td></tr><tr style="background-color:rgb(229,236,249)"><td></td></tr><tr><td style="white-space:pre;font-family:monospace;font-size:12px;color:blue"></td></tr><tr><td style="white-space:pre;font-family:monospace;font-size:12px;color:blue"><code>  // Which cohort these reports belong to.  The RAPPOR participants are
</code></td></tr><tr style="background-color:rgb(229,236,249)"><td></td></tr><tr><td style="white-space:pre;font-family:monospace;font-size:12px;color:blue"><code>  // partioned into cohorts in different ways, to allow better statistics and
</code></td></tr><tr style="background-color:rgb(229,236,249)"><td></td></tr><tr><td style="white-space:pre;font-family:monospace;font-size:12px;color:blue"><code>  // increased coverage.  In particular, the cohort will serve to choose the
</code></td></tr><tr style="background-color:rgb(229,236,249)"><td></td></tr><tr><td style="white-space:pre;font-family:monospace;font-size:12px;color:blue"><code>  // hash functions used for Bloom-filter-based reports.
</code></td></tr><tr style="background-color:rgb(229,236,249)"><td></td></tr><tr><td style="white-space:pre;font-family:monospace;font-size:12px;color:blue"><code>  optional int32 cohort = 2;
</code></td></tr><tr style="background-color:rgb(229,236,249)"><td></td></tr><tr><td style="white-space:pre;font-family:monospace;font-size:12px;color:blue">
</td></tr><tr style="background-color:rgb(229,236,249)"><td></td></tr><tr><td style="white-space:pre;font-family:monospace;font-size:12px;color:blue"><code>  message Report {
</code></td></tr><tr style="background-color:rgb(229,236,249)"><td></td></tr><tr><td style="white-space:pre;font-family:monospace;font-size:12px;color:blue"><code>    // The name of the metric, hashed.
</code></td></tr><tr style="background-color:rgb(229,236,249)"><td></td></tr><tr><td style="white-space:pre;font-family:monospace;font-size:12px;color:blue"><code>    optional fixed64 name_hash = 1;
</code></td></tr><tr style="background-color:rgb(229,236,249)"><td></td></tr><tr><td style="white-space:pre;font-family:monospace;font-size:12px;color:blue">
</td></tr><tr style="background-color:rgb(229,236,249)"><td></td></tr><tr><td style="white-space:pre;font-family:monospace;font-size:12px;color:blue"><code>    // The sequence of bits produced by random coin flips in
</code></td></tr><tr style="background-color:rgb(229,236,249)"><td></td></tr><tr><td style="white-space:pre;font-family:monospace;font-size:12px;color:blue"><code>    // RapporMetric::GetReport().  For a complete description of RAPPOR
</code></td></tr><tr style="background-color:rgb(229,236,249)"><td></td></tr><tr><td style="white-space:pre;font-family:monospace;font-size:12px;color:blue"><code>    // metrics, refer to the design document at:
</code></td></tr><tr style="background-color:rgb(229,236,249)"><td></td></tr><tr><td style="white-space:pre;font-family:monospace;font-size:12px;color:blue"><code>    // http://www.chromium.org/developers/design-documents/rappor
</code></td></tr><tr style="background-color:rgb(229,236,249)"><td></td></tr><tr><td style="white-space:pre;font-family:monospace;font-size:12px;color:blue"><code>    optional bytes bits = 2;
</code></td></tr><tr style="background-color:rgb(229,236,249)"><td></td></tr><tr><td style="white-space:pre;font-family:monospace;font-size:12px;color:blue"><code>  }
</code></td></tr><tr style="background-color:rgb(229,236,249)"><td></td></tr><tr><td style="white-space:pre;font-family:monospace;font-size:12px;color:blue"><code>  repeated Report report = 3;
</code></td></tr><tr style="background-color:rgb(229,236,249)"><td></td></tr><tr><td style="white-space:pre;font-family:monospace;font-size:12px;color:blue"><code>}</code></td></tr></tbody></table></div><font size="2"><br /><span style="font-family:Arial;background-color:transparent;vertical-align:baseline;white-space:pre-wrap">The proto is passed to the </span><span style="font-family:Courier New;background-color:transparent;vertical-align:baseline;white-space:pre-wrap"><code>LogUploader</code></span><span style="font-family:Arial;background-color:transparent;vertical-align:baseline;white-space:pre-wrap">.  It stores all of the logs it is passed in a queue, and sends them to the server.  When uploads fail, it retries with exponential backoff.  For now, if chrome exits before the logs are uploaded, they are lost.  We may implement caching unsent logs in prefs similar to UMA in the future.</span></font></span></div></div></td></tr></tbody></table>
</div> 
</div> 
<div id="sites-canvas-bottom-panel">
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_page-subpages"> </div>
<div id="sites-attachments-container">
</div>
<a xmlns="http://www.w3.org/1999/xhtml" name="page-comments"></a>
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_page-comments"><div class="sites-comment-docos-wrapper"><div class="sites-comment-docos"><div class="sites-comment-docos-background"></div><div class="sites-comment-docos-header"><div class="sites-comment-docos-header-title">Comments</div></div><div id="sites-comment-docos-pane" class="sites-comment-docos-pane"></div></div></div></div>
</div>
</div> 
</td> 
</tr>
</table> 
</div> 
</div> 
<div id="sites-chrome-footer-wrapper">
<div id="sites-chrome-footer-wrapper-inside">
<div id="sites-chrome-footer">
</div>
</div>
</div>
</div> 
</div> 
<div id="sites-chrome-adminfooter-container">
<div xmlns="http://www.w3.org/1999/xhtml" class="sites-adminfooter" role="navigation"><p><a class="sites-system-link" href="https://www.google.com/a/UniversalLogin?service=jotspot&amp;continue=https://sites.google.com/a/chromium.org/dev/developers/design-documents/rappor">Sign in</a><span aria-hidden="true">|</span><a class="sites-system-link" href="../../system/app/pages/recentChanges.html">Recent Site Activity</a><span aria-hidden="true">|</span><a class="sites-system-link" href="../../system/app/pages/reportAbuse.html" target="_blank">Report Abuse</a><span aria-hidden="true">|</span><a class="sites-system-link" href="javascript:;" onclick="window.open(webspace.printUrl)">Print Page</a><span aria-hidden="true">|</span><span class="sites-system-link">Powered By</span> <b class="powered-by"><a href="http://sites.google.com">Google Sites</a></b></p></div>
</div>
</div> 
</div> 
<div id="sites-chrome-onebar-footer">
</div>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
    window.jstiming.load.tick('sjl');
  </script>
<script xmlns="http://www.w3.org/1999/xhtml" src="https://ssl.gstatic.com/sites/p/56e332/system/js/jot_min_view__en.js"></script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
    window.jstiming.load.tick('jl');
  </script>
<script xmlns="http://www.w3.org/1999/xhtml">
      
          sites.core.Analytics.createTracker();
          sites.core.Analytics.trackPageview();
        
    </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
                    sites.Searchbox.initialize(
                        'sites-searchbox-search-button',
                        {"object":[]}['object'],
                        'search-site',
                        {"label":"Configure search options...","url":"/system/app/pages/admin/settings"});
                  </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
      gsites.HoverPopupMenu.createSiteDropdownMenus('sites-header-nav-dropdown', false);
    </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript" defer="true">
            JOT_setupNav("7648876402527094", "Navigation", false);
            JOT_addListener('titleChange', 'JOT_NAVIGATION_titleChange', 'COMP_7648876402527094');
          </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript" defer="true">
            JOT_setupNav("14720868319272995", "Quick links", false);
            JOT_addListener('titleChange', 'JOT_NAVIGATION_titleChange', 'COMP_14720868319272995');
          </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript" defer="true">
            JOT_setupNav("19690813310444355", "Other sites", false);
            JOT_addListener('titleChange', 'JOT_NAVIGATION_titleChange', 'COMP_19690813310444355');
          </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
              new sites.CommentPane('//docs.google.com/comments/d/AAHRpnXtfSHKvVcqk9cQ5j7RW4S-CyAev1GniT4u-j4iRQAEI09tScg2RvCiwx75T40kG0ewS_aoVID5v-hZRvjEykM_XcAkfUY8wZ8uGSgN2E02cNVYd9wZY8n0CyvN3Sj_NCueff_oy/api/js?anon=true',
                  false, false);
            </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
  setTimeout(function() {
    var fingerprint = gsites.date.TimeZone.getFingerprint([]);
    gsites.Xhr.send('https://www.chromium.org/_/tz', null, null, 'GET', null, null, { afjstz: fingerprint });
  }, 500);
</script>
<script xmlns="http://www.w3.org/1999/xhtml">
                    window.onload = function() {
                      if (false) {
                        JOT_setMobilePreview();
                      }
                      var loadTimer = window.jstiming.load;
                      loadTimer.tick("ol");
                      loadTimer["name"] = "load," + webspace.page.type + ",user_page";
                      window.jstiming.report(loadTimer, {}, 'https://gg.google.com/csi');
                    }
                  </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
        JOT_insertAnalyticsCode(false,
            false);
      </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
    var maestroRunner = new gsites.pages.view.SitesMaestroRunner(
        webspace, "en");
    maestroRunner.initListeners();
    maestroRunner.installEditRender();
  </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript" defer="true">
  //<![CDATA[
    // Decorate any fastUI buttons on the page with a class of 'goog-button'.
    if (webspace.user.hasWriteAccess) {
      JOT_decorateButtons();
    }

    // Fires delayed events.
    (function() {
      JOT_fullyLoaded = true;
      var delayedEvents = JOT_delayedEvents;
      for (var x = 0; x < delayedEvents.length; x++) {
        var event = delayedEvents[x];
        JOT_postEvent(event.eventName, event.eventSrc, event.payload);
      }
      JOT_delayedEvents = null;
      JOT_postEvent('pageLoaded');
    })();
  //]]>
</script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
    JOT_postEvent('decorateGvizCharts');
  </script>
<script type="text/javascript">
          JOT_setupPostRenderingManager();
        </script>
<script type="text/javascript">
          JOT_postEvent('renderPlus', null, 'sites-chrome-main');
        </script>
<div id="server-timer-div" style="display:none"> </div>
<script type="text/javascript">
          window.jstiming.load.tick('render');
          JOT_postEvent('usercontentrendered', this);
        </script>
</body>
</html>
