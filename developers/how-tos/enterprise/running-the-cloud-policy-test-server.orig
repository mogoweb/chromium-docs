<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/WebPage">
<head>
<meta http-equiv="X-UA-Compatible" content="chrome=1" />
<script type="text/javascript">/* Copyright 2008 Google. */ (function() { var e="wtsrt_",g="tbsd_",h="tbnd_",k="start",l="_wtsrt",m="_tbnd",n="CSI/";(function(){function f(a){this.t={};this.tick=function(a,c,b){this.t[a]=[void 0!=b?b:(new Date).getTime(),c];if(void 0==b)try{window.console.timeStamp(n+a)}catch(d){}};this.tick(k,null,a)}var a;window.performance&&(a=window.performance.timing);var p=a?new f(a.responseStart):new f;window.jstiming={Timer:f,load:p};if(a){var c=a.navigationStart,d=a.responseStart;0<c&&d>=c&&(window.jstiming.srt=d-c)}if(a){var b=window.jstiming.load;0<c&&d>=c&&(b.tick(l,void 0,c),b.tick(e,l,d),b.tick(g,e))}try{a=null,
window.chrome&&window.chrome.csi&&(a=Math.floor(window.chrome.csi().pageT),b&&0<c&&(b.tick(m,void 0,window.chrome.csi().startE),b.tick(h,m,c))),null==a&&window.gtbExternal&&(a=window.gtbExternal.pageT()),null==a&&window.external&&(a=window.external.pageT,b&&0<c&&(b.tick(m,void 0,window.external.startE),b.tick(h,m,c))),a&&(window.jstiming.pt=a)}catch(q){}})(); })()
</script>
<link rel="shortcut icon" href="/_/rsrc/1354323194313/favicon.ico" type="image/x-icon" />
<link rel="apple-touch-icon" href="https://ssl.gstatic.com/sites/p/56e332/system/app/images/apple-touch-icon.png" type="image/png" />
<script type="text/javascript">/* Copyright 2008 Google. */ (function() { var d="",g="__duration__",h="function";function k(c){return document.getElementById(c)}window.byId=k;function l(c){return c.replace(/^\s+|\s+$/g,d)}window.trim=l;var m=[],n=0;window.JOT_addListener=function(c,a,b){var e=new String(n++);c={eventName:c,handler:a,compId:b,key:e};m.push(c);return e};window.JOT_removeListenerByKey=function(c){for(var a=0;a<m.length;a++)if(m[a].key==c){m.splice(a,1);break}};
window.JOT_removeAllListenersForName=function(c){for(var a=0;a<m.length;a++)m[a].eventName==c&&m.splice(a,1)};window.JOT_postEvent=function(c,a,b){var e={eventName:c,eventSrc:a||{},payload:b||{}};if(window.JOT_fullyLoaded)for(a=m.length,b=0;b<a&&b<m.length;b++){var f=m[b];f&&f.eventName==c&&(e.listenerCompId=f.compId||d,(f=typeof f.handler==h?f.handler:window[f.handler])&&f(e))}else window.JOT_delayedEvents.push({eventName:c,eventSrc:a,payload:b})};window.JOT_delayedEvents=[];
window.JOT_fullyLoaded=!1;window.JOT_formatRelativeToNow=function(c,a){var b=((new Date).getTime()-c)/6E4;if(1440<=b||0>b)return null;var e=0;60<=b&&(b/=60,e=2);2<=b&&e++;return a?window.JOT_siteRelTimeStrs[e].replace(g,Math.floor(b)):window.JOT_userRelTimeStrs[e].replace(g,Math.floor(b))}; })()
</script>
<script>

  

  var breadcrumbs = [{"path":"/developers","deleted":false,"title":"For Developers","dir":"ltr"},{"path":"/developers/how-tos","deleted":false,"title":"How-Tos","dir":"ltr"},{"path":"/developers/how-tos/enterprise","deleted":false,"title":"Enterprise","dir":"ltr"},{"path":"/developers/how-tos/enterprise/running-the-cloud-policy-test-server","deleted":false,"title":"Running the cloud policy test server","dir":"ltr"}];
  var JOT_clearDotPath = 'https://ssl.gstatic.com/sites/p/56e332/system/app/images/cleardot.gif';

  
  var JOT_userRelTimeStrs = ["a minute ago","__duration__ minutes ago","an hour ago","__duration__ hours ago"];

  
  

  

  var webspace = {"enableAnalytics":true,"pageSharingId":"jotspot_page","enableUniversalAnalytics":false,"sharingPolicy":"OPENED_WITH_INDICATOR","siteTitle":"The Chromium Projects","isStartPageEnabled":true,"adsensePublisherId":null,"features":{"languageSelectDefaultTextSetToDefault":true,"validateClientGvizDataSourceUrls":true,"moreMobileStyleImprovements":true,"newInsertMenuIcons":true,"accessibleSortingButtons":true,"domainAnalyticsInGAOnly":true,"noCaptcha":true,"fileCabinetScreenReaderFix":true,"updatedTosAndPrivacyLinks":null,"pageDrafts":false,"mobileOrientationFix":true,"plusBadge":false,"pdfEmbedSupport":false,"jsClickFix":true},"isPublic":true,"isConsumer":false,"serverFlags":{"cajaBaseUrl":"//www.gstatic.com/caja","cajaDebugMode":false},"onepickBaseUrl":"https://docs.google.com","domainAnalyticsAccountId":"","plusPageId":"","signInUrl":"https://www.google.com/a/SelectSession?continue\u003dhttps://sites.google.com/a/chromium.org/dev/developers/how-tos/enterprise/running-the-cloud-policy-test-server\u0026service\u003djotspot","analyticsAccountId":"UA-5484340-1","scottyUrl":"/_/upload","homePath":"/","siteNoticeUrlEnabled":null,"plusPageUrl":"","adsensePromoClickedOrSiteIneligible":true,"csiReportUri":"https://gg.google.com/csi","sharingId":"jotspot","termsUrl":"//www.google.com/intl/en/policies/terms/","gvizVersion":1,"editorResources":{"sitelayout":["https://ssl.gstatic.com/sites/p/56e332/system/app/css/sitelayouteditor.css"],"text":["https://ssl.gstatic.com/sites/p/56e332/system/js/codemirror.js","https://ssl.gstatic.com/sites/p/56e332/system/app/css/codemirror_css.css","https://ssl.gstatic.com/sites/p/56e332/system/js/trog_edit__en.js","https://ssl.gstatic.com/sites/p/56e332/system/app/css/trogedit.css","/_/rsrc/1441580320000/system/app/css/editor.css","https://ssl.gstatic.com/sites/p/56e332/system/app/css/codeeditor.css","/_/rsrc/1441580320000/system/app/css/camelot/editor-jfk-wlb.css"]},"sharingUrlPrefix":"/_/sharing","isAdsenseEnabled":true,"domain":"chromium.org","baseUri":"","name":"dev","siteTemplateId":false,"siteNoticeRevision":null,"siteNoticeUrlAddress":null,"siteNoticeMessage":null,"page":{"isRtlLocale":false,"canDeleteWebspace":null,"isPageDraft":null,"parentPath":"/developers/how-tos/enterprise","parentWuid":"wuid:gx:46460e89df1f2387","siteLocale":"en","timeZone":"America/Los_Angeles","type":"text","title":"Running the cloud policy test server","locale":"en","wuid":"wuid:gx:6f394580473576bb","revision":29,"path":"/developers/how-tos/enterprise/running-the-cloud-policy-test-server","isSiteRtlLocale":false,"pageInheritsPermissions":null,"name":"running-the-cloud-policy-test-server","canChangePath":true,"state":"","properties":{},"bidiEnabled":false,"currentTemplate":{"path":"/system/app/pagetemplates/text","title":"Web Page"}},"canPublishScriptToAnyone":true,"user":{"keyboardShortcuts":true,"sessionIndex":"","guest_":true,"displayNameOrEmail":"guest","userName":"guest","uid":"","renderMobile":false,"domain":"","namespace":"","hasWriteAccess":false,"namespaceUser":false,"primaryEmail":"guest","hasAdminAccess":false},"gadgets":{"baseUri":"/system/app/pages/gadgets"}};
  webspace.page.breadcrumbs = breadcrumbs;

  
  var JOT_siteRelTimeStrs = ["a minute ago","__duration__ minutes ago","an hour ago","__duration__ hours ago"];

</script>
<script type="text/javascript">
                window.jstiming.load.tick('scl');
              </script>
<meta name="title" content="Running the cloud policy test server - The Chromium Projects" />
<meta itemprop="name" content="Running the cloud policy test server - The Chromium Projects" />
<meta property="og:title" content="Running the cloud policy test server - The Chromium Projects" />
<meta name="description" content="Home of the Chromium Open Source Project" />
<meta itemprop="description" content="Home of the Chromium Open Source Project" />
<meta id="meta-tag-description" property="og:description" content="Home of the Chromium Open Source Project" />
<style type="text/css">
</style>
<link rel="stylesheet" type="text/css" href="https://ssl.gstatic.com/sites/p/56e332/system/app/themes/beigeandblue/standard-css-beigeandblue-ltr-ltr.css" />
<link rel="stylesheet" type="text/css" href="/_/rsrc/1441580320000/system/app/css/overlay.css?cb=beigeandblueundefineda100%25%25150goog-ws-leftthemedefaultstandard" />
<link rel="stylesheet" type="text/css" href="/_/rsrc/1441580320000/system/app/css/camelot/allthemes-view.css" />
<!--[if IE]>
          <link rel="stylesheet" type="text/css" href="/system/app/css/camelot/allthemes%2die.css" />
        <![endif]-->
<title>Running the cloud policy test server - The Chromium Projects</title>
<meta itemprop="image" content="/_/rsrc/1438879449147/config/customLogo.gif?revision=3" />
<meta property="og:image" content="/_/rsrc/1438879449147/config/customLogo.gif?revision=3" />
<script type="text/javascript">
                window.jstiming.load.tick('cl');
              </script>
</head>
<body xmlns="http://www.google.com/ns/jotspot" id="body" class=" en            ">
<div id="sites-page-toolbar" class="sites-header-divider">
<div xmlns="http://www.w3.org/1999/xhtml" id="sites-status" class="sites-status" style="display:none;"><div id="sites-notice" class="sites-notice" role="status" aria-live="assertive"> </div></div>
</div>
<div id="sites-chrome-everything-scrollbar">
<div id="sites-chrome-everything" class="">
<div id="sites-chrome-page-wrapper" style="direction: ltr">
<div id="sites-chrome-page-wrapper-inside">
<div xmlns="http://www.w3.org/1999/xhtml" id="sites-chrome-header-wrapper" style="height:auto;">
<table id="sites-chrome-header" class="sites-layout-hbox" cellspacing="0" style="height:auto;">
<tr class="sites-header-primary-row" id="sites-chrome-userheader">
<td id="sites-header-title" class="" role="banner"><div class="sites-header-cell-buffer-wrapper"><a href="https://www.chromium.org/" id="sites-chrome-userheader-logo"><img id="logo-img-id" src="/_/rsrc/1438879449147/config/customLogo.gif?revision=3" alt="The Chromium Projects" class="sites-logo  " /></a><h2><a href="https://www.chromium.org/" dir="ltr" id="sites-chrome-userheader-title">The Chromium Projects</a></h2></div></td><td class="sites-layout-searchbox  "><div class="sites-header-cell-buffer-wrapper"><form id="sites-searchbox-form" action="/system/app/pages/search" role="search"><input type="hidden" id="sites-searchbox-scope" name="scope" value="search-site" /><input type="text" id="jot-ui-searchInput" name="q" size="20" value="" aria-label="Search this site" /><div id="sites-searchbox-button-set" class="goog-inline-block"><div role="button" id="sites-searchbox-search-button" class="goog-inline-block jfk-button jfk-button-standard" tabindex="0">Search this site</div></div></form></div></td>
</tr>
<tr class="sites-header-secondary-row" id="sites-chrome-horizontal-nav">
<td colspan="2" id="sites-chrome-header-horizontal-nav-container" role="navigation">
</td>
</tr>
</table>
</div>
<div id="sites-chrome-main-wrapper">
<div id="sites-chrome-main-wrapper-inside">
<table id="sites-chrome-main" class="sites-layout-hbox" cellspacing="0" cellpadding="{scmCellpadding}" border="0">
<tr>
<td id="sites-chrome-sidebar-left" class="sites-layout-sidebar-left initial" style="width:150px">
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_7648876402527094" class="sites-embed" role="navigation"><div class="sites-embed-content sites-sidebar-nav"><ul role="navigation" jotId="navList"><li class="nav-first "><div dir="ltr" style="padding-left: 5px;"><a href="/chromium-projects" jotId="wuid:gx:10ae433dadbbab13" class="sites-navigation-link">Home</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="/Home" jotId="wuid:gx:43582b9d2029d3af" class="sites-navigation-link">Chromium</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="/chromium-os" jotId="wuid:gx:83df2ab1f8880ba" class="sites-navigation-link">Chromium OS</a></div></li></ul></div></div>
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_14720868319272995" class="sites-embed" role="navigation"><h4 class="sites-embed-title">Quick links</h4><div class="sites-embed-content sites-sidebar-nav"><ul role="navigation" jotId="navList"><li class="nav-first "><div dir="ltr" style="padding-left: 5px;"><a href="http://www.chromium.org/for-testers/bug-reporting-guidelines" class="sites-navigation-link">Report bugs</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="http://www.chromium.org/developers/discussion-groups" class="sites-navigation-link">Discuss</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="/system/app/pages/sitemap/hierarchy" jotId="wuid:gx:4b58a9a350ad12f" class="sites-navigation-link">网站地图</a></div></li></ul></div></div>
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_19690813310444355" class="sites-embed" role="navigation"><h4 class="sites-embed-title">Other sites</h4><div class="sites-embed-content sites-sidebar-nav"><ul role="navigation" jotId="navList"><li class="nav-first "><div dir="ltr" style="padding-left: 5px;"><a href="http://blog.chromium.org/" class="sites-navigation-link">Chromium Blog</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="http://code.google.com/chrome/extensions/" class="sites-navigation-link">Google Chrome Extensions</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="https://developers.google.com/chrome/chrome-frame/" class="sites-navigation-link">Google Chrome Frame</a></div></li></ul></div></div>
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_19695218559354544" class="sites-embed" role="complementary"><h4 class="sites-embed-title"></h4><div class="sites-embed-content sites-embed-content-sidebar-textbox"><div dir="ltr"><span style="font-size:x-small">Except as otherwise </span><a href="http://developers.google.com/site-policies.html#restrictions"><span style="font-size:x-small">noted</span></a><span style="font-size:x-small">, the content of this page is licensed under a </span><a href="http://creativecommons.org/licenses/by/2.5/"><span style="font-size:x-small">Creative Commons Attribution 2.5 license</span></a><span style="font-size:x-small">, and examples are licensed under the </span><a href="http://src.chromium.org/viewvc/chrome/trunk/src/LICENSE" target="_blank"><span style="font-size:x-small">BSD License</span></a><span style="font-size:x-small">.<br /></span></div></div></div>
</td>
<td id="sites-canvas-wrapper">
<div id="sites-canvas" role="main">
<div id="goog-ws-editor-toolbar-container"> </div>
<div xmlns="http://www.w3.org/1999/xhtml" id="title-crumbs" style="">
<A href="/developers" dir="ltr">For Developers</A>‎ &gt; ‎<A href="/developers/how-tos" dir="ltr">How-Tos</A>‎ &gt; ‎<A href="/developers/how-tos/enterprise" dir="ltr">Enterprise</A>‎ &gt; ‎
  </div>
<h3 xmlns="http://www.w3.org/1999/xhtml" id="sites-page-title-header" style="" align="left">
<span id="sites-page-title" dir="ltr" tabindex="-1" style="outline: none">Running the cloud policy test server</span>
</h3>
<div id="sites-canvas-main" class="sites-canvas-main">
<div id="sites-canvas-main-content">
<table xmlns="http://www.w3.org/1999/xhtml" cellspacing="0" class="sites-layout-name-one-column sites-layout-hbox"><tbody><tr><td class="sites-layout-tile sites-tile-name-content-1"><div dir="ltr"><div>Chromium can pull down enterprise policy configuration from a cloud service. We have a simplistic python implementation of the management service, so we are able to test features without relying on a full cloud policy server implementation. This page explains how to run it:</div>
<h2><a name="TOC-Running-the-test-server"></a>Running the test server</h2>
<div>
<ol><li>You need a Linux Chromium checkout that's in good shape for building the browser. See <a href="https://www.chromium.org/developers/how-tos/get-the-code">Get the Code</a></li>
<li>Make sure you have the protocol buffer source compiled (add the <code>device_policy_proto</code> to the line below if you're building for Chrome OS):<br />
<div class="sites-codeblock sites-codesnippet-block">
<code>ninja -C out/Debug py_proto policy cloud_policy_proto</code></div></li>
<li>Start the test server. You can start testserver.py directly from the src/ directory of your Chrome source tree:<br /><div class="sites-codeblock sites-codesnippet-block"><font color="#006000" face="monospace"><span style="background-color:transparent">PYTHONPATH=third_party/tlslite:net/tools/testserver:out/Debug/pyproto:out/Debug/pyproto/chrome/browser/chromeos/policy/proto:out/Debug/pyproto/policy/proto </span>python chrome/browser/policy/test/policy_testserver.py --data-dir ~/tmp/ --host 127.0.0.1 --port 8889</font></div><br />Note: replace out/Debug with out/Release if appropriate, depending on your build configuration.<br /><br />If you want logging, add these flags:<br />
<div class="sites-codeblock sites-codesnippet-block">
<code>--log-level DEBUG --log-to-console</code></div><br /> Notes on parameters:<br />
<ul>
<li><code>--data-dir</code> specifies the directory from which the server will read the policy file (see below). Up to you where to place it.</li><li><code>--port</code> specifies the port the server should listen on, you can pick a port of your liking.</li><li><code style="font-size:10pt">--host</code><span style="font-size:10pt"> The IP address the server should bind to. Note that if you want to test a Chromium OS image running on a Chromebook or in a Virtual Machine against the server, you need to specify the host name or IP address of the public interface in your machine. Note that the server only accepts connections from that IP. To work around these restrictions you can use a port forwarding (ssh is your friend) or local proxy server.</span></li><li><span style="color:rgb(0,96,0);font-family:monospace;font-size:13.3333330154419px">--client-state</span> specifies a file in which to persist current server state. This is useful if you want the server to remember registered clients and such across server restarts, for example when your tinkering with the python code in policy_testserver.py to create specific error conditions etc.</li><li><span style="color:rgb(0,96,0);font-family:monospace;font-size:13.3333330154419px">--config-file</span> specifies a file that contains server configuration. If not specified, the server will default to the <span style="color:rgb(0,96,0);font-family:monospace;font-size:13.3333330154419px">device_management</span> file in the data directory.</li><li><span style="color:rgb(0,96,0);font-family:monospace;font-size:13.3333330154419px">--policy-key</span> a PEM-encoded file containing a private RSA key used to sign policy blobs. More information on the policy blob format and signatures is <a href="https://www.chromium.org/developers/how-tos/enterprise/protobuf-encoded-policy-blobs">here</a>. Note that for signing keys to be accepted by Chrome, a verification signature is required that certifies the signing key. These signatures are checked against a Google-owned key pair, the public half of which is <a href="https://code.google.com/p/chromium/codesearch#chromium/src/components/policy/core/common/cloud/cloud_policy_constants.cc&amp;l=65">baked into the chrome binary</a>. The policy test server contains <a href="https://code.google.com/p/chromium/codesearch#chromium/src/chrome/browser/policy/test/policy_testserver.py&amp;l=115">hardcoded verification signatures</a> for a couple test domains. If you specify a policy key on the command line, the server will try to load a verification signature from the file that's named like the policy key file, but with ".sig" appended. Multiple policy keys may be specified in the command line in order to test key rotation.</li></ul></li>
<li>Check whether the server answers requests. Point your browser to <a href="http://localhost:8889/test/ping">http://localhost:8889/test/ping</a> (or the public IP you've passed to the <code>--host</code> switch). The server should respond with a page saying "<span style="white-space:pre-wrap;font-size:10pt;background-color:transparent">Policy server is up.</span><span style="font-size:10pt;background-color:transparent">"</span></li>
<li>Ready to roll!</li></ol><h2><a name="TOC-Setting-up-a-configuration-file"></a>Setting up a configuration file</h2><div>The configuration file is a<span style="font-size:13.3333330154419px;background-color:transparent"> JSON file containing server-global parameters. Here's an example:</span></div><div><span style="background-color:transparent"><div></div><div class="sites-codeblock sites-codesnippet-block"><div><code>{</code></div><div><code>  "managed_users": [ "*" ],</code></div><div><code>  "policy_user": "madmax@managedchrome.com",</code></div><div><code>  "current_key_index": 0,</code></div><div><code>  "service_account_identity": "",</code></div><div><code>  "robot_api_auth_code": "",</code></div><div><code>  "invalidation_source": 0,</code></div><div><code>  "invalidation_name": "",</code></div><div><code>  "device_state": {</code></div><div><code>    "management_domain": "managedchrome.com",</code></div><div><code>    "restore_mode": 2</code></div><div><code>  }</code></div><div><code>}</code></div></div></span></div><br />Notes on parameters:</div><div><ul style="font-size:13.3333330154419px"><li><code>managed_users</code> specifies the list of clients the server is allowing to register. Each entry is an oauth token, or the "*" wildcard which matches any client.<br />(Note that going by OAuth token actually isn't very useful, we should either remove this parameter or give the server the ability to figure out the actual user)</li><li><code>policy_user</code> is the user ID to put in policy responses to identify the target of the policy settings. This needs to match the user on the Chrome side or Chrome will reject the policy.</li><li><code style="font-size:13.3333330154419px">current_key_index</code><span style="font-size:13.3333330154419px"> is the index of the signing key to use when generating policy blob signatures.</span></li><li><code style="font-size:13.3333330154419px">service_account_identity</code><span style="font-size:13.3333330154419px"> is the email address of the service account. This is the account used on Chrome OS to enable Google cloud services that require authentication. Note that the test server can't create service accounts, so this parameter is likely only useful for testing (i.e. you have a way to create a service account separately and want to inject the proper service account name).</span><br /></li><li><code style="font-size:13.3333330154419px">robot_api_auth_code</code><span style="font-size:13.3333330154419px"> specifies the authentication code the server should return when a Chrome OS client asks for one during enterprise enrollment. Since the server doesn't have the ability to create robot accounts, it can't satisfy these request. Leave this parameter empty unless you are testing robot auth setup and have a way to create robot accounts and obtain auth codes separately.</span><br /></li><li><code style="font-size:13.3333330154419px">invalidation_source</code><span style="font-size:13.3333330154419px"> and <span style="color:rgb(0,96,0);font-family:monospace;font-size:13.3333330154419px">invalidation_name</span> are used in policy change push notifications. Change notifications are not supported by the test server. This parameter merely exists to facilitate testing using a source identifier obtained elsewhere.</span></li><li><code style="font-size:13.3333330154419px">device_state</code><span style="font-size:13.3333330154419px"> provides device state parameters requested by Chrome OS clients that have gone through a hardware reset and are performing a handshake with the server to discover their previous state. This is part of the forced re-enrollment and device disabling features. You should generally only need these parameters if you're specifically testing the aforementioned features.</span></li></ul><h2><a name="TOC-Setting-up-a-policy-file"></a>Setting up a policy file</h2><div>The test server reads policy to supply to clients from the data directory specified with the <code>--data-dir</code>.  The directory contains text files containing protobuf messages that supply the payload to return to the client when it asks for policy. The files are named according to the type of policy requested and the entity the policy is intended for.</div><h3><a name="TOC-User-policy"></a><font size="3">User policy</font></h3><span style="font-size:10pt;font-weight:normal;background-color:transparent">The file names are:</span><div><ul><li><span style="font-size:10pt;background-color:transparent">policy_google_android_user.txt</span></li><li><span style="font-size:10pt;background-color:transparent">policy_google_chromeos_publicaccount_$PUBLICACCOUNTID.txt</span></li><li><span style="font-size:10pt;background-color:transparent">policy_google_chromeos_user.txt</span></li><li><span style="font-size:10pt;background-color:transparent">policy_google_chrome_user.txt</span></li><li><span style="font-size:10pt;background-color:transparent">policy_google_ios_user.txt</span></li></ul><span style="font-size:10pt;background-color:transparent">The payload protocol buffer message is CloudPolicySettings. This is generated from <a href="https://code.google.com/p/chromium/codesearch#search/&amp;q=policy_templates.json&amp;sq=package:chromium&amp;type=cs">policy_templates.json</a> and there is a message field with the name matching the policy name for each supported policy. The value field within the nested message contains the policy value. Here is an example with a few policy settings defined:</span><br style="font-size:10pt;background-color:transparent" /><div class="sites-codeblock sites-codesnippet-block" style="font-size:10pt"><code>HomepageLocation {<br />  value: "http://www.chromium.org"<br />}<br /><br />ShowHomeButton {<br />  value: true<br />}</code></div><h3 style="background-color:transparent"><a name="TOC-Device-policy"></a><span style="background-color:transparent"><font size="3">Device policy</font></span></h3><div style="font-size:10pt;background-color:transparent"><span style="font-size:10pt;background-color:transparent">The file name is policy_google_chromeos_device.txt and the payload protocol buffer is ChromeDeviceSettingsProto. Example contents:</span></div><div style="font-size:10pt;background-color:transparent"><span style="font-size:10pt;background-color:transparent"><div style="font-size:10pt;background-color:transparent"></div><div class="sites-codeblock sites-codesnippet-block"><div style="font-size:10pt;background-color:transparent"><code>device_policy_refresh_rate {</code></div><div style="font-size:10pt;background-color:transparent"><code>  device_policy_refresh_rate: 60</code></div><div style="font-size:10pt;background-color:transparent"><code>}</code></div><div style="font-size:10pt;background-color:transparent"><code>user_whitelist {</code></div><div style="font-size:10pt;background-color:transparent"><code>  user_whitelist: "*@managedchrome.com"</code></div><div style="font-size:10pt;background-color:transparent"><code>  user_whitelist: "*@gmail.com"</code></div><div style="font-size:10pt;background-color:transparent"><span style="color:rgb(0,96,0);font-size:10pt;line-height:1;background-color:transparent">}</span></div><div style="font-size:10pt;background-color:transparent"><code>device_local_accounts {</code></div><div style="font-size:10pt;background-color:transparent"><code>  account {</code></div><div style="font-size:10pt;background-color:transparent"><code>    account_id: "publicsession@managedchrome.com"</code></div><div style="font-size:10pt;background-color:transparent"><code>    type: ACCOUNT_TYPE_PUBLIC_SESSION</code></div><div style="font-size:10pt;background-color:transparent"><code>  }</code></div><div style="font-size:10pt;background-color:transparent"><span style="color:rgb(0,96,0);font-size:10pt;line-height:1;background-color:transparent">}</span></div></div></span></div></div></div><div><h2><a name="TOC-Configuring-Chromium-OS-to-talk-to-the-test-server"></a>Configuring Chromium OS to talk to the test server</h2><div>In order to do something useful with the test server, you can configure Chromium built for Chromium OS to talk to the test server for device- and user-level policy. Here is what you need to do:</div><div><ol><li>Get a root shell on the VM or Chromebook that you want to talk to the test server.</li><li>Make sure you have a writable root file system. Try <code>mount -o remount,rw /</code> if you don't, if that fails, you're likely on an actual device with enabled root file system protection, in that case check out <code>/usr/share/vboot/bin/make_dev_ssd.sh --remove_rootfs_verification</code></li><li>Edit <code>/etc/chrome_dev.conf</code>. Add the following flags:<br /><div class="sites-codeblock sites-codesnippet-block"><span style="color:rgb(0,96,0);font-family:monospace;font-size:13.3333330154419px;line-height:13.3333320617676px;background-color:rgb(239,239,239)"><code>--device-management-url=http://&lt;your-ip&gt;:&lt;yourport&gt;</code></span><br style="color:rgb(0,96,0);font-family:monospace;font-size:13.3333330154419px;line-height:13.3333320617676px;background-color:rgb(239,239,239)" /><span style="color:rgb(0,96,0);font-family:monospace;font-size:13.3333330154419px;line-height:13.3333320617676px;background-color:rgb(239,239,239)"><code>--enterprise-enrollment-skip-robot-auth</code></span></div>This points the device at your test server and instructs it to skip robot auth setup, which avoids an error during enrollment due to the test server not being able to create robot accounts.</li><li>On a shell, say<br /><div class="sites-codeblock sites-codesnippet-block"><code>restart ui</code></div></li><li>You're now set up to fetch policy from the test server!</li></ol><h2><a name="TOC-Configuring-Chromium-to-talk-to-the-test-server"></a>Configuring Chromium to talk to the test server</h2><div>Pass the following command line flag to chrome:</div><div><br /></div><div><span style="color:rgb(0,96,0);line-height:1;font-size:10pt;background-color:rgb(239,239,239)"><div class="sites-codeblock sites-codesnippet-block"><code>--device-management-url=http://&lt;your-ip&gt;:&lt;yourport&gt;</code></div></span></div><h2><a name="TOC-User-policy1"></a>User policy</h2></div><div>To test some user policy setting, configure the policy file as desired and then just log in. The browser should automatically pull policy. You can verify that the policy is correctly pulled down from the server by inspecting <a href="javascript:void(0);">chrome://policy</a>. To test policy changes, you can also just update the policy in the file, and use the "Reload policies" button on <a href="javascript:void(0);">chrome://policy</a> to refresh policy at runtime.</div><h2><a name="TOC-Device-policy1"></a>Device policy</h2><div>For devices to receive device policy, they need to be enrolled for enterprise management at device setup time. There are some requirements for that to succeed:</div><div><ul><li>The device's TPM needs to be clear. In particular, running <code>cryptohome --action=tpm_status</code> should indicate that the TPM is not yet owned. If you have an owned TPM, do the following:<br /><div class="sites-codeblock sites-codesnippet-block"><code>crossystem clear_tpm_owner_request=1</code><br /><code>echo "fast keepimg" &gt; /mnt/stateful_partition/factory_install_reset</code><br /><code>reboot</code></div>The system will reboot, do a powerwash and reboot again. The device should have a clear TPM and be in enrollable state afterwards.</li><li>The device may not have a consumer owner already, i.e. you shouldn't have logged in previously. Ownership is mainly indicated through files in <code>/var/lib/whitelist</code>, which you can clear like this<br /><div class="sites-codeblock sites-codesnippet-block"><code>stop ui</code><br /><code>rm -rf /var/lib/whitelist/*</code><br /><code>start ui</code></div>This works well in a VM, note that you probably need a TPM reset an actual hardware (see above).</li></ul><div>To perform the actual enrollment, hit <code>Ctrl+Alt+E</code> on the sign in screen. Provide credentials (note that in case of the test server, you must match the "policy_user" field in your JSON config file) and speak a short prayer. If you get lucky, the device will enroll. Log in and check <a href="javascript:void(0);">chrome://policy</a> for whether it says device policy is present. </div></div></div></div></td></tr></tbody></table>
</div> 
</div> 
<div id="sites-canvas-bottom-panel">
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_page-subpages"> </div>
<div id="sites-attachments-container">
</div>
<a xmlns="http://www.w3.org/1999/xhtml" name="page-comments"></a>
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_page-comments"><div class="sites-comment-docos-wrapper"><div class="sites-comment-docos"><div class="sites-comment-docos-background"></div><div class="sites-comment-docos-header"><div class="sites-comment-docos-header-title">Comments</div></div><div id="sites-comment-docos-pane" class="sites-comment-docos-pane"></div></div></div></div>
</div>
</div> 
</td> 
</tr>
</table> 
</div> 
</div> 
<div id="sites-chrome-footer-wrapper">
<div id="sites-chrome-footer-wrapper-inside">
<div id="sites-chrome-footer">
</div>
</div>
</div>
</div> 
</div> 
<div id="sites-chrome-adminfooter-container">
<div xmlns="http://www.w3.org/1999/xhtml" class="sites-adminfooter" role="navigation"><p><a class="sites-system-link" href="https://www.google.com/a/UniversalLogin?service=jotspot&amp;continue=https://sites.google.com/a/chromium.org/dev/developers/how-tos/enterprise/running-the-cloud-policy-test-server">Sign in</a><span aria-hidden="true">|</span><a class="sites-system-link" href="/system/app/pages/recentChanges">Recent Site Activity</a><span aria-hidden="true">|</span><a class="sites-system-link" href="/system/app/pages/reportAbuse" target="_blank">Report Abuse</a><span aria-hidden="true">|</span><a class="sites-system-link" href="javascript:;" onclick="window.open(webspace.printUrl)">Print Page</a><span aria-hidden="true">|</span><span class="sites-system-link">Powered By</span> <b class="powered-by"><a href="http://sites.google.com">Google Sites</a></b></p></div>
</div>
</div> 
</div> 
<div id="sites-chrome-onebar-footer">
</div>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
    window.jstiming.load.tick('sjl');
  </script>
<script xmlns="http://www.w3.org/1999/xhtml" src="https://ssl.gstatic.com/sites/p/56e332/system/js/jot_min_view__en.js"></script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
    window.jstiming.load.tick('jl');
  </script>
<script xmlns="http://www.w3.org/1999/xhtml">
      
          sites.core.Analytics.createTracker();
          sites.core.Analytics.trackPageview();
        
    </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
                    sites.Searchbox.initialize(
                        'sites-searchbox-search-button',
                        {"object":[]}['object'],
                        'search-site',
                        {"label":"Configure search options...","url":"/system/app/pages/admin/settings"});
                  </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
      gsites.HoverPopupMenu.createSiteDropdownMenus('sites-header-nav-dropdown', false);
    </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript" defer="true">
            JOT_setupNav("7648876402527094", "Navigation", false);
            JOT_addListener('titleChange', 'JOT_NAVIGATION_titleChange', 'COMP_7648876402527094');
          </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript" defer="true">
            JOT_setupNav("14720868319272995", "Quick links", false);
            JOT_addListener('titleChange', 'JOT_NAVIGATION_titleChange', 'COMP_14720868319272995');
          </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript" defer="true">
            JOT_setupNav("19690813310444355", "Other sites", false);
            JOT_addListener('titleChange', 'JOT_NAVIGATION_titleChange', 'COMP_19690813310444355');
          </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
              new sites.CommentPane('//docs.google.com/comments/d/AAHRpnXvrAwjAfmld0ObrebBiGRq9vP-N4w9oG_47J0Eo-VHV-tReeOl2c4Q1Knze4TJPHOWwG1oFaLKVyw14oCDXLX_R9NeWZ3JwQj73xAagMXyBSduyXvNmD8zoLvpapewY2Dyf4kCD/api/js?anon=true',
                  false, false);
            </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
  setTimeout(function() {
    var fingerprint = gsites.date.TimeZone.getFingerprint([]);
    gsites.Xhr.send('https://www.chromium.org/_/tz', null, null, 'GET', null, null, { afjstz: fingerprint });
  }, 500);
</script>
<script xmlns="http://www.w3.org/1999/xhtml">
                    window.onload = function() {
                      if (false) {
                        JOT_setMobilePreview();
                      }
                      var loadTimer = window.jstiming.load;
                      loadTimer.tick("ol");
                      loadTimer["name"] = "load," + webspace.page.type + ",user_page";
                      window.jstiming.report(loadTimer, {}, 'https://gg.google.com/csi');
                    }
                  </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
        JOT_insertAnalyticsCode(false,
            false);
      </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
    var maestroRunner = new gsites.pages.view.SitesMaestroRunner(
        webspace, "en");
    maestroRunner.initListeners();
    maestroRunner.installEditRender();
  </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript" defer="true">
  //<![CDATA[
    // Decorate any fastUI buttons on the page with a class of 'goog-button'.
    if (webspace.user.hasWriteAccess) {
      JOT_decorateButtons();
    }

    // Fires delayed events.
    (function() {
      JOT_fullyLoaded = true;
      var delayedEvents = JOT_delayedEvents;
      for (var x = 0; x < delayedEvents.length; x++) {
        var event = delayedEvents[x];
        JOT_postEvent(event.eventName, event.eventSrc, event.payload);
      }
      JOT_delayedEvents = null;
      JOT_postEvent('pageLoaded');
    })();
  //]]>
</script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
    JOT_postEvent('decorateGvizCharts');
  </script>
<script type="text/javascript">
          JOT_setupPostRenderingManager();
        </script>
<script type="text/javascript">
          JOT_postEvent('renderPlus', null, 'sites-chrome-main');
        </script>
<div id="server-timer-div" style="display:none"> </div>
<script type="text/javascript">
          window.jstiming.load.tick('render');
          JOT_postEvent('usercontentrendered', this);
        </script>
</body>
</html>
