<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/WebPage">
<head>
<meta http-equiv="X-UA-Compatible" content="chrome=1" />
<script type="text/javascript">/* Copyright 2008 Google. */ (function() { var e="wtsrt_",g="tbsd_",h="tbnd_",k="start",l="_wtsrt",m="_tbnd",n="CSI/";(function(){function f(a){this.t={};this.tick=function(a,c,b){this.t[a]=[void 0!=b?b:(new Date).getTime(),c];if(void 0==b)try{window.console.timeStamp(n+a)}catch(d){}};this.tick(k,null,a)}var a;window.performance&&(a=window.performance.timing);var p=a?new f(a.responseStart):new f;window.jstiming={Timer:f,load:p};if(a){var c=a.navigationStart,d=a.responseStart;0<c&&d>=c&&(window.jstiming.srt=d-c)}if(a){var b=window.jstiming.load;0<c&&d>=c&&(b.tick(l,void 0,c),b.tick(e,l,d),b.tick(g,e))}try{a=null,
window.chrome&&window.chrome.csi&&(a=Math.floor(window.chrome.csi().pageT),b&&0<c&&(b.tick(m,void 0,window.chrome.csi().startE),b.tick(h,m,c))),null==a&&window.gtbExternal&&(a=window.gtbExternal.pageT()),null==a&&window.external&&(a=window.external.pageT,b&&0<c&&(b.tick(m,void 0,window.external.startE),b.tick(h,m,c))),a&&(window.jstiming.pt=a)}catch(q){}})(); })()
</script>
<link rel="shortcut icon" href="../../_/rsrc/1354323194313/favicon.ico" type="image/x-icon" />
<link rel="apple-touch-icon" href="https://ssl.gstatic.com/sites/p/56e332/system/app/images/apple-touch-icon.png" type="image/png" />
<script type="text/javascript">/* Copyright 2008 Google. */ (function() { var d="",g="__duration__",h="function";function k(c){return document.getElementById(c)}window.byId=k;function l(c){return c.replace(/^\s+|\s+$/g,d)}window.trim=l;var m=[],n=0;window.JOT_addListener=function(c,a,b){var e=new String(n++);c={eventName:c,handler:a,compId:b,key:e};m.push(c);return e};window.JOT_removeListenerByKey=function(c){for(var a=0;a<m.length;a++)if(m[a].key==c){m.splice(a,1);break}};
window.JOT_removeAllListenersForName=function(c){for(var a=0;a<m.length;a++)m[a].eventName==c&&m.splice(a,1)};window.JOT_postEvent=function(c,a,b){var e={eventName:c,eventSrc:a||{},payload:b||{}};if(window.JOT_fullyLoaded)for(a=m.length,b=0;b<a&&b<m.length;b++){var f=m[b];f&&f.eventName==c&&(e.listenerCompId=f.compId||d,(f=typeof f.handler==h?f.handler:window[f.handler])&&f(e))}else window.JOT_delayedEvents.push({eventName:c,eventSrc:a,payload:b})};window.JOT_delayedEvents=[];
window.JOT_fullyLoaded=!1;window.JOT_formatRelativeToNow=function(c,a){var b=((new Date).getTime()-c)/6E4;if(1440<=b||0>b)return null;var e=0;60<=b&&(b/=60,e=2);2<=b&&e++;return a?window.JOT_siteRelTimeStrs[e].replace(g,Math.floor(b)):window.JOT_userRelTimeStrs[e].replace(g,Math.floor(b))}; })()
</script>
<script>

  

  var breadcrumbs = [{"path":"/developers","deleted":false,"title":"For Developers","dir":"ltr"},{"path":"/developers/crash-reports","deleted":false,"title":"Crash Reports","dir":"ltr"},{"path":"/developers/crash-reports/crash-with-invalid-handle","deleted":false,"title":"Crash with invalid handle","dir":"ltr"}];
  var JOT_clearDotPath = 'https://ssl.gstatic.com/sites/p/56e332/system/app/images/cleardot.gif';

  
  var JOT_userRelTimeStrs = ["a minute ago","__duration__ minutes ago","an hour ago","__duration__ hours ago"];

  
  

  

  var webspace = {"enableAnalytics":true,"pageSharingId":"jotspot_page","enableUniversalAnalytics":false,"sharingPolicy":"OPENED_WITH_INDICATOR","siteTitle":"The Chromium Projects","isStartPageEnabled":true,"adsensePublisherId":null,"features":{"languageSelectDefaultTextSetToDefault":true,"validateClientGvizDataSourceUrls":true,"moreMobileStyleImprovements":true,"newInsertMenuIcons":true,"accessibleSortingButtons":true,"domainAnalyticsInGAOnly":true,"noCaptcha":true,"fileCabinetScreenReaderFix":true,"updatedTosAndPrivacyLinks":null,"pageDrafts":false,"mobileOrientationFix":true,"plusBadge":false,"pdfEmbedSupport":false,"jsClickFix":true},"isPublic":true,"isConsumer":false,"serverFlags":{"cajaBaseUrl":"//www.gstatic.com/caja","cajaDebugMode":false},"onepickBaseUrl":"https://docs.google.com","domainAnalyticsAccountId":"","plusPageId":"","signInUrl":"https://www.google.com/a/SelectSession?continue\u003dhttps://sites.google.com/a/chromium.org/dev/developers/crash-reports/crash-with-invalid-handle\u0026service\u003djotspot","analyticsAccountId":"UA-5484340-1","scottyUrl":"/_/upload","homePath":"/","siteNoticeUrlEnabled":null,"plusPageUrl":"","adsensePromoClickedOrSiteIneligible":true,"csiReportUri":"https://gg.google.com/csi","sharingId":"jotspot","termsUrl":"//www.google.com/intl/en/policies/terms/","gvizVersion":1,"editorResources":{"sitelayout":["https://ssl.gstatic.com/sites/p/56e332/system/app/css/sitelayouteditor.css"],"text":["https://ssl.gstatic.com/sites/p/56e332/system/js/codemirror.js","https://ssl.gstatic.com/sites/p/56e332/system/app/css/codemirror_css.css","https://ssl.gstatic.com/sites/p/56e332/system/js/trog_edit__en.js","https://ssl.gstatic.com/sites/p/56e332/system/app/css/trogedit.css","/_/rsrc/1441580320000/system/app/css/editor.css","https://ssl.gstatic.com/sites/p/56e332/system/app/css/codeeditor.css","/_/rsrc/1441580320000/system/app/css/camelot/editor-jfk-wlb.css"]},"sharingUrlPrefix":"/_/sharing","isAdsenseEnabled":true,"domain":"chromium.org","baseUri":"","name":"dev","siteTemplateId":false,"siteNoticeRevision":null,"siteNoticeUrlAddress":null,"siteNoticeMessage":null,"page":{"isRtlLocale":false,"canDeleteWebspace":null,"isPageDraft":null,"parentPath":"/developers/crash-reports","parentWuid":"wuid:gx:2e7176e445913c9b","siteLocale":"en","timeZone":"America/Los_Angeles","type":"text","title":"Crash with invalid handle","locale":"en","wuid":"wuid:gx:1ca32febeeeedb2e","revision":5,"path":"/developers/crash-reports/crash-with-invalid-handle","isSiteRtlLocale":false,"pageInheritsPermissions":null,"name":"crash-with-invalid-handle","canChangePath":true,"state":"","properties":{},"bidiEnabled":false,"currentTemplate":{"path":"/system/app/pagetemplates/text","title":"Web Page"}},"canPublishScriptToAnyone":true,"user":{"keyboardShortcuts":true,"sessionIndex":"","guest_":true,"displayNameOrEmail":"guest","userName":"guest","uid":"","renderMobile":false,"domain":"","namespace":"","hasWriteAccess":false,"namespaceUser":false,"primaryEmail":"guest","hasAdminAccess":false},"gadgets":{"baseUri":"/system/app/pages/gadgets"}};
  webspace.page.breadcrumbs = breadcrumbs;

  
  var JOT_siteRelTimeStrs = ["a minute ago","__duration__ minutes ago","an hour ago","__duration__ hours ago"];

</script>
<script type="text/javascript">
                window.jstiming.load.tick('scl');
              </script>
<meta name="title" content="Crash with invalid handle - The Chromium Projects" />
<meta itemprop="name" content="Crash with invalid handle - The Chromium Projects" />
<meta property="og:title" content="Crash with invalid handle - The Chromium Projects" />
<meta name="description" content="Home of the Chromium Open Source Project" />
<meta itemprop="description" content="Home of the Chromium Open Source Project" />
<meta id="meta-tag-description" property="og:description" content="Home of the Chromium Open Source Project" />
<style type="text/css">
</style>
<link rel="stylesheet" type="text/css" href="https://ssl.gstatic.com/sites/p/56e332/system/app/themes/beigeandblue/standard-css-beigeandblue-ltr-ltr.css" />
<link rel="stylesheet" type="text/css" href="../../_/rsrc/1441580320000/system/app/css/overlay.css%3Fcb=beigeandblueundefineda100%2525%2525150goog-ws-leftthemedefaultstandard.css" />
<link rel="stylesheet" type="text/css" href="../../_/rsrc/1441580320000/system/app/css/camelot/allthemes-view.css" />
<!--[if IE]>
          <link rel="stylesheet" type="text/css" href="/system/app/css/camelot/allthemes%2die.css" />
        <![endif]-->
<title>Crash with invalid handle - The Chromium Projects</title>
<meta itemprop="image" content="/_/rsrc/1438879449147/config/customLogo.gif?revision=3" />
<meta property="og:image" content="/_/rsrc/1438879449147/config/customLogo.gif?revision=3" />
<script type="text/javascript">
                window.jstiming.load.tick('cl');
              </script>
</head>
<body xmlns="http://www.google.com/ns/jotspot" id="body" class=" en            ">
<div id="sites-page-toolbar" class="sites-header-divider">
<div xmlns="http://www.w3.org/1999/xhtml" id="sites-status" class="sites-status" style="display:none;"><div id="sites-notice" class="sites-notice" role="status" aria-live="assertive"> </div></div>
</div>
<div id="sites-chrome-everything-scrollbar">
<div id="sites-chrome-everything" class="">
<div id="sites-chrome-page-wrapper" style="direction: ltr">
<div id="sites-chrome-page-wrapper-inside">
<div xmlns="http://www.w3.org/1999/xhtml" id="sites-chrome-header-wrapper" style="height:auto;">
<table id="sites-chrome-header" class="sites-layout-hbox" cellspacing="0" style="height:auto;">
<tr class="sites-header-primary-row" id="sites-chrome-userheader">
<td id="sites-header-title" class="" role="banner"><div class="sites-header-cell-buffer-wrapper"><a href="../../index.html" id="sites-chrome-userheader-logo"><img id="logo-img-id" src="../../_/rsrc/1438879449147/config/customLogo.gif%3Frevision=3" alt="The Chromium Projects" class="sites-logo  " /></a><h2><a href="../../index.html" dir="ltr" id="sites-chrome-userheader-title">The Chromium Projects</a></h2></div></td><td class="sites-layout-searchbox  "><div class="sites-header-cell-buffer-wrapper"><form id="sites-searchbox-form" action="https://www.chromium.org/system/app/pages/search" role="search"><input type="hidden" id="sites-searchbox-scope" name="scope" value="search-site" /><input type="text" id="jot-ui-searchInput" name="q" size="20" value="" aria-label="Search this site" /><div id="sites-searchbox-button-set" class="goog-inline-block"><div role="button" id="sites-searchbox-search-button" class="goog-inline-block jfk-button jfk-button-standard" tabindex="0">Search this site</div></div></form></div></td>
</tr>
<tr class="sites-header-secondary-row" id="sites-chrome-horizontal-nav">
<td colspan="2" id="sites-chrome-header-horizontal-nav-container" role="navigation">
</td>
</tr>
</table>
</div>
<div id="sites-chrome-main-wrapper">
<div id="sites-chrome-main-wrapper-inside">
<table id="sites-chrome-main" class="sites-layout-hbox" cellspacing="0" cellpadding="{scmCellpadding}" border="0">
<tr>
<td id="sites-chrome-sidebar-left" class="sites-layout-sidebar-left initial" style="width:150px">
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_7648876402527094" class="sites-embed" role="navigation"><div class="sites-embed-content sites-sidebar-nav"><ul role="navigation" jotId="navList"><li class="nav-first "><div dir="ltr" style="padding-left: 5px;"><a href="../../chromium-projects.html" jotId="wuid:gx:10ae433dadbbab13" class="sites-navigation-link">Home</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="../../Home.1.html" jotId="wuid:gx:43582b9d2029d3af" class="sites-navigation-link">Chromium</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="../../chromium-os.1.html" jotId="wuid:gx:83df2ab1f8880ba" class="sites-navigation-link">Chromium OS</a></div></li></ul></div></div>
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_14720868319272995" class="sites-embed" role="navigation"><h4 class="sites-embed-title">Quick links</h4><div class="sites-embed-content sites-sidebar-nav"><ul role="navigation" jotId="navList"><li class="nav-first "><div dir="ltr" style="padding-left: 5px;"><a href="../../for-testers/bug-reporting-guidelines.html" class="sites-navigation-link">Report bugs</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="../discussion-groups.html" class="sites-navigation-link">Discuss</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="../../system/app/pages/sitemap/hierarchy.html" jotId="wuid:gx:4b58a9a350ad12f" class="sites-navigation-link">网站地图</a></div></li></ul></div></div>
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_19690813310444355" class="sites-embed" role="navigation"><h4 class="sites-embed-title">Other sites</h4><div class="sites-embed-content sites-sidebar-nav"><ul role="navigation" jotId="navList"><li class="nav-first "><div dir="ltr" style="padding-left: 5px;"><a href="http://blog.chromium.org/" class="sites-navigation-link">Chromium Blog</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="http://code.google.com/chrome/extensions/" class="sites-navigation-link">Google Chrome Extensions</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="https://developers.google.com/chrome/chrome-frame/" class="sites-navigation-link">Google Chrome Frame</a></div></li></ul></div></div>
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_19695218559354544" class="sites-embed" role="complementary"><h4 class="sites-embed-title"></h4><div class="sites-embed-content sites-embed-content-sidebar-textbox"><div dir="ltr"><span style="font-size:x-small">Except as otherwise </span><a href="http://developers.google.com/site-policies.html#restrictions"><span style="font-size:x-small">noted</span></a><span style="font-size:x-small">, the content of this page is licensed under a </span><a href="http://creativecommons.org/licenses/by/2.5/"><span style="font-size:x-small">Creative Commons Attribution 2.5 license</span></a><span style="font-size:x-small">, and examples are licensed under the </span><a href="http://src.chromium.org/viewvc/chrome/trunk/src/LICENSE" target="_blank"><span style="font-size:x-small">BSD License</span></a><span style="font-size:x-small">.<br /></span></div></div></div>
</td>
<td id="sites-canvas-wrapper">
<div id="sites-canvas" role="main">
<div id="goog-ws-editor-toolbar-container"> </div>
<div xmlns="http://www.w3.org/1999/xhtml" id="title-crumbs" style="">
<A href="../../developers.1.html" dir="ltr">For Developers</A>‎ &gt; ‎<A href="../crash-reports.1.html" dir="ltr">Crash Reports</A>‎ &gt; ‎
  </div>
<h3 xmlns="http://www.w3.org/1999/xhtml" id="sites-page-title-header" style="" align="left">
<span id="sites-page-title" dir="ltr" tabindex="-1" style="outline: none">Crash with invalid handle</span>
</h3>
<div id="sites-canvas-main" class="sites-canvas-main">
<div id="sites-canvas-main-content">
<table xmlns="http://www.w3.org/1999/xhtml" cellspacing="0" class="sites-layout-name-one-column sites-layout-hbox"><tbody><tr><td class="sites-layout-tile sites-tile-name-content-1"><div dir="ltr"><h2><a name="TOC-What-is-this-crash-about-"></a>What is this crash about?</h2>
<h3><a name="TOC-I-m-seeing-frequent-Chrome-crashes-and-the-stack-looks-like-this:"></a>I'm seeing frequent Chrome crashes and the stack looks like this:</h3>
<blockquote style="margin:0 0 0 40px;border:none;padding:0px">
<div><font face="courier new, monospace">[debugger_win.cc:20 ]           base::debug::BreakDebugger()</font></div>
<div><font face="courier new, monospace">[scoped_handle.cc:79 ]<span style="white-space:pre">          </span>base::win::HandleTraits::CloseHandle()</font></div>
<div><font face="courier new, monospace">[file_win.cc:120 ]              base::File::Close()</font></div>
<div><font face="courier new, monospace">[file_stream_context.cc:184 ]   net::FileStream::Context::CloseFileImpl()</font></div>
<div><font face="courier new, monospace">[bind_internal.h:1169 ]<span style="white-space:pre">         </span>base::internal::Invoker&lt;&gt;::Run()</font></div>
<div><font face="courier new, monospace">[sequenced_worker_pool.cc:760 ]<span style="white-space:pre"> </span>base::SequencedWorkerPool::Inner::ThreadLoop()</font></div>
<div><font face="courier new, monospace">[sequenced_worker_pool.cc:508 ]<span style="white-space:pre"> </span>base::SequencedWorkerPool::Worker::Run()</font></div>
<div><font face="courier new, monospace">[simple_thread.cc:60 ]          base::SimpleThread::ThreadMain()</font></div>
<div><font face="courier new, monospace">[platform_thread_win.cc:78 ]<span style="white-space:pre">    </span>base::`anonymous namespace'::ThreadFunc()</font></div>
<div><font face="courier new, monospace">[kernel32.dll + 0x0004ee1b ]<span style="white-space:pre">    </span>BaseThreadInitThunk</font></div>
<div><font face="courier new, monospace">[ntdll.dll + 0x000637ea ]<span style="white-space:pre">       </span>__RtlUserThreadStart</font></div>
<div><font face="courier new, monospace">[ntdll.dll + 0x000637bd ]       _RtlUserThreadStart</font></div>
</blockquote>
<div><br />
</div>
<div>or like this:</div>
<div><br />
</div>
<blockquote style="margin:0 0 0 40px;border:none;padding:0px">
<div><font face="courier new, monospace">[debugger_win.cc:20 ]<span style="white-space:pre">           </span>base::debug::BreakDebugger()</font></div>
<div><font face="courier new, monospace">[scoped_handle.cc:79 ]<span style="white-space:pre">          </span>base::win::HandleTraits::CloseHandle()</font></div>
<div><font face="courier new, monospace">[scoped_handle.h:52 ]<span style="white-space:pre">           </span>base::win::GenericScopedHandle&lt;&gt;::~GenericScopedHandle&lt;&gt;()</font></div>
<div><font face="courier new, monospace">[handle_watcher.cc:271 ]        mojo::common::WatcherThreadManager::StopWatching()</font></div>
<div><font face="courier new, monospace">[handle_watcher.cc:434 ]        mojo::common::HandleWatcher::SecondaryThreadWatchingState::~SecondaryThreadWatchingState()</font></div>
<div><font face="courier new, monospace">[chrome.dll + 0x00238a03 ]      mojo::common::HandleWatcher::SecondaryThreadWatchingState::`scalar deleting destructor'()</font></div>
</blockquote>
<div><br />
</div>
<div>The relevant part is the first three lines that show that something is being closed and there is an intentional crash because there is an error closing that handle.</div>
<div><br />
</div>
<div>These stacks point to a form of corruption in the past, which is only detected when the invalid handle is being closed. Like most forms of corruption, it is not safe to continue execution at this point, but at the time of the crash there is not enough information to know when (and where) the corruption was introduced.</div>
<div><br />
</div>
<h3><a name="TOC-I-am-seeing-Chrome-hangs-with-stacks-like-this-one:"></a>I am seeing Chrome hangs with stacks like this one:</h3>
<blockquote style="margin:0 0 0 40px;border:none;padding:0px">
<div><font face="courier new, monospace">[ntdll.dll + 0x00040da8 ]<span style="white-space:pre">       </span>ZwWaitForSingleObject</font></div>
<div><font face="courier new, monospace">[KERNELBASE.dll + 0x00001128 ]<span style="white-space:pre">  </span>WaitForSingleObjectEx</font></div>
<div><font face="courier new, monospace">[KERNELBASE.dll + 0x000010b3 ]<span style="white-space:pre">  </span>WaitForSingleObject</font></div>
<div><font face="courier new, monospace">[platform_thread_win.cc:222 ]<span style="white-space:pre">   </span>base::PlatformThread::Join()</font></div>
<div><font face="courier new, monospace">[thread.cc:135 ]<span style="white-space:pre">                </span>base::Thread::Stop()</font></div>
<div><font face="courier new, monospace">[..._process_sub_thread.cc:26 ]<span style="white-space:pre"> </span>content::BrowserProcessSubThread::~BrowserProcessSubThread()</font></div>
<div><font face="courier new, monospace">[chrome.dll + 0x0043dcb8 ]<span style="white-space:pre">      </span>content::BrowserProcessSubThread::`scalar deleting destructor'()</font></div>
<div><font face="courier new, monospace">[browser_main_loop.cc:829 ]<span style="white-space:pre">     </span>content::BrowserMainLoop::ShutdownThreadsAndCleanUp()</font></div>
<div><font face="courier new, monospace">[browser_main_runner.cc:146 ]<span style="white-space:pre">   </span>content::BrowserMainRunnerImpl::Shutdown()</font></div>
<div><font face="courier new, monospace">[browser_main.cc:28 ]<span style="white-space:pre">           </span>content::BrowserMain()</font></div>
</blockquote>
<div><br />
</div>
<div>This is another manifestation of the same underlying issue: once a handle is corrupt, using it can do anything. If the OS detects that the handle is invalid, the operation generally fails right away. However, if the handle now points to something else, operations may appear to work but do something generally unexpected. The code in this example is simply waiting on the wrong object, so most likely it will never be signaled.</div>
<div><br />
</div>
<h2><a name="TOC-What-to-do-about-it"></a>What to do about it</h2>
<div><br />
</div>
<div>We have better detection baked into the 32-bit builds of Dev and Canary builds of Chrome. In that case, the crash stack will hopefully morph into something that points to the code at fault.</div>
<div><br />
</div>
<h3><a name="TOC-For-users:"></a>For users:</h3>
<div>
<ul><li><span style="font-size:10pt;background-color:transparent">Consider installing a <a href="https://www.google.com/chrome/browser/canary.html?platform=win">Canary</a> or <a href="https://www.google.com/chrome/browser/index.html?extra=devchannel&amp;platform=win">Dev</a> Channel Build (Windows only. See <a href="../../getting-involved/dev-channel.1.html">this</a> for information about what a channel is and what to do before installing a new one).</span></li>
<li><span style="font-size:10pt;background-color:transparent">Search your system for malware, and try removing software that interacts directly with Chrome by injecting DLLs. In the past we have seen correlation between 3rd party software loaded into Chrome and problems with invalid handles. You can get a list of all DLLs loaded into the browser by navigating to about:conflicts (note that most likely there are no detected conflicts even if a DLL is causing trouble).</span></li></ul>
</div>
<div><br />
</div>
<h3><a name="TOC-For-bug-triage:"></a>For bug triage:</h3>
<div>
<ul><li><span style="font-size:10pt;background-color:transparent">Close bugs that are reported on the Stable or Beta builds, as there is very little to do. Feel free to point to this page.</span></li>
<li><span style="font-size:10pt;background-color:transparent">If the report comes directly from the stability result of a given version (top x on the crash server), search for a similar report and merge (it may be closed as WontFix). Avoid merging into a user-reported bug (there is a similar report somewhere for something that is internal </span></li>
<li><span style="font-size:10pt;background-color:transparent">The ScopedHandle verifier is far from perfect, so even with a 32-bit build canary build it is bound to generate dumps that follow the same pattern of dumps from Stable. Ignore those reports.</span></li></ul>
</div>
<div><br />
</div>
<h3><a name="TOC-For-developers:"></a>For developers:</h3>
<div><br />
</div>
<div>A Canary build will generate a properly bucketed stack dump like this:</div>
<div><br />
</div>
<blockquote style="margin:0 0 0 40px;border:none;padding:0px">
<div><font face="courier new, monospace">[scoped_handle.cc:145 ]<span style="white-space:pre">         </span>base::win::OnHandleBeingClosed()</font></div>
<div><font face="courier new, monospace">[close_handle_hook_win.cc:27 ]  `anonymous namespace'::CloseHandleHook()</font></div>
<div><font face="courier new, monospace">[shared_memory_win.cc:75 ]      base::SharedMemory::~SharedMemory()</font></div>
<div><font face="courier new, monospace">[resource_buffer.cc:42 ]        content::ResourceBuffer::~ResourceBuffer()</font></div>
<div><font face="courier new, monospace">[ref_counted.h:192 ]<span style="white-space:pre">            </span>base::RefCountedThreadSafe&lt;&gt;::DeleteInternal()</font></div>
<div><font face="courier new, monospace">[async_resource_handler.cc:99 ]<span style="white-space:pre"> </span>content::AsyncResourceHandler::~AsyncResourceHandler()</font></div>
<div><font face="courier new, monospace">[chrome.dll + 0x003af3ae ]      content::AsyncResourceHandler::`scalar deleting destructor'()</font></div>
<div><font face="courier new, monospace">[...ed_resource_handler.cc:19 ]<span style="white-space:pre"> </span>content::LayeredResourceHandler::~LayeredResourceHandler()</font></div>
<div><font face="courier new, monospace">[chrome.dll + 0x003aebc7 ]<span style="white-space:pre">      </span>content::BufferedResourceHandler::`scalar deleting destructor'()</font></div>
<div><font face="courier new, monospace">[...ed_resource_handler.cc:19 ]<span style="white-space:pre"> </span>content::LayeredResourceHandler::~LayeredResourceHandler()</font></div>
<div><font face="courier new, monospace">[chrome.dll + 0x003ae5f8 ]      content::ThrottlingResourceHandler::`scalar deleting destructor'()</font></div>
<div><font face="courier new, monospace">[resource_loader.cc:104 ]       content::ResourceLoader::~ResourceLoader()</font></div>
</blockquote>
<div><br />
</div>
<div>It points to ~SharedMemory as the source of corruption. This means that said code is either double closing a handle somehow (most of the time it is far from obvious how that happens), or it is not really doing anything wrong but it is being blamed anyway. In any case, this code should not be doing manual handle management so it should be refactored to use ScopedHandle instead.</div>
<div><br />
</div>
<div>If there is a bug, it most likely will go away with the refactor. If there was no bug, ScopedHandle verifier will stop blaming this code, and the overall reliability of the verifier will go up.</div>
<div><br />
</div>
<div>
<ul><li><span style="font-size:10pt;background-color:transparent">So the take away is... refactor the code to remove manual handle management. This also means to modify interfaces to remove passing raw handles around and instead pass a ScopedHandle (or something that encapsulates the handle  using a ScopedHandle internally). There's plenty of code to choose from!. See bugs <a href="http://crbug.com/322664">322664</a>, <a href="http://crbug.com/416721">416721</a> or <a href="http://crbug.com/417532">417532</a> for some examples.</span></li>
<li><span style="font-size:10pt;background-color:transparent">Search the crash server for stacks containing OnHandleBeingClosed to get a summary of issues currently detected as problematic.</span></li></ul>
</div>
<div><br />
</div></div></td></tr></tbody></table>
</div> 
</div> 
<div id="sites-canvas-bottom-panel">
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_page-subpages"> </div>
<div id="sites-attachments-container">
</div>
<a xmlns="http://www.w3.org/1999/xhtml" name="page-comments"></a>
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_page-comments"><div class="sites-comment-docos-wrapper"><div class="sites-comment-docos"><div class="sites-comment-docos-background"></div><div class="sites-comment-docos-header"><div class="sites-comment-docos-header-title">Comments</div></div><div id="sites-comment-docos-pane" class="sites-comment-docos-pane"></div></div></div></div>
</div>
</div> 
</td> 
</tr>
</table> 
</div> 
</div> 
<div id="sites-chrome-footer-wrapper">
<div id="sites-chrome-footer-wrapper-inside">
<div id="sites-chrome-footer">
</div>
</div>
</div>
</div> 
</div> 
<div id="sites-chrome-adminfooter-container">
<div xmlns="http://www.w3.org/1999/xhtml" class="sites-adminfooter" role="navigation"><p><a class="sites-system-link" href="https://www.google.com/a/UniversalLogin?service=jotspot&amp;continue=https://sites.google.com/a/chromium.org/dev/developers/crash-reports/crash-with-invalid-handle">Sign in</a><span aria-hidden="true">|</span><a class="sites-system-link" href="../../system/app/pages/recentChanges.html">Recent Site Activity</a><span aria-hidden="true">|</span><a class="sites-system-link" href="../../system/app/pages/reportAbuse.html" target="_blank">Report Abuse</a><span aria-hidden="true">|</span><a class="sites-system-link" href="javascript:;" onclick="window.open(webspace.printUrl)">Print Page</a><span aria-hidden="true">|</span><span class="sites-system-link">Powered By</span> <b class="powered-by"><a href="http://sites.google.com">Google Sites</a></b></p></div>
</div>
</div> 
</div> 
<div id="sites-chrome-onebar-footer">
</div>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
    window.jstiming.load.tick('sjl');
  </script>
<script xmlns="http://www.w3.org/1999/xhtml" src="https://ssl.gstatic.com/sites/p/56e332/system/js/jot_min_view__en.js"></script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
    window.jstiming.load.tick('jl');
  </script>
<script xmlns="http://www.w3.org/1999/xhtml">
      
          sites.core.Analytics.createTracker();
          sites.core.Analytics.trackPageview();
        
    </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
                    sites.Searchbox.initialize(
                        'sites-searchbox-search-button',
                        {"object":[]}['object'],
                        'search-site',
                        {"label":"Configure search options...","url":"/system/app/pages/admin/settings"});
                  </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
      gsites.HoverPopupMenu.createSiteDropdownMenus('sites-header-nav-dropdown', false);
    </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript" defer="true">
            JOT_setupNav("7648876402527094", "Navigation", false);
            JOT_addListener('titleChange', 'JOT_NAVIGATION_titleChange', 'COMP_7648876402527094');
          </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript" defer="true">
            JOT_setupNav("14720868319272995", "Quick links", false);
            JOT_addListener('titleChange', 'JOT_NAVIGATION_titleChange', 'COMP_14720868319272995');
          </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript" defer="true">
            JOT_setupNav("19690813310444355", "Other sites", false);
            JOT_addListener('titleChange', 'JOT_NAVIGATION_titleChange', 'COMP_19690813310444355');
          </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
              new sites.CommentPane('//docs.google.com/comments/d/AAHRpnXvrAwjAfmld0ObrebBiGRq9tICugv-BTV1V-pbMm1VkL1-Zc90qevjThTc_yoKz9Yu6nhXVfAiKFdKvT8kF8L5e3TbqHUZEmXxRtiszeLQrsGXT8xwJOjvQHl4QA0bGJ3HlN4OX/api/js?anon=true',
                  false, false);
            </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
  setTimeout(function() {
    var fingerprint = gsites.date.TimeZone.getFingerprint([]);
    gsites.Xhr.send('https://www.chromium.org/_/tz', null, null, 'GET', null, null, { afjstz: fingerprint });
  }, 500);
</script>
<script xmlns="http://www.w3.org/1999/xhtml">
                    window.onload = function() {
                      if (false) {
                        JOT_setMobilePreview();
                      }
                      var loadTimer = window.jstiming.load;
                      loadTimer.tick("ol");
                      loadTimer["name"] = "load," + webspace.page.type + ",user_page";
                      window.jstiming.report(loadTimer, {}, 'https://gg.google.com/csi');
                    }
                  </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
        JOT_insertAnalyticsCode(false,
            false);
      </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
    var maestroRunner = new gsites.pages.view.SitesMaestroRunner(
        webspace, "en");
    maestroRunner.initListeners();
    maestroRunner.installEditRender();
  </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript" defer="true">
  //<![CDATA[
    // Decorate any fastUI buttons on the page with a class of 'goog-button'.
    if (webspace.user.hasWriteAccess) {
      JOT_decorateButtons();
    }

    // Fires delayed events.
    (function() {
      JOT_fullyLoaded = true;
      var delayedEvents = JOT_delayedEvents;
      for (var x = 0; x < delayedEvents.length; x++) {
        var event = delayedEvents[x];
        JOT_postEvent(event.eventName, event.eventSrc, event.payload);
      }
      JOT_delayedEvents = null;
      JOT_postEvent('pageLoaded');
    })();
  //]]>
</script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
    JOT_postEvent('decorateGvizCharts');
  </script>
<script type="text/javascript">
          JOT_setupPostRenderingManager();
        </script>
<script type="text/javascript">
          JOT_postEvent('renderPlus', null, 'sites-chrome-main');
        </script>
<div id="server-timer-div" style="display:none"> </div>
<script type="text/javascript">
          window.jstiming.load.tick('render');
          JOT_postEvent('usercontentrendered', this);
        </script>
</body>
</html>
