<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/WebPage">
<head>
<meta http-equiv="X-UA-Compatible" content="chrome=1" />
<script type="text/javascript">/* Copyright 2008 Google. */ (function() { var e="wtsrt_",g="tbsd_",h="tbnd_",k="start",l="_wtsrt",m="_tbnd",n="CSI/";(function(){function f(a){this.t={};this.tick=function(a,c,b){this.t[a]=[void 0!=b?b:(new Date).getTime(),c];if(void 0==b)try{window.console.timeStamp(n+a)}catch(d){}};this.tick(k,null,a)}var a;window.performance&&(a=window.performance.timing);var p=a?new f(a.responseStart):new f;window.jstiming={Timer:f,load:p};if(a){var c=a.navigationStart,d=a.responseStart;0<c&&d>=c&&(window.jstiming.srt=d-c)}if(a){var b=window.jstiming.load;0<c&&d>=c&&(b.tick(l,void 0,c),b.tick(e,l,d),b.tick(g,e))}try{a=null,
window.chrome&&window.chrome.csi&&(a=Math.floor(window.chrome.csi().pageT),b&&0<c&&(b.tick(m,void 0,window.chrome.csi().startE),b.tick(h,m,c))),null==a&&window.gtbExternal&&(a=window.gtbExternal.pageT()),null==a&&window.external&&(a=window.external.pageT,b&&0<c&&(b.tick(m,void 0,window.external.startE),b.tick(h,m,c))),a&&(window.jstiming.pt=a)}catch(q){}})(); })()
</script>
<link rel="shortcut icon" href="../../../_/rsrc/1354323194313/favicon.ico" type="image/x-icon" />
<link rel="apple-touch-icon" href="https://ssl.gstatic.com/sites/p/56e332/system/app/images/apple-touch-icon.png" type="image/png" />
<script type="text/javascript">/* Copyright 2008 Google. */ (function() { var d="",g="__duration__",h="function";function k(c){return document.getElementById(c)}window.byId=k;function l(c){return c.replace(/^\s+|\s+$/g,d)}window.trim=l;var m=[],n=0;window.JOT_addListener=function(c,a,b){var e=new String(n++);c={eventName:c,handler:a,compId:b,key:e};m.push(c);return e};window.JOT_removeListenerByKey=function(c){for(var a=0;a<m.length;a++)if(m[a].key==c){m.splice(a,1);break}};
window.JOT_removeAllListenersForName=function(c){for(var a=0;a<m.length;a++)m[a].eventName==c&&m.splice(a,1)};window.JOT_postEvent=function(c,a,b){var e={eventName:c,eventSrc:a||{},payload:b||{}};if(window.JOT_fullyLoaded)for(a=m.length,b=0;b<a&&b<m.length;b++){var f=m[b];f&&f.eventName==c&&(e.listenerCompId=f.compId||d,(f=typeof f.handler==h?f.handler:window[f.handler])&&f(e))}else window.JOT_delayedEvents.push({eventName:c,eventSrc:a,payload:b})};window.JOT_delayedEvents=[];
window.JOT_fullyLoaded=!1;window.JOT_formatRelativeToNow=function(c,a){var b=((new Date).getTime()-c)/6E4;if(1440<=b||0>b)return null;var e=0;60<=b&&(b/=60,e=2);2<=b&&e++;return a?window.JOT_siteRelTimeStrs[e].replace(g,Math.floor(b)):window.JOT_userRelTimeStrs[e].replace(g,Math.floor(b))}; })()
</script>
<script>

  

  var breadcrumbs = [{"path":"/developers","deleted":false,"title":"For Developers","dir":"ltr"},{"path":"/developers/testing","deleted":false,"title":"Testing and infrastructure","dir":"ltr"},{"path":"/developers/testing/isolated-testing","deleted":false,"title":"Isolated Testing","dir":"ltr"},{"path":"/developers/testing/isolated-testing/deterministic-builds","deleted":false,"title":"Deterministic builds","dir":"ltr"}];
  var JOT_clearDotPath = 'https://ssl.gstatic.com/sites/p/56e332/system/app/images/cleardot.gif';

  
  var JOT_userRelTimeStrs = ["a minute ago","__duration__ minutes ago","an hour ago","__duration__ hours ago"];

  
  

  

  var webspace = {"enableAnalytics":true,"pageSharingId":"jotspot_page","enableUniversalAnalytics":false,"sharingPolicy":"OPENED_WITH_INDICATOR","siteTitle":"The Chromium Projects","isStartPageEnabled":true,"adsensePublisherId":null,"features":{"languageSelectDefaultTextSetToDefault":true,"validateClientGvizDataSourceUrls":true,"moreMobileStyleImprovements":true,"newInsertMenuIcons":true,"accessibleSortingButtons":true,"domainAnalyticsInGAOnly":true,"noCaptcha":true,"fileCabinetScreenReaderFix":true,"updatedTosAndPrivacyLinks":null,"pageDrafts":false,"mobileOrientationFix":true,"plusBadge":false,"pdfEmbedSupport":false,"jsClickFix":true},"isPublic":true,"isConsumer":false,"serverFlags":{"cajaBaseUrl":"//www.gstatic.com/caja","cajaDebugMode":false},"onepickBaseUrl":"https://docs.google.com","domainAnalyticsAccountId":"","plusPageId":"","signInUrl":"https://www.google.com/a/SelectSession?continue\u003dhttps://sites.google.com/a/chromium.org/dev/developers/testing/isolated-testing/deterministic-builds\u0026service\u003djotspot","analyticsAccountId":"UA-5484340-1","scottyUrl":"/_/upload","homePath":"/","siteNoticeUrlEnabled":null,"plusPageUrl":"","adsensePromoClickedOrSiteIneligible":true,"csiReportUri":"https://gg.google.com/csi","sharingId":"jotspot","termsUrl":"//www.google.com/intl/en/policies/terms/","gvizVersion":1,"editorResources":{"sitelayout":["https://ssl.gstatic.com/sites/p/56e332/system/app/css/sitelayouteditor.css"],"text":["https://ssl.gstatic.com/sites/p/56e332/system/js/codemirror.js","https://ssl.gstatic.com/sites/p/56e332/system/app/css/codemirror_css.css","https://ssl.gstatic.com/sites/p/56e332/system/js/trog_edit__en.js","https://ssl.gstatic.com/sites/p/56e332/system/app/css/trogedit.css","/_/rsrc/1441580320000/system/app/css/editor.css","https://ssl.gstatic.com/sites/p/56e332/system/app/css/codeeditor.css","/_/rsrc/1441580320000/system/app/css/camelot/editor-jfk-wlb.css"]},"sharingUrlPrefix":"/_/sharing","isAdsenseEnabled":true,"domain":"chromium.org","baseUri":"","name":"dev","siteTemplateId":false,"siteNoticeRevision":null,"siteNoticeUrlAddress":null,"siteNoticeMessage":null,"page":{"isRtlLocale":false,"canDeleteWebspace":null,"isPageDraft":null,"parentPath":"/developers/testing/isolated-testing","parentWuid":"wuid:gx:10f79ca11e86af6","siteLocale":"en","timeZone":"America/Los_Angeles","type":"text","title":"Deterministic builds","locale":"en","wuid":"wuid:gx:7bec90dc8ee6b994","revision":38,"path":"/developers/testing/isolated-testing/deterministic-builds","isSiteRtlLocale":false,"pageInheritsPermissions":null,"name":"deterministic-builds","canChangePath":true,"state":"","properties":{},"bidiEnabled":false,"currentTemplate":{"path":"/system/app/pagetemplates/text","title":"Web Page"}},"canPublishScriptToAnyone":true,"user":{"keyboardShortcuts":true,"sessionIndex":"","guest_":true,"displayNameOrEmail":"guest","userName":"guest","uid":"","renderMobile":false,"domain":"","namespace":"","hasWriteAccess":false,"namespaceUser":false,"primaryEmail":"guest","hasAdminAccess":false},"gadgets":{"baseUri":"/system/app/pages/gadgets"}};
  webspace.page.breadcrumbs = breadcrumbs;

  
  var JOT_siteRelTimeStrs = ["a minute ago","__duration__ minutes ago","an hour ago","__duration__ hours ago"];

</script>
<script type="text/javascript">
                window.jstiming.load.tick('scl');
              </script>
<meta name="title" content="Deterministic builds - The Chromium Projects" />
<meta itemprop="name" content="Deterministic builds - The Chromium Projects" />
<meta property="og:title" content="Deterministic builds - The Chromium Projects" />
<meta name="description" content="Home of the Chromium Open Source Project" />
<meta itemprop="description" content="Home of the Chromium Open Source Project" />
<meta id="meta-tag-description" property="og:description" content="Home of the Chromium Open Source Project" />
<style type="text/css">
</style>
<link rel="stylesheet" type="text/css" href="https://ssl.gstatic.com/sites/p/56e332/system/app/themes/beigeandblue/standard-css-beigeandblue-ltr-ltr.css" />
<link rel="stylesheet" type="text/css" href="../../../_/rsrc/1441580320000/system/app/css/overlay.css%3Fcb=beigeandblueundefineda100%2525%2525150goog-ws-leftthemedefaultstandard.css" />
<link rel="stylesheet" type="text/css" href="../../../_/rsrc/1441580320000/system/app/css/camelot/allthemes-view.css" />
<!--[if IE]>
          <link rel="stylesheet" type="text/css" href="/system/app/css/camelot/allthemes%2die.css" />
        <![endif]-->
<title>Deterministic builds - The Chromium Projects</title>
<meta itemprop="image" content="/_/rsrc/1438879449147/config/customLogo.gif?revision=3" />
<meta property="og:image" content="/_/rsrc/1438879449147/config/customLogo.gif?revision=3" />
<script type="text/javascript">
                window.jstiming.load.tick('cl');
              </script>
</head>
<body xmlns="http://www.google.com/ns/jotspot" id="body" class=" en            ">
<div id="sites-page-toolbar" class="sites-header-divider">
<div xmlns="http://www.w3.org/1999/xhtml" id="sites-status" class="sites-status" style="display:none;"><div id="sites-notice" class="sites-notice" role="status" aria-live="assertive"> </div></div>
</div>
<div id="sites-chrome-everything-scrollbar">
<div id="sites-chrome-everything" class="">
<div id="sites-chrome-page-wrapper" style="direction: ltr">
<div id="sites-chrome-page-wrapper-inside">
<div xmlns="http://www.w3.org/1999/xhtml" id="sites-chrome-header-wrapper" style="height:auto;">
<table id="sites-chrome-header" class="sites-layout-hbox" cellspacing="0" style="height:auto;">
<tr class="sites-header-primary-row" id="sites-chrome-userheader">
<td id="sites-header-title" class="" role="banner"><div class="sites-header-cell-buffer-wrapper"><a href="../../../index.html" id="sites-chrome-userheader-logo"><img id="logo-img-id" src="../../../_/rsrc/1438879449147/config/customLogo.gif%3Frevision=3" alt="The Chromium Projects" class="sites-logo  " /></a><h2><a href="../../../index.html" dir="ltr" id="sites-chrome-userheader-title">The Chromium Projects</a></h2></div></td><td class="sites-layout-searchbox  "><div class="sites-header-cell-buffer-wrapper"><form id="sites-searchbox-form" action="https://www.chromium.org/system/app/pages/search" role="search"><input type="hidden" id="sites-searchbox-scope" name="scope" value="search-site" /><input type="text" id="jot-ui-searchInput" name="q" size="20" value="" aria-label="Search this site" /><div id="sites-searchbox-button-set" class="goog-inline-block"><div role="button" id="sites-searchbox-search-button" class="goog-inline-block jfk-button jfk-button-standard" tabindex="0">Search this site</div></div></form></div></td>
</tr>
<tr class="sites-header-secondary-row" id="sites-chrome-horizontal-nav">
<td colspan="2" id="sites-chrome-header-horizontal-nav-container" role="navigation">
</td>
</tr>
</table>
</div>
<div id="sites-chrome-main-wrapper">
<div id="sites-chrome-main-wrapper-inside">
<table id="sites-chrome-main" class="sites-layout-hbox" cellspacing="0" cellpadding="{scmCellpadding}" border="0">
<tr>
<td id="sites-chrome-sidebar-left" class="sites-layout-sidebar-left initial" style="width:150px">
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_7648876402527094" class="sites-embed" role="navigation"><div class="sites-embed-content sites-sidebar-nav"><ul role="navigation" jotId="navList"><li class="nav-first "><div dir="ltr" style="padding-left: 5px;"><a href="../../../chromium-projects.html" jotId="wuid:gx:10ae433dadbbab13" class="sites-navigation-link">Home</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="../../../Home.1.html" jotId="wuid:gx:43582b9d2029d3af" class="sites-navigation-link">Chromium</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="../../../chromium-os.1.html" jotId="wuid:gx:83df2ab1f8880ba" class="sites-navigation-link">Chromium OS</a></div></li></ul></div></div>
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_14720868319272995" class="sites-embed" role="navigation"><h4 class="sites-embed-title">Quick links</h4><div class="sites-embed-content sites-sidebar-nav"><ul role="navigation" jotId="navList"><li class="nav-first "><div dir="ltr" style="padding-left: 5px;"><a href="../../../for-testers/bug-reporting-guidelines.html" class="sites-navigation-link">Report bugs</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="../../discussion-groups.html" class="sites-navigation-link">Discuss</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="../../../system/app/pages/sitemap/hierarchy.html" jotId="wuid:gx:4b58a9a350ad12f" class="sites-navigation-link">网站地图</a></div></li></ul></div></div>
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_19690813310444355" class="sites-embed" role="navigation"><h4 class="sites-embed-title">Other sites</h4><div class="sites-embed-content sites-sidebar-nav"><ul role="navigation" jotId="navList"><li class="nav-first "><div dir="ltr" style="padding-left: 5px;"><a href="http://blog.chromium.org/" class="sites-navigation-link">Chromium Blog</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="http://code.google.com/chrome/extensions/" class="sites-navigation-link">Google Chrome Extensions</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="https://developers.google.com/chrome/chrome-frame/" class="sites-navigation-link">Google Chrome Frame</a></div></li></ul></div></div>
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_19695218559354544" class="sites-embed" role="complementary"><h4 class="sites-embed-title"></h4><div class="sites-embed-content sites-embed-content-sidebar-textbox"><div dir="ltr"><span style="font-size:x-small">Except as otherwise </span><a href="http://developers.google.com/site-policies.html#restrictions"><span style="font-size:x-small">noted</span></a><span style="font-size:x-small">, the content of this page is licensed under a </span><a href="http://creativecommons.org/licenses/by/2.5/"><span style="font-size:x-small">Creative Commons Attribution 2.5 license</span></a><span style="font-size:x-small">, and examples are licensed under the </span><a href="http://src.chromium.org/viewvc/chrome/trunk/src/LICENSE" target="_blank"><span style="font-size:x-small">BSD License</span></a><span style="font-size:x-small">.<br /></span></div></div></div>
</td>
<td id="sites-canvas-wrapper">
<div id="sites-canvas" role="main">
<div id="goog-ws-editor-toolbar-container"> </div>
<div xmlns="http://www.w3.org/1999/xhtml" id="title-crumbs" style="">
<A href="../../../developers.1.html" dir="ltr">For Developers</A>‎ &gt; ‎<A href="../../testing.1.html" dir="ltr">Testing and infrastructure</A>‎ &gt; ‎<A href="../isolated-testing.1.html" dir="ltr">Isolated Testing</A>‎ &gt; ‎
  </div>
<h3 xmlns="http://www.w3.org/1999/xhtml" id="sites-page-title-header" style="" align="left">
<span id="sites-page-title" dir="ltr" tabindex="-1" style="outline: none">Deterministic builds</span>
</h3>
<div id="sites-canvas-main" class="sites-canvas-main">
<div id="sites-canvas-main-content">
<table xmlns="http://www.w3.org/1999/xhtml" cellspacing="0" class="sites-layout-name-one-column sites-layout-hbox"><tbody><tr><td class="sites-layout-tile sites-tile-name-content-1"><div dir="ltr"><div><div class="sites-embed-align-right-wrapping-on"><div class="sites-embed-border-off sites-embed" style="width:250px;"><div class="sites-embed-content sites-embed-type-toc"><div class="goog-toc sites-embed-toc-maxdepth-6"><p>Contents</p><ol class="goog-toc"><li class="goog-toc"><a href="deterministic-builds.html#TOC-Summary"><strong>1 </strong>Summary</a></li><li class="goog-toc"><a href="deterministic-builds.html#TOC-Goal"><strong>2 </strong>Goal</a><ol class="goog-toc"><li class="goog-toc"><a href="deterministic-builds.html#TOC-Sub-goals"><strong>2.1 </strong>Sub goals</a></li></ol></li><li class="goog-toc"><a href="deterministic-builds.html#TOC-Background"><strong>3 </strong>Background</a></li><li class="goog-toc"><a href="deterministic-builds.html#TOC-Non-Goals"><strong>4 </strong>Non Goals</a></li><li class="goog-toc"><a href="deterministic-builds.html#TOC-Testing-plan"><strong>5 </strong>Testing plan</a></li><li class="goog-toc"><a href="deterministic-builds.html#TOC-General-Challenges"><strong>6 </strong>General Challenges</a><ol class="goog-toc"><li class="goog-toc"><a href="deterministic-builds.html#TOC-Non-determinism-originating-from-the-code-base-itself"><strong>6.1 </strong>Non-determinism originating from the code base itself</a></li><li class="goog-toc"><a href="deterministic-builds.html#TOC-Toolset-and-infrastructure-induced-non-determinism"><strong>6.2 </strong>Toolset and infrastructure induced non-determinism</a></li></ol></li><li class="goog-toc"><a href="deterministic-builds.html#TOC-OS-Specific-Challenges"><strong>7 </strong>OS Specific Challenges</a><ol class="goog-toc"><li class="goog-toc"><a href="deterministic-builds.html#TOC-Windows"><strong>7.1 </strong>Windows</a></li><li class="goog-toc"><a href="deterministic-builds.html#TOC-OSX"><strong>7.2 </strong>OSX</a></li><li class="goog-toc"><a href="deterministic-builds.html#TOC-Linux"><strong>7.3 </strong>Linux</a></li><li class="goog-toc"><a href="deterministic-builds.html#TOC-Android"><strong>7.4 </strong>Android</a></li><li class="goog-toc"><a href="deterministic-builds.html#TOC-iOS"><strong>7.5 </strong>iOS</a></li></ol></li><li class="goog-toc"><a href="deterministic-builds.html#TOC-Example-workflow-on-Windows"><strong>8 </strong>Example workflow on Windows</a></li><li class="goog-toc"><a href="deterministic-builds.html#TOC-Extension-of-the-project"><strong>9 </strong>Extension of the project</a></li></ol></div></div></div></div></div><h2><a name="TOC-Summary"></a>Summary</h2><div>Make Chromium's build process to be deterministic. <span style="font-size:10pt;background-color:transparent">Tracking issue: </span><a href="http://crbug.com/314403" style="font-size:10pt;background-color:transparent">crbug.com/314403</a></div><h2><a name="TOC-Goal"></a>Goal</h2><div><i>Improve cycle time and reduce infrastructure utilization with redundant tasks.</i></div><h3><a name="TOC-Sub-goals"></a>Sub goals</h3><div><ol><li><span style="font-size:10pt;background-color:transparent">Reduce I/O load on the Isolate Server by having deterministic binaries.</span></li><ol><li><span style="font-size:10pt;background-color:transparent">Binaries do not need to be archived if they are already in the Isolate Server cache. If the build is deterministic, this happens frequently.</span></li></ol><li><span style="font-size:10pt;background-color:transparent">Take advantage of native's </span><a href="https://code.google.com/p/swarming/wiki/SwarmingDetailedDesign#Task_deduplication" style="font-size:10pt;background-color:transparent">Swarming task deduplication</a><span style="font-size:10pt;background-color:transparent"> by skipping redundant test executables</span><span style="font-size:10pt;background-color:transparent">.</span></li><ol><li><span style="font-size:10pt;background-color:transparent">If an .isolated task was already run on Swarming with the exact same SHA-1 and it succeeded, <a href="https://code.google.com/p/swarming/wiki/SwarmingUserGuide#Task_idempotency">Swarming returns the cached results immediately</a>.</span></li></ol></ol></div><div><div>So it's actually a 2x multiplier here for each target that becomes deterministic and runs on Swarming. Benefits are both <b>monetary</b> (less hardware is required) and <b>developer time</b> (reduced latency by having less work to do on the TS and CI).</div></div><div><br /></div><div><span style="font-size:10pt;background-color:transparent">We estimate <b>we'd save around &gt;20% of the current testing load. </b></span><span style="font-size:10pt;background-color:transparent">This will result in faster test cycles on the Try Server (TS) and the Continuous Integration (CI) infrastructure. <b>Swarming already dedupe 1~7% of the tasks runtime</b> simply due to incremental builds.</span></div><div><br /></div><h2><a name="TOC-Background"></a>Background</h2><div><i>Test isolation</i> is an on-going effort to generate an exact list of the files needed by a given unit test at runtime. It enables 3 benefits:</div><div><ul><li><span style="font-size:10pt;background-color:transparent">Horizontal scaling by splitting a slow test into multiple shards run concurrently.</span></li><li><span style="font-size:10pt;background-color:transparent">Horizontal scaling by running multiple tests concurrently on multiple bots.</span></li><li><span style="font-size:10pt;background-color:transparent">Multi-OS testing of the same binaries. For example, build once, test on XP, Vista, Win7, Win8, Win10.</span></li></ul></div><div><span style="font-size:10pt;background-color:transparent">Tracking issue: </span><a href="http://crbug.com/98637" style="font-size:10pt;background-color:transparent">crbug.com/98637</a></div><div><br /></div><div><i>Swarming</i> is the task distributor that leverage Test isolation to run tests simultaneously to reduce latency in getting test results.</div><div><br /></div><div>Normal projects do not have deterministic builds and chromium is one example. <i>A deterministic build is not something that happens naturally</i>. It needs to be done. <i>Swarming knows the relationship between an isolated test and the result when run on a bot with specific features. </i><span style="background-color:transparent;font-size:10pt">The specific features are determined by the requests. For example the request may specify bot OS specific version, bitness, metadata like the video card, etc.</span></div><div><br /></div><div>Google internally uses many tricks to achieve similar performance improves at extremely high cache rates: [<a href="http://google-engtools.blogspot.com/2011/08/build-in-cloud-how-build-system-works.html">link</a>]</div><div><br /></div><blockquote style="margin:0 0 0 40px;border:none;padding:0px"><div><i>Building the whole action graph would be wasteful (...), so we will skip executing an action unless one or more of its input files change compared to the previous build. In order to do that we keep track of the content digest of each input file whenever we execute an action. As we mentioned in the previous blog post, we keep track of the content digest of source files and we use the same content digest to track changes to files.</i></div></blockquote><h2><a name="TOC-Non-Goals"></a>Non Goals</h2><div>Make the build deterministic is not a goal in these conditions:</div><div><ul><li>When the absolute path of the base directory is different, e.g. the build will only be deterministic when built from the exact base path. This is simple to do on build slaves, harder for users.</li><ul><li><span style="font-size:10pt;background-color:transparent">This is a problem since build slaves by default embed the builder name in the path, this can be fixed.</span></li></ul><li>For developers. The primary use case is the CI (continuous integration tests) and TS (Try Server, pre-commit tests).</li><li>Content addressed build. A CAB can be built out of a deterministic build but this is not what this effort is about.</li><li>Make the build deterministic on official builds, at least not in the short term. Reproducible build does have security benefits so it can be considered an eventual extension of the project.</li></ul><h2><a name="TOC-Testing-plan"></a>Testing plan</h2><div>Testing is currently with the following pattern:</div><div><div class="sites-codeblock sites-codesnippet-block"><span style="font-size:10pt;background-color:transparent"><code>gclient sync</code></span><br /><span style="font-size:10pt;background-color:transparent"><code>gclient runhooks</code></span><br /><span style="font-size:10pt;background-color:transparent"><code>ninja -C out/Release all</code></span><br /><span style="font-size:10pt;background-color:transparent"><code>mv out out.1</code></span><br /><span style="font-size:10pt;background-color:transparent"><code>gclient runhooks</code></span><br /><span style="font-size:10pt;background-color:transparent"><code>ninja -C out/Release all<br /><a href="https://chromium.googlesource.com/chromium/tools/build/+/master/scripts/slave/recipe_modules/isolate/resources/compare_build_artifacts.py">compare_build_artifacts.py</a> -f out -s out.1</code></span><br /></div></div><div><br /></div><div>Continuous integration testing: <a href="http://build.chromium.org/p/chromium.swarm/waterfall?category=deterministic">http://build.chromium.org/p/chromium.swarm/waterfall?category=deterministic</a></div><div><br /></div><div>Regressions are tracked via a whitelist json file. It is not mandatory yet. It will eventually be.</div></div><h2><a name="TOC-General-Challenges"></a>General Challenges</h2><p>Non-determinism comes from various sources. Here's the principal categories:</p><h3><a name="TOC-Non-determinism-originating-from-the-code-base-itself"></a>Non-determinism originating from the code base itself</h3><div><ul><li><span style="background-color:transparent;font-size:10pt">File paths:</span><span style="background-color:transparent;font-size:10pt"> direct or indirect embedding of non-deterministic source file paths in the final binary; for example use of C/C++ macro __FILE__ with the use of absolute file paths instead of relative file paths.</span></li><li><span style="background-color:transparent"><font size="2">File content references; for example use of C/C++ macro __LINE__, </font>__COUNTER__<font size="2">.</font></span></li><li><span style="background-color:transparent"><font size="2">Timestamps: for example, use of C/C++ macros </font>__DATE__, <font size="2">__TIME__, __TIMESTAMP__, embedding the compilation time in the binary, etc.</font></span></li><li><span style="background-color:transparent;font-size:10pt">Source control metadata: checkout revision number embedded in the binary. That fact the SCM reference changed doesn't mean the content changed and as such shouldn't affect the final binary, except extraneous metadata.</span></li><li><span style="background-color:transparent;font-size:10pt">Build tools: build scripts enumerating a hash table (python dict) without sorting to operate on build outputs.</span></li></ul></div><h3><a name="TOC-Toolset-and-infrastructure-induced-non-determinism"></a>Toolset and infrastructure induced non-determinism</h3><div><ul><li><span style="background-color:transparent;font-size:10pt">Build system non-determinism: this buckets non determinism induced by GYP, ninja or GN and not the underlying toolset nor the source code itself.</span></li><li><span style="background-color:transparent;font-size:10pt">Object files ordering in the final executable and order of dynamic library listing. This can occur in any step or tool working on object files.</span></li><li>Multithreading in the toolset; multi-threaded linking.</li><li><span style="background-color:transparent;font-size:10pt">Caused by the toolset </span><i style="background-color:transparent;font-size:10pt">on purpose</i><span style="background-color:transparent;font-size:10pt">: GUIDs embedded in debug symbols (PDB), timestamps in linked executable. See <a href="https://github.com/google/syzygy/tree/master/syzygy/zap_timestamp">zap_timestamp</a> as a tool to work around Visual Studio limitations.</span></li><li><font size="2" style="background-color:transparent">Between toolsets: the build </font><span style="font-size:10pt;background-color:transparent">determinism</span><font size="2" style="background-color:transparent"> can only be achieved by using the exact same toolset; exact same compiler, linker and ancillary tools. Fighting this is a waste of time, simply stating it here to clarify.</font></li><li><font size="2" style="background-color:transparent">Infrastructure: Local versus remote compilation may (and usually) generate different object files.</font></li></ul><h2><a name="TOC-OS-Specific-Challenges"></a>OS Specific Challenges</h2><div>Each toolset is non-deterministic in different ways so the work has to be redone on each platforms.</div><h3><a name="TOC-Windows"></a>Windows</h3></div><div>Tracking issue: <a href="http://crbug.com/314403">crbug.com/314403</a></div><div>Builder: <a href="http://build.chromium.org/p/chromium.swarm/waterfall?builder=Windows%20deterministic%20build">http://build.chromium.org/p/chromium.swarm/waterfall?builder=Windows%20deterministic%20build</a></div><div><ul><li>Issues seen:</li><ul><li>The manifest XML generated in the PE is not deterministic, its textual format occasionally changes even if the logical content is the same.</li><li>Path casing.</li><li>Objects files are linked by the linker in what seems like a hash table, so changing something as simple as path casing can completely shuffle the order.</li><li>In LTCG/WPO, the linker is dual threaded, so we think it'll be less deterministic.</li></ul><li><a href="https://github.com/google/syzygy/tree/master/syzygy/zap_timestamp">zap_timestamp</a> took care of many issues. The main blockers are x64 and PDBs.</li></ul><h3><a name="TOC-OSX"></a>OSX</h3></div><div>Tracking issue: <a href="http://crbug.com/330262"><span style="font-size:10pt;background-color:transparent">crbug.com/</span><span style="background-color:transparent">330262</span></a></div><div>Builder: <a href="http://build.chromium.org/p/chromium.swarm/waterfall?builder=Mac%20deterministic%20build">http://build.chromium.org/p/chromium.swarm/waterfall?builder=Mac%20deterministic%20build</a></div><div><ul><li>The toolset is heavily non-deterministic.</li><li>The first step is <a href="https://codereview.chromium.org/699083004">ZERO_AR_DATE=1</a> which was reverted due to iOS breakage.</li><li>Even though, it's not sufficient, someone needs close look at Mach-O format.</li></ul><h3><a name="TOC-Linux"></a>Linux</h3><div>Tracking issue: <a href="http://crbug.com/330263">crbug.com/330263</a></div><div>Builder: <a href="http://build.chromium.org/p/chromium.swarm/waterfall?builder=Linux%20deterministic%20build">http://build.chromium.org/p/chromium.swarm/waterfall?builder=Linux%20deterministic%20build</a></div><div><ul><li>Linux is DONE!</li></ul></div><h3><a name="TOC-Android"></a>Android</h3></div><div>Tracking issue: <a href="http://crbug.com/383340">crbug.com/383340</a></div><div>Builder: <a href="http://build.chromium.org/p/chromium.swarm/waterfall?builder=Android%20deterministic%20build">http://build.chromium.org/p/chromium.swarm/waterfall?builder=Android%20deterministic%20build</a></div><div><ul><li>Android is DONE!</li></ul><h3><a name="TOC-iOS"></a>iOS</h3></div><div>Tracking issue: <a href="http://crbug.com/383364"><span style="font-size:10pt;background-color:transparent">crbug.com/</span><span style="background-color:transparent">383364</span></a></div><div>Builder: <a href="http://build.chromium.org/p/chromium.swarm/waterfall?builder=IOS%20deterministic%20build">http://build.chromium.org/p/chromium.swarm/waterfall?builder=IOS%20deterministic%20build</a></div><div><ul><li>Not investigated yet.</li></ul></div><h2><a name="TOC-Example-workflow-on-Windows"></a>Example workflow on Windows</h2><div class="sites-codeblock sites-codesnippet-block"><code># Do a whitespace change foo.cc to force a compilation.</code><br /><code>echo "" &gt;&gt; foo_main.cc<br /></code><br /><code># It recreates the same foo.obj than before since the code didn't change.</code><br /><code>compile foo_main.cc -&gt; foo_main.obj</code><br /><code><br /># This step could be saved by a content-addressed build system, see "extension of the project" below.</code><br /><code>link foo_main.obj -&gt; bar_test.exe</code><br /><code><br /># The binary didn't change, it is not uploaded again, saving both I/O and latency.</code><br /><code>isolate bar_test.exe -&gt; isolateserver</code><br /><code><br /># Swarming immediately return results of the last green build, saving both utilization and latency.</code><br /><code>swarming.py run &lt;sha1 of bar_test.isolated&gt;</code></div><br /><h2><a name="TOC-Extension-of-the-project"></a>Extension of the project</h2>Getting the build system to be content addressed as described in the Google reference above. This is a secondary task. It is out of scope for this project but is a natural extension. This saves on the build process itself at the cost of calculating hashes for each intermediary files. This will be piling on the fact that the build is itself deterministic. This is not worth doing before the build is itself deterministic and this property is enforced. This will save significantly on the build time itself on the build machines.</div></td></tr></tbody></table>
</div> 
</div> 
<div id="sites-canvas-bottom-panel">
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_page-subpages"> </div>
<div id="sites-attachments-container">
</div>
<a xmlns="http://www.w3.org/1999/xhtml" name="page-comments"></a>
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_page-comments"><div class="sites-comment-docos-wrapper"><div class="sites-comment-docos"><div class="sites-comment-docos-background"></div><div class="sites-comment-docos-header"><div class="sites-comment-docos-header-title">Comments</div></div><div id="sites-comment-docos-pane" class="sites-comment-docos-pane"></div></div></div></div>
</div>
</div> 
</td> 
</tr>
</table> 
</div> 
</div> 
<div id="sites-chrome-footer-wrapper">
<div id="sites-chrome-footer-wrapper-inside">
<div id="sites-chrome-footer">
</div>
</div>
</div>
</div> 
</div> 
<div id="sites-chrome-adminfooter-container">
<div xmlns="http://www.w3.org/1999/xhtml" class="sites-adminfooter" role="navigation"><p><a class="sites-system-link" href="https://www.google.com/a/UniversalLogin?service=jotspot&amp;continue=https://sites.google.com/a/chromium.org/dev/developers/testing/isolated-testing/deterministic-builds">Sign in</a><span aria-hidden="true">|</span><a class="sites-system-link" href="../../../system/app/pages/recentChanges.html">Recent Site Activity</a><span aria-hidden="true">|</span><a class="sites-system-link" href="../../../system/app/pages/reportAbuse.html" target="_blank">Report Abuse</a><span aria-hidden="true">|</span><a class="sites-system-link" href="javascript:;" onclick="window.open(webspace.printUrl)">Print Page</a><span aria-hidden="true">|</span><span class="sites-system-link">Powered By</span> <b class="powered-by"><a href="http://sites.google.com">Google Sites</a></b></p></div>
</div>
</div> 
</div> 
<div id="sites-chrome-onebar-footer">
</div>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
    window.jstiming.load.tick('sjl');
  </script>
<script xmlns="http://www.w3.org/1999/xhtml" src="https://ssl.gstatic.com/sites/p/56e332/system/js/jot_min_view__en.js"></script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
    window.jstiming.load.tick('jl');
  </script>
<script xmlns="http://www.w3.org/1999/xhtml">
      
          sites.core.Analytics.createTracker();
          sites.core.Analytics.trackPageview();
        
    </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
                    sites.Searchbox.initialize(
                        'sites-searchbox-search-button',
                        {"object":[]}['object'],
                        'search-site',
                        {"label":"Configure search options...","url":"/system/app/pages/admin/settings"});
                  </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
      gsites.HoverPopupMenu.createSiteDropdownMenus('sites-header-nav-dropdown', false);
    </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript" defer="true">
            JOT_setupNav("7648876402527094", "Navigation", false);
            JOT_addListener('titleChange', 'JOT_NAVIGATION_titleChange', 'COMP_7648876402527094');
          </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript" defer="true">
            JOT_setupNav("14720868319272995", "Quick links", false);
            JOT_addListener('titleChange', 'JOT_NAVIGATION_titleChange', 'COMP_14720868319272995');
          </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript" defer="true">
            JOT_setupNav("19690813310444355", "Other sites", false);
            JOT_addListener('titleChange', 'JOT_NAVIGATION_titleChange', 'COMP_19690813310444355');
          </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
              new sites.CommentPane('//docs.google.com/comments/d/AAHRpnXvrAwjAfmld0ObrebBiGRq9EZ8FD6FJESqSsikCFq43smiuMGCo3DK-NKcFHg_FEAg4H9QkOwnuhbOiTggL8jLT1sNZwDPeKBPugtSmUEP3jf9u0tUkvR4Hb3PnswES9AwCZov6/api/js?anon=true',
                  false, false);
            </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
  setTimeout(function() {
    var fingerprint = gsites.date.TimeZone.getFingerprint([]);
    gsites.Xhr.send('https://www.chromium.org/_/tz', null, null, 'GET', null, null, { afjstz: fingerprint });
  }, 500);
</script>
<script xmlns="http://www.w3.org/1999/xhtml">
                    window.onload = function() {
                      if (false) {
                        JOT_setMobilePreview();
                      }
                      var loadTimer = window.jstiming.load;
                      loadTimer.tick("ol");
                      loadTimer["name"] = "load," + webspace.page.type + ",user_page";
                      window.jstiming.report(loadTimer, {}, 'https://gg.google.com/csi');
                    }
                  </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
        JOT_insertAnalyticsCode(false,
            false);
      </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
    var maestroRunner = new gsites.pages.view.SitesMaestroRunner(
        webspace, "en");
    maestroRunner.initListeners();
    maestroRunner.installEditRender();
  </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript" defer="true">
  //<![CDATA[
    // Decorate any fastUI buttons on the page with a class of 'goog-button'.
    if (webspace.user.hasWriteAccess) {
      JOT_decorateButtons();
    }

    // Fires delayed events.
    (function() {
      JOT_fullyLoaded = true;
      var delayedEvents = JOT_delayedEvents;
      for (var x = 0; x < delayedEvents.length; x++) {
        var event = delayedEvents[x];
        JOT_postEvent(event.eventName, event.eventSrc, event.payload);
      }
      JOT_delayedEvents = null;
      JOT_postEvent('pageLoaded');
    })();
  //]]>
</script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
    JOT_postEvent('decorateGvizCharts');
  </script>
<script type="text/javascript">
          JOT_setupPostRenderingManager();
        </script>
<script type="text/javascript">
          JOT_postEvent('renderPlus', null, 'sites-chrome-main');
        </script>
<div id="server-timer-div" style="display:none"> </div>
<script type="text/javascript">
          window.jstiming.load.tick('render');
          JOT_postEvent('usercontentrendered', this);
        </script>
</body>
</html>
