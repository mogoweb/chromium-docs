<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/WebPage">
<head>
<meta http-equiv="X-UA-Compatible" content="chrome=1" />
<script type="text/javascript">/* Copyright 2008 Google. */ (function() { var e="wtsrt_",g="tbsd_",h="tbnd_",k="start",l="_wtsrt",m="_tbnd",n="CSI/";(function(){function f(a){this.t={};this.tick=function(a,c,b){this.t[a]=[void 0!=b?b:(new Date).getTime(),c];if(void 0==b)try{window.console.timeStamp(n+a)}catch(d){}};this.tick(k,null,a)}var a;window.performance&&(a=window.performance.timing);var p=a?new f(a.responseStart):new f;window.jstiming={Timer:f,load:p};if(a){var c=a.navigationStart,d=a.responseStart;0<c&&d>=c&&(window.jstiming.srt=d-c)}if(a){var b=window.jstiming.load;0<c&&d>=c&&(b.tick(l,void 0,c),b.tick(e,l,d),b.tick(g,e))}try{a=null,
window.chrome&&window.chrome.csi&&(a=Math.floor(window.chrome.csi().pageT),b&&0<c&&(b.tick(m,void 0,window.chrome.csi().startE),b.tick(h,m,c))),null==a&&window.gtbExternal&&(a=window.gtbExternal.pageT()),null==a&&window.external&&(a=window.external.pageT,b&&0<c&&(b.tick(m,void 0,window.external.startE),b.tick(h,m,c))),a&&(window.jstiming.pt=a)}catch(q){}})(); })()
</script>
<link rel="shortcut icon" href="/_/rsrc/1354323194313/favicon.ico" type="image/x-icon" />
<link rel="apple-touch-icon" href="https://ssl.gstatic.com/sites/p/56e332/system/app/images/apple-touch-icon.png" type="image/png" />
<script type="text/javascript">/* Copyright 2008 Google. */ (function() { var d="",g="__duration__",h="function";function k(c){return document.getElementById(c)}window.byId=k;function l(c){return c.replace(/^\s+|\s+$/g,d)}window.trim=l;var m=[],n=0;window.JOT_addListener=function(c,a,b){var e=new String(n++);c={eventName:c,handler:a,compId:b,key:e};m.push(c);return e};window.JOT_removeListenerByKey=function(c){for(var a=0;a<m.length;a++)if(m[a].key==c){m.splice(a,1);break}};
window.JOT_removeAllListenersForName=function(c){for(var a=0;a<m.length;a++)m[a].eventName==c&&m.splice(a,1)};window.JOT_postEvent=function(c,a,b){var e={eventName:c,eventSrc:a||{},payload:b||{}};if(window.JOT_fullyLoaded)for(a=m.length,b=0;b<a&&b<m.length;b++){var f=m[b];f&&f.eventName==c&&(e.listenerCompId=f.compId||d,(f=typeof f.handler==h?f.handler:window[f.handler])&&f(e))}else window.JOT_delayedEvents.push({eventName:c,eventSrc:a,payload:b})};window.JOT_delayedEvents=[];
window.JOT_fullyLoaded=!1;window.JOT_formatRelativeToNow=function(c,a){var b=((new Date).getTime()-c)/6E4;if(1440<=b||0>b)return null;var e=0;60<=b&&(b/=60,e=2);2<=b&&e++;return a?window.JOT_siteRelTimeStrs[e].replace(g,Math.floor(b)):window.JOT_userRelTimeStrs[e].replace(g,Math.floor(b))}; })()
</script>
<script>

  

  var breadcrumbs = [{"path":"/chromium-os","deleted":false,"title":"Chromium OS","dir":"ltr"},{"path":"/chromium-os/gentoo-package-upgrade-process","deleted":false,"title":"Portage New \u0026 Upgrade Package Process","dir":"ltr"}];
  var JOT_clearDotPath = 'https://ssl.gstatic.com/sites/p/56e332/system/app/images/cleardot.gif';

  
  var JOT_userRelTimeStrs = ["a minute ago","__duration__ minutes ago","an hour ago","__duration__ hours ago"];

  
  

  

  var webspace = {"enableAnalytics":true,"pageSharingId":"jotspot_page","enableUniversalAnalytics":false,"sharingPolicy":"OPENED_WITH_INDICATOR","siteTitle":"The Chromium Projects","isStartPageEnabled":true,"adsensePublisherId":null,"features":{"languageSelectDefaultTextSetToDefault":true,"validateClientGvizDataSourceUrls":true,"moreMobileStyleImprovements":true,"newInsertMenuIcons":true,"accessibleSortingButtons":true,"domainAnalyticsInGAOnly":true,"noCaptcha":true,"fileCabinetScreenReaderFix":true,"updatedTosAndPrivacyLinks":null,"pageDrafts":false,"mobileOrientationFix":true,"plusBadge":false,"pdfEmbedSupport":false,"jsClickFix":true},"isPublic":true,"isConsumer":false,"serverFlags":{"cajaBaseUrl":"//www.gstatic.com/caja","cajaDebugMode":false},"onepickBaseUrl":"https://docs.google.com","domainAnalyticsAccountId":"","plusPageId":"","signInUrl":"https://www.google.com/a/SelectSession?continue\u003dhttps://sites.google.com/a/chromium.org/dev/chromium-os/gentoo-package-upgrade-process\u0026service\u003djotspot","analyticsAccountId":"UA-5484340-1","scottyUrl":"/_/upload","homePath":"/","siteNoticeUrlEnabled":null,"plusPageUrl":"","adsensePromoClickedOrSiteIneligible":true,"csiReportUri":"https://gg.google.com/csi","sharingId":"jotspot","termsUrl":"//www.google.com/intl/en/policies/terms/","gvizVersion":1,"editorResources":{"sitelayout":["https://ssl.gstatic.com/sites/p/56e332/system/app/css/sitelayouteditor.css"],"text":["https://ssl.gstatic.com/sites/p/56e332/system/js/codemirror.js","https://ssl.gstatic.com/sites/p/56e332/system/app/css/codemirror_css.css","https://ssl.gstatic.com/sites/p/56e332/system/js/trog_edit__en.js","https://ssl.gstatic.com/sites/p/56e332/system/app/css/trogedit.css","/_/rsrc/1441580320000/system/app/css/editor.css","https://ssl.gstatic.com/sites/p/56e332/system/app/css/codeeditor.css","/_/rsrc/1441580320000/system/app/css/camelot/editor-jfk-wlb.css"]},"sharingUrlPrefix":"/_/sharing","isAdsenseEnabled":true,"domain":"chromium.org","baseUri":"","name":"dev","siteTemplateId":false,"siteNoticeRevision":null,"siteNoticeUrlAddress":null,"siteNoticeMessage":null,"page":{"isRtlLocale":false,"canDeleteWebspace":null,"isPageDraft":null,"parentPath":"/chromium-os","parentWuid":"wuid:gx:83df2ab1f8880ba","siteLocale":"en","timeZone":"America/Los_Angeles","type":"text","title":"Portage New \u0026 Upgrade Package Process","locale":"en","wuid":"wuid:gx:27195f520abe5fcb","revision":66,"path":"/chromium-os/gentoo-package-upgrade-process","isSiteRtlLocale":false,"pageInheritsPermissions":null,"name":"gentoo-package-upgrade-process","canChangePath":true,"state":"","properties":{},"bidiEnabled":false,"currentTemplate":{"path":"/system/app/pagetemplates/text","title":"Web Page"}},"canPublishScriptToAnyone":true,"user":{"keyboardShortcuts":true,"sessionIndex":"","guest_":true,"displayNameOrEmail":"guest","userName":"guest","uid":"","renderMobile":false,"domain":"","namespace":"","hasWriteAccess":false,"namespaceUser":false,"primaryEmail":"guest","hasAdminAccess":false},"gadgets":{"baseUri":"/system/app/pages/gadgets"}};
  webspace.page.breadcrumbs = breadcrumbs;

  
  var JOT_siteRelTimeStrs = ["a minute ago","__duration__ minutes ago","an hour ago","__duration__ hours ago"];

</script>
<script type="text/javascript">
                window.jstiming.load.tick('scl');
              </script>
<meta name="title" content="Portage New &amp; Upgrade Package Process - The Chromium Projects" />
<meta itemprop="name" content="Portage New &amp; Upgrade Package Process - The Chromium Projects" />
<meta property="og:title" content="Portage New &amp; Upgrade Package Process - The Chromium Projects" />
<meta name="description" content="Home of the Chromium Open Source Project" />
<meta itemprop="description" content="Home of the Chromium Open Source Project" />
<meta id="meta-tag-description" property="og:description" content="Home of the Chromium Open Source Project" />
<style type="text/css">
</style>
<link rel="stylesheet" type="text/css" href="https://ssl.gstatic.com/sites/p/56e332/system/app/themes/beigeandblue/standard-css-beigeandblue-ltr-ltr.css" />
<link rel="stylesheet" type="text/css" href="/_/rsrc/1441580320000/system/app/css/overlay.css?cb=beigeandblueundefineda100%25%25150goog-ws-leftthemedefaultstandard" />
<link rel="stylesheet" type="text/css" href="/_/rsrc/1441580320000/system/app/css/camelot/allthemes-view.css" />
<!--[if IE]>
          <link rel="stylesheet" type="text/css" href="/system/app/css/camelot/allthemes%2die.css" />
        <![endif]-->
<title>Portage New &amp; Upgrade Package Process - The Chromium Projects</title>
<meta itemprop="image" content="/_/rsrc/1438879449147/config/customLogo.gif?revision=3" />
<meta property="og:image" content="/_/rsrc/1438879449147/config/customLogo.gif?revision=3" />
<script type="text/javascript">
                window.jstiming.load.tick('cl');
              </script>
</head>
<body xmlns="http://www.google.com/ns/jotspot" id="body" class=" en            ">
<div id="sites-page-toolbar" class="sites-header-divider">
<div xmlns="http://www.w3.org/1999/xhtml" id="sites-status" class="sites-status" style="display:none;"><div id="sites-notice" class="sites-notice" role="status" aria-live="assertive"> </div></div>
</div>
<div id="sites-chrome-everything-scrollbar">
<div id="sites-chrome-everything" class="">
<div id="sites-chrome-page-wrapper" style="direction: ltr">
<div id="sites-chrome-page-wrapper-inside">
<div xmlns="http://www.w3.org/1999/xhtml" id="sites-chrome-header-wrapper" style="height:auto;">
<table id="sites-chrome-header" class="sites-layout-hbox" cellspacing="0" style="height:auto;">
<tr class="sites-header-primary-row" id="sites-chrome-userheader">
<td id="sites-header-title" class="" role="banner"><div class="sites-header-cell-buffer-wrapper"><a href="https://www.chromium.org/" id="sites-chrome-userheader-logo"><img id="logo-img-id" src="/_/rsrc/1438879449147/config/customLogo.gif?revision=3" alt="The Chromium Projects" class="sites-logo  " /></a><h2><a href="https://www.chromium.org/" dir="ltr" id="sites-chrome-userheader-title">The Chromium Projects</a></h2></div></td><td class="sites-layout-searchbox  "><div class="sites-header-cell-buffer-wrapper"><form id="sites-searchbox-form" action="/system/app/pages/search" role="search"><input type="hidden" id="sites-searchbox-scope" name="scope" value="search-site" /><input type="text" id="jot-ui-searchInput" name="q" size="20" value="" aria-label="Search this site" /><div id="sites-searchbox-button-set" class="goog-inline-block"><div role="button" id="sites-searchbox-search-button" class="goog-inline-block jfk-button jfk-button-standard" tabindex="0">Search this site</div></div></form></div></td>
</tr>
<tr class="sites-header-secondary-row" id="sites-chrome-horizontal-nav">
<td colspan="2" id="sites-chrome-header-horizontal-nav-container" role="navigation">
</td>
</tr>
</table>
</div>
<div id="sites-chrome-main-wrapper">
<div id="sites-chrome-main-wrapper-inside">
<table id="sites-chrome-main" class="sites-layout-hbox" cellspacing="0" cellpadding="{scmCellpadding}" border="0">
<tr>
<td id="sites-chrome-sidebar-left" class="sites-layout-sidebar-left initial" style="width:150px">
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_7648876402527094" class="sites-embed" role="navigation"><div class="sites-embed-content sites-sidebar-nav"><ul role="navigation" jotId="navList"><li class="nav-first "><div dir="ltr" style="padding-left: 5px;"><a href="/chromium-projects" jotId="wuid:gx:10ae433dadbbab13" class="sites-navigation-link">Home</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="/Home" jotId="wuid:gx:43582b9d2029d3af" class="sites-navigation-link">Chromium</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="/chromium-os" jotId="wuid:gx:83df2ab1f8880ba" class="sites-navigation-link">Chromium OS</a></div></li></ul></div></div>
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_14720868319272995" class="sites-embed" role="navigation"><h4 class="sites-embed-title">Quick links</h4><div class="sites-embed-content sites-sidebar-nav"><ul role="navigation" jotId="navList"><li class="nav-first "><div dir="ltr" style="padding-left: 5px;"><a href="http://www.chromium.org/for-testers/bug-reporting-guidelines" class="sites-navigation-link">Report bugs</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="http://www.chromium.org/developers/discussion-groups" class="sites-navigation-link">Discuss</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="/system/app/pages/sitemap/hierarchy" jotId="wuid:gx:4b58a9a350ad12f" class="sites-navigation-link">网站地图</a></div></li></ul></div></div>
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_19690813310444355" class="sites-embed" role="navigation"><h4 class="sites-embed-title">Other sites</h4><div class="sites-embed-content sites-sidebar-nav"><ul role="navigation" jotId="navList"><li class="nav-first "><div dir="ltr" style="padding-left: 5px;"><a href="http://blog.chromium.org/" class="sites-navigation-link">Chromium Blog</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="http://code.google.com/chrome/extensions/" class="sites-navigation-link">Google Chrome Extensions</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="https://developers.google.com/chrome/chrome-frame/" class="sites-navigation-link">Google Chrome Frame</a></div></li></ul></div></div>
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_19695218559354544" class="sites-embed" role="complementary"><h4 class="sites-embed-title"></h4><div class="sites-embed-content sites-embed-content-sidebar-textbox"><div dir="ltr"><span style="font-size:x-small">Except as otherwise </span><a href="http://developers.google.com/site-policies.html#restrictions"><span style="font-size:x-small">noted</span></a><span style="font-size:x-small">, the content of this page is licensed under a </span><a href="http://creativecommons.org/licenses/by/2.5/"><span style="font-size:x-small">Creative Commons Attribution 2.5 license</span></a><span style="font-size:x-small">, and examples are licensed under the </span><a href="http://src.chromium.org/viewvc/chrome/trunk/src/LICENSE" target="_blank"><span style="font-size:x-small">BSD License</span></a><span style="font-size:x-small">.<br /></span></div></div></div>
</td>
<td id="sites-canvas-wrapper">
<div id="sites-canvas" role="main">
<div id="goog-ws-editor-toolbar-container"> </div>
<div xmlns="http://www.w3.org/1999/xhtml" id="title-crumbs" style="">
<A href="/chromium-os" dir="ltr">Chromium OS</A>‎ &gt; ‎
  </div>
<h3 xmlns="http://www.w3.org/1999/xhtml" id="sites-page-title-header" style="" align="left">
<span id="sites-page-title" dir="ltr" tabindex="-1" style="outline: none">Portage New &amp; Upgrade Package Process</span>
</h3>
<div id="sites-canvas-main" class="sites-canvas-main">
<div id="sites-canvas-main-content">
<table xmlns="http://www.w3.org/1999/xhtml" cellspacing="0" class="sites-layout-name-one-column sites-layout-hbox"><tbody><tr><td class="sites-layout-tile sites-tile-name-content-1"><div dir="ltr"><div class="sites-embed-align-right-wrapping-on"><div class="sites-embed-border-off sites-embed" style="width:250px;"><div class="sites-embed-content sites-embed-type-toc"><div class="goog-toc sites-embed-toc-maxdepth-6"><p>Contents</p><ol class="goog-toc"><li class="goog-toc"><a href="#TOC-Purpose"><strong>1 </strong>Purpose</a></li><li class="goog-toc"><a href="#TOC-Quickstart"><strong>2 </strong>Quickstart</a></li><li class="goog-toc"><a href="#TOC-Assumptions"><strong>3 </strong>Assumptions</a></li><li class="goog-toc"><a href="#TOC-Brief-Background"><strong>4 </strong>Brief Background</a></li><li class="goog-toc"><a href="#TOC-The-Steps"><strong>5 </strong>The Steps</a><ol class="goog-toc"><li class="goog-toc"><a href="#TOC-Plan-your-upgrade"><strong>5.1 </strong>Plan your upgrade</a></li><li class="goog-toc"><a href="#TOC-Prepare-Environment"><strong>5.2 </strong>Prepare Environment</a></li><li class="goog-toc"><a href="#TOC-Upgrade-Locally"><strong>5.3 </strong>Upgrade Locally</a></li><li class="goog-toc"><a href="#TOC-Clean-up-Commit"><strong>5.4 </strong>Clean up Commit</a></li><li class="goog-toc"><a href="#TOC-Testing"><strong>5.5 </strong>Testing</a></li><li class="goog-toc"><a href="#TOC-Uploading"><strong>5.6 </strong>Uploading</a></li><li class="goog-toc"><a href="#TOC-Clean-up-Environment"><strong>5.7 </strong>Clean up Environment</a></li></ol></li><li class="goog-toc"><a href="#TOC-Appendices"><strong>6 </strong>Appendices</a><ol class="goog-toc"><li class="goog-toc"><a href="#TOC-Re-applying-a-patch-after-upgrade"><strong>6.1 </strong>Re-applying a patch after upgrade</a></li><li class="goog-toc"><a href="#TOC-Handling-eclasses"><strong>6.2 </strong>Handling eclasses</a></li><li class="goog-toc"><a href="#AppendixUnstableVersion"><strong>6.3 </strong>Upgrading to unstable version</a></li></ol></li><li class="goog-toc"><a href="#TOC-FAQ"><strong>7 </strong>FAQ</a></li></ol></div></div></div></div>
<h3><a name="TOC-Purpose"></a>Purpose</h3>
<p>This page documents the process of upgrading a Portage package in our source to the latest upstream version, or for pulling in a new package that doesn't yet exist (since that's the same thing as upgrading from version &lt;none&gt;).  These instructions are intended for Chromium OS developers.</p>
<p>The upgrade process documented here uses a script, called cros_portage_upgrade, developed to help automate/simplify this process.  It is not required that you use this script, and if you are confident that you can update packages in another way you are free to do so.  Some of the FAQ on this page may still be of use to you, in any case.</p>
<h3><a name="TOC-Quickstart"></a>Quickstart</h3>
<p>A quick reminder of the steps to perform in your chroot set up per <a href="http://www.chromium.org/chromium-os/developer-guide" style="background-color:transparent;font-size:10pt">Chromium OS Developer Guide</a><span style="background-color:transparent;font-size:10pt">:</span></p>
<div>
<ol><li>Enter chroot: <font face="courier new, monospace"><b>$REPO/chromite/bin/cros_sdk</b></font></li>
<li>Set up boards to test on: <font face="courier new, monospace"><b>~/trunk/src/scripts/setup_board --board=daisy</b></font></li>
<li>Start a new git branch in portage-stable repo:<br />
<b>    </b><font face="courier new, monospace"><b>cd ~/trunk/src/third_party/portage-stable<br />
  git checkout -b NEWBRANCH --track remotes/cros/master </b></font></li>
<li>Upgrade package locally:<br />
<font face="monospace">  </font><font face="courier new, monospace" size="2"><b>cros_portage_upgrade --upgrade --board=&lt;board&gt;:&lt;board&gt;... some_package1 some_package2 ...</b></font></li>
<li>Repeat previous step as needed, fixing any upgrade errors that appear.</li>
<li>Test. Yes. Really. You.</li>
<li>Add BUG/TEST fields to commit message: <font face="courier new, monospace"><b>git commit --amend</b></font></li>
<li>upload change for review:  <b style="font-family:courier new,monospace">repo upload .</b></li>
<li>And later, abandon branch: <font face="courier new, monospace"><b>git branch -D NEWBRANCH</b></font><br />
  </li>
</ol>
</div>
<h3><a name="TOC-Assumptions"></a>Assumptions</h3>
<p>The following assumptions are made with these instructions:</p>
<ul><li>You know which package or packages you want to upgrade.</li>
<li>You know how you intend to specifically test the package(s) after the upgrade (beyond the basic smoke tests).</li>
<li>You are familiar with the build environment from a developer perspective.  You know how to start branches, amend commits, upload commits, end branches, etc.  See the <a href="http://www.chromium.org/chromium-os/developer-guide">Chromium OS Developer Guide</a>.</li></ul>
<h3><a name="TOC-Brief-Background"></a>Brief Background</h3>
<p>Any Portage packages, upstream included, can be marked as stable or unstable for any architecture.  You don't have to know anything more about this detail unless you need to upgrade a package to an unstable version.  However, this happens somewhat frequently.  Perhaps a feature you need is only available in the absolute latest version of a package, but that version has not been marked stable for x86, yet.  If you do need to upgrade to an unstable version check the appendix entry below.</p>
<p>The chromiumos source has projects that are portage "overlays", all under <font face="monospace">src/third_party</font>.  Three of them are of interest here.</p>
<ol><li>The <font face="monospace">src/third_party/portage</font> overlay represents a snapshot of the upstream Portage source.  Currently the snapshot is really old but there is a project underway to update it more regularly.  This overlay used to serve as the default source for all Portage packages that we use.  Now it serves as an upstream reference snapshot and nothing more.</li>
<li>The <font face="monospace">src/third_party/portage-stable</font> overlay has copies of all upstream Portage packages that we use unaltered.  When we "upgrade" a package, what we are really doing is putting a copy of the current upstream package into this overlay.</li>
<li>The <font face="monospace">src/third_party/chromiumos-overlay</font> is probably familiar to you.  For package upgrade purposes, it will only be used in the following scenario:</li>
<ol>
<li>If a package is locally patched before the upgrade, then you will probably have to port the local patch to the newer version as well.  That should be done in this overlay.</li>
</ol>
</ol>
<h3><a name="TOC-The-Steps"></a>The Steps</h3>
<h4><a name="TOC-Plan-your-upgrade"></a>Plan your upgrade</h4>
<p>Check the <a href="https://spreadsheets1.google.com/a/chromium.org/spreadsheet/ccc?key=tJuuSuHmrEMqdL5b8dkgBIA">package status spreadsheet</a> and write down which package or packages you want to upgrade, using their full "category/package" name (e.g. sys-apps/dbus).  Decide whether you want to upgrade them to the latest stable or unstable versions.  Generally, your first choice should be to upgrade packages to the latest <b>stable</b> upstream version.</p>
<p>Note whether any of the packages you need to upgrade are locally patched (as indicated in the spreadsheet).  This means that somebody, possibly you, has made a patch to the package that we are using right now.  It is important to determine what should happen to that patch after the upgrade.  Inspect the git history for the patch, talk to the committer, inspect the patch, etc.</p>
<div>
<ul><li>If the patch was done to backport a change from upstream, then simply updating the package to the upstream version should be sufficient and the patch can be ignored.  Be sure to confirm which version the patch was backported from.</li>
<li>If the patch is still required, then you will have to re-apply the patch after the upgrade.  Go through the upgrade process, except for the final testing and uploading.  Then follow the <a href="#AppendixReapplyPatch">guidelines for re-applying a patch</a> below.</li></ul>
</div>
<p>Decide which boards you want to try the upgrade for.  You should include<b> one board from each supported arch type</b> (e.g. amd64, arm, x86), unless the package is only used on one arch for some reason (check the spreadsheet).  Typically, there is no reason to specify more than one board per architecture type, unless you know of board-specific testing that must be done.  If your package or packages are used on the host (see spreadsheet), then you want to upgrade for the host (which can be done at the same time as the boards).  Many packages are used on a chromeos board as well as the host (the "host" is the chroot environment).  Choose boards that you can test the upgrades on, or boards that you know the packages need to be tested on.</p>
<h4><a name="TOC-Prepare-Environment"></a>Prepare Environment</h4>
<p>You probably want to 'repo sync' your entire source tree.</p>
<div>
<div class="sites-codeblock sites-codesnippet-block"><code>cd ~/chromiumos &amp;&amp; repo sync -j 4</code></div>
</div>
<p>Prepare a new branch in the src/third_party/portage-stable project.  This is where the upgrades will be staged/committed.</p>
<div>
<div class="sites-codeblock sites-codesnippet-block"><code>cd ~/chromiumos/src/third_party/portage-stable &amp;&amp; repo start pkg_upgrade .</code></div>
</div>
<p>Now you need to setup all boards that you will need.  Note: this is not required if you're upgrading a host-only package.</p>
<div></div>
<div class="sites-codeblock sites-codesnippet-block">
<div><code>cros_sdk --enter</code></div>
<div><span style="color:rgb(0,96,0);line-height:1;font-size:10pt"><code>./setup_board --board=x86-generic</code></span></div>
<div><code>./setup_board --board=link</code></div>
<div><code>./setup_board --board=daisy</code></div>
</div>
<h4><a name="TOC-Upgrade-Locally"></a>Upgrade Locally</h4>
<p>For these instructions, let's say you want to upgrade "media-libs/alsa-lib", "media-sound/alsa-headers", and "media-sound/alsa-utils" on boards "x86-generic" and "daisy".  You plan to try the stable upstream versions first.  These commands must be run from <b>within your chroot</b>.  If you also need to upgrade on the host (chroot/amd64) use the <font face="monospace">--host</font> option, which can be used in combination with the <font face="monospace">--board</font> option or without it.</p>
<div>
<div class="sites-codeblock sites-codesnippet-block"><code>cros_portage_upgrade --upgrade --board=x86-generic:daisy </code><code>media-libs/alsa-lib </code><code>media-sound/alsa-headers </code><code>media-sound/alsa-utils</code></div>
</div>
<p>If the script runs all the way through without any problems the first time then you have no missing dependencies or other build-related obstacles to the upgrade.  But you still need to test the upgrade results!  The upgrade should be prepared as a commit in <font face="monospace">src/third_party/portage-stable</font>.  You should inspect/edit the commit message before uploading it, though.</p>
<p>If the script does not run all the way through the first time, it should give you the means to determine why.  Typically, this means that one or more of the upgraded packages could not be built (using emerge) after the upgrade.  This may be due to a package dependency that must also be upgraded, or a package mask that must be edited.  In any case, you are given the output of the failing emerge command so that you can determine for yourself what is needed.  Make the necessary change (perhaps adding another package to upgrade at the command line), then run again.</p>
<p>To upgrade to unstable versions, simply add the <font face="monospace">--unstable-ok</font> option and follow the instructions.  Or see the <a href="https://www.chromium.org/chromium-os/gentoo-package-upgrade-process#AppendixUnstableVersion">guidelines for upgrading to unstable versions</a> below.</p>
<div></div>
<p>Run cros_portage_upgrade with <font face="monospace">--help</font> to see addition options and usage.  If you are having difficultly with this step please do not hesitate to contact chromium-os-dev@chromium.org for assistance.</p>
<h4><a name="TOC-Clean-up-Commit"></a>Clean up Commit</h4>
<div>
<p>You may also need to clean up the files in your commit.  Our convention is to only check in files that are used, and some upgrades come with extra files (such as unused patch files, for example).  You can usually tell by inspecting the list of files and the ebuild whether any files are unused.  You can remove these files from your commit with a command like the following within portage-stable:</p>
<div>
<div class="sites-codeblock sites-codesnippet-block"><code>git reset HEAD~ &lt;filepath&gt; ; rm &lt;filepath&gt; ; git commit --amend</code></div>
</div>
</div>
<p>If you already built your upgraded package, make sure to do it again after cleaning up extraneous files to verify that you haven't removed something important!</p>
<h4><a name="TOC-Testing"></a>Testing</h4>
<p>Use common sense, and your specific expertise, to test the upgraded packages.  The changes are active in your source right now, so you can build your target boards to test.  If your package is added to the host (chroot) you'll need to emerge it onto your chroot and test it there as well.</p>
<p>You probably want to run at least the suite:smoke tests for each board, which you can do by following the tips at <a href="https://www.chromium.org/chromium-os/testing">https://sites.google.com/a/chromium.org/dev/chromium-os/testing</a> (Googlers may also use the tips at <a href="http://goto/cros_test">goto/cros-test</a>).  In particular, you can use <a href="https://www.chromium.org/chromium-os/build/local-trybot-documentation">trybot</a> to determine what effect your upgrade will have on the greenness of the waterfall.</p>
<p>Beyond the suite:smoke tests, test whatever you think makes sense given the packages you just upgraded.</p>
<h4><a name="TOC-Uploading"></a>Uploading</h4>
<p>When you are satisfied that the upgrade is safe to push, <b>you still need to edit the commit message that was created for you</b> by cros_portage_upgrade.  Add a bug number, test details, and any other details you want.</p>
<div></div>
<div class="sites-codeblock sites-codesnippet-block">
<div><code>cd ~/chromiumos/src/third_party/portage-stable</code></div>
<div><code>git commit --amend</code></div>
</div>
<p>Upload the usual way.</p>
<div></div>
<div class="sites-codeblock sites-codesnippet-block">
<div><code>cd </code><code>~/chromiumos/src/third_party/portage-stable</code></div>
<div><code>repo upload .</code></div>
</div>
<p>Then go through the usual code review process on gerrit.</p>
<h4><a name="TOC-Clean-up-Environment"></a>Clean up Environment</h4>
<p>After your changelist is through review and submitted to the tree, you will want to get off the branch you created in <font face="monospace">src/third_party/portage-stable</font>.  You know the drill.</p>
<div><span style="line-height:13px;background-color:rgb(239,239,239)">
<div></div>
<div class="sites-codeblock sites-codesnippet-block">
<div><code>cd </code><code>~/chromiumos/src/third_party/portage-stable</code></div>
<div><font color="#006000" face="monospace">repo abandon pkg_upgrade .</font></div>
</div>
</span></div>
<h3><a name="TOC-Appendices"></a>Appendices</h3>
<div>
<a name="AppendixReapplyPatch"></a>
<h4><a name="TOC-Re-applying-a-patch-after-upgrade"></a><b>Re-applying a patch after upgrade</b></h4>
<p>It is not uncommon for a package to be locally patched in the source now (typically any upstream package in the <font face="monospace">src/third_party/chromiumos-overlay</font> overlay).  To upgrade that package the patch will (probably) need to be applied again to the upgraded version.  Let's say you upgraded the "foo/bar" package to upstream version "1.2.3", but you need to re-apply a patch to it that was previously applied to version "1.1.1" (perhaps "1.1.1-r1" is the active version now with the patch).</p>
<p>Allow the cros_portage_upgrade script to complete the pristine upgrade in <font face="monospace">src/third_party/portage-stable</font> for the package first.  Then copy the entire directory over to the analogous location under <font face="monospace">src/third_party/chromiumos-overlay</font><font face="arial, sans-serif">, creating the directory if necessary</font>  You will commit the unaltered package as it is in the first changelist, but first you must mark it as unstable so that it will not be used.  To do so, add a new file like the following to the <span style="font-family:courier new,monospace">src/third_party/chromiumos-overlay/profiles/default/linux/package.mask/ </span><span style="font-size:13.3333330154419px;background-color:transparent">directory</span>:</p>
<div>
<div class="sites-codeblock sites-codesnippet-block"><code># Copyright 2015 The Chromium OS Authors. All rights reserved.<br />
# Use of this source code is governed by a BSD-style license that can be<br />
# found in the LICENSE file<br />
<br />
# TODO(username): Masked for testing!<br />
=foo/bar-1.2.3</code></div>
</div>
<p>The above masks the specific package version "foo/bar-1.2.3" for all targets.  (If your intent is to patch the ebuild only for certain platforms please speak to the build team as this is generally unnecessary and strongly discouraged.)  Now you are ready to submit the pristine copy of the upstream package to chromiumos-overlay.</p>
<p>Next make a copy of the ebuild file with a revision suffix.  For example:</p>
<div>
<div class="sites-codeblock sites-codesnippet-block"><code>cp bar-1.2.3.ebuild bar-1.2.3-r1.ebuild</code></div>
</div>
<p>Then re-apply the patch to the new revision ebuild, by copying the epatch line or lines in the previously patched ebuild (bar-1.1.1-r1.ebuild).  Be sure to keep whatever patch files under the "files" directory are required for the patch, too.  You might have to rename them (e.g. <font face="monospace">cp files/bar-1.1.1-something.patch files/bar-1.2.3-something.patch</font>).  <b>Be careful to apply the patch responsibly</b>, because the source file(s) the patch alters may have changed since the patch was created.  If so, you can create a new patch or consult the original patch author (if not you).</p>
<p>To inspect the source files involved, both before and after patching, use the "ebuild" utility.  For example, to see the source files for "foo/bar-1.2.3" before any patching run this <b>inside chroot</b>, use a command like the following examples:</p>
<div></div>
<div class="sites-codeblock sites-codesnippet-block">
<div><code>sudo ebuild `equery which foo/bar-1.2.3` unpack</code></div>
<div><code>sudo ebuild-x86-generic `equery-x86-generic which foo/bar-1.2.3` unpack</code></div>
<div><code>sudo ebuild-daisy `equery-daisy which foo/bar-1.2.3` unpack</code></div>
</div>
<p>The above will unpack source files and tell you where they are.  You can inspect them to verify whether the source file(s) the patch touches have changed between versions.  To see what the source files look like after patching, use the same commands as above but replace "unpack" with "prepare".  Also, make sure your newly patched version is the version being picked up by the build system by running "equery which" <b>inside chroot</b>:</p>
<div></div>
<div class="sites-codeblock sites-codesnippet-block">
<div><code>equery which foo/bar</code></div>
<div><code>equery-x86-generic which foo/bar</code></div>
<div><code>equery-daisy which foo/bar</code></div>
</div>
<p>Make sure your new ebuild is the one being picked up.  Your upgrade with patch is ready for testing now.  Return to the testing step of the process above.</p>
<p>Remember to delete the new entry you made to the package.mask file.</p>
<p>Don't forget to discard the upgrade in portage-stable that cros_portage_upgrade created for you.</p>
<a name="AppendixHandlingEclasses"></a>
<h4><a name="TOC-Handling-eclasses"></a><b>Handling eclasses</b></h4>
<p>Some packages make use of <a href="http://www.gentoo.org/proj/en/devrel/handbook/handbook.xml?part=2&amp;chap=2">eclasses</a>, which are essentially ebuild code factored out into library files shared across multiple packages.  If an ebuild file includes an <font face="monospace">inherit</font> statement, then it uses an eclass.  You don't have to check for this before you upgrade.  The upgrade script will attempt to detect when an eclass must be upgraded along with a package upgrade, but if it is unable to you must upgrade the eclass yourself.  If you are not sure how to do that please consult with a member of the build team.</p>
<h4><a name="AppendixUnstableVersion"></a><b>Upgrading to unstable version</b></h4>
<p>If you need to upgrade a package to an unstable version for a compelling reason, then use the <font face="monospace">--unstable-ok</font> option to the cros_portage_upgrade script and it will try to do the right thing.  What it does is edit the KEYWORDS line (or lines) in the ebuild to mark all architectures as stable.  <i>This is the only exception to the rule that packages in portage-stable should be unedited.</i>  You should inspect the resulting ebuild file or files to confirm that the edit worked correctly, and file a bug on cros_portage_upgrade if it did not.</p>
<h3><a name="TOC-FAQ"></a>FAQ</h3>
</div>
<div>
<p><b>Q</b>: <i>I ran the upgrade script multiple times, and the runtime dropped drastically after the first time.  What gives?</i><br />
<b>A</b>: The cros_portage_upgrade script needs to have a local checkout of the upstream origin/gentoo source to use as a reference when it runs.  By default, it creates a clone in a temporary directory and then re-uses it in later runs (updating it each time).  This explains the runtime symptoms.  Messages from the script should say something to this effect, as well.</p>
<p>Alternatively, you can clone your own copy of upstream origin/gentoo to point cros_portage_upgrade to, using the <font face="monospace">--upstream</font> option.  This will have the same runtime benefits if you run more than once.  Do this inside your chroot:</p>
<div>
<div></div>
<div class="sites-codeblock sites-codesnippet-block">
<div><code>cd</code></div>
<div><code>git clone https://chromium.googlesource.com/chromiumos/overlays/portage gentoo-portage</code></div>
<div><code>cd gentoo-portage/</code></div>
<div><code>git checkout origin/gentoo</code></div>
</div>
</div>
<p>Then add the following option when you run cros_portage_upgrade:  <font face="monospace">--upstream=$HOME/gentoo-portage</font> .</p>
<p><b>Q:</b> <i>Why doesn't the upgrade script just run on all boards/architectures that matter at once?  Why do I have to specify them?</i><br />
<b>A:</b> The boards that "matter" vary.  The same is true, to a lesser extent, with architectures.  You know how you intend to test the package, and you may have plans to test it on specific boards for specific reasons.  Plus, cros_portage_upgrade requires that setup_board be completed for all specified boards because it evaluates packages within the context of that board, making use of emerge-&lt;board&gt; and equery-&lt;board&gt; utilities heavily.  If you already have a reasonable subset of boards setup, or available to test on, then running on those boards makes sense.</p>
<p><b>Q:</b> <i>Why doesn't the upgrade script run setup_board for me as needed?</i><br />
<b>A:</b> This script is intended to live within the build environment we have today.  It lives between the setup_board and build_packages stages, which all developers are familiar with.  The script is not intended to be a master script with knowledge of build process order.</p>
<p><b>Q:</b> <i>Why doesn't the upgrade script create the branch in src/third_party/portage-stable for me?</i><br />
<b>A:</b> This was considered, but discarded in favor of transparency.  You need to know that a branch was created because you must amend the commit message, upload it, and especially abandon the branch in the end.  If you created the branch in the first place you are more likely to be aware that you need to abandon the branch to return to your previous state.</p>
<p><b>Q:</b> <i>Why can't the upgrade script create a complete commit message so no amend is needed, then do the upload and abandon steps as well?</i><br />
<b>A:</b> Firstly, only you know what tests you will run to verify the upgrade and those should be mentioned in the commit message.  Secondly, there are many scenarios where the upgrade result is not final and requires intervention/repetition by you.</p>
<p><b>Q:</b> <i>How do you install a <b>new</b> package that is not currently installed? I get the "The following packages were not found in current overlays (but they do exist upstream): ..." error.</i><br />
<b>A:</b> Make sure you pass <span style="font-family:monospace;font-size:10pt">--upgrade</span><span style="font-size:10pt"> to the script since installing a new package is the same thing as upgrading it from &lt;none&gt;.</span></p>
</div></div></td></tr></tbody></table>
</div> 
</div> 
<div id="sites-canvas-bottom-panel">
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_page-subpages"> </div>
<div id="sites-attachments-container">
</div>
<a xmlns="http://www.w3.org/1999/xhtml" name="page-comments"></a>
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_page-comments"><div class="sites-comment-docos-wrapper"><div class="sites-comment-docos"><div class="sites-comment-docos-background"></div><div class="sites-comment-docos-header"><div class="sites-comment-docos-header-title">Comments</div></div><div id="sites-comment-docos-pane" class="sites-comment-docos-pane"></div></div></div></div>
</div>
</div> 
</td> 
</tr>
</table> 
</div> 
</div> 
<div id="sites-chrome-footer-wrapper">
<div id="sites-chrome-footer-wrapper-inside">
<div id="sites-chrome-footer">
</div>
</div>
</div>
</div> 
</div> 
<div id="sites-chrome-adminfooter-container">
<div xmlns="http://www.w3.org/1999/xhtml" class="sites-adminfooter" role="navigation"><p><a class="sites-system-link" href="https://www.google.com/a/UniversalLogin?service=jotspot&amp;continue=https://sites.google.com/a/chromium.org/dev/chromium-os/gentoo-package-upgrade-process">Sign in</a><span aria-hidden="true">|</span><a class="sites-system-link" href="/system/app/pages/recentChanges">Recent Site Activity</a><span aria-hidden="true">|</span><a class="sites-system-link" href="/system/app/pages/reportAbuse" target="_blank">Report Abuse</a><span aria-hidden="true">|</span><a class="sites-system-link" href="javascript:;" onclick="window.open(webspace.printUrl)">Print Page</a><span aria-hidden="true">|</span><span class="sites-system-link">Powered By</span> <b class="powered-by"><a href="http://sites.google.com">Google Sites</a></b></p></div>
</div>
</div> 
</div> 
<div id="sites-chrome-onebar-footer">
</div>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
    window.jstiming.load.tick('sjl');
  </script>
<script xmlns="http://www.w3.org/1999/xhtml" src="https://ssl.gstatic.com/sites/p/56e332/system/js/jot_min_view__en.js"></script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
    window.jstiming.load.tick('jl');
  </script>
<script xmlns="http://www.w3.org/1999/xhtml">
      
          sites.core.Analytics.createTracker();
          sites.core.Analytics.trackPageview();
        
    </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
                    sites.Searchbox.initialize(
                        'sites-searchbox-search-button',
                        {"object":[]}['object'],
                        'search-site',
                        {"label":"Configure search options...","url":"/system/app/pages/admin/settings"});
                  </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
      gsites.HoverPopupMenu.createSiteDropdownMenus('sites-header-nav-dropdown', false);
    </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript" defer="true">
            JOT_setupNav("7648876402527094", "Navigation", false);
            JOT_addListener('titleChange', 'JOT_NAVIGATION_titleChange', 'COMP_7648876402527094');
          </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript" defer="true">
            JOT_setupNav("14720868319272995", "Quick links", false);
            JOT_addListener('titleChange', 'JOT_NAVIGATION_titleChange', 'COMP_14720868319272995');
          </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript" defer="true">
            JOT_setupNav("19690813310444355", "Other sites", false);
            JOT_addListener('titleChange', 'JOT_NAVIGATION_titleChange', 'COMP_19690813310444355');
          </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
              new sites.CommentPane('//docs.google.com/comments/d/AAHRpnXvrAwjAfmld0ObrebBiGRq975mbISjgJJFXJ9WRNRvFQ9J_zR_amkeYm0vQOR9TqvCIBJHq_4EHGyYANUS36mLKbMWsE5RD9pn203-DYeou5nPKLQZqaJXAI5kcJ8dZcHGKlgoC/api/js?anon=true',
                  false, false);
            </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
  setTimeout(function() {
    var fingerprint = gsites.date.TimeZone.getFingerprint([]);
    gsites.Xhr.send('https://www.chromium.org/_/tz', null, null, 'GET', null, null, { afjstz: fingerprint });
  }, 500);
</script>
<script xmlns="http://www.w3.org/1999/xhtml">
                    window.onload = function() {
                      if (false) {
                        JOT_setMobilePreview();
                      }
                      var loadTimer = window.jstiming.load;
                      loadTimer.tick("ol");
                      loadTimer["name"] = "load," + webspace.page.type + ",user_page";
                      window.jstiming.report(loadTimer, {}, 'https://gg.google.com/csi');
                    }
                  </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
        JOT_insertAnalyticsCode(false,
            false);
      </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
    var maestroRunner = new gsites.pages.view.SitesMaestroRunner(
        webspace, "en");
    maestroRunner.initListeners();
    maestroRunner.installEditRender();
  </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript" defer="true">
  //<![CDATA[
    // Decorate any fastUI buttons on the page with a class of 'goog-button'.
    if (webspace.user.hasWriteAccess) {
      JOT_decorateButtons();
    }

    // Fires delayed events.
    (function() {
      JOT_fullyLoaded = true;
      var delayedEvents = JOT_delayedEvents;
      for (var x = 0; x < delayedEvents.length; x++) {
        var event = delayedEvents[x];
        JOT_postEvent(event.eventName, event.eventSrc, event.payload);
      }
      JOT_delayedEvents = null;
      JOT_postEvent('pageLoaded');
    })();
  //]]>
</script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
    JOT_postEvent('decorateGvizCharts');
  </script>
<script type="text/javascript">
          JOT_setupPostRenderingManager();
        </script>
<script type="text/javascript">
          JOT_postEvent('renderPlus', null, 'sites-chrome-main');
        </script>
<div id="server-timer-div" style="display:none"> </div>
<script type="text/javascript">
          window.jstiming.load.tick('render');
          JOT_postEvent('usercontentrendered', this);
        </script>
</body>
</html>
