<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/WebPage">
<head>
<meta http-equiv="X-UA-Compatible" content="chrome=1" />
<script type="text/javascript">/* Copyright 2008 Google. */ (function() { var e="wtsrt_",g="tbsd_",h="tbnd_",k="start",l="_wtsrt",m="_tbnd",n="CSI/";(function(){function f(a){this.t={};this.tick=function(a,c,b){this.t[a]=[void 0!=b?b:(new Date).getTime(),c];if(void 0==b)try{window.console.timeStamp(n+a)}catch(d){}};this.tick(k,null,a)}var a;window.performance&&(a=window.performance.timing);var p=a?new f(a.responseStart):new f;window.jstiming={Timer:f,load:p};if(a){var c=a.navigationStart,d=a.responseStart;0<c&&d>=c&&(window.jstiming.srt=d-c)}if(a){var b=window.jstiming.load;0<c&&d>=c&&(b.tick(l,void 0,c),b.tick(e,l,d),b.tick(g,e))}try{a=null,
window.chrome&&window.chrome.csi&&(a=Math.floor(window.chrome.csi().pageT),b&&0<c&&(b.tick(m,void 0,window.chrome.csi().startE),b.tick(h,m,c))),null==a&&window.gtbExternal&&(a=window.gtbExternal.pageT()),null==a&&window.external&&(a=window.external.pageT,b&&0<c&&(b.tick(m,void 0,window.external.startE),b.tick(h,m,c))),a&&(window.jstiming.pt=a)}catch(q){}})(); })()
</script>
<link rel="shortcut icon" href="/_/rsrc/1354323194313/favicon.ico" type="image/x-icon" />
<link rel="apple-touch-icon" href="https://ssl.gstatic.com/sites/p/56e332/system/app/images/apple-touch-icon.png" type="image/png" />
<script type="text/javascript">/* Copyright 2008 Google. */ (function() { var d="",g="__duration__",h="function";function k(c){return document.getElementById(c)}window.byId=k;function l(c){return c.replace(/^\s+|\s+$/g,d)}window.trim=l;var m=[],n=0;window.JOT_addListener=function(c,a,b){var e=new String(n++);c={eventName:c,handler:a,compId:b,key:e};m.push(c);return e};window.JOT_removeListenerByKey=function(c){for(var a=0;a<m.length;a++)if(m[a].key==c){m.splice(a,1);break}};
window.JOT_removeAllListenersForName=function(c){for(var a=0;a<m.length;a++)m[a].eventName==c&&m.splice(a,1)};window.JOT_postEvent=function(c,a,b){var e={eventName:c,eventSrc:a||{},payload:b||{}};if(window.JOT_fullyLoaded)for(a=m.length,b=0;b<a&&b<m.length;b++){var f=m[b];f&&f.eventName==c&&(e.listenerCompId=f.compId||d,(f=typeof f.handler==h?f.handler:window[f.handler])&&f(e))}else window.JOT_delayedEvents.push({eventName:c,eventSrc:a,payload:b})};window.JOT_delayedEvents=[];
window.JOT_fullyLoaded=!1;window.JOT_formatRelativeToNow=function(c,a){var b=((new Date).getTime()-c)/6E4;if(1440<=b||0>b)return null;var e=0;60<=b&&(b/=60,e=2);2<=b&&e++;return a?window.JOT_siteRelTimeStrs[e].replace(g,Math.floor(b)):window.JOT_userRelTimeStrs[e].replace(g,Math.floor(b))}; })()
</script>
<script>

  

  var breadcrumbs = [{"path":"/chromium-os","deleted":false,"title":"Chromium OS","dir":"ltr"},{"path":"/chromium-os/developer-information-for-chrome-os-devices","deleted":false,"title":"Developer Information for Chrome OS Devices","dir":"ltr"},{"path":"/chromium-os/developer-information-for-chrome-os-devices/custom-firmware","deleted":false,"title":"Custom Firmware","dir":"ltr"}];
  var JOT_clearDotPath = 'https://ssl.gstatic.com/sites/p/56e332/system/app/images/cleardot.gif';

  
  var JOT_userRelTimeStrs = ["a minute ago","__duration__ minutes ago","an hour ago","__duration__ hours ago"];

  
  

  

  var webspace = {"enableAnalytics":true,"pageSharingId":"jotspot_page","enableUniversalAnalytics":false,"sharingPolicy":"OPENED_WITH_INDICATOR","siteTitle":"The Chromium Projects","isStartPageEnabled":true,"adsensePublisherId":null,"features":{"languageSelectDefaultTextSetToDefault":true,"validateClientGvizDataSourceUrls":true,"moreMobileStyleImprovements":true,"newInsertMenuIcons":true,"accessibleSortingButtons":true,"domainAnalyticsInGAOnly":true,"noCaptcha":true,"fileCabinetScreenReaderFix":true,"updatedTosAndPrivacyLinks":null,"pageDrafts":false,"mobileOrientationFix":true,"plusBadge":false,"pdfEmbedSupport":false,"jsClickFix":true},"isPublic":true,"isConsumer":false,"serverFlags":{"cajaBaseUrl":"//www.gstatic.com/caja","cajaDebugMode":false},"onepickBaseUrl":"https://docs.google.com","domainAnalyticsAccountId":"","plusPageId":"","signInUrl":"https://www.google.com/a/SelectSession?continue\u003dhttps://sites.google.com/a/chromium.org/dev/chromium-os/developer-information-for-chrome-os-devices/custom-firmware\u0026service\u003djotspot","analyticsAccountId":"UA-5484340-1","scottyUrl":"/_/upload","homePath":"/","siteNoticeUrlEnabled":null,"plusPageUrl":"","adsensePromoClickedOrSiteIneligible":true,"csiReportUri":"https://gg.google.com/csi","sharingId":"jotspot","termsUrl":"//www.google.com/intl/en/policies/terms/","gvizVersion":1,"editorResources":{"sitelayout":["https://ssl.gstatic.com/sites/p/56e332/system/app/css/sitelayouteditor.css"],"text":["https://ssl.gstatic.com/sites/p/56e332/system/js/codemirror.js","https://ssl.gstatic.com/sites/p/56e332/system/app/css/codemirror_css.css","https://ssl.gstatic.com/sites/p/56e332/system/js/trog_edit__en.js","https://ssl.gstatic.com/sites/p/56e332/system/app/css/trogedit.css","/_/rsrc/1441580320000/system/app/css/editor.css","https://ssl.gstatic.com/sites/p/56e332/system/app/css/codeeditor.css","/_/rsrc/1441580320000/system/app/css/camelot/editor-jfk-wlb.css"]},"sharingUrlPrefix":"/_/sharing","isAdsenseEnabled":true,"domain":"chromium.org","baseUri":"","name":"dev","siteTemplateId":false,"siteNoticeRevision":null,"siteNoticeUrlAddress":null,"siteNoticeMessage":null,"page":{"isRtlLocale":false,"canDeleteWebspace":null,"isPageDraft":null,"parentPath":"/chromium-os/developer-information-for-chrome-os-devices","parentWuid":"wuid:gx:2227f33967836151","siteLocale":"en","timeZone":"America/Los_Angeles","type":"text","title":"Custom Firmware","locale":"en","wuid":"wuid:gx:1a0285410921f90","revision":28,"path":"/chromium-os/developer-information-for-chrome-os-devices/custom-firmware","isSiteRtlLocale":false,"pageInheritsPermissions":null,"name":"custom-firmware","canChangePath":true,"state":"","properties":{},"bidiEnabled":false,"currentTemplate":{"path":"/system/app/pagetemplates/text","title":"Web Page"}},"canPublishScriptToAnyone":true,"user":{"keyboardShortcuts":true,"sessionIndex":"","guest_":true,"displayNameOrEmail":"guest","userName":"guest","uid":"","renderMobile":false,"domain":"","namespace":"","hasWriteAccess":false,"namespaceUser":false,"primaryEmail":"guest","hasAdminAccess":false},"gadgets":{"baseUri":"/system/app/pages/gadgets"}};
  webspace.page.breadcrumbs = breadcrumbs;

  
  var JOT_siteRelTimeStrs = ["a minute ago","__duration__ minutes ago","an hour ago","__duration__ hours ago"];

</script>
<script type="text/javascript">
                window.jstiming.load.tick('scl');
              </script>
<meta name="title" content="Custom Firmware - The Chromium Projects" />
<meta itemprop="name" content="Custom Firmware - The Chromium Projects" />
<meta property="og:title" content="Custom Firmware - The Chromium Projects" />
<meta name="description" content="Home of the Chromium Open Source Project" />
<meta itemprop="description" content="Home of the Chromium Open Source Project" />
<meta id="meta-tag-description" property="og:description" content="Home of the Chromium Open Source Project" />
<style type="text/css">
</style>
<link rel="stylesheet" type="text/css" href="https://ssl.gstatic.com/sites/p/56e332/system/app/themes/beigeandblue/standard-css-beigeandblue-ltr-ltr.css" />
<link rel="stylesheet" type="text/css" href="/_/rsrc/1441580320000/system/app/css/overlay.css?cb=beigeandblueundefineda100%25%25150goog-ws-leftthemedefaultstandard" />
<link rel="stylesheet" type="text/css" href="/_/rsrc/1441580320000/system/app/css/camelot/allthemes-view.css" />
<!--[if IE]>
          <link rel="stylesheet" type="text/css" href="/system/app/css/camelot/allthemes%2die.css" />
        <![endif]-->
<title>Custom Firmware - The Chromium Projects</title>
<meta itemprop="image" content="/_/rsrc/1438879449147/config/customLogo.gif?revision=3" />
<meta property="og:image" content="/_/rsrc/1438879449147/config/customLogo.gif?revision=3" />
<script type="text/javascript">
                window.jstiming.load.tick('cl');
              </script>
</head>
<body xmlns="http://www.google.com/ns/jotspot" id="body" class=" en            ">
<div id="sites-page-toolbar" class="sites-header-divider">
<div xmlns="http://www.w3.org/1999/xhtml" id="sites-status" class="sites-status" style="display:none;"><div id="sites-notice" class="sites-notice" role="status" aria-live="assertive"> </div></div>
</div>
<div id="sites-chrome-everything-scrollbar">
<div id="sites-chrome-everything" class="">
<div id="sites-chrome-page-wrapper" style="direction: ltr">
<div id="sites-chrome-page-wrapper-inside">
<div xmlns="http://www.w3.org/1999/xhtml" id="sites-chrome-header-wrapper" style="height:auto;">
<table id="sites-chrome-header" class="sites-layout-hbox" cellspacing="0" style="height:auto;">
<tr class="sites-header-primary-row" id="sites-chrome-userheader">
<td id="sites-header-title" class="" role="banner"><div class="sites-header-cell-buffer-wrapper"><a href="https://www.chromium.org/" id="sites-chrome-userheader-logo"><img id="logo-img-id" src="/_/rsrc/1438879449147/config/customLogo.gif?revision=3" alt="The Chromium Projects" class="sites-logo  " /></a><h2><a href="https://www.chromium.org/" dir="ltr" id="sites-chrome-userheader-title">The Chromium Projects</a></h2></div></td><td class="sites-layout-searchbox  "><div class="sites-header-cell-buffer-wrapper"><form id="sites-searchbox-form" action="/system/app/pages/search" role="search"><input type="hidden" id="sites-searchbox-scope" name="scope" value="search-site" /><input type="text" id="jot-ui-searchInput" name="q" size="20" value="" aria-label="Search this site" /><div id="sites-searchbox-button-set" class="goog-inline-block"><div role="button" id="sites-searchbox-search-button" class="goog-inline-block jfk-button jfk-button-standard" tabindex="0">Search this site</div></div></form></div></td>
</tr>
<tr class="sites-header-secondary-row" id="sites-chrome-horizontal-nav">
<td colspan="2" id="sites-chrome-header-horizontal-nav-container" role="navigation">
</td>
</tr>
</table>
</div>
<div id="sites-chrome-main-wrapper">
<div id="sites-chrome-main-wrapper-inside">
<table id="sites-chrome-main" class="sites-layout-hbox" cellspacing="0" cellpadding="{scmCellpadding}" border="0">
<tr>
<td id="sites-chrome-sidebar-left" class="sites-layout-sidebar-left initial" style="width:150px">
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_7648876402527094" class="sites-embed" role="navigation"><div class="sites-embed-content sites-sidebar-nav"><ul role="navigation" jotId="navList"><li class="nav-first "><div dir="ltr" style="padding-left: 5px;"><a href="/chromium-projects" jotId="wuid:gx:10ae433dadbbab13" class="sites-navigation-link">Home</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="/Home" jotId="wuid:gx:43582b9d2029d3af" class="sites-navigation-link">Chromium</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="/chromium-os" jotId="wuid:gx:83df2ab1f8880ba" class="sites-navigation-link">Chromium OS</a></div></li></ul></div></div>
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_14720868319272995" class="sites-embed" role="navigation"><h4 class="sites-embed-title">Quick links</h4><div class="sites-embed-content sites-sidebar-nav"><ul role="navigation" jotId="navList"><li class="nav-first "><div dir="ltr" style="padding-left: 5px;"><a href="http://www.chromium.org/for-testers/bug-reporting-guidelines" class="sites-navigation-link">Report bugs</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="http://www.chromium.org/developers/discussion-groups" class="sites-navigation-link">Discuss</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="/system/app/pages/sitemap/hierarchy" jotId="wuid:gx:4c0f552cb393ed23" class="sites-navigation-link">Sitemap</a></div></li></ul></div></div>
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_19690813310444355" class="sites-embed" role="navigation"><h4 class="sites-embed-title">Other sites</h4><div class="sites-embed-content sites-sidebar-nav"><ul role="navigation" jotId="navList"><li class="nav-first "><div dir="ltr" style="padding-left: 5px;"><a href="http://blog.chromium.org/" class="sites-navigation-link">Chromium Blog</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="http://code.google.com/chrome/extensions/" class="sites-navigation-link">Google Chrome Extensions</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="https://developers.google.com/chrome/chrome-frame/" class="sites-navigation-link">Google Chrome Frame</a></div></li></ul></div></div>
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_19695218559354544" class="sites-embed" role="complementary"><h4 class="sites-embed-title"></h4><div class="sites-embed-content sites-embed-content-sidebar-textbox"><div dir="ltr"><span style="font-size:x-small">Except as otherwise </span><a href="http://developers.google.com/site-policies.html#restrictions"><span style="font-size:x-small">noted</span></a><span style="font-size:x-small">, the content of this page is licensed under a </span><a href="http://creativecommons.org/licenses/by/2.5/"><span style="font-size:x-small">Creative Commons Attribution 2.5 license</span></a><span style="font-size:x-small">, and examples are licensed under the </span><a href="http://src.chromium.org/viewvc/chrome/trunk/src/LICENSE" target="_blank"><span style="font-size:x-small">BSD License</span></a><span style="font-size:x-small">.<br /></span></div></div></div>
</td>
<td id="sites-canvas-wrapper">
<div id="sites-canvas" role="main">
<div id="goog-ws-editor-toolbar-container"> </div>
<div xmlns="http://www.w3.org/1999/xhtml" id="title-crumbs" style="">
<A href="/chromium-os" dir="ltr">Chromium OS</A>‎ &gt; ‎<A href="/chromium-os/developer-information-for-chrome-os-devices" dir="ltr">Developer Information for Chrome OS Devices</A>‎ &gt; ‎
  </div>
<h3 xmlns="http://www.w3.org/1999/xhtml" id="sites-page-title-header" style="" align="left">
<span id="sites-page-title" dir="ltr" tabindex="-1" style="outline: none">Custom Firmware</span>
</h3>
<div id="sites-canvas-main" class="sites-canvas-main">
<div id="sites-canvas-main-content">
<table xmlns="http://www.w3.org/1999/xhtml" cellspacing="0" class="sites-layout-name-one-column sites-layout-hbox"><tbody><tr><td class="sites-layout-tile sites-tile-name-content-1"><div dir="ltr"><div><div class="sites-embed-align-right-wrapping-on"><div class="sites-embed-border-off sites-embed" style="width:250px;"><div class="sites-embed-content sites-embed-type-toc"><div class="goog-toc sites-embed-toc-maxdepth-6"><p>Contents</p><ol class="goog-toc"><li class="goog-toc"><a href="#TOC-Firmware-as-kernel"><strong>1 </strong>Firmware as kernel</a><ol class="goog-toc"><li class="goog-toc"><a href="#TOC-Warning"><strong>1.1 </strong>Warning</a><ol class="goog-toc"><li class="goog-toc"><a href="#TOC-H2C"><strong>1.1.1 </strong>H2C</a></li><li class="goog-toc"><a href="#TOC-Coreboot"><strong>1.1.2 </strong>Coreboot</a></li><li class="goog-toc"><a href="#TOC-U-Boot"><strong>1.1.3 </strong>U-Boot</a></li><li class="goog-toc"><a href="#TOC-Depthcharge"><strong>1.1.4 </strong>Depthcharge</a></li></ol></li><li class="goog-toc"><a href="#TOC-Producing-a-kernel-to-boot"><strong>1.2 </strong>Producing a "kernel" to boot</a></li><li class="goog-toc"><a href="#TOC-Known-issues"><strong>1.3 </strong>Known issues</a></li></ol></li><li class="goog-toc"><a href="#TOC-I-m-not-afraid-of-damaging-things"><strong>2 </strong>I'm not afraid of damaging things</a></li></ol></div></div></div></div></div>
<p>The Chrome OS firmware is <b>always</b> verified as signed by Google. Developer mode allows you to safely fiddle with the disk and operating system, but the boot process depends on unmodified firmware. There is no provision for modifying the firmware without physically taking the device apart. Modifying your firmware can result in permanent damage.</p>
<p>This page talks about how to use your own custom firmware without damaging the official firmware on your device, by pretending that your custom firmware is a custom kernel.</p>
<div>
<h2><a name="TOC-Firmware-as-kernel"></a>Firmware as kernel</h2>
<p>The normal-mode <a href="https://www.chromium.org/chromium-os/chromiumos-design-docs/disk-format">boot process</a> is roughly this: RO firmware verifies and launches the RW firmware, RW firmware verifies and launches the kernel, the kernel verifies the rootfs as it's read from the disk.</p>
<p>In developer mode, the RW firmware doesn't verify that the kernel is signed by Google, just that it looks like a correctly signed kernel image. It doesn't matter <b>who</b> signed it, so you can <a href="https://www.chromium.org/chromium-os/developer-guide">build and boot your own</a> kernel and rootfs. On later models, you can also enable booting a custom Chromium OS kernel from USB.</p>
<p>The ChromeOS firmware doesn't actually look at the kernel, it just looks for a <a href="https://www.chromium.org/chromium-os/chromiumos-design-docs/verified-boot-data-structures">ChromeOS-specific header</a> that describes it. So if your custom kernel isn't actually a Linux kernel, but is a custom build of U-Boot that was packaged as though it was a Chromium OS kernel, the firmware will happily load it into RAM and jump to it. What happens next is up to you.</p>
<h3><a name="TOC-Warning"></a>Warning</h3>
<p>This has been known to work (more or less), but it's pretty annoying and difficult to debug. Most of the time when something goes wrong, you just see the scary boot screen, you press Ctrl-D or Ctrl-U to boot your magic image, and ... the machine silently hangs or reboots. Sometimes it reboots into recovery mode but power cycling restores it. Sometimes you have to run the recovery process to restore it. You shouldn't be able to damage anything, but you can spend a lot of time trying to get it right.</p>
<p>That said, the general process is fairly straightforward. Of course, it helps <b>a lot</b> if you've <a href="https://www.chromium.org/chromium-os/developer-guide" style="font-size:10pt">built and booted your own</a><span style="font-size:10pt"> Chromium OS image at least once so that you're familiar with the development environment.</span></p>
<div><span style="white-space:pre-wrap;color:rgb(34,34,34);font-family:Arial">Google pushes frequent updates to the running Chrome OS system so that over time it just gets better. However, since the initial portion of the BIOS is read-only, only the read-write part of the BIOS can be updated and the requirement that it interoperate with the RW portion limits the amount of change that can be applied. In addition, updating BIOS can be a scary proposition because uncaught bugs could require users to run the recovery process. That means that significant changes to the BIOS are only made by introducing new ChromeOS devices. As of this writing, there are three major BIOS designs in existence, and each type loads and runs the kernel in different ways.</span></div>
<h4><a name="TOC-H2C"></a><b style="font-family:Times New Roman;font-size:medium;font-weight:normal"><span style="font-size:13px;font-family:Arial;color:rgb(34,34,34);background-color:transparent;font-weight:bold;vertical-align:baseline;white-space:pre-wrap">H2C</span></b></h4>
<p>The first generation of Chromebooks (Cr-48, Alex, ZGB) uses a BIOS called "H2C".</p>
<div><b>
<ul style="font-family:Times New Roman;font-size:medium;font-weight:normal;margin-top:0pt;margin-bottom:0pt"><li dir="ltr" style="list-style-type:disc;font-size:13px;font-family:Arial;color:rgb(34,34,34);background-color:transparent;vertical-align:baseline;margin-left:15px"><span style="background-color:transparent;vertical-align:baseline;white-space:pre-wrap">H2C is UEFI-based, but with a lot of stuff cut out to speed up the boot process.</span></li>
<li dir="ltr" style="list-style-type:disc;font-size:13px;font-family:Arial;color:rgb(34,34,34);background-color:transparent;vertical-align:baseline;margin-left:15px"><span style="background-color:transparent;vertical-align:baseline;white-space:pre-wrap">The BIOS is a 64-bit executable, but the ChromeOS kernel is launched in 32-bit mode. Our kernel has to be specially modified to handle this difference.</span></li>
<li dir="ltr" style="list-style-type:disc;font-size:13px;font-family:Arial;color:rgb(34,34,34);background-color:transparent;vertical-align:baseline;margin-left:15px"><span style="background-color:transparent;vertical-align:baseline;white-space:pre-wrap">The "bootloader stub" is a standard UEFI executable, with source in </span><span style="font-family:Courier New;background-color:transparent;vertical-align:baseline;white-space:pre-wrap"><a href="http://git.chromium.org/gitweb/?p=chromiumos/third_party/bootstub.git">src/third_party/bootstub/</a></span><span style="background-color:transparent;vertical-align:baseline;white-space:pre-wrap">.  The purpose of this tiny executable is to</span></li>
<ul style="margin-top:0pt;margin-bottom:0pt"><li dir="ltr" style="list-style-type:circle;font-size:13px;font-family:Arial;color:rgb(34,34,34);background-color:transparent;vertical-align:baseline;margin-left:15px"><span style="background-color:transparent;vertical-align:baseline;white-space:pre-wrap">Update the kernel cmdline to let the kernel find the correct rootfs partition.</span></li>
<li dir="ltr" style="list-style-type:circle;font-size:13px;font-family:Arial;color:rgb(34,34,34);background-color:transparent;vertical-align:baseline;margin-left:15px"><span style="background-color:transparent;vertical-align:baseline;white-space:pre-wrap">Obtain the memory map from the BIOS that the kernel will need.</span></li>
<li dir="ltr" style="list-style-type:circle;font-size:13px;font-family:Arial;color:rgb(34,34,34);background-color:transparent;vertical-align:baseline;margin-left:15px"><span style="background-color:transparent;vertical-align:baseline;white-space:pre-wrap">Switch CPU modes from 64-bit to 32-bit.</span></li>
<li dir="ltr" style="list-style-type:circle;font-size:13px;font-family:Arial;color:rgb(34,34,34);background-color:transparent;vertical-align:baseline;margin-left:15px"><span style="background-color:transparent;vertical-align:baseline;white-space:pre-wrap">Jump to the kernel entry point at 0x100000.</span></li></ul>
<li dir="ltr" style="list-style-type:disc;font-size:13px;font-family:Arial;color:rgb(34,34,34);background-color:transparent;vertical-align:baseline;margin-left:15px"><span style="background-color:transparent;vertical-align:baseline;white-space:pre-wrap">You can replace the bootloader stub with any other UEFI application (such as grub2), but it will be broken in two ways:</span></li>
<ul style="margin-top:0pt;margin-bottom:0pt"><li dir="ltr" style="list-style-type:circle;font-size:13px;font-family:Arial;color:rgb(34,34,34);background-color:transparent;vertical-align:baseline;margin-left:15px"><span style="background-color:transparent;vertical-align:baseline;white-space:pre-wrap">The BIOS' console output functions are disabled, so you can't see any output.</span></li>
<li dir="ltr" style="list-style-type:circle;font-size:13px;font-family:Arial;color:rgb(34,34,34);background-color:transparent;vertical-align:baseline;margin-left:15px"><span style="background-color:transparent;vertical-align:baseline;white-space:pre-wrap">None of the UEFI-provided disk handles are valid, so you can't do any disk IO.</span></li></ul></ul>
</b>
<h4><a name="TOC-Coreboot"></a><b><span style="font-family:Arial;font-size:13px;font-weight:bold;color:rgb(34,34,34);background-color:transparent;vertical-align:baseline;white-space:pre-wrap">Coreboot</span></b></h4>
</div>
<p><span style="white-space:pre-wrap;color:rgb(34,34,34);font-family:Arial">The second generation x86 Chromebooks (Stumpy, Lumpy, Parrot) firmware is a combination of Coreboot and U-Boot.</span></p>
<div><b>
<ul style="font-family:Times New Roman;font-size:medium;font-weight:normal;margin-top:0pt;margin-bottom:0pt"><li dir="ltr" style="list-style-type:disc;font-size:13px;font-family:Arial;color:rgb(34,34,34);background-color:transparent;vertical-align:baseline;margin-left:15px"><span style="background-color:transparent;vertical-align:baseline;white-space:pre-wrap">Coreboot initializes the bare hardware, then invokes a "payload".</span></li>
<li dir="ltr" style="list-style-type:disc;font-size:13px;font-family:Arial;color:rgb(34,34,34);background-color:transparent;vertical-align:baseline;margin-left:15px"><span style="background-color:transparent;vertical-align:baseline;white-space:pre-wrap">The payload is U-Boot, configured and customized to boot using our verified boot process without delay.</span></li>
<li dir="ltr" style="list-style-type:disc;font-size:13px;font-family:Arial;color:rgb(34,34,34);background-color:transparent;vertical-align:baseline;margin-left:15px"><span style="background-color:transparent;vertical-align:baseline;white-space:pre-wrap">Coreboot and U-Boot are both 32-bit executables, as is the kernel entry code (even for 64-bit kernels).</span></li>
<li dir="ltr" style="list-style-type:disc;font-size:13px;font-family:Arial;color:rgb(34,34,34);background-color:transparent;vertical-align:baseline;margin-left:15px"><span style="background-color:transparent;vertical-align:baseline;white-space:pre-wrap">U-Boot updates the kernel cmdline and zeropage table, before jumping directly to 0x100000. Any "bootstub" code is ignored.</span></li></ul>
</b>
<p><b><span style="font-family:Arial;font-size:13px;font-weight:normal;color:rgb(34,34,34);background-color:transparent;vertical-align:baseline;white-space:pre-wrap">The two nice things about the coreboot BIOS are:</span></b></p>
<b>
<ul style="font-family:Times New Roman;font-size:medium;font-weight:normal;margin-top:0pt;margin-bottom:0pt"><li dir="ltr" style="list-style-type:disc;font-size:13px;font-family:Arial;color:rgb(34,34,34);background-color:transparent;vertical-align:baseline;margin-left:15px"><span style="background-color:transparent;vertical-align:baseline;white-space:pre-wrap">U-Boot can decide at boot time to enable the console output if it needs to.</span></li>
<li dir="ltr" style="list-style-type:disc;font-size:13px;font-family:Arial;color:rgb(34,34,34);background-color:transparent;vertical-align:baseline;margin-left:15px"><span style="background-color:transparent;vertical-align:baseline;white-space:pre-wrap">The handoff from BIOS to kernel is a simple 32-bit jump. No trampoline, no reliance on run-time-resident BIOS functions.</span></li></ul>
</b></div>
<h4><a name="TOC-U-Boot"></a><b>U-Boot</b></h4>
<p>The ARM-based Samsung Chromebook (Snow) uses U-Boot alone.</p>
<div>
<ul><li>The read-only firmware consists of three parts:</li>
<ol><li><span style="font-size:10pt">BL1/PRE_BOOT is the chip-specific bootloader provided by Samsung.</span></li>
<li><span style="font-size:10pt">BL2/SPL is a very tiny board-specific bootloader derived from U-Boot.</span></li>
<li><span style="font-size:10pt">The RO U-Boot then handles the verification and loading of the RW firmware.</span></li>
</ol>
<li>The read-write firmware is also U-Boot.</li>
<li>U-Boot passes all the kernel parameters through FDT.</li>
<li>The kernel is loaded in RAM at a different location from x86.</li>
<li>The kernel is wrapped as a FIT image, not a raw binary.</li></ul><div><h4><a name="TOC-Depthcharge"></a><b>Depthcharge</b></h4><p>The newest Chromebooks (Haswell and beyond) now use Depthcharge, which is deployed as a payload from Coreboot effectively replacing U-Boot entirely. Depthcharge removes reliance on U-Boot and allows for a lighter boot process with on demand initialization of devices. There is a presentation on Depthcharge available <a href="https://www.chromium.org/chromium-os/2014-firmware-summit/ChromeOS%20firmware%20summit%20-%20Depthcharge.pdf?attredirects=0&amp;attachauth=ANoY7crG5Y31pCz4m3Y0F8EMOo840dzbC1WBcdjqU9i3YeYoO7pK2c35_oIBLRJTV4wsyrhyno1aMl48FmOkUX3iW80kwS-K1dkX8jZcRzAmPdCOauDdhqbav6lawrX_UY4SDc_RDLI4kod7T6BswB5SAzvA_FR4Ap7r12kIiSlZjpbMteK81SnTtGayYMlD0A9Qy1hFFD_5izZBVYMeQ40IO4kF5LNQ5Mr8SK4NkiR65T01YbiRUkVjCeo6ndvvNnjkJQ6d19Qtv4TzsA4Bv5rhmRXafENjd6GVIHw82DYb-KYGe5DakfU%3D">here</a>. </p></div>
</div>
<h3><a name="TOC-Producing-a-kernel-to-boot"></a>Producing a "kernel" to boot</h3>
<p><b style="font-size:10pt">Step one</b><span style="font-size:10pt"> is to build your custom bootloader. </span></p>
<p><span style="font-size:10pt">On x86 coreboot if you're modifying the Chrome OS U-Boot, that may be as simple as changing </span><code style="font-size:10pt">CONFIG_SYS_TEXT_BASE</code><span style="font-size:10pt"> to the expected kernel load address and running </span><code style="font-size:10pt"><font color="#9900ff">emerge chromeos-u-boot</font></code><span style="font-size:10pt"> (<font color="#9900ff"><code>cros_workon</code></font> first, of course). You'll probably need to tweak a few other things to enable the vga output or provide an interactive prompt.</span></p><p>For an ARM Chromebook, you can find detailed instructions on the <a href="https://www.chromium.org/chromium-os/u-boot-porting-guide/using-nv-u-boot-on-the-samsung-arm-chromebook">Using nv-U-Boot on the Samsung ARM Chromebook</a> page.</p>
<p><b style="font-size:10pt">Step two</b><span style="font-size:10pt"> is to sign your binary like a Chromium OS kernel:</span></p>
<div class="sites-codeblock sites-codesnippet-block">
<div><font color="#9900ff" face="monospace">echo blah &gt; dummy.txt</font></div>
<div><font color="#9900ff" face="monospace"><br />
</font></div>
<div><font color="#9900ff" face="monospace">
<div>vbutil_kernel --pack kernelpart.bin \</div>
<div><span style="white-space:pre"> </span>--keyblock /usr/share/vboot/devkeys/kernel.keyblock \</div>
<div><span style="white-space:pre"> </span>--signprivate /usr/share/vboot/devkeys/kernel_data_key.vbprivk \</div>
<div><span style="white-space:pre"> </span>--version 1 \</div>
<div><span style="white-space:pre"> </span>--vmlinuz ${MY_BINARY} \</div>
<div><span style="white-space:pre"> </span>--bootloader dummy.txt \</div>
<div><span style="white-space:pre"> </span>--config dummy.txt \</div>
<div><span style="white-space:pre"> </span>--arch arm</div>
<div><br />
</div>
<div>KPART=$(pwd)/kernelpart.bin</div>
</font></div>
</div>
<div><br />
</div>
<div>Notes:<b><br />
<ol style="font-family:Times New Roman;font-size:medium;margin-top:0pt;margin-bottom:0pt"><li dir="ltr" style="font-weight:normal;list-style-type:decimal;font-size:13px;font-family:Arial;background-color:transparent;vertical-align:baseline;margin-left:15px"><span style="background-color:transparent;vertical-align:baseline;white-space:pre-wrap"><font color="#222222">Your binary is specified with the </font><b style="white-space:normal;font-family:Times New Roman;font-size:medium;font-weight:normal"><span style="font-size:13px;font-family:Courier New;background-color:transparent;vertical-align:baseline;white-space:pre-wrap"><code><font color="#9900ff">--vmlinuz</font></code><font color="#222222"> </font></span></b><font color="#222222">argument.</font></span></li>
<li dir="ltr" style="list-style-type:decimal;font-size:13px;font-family:Arial;background-color:transparent;vertical-align:baseline;margin-left:15px"><span style="background-color:transparent;vertical-align:baseline;white-space:pre-wrap"><span style="font-weight:normal"><font color="#222222">We use a </font><code><font color="#9900ff">dummy.txt</font></code><font color="#222222"> file for the bootloader and config file args, just so </font><code><font color="#9900ff">vbutil_kernel</font></code><font color="#222222"> doesn't complain.  </font></span><font color="#ff0000">(TODO: Seems to work without this.  Is it still needed?)</font></span></li>
<li dir="ltr" style="font-weight:normal;list-style-type:decimal;font-size:13px;font-family:Arial;background-color:transparent;vertical-align:baseline;margin-left:15px"><span style="background-color:transparent;vertical-align:baseline;white-space:pre-wrap"><font color="#222222">We specify </font><code><font color="#9900ff">--arch arm</font></code><font color="#222222"> even if we're building for x86, because x86 kernels have a preamble that </font><code><font color="#9900ff">vbutil_kernel</font></code><font color="#222222"> will try to remove and U-Boot doesn't have that.</font></span></li>
<li dir="ltr" style="font-weight:normal;list-style-type:decimal;font-size:13px;font-family:Arial;background-color:transparent;vertical-align:baseline;margin-left:15px"><span style="background-color:transparent;vertical-align:baseline;white-space:pre-wrap"><font color="#222222">At some point we should modify </font><code><font color="#9900ff">vbutil_kernel</font></code><font color="#222222"> to be more accommodating so we don't have to use these tricks. There's a </font></span><a href="http://code.google.com/p/chromium-os/issues/detail?id=23548" style="color:rgb(34,34,34)"><span style="color:rgb(17,85,204);background-color:transparent;vertical-align:baseline;white-space:pre-wrap">bug</span></a><span style="color:rgb(34,34,34);background-color:transparent;vertical-align:baseline;white-space:pre-wrap"> open for that, and I'll get to it Real Soon Now.</span></li>
</ol>
</b></div>
<p><b>Step three</b> is to copy that image to the chromebook and try it out.</p>
<div><b><span style="font-family:Courier New;font-size:13px;font-weight:normal;color:rgb(34,34,34);background-color:transparent;vertical-align:baseline;white-space:pre-wrap">    chronos#  cd /mnt/stateful_partition/</span><br />
<span style="font-family:Courier New;font-size:13px;font-weight:normal;color:rgb(34,34,34);background-color:transparent;vertical-align:baseline;white-space:pre-wrap">    chronos#  scp YOU@SOMEWHERE:/PATH/TO/kernelpart.bin .</span><br />
</b>
<p>Install it into partition 4 (assuming we've booted from partition 2):</p>
<b><span style="font-family:Courier New;font-weight:normal;color:rgb(34,34,34);background-color:transparent;vertical-align:baseline;white-space:pre-wrap">    chronos#  dd if=kernelpart.bin of=/dev/sda4</span></b><b><br />
<span style="font-family:Courier New;font-size:13px;font-weight:normal;color:rgb(34,34,34);background-color:transparent;vertical-align:baseline;white-space:pre-wrap">    chronos#  cgpt add -i 4 -P 9 -T 1 -S 0 /dev/sda</span><br />
</b>
<p><b><span style="font-family:Arial;font-size:13px;font-weight:normal;color:rgb(34,34,34);background-color:transparent;vertical-align:baseline;white-space:pre-wrap">Note that I'm making partition 4 a high priority, but marking it as unsuccessful and with a tries count of 1. That way, when you reboot, you'll go back to your previous (working) ChromeOS kernel in partition 2.</span></b></p>
</div>
<p>Reboot and if all goes well, your code should run.</p><p>An alternate here is to enable USB boot (<code><font color="#990000">crossystem dev_boot_usb=1</font></code>) and then boot from an SD card / USB key that you built/burned with <code><font color="#9900ff">build_image</font></code> / <span style="color:rgb(153,0,255);font-family:monospace;font-size:10pt">image_to_usb</span><span style="font-size:10pt">.  In that case you can just put your <code><font color="#9900ff">${KPART}</font></code> straight into partition 2 and boot it with Ctrl-U.</span></p>
<h3><a name="TOC-Known-issues"></a><b>Known issues</b></h3>
<p>There probably are some. Even within a single type of firmware, each Chromebook has a slightly different version. Testing is done and bugs are fixed right up until final manufacturing, and development continues on the top of tree constantly. The standard Linux kernel doesn't generally trust the BIOS very much, so it often does a lot of its own hardware initialization even on Chrome OS. That means that some firmware bugs may exist that are masked or cleaned up by the kernel, where they won't be exposed by testing. Plus, there can be dependencies between the RO firmware (Coreboot, especially) and the RW firmware that a custom bootloader may not be aware of.</p>
<h2><a name="TOC-I-m-not-afraid-of-damaging-things"></a>I'm not afraid of damaging things</h2>
<p>Well, okay then. Here's <a href="http://goo.gl/jsE8EE" target="_blank">a presentation from OSCON 2013</a> on how to build and install your own firmware, including the read-only parts. Good luck.</p>
</div></div></td></tr></tbody></table>
</div> 
</div> 
<div id="sites-canvas-bottom-panel">
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_page-subpages"> </div>
<div id="sites-attachments-container">
</div>
<a xmlns="http://www.w3.org/1999/xhtml" name="page-comments"></a>
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_page-comments"><div class="sites-comment-docos-wrapper"><div class="sites-comment-docos"><div class="sites-comment-docos-background"></div><div class="sites-comment-docos-header"><div class="sites-comment-docos-header-title">Comments</div></div><div id="sites-comment-docos-pane" class="sites-comment-docos-pane"></div></div></div></div>
</div>
</div> 
</td> 
</tr>
</table> 
</div> 
</div> 
<div id="sites-chrome-footer-wrapper">
<div id="sites-chrome-footer-wrapper-inside">
<div id="sites-chrome-footer">
</div>
</div>
</div>
</div> 
</div> 
<div id="sites-chrome-adminfooter-container">
<div xmlns="http://www.w3.org/1999/xhtml" class="sites-adminfooter" role="navigation"><p><a class="sites-system-link" href="https://www.google.com/a/UniversalLogin?service=jotspot&amp;continue=https://sites.google.com/a/chromium.org/dev/chromium-os/developer-information-for-chrome-os-devices/custom-firmware">Sign in</a><span aria-hidden="true">|</span><a class="sites-system-link" href="/system/app/pages/recentChanges">Recent Site Activity</a><span aria-hidden="true">|</span><a class="sites-system-link" href="/system/app/pages/reportAbuse" target="_blank">Report Abuse</a><span aria-hidden="true">|</span><a class="sites-system-link" href="javascript:;" onclick="window.open(webspace.printUrl)">Print Page</a><span aria-hidden="true">|</span><span class="sites-system-link">Powered By</span> <b class="powered-by"><a href="http://sites.google.com">Google Sites</a></b></p></div>
</div>
</div> 
</div> 
<div id="sites-chrome-onebar-footer">
</div>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
    window.jstiming.load.tick('sjl');
  </script>
<script xmlns="http://www.w3.org/1999/xhtml" src="https://ssl.gstatic.com/sites/p/56e332/system/js/jot_min_view__en.js"></script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
    window.jstiming.load.tick('jl');
  </script>
<script xmlns="http://www.w3.org/1999/xhtml">
      
          sites.core.Analytics.createTracker();
          sites.core.Analytics.trackPageview();
        
    </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
                    sites.Searchbox.initialize(
                        'sites-searchbox-search-button',
                        {"object":[]}['object'],
                        'search-site',
                        {"label":"Configure search options...","url":"/system/app/pages/admin/settings"});
                  </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
      gsites.HoverPopupMenu.createSiteDropdownMenus('sites-header-nav-dropdown', false);
    </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript" defer="true">
            JOT_setupNav("7648876402527094", "Navigation", false);
            JOT_addListener('titleChange', 'JOT_NAVIGATION_titleChange', 'COMP_7648876402527094');
          </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript" defer="true">
            JOT_setupNav("14720868319272995", "Quick links", false);
            JOT_addListener('titleChange', 'JOT_NAVIGATION_titleChange', 'COMP_14720868319272995');
          </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript" defer="true">
            JOT_setupNav("19690813310444355", "Other sites", false);
            JOT_addListener('titleChange', 'JOT_NAVIGATION_titleChange', 'COMP_19690813310444355');
          </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
              new sites.CommentPane('//docs.google.com/comments/d/AAHRpnXukca4jaDOG9SuQz_G8t7HlyjMRdsEaI-1pdbafNIp0uAf_KDzoQFnYBgRMB7GYA5ZkpcIKi7ZIBCrWckWSUdUrzbmQnzEpNZXzM56DJJ57ZnzMN4tmTZgRkNbJInItz6villEw/api/js?anon=true',
                  false, false);
            </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
  setTimeout(function() {
    var fingerprint = gsites.date.TimeZone.getFingerprint([]);
    gsites.Xhr.send('https://www.chromium.org/_/tz', null, null, 'GET', null, null, { afjstz: fingerprint });
  }, 500);
</script>
<script xmlns="http://www.w3.org/1999/xhtml">
                    window.onload = function() {
                      if (false) {
                        JOT_setMobilePreview();
                      }
                      var loadTimer = window.jstiming.load;
                      loadTimer.tick("ol");
                      loadTimer["name"] = "load," + webspace.page.type + ",user_page";
                      window.jstiming.report(loadTimer, {}, 'https://gg.google.com/csi');
                    }
                  </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
        JOT_insertAnalyticsCode(false,
            false);
      </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
    var maestroRunner = new gsites.pages.view.SitesMaestroRunner(
        webspace, "en");
    maestroRunner.initListeners();
    maestroRunner.installEditRender();
  </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript" defer="true">
  //<![CDATA[
    // Decorate any fastUI buttons on the page with a class of 'goog-button'.
    if (webspace.user.hasWriteAccess) {
      JOT_decorateButtons();
    }

    // Fires delayed events.
    (function() {
      JOT_fullyLoaded = true;
      var delayedEvents = JOT_delayedEvents;
      for (var x = 0; x < delayedEvents.length; x++) {
        var event = delayedEvents[x];
        JOT_postEvent(event.eventName, event.eventSrc, event.payload);
      }
      JOT_delayedEvents = null;
      JOT_postEvent('pageLoaded');
    })();
  //]]>
</script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
    JOT_postEvent('decorateGvizCharts');
  </script>
<script type="text/javascript">
          JOT_setupPostRenderingManager();
        </script>
<script type="text/javascript">
          JOT_postEvent('renderPlus', null, 'sites-chrome-main');
        </script>
<div id="server-timer-div" style="display:none"> </div>
<script type="text/javascript">
          window.jstiming.load.tick('render');
          JOT_postEvent('usercontentrendered', this);
        </script>
</body>
</html>
