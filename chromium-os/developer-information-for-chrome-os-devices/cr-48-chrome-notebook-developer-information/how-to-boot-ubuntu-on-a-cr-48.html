<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/WebPage">
<head>
<meta http-equiv="X-UA-Compatible" content="chrome=1" />
<script type="text/javascript">/* Copyright 2008 Google. */ (function() { var e="wtsrt_",g="tbsd_",h="tbnd_",k="start",l="_wtsrt",m="_tbnd",n="CSI/";(function(){function f(a){this.t={};this.tick=function(a,c,b){this.t[a]=[void 0!=b?b:(new Date).getTime(),c];if(void 0==b)try{window.console.timeStamp(n+a)}catch(d){}};this.tick(k,null,a)}var a;window.performance&&(a=window.performance.timing);var p=a?new f(a.responseStart):new f;window.jstiming={Timer:f,load:p};if(a){var c=a.navigationStart,d=a.responseStart;0<c&&d>=c&&(window.jstiming.srt=d-c)}if(a){var b=window.jstiming.load;0<c&&d>=c&&(b.tick(l,void 0,c),b.tick(e,l,d),b.tick(g,e))}try{a=null,
window.chrome&&window.chrome.csi&&(a=Math.floor(window.chrome.csi().pageT),b&&0<c&&(b.tick(m,void 0,window.chrome.csi().startE),b.tick(h,m,c))),null==a&&window.gtbExternal&&(a=window.gtbExternal.pageT()),null==a&&window.external&&(a=window.external.pageT,b&&0<c&&(b.tick(m,void 0,window.external.startE),b.tick(h,m,c))),a&&(window.jstiming.pt=a)}catch(q){}})(); })()
</script>
<link rel="shortcut icon" href="http://www.chromium.org/_/rsrc/1354323194313/favicon.ico" type="image/x-icon" />
<link rel="apple-touch-icon" href="http://www.gstatic.com/sites/p/56e332/system/app/images/apple-touch-icon.png" type="image/png" />
<script type="text/javascript">/* Copyright 2008 Google. */ (function() { var d="",g="__duration__",h="function";function k(c){return document.getElementById(c)}window.byId=k;function l(c){return c.replace(/^\s+|\s+$/g,d)}window.trim=l;var m=[],n=0;window.JOT_addListener=function(c,a,b){var e=new String(n++);c={eventName:c,handler:a,compId:b,key:e};m.push(c);return e};window.JOT_removeListenerByKey=function(c){for(var a=0;a<m.length;a++)if(m[a].key==c){m.splice(a,1);break}};
window.JOT_removeAllListenersForName=function(c){for(var a=0;a<m.length;a++)m[a].eventName==c&&m.splice(a,1)};window.JOT_postEvent=function(c,a,b){var e={eventName:c,eventSrc:a||{},payload:b||{}};if(window.JOT_fullyLoaded)for(a=m.length,b=0;b<a&&b<m.length;b++){var f=m[b];f&&f.eventName==c&&(e.listenerCompId=f.compId||d,(f=typeof f.handler==h?f.handler:window[f.handler])&&f(e))}else window.JOT_delayedEvents.push({eventName:c,eventSrc:a,payload:b})};window.JOT_delayedEvents=[];
window.JOT_fullyLoaded=!1;window.JOT_formatRelativeToNow=function(c,a){var b=((new Date).getTime()-c)/6E4;if(1440<=b||0>b)return null;var e=0;60<=b&&(b/=60,e=2);2<=b&&e++;return a?window.JOT_siteRelTimeStrs[e].replace(g,Math.floor(b)):window.JOT_userRelTimeStrs[e].replace(g,Math.floor(b))}; })()
</script>
<script>

  

  var breadcrumbs = [{"path":"/chromium-os","deleted":false,"title":"Chromium OS","dir":"ltr"},{"path":"/chromium-os/developer-information-for-chrome-os-devices","deleted":false,"title":"Developer Information for Chrome OS Devices","dir":"ltr"},{"path":"/chromium-os/developer-information-for-chrome-os-devices/cr-48-chrome-notebook-developer-information","deleted":false,"title":"Cr-48 Chrome Notebook Developer Information","dir":"ltr"},{"path":"/chromium-os/developer-information-for-chrome-os-devices/cr-48-chrome-notebook-developer-information/how-to-boot-ubuntu-on-a-cr-48","deleted":false,"title":"How to boot Ubuntu on a Cr-48","dir":"ltr"}];
  var JOT_clearDotPath = 'http://www.gstatic.com/sites/p/56e332/system/app/images/cleardot.gif';

  
  var JOT_userRelTimeStrs = ["a minute ago","__duration__ minutes ago","an hour ago","__duration__ hours ago"];

  
  

  

  var webspace = {"enableAnalytics":true,"pageSharingId":"jotspot_page","enableUniversalAnalytics":false,"sharingPolicy":"OPENED_WITH_INDICATOR","siteTitle":"The Chromium Projects","isStartPageEnabled":true,"adsensePublisherId":null,"features":{"languageSelectDefaultTextSetToDefault":true,"validateClientGvizDataSourceUrls":true,"moreMobileStyleImprovements":true,"newInsertMenuIcons":true,"accessibleSortingButtons":true,"domainAnalyticsInGAOnly":true,"noCaptcha":true,"fileCabinetScreenReaderFix":true,"updatedTosAndPrivacyLinks":null,"pageDrafts":false,"mobileOrientationFix":true,"plusBadge":false,"pdfEmbedSupport":false,"jsClickFix":true},"isPublic":true,"isConsumer":false,"serverFlags":{"cajaBaseUrl":"//www.gstatic.com/caja","cajaDebugMode":false},"onepickBaseUrl":"https://docs.google.com","domainAnalyticsAccountId":"","plusPageId":"","signInUrl":"https://www.google.com/a/SelectSession?continue\u003dhttp://sites.google.com/a/chromium.org/dev/chromium-os/developer-information-for-chrome-os-devices/cr-48-chrome-notebook-developer-information/how-to-boot-ubuntu-on-a-cr-48\u0026service\u003djotspot","analyticsAccountId":"UA-5484340-1","scottyUrl":"/_/upload","homePath":"/","siteNoticeUrlEnabled":null,"plusPageUrl":"","adsensePromoClickedOrSiteIneligible":true,"csiReportUri":"http://csi.gstatic.com/csi","sharingId":"jotspot","termsUrl":"//www.google.com/intl/en/policies/terms/","gvizVersion":1,"editorResources":{"sitelayout":["http://www.gstatic.com/sites/p/56e332/system/app/css/sitelayouteditor.css"],"text":["http://www.gstatic.com/sites/p/56e332/system/js/codemirror.js","http://www.gstatic.com/sites/p/56e332/system/app/css/codemirror_css.css","http://www.gstatic.com/sites/p/56e332/system/js/trog_edit__en.js","http://www.gstatic.com/sites/p/56e332/system/app/css/trogedit.css","/_/rsrc/1441580320000/system/app/css/editor.css","http://www.gstatic.com/sites/p/56e332/system/app/css/codeeditor.css","/_/rsrc/1441580320000/system/app/css/camelot/editor-jfk-wlb.css"]},"sharingUrlPrefix":"/_/sharing","isAdsenseEnabled":true,"domain":"chromium.org","baseUri":"","name":"dev","siteTemplateId":false,"siteNoticeRevision":null,"siteNoticeUrlAddress":null,"siteNoticeMessage":null,"page":{"isRtlLocale":false,"canDeleteWebspace":null,"isPageDraft":null,"parentPath":"/chromium-os/developer-information-for-chrome-os-devices/cr-48-chrome-notebook-developer-information","parentWuid":"wuid:gx:5fbc40735c7850dc","siteLocale":"en","timeZone":"America/Los_Angeles","type":"text","title":"How to boot Ubuntu on a Cr-48","locale":"en","wuid":"wuid:gx:4d0359363dfe547","revision":20,"path":"/chromium-os/developer-information-for-chrome-os-devices/cr-48-chrome-notebook-developer-information/how-to-boot-ubuntu-on-a-cr-48","isSiteRtlLocale":false,"pageInheritsPermissions":null,"name":"how-to-boot-ubuntu-on-a-cr-48","canChangePath":true,"state":"","properties":{},"bidiEnabled":false,"currentTemplate":{"path":"/system/app/pagetemplates/text","title":"Web Page"}},"canPublishScriptToAnyone":true,"user":{"keyboardShortcuts":true,"sessionIndex":"","guest_":true,"displayNameOrEmail":"guest","userName":"guest","uid":"","renderMobile":false,"domain":"","namespace":"","hasWriteAccess":false,"namespaceUser":false,"primaryEmail":"guest","hasAdminAccess":false},"gadgets":{"baseUri":"/system/app/pages/gadgets"}};
  webspace.page.breadcrumbs = breadcrumbs;

  
  var JOT_siteRelTimeStrs = ["a minute ago","__duration__ minutes ago","an hour ago","__duration__ hours ago"];

</script>
<script type="text/javascript">
                window.jstiming.load.tick('scl');
              </script>
<meta name="title" content="How to boot Ubuntu on a Cr-48 - The Chromium Projects" />
<meta itemprop="name" content="How to boot Ubuntu on a Cr-48 - The Chromium Projects" />
<meta property="og:title" content="How to boot Ubuntu on a Cr-48 - The Chromium Projects" />
<meta name="description" content="Home of the Chromium Open Source Project" />
<meta itemprop="description" content="Home of the Chromium Open Source Project" />
<meta id="meta-tag-description" property="og:description" content="Home of the Chromium Open Source Project" />
<style type="text/css">
</style>
<link rel="stylesheet" type="text/css" href="http://www.gstatic.com/sites/p/56e332/system/app/themes/beigeandblue/standard-css-beigeandblue-ltr-ltr.css" />
<link rel="stylesheet" type="text/css" href="http://www.chromium.org/_/rsrc/1441580320000/system/app/css/overlay.css?cb=beigeandblueundefineda100%25%25150goog-ws-leftthemedefaultstandard" />
<link rel="stylesheet" type="text/css" href="http://www.chromium.org/_/rsrc/1441580320000/system/app/css/camelot/allthemes-view.css" />
<!--[if IE]>
          <link rel="stylesheet" type="text/css" href="/system/app/css/camelot/allthemes%2die.css" />
        <![endif]-->
<title>How to boot Ubuntu on a Cr-48 - The Chromium Projects</title>
<meta itemprop="image" content="/_/rsrc/1438879449147/config/customLogo.gif?revision=3" />
<meta property="og:image" content="/_/rsrc/1438879449147/config/customLogo.gif?revision=3" />
<script type="text/javascript">
                window.jstiming.load.tick('cl');
              </script>
</head>
<body xmlns="http://www.google.com/ns/jotspot" id="body" class=" en            ">
<div id="sites-page-toolbar" class="sites-header-divider">
<div xmlns="http://www.w3.org/1999/xhtml" id="sites-status" class="sites-status" style="display:none;"><div id="sites-notice" class="sites-notice" role="status" aria-live="assertive"> </div></div>
</div>
<div id="sites-chrome-everything-scrollbar">
<div id="sites-chrome-everything" class="">
<div id="sites-chrome-page-wrapper" style="direction: ltr">
<div id="sites-chrome-page-wrapper-inside">
<div xmlns="http://www.w3.org/1999/xhtml" id="sites-chrome-header-wrapper" style="height:auto;">
<table id="sites-chrome-header" class="sites-layout-hbox" cellspacing="0" style="height:auto;">
<tr class="sites-header-primary-row" id="sites-chrome-userheader">
<td id="sites-header-title" class="" role="banner"><div class="sites-header-cell-buffer-wrapper"><a href="http://www.chromium.org/" id="sites-chrome-userheader-logo"><img id="logo-img-id" src="http://www.chromium.org/_/rsrc/1438879449147/config/customLogo.gif?revision=3" alt="The Chromium Projects" class="sites-logo  " /></a><h2><a href="http://www.chromium.org/" dir="ltr" id="sites-chrome-userheader-title">The Chromium Projects</a></h2></div></td><td class="sites-layout-searchbox  "><div class="sites-header-cell-buffer-wrapper"><form id="sites-searchbox-form" action="http://www.chromium.org/system/app/pages/search" role="search"><input type="hidden" id="sites-searchbox-scope" name="scope" value="search-site" /><input type="text" id="jot-ui-searchInput" name="q" size="20" value="" aria-label="Search this site" /><div id="sites-searchbox-button-set" class="goog-inline-block"><div role="button" id="sites-searchbox-search-button" class="goog-inline-block jfk-button jfk-button-standard" tabindex="0">Search this site</div></div></form></div></td>
</tr>
<tr class="sites-header-secondary-row" id="sites-chrome-horizontal-nav">
<td colspan="2" id="sites-chrome-header-horizontal-nav-container" role="navigation">
</td>
</tr>
</table>
</div>
<div id="sites-chrome-main-wrapper">
<div id="sites-chrome-main-wrapper-inside">
<table id="sites-chrome-main" class="sites-layout-hbox" cellspacing="0" cellpadding="{scmCellpadding}" border="0">
<tr>
<td id="sites-chrome-sidebar-left" class="sites-layout-sidebar-left initial" style="width:150px">
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_7648876402527094" class="sites-embed" role="navigation"><div class="sites-embed-content sites-sidebar-nav"><ul role="navigation" jotId="navList"><li class="nav-first "><div dir="ltr" style="padding-left: 5px;"><a href="http://www.chromium.org/chromium-projects" jotId="wuid:gx:10ae433dadbbab13" class="sites-navigation-link">Home</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="../../../Home.html" jotId="wuid:gx:43582b9d2029d3af" class="sites-navigation-link">Chromium</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="../../../chromium-os.html" jotId="wuid:gx:83df2ab1f8880ba" class="sites-navigation-link">Chromium OS</a></div></li></ul></div></div>
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_14720868319272995" class="sites-embed" role="navigation"><h4 class="sites-embed-title">Quick links</h4><div class="sites-embed-content sites-sidebar-nav"><ul role="navigation" jotId="navList"><li class="nav-first "><div dir="ltr" style="padding-left: 5px;"><a href="../../../for-testers/bug-reporting-guidelines.html" class="sites-navigation-link">Report bugs</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="../../../developers/discussion-groups.html" class="sites-navigation-link">Discuss</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="http://www.chromium.org/system/app/pages/sitemap/hierarchy" jotId="wuid:gx:4b58a9a350ad12f" class="sites-navigation-link">网站地图</a></div></li></ul></div></div>
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_19690813310444355" class="sites-embed" role="navigation"><h4 class="sites-embed-title">Other sites</h4><div class="sites-embed-content sites-sidebar-nav"><ul role="navigation" jotId="navList"><li class="nav-first "><div dir="ltr" style="padding-left: 5px;"><a href="http://blog.chromium.org/" class="sites-navigation-link">Chromium Blog</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="http://code.google.com/chrome/extensions/" class="sites-navigation-link">Google Chrome Extensions</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="https://developers.google.com/chrome/chrome-frame/" class="sites-navigation-link">Google Chrome Frame</a></div></li></ul></div></div>
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_19695218559354544" class="sites-embed" role="complementary"><h4 class="sites-embed-title"></h4><div class="sites-embed-content sites-embed-content-sidebar-textbox"><div dir="ltr"><span style="font-size:x-small">Except as otherwise </span><a href="http://developers.google.com/site-policies.html#restrictions"><span style="font-size:x-small">noted</span></a><span style="font-size:x-small">, the content of this page is licensed under a </span><a href="http://creativecommons.org/licenses/by/2.5/"><span style="font-size:x-small">Creative Commons Attribution 2.5 license</span></a><span style="font-size:x-small">, and examples are licensed under the </span><a href="http://src.chromium.org/viewvc/chrome/trunk/src/LICENSE" target="_blank"><span style="font-size:x-small">BSD License</span></a><span style="font-size:x-small">.<br /></span></div></div></div>
</td>
<td id="sites-canvas-wrapper">
<div id="sites-canvas" role="main">
<div id="goog-ws-editor-toolbar-container"> </div>
<div xmlns="http://www.w3.org/1999/xhtml" id="title-crumbs" style="">
<A href="../../../chromium-os.html" dir="ltr">Chromium OS</A>‎ &gt; ‎<A href="../../developer-information-for-chrome-os-devices.html" dir="ltr">Developer Information for Chrome OS Devices</A>‎ &gt; ‎<A href="../cr-48-chrome-notebook-developer-information.html" dir="ltr">Cr-48 Chrome Notebook Developer Information</A>‎ &gt; ‎
  </div>
<h3 xmlns="http://www.w3.org/1999/xhtml" id="sites-page-title-header" style="" align="left">
<span id="sites-page-title" dir="ltr" tabindex="-1" style="outline: none">How to boot Ubuntu on a Cr-48</span>
</h3>
<div id="sites-canvas-main" class="sites-canvas-main">
<div id="sites-canvas-main-content">
<table xmlns="http://www.w3.org/1999/xhtml" cellspacing="0" class="sites-layout-name-one-column sites-layout-hbox"><tbody><tr><td class="sites-layout-tile sites-tile-name-content-1"><div dir="ltr"><div class="sites-embed-align-right-wrapping-on"><div class="sites-embed-border-off sites-embed" style="width:250px;"><div class="sites-embed-content sites-embed-type-toc"><div class="goog-toc sites-embed-toc-maxdepth-6"><p>Contents</p><ol class="goog-toc"><li class="goog-toc"><a href="how-to-boot-ubuntu-on-a-cr-48.html#TOC-Free-up-some-SSD-space-for-Ubuntu"><strong>1 </strong>Free up some SSD space for Ubuntu</a></li><li class="goog-toc"><a href="how-to-boot-ubuntu-on-a-cr-48.html#TOC-Acquire-an-Ubuntu-filesystem"><strong>2 </strong>Acquire an Ubuntu filesystem</a></li><li class="goog-toc"><a href="how-to-boot-ubuntu-on-a-cr-48.html#TOC-Configure-the-kernel"><strong>3 </strong>Configure the kernel</a></li><li class="goog-toc"><a href="how-to-boot-ubuntu-on-a-cr-48.html#TOC-Set-boot-priority"><strong>4 </strong>Set boot priority</a></li><li class="goog-toc"><a href="how-to-boot-ubuntu-on-a-cr-48.html#TOC-Footnotes"><strong>5 </strong>Footnotes</a><ol class="goog-toc"><li class="goog-toc"><a href="how-to-boot-ubuntu-on-a-cr-48.html#TOC-Ugh"><strong>5.1 </strong>Ugh</a></li><li class="goog-toc"><a href="how-to-boot-ubuntu-on-a-cr-48.html#TOC-Double-ugh"><strong>5.2 </strong>Double-ugh</a></li></ol></li></ol></div></div></div></div><span style="font-size:20px;font-weight:bold">Introduction</span>
<p>While <a href="../../chromiumos-design-docs/verified-boot.html" target="_blank">Chrome OS verified boot</a> protects against unintended system modification by malicious or buggy software, <b>the ability to hack your own device is an <a href="http://www.chromium.org/chromium-os/chromiumos-design-docs/developer-mode">intentional</a> design feature of Google Chrome notebooks</b>. The instructions for <a href="../../developer-guide.html">building your own version of Chromium OS</a>, and installing it on a Cr-48 are given elsewhere. Some enthusiasts, however, may want to install something completely different. This page provides an example, showing how the official Chrome OS software can coexist with <a href="http://www.ubuntu.com/" target="_blank">Ubuntu</a>, a popular linux distribution. I'm assuming that you're already somewhat familiar with the Chromium OS development environment.<br /></p><div><span style="font-size:10pt"><b>Caution: Modifications you make to the system are not supported by Google, may cause hardware</b></span><b style="font-size:10pt"><span style="font-size:10pt">, software or security</span></b><b style="font-size:10pt"> issues and may void warranty.</b><span style="font-size:10pt"> Be very careful.</span></div>
<p>These instructions work on the Cr-48 as originally shipped. There are several magic numbers that may change following software updates or on other Chromium OS-based machines. Even if the numbers don't exactly match, the basic idea is the same.<br /></p>
<p>In the examples below:</p>
<div class="sites-codeblock sites-codesnippet-block"><code>The Cr-48 shell is formatted like this.</code><br />
</div>
<div class="sites-codeblock sites-codesnippet-block"><code><font color="#9900ff">The Chromium OS build chroot is formatted like this.</font></code></div>
<span style="font-family:monospace;line-height:13px">
<div class="sites-codeblock sites-codesnippet-block"><code><font color="#783f04">The standard linux workstation shell is formatted like this.</font></code></div>
<br />
<span style="font-family:Arial,Verdana,sans-serif;font-size:20px;font-weight:bold;line-height:normal">Fair warning</span><br />
</span>
<div>
<p>This is kind of a cheat. The Cr-48's boot process does not support <code><a href="http://www.ibm.com/developerworks/linux/library/l-initrd.html" target="_blank">initrd</a></code>, which is required by Ubuntu. That leaves us three possibilities:</p>
<div>
<ol><li>Use the existing Chrome OS kernel with the Ubuntu rootfs.</li>
<li>Recompile the Ubuntu kernel to do without <code>initrd</code> (<a href="how-to-boot-ubuntu-on-a-cr-48.html#TOC-Ugh">ugh</a>).</li>
<li>Modify the Chrome OS bootstub to handle <code>initrd</code> (<a href="how-to-boot-ubuntu-on-a-cr-48.html#TOC-Double-ugh">double-ugh</a>).</li>
</ol>
</div>
<div>Let's take door #1.</div>
<h2><a name="TOC-Free-up-some-SSD-space-for-Ubuntu"></a>Free up some SSD space for Ubuntu</h2>
<div>To begin our journey, first switch the Cr-48 into <a href="../cr-48-chrome-notebook-developer-information.html" target="_blank">developer mode</a> and reboot.  When you see the blue frowny face with the "Chrome OS verification is turned off" message, either wait 30 seconds or hit Ctrl-D to boot immediately. This screen is always shown when booting in developer mode, to ensure that someone doesn't change your OS without your knowledge.</div>
<div><br />
</div>
<div>Switch to <a href="http://www.chromium.org/poking-around-your-chrome-os-device#TOC-Get-the-command-prompt-through-VT-2" target="_blank">VT2</a> (press [ Ctrl ] [ Alt ] [ =&gt; ]), and log in as user 'chronos' (no password required), then run <code>sudo bash</code>.</div>
<div><br />
</div>
<div>To prevent the lock screen from logging you out of VT2, leave Chrome OS parked on the login screen. To prevent the backlight from dimming while in VT2, run <span style="font-family:monospace;color:rgb(0,96,0)">sudo initctl stop powerd</span>.</div>
<div><br />
</div>
<div>Take a look at the SSD layout. It should be something like this (the UUID values will all be different, of course):</div>
<div><br />
</div>
<div>
<div></div>
</div>
<div class="sites-codeblock sites-codesnippet-block">
<div>
<div><code>localhost ~ # <b>cgpt show /dev/sda</b></code></div>
<div><code>     start      size    part  contents</code></div>
<div><code>         0         1          PMBR (Boot GUID: 045E5C92-6F57-9B46-BDCC-99BFF876E469)</code></div>
<div><code>         1         1          Pri GPT header</code></div>
<div><code>         2        32          Pri GPT table</code></div>
<div><code>    266240  22622208       1  Label: "STATE"</code></div>
<div><code>                              Type: Linux data</code></div>
<div><code>                              UUID: 1844A16D-AEC9-7C4B-9553-C3EB4814F6BB</code></div>
<div><code>      4096     32768       2  Label: "KERN-A"</code></div>
<div><code>                              Type: ChromeOS kernel</code></div>
<div><code>                              UUID: D176DC60-81F1-654E-8953-E3D28019738C</code></div>
<div><code>                              Attr: priority=3 tries=0 successful=1</code></div>
<div><code>  27082752   4194304       3  Label: "ROOT-A"</code></div>
<div><code>                              Type: ChromeOS rootfs</code></div>
<div><code>                              UUID: 0193CA51-DA12-9847-A715-C90433E55F60</code></div>
<div><code>     36864     32768       4  Label: "KERN-B"</code></div>
<div><code>                              Type: ChromeOS kernel</code></div>
<div><code>                              UUID: F1A2C65C-CC22-FF4A-A8BC-67BA233F3D40</code></div>
<div><code>                              Attr: priority=0 tries=15 successful=0</code></div>
<div><code>  22888448   4194304       5  Label: "ROOT-B"</code></div>
<div><code>                              Type: ChromeOS rootfs</code></div>
<div><code>                              UUID: B3361FB5-4DAC-9344-B7E5-870B7AC5FEA1</code></div>
<div><code>        34         1       6  Label: "KERN-C"</code></div>
<div><code>                              Type: ChromeOS kernel</code></div>
<div><code>                              UUID: B6954485-4295-9749-956A-C315B01FB684</code></div>
<div><code>                              Attr: priority=0 tries=15 successful=0</code></div>
<div><code>        35         1       7  Label: "ROOT-C"</code></div>
<div><code>                              Type: ChromeOS rootfs</code></div>
<div><code>                              UUID: 5B5202B5-F74B-714E-9538-ADE56B2E5662</code></div>
<div><code>     69632     32768       8  Label: "OEM"</code></div>
<div><code>                              Type: Linux data</code></div>
<div><code>                              UUID: 84971802-0D1C-504B-9CB5-DEA896F0AD3F</code></div>
<div><code>        36         1       9  Label: "reserved"</code></div>
<div><code>                              Type: ChromeOS reserved</code></div>
<div><code>                              UUID: 77375DA6-8F07-704A-BBF4-2BCA662BFDFF</code></div>
<div><code>        37         1      10  Label: "reserved"</code></div>
<div><code>                              Type: ChromeOS reserved</code></div>
<div><code>                              UUID: 6880F478-EB05-8B4B-B951-94A96076263E</code></div>
<div><code>        38         1      11  Label: "reserved"</code></div>
<div><code>                              Type: ChromeOS reserved</code></div>
<div><code>                              UUID: 12DDC236-8FDF-4049-9A2D-10FAB17D3AA9</code></div>
<div><code>    233472     32768      12  Label: "EFI-SYSTEM"</code></div>
<div><code>                              Type: EFI System Partition</code></div>
<div><code>                              UUID: 045E5C92-6F57-9B46-BDCC-99BFF876E469</code></div>
<div><code>  31277199        32          Sec GPT table</code></div>
<div><code>  31277231         1          Sec GPT header</code></div>
</div>
<div></div>
</div>
<div><br />
</div>
<div>The units are 512-byte disk sectors.</div>
<div><br />
</div>
<div>
<div>On Chrome OS there are several bootable images, each composed of a kernel and a root filesystem (rootfs).  For a given image, the kernel and rootfs are stored on a pair of consecutive partitions.  Two of these images, Image-A and Image-B, are for official Chrome OS:</div>
<div>
<ul><li>KERN-A and ROOT-A on partitions <code>/dev/sda2</code> and <code>/dev/sda3</code></li>
<li>KERN-B and ROOT-B on partitions <code>/dev/sda4</code> and <code>/dev/sda5</code></li></ul>
</div>
</div>
<div>When the Chrome OS autoupdater downloads a new image (every six weeks or so, as new versions are pushed out), it alternately stores it in Image-A and Image-B - whichever image isn't currently running.  The autoupdater even runs in developer mode, as long as we are running an official Chrome OS image.</div>
<div><br />
</div>
<div>For Ubuntu, we'll use the currently unassigned Image-C, composed of KERN-C and ROOT-C on partitions <code style="color:rgb(0,96,0)">/dev/sda6</code> and <code style="color:rgb(0,96,0)">/dev/sda7</code>, respectively.</div>
<div><br />
</div>
<div>
<div>
<div>However, initially they are too small so, first we need to grow them by stealing from the upper half of the stateful partition, STATE (<code style="color:rgb(0,96,0)">/dev/sda1</code>).  Initially, STATE is 22622208 512-byte sectors, or just under 11 GB.  From this we'll set aside 16 MB for KERN-C, and 5 GB for ROOT-C.</div>
</div>
</div>
<div><br />
</div>
<div>
<div></div>
<div class="sites-codeblock sites-codesnippet-block">
<div><code>umount /mnt/stateful_partition</code></div>
<div><code>cgpt add -i 1 -b 266240    -s 12103680 -l STATE   /dev/sda</code></div>
<div><code>cgpt add -i 6 -b 12369920  -s 32768    -l KERN-C  /dev/sda</code></div>
<div><code>cgpt add -i 7 -b 12402688  -s 10485760 -l ROOT-C  /dev/sda</code></div>
</div>
</div>
<div><br />
</div>
<div>Using these values ensures that only the original STATE partition is affected.</div>
<div><br />
</div>
<div>Now the partition table should look something like this (changes in <b>bold</b>):</div>
<div><br />
</div>
<div>
<div></div>
<div class="sites-codeblock sites-codesnippet-block">
<div><code>localhost ~ # <b>cgpt show /dev/sda</b></code></div>
<div><code>     start      size    part  contents</code></div>
<div><code>         0         1          PMBR (Boot GUID: 045E5C92-6F57-9B46-BDCC-99BFF876E469)</code></div>
<div><code>         1         1          Pri GPT header</code></div>
<div><code>         2        32          Pri GPT table</code></div>
<div><code>    <b>266240</b>  <b>12103680</b>       1  Label: "STATE"</code></div>
<div><code>                              Type: Linux data</code></div>
<div><code>                              UUID: 1844A16D-AEC9-7C4B-9553-C3EB4814F6BB</code></div>
<div><code>      4096     32768       2  Label: "KERN-A"</code></div>
<div><code>                              Type: ChromeOS kernel</code></div>
<div><code>                              UUID: D176DC60-81F1-654E-8953-E3D28019738C</code></div>
<div><code>                              Attr: priority=3 tries=0 successful=1</code></div>
<div><code>  27082752   4194304       3  Label: "ROOT-A"</code></div>
<div><code>                              Type: ChromeOS rootfs</code></div>
<div><code>                              UUID: 0193CA51-DA12-9847-A715-C90433E55F60</code></div>
<div><code>     36864     32768       4  Label: "KERN-B"</code></div>
<div><code>                              Type: ChromeOS kernel</code></div>
<div><code>                              UUID: F1A2C65C-CC22-FF4A-A8BC-67BA233F3D40</code></div>
<div><code>                              Attr: priority=0 tries=15 successful=0</code></div>
<div><code>  22888448   4194304       5  Label: "ROOT-B"</code></div>
<div><code>                              Type: ChromeOS rootfs</code></div>
<div><code>                              UUID: B3361FB5-4DAC-9344-B7E5-870B7AC5FEA1</code></div>
<div><code>  <b>12369920</b>     <b>32768</b>       6  Label: "KERN-C"</code></div>
<div><code>                              Type: ChromeOS kernel</code></div>
<div><code>                              UUID: B6954485-4295-9749-956A-C315B01FB684</code></div>
<div><code>                              Attr: priority=0 tries=15 successful=0</code></div>
<div><code>  <b>12402688</b>  <b>10485760</b>       7  Label: "ROOT-C"</code></div>
<div><code>                              Type: ChromeOS rootfs</code></div>
<div><code>                              UUID: 5B5202B5-F74B-714E-9538-ADE56B2E5662</code></div>
<div><code>     69632     32768       8  Label: "OEM"</code></div>
<div><code>                              Type: Linux data</code></div>
<div><code>                              UUID: 84971802-0D1C-504B-9CB5-DEA896F0AD3F</code></div>
<div><code>        36         1       9  Label: "reserved"</code></div>
<div><code>                              Type: ChromeOS reserved</code></div>
<div><code>                              UUID: 77375DA6-8F07-704A-BBF4-2BCA662BFDFF</code></div>
<div><code>        37         1      10  Label: "reserved"</code></div>
<div><code>                              Type: ChromeOS reserved</code></div>
<div><code>                              UUID: 6880F478-EB05-8B4B-B951-94A96076263E</code></div>
<div><code>        38         1      11  Label: "reserved"</code></div>
<div><code>                              Type: ChromeOS reserved</code></div>
<div><code>                              UUID: 12DDC236-8FDF-4049-9A2D-10FAB17D3AA9</code></div>
<div><code>    233472     32768      12  Label: "EFI-SYSTEM"</code></div>
<div><code>                              Type: EFI System Partition</code></div>
<div><code>                              UUID: 045E5C92-6F57-9B46-BDCC-99BFF876E469</code></div>
<div><code>  31277199        32          Sec GPT table</code></div>
<div><code>  31277231         1          Sec GPT header</code></div>
</div>
</div>
<div><br />
</div>
<div><br />
</div>
<div>
<div>At this point we should destroy the STATE partition contents, because otherwise at the next boot the startup scripts may notice that it's corrupted and will erase it using the old size (obtained from dumpe2fs) and not the new one. Best to be safe and just zap it now. This will take a couple of minutes to run:</div>
</div>
<div><br />
</div>
<div>
<div class="sites-codeblock sites-codesnippet-block"><code>dd if=/dev/zero of=/dev/sda bs=131072 seek=1040 count=47280</code></div>
</div>
<div><br />
</div>
<div>To speed up SSD access, we use a block size of 131,072 bytes (128 KB), which aligns with the SSD erase size.</div>
<div><br />
</div>
<div>And now reboot so that the startup script recreates the required files in the stateful partition. This will do a safe wipe first, so you'll have to wait a bit (again).</div>
<div><br />
</div>
<div>At this point we're through fiddling with the partition table, so you may want to go back to VT2 and set a password according to these <a href="http://www.chromium.org/poking-around-your-chrome-os-device#TOC-Get-the-command-prompt-through-VT-2">instructions</a>.</div>
<h2><a name="TOC-Acquire-an-Ubuntu-filesystem"></a>Acquire an Ubuntu filesystem</h2>
<div>First, although the Cr-48 CPU and BIOS is 64-bit, the kernel and rootfs are presently 32-bit. Since we're reusing the Chrome OS kernel, we'll download and use the 32-bit ubuntu-10.10-desktop-i386.iso from an <a href="https://launchpad.net/ubuntu/+cdmirrors" target="_blank">Ubuntu CD mirror</a>.  For example:</div>
<div><br />
</div>
<div>
<div class="sites-codeblock sites-codesnippet-block"><font color="#783f04" face="monospace">wget http://mirror.anl.gov/pub/ubuntu-iso/CDs/10.10/ubuntu-10.10-desktop-i386.iso</font></div>
</div>
<div><br />
</div>
<div>Second, even in developer mode, the Cr-48 will only boot external drives that are signed by Google. That means we can't (easily) use the normal Ubuntu live installer. Instead, I'll create an empty disk image file with a 5G partition on it, and use <a href="http://www.virtualbox.org/" target="_blank">VirtualBox</a> to install into that. Then I'll transfer that raw partition onto the Cr-48.</div>
<div><br />
</div>
<div>To install VirtualBox (and its command line management tool, <code>VBoxManage</code>) on Ubuntu:</div>
<div><br />
</div>
<div>
<div class="sites-codeblock sites-codesnippet-block"><code><font color="#783f04">sudo aptitude install virtualbox-ose</font></code></div>
</div>
<div><br />
</div>
<div>I'll do this on my normal linux workstation, of course. I'll create the file inside the chroot so I can use the cgpt tool, but I'll run VirtualBox from outside. We could create the file using fdisk, but using cgpt ensures all the numbers match. You could also build the cgpt tool for use external to the chroot, but whatever. </div>
<div><br />
</div>
<div>We'll need our disk image to be a little larger than 5G so it has room for the GPT headers.</div>
<div><br />
</div>
<div>So, do the following in the <a href="../../developer-guide.html#TOC-Create-a-chroot">Chromium OS chroot</a>:</div>
<div><br />
</div>
<div class="sites-codeblock sites-codesnippet-block">
<div>
<div><code><font color="#9900ff">cd /tmp</font></code></div>
<div><code><font color="#9900ff">rm -rf test.bin</font></code></div>
<div><code><font color="#9900ff">dd if=/dev/zero bs=512 seek=10486015 count=1 of=test.bin</font></code></div>
<div><code><font color="#9900ff">cgpt create test.bin</font></code></div>
<div><code><font color="#9900ff">cgpt boot -p test.bin</font></code></div>
<div><code><font color="#9900ff">cgpt add -b 128 -s 10485760 -t data -l ubuntu test.bin</font></code></div>
</div>
<div></div>
</div>
<br />
<div>From outside the chroot, translate the binary into a virtualbox disk:</div>
<div><br />
</div>
<div></div>
<div class="sites-codeblock sites-codesnippet-block">
<div><code><font color="#7f6000">cd /path/to/chromiumos/chroot/tmp </font></code></div>
<div><span style="font-family:monospace"><code><font color="#7f6000">VBoxManage convertdd test.bin test.vdi --format VDI</font></code></span></div>
<div></div>
</div>
<div><br />
</div>
<div>Launch the VirtualBox GUI (<code><font color="#783f04">virtualbox</font></code>) and create a new virtual machine with 2G of RAM. Configure <code>test.vdi</code> as the existing hard disk (SATA port 0), and attach the Ubuntu .iso as the IDE secondary master. Everything else can be left as default.</div>
<div><br />
</div>
<div>Boot the virtual machine and install Ubuntu onto <code>/dev/sda1</code>.  The Chrome OS kernel does not use swap memory, so be sure to specify partitions manually.  Select the middle <code>/dev/sda1</code>, and format it for <code>ext2</code>, and mount on <code>/</code>.  The ubuntu installer should warn you that you have no swap partition, and it will therefore disable swap.  This is what we want.</div>
<div><br />
</div>
<div>Once Ubuntu is installed, working and updated, shut the virtual machine down and convert the <code>.vdi</code> image back into a binary:</div>
<div><br />
</div>
<div>
<div class="sites-codeblock sites-codesnippet-block"><code><font color="#783f04">VBoxManage internalcommands converttoraw test.vdi test_new.bin</font></code></div>
</div>
<div><br />
</div>
<div>Now, we'll extract just the Ubuntu rootfs partition from the binary file:</div>
<div><br />
</div>
<div>
<div class="sites-codeblock sites-codesnippet-block"><code><font color="#783f04">dd if=test_new.bin bs=512 skip=128 count=10485760 of=rootfs.bin</font></code></div>
</div>
<div><br />
</div>
<div>Next, we copy the ubuntu rootfs directly to the Cr-48 ROOT-C partition (<code>/dev/sda7</code>).  To copy the file, run the following command on the Cr-48, where USER@HOST refers to the account and host from which you are copying.  </div><div><b><br /></b></div><div><b>Note:</b> the root filesystem is a huge file that will take quite a while to upload.  This is much less painful with a fast network connection, so, if possible, use a USB-to-ethernet adapter to avoid going through Wi-Fi.</div>
<div><br />
</div>
<div>
<div class="sites-codeblock sites-codesnippet-block"><code>ssh USER@HOST cat /path/to/rootfs.bin | dd of=/dev/sda7</code></div>
</div>
<div><br /></div><div>If you have to use Wi-Fi, you can reduce the wait with a bit of compression (thanks to Jay Lee for pointing this out):</div><div><br /></div><div class="sites-codeblock sites-codesnippet-block"><code>ssh USER@HOST bzip2 -c /path/to/rootfs.bin | bunzip2 -c | dd of=/dev/sda7</code></div><div><br /></div>
<div>If your network is flaky you might find it easier to use <code>scp</code> to copy the compressed image to the Cr-48 first, then uncompress and write to <code>/dev/sda7</code>. Or you could just copy the <code>rootfs.bin</code> file to a USB stick instead of using the network, but it's likely to take about as long. You always want to use <code>dd</code> to copy the rootfs image into <code>/dev/sda7</code>, of course.<br /><br />You can see that it worked by mounting the new rootfs and looking around:</div>
<div><br />
</div>
<div>
<div></div>
<div class="sites-codeblock sites-codesnippet-block">
<div><code>mkdir /tmp/urfs</code></div>
<div><code>mount /dev/sda7 /tmp/urfs</code></div>
<div><code>ls /tmp/urfs</code></div>
</div>
</div>
<div><br />
</div>
<div>While we're looking, let's copy the <code>cgpt</code> tool into Ubuntu's rootfs. Make sure it's executable. We'll need this later.</div>
<div><br />
</div>
<div>
<div></div>
<div class="sites-codeblock sites-codesnippet-block">
<div><code>cp /usr/bin/cgpt /tmp/urfs/usr/bin/</code></div>
<div><code>chmod a+rx /tmp/urfs/usr/bin/cgpt</code></div>
</div>
</div>
<div><br />
</div>
<div>We'll need to copy all the kernel modules too.</div>
<div><br />
</div>
<div>
<div></div>
<div class="sites-codeblock sites-codesnippet-block">
<div><code>cd /lib/modules</code></div>
<div><code>cp -ar * /tmp/urfs/lib/modules/</code></div>
<div></div>
</div>
<br />
<div>That should do it.</div>
<div><br />
</div>
<div></div>
</div>
<div class="sites-codeblock sites-codesnippet-block">
<div>
<div><code>umount /tmp/urfs</code></div>
</div>
<div></div>
</div>
<br />
<h2><a name="TOC-Configure-the-kernel"></a>Configure the kernel</h2>
<div>The next step is to copy the currently running Chrome OS kernel to KERN-C (<code>/dev/sda6</code>).  Remember, an image consists of a kernel and a rootfs on consecutive partitions.  So, to figure out which kernel is running, we can check which partition is currently mounted as the rootfs:</div>
<div><br />
</div>
<div>
<div class="sites-codeblock sites-codesnippet-block"><code>rootdev -s</code></div>
</div>
<div><br />
</div>
<div>If this prints <code>/dev/sda3</code> (ROOT-A), then our kernel is on <code>/dev/sda2</code> (KERN-A).</div>
<div>If this prints <span style="color:rgb(0,96,0);font-family:monospace">/dev/sda5</span> (ROOT-B), then our kernel is on <span style="color:rgb(0,96,0);font-family:monospace">/dev/sda4</span> (KERN-B).</div>
<div>Assuming our kernel is on <span style="color:rgb(0,96,0);font-family:monospace">/dev/sda2</span> (KERN-A), copy it to <span style="color:rgb(0,96,0);font-family:monospace">/dev/sda6</span> (KERN-C):</div>
<div><br />
</div>
<div></div>
<div class="sites-codeblock sites-codesnippet-block">
<div><code>dd if=/dev/sda2 of=/dev/sda6</code></div>
<div></div>
</div>
<br />
<div>Now we need to change the kernel command line to use our Ubuntu rootfs instead of a Chrome OS rootfs. For this, we'll use <code>make_dev_ssd.sh</code>, located in the Chromium OS source tree under <code>src/platform/vboot_reference/scripts/image_signing/<font color="#000000"><font face="Arial, Verdana, sans-serif">.</font></font></code>  The <a href="http://git.chromium.org/cgi-bin/gitweb.cgi?p=vboot_reference.git;a=tree">latest version</a> has options to change individual kernel command lines.</div>
<div><br />
</div>
<div>Use <code>scp</code> to copy it from your host to the stateful partition of the Cr-48. Note we'll also need <code>common_minimal.sh<font color="#000000" face="Arial, Verdana, sans-serif"> from the same directory.</font></code></div>
<div><br />
</div>
<div></div>
<div class="sites-codeblock sites-codesnippet-block">
<div><code>cd /mnt/stateful_partition</code></div>
<div><code>scp USER@HOST:/some/path/to/latest/make_dev_ssd.sh .</code></div>
<div><code>scp USER@HOST:/some/path/to/latest/common.sh .</code></div>
<div></div>
</div>
<br />
<div>Extract the existing kernel command line from KERN-C, and save it to a file named <code>foo.6</code> (the .6 extension is added by the script):</div>
<div><br />
</div>
<div></div>
<div class="sites-codeblock sites-codesnippet-block">
<div><code>sh ./make_dev_ssd.sh --partitions '6' --save_config foo</code></div>
<div></div>
</div>
<div><br />
</div>
<div>
<div>The default Chrome OS kernel command line looks something like this:</div>
<div><br />
</div>
<div>
<div>
<div class="sites-codeblock sites-codesnippet-block" style="background-color:rgb(239,239,239);border:1px solid rgb(211,211,211);display:block;padding:0.5em 0px 0.5em 1em;line-height:13px"><code style="color:rgb(0,96,0)"><font color="#000000">quiet console=tty2 init=/sbin/init add_efi_memmap boot=local rootwait ro noresume noswap i915.modeset=1 loglevel=1 cros_secure kern_guid=%U tpm_tis.force=1 tpm_tis.interrupts=0 root=/dev/dm-0 dm_verity.error_behavior=3 dm_verity.max_bios=-1 dm_verity.dev_wait=1 dm="vroot none ro,0 1740800 verity /dev/sd%D%P /dev/sd%D%P 1740800 1 sha1 50adbfb72bb1efda0c1a86dcd1c1d6a0b46726d1" noinitrd</font></code></div>
</div>
</div>
</div>
<br />
<div>The only editor on the Cr-48 is qemacs, so open foo.6 with qemacs:</div>
<div><br />
</div>
<div>
<div>
<div class="sites-codeblock sites-codesnippet-block" style="background-color:rgb(239,239,239);border:1px solid rgb(211,211,211);display:block;padding:0.5em 0px 0.5em 1em;line-height:13px"><code style="color:rgb(0,96,0)">qemacs foo.6</code></div>
</div>
</div>
<div><font color="#006000" face="monospace"><br />
</font></div>
<div>Edit the file to look like this:</div>
<div><br />
</div>
<div></div>
<div class="sites-codeblock sites-codesnippet-block">
<div><code><font color="#000000">console=tty1 init=/sbin/init add_efi_memmap boot=local rootwait ro noresume noswap i915.modeset=1 loglevel=7 kern_guid=%U tpm_tis.force=1 tpm_tis.interrupts=0 root=/dev/sda7 noinitrd</font></code></div>
<div></div>
</div>
<div><br />
</div>
<div>Then save (Ctrl-x Ctrl-s) and exit (Ctrl-x Ctrl-c). qemacs occasionally gets confused, so double-check to be sure you have the right content:</div>
<div><br />
</div>
<div>
<div class="sites-codeblock sites-codesnippet-block"><code>cat foo.6</code></div>
</div>
<div><br />
</div>
<div>Finally, use <code>make_dev_ssd.sh</code> to replace the kernel command line in KERN-C:</div>
<div><br />
</div>
<div></div>
<div class="sites-codeblock sites-codesnippet-block">
<div><code>sh ./make_dev_ssd.sh </code><span style="font-family:monospace;color:rgb(0,96,0)">--partitions '6' </span><span style="font-family:monospace;color:rgb(0,96,0)">--set_config foo</span></div>
<div></div>
</div>
<div><br />
</div>
<div>The kernel command line is part of the kernel partition, and the entire partition must be cryptographically signed in order to work. We can't replace the command line part without affecting the entire kernel partition. The script will save a backup copy before replacing the partition content, but we shouldn't need it.</div>
<div><br />
</div>
<div></div>
<h2><a name="TOC-Set-boot-priority"></a>Set boot priority</h2>
<div>At this point we should have the following situation:</div>
<div><br />
</div>
<div>Image-A is an official Google Chrome OS which can boot either in normal mode or dev-mode.</div>
<div>Image-B is (or will be after the first autoupdate) another official Google Chrome OS which can boot either in normal mode or dev-mode.</div>
<div>Image-C is Chrome OS kernel with a modified command line and an Ubuntu rootfs, which can only boot in dev-mode.</div>
<div><br />
</div>
<div>Next, we adjust the priority among the images so we can try out our Ubuntu image. The image priority is an attribute of its kernel partition.  Run <code>cgpt show /dev/sda</code> again, to see the kernel priorities:</div>
<div><br />
</div>
<div>
<div></div>
<div class="sites-codeblock sites-codesnippet-block">
<div><span style="font-family:monospace"><span style="font-family:Arial,Verdana,sans-serif">
<div><code style="color:rgb(0,96,0)">localhost ~ # <b>cgpt show /dev/sda</b></code></div>
<div><code><b><font color="#38761d">...</font></b></code></div>
</span></span></div>
<div><span style="font-family:monospace"><font color="#38761d">      4096     32768       2  Label: "KERN-A"</font></span></div>
<div><code><font color="#38761d">                              Type: ChromeOS kernel</font></code></div>
<div><code><font color="#38761d">                              UUID: D176DC60-81F1-654E-8953-E3D28019738C</font></code></div>
<div><code><font color="#38761d">                              Attr: <b>priority=3 tries=0 successful=1</b></font></code></div>
<div><span style="font-family:monospace"><font color="#38761d">...</font></span></div>
<div><span style="font-family:monospace"><font color="#38761d">     36864     32768       4  Label: "KERN-B"</font></span></div>
<div><code><font color="#38761d">                              Type: ChromeOS kernel</font></code></div>
<div><code><font color="#38761d">                              UUID: F1A2C65C-CC22-FF4A-A8BC-67BA233F3D40</font></code></div>
<div><code><font color="#38761d">                              Attr: <b>priority=0 tries=15 successful=0</b></font></code></div>
<div><code><font color="#38761d">
<div style="font-family:Arial,Verdana,sans-serif"><code>...</code></div>
<div style="font-family:Arial,Verdana,sans-serif"><code>  12369920     32768       6  Label: "KERN-C"</code></div>
<div style="font-family:Arial,Verdana,sans-serif"><code>                              Type: ChromeOS kernel</code></div>
<div style="font-family:Arial,Verdana,sans-serif"><code>                              UUID: B6954485-4295-9749-956A-C315B01FB684</code></div>
<div style="font-family:Arial,Verdana,sans-serif"><code>                              Attr: <b>priority=0 tries=15 successful=0</b></code></div>
</font></code></div>
</div>
</div>
<div><br />
</div>
<div>The priority determines the order in which the BIOS tries to find a valid kernel (bigger is higher, zero means don't even try). The tries field is decremented each time the BIOS tries to boot it, and if it's zero, the kernel is considered invalid (this lets us boot new images without looping forever if they don't work). The successful field overrides the tries field, but is only set by the OS once it's up and running.</div>
<div><br />
</div>
<div>Let's change the priority of KERN-C to 5:</div>
<div><br />
</div>
<div></div>
<div class="sites-codeblock sites-codesnippet-block">
<div><code>cgpt add -i 6 -P 5 -T 1 -S 0 /dev/sda</code></div>
<div></div>
</div>
<br />
<div>This makes KERN-C the highest priority, but only gives us one chance to boot it. That way if it doesn't work, we're not completely stuck.</div>
<div><br />
</div>
<div>If you reboot now, you should come up in Ubuntu!  Note that Computer Science Standard Answer #1 applies: It Works For Me™</div>
<div><br />
</div>
<div>If something went wrong and Ubuntu crashes or you powered off, the tries field for KERN-C will have been decremented to 0 and you'll fall back to booting Chrome OS.</div>
<div><br />
</div>
<div>Assuming that Ubuntu booted and you could log in, go to Applications-&gt;Accessories-&gt;Terminal to get a shell, and run</div>
<div><br />
</div>
<div></div>
<div class="sites-codeblock sites-codesnippet-block">
<div><code><font color="#783f04">sudo cgpt add -i 6 -P 5 -S 1 /dev/sda</font></code></div>
<div></div>
</div>
<br />
<div>This will mark the Ubuntu kernel as valid, so it will continue to boot next time.</div>
<div><br />
</div>
<div>Now you can switch back and forth between the official Chrome OS release and Ubuntu just by flipping the dev-mode switch. Going from dev-mode to normal mode erases STATE (<code>/dev/sda1</code>), but much more quickly. Going from normal to dev-mode again would normally do a slow erase of <code>/dev/sda1</code>, but since we're booting Ubuntu that doesn't happen.</div>
<div><br />
</div>
<div>This works because although KERN-C has the highest priority, it isn't signed by Google. In dev-mode that's okay, but in normal mode it will be rejected by the BIOS. Since we've set the successful flag to 1, the BIOS won't mark it invalid but will just skip it each time. This makes the normal-mode boot time slightly longer, but only by a second or two. </div>
<div><br />
</div>
<div>Of course you could also switch between images from within dev-mode just by manually setting the priorities with <code>cgpt</code> before rebooting.</div>
<div><br />
</div>
<div>Note that if the normal image autoupdates, it will probably change the kernel priorities so that Image-C is no longer the highest and the next time you switch to dev mode, you will</div>
<div>  a) have a long wait, </div>
<div>  b) still be running Chrome OS, and </div>
<div>  c) have to use cgpt to raise the KERN-C priority again. </div>
<div><br />
</div>
<div>But, because autoupdate only switches between Image-A and Image-B, the Ubuntu kernel and rootfs shouldn't be affected.</div>
<div><br />
</div>
<h2><a name="TOC-Footnotes"></a>Footnotes</h2>
<h3><a name="TOC-Ugh"></a>Ugh</h3>
<div>Recompiling the Ubuntu kernel should be possible, with a few caveats:</div>
<div><br />
</div>
<div>
<div>First, you'll have to modify or reconfigure the kernel to not use initrd. initramfs should work though.</div>
<div><br />
</div>
<div>Second, official Chrome OS still has a few closed-source hardware drivers.  The pure open-source Chromium OS experience is therefore a bit sub-optimal, although still quite useable.</div>
<div><br />
</div>
<div>Third, if you use the 32-bit image, you'll also have to modify the kernel source to boot correctly from the 64-bit Chrome OS BIOS.</div>
<div>See <a href="http://git.chromium.org/cgi-bin/gitweb.cgi?p=kernel.git;a=commit;h=a7cfa1075c04df162d58dc2ed93df6045e9c3271">http://git.chromium.org/cgi-bin/gitweb.cgi?p=kernel.git;a=commit;h=a7cfa1075c04df162d58dc2ed93df6045e9c3271</a> for details.</div>
<div><br />
</div>
<div>If you use a 64-bit image it shouldn't need the boot hacks, but driver support is much less robust.</div>
<div><br />
</div>
<div>Finally, you'll have to sign the kernel yourself and put it into the KERN-C partition. That is actually the easiest step, but it's not really well documented. Look in the developer pages.</div>
</div>
</div>
<div><br />
</div>
<div>
<h3><a name="TOC-Double-ugh"></a>Double-ugh</h3>
<div><code>initrd</code> is typically handled by the bootloader, which reads the specified image from the disk into RAM and passes the address to the kernel as it's invoked.</div>
<div><br />
</div>
<div>The Chrome OS BIOS is a modified EFI BIOS. The bootstub is a standard EFI Application, but it's embedded in the kernel image in a dedicated partition type, rather than accessible through a FAT filesystem. To decrease boot time, the BIOS does not discover or pass the standard disk drive handles to the bootstub, so the bootstub doesn't know anything about disks or filesystems. There is also no Compatibility Support Module in the BIOS. In theory <code>elilo</code> or <code>grub2</code> could replace the bootstub, but they would have to reimplement some of the device discovery functions normally done by an EFI BIOS.</div>
</div>
<div><br />
</div>
<div>If you want to take this on, go for it. That would let us create a kernel partition that just contained an EFI bootloader, which could then chain-boot to external USB drives, etc. That might be kind of cool.</div>
<div><br />
</div>
<div><hr size="2" width="100%" />Some <a href="http://xkcd.com/386/">clarification</a> in response to the wharrgarbl resulting from this howto...<br /><ul><li>The dev-mode switch is purely for hackers who want to jailbreak their notebook. The people who build the notebook don't need it (duh).</li><li>Things are locked down by default to try to prevent Bad People from rooting your device without your knowledge. It's always been intended that you should be able to root it yourself. Go read the <a href="http://www.chromium.org/chromium-os/chromiumos-design-docs/developer-mode">design document</a> for details and background.</li><li>It's not a trick. We really don't care what you do with your own property. As long as you don't crack open the case, you should always be able to <a href="http://www.google.com/chromeos/recovery">restore it to the original state</a>.<br /></li><li>I put this hack together in about a day (with another day or so for my coworkers to proofread it) which is why it's so complicated. I 
figured you'd want to see an example sooner rather than later.</li><li>wfrichar@chromium.org wrote this. I work for Google, on the Chrome OS verified boot stuff.<br /></li></ul>
</div></div></td></tr></tbody></table>
</div> 
</div> 
<div id="sites-canvas-bottom-panel">
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_page-subpages"> </div>
<div id="sites-attachments-container">
</div>
<a xmlns="http://www.w3.org/1999/xhtml" name="page-comments"></a>
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_page-comments"><div class="sites-comment-docos-wrapper"><div class="sites-comment-docos"><div class="sites-comment-docos-background"></div><div class="sites-comment-docos-header"><div class="sites-comment-docos-header-title">Comments</div></div><div id="sites-comment-docos-pane" class="sites-comment-docos-pane"></div></div></div></div>
</div>
</div> 
</td> 
</tr>
</table> 
</div> 
</div> 
<div id="sites-chrome-footer-wrapper">
<div id="sites-chrome-footer-wrapper-inside">
<div id="sites-chrome-footer">
</div>
</div>
</div>
</div> 
</div> 
<div id="sites-chrome-adminfooter-container">
<div xmlns="http://www.w3.org/1999/xhtml" class="sites-adminfooter" role="navigation"><p><a class="sites-system-link" href="https://www.google.com/a/UniversalLogin?service=jotspot&amp;continue=http://sites.google.com/a/chromium.org/dev/chromium-os/developer-information-for-chrome-os-devices/cr-48-chrome-notebook-developer-information/how-to-boot-ubuntu-on-a-cr-48">Sign in</a><span aria-hidden="true">|</span><a class="sites-system-link" href="http://www.chromium.org/system/app/pages/recentChanges">Recent Site Activity</a><span aria-hidden="true">|</span><a class="sites-system-link" href="http://www.chromium.org/system/app/pages/reportAbuse" target="_blank">Report Abuse</a><span aria-hidden="true">|</span><a class="sites-system-link" href="javascript:;" onclick="window.open(webspace.printUrl)">Print Page</a><span aria-hidden="true">|</span><span class="sites-system-link">Powered By</span> <b class="powered-by"><a href="http://sites.google.com">Google Sites</a></b></p></div>
</div>
</div> 
</div> 
<div id="sites-chrome-onebar-footer">
</div>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
    window.jstiming.load.tick('sjl');
  </script>
<script xmlns="http://www.w3.org/1999/xhtml" src="http://www.gstatic.com/sites/p/56e332/system/js/jot_min_view__en.js"></script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
    window.jstiming.load.tick('jl');
  </script>
<script xmlns="http://www.w3.org/1999/xhtml">
      
          sites.core.Analytics.createTracker();
          sites.core.Analytics.trackPageview();
        
    </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
                    sites.Searchbox.initialize(
                        'sites-searchbox-search-button',
                        {"object":[]}['object'],
                        'search-site',
                        {"label":"Configure search options...","url":"/system/app/pages/admin/settings"});
                  </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
      gsites.HoverPopupMenu.createSiteDropdownMenus('sites-header-nav-dropdown', false);
    </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript" defer="true">
            JOT_setupNav("7648876402527094", "Navigation", false);
            JOT_addListener('titleChange', 'JOT_NAVIGATION_titleChange', 'COMP_7648876402527094');
          </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript" defer="true">
            JOT_setupNav("14720868319272995", "Quick links", false);
            JOT_addListener('titleChange', 'JOT_NAVIGATION_titleChange', 'COMP_14720868319272995');
          </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript" defer="true">
            JOT_setupNav("19690813310444355", "Other sites", false);
            JOT_addListener('titleChange', 'JOT_NAVIGATION_titleChange', 'COMP_19690813310444355');
          </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
              new sites.CommentPane('//docs.google.com/comments/d/AAHRpnXukca4jaDOG9SuQz_G8t7HlBVeEu8K2L65qiOtfChN4bfH3tUt09sLwkxfIAg-lRO_5l70GJ51Cj-LYICM_IG13LhPbql_ySbewf5kdhoyNt_UnKTvxCtFUGEEBPMr0Ck72suWv/api/js?anon=true',
                  false, false);
            </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
  setTimeout(function() {
    var fingerprint = gsites.date.TimeZone.getFingerprint([]);
    gsites.Xhr.send('http://www.chromium.org/_/tz', null, null, 'GET', null, null, { afjstz: fingerprint });
  }, 500);
</script>
<script xmlns="http://www.w3.org/1999/xhtml">
                    window.onload = function() {
                      if (false) {
                        JOT_setMobilePreview();
                      }
                      var loadTimer = window.jstiming.load;
                      loadTimer.tick("ol");
                      loadTimer["name"] = "load," + webspace.page.type + ",user_page";
                      window.jstiming.report(loadTimer, {}, 'http://csi.gstatic.com/csi');
                    }
                  </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
        JOT_insertAnalyticsCode(false,
            false);
      </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
    var maestroRunner = new gsites.pages.view.SitesMaestroRunner(
        webspace, "en");
    maestroRunner.initListeners();
    maestroRunner.installEditRender();
  </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript" defer="true">
  //<![CDATA[
    // Decorate any fastUI buttons on the page with a class of 'goog-button'.
    if (webspace.user.hasWriteAccess) {
      JOT_decorateButtons();
    }

    // Fires delayed events.
    (function() {
      JOT_fullyLoaded = true;
      var delayedEvents = JOT_delayedEvents;
      for (var x = 0; x < delayedEvents.length; x++) {
        var event = delayedEvents[x];
        JOT_postEvent(event.eventName, event.eventSrc, event.payload);
      }
      JOT_delayedEvents = null;
      JOT_postEvent('pageLoaded');
    })();
  //]]>
</script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
    JOT_postEvent('decorateGvizCharts');
  </script>
<script type="text/javascript">
          JOT_setupPostRenderingManager();
        </script>
<script type="text/javascript">
          JOT_postEvent('renderPlus', null, 'sites-chrome-main');
        </script>
<div id="server-timer-div" style="display:none"> </div>
<script type="text/javascript">
          window.jstiming.load.tick('render');
          JOT_postEvent('usercontentrendered', this);
        </script>
</body>
</html>
