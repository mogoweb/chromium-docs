<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/WebPage">
<head>
<meta http-equiv="X-UA-Compatible" content="chrome=1" />
<script type="text/javascript">/* Copyright 2008 Google. */ (function() { var e="wtsrt_",g="tbsd_",h="tbnd_",k="start",l="_wtsrt",m="_tbnd",n="CSI/";(function(){function f(a){this.t={};this.tick=function(a,c,b){this.t[a]=[void 0!=b?b:(new Date).getTime(),c];if(void 0==b)try{window.console.timeStamp(n+a)}catch(d){}};this.tick(k,null,a)}var a;window.performance&&(a=window.performance.timing);var p=a?new f(a.responseStart):new f;window.jstiming={Timer:f,load:p};if(a){var c=a.navigationStart,d=a.responseStart;0<c&&d>=c&&(window.jstiming.srt=d-c)}if(a){var b=window.jstiming.load;0<c&&d>=c&&(b.tick(l,void 0,c),b.tick(e,l,d),b.tick(g,e))}try{a=null,
window.chrome&&window.chrome.csi&&(a=Math.floor(window.chrome.csi().pageT),b&&0<c&&(b.tick(m,void 0,window.chrome.csi().startE),b.tick(h,m,c))),null==a&&window.gtbExternal&&(a=window.gtbExternal.pageT()),null==a&&window.external&&(a=window.external.pageT,b&&0<c&&(b.tick(m,void 0,window.external.startE),b.tick(h,m,c))),a&&(window.jstiming.pt=a)}catch(q){}})(); })()
</script>
<link rel="shortcut icon" href="../../_/rsrc/1354323194313/favicon.ico" type="image/x-icon" />
<link rel="apple-touch-icon" href="https://ssl.gstatic.com/sites/p/56e332/system/app/images/apple-touch-icon.png" type="image/png" />
<script type="text/javascript">/* Copyright 2008 Google. */ (function() { var d="",g="__duration__",h="function";function k(c){return document.getElementById(c)}window.byId=k;function l(c){return c.replace(/^\s+|\s+$/g,d)}window.trim=l;var m=[],n=0;window.JOT_addListener=function(c,a,b){var e=new String(n++);c={eventName:c,handler:a,compId:b,key:e};m.push(c);return e};window.JOT_removeListenerByKey=function(c){for(var a=0;a<m.length;a++)if(m[a].key==c){m.splice(a,1);break}};
window.JOT_removeAllListenersForName=function(c){for(var a=0;a<m.length;a++)m[a].eventName==c&&m.splice(a,1)};window.JOT_postEvent=function(c,a,b){var e={eventName:c,eventSrc:a||{},payload:b||{}};if(window.JOT_fullyLoaded)for(a=m.length,b=0;b<a&&b<m.length;b++){var f=m[b];f&&f.eventName==c&&(e.listenerCompId=f.compId||d,(f=typeof f.handler==h?f.handler:window[f.handler])&&f(e))}else window.JOT_delayedEvents.push({eventName:c,eventSrc:a,payload:b})};window.JOT_delayedEvents=[];
window.JOT_fullyLoaded=!1;window.JOT_formatRelativeToNow=function(c,a){var b=((new Date).getTime()-c)/6E4;if(1440<=b||0>b)return null;var e=0;60<=b&&(b/=60,e=2);2<=b&&e++;return a?window.JOT_siteRelTimeStrs[e].replace(g,Math.floor(b)):window.JOT_userRelTimeStrs[e].replace(g,Math.floor(b))}; })()
</script>
<script>

  

  var breadcrumbs = [{"path":"/chromium-os","deleted":false,"title":"Chromium OS","dir":"ltr"},{"path":"/chromium-os/developer-information-for-chrome-os-devices","deleted":false,"title":"Developer Information for Chrome OS Devices","dir":"ltr"},{"path":"/chromium-os/developer-information-for-chrome-os-devices/workaround-for-battery-discharge-in-dev-mode","deleted":false,"title":"Workaround for battery discharge in dev-mode","dir":"ltr"}];
  var JOT_clearDotPath = 'https://ssl.gstatic.com/sites/p/56e332/system/app/images/cleardot.gif';

  
  var JOT_userRelTimeStrs = ["a minute ago","__duration__ minutes ago","an hour ago","__duration__ hours ago"];

  
  

  

  var webspace = {"enableAnalytics":true,"pageSharingId":"jotspot_page","enableUniversalAnalytics":false,"sharingPolicy":"OPENED_WITH_INDICATOR","siteTitle":"The Chromium Projects","isStartPageEnabled":true,"adsensePublisherId":null,"features":{"languageSelectDefaultTextSetToDefault":true,"validateClientGvizDataSourceUrls":true,"moreMobileStyleImprovements":true,"newInsertMenuIcons":true,"accessibleSortingButtons":true,"domainAnalyticsInGAOnly":true,"noCaptcha":true,"fileCabinetScreenReaderFix":true,"updatedTosAndPrivacyLinks":null,"pageDrafts":false,"mobileOrientationFix":true,"plusBadge":false,"pdfEmbedSupport":false,"jsClickFix":true},"isPublic":true,"isConsumer":false,"serverFlags":{"cajaBaseUrl":"//www.gstatic.com/caja","cajaDebugMode":false},"onepickBaseUrl":"https://docs.google.com","domainAnalyticsAccountId":"","plusPageId":"","signInUrl":"https://www.google.com/a/SelectSession?continue\u003dhttps://sites.google.com/a/chromium.org/dev/chromium-os/developer-information-for-chrome-os-devices/workaround-for-battery-discharge-in-dev-mode\u0026service\u003djotspot","analyticsAccountId":"UA-5484340-1","scottyUrl":"/_/upload","homePath":"/","siteNoticeUrlEnabled":null,"plusPageUrl":"","adsensePromoClickedOrSiteIneligible":true,"csiReportUri":"https://gg.google.com/csi","sharingId":"jotspot","termsUrl":"//www.google.com/intl/en/policies/terms/","gvizVersion":1,"editorResources":{"sitelayout":["https://ssl.gstatic.com/sites/p/56e332/system/app/css/sitelayouteditor.css"],"text":["https://ssl.gstatic.com/sites/p/56e332/system/js/codemirror.js","https://ssl.gstatic.com/sites/p/56e332/system/app/css/codemirror_css.css","https://ssl.gstatic.com/sites/p/56e332/system/js/trog_edit__en.js","https://ssl.gstatic.com/sites/p/56e332/system/app/css/trogedit.css","/_/rsrc/1441580320000/system/app/css/editor.css","https://ssl.gstatic.com/sites/p/56e332/system/app/css/codeeditor.css","/_/rsrc/1441580320000/system/app/css/camelot/editor-jfk-wlb.css"]},"sharingUrlPrefix":"/_/sharing","isAdsenseEnabled":true,"domain":"chromium.org","baseUri":"","name":"dev","siteTemplateId":false,"siteNoticeRevision":null,"siteNoticeUrlAddress":null,"siteNoticeMessage":null,"page":{"isRtlLocale":false,"canDeleteWebspace":null,"isPageDraft":null,"parentPath":"/chromium-os/developer-information-for-chrome-os-devices","parentWuid":"wuid:gx:2227f33967836151","siteLocale":"en","timeZone":"America/Los_Angeles","type":"text","title":"Workaround for battery discharge in dev-mode","locale":"en","wuid":"wuid:gx:6746b21c24f09739","revision":16,"path":"/chromium-os/developer-information-for-chrome-os-devices/workaround-for-battery-discharge-in-dev-mode","isSiteRtlLocale":false,"pageInheritsPermissions":null,"name":"workaround-for-battery-discharge-in-dev-mode","canChangePath":true,"state":"","properties":{},"bidiEnabled":false,"currentTemplate":{"path":"/system/app/pagetemplates/text","title":"Web Page"}},"canPublishScriptToAnyone":true,"user":{"keyboardShortcuts":true,"sessionIndex":"","guest_":true,"displayNameOrEmail":"guest","userName":"guest","uid":"","renderMobile":false,"domain":"","namespace":"","hasWriteAccess":false,"namespaceUser":false,"primaryEmail":"guest","hasAdminAccess":false},"gadgets":{"baseUri":"/system/app/pages/gadgets"}};
  webspace.page.breadcrumbs = breadcrumbs;

  
  var JOT_siteRelTimeStrs = ["a minute ago","__duration__ minutes ago","an hour ago","__duration__ hours ago"];

</script>
<script type="text/javascript">
                window.jstiming.load.tick('scl');
              </script>
<meta name="title" content="Workaround for battery discharge in dev-mode - The Chromium Projects" />
<meta itemprop="name" content="Workaround for battery discharge in dev-mode - The Chromium Projects" />
<meta property="og:title" content="Workaround for battery discharge in dev-mode - The Chromium Projects" />
<meta name="description" content="Home of the Chromium Open Source Project" />
<meta itemprop="description" content="Home of the Chromium Open Source Project" />
<meta id="meta-tag-description" property="og:description" content="Home of the Chromium Open Source Project" />
<style type="text/css">
</style>
<link rel="stylesheet" type="text/css" href="https://ssl.gstatic.com/sites/p/56e332/system/app/themes/beigeandblue/standard-css-beigeandblue-ltr-ltr.css" />
<link rel="stylesheet" type="text/css" href="../../_/rsrc/1441580320000/system/app/css/overlay.css%3Fcb=beigeandblueundefineda100%2525%2525150goog-ws-leftthemedefaultstandard.css" />
<link rel="stylesheet" type="text/css" href="../../_/rsrc/1441580320000/system/app/css/camelot/allthemes-view.css" />
<!--[if IE]>
          <link rel="stylesheet" type="text/css" href="/system/app/css/camelot/allthemes%2die.css" />
        <![endif]-->
<title>Workaround for battery discharge in dev-mode - The Chromium Projects</title>
<meta itemprop="image" content="/_/rsrc/1438879449147/config/customLogo.gif?revision=3" />
<meta property="og:image" content="/_/rsrc/1438879449147/config/customLogo.gif?revision=3" />
<script type="text/javascript">
                window.jstiming.load.tick('cl');
              </script>
</head>
<body xmlns="http://www.google.com/ns/jotspot" id="body" class=" en            ">
<div id="sites-page-toolbar" class="sites-header-divider">
<div xmlns="http://www.w3.org/1999/xhtml" id="sites-status" class="sites-status" style="display:none;"><div id="sites-notice" class="sites-notice" role="status" aria-live="assertive"> </div></div>
</div>
<div id="sites-chrome-everything-scrollbar">
<div id="sites-chrome-everything" class="">
<div id="sites-chrome-page-wrapper" style="direction: ltr">
<div id="sites-chrome-page-wrapper-inside">
<div xmlns="http://www.w3.org/1999/xhtml" id="sites-chrome-header-wrapper" style="height:auto;">
<table id="sites-chrome-header" class="sites-layout-hbox" cellspacing="0" style="height:auto;">
<tr class="sites-header-primary-row" id="sites-chrome-userheader">
<td id="sites-header-title" class="" role="banner"><div class="sites-header-cell-buffer-wrapper"><a href="../../index.html" id="sites-chrome-userheader-logo"><img id="logo-img-id" src="../../_/rsrc/1438879449147/config/customLogo.gif%3Frevision=3" alt="The Chromium Projects" class="sites-logo  " /></a><h2><a href="../../index.html" dir="ltr" id="sites-chrome-userheader-title">The Chromium Projects</a></h2></div></td><td class="sites-layout-searchbox  "><div class="sites-header-cell-buffer-wrapper"><form id="sites-searchbox-form" action="https://www.chromium.org/system/app/pages/search" role="search"><input type="hidden" id="sites-searchbox-scope" name="scope" value="search-site" /><input type="text" id="jot-ui-searchInput" name="q" size="20" value="" aria-label="Search this site" /><div id="sites-searchbox-button-set" class="goog-inline-block"><div role="button" id="sites-searchbox-search-button" class="goog-inline-block jfk-button jfk-button-standard" tabindex="0">Search this site</div></div></form></div></td>
</tr>
<tr class="sites-header-secondary-row" id="sites-chrome-horizontal-nav">
<td colspan="2" id="sites-chrome-header-horizontal-nav-container" role="navigation">
</td>
</tr>
</table>
</div>
<div id="sites-chrome-main-wrapper">
<div id="sites-chrome-main-wrapper-inside">
<table id="sites-chrome-main" class="sites-layout-hbox" cellspacing="0" cellpadding="{scmCellpadding}" border="0">
<tr>
<td id="sites-chrome-sidebar-left" class="sites-layout-sidebar-left initial" style="width:150px">
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_7648876402527094" class="sites-embed" role="navigation"><div class="sites-embed-content sites-sidebar-nav"><ul role="navigation" jotId="navList"><li class="nav-first "><div dir="ltr" style="padding-left: 5px;"><a href="../../chromium-projects.html" jotId="wuid:gx:10ae433dadbbab13" class="sites-navigation-link">Home</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="../../Home.1.html" jotId="wuid:gx:43582b9d2029d3af" class="sites-navigation-link">Chromium</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="../../chromium-os.1.html" jotId="wuid:gx:83df2ab1f8880ba" class="sites-navigation-link">Chromium OS</a></div></li></ul></div></div>
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_14720868319272995" class="sites-embed" role="navigation"><h4 class="sites-embed-title">Quick links</h4><div class="sites-embed-content sites-sidebar-nav"><ul role="navigation" jotId="navList"><li class="nav-first "><div dir="ltr" style="padding-left: 5px;"><a href="../../for-testers/bug-reporting-guidelines.html" class="sites-navigation-link">Report bugs</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="../../developers/discussion-groups.html" class="sites-navigation-link">Discuss</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="../../system/app/pages/sitemap/hierarchy.html" jotId="wuid:gx:4c0f552cb393ed23" class="sites-navigation-link">Sitemap</a></div></li></ul></div></div>
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_19690813310444355" class="sites-embed" role="navigation"><h4 class="sites-embed-title">Other sites</h4><div class="sites-embed-content sites-sidebar-nav"><ul role="navigation" jotId="navList"><li class="nav-first "><div dir="ltr" style="padding-left: 5px;"><a href="http://blog.chromium.org/" class="sites-navigation-link">Chromium Blog</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="http://code.google.com/chrome/extensions/" class="sites-navigation-link">Google Chrome Extensions</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="https://developers.google.com/chrome/chrome-frame/" class="sites-navigation-link">Google Chrome Frame</a></div></li></ul></div></div>
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_19695218559354544" class="sites-embed" role="complementary"><h4 class="sites-embed-title"></h4><div class="sites-embed-content sites-embed-content-sidebar-textbox"><div dir="ltr"><span style="font-size:x-small">Except as otherwise </span><a href="http://developers.google.com/site-policies.html#restrictions"><span style="font-size:x-small">noted</span></a><span style="font-size:x-small">, the content of this page is licensed under a </span><a href="http://creativecommons.org/licenses/by/2.5/"><span style="font-size:x-small">Creative Commons Attribution 2.5 license</span></a><span style="font-size:x-small">, and examples are licensed under the </span><a href="http://src.chromium.org/viewvc/chrome/trunk/src/LICENSE" target="_blank"><span style="font-size:x-small">BSD License</span></a><span style="font-size:x-small">.<br /></span></div></div></div>
</td>
<td id="sites-canvas-wrapper">
<div id="sites-canvas" role="main">
<div id="goog-ws-editor-toolbar-container"> </div>
<div xmlns="http://www.w3.org/1999/xhtml" id="title-crumbs" style="">
<A href="../../chromium-os.1.html" dir="ltr">Chromium OS</A>‎ &gt; ‎<A href="../developer-information-for-chrome-os-devices.1.html" dir="ltr">Developer Information for Chrome OS Devices</A>‎ &gt; ‎
  </div>
<h3 xmlns="http://www.w3.org/1999/xhtml" id="sites-page-title-header" style="" align="left">
<span id="sites-page-title" dir="ltr" tabindex="-1" style="outline: none">Workaround for battery discharge in dev-mode</span>
</h3>
<div id="sites-canvas-main" class="sites-canvas-main">
<div id="sites-canvas-main-content">
<table xmlns="http://www.w3.org/1999/xhtml" cellspacing="0" class="sites-layout-name-one-column sites-layout-hbox"><tbody><tr><td class="sites-layout-tile sites-tile-name-content-1"><div dir="ltr"><div><div class="sites-embed-align-right-wrapping-on"><div class="sites-embed-border-off sites-embed" style="width:250px;"><div class="sites-embed-content sites-embed-type-toc"><div class="goog-toc sites-embed-toc-maxdepth-6"><p>Contents</p><ol class="goog-toc"><li class="goog-toc"><a href="workaround-for-battery-discharge-in-dev-mode.html#TOC-Introduction"><strong>1 </strong>Introduction</a></li><li class="goog-toc"><a href="workaround-for-battery-discharge-in-dev-mode.html#TOC-Impacted-Devices"><strong>2 </strong>Impacted Devices</a></li><li class="goog-toc"><a href="workaround-for-battery-discharge-in-dev-mode.html#TOC-How-to-recover"><strong>3 </strong>How to recover</a><ol class="goog-toc"><li class="goog-toc"><a href="workaround-for-battery-discharge-in-dev-mode.html#TOC-Stay-in-developer-mode"><strong>3.1 </strong>Stay in developer mode</a></li><li class="goog-toc"><a href="workaround-for-battery-discharge-in-dev-mode.html#TOC-Download-a-recovery-image"><strong>3.2 </strong>Download a recovery image</a></li><li class="goog-toc"><a href="workaround-for-battery-discharge-in-dev-mode.html#TOC-Modify-the-recovery-image-so-we-can-mount-it"><strong>3.3 </strong>Modify the recovery image so we can mount it</a></li><li class="goog-toc"><a href="workaround-for-battery-discharge-in-dev-mode.html#TOC-Change-the-chromeos-install-script-to-just-fix-the-flags"><strong>3.4 </strong>Change the chromeos-install script to just fix the flags</a></li><li class="goog-toc"><a href="workaround-for-battery-discharge-in-dev-mode.html#TOC-Recover-the-dev-mode-flags"><strong>3.5 </strong>Recover the dev-mode flags</a></li></ol></li></ol></div></div></div></div></div>
<h2><a name="TOC-Introduction"></a>Introduction</h2>
<p><a href="https://crbug.com/362105">Issue 362105</a> describes a painfully annoying problem for people who put their Chromebooks in dev-mode so they can use them more like a standard laptop. The tl;dr version is that if <span style="font-size:13.3333330154419px;background-color:transparent">you've completely replaced or disabled Chrome OS and </span><span style="font-size:10pt;background-color:transparent">the battery runs all the way down, it forgets that it was configured to allow non-Chrome OS images to boot, locking you out of your own device. If this happens to you, here's how to get back in.</span></p><div style="font-size:13.3333330154419px">Note: If your machine boots up in Chrome OS, you probably haven't lost anything:</div><div style="font-size:13.3333330154419px"><br /></div><blockquote style="font-size:13.3333330154419px;margin:0px 0px 0px 40px;border:none;padding:0px">If you're no longer in dev-mode, enter it again and reboot</blockquote><blockquote style="font-size:13.3333330154419px;margin:0px 0px 0px 40px;border:none;padding:0px"><div>Go into crosh (CTRL-ALT-T)</div><div>Type "shell" to get a shell.</div><div>run <font face="courier new, monospace">sudo crossystem dev_boot_legacy=1</font></div><div>reboot</div><div>press CTRL-L when you see the scary boot screen</div></blockquote><div style="font-size:13.3333330154419px"><br /></div><div style="font-size:13.3333330154419px">If your machine <b>doesn't</b> boot Chrome OS and only gives you the "Chrome OS is missing or damaged" screen with every boot, then the following may help.</div>
<p><span style="font-size:10pt;background-color:transparent">This process is long and annoying, but it's better than losing all your data.</span></p>
<h2><a name="TOC-Impacted-Devices"></a>Impacted Devices</h2>
<p>The issue has been resolved in newer devices, but most likely will not be backported to older ones. Here are all the devices impacted (the project names are listed; see the <span style="background-color:transparent"><a href="../developer-information-for-chrome-os-devices.1.html">Developer Information for Chrome OS Devices</a> page for product names):</span></p>
<ul><li>mario &amp; alex &amp; zgb</li>
<li>stumpy &amp; lumpy</li>
<li>snow</li>
<li>parrot</li>
<li>stout</li>
<li>butterfly</li><li>link</li><li>spring &amp; skate</li><li>peppy &amp; pepto</li><li>falco &amp; wolf &amp; leon</li><li>panther &amp; m<span style="font-size:10pt;background-color:transparent">onroe</span></li><li>squawks &amp; quawks &amp; clapper &amp; swanky &amp; kip</li><li>zako</li><li>big &amp; blaze</li><li>veyron</li></ul>
<h2><a name="TOC-How-to-recover"></a>How to recover</h2>
<p>These instructions assume you have another Linux machine to do this on, because 1) I know that works, and 2) I don't have any Mac or Windows machines.</p>
<p>Here's what we're going to do:</p>
<h3><a name="TOC-Stay-in-developer-mode"></a>Stay in developer mode</h3>
<p>If your Linux data is in a separate disk partition that you've created or taken over, you still may be okay. But best not to risk it. Certainly <b>don't</b> go through the recovery process, because that will wipe the disk.</p>
<h3><a name="TOC-Download-a-recovery-image"></a>Download a recovery image</h3>
<p>If you go to <a href="http://www.google.com/chromeos/recovery">www.google.com/chromeos/recovery</a>, you'll find instructions for running a Linux script that will download and format a USB stick for you. Follow them, but <b>don't</b> remove the USB stick afterwards, and <b>really</b> don't insert it in your Chromebook. [Update: okay, you used to find instructions there, but they're gone. Look <a href="https://support.google.com/chromebook/answer/6002417">here</a> instead. I've filed a bug.]</p>
<p>Note: My USB stick shows up as <code>/dev/sdc</code>. If yours is something else, use that instead in the examples below.</p>
<h3><a name="TOC-Modify-the-recovery-image-so-we-can-mount-it"></a>Modify the recovery image so we can mount it</h3>
<p>The root filesystem on the recovery image is marked with some unsupported ext2 flags, so that if you try to mount it you'll see a message like this:</p>
<div class="sites-codeblock sites-codesnippet-block"><span style="font-family:courier new,monospace;line-height:1;font-size:10pt;background-color:rgb(239,239,239)"><code>$</code></span><code> <b>sudo mount /dev/sdc3 /mnt</b></code><br />
<span style="color:rgb(0,96,0);font-family:courier new,monospace;line-height:1;font-size:10pt;background-color:rgb(239,239,239)"><code>mount: wrong fs type, bad option, bad superblock on /dev/loop0,</code></span><br />
<span style="color:rgb(0,96,0);font-family:courier new,monospace;line-height:1;font-size:10pt;background-color:rgb(239,239,239)"><code>missing codepage or helper program, or other error</code></span><br />
<span style="color:rgb(0,96,0);font-family:courier new,monospace;line-height:1;font-size:10pt;background-color:rgb(239,239,239)"><code>In some cases useful info is found in syslog - try</code></span><br />
<span style="color:rgb(0,96,0);font-family:courier new,monospace;line-height:1;font-size:10pt;background-color:rgb(239,239,239)"><code>dmesg | tail  or so</code></span><font face="courier new, monospace"><span style="line-height:13.333332061767578px"><br />
</span></font><span style="color:rgb(0,96,0);font-family:courier new,monospace;line-height:1;font-size:10pt;background-color:rgb(239,239,239)"><br />
</span>
<div><span style="color:rgb(0,96,0);font-family:courier new,monospace;line-height:1;font-size:10pt;background-color:rgb(239,239,239)"><code>Exit code 32</code></span>
<div><span style="font-family:courier new,monospace;line-height:1;font-size:10pt;background-color:rgb(239,239,239)"><code>$</code></span></div>
</div>
</div>
<p>We need to clear those flag bits so we can make changes to the filesystem. To do this, we need to know the offset (in bytes) of the beginning of the rootfs partition. You can use the GNU parted tool to find this <span style="font-family:arial,sans-serif;font-size:10pt;background-color:transparent">out:</span></p>
<div class="sites-codeblock sites-codesnippet-block">
<div>
<div style="line-height:13.333332061767578px"><code>$</code><code> </code><b><code>sudo parted /dev/sdc</code></b></div>
<div style="line-height:13.333332061767578px"><code>GNU Parted 2.3</code></div>
<div style="line-height:13.333332061767578px"><code>Using /dev/sdc</code></div>
<div style="line-height:13.333332061767578px"><code>Welcome to GNU Parted! Type 'help' to view a list of commands.</code></div>
<div style="line-height:13.333332061767578px"><code>(parted)</code><code> </code><b><code>unit B</code></b><code> </code><code>                                                          </code></div>
<div style="line-height:13.333332061767578px"><code>(parted)</code><code> </code><b><code>print</code></b><code> </code><code>                                                           </code></div>
<div style="line-height:13.333332061767578px"><code>Error: The backup GPT table is not at the end of the disk, as it should be.</code></div>
<div style="line-height:13.333332061767578px"><code>This might mean that another operating system believes the disk is smaller.</code></div>
<div style="line-height:13.333332061767578px"><code>Fix, by moving the backup to the end (and removing the old backup)?</code></div>
<div style="line-height:13.333332061767578px"><code>Fix/Ignore/Cancel?</code><code> </code><b><code>I</code></b><code> </code><code>                                                     </code></div>
<div style="line-height:13.333332061767578px"><code>Warning: Not all of the space available to /dev/sdc appears to be used, you can</code></div>
<div style="line-height:13.333332061767578px"><code>fix the GPT to use all of the space (an extra 3115136 blocks) or continue with</code></div>
<div style="line-height:13.333332061767578px"><code>the current setting? </code></div>
<div style="line-height:13.333332061767578px"><code>Fix/Ignore?</code><code> </code><b><code>I</code></b><code> </code><code>                                                            </code></div>
<div style="line-height:13.333332061767578px"><code>Model: Kingston DT 100 G2 (scsi)</code></div>
<div style="line-height:13.333332061767578px"><code>Disk /dev/sdc: 3926949888B</code></div>
<div style="line-height:13.333332061767578px"><code>Sector size (logical/physical): 512B/512B</code></div>
<div style="line-height:13.333332061767578px"><code>Partition Table: gpt</code></div>
<div style="line-height:13.333332061767578px"><br />
</div>
<div style="line-height:13.333332061767578px"><code>Number  Start        End          Size         File system  Name        Flags</code></div>
<div style="line-height:13.333332061767578px"><code>11      32768B       8421375B     8388608B                  RWFW</code></div>
<div style="line-height:13.333332061767578px"><code> 6      8421376B     8421887B     512B                      KERN-C</code></div>
<div style="line-height:13.333332061767578px"><code> 7      8421888B     8422399B     512B                      ROOT-C</code></div>
<div style="line-height:13.333332061767578px"><code> 9      8422400B     8422911B     512B                      reserved</code></div>
<div style="line-height:13.333332061767578px"><code>10      8422912B     8423423B     512B                      reserved</code></div>
<div style="line-height:13.333332061767578px"><code> 2      10485760B    27262975B    16777216B                 KERN-A</code></div>
<div style="line-height:13.333332061767578px"><code> 4      27262976B    44040191B    16777216B                 KERN-B</code></div>
<div style="line-height:13.333332061767578px"><code> 8      44040192B    882900991B   838860800B   ext4         OEM</code></div>
<div style="line-height:13.333332061767578px"><code>12      950009856B   966787071B   16777216B    fat16        EFI-SYSTEM  boot</code></div>
<div style="line-height:13.333332061767578px"><code> 5      966787072B   968884223B   2097152B                  ROOT-B</code></div>
<div style="line-height:13.333332061767578px"><code> 3      968884224B   2269118463B  1300234240B  ext2         ROOT-A</code></div>
<div style="line-height:13.333332061767578px"><code> 1      2269118464B  2315255807B  46137344B    ext2         STATE</code></div>
<div style="line-height:13.333332061767578px"><br />
</div>
<div style="line-height:13.333332061767578px"><code>(parted)</code><code> </code><b><code>quit</code></b><code> </code><code>                                                            </code></div>
<div style="line-height:13.333332061767578px"><code>$</code></div>
</div>
</div>
<p>Note that we do <b>not</b> want to repair any of the GPT headers. Just answer "I" (ignore) when asked about them.</p>
<p>The rootfs partition is partition 3, which begins 968884224 bytes into the disk. That's the magic number we need to remember. (We could just refer to /dev/sdc3 with an offset of 0, but this process works on binary images too.)</p>
<p>This script will modify the ext2 flags bits in the rootfs filesystem header so we can mount it. Copy it into a file and mark it as executable.</p>
<div></div>
<div class="sites-codeblock sites-codesnippet-block">
<div><span style="color:rgb(0,96,0);font-family:arial,sans-serif;line-height:1;font-size:10pt">#!/bin/bash</span></div>
<div>
<div><font face="arial, sans-serif"><br />
</font></div>
<div><font face="arial, sans-serif"><code>is_ext2() {</code></font></div>
<div><font face="arial, sans-serif"><code>  local rootfs="$1"</code></font></div>
<div><font face="arial, sans-serif"><code>  local offset="${2-0}"</code></font></div>
<div><font face="arial, sans-serif"><code>  # Make sure we're checking an ext2 image</code></font></div>
<div><font face="arial, sans-serif"><code>  local sb_magic_offset=$((0x438))</code></font></div>
<div><font face="arial, sans-serif"><code>  local sb_value=$(sudo dd if="$rootfs" skip=$((offset + sb_magic_offset)) \</code></font></div>
<div><font face="arial, sans-serif"><code>                   count=2 bs=1 2&gt;/dev/null)</code></font></div>
<div><font face="arial, sans-serif"><code>  local expected_sb_value=$(printf '\123\357')</code></font></div>
<div><font face="arial, sans-serif"><code>  if [ "$sb_value" = "$expected_sb_value" ]; then</code></font></div>
<div><font face="arial, sans-serif"><code>    return 0</code></font></div>
<div><font face="arial, sans-serif"><code>  fi</code></font></div>
<div><font face="arial, sans-serif"><code>  return 1</code></font></div>
<div><font face="arial, sans-serif"><code>}</code></font></div>
<div><font face="arial, sans-serif"><br />
</font></div>
<div><font face="arial, sans-serif"><code>enable_rw_mount() {</code></font></div>
<div><font face="arial, sans-serif"><code>  local rootfs="$1"</code></font></div>
<div><font face="arial, sans-serif"><code>  local offset="${2-0}"</code></font></div>
<div><font face="arial, sans-serif"><code>  # Make sure we're checking an ext2 image</code></font></div>
<div><font face="arial, sans-serif"><code>  if ! is_ext2 "$rootfs" $offset; then</code></font></div>
<div><font face="arial, sans-serif"><code>    echo "enable_rw_mount called on non-ext2 filesystem: $rootfs $offset" 1&gt;&amp;2</code></font></div>
<div><font face="arial, sans-serif"><code>    return 1</code></font></div>
<div><font face="arial, sans-serif"><code>  fi</code></font></div>
<div><font face="arial, sans-serif"><code>  local ro_compat_offset=$((0x464 + 3))  # Set 'highest' byte</code></font></div>
<div><font face="arial, sans-serif"><code>  # Dash can't do echo -ne, but it can do printf "\NNN"</code></font></div>
<div><font face="arial, sans-serif"><code>  # We could use /dev/zero here, but this matches what would be</code></font></div>
<div><font face="arial, sans-serif"><code>  # needed for disable_rw_mount (printf '\377').</code></font></div>
<div><font face="arial, sans-serif"><code>  printf '\000' |</code></font></div>
<div><font face="arial, sans-serif"><code>    sudo dd of="$rootfs" seek=$((offset + ro_compat_offset)) \</code></font></div>
<div><font face="arial, sans-serif"><code>            conv=notrunc count=1 bs=1 2&gt;/dev/null</code></font></div>
<div><font face="arial, sans-serif"><code>}</code></font></div>
<div><br />
</div>
<div><font face="arial, sans-serif"><code>[ -n "$2" ] || exit 1</code></font></div>
<div><font face="arial, sans-serif"><code>enable_rw_mount $1 $2</code></font></div>
</div>
</div>
<p>Provide the USB device and the byte offset as arguments to the script, and now we can mount the rootfs from the recovery image:</p>
<div><font face="arial, sans-serif">
<div></div>
<div class="sites-codeblock sites-codesnippet-block">
<div><code>$ <b>sudo ./enable_rw_mount.sh /dev/sdc 968884224</b></code></div>
<div><code>$ <b>sudo mount /dev/sdc3 /mnt</b></code></div>
<div><code>$ <b>ls /mnt</b></code></div>
<div><code>bin/     dev/  home/  lib64/       media/  opt/       proc/  sbin/  tmp/  var/</code></div>
<div><code>debugd/  etc/  lib/   lost+found/  mnt/    postinst@  root/  sys/   usr/</code><span style="color:rgb(0,96,0);line-height:1;font-size:10pt"> </span></div>
</div>
</font></div>
<h3><a name="TOC-Change-the-chromeos-install-script-to-just-fix-the-flags"></a><font face="arial, sans-serif">Change the chromeos-install script to just fix the flags</font></h3>
<p><font face="arial, sans-serif">The recovery image would normally run the</font> <code>/usr/sbin/chromeos-install</code> <font face="arial, sans-serif">script, which would wipe the SSD and restore everything. We don't want that, so we'll just modify that script to restore the dev-mode flags to allow our custom image to boot again.</font></p>
<p><font face="arial, sans-serif">Create the script we want:</font></p>
<div>
<div style="font-family:arial,sans-serif"></div>
<div class="sites-codeblock sites-codesnippet-block" style="font-family:arial,sans-serif">
<div><code>$ <b>cat &gt; /tmp/foo.txt</b></code></div>
<div><code>#!/bin/bash</code></div>
<div><code>crossystem dev_boot_legacy=1 dev_boot_usb=1 </code></div>
<div><code>sleep 5</code></div>
<div><code>exit</code></div>
<div><code><b>^D</b></code></div>
<div><code>$</code></div>
</div>
<p style="font-family:arial,sans-serif">Replace the original script:</p>
<div style="font-family:arial,sans-serif"></div>
<div class="sites-codeblock sites-codesnippet-block">
<div style="font-family:arial,sans-serif"><code>$ <b>sudo cp /tmp/foo.txt /mnt/usr/sbin/chromeos-install</b> </code></div>
<div>
<div style="font-family:arial,sans-serif"><code>$ <b>ls -l </b></code><span style="font-size:10pt;background-color:transparent"><code><b>/mnt/usr/sbin/chromeos-install</b></code></span></div>
<div style="font-family:arial,sans-serif"><code>-rwxr-xr-x 1 root root 76 Jun 16 16:44 /mnt/usr/sbin/chromeos-install*</code></div>
<div style="font-family:arial,sans-serif"><code>$ <b>cat </b></code><span style="font-size:10pt;background-color:transparent"><code><b>/mnt/usr/sbin/chromeos-install</b></code></span></div>
<div style="font-family:arial,sans-serif"><code>#!/bin/bash</code></div>
<div style="font-family:arial,sans-serif"><code>crossystem dev_boot_legacy=1 dev_boot_usb=1</code></div>
<div style="font-family:arial,sans-serif"><code>sleep 5</code></div>
<div style="font-family:arial,sans-serif"><code>exit</code></div>
<div><font color="#006000" face="monospace">$</font></div>
</div>
</div>
<p>Note that it's executable, and has the content we want. Unmount the USB stick.</p>
<div class="sites-codeblock sites-codesnippet-block" style="font-family:arial,sans-serif">
<div><code>$ <b>sudo umount /mnt</b></code></div>
</div>
</div>
<h3><a name="TOC-Recover-the-dev-mode-flags"></a>Recover the dev-mode flags</h3>
<p>Now you can insert this recovery image into your Chromebook. When it goes through the normal "Verifying the integrity of your recovery media" process, it may complain that the rootfs is not verified, but it will continue on anyway because we're in developer mode. It will then proceed to the "System recovery" step, but don't panic - it's going to run your modified script instead. That should only take a few seconds. Once it completes, remove the USB stick and when it reboots, your Ctrl-L and Ctrl-U shortcuts should work again.</p></div></td></tr></tbody></table>
</div> 
</div> 
<div id="sites-canvas-bottom-panel">
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_page-subpages"> </div>
<div id="sites-attachments-container">
</div>
<a xmlns="http://www.w3.org/1999/xhtml" name="page-comments"></a>
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_page-comments"><div class="sites-comment-docos-wrapper"><div class="sites-comment-docos"><div class="sites-comment-docos-background"></div><div class="sites-comment-docos-header"><div class="sites-comment-docos-header-title">Comments</div></div><div id="sites-comment-docos-pane" class="sites-comment-docos-pane"></div></div></div></div>
</div>
</div> 
</td> 
</tr>
</table> 
</div> 
</div> 
<div id="sites-chrome-footer-wrapper">
<div id="sites-chrome-footer-wrapper-inside">
<div id="sites-chrome-footer">
</div>
</div>
</div>
</div> 
</div> 
<div id="sites-chrome-adminfooter-container">
<div xmlns="http://www.w3.org/1999/xhtml" class="sites-adminfooter" role="navigation"><p><a class="sites-system-link" href="https://www.google.com/a/UniversalLogin?service=jotspot&amp;continue=https://sites.google.com/a/chromium.org/dev/chromium-os/developer-information-for-chrome-os-devices/workaround-for-battery-discharge-in-dev-mode">Sign in</a><span aria-hidden="true">|</span><a class="sites-system-link" href="../../system/app/pages/recentChanges.html">Recent Site Activity</a><span aria-hidden="true">|</span><a class="sites-system-link" href="../../system/app/pages/reportAbuse.html" target="_blank">Report Abuse</a><span aria-hidden="true">|</span><a class="sites-system-link" href="javascript:;" onclick="window.open(webspace.printUrl)">Print Page</a><span aria-hidden="true">|</span><span class="sites-system-link">Powered By</span> <b class="powered-by"><a href="http://sites.google.com">Google Sites</a></b></p></div>
</div>
</div> 
</div> 
<div id="sites-chrome-onebar-footer">
</div>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
    window.jstiming.load.tick('sjl');
  </script>
<script xmlns="http://www.w3.org/1999/xhtml" src="https://ssl.gstatic.com/sites/p/56e332/system/js/jot_min_view__en.js"></script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
    window.jstiming.load.tick('jl');
  </script>
<script xmlns="http://www.w3.org/1999/xhtml">
      
          sites.core.Analytics.createTracker();
          sites.core.Analytics.trackPageview();
        
    </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
                    sites.Searchbox.initialize(
                        'sites-searchbox-search-button',
                        {"object":[]}['object'],
                        'search-site',
                        {"label":"Configure search options...","url":"/system/app/pages/admin/settings"});
                  </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
      gsites.HoverPopupMenu.createSiteDropdownMenus('sites-header-nav-dropdown', false);
    </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript" defer="true">
            JOT_setupNav("7648876402527094", "Navigation", false);
            JOT_addListener('titleChange', 'JOT_NAVIGATION_titleChange', 'COMP_7648876402527094');
          </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript" defer="true">
            JOT_setupNav("14720868319272995", "Quick links", false);
            JOT_addListener('titleChange', 'JOT_NAVIGATION_titleChange', 'COMP_14720868319272995');
          </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript" defer="true">
            JOT_setupNav("19690813310444355", "Other sites", false);
            JOT_addListener('titleChange', 'JOT_NAVIGATION_titleChange', 'COMP_19690813310444355');
          </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
              new sites.CommentPane('//docs.google.com/comments/d/AAHRpnXvrAwjAfmld0ObrebBiGRq98ZfczF5HWDc_FlwJroqaKG7T5pKwdz7Hvz13e-bHmr6AW8Naj5d37iOLiy93ce54ggaNS1duS67U8hL5FwmshxCzzgrHuMj7fF7mJvP6FbFDSmw7/api/js?anon=true',
                  false, false);
            </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
  setTimeout(function() {
    var fingerprint = gsites.date.TimeZone.getFingerprint([]);
    gsites.Xhr.send('https://www.chromium.org/_/tz', null, null, 'GET', null, null, { afjstz: fingerprint });
  }, 500);
</script>
<script xmlns="http://www.w3.org/1999/xhtml">
                    window.onload = function() {
                      if (false) {
                        JOT_setMobilePreview();
                      }
                      var loadTimer = window.jstiming.load;
                      loadTimer.tick("ol");
                      loadTimer["name"] = "load," + webspace.page.type + ",user_page";
                      window.jstiming.report(loadTimer, {}, 'https://gg.google.com/csi');
                    }
                  </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
        JOT_insertAnalyticsCode(false,
            false);
      </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
    var maestroRunner = new gsites.pages.view.SitesMaestroRunner(
        webspace, "en");
    maestroRunner.initListeners();
    maestroRunner.installEditRender();
  </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript" defer="true">
  //<![CDATA[
    // Decorate any fastUI buttons on the page with a class of 'goog-button'.
    if (webspace.user.hasWriteAccess) {
      JOT_decorateButtons();
    }

    // Fires delayed events.
    (function() {
      JOT_fullyLoaded = true;
      var delayedEvents = JOT_delayedEvents;
      for (var x = 0; x < delayedEvents.length; x++) {
        var event = delayedEvents[x];
        JOT_postEvent(event.eventName, event.eventSrc, event.payload);
      }
      JOT_delayedEvents = null;
      JOT_postEvent('pageLoaded');
    })();
  //]]>
</script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
    JOT_postEvent('decorateGvizCharts');
  </script>
<script type="text/javascript">
          JOT_setupPostRenderingManager();
        </script>
<script type="text/javascript">
          JOT_postEvent('renderPlus', null, 'sites-chrome-main');
        </script>
<div id="server-timer-div" style="display:none"> </div>
<script type="text/javascript">
          window.jstiming.load.tick('render');
          JOT_postEvent('usercontentrendered', this);
        </script>
</body>
</html>
