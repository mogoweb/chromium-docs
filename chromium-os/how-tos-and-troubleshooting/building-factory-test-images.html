<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/WebPage">
<head>
<meta http-equiv="X-UA-Compatible" content="chrome=1" />
<script type="text/javascript">/* Copyright 2008 Google. */ (function() { var e="wtsrt_",g="tbsd_",h="tbnd_",k="start",l="_wtsrt",m="_tbnd",n="CSI/";(function(){function f(a){this.t={};this.tick=function(a,c,b){this.t[a]=[void 0!=b?b:(new Date).getTime(),c];if(void 0==b)try{window.console.timeStamp(n+a)}catch(d){}};this.tick(k,null,a)}var a;window.performance&&(a=window.performance.timing);var p=a?new f(a.responseStart):new f;window.jstiming={Timer:f,load:p};if(a){var c=a.navigationStart,d=a.responseStart;0<c&&d>=c&&(window.jstiming.srt=d-c)}if(a){var b=window.jstiming.load;0<c&&d>=c&&(b.tick(l,void 0,c),b.tick(e,l,d),b.tick(g,e))}try{a=null,
window.chrome&&window.chrome.csi&&(a=Math.floor(window.chrome.csi().pageT),b&&0<c&&(b.tick(m,void 0,window.chrome.csi().startE),b.tick(h,m,c))),null==a&&window.gtbExternal&&(a=window.gtbExternal.pageT()),null==a&&window.external&&(a=window.external.pageT,b&&0<c&&(b.tick(m,void 0,window.external.startE),b.tick(h,m,c))),a&&(window.jstiming.pt=a)}catch(q){}})(); })()
</script>
<link rel="shortcut icon" href="../../_/rsrc/1354323194313/favicon.ico" type="image/x-icon" />
<link rel="apple-touch-icon" href="https://ssl.gstatic.com/sites/p/56e332/system/app/images/apple-touch-icon.png" type="image/png" />
<script type="text/javascript">/* Copyright 2008 Google. */ (function() { var d="",g="__duration__",h="function";function k(c){return document.getElementById(c)}window.byId=k;function l(c){return c.replace(/^\s+|\s+$/g,d)}window.trim=l;var m=[],n=0;window.JOT_addListener=function(c,a,b){var e=new String(n++);c={eventName:c,handler:a,compId:b,key:e};m.push(c);return e};window.JOT_removeListenerByKey=function(c){for(var a=0;a<m.length;a++)if(m[a].key==c){m.splice(a,1);break}};
window.JOT_removeAllListenersForName=function(c){for(var a=0;a<m.length;a++)m[a].eventName==c&&m.splice(a,1)};window.JOT_postEvent=function(c,a,b){var e={eventName:c,eventSrc:a||{},payload:b||{}};if(window.JOT_fullyLoaded)for(a=m.length,b=0;b<a&&b<m.length;b++){var f=m[b];f&&f.eventName==c&&(e.listenerCompId=f.compId||d,(f=typeof f.handler==h?f.handler:window[f.handler])&&f(e))}else window.JOT_delayedEvents.push({eventName:c,eventSrc:a,payload:b})};window.JOT_delayedEvents=[];
window.JOT_fullyLoaded=!1;window.JOT_formatRelativeToNow=function(c,a){var b=((new Date).getTime()-c)/6E4;if(1440<=b||0>b)return null;var e=0;60<=b&&(b/=60,e=2);2<=b&&e++;return a?window.JOT_siteRelTimeStrs[e].replace(g,Math.floor(b)):window.JOT_userRelTimeStrs[e].replace(g,Math.floor(b))}; })()
</script>
<script>

  

  var breadcrumbs = [{"path":"/chromium-os","deleted":false,"title":"Chromium OS","dir":"ltr"},{"path":"/chromium-os/how-tos-and-troubleshooting","deleted":false,"title":"How Tos and Troubleshooting","dir":"ltr"},{"path":"/chromium-os/how-tos-and-troubleshooting/building-factory-test-images","deleted":false,"title":"Building Factory Test Images","dir":"ltr"}];
  var JOT_clearDotPath = 'https://ssl.gstatic.com/sites/p/56e332/system/app/images/cleardot.gif';

  
  var JOT_userRelTimeStrs = ["a minute ago","__duration__ minutes ago","an hour ago","__duration__ hours ago"];

  
  

  

  var webspace = {"enableAnalytics":true,"pageSharingId":"jotspot_page","enableUniversalAnalytics":false,"sharingPolicy":"OPENED_WITH_INDICATOR","siteTitle":"The Chromium Projects","isStartPageEnabled":true,"adsensePublisherId":null,"features":{"languageSelectDefaultTextSetToDefault":true,"validateClientGvizDataSourceUrls":true,"moreMobileStyleImprovements":true,"newInsertMenuIcons":true,"accessibleSortingButtons":true,"domainAnalyticsInGAOnly":true,"noCaptcha":true,"fileCabinetScreenReaderFix":true,"updatedTosAndPrivacyLinks":null,"pageDrafts":false,"mobileOrientationFix":true,"plusBadge":false,"pdfEmbedSupport":false,"jsClickFix":true},"isPublic":true,"isConsumer":false,"serverFlags":{"cajaBaseUrl":"//www.gstatic.com/caja","cajaDebugMode":false},"onepickBaseUrl":"https://docs.google.com","domainAnalyticsAccountId":"","plusPageId":"","signInUrl":"https://www.google.com/a/SelectSession?continue\u003dhttps://sites.google.com/a/chromium.org/dev/chromium-os/how-tos-and-troubleshooting/building-factory-test-images\u0026service\u003djotspot","analyticsAccountId":"UA-5484340-1","scottyUrl":"/_/upload","homePath":"/","siteNoticeUrlEnabled":null,"plusPageUrl":"","adsensePromoClickedOrSiteIneligible":true,"csiReportUri":"https://gg.google.com/csi","sharingId":"jotspot","termsUrl":"//www.google.com/intl/en/policies/terms/","gvizVersion":1,"editorResources":{"sitelayout":["https://ssl.gstatic.com/sites/p/56e332/system/app/css/sitelayouteditor.css"],"text":["https://ssl.gstatic.com/sites/p/56e332/system/js/codemirror.js","https://ssl.gstatic.com/sites/p/56e332/system/app/css/codemirror_css.css","https://ssl.gstatic.com/sites/p/56e332/system/js/trog_edit__en.js","https://ssl.gstatic.com/sites/p/56e332/system/app/css/trogedit.css","/_/rsrc/1441580320000/system/app/css/editor.css","https://ssl.gstatic.com/sites/p/56e332/system/app/css/codeeditor.css","/_/rsrc/1441580320000/system/app/css/camelot/editor-jfk-wlb.css"]},"sharingUrlPrefix":"/_/sharing","isAdsenseEnabled":true,"domain":"chromium.org","baseUri":"","name":"dev","siteTemplateId":false,"siteNoticeRevision":null,"siteNoticeUrlAddress":null,"siteNoticeMessage":null,"page":{"isRtlLocale":false,"canDeleteWebspace":null,"isPageDraft":null,"parentPath":"/chromium-os/how-tos-and-troubleshooting","parentWuid":"wuid:gx:72ecb36fa9c83ecd","siteLocale":"en","timeZone":"America/Los_Angeles","type":"text","title":"Building Factory Test Images","locale":"en","wuid":"wuid:gx:46a35f225de36201","revision":33,"path":"/chromium-os/how-tos-and-troubleshooting/building-factory-test-images","isSiteRtlLocale":false,"pageInheritsPermissions":null,"name":"building-factory-test-images","canChangePath":true,"state":"","properties":{},"bidiEnabled":false,"currentTemplate":{"path":"/system/app/pagetemplates/text","title":"Web Page"}},"canPublishScriptToAnyone":true,"user":{"keyboardShortcuts":true,"sessionIndex":"","guest_":true,"displayNameOrEmail":"guest","userName":"guest","uid":"","renderMobile":false,"domain":"","namespace":"","hasWriteAccess":false,"namespaceUser":false,"primaryEmail":"guest","hasAdminAccess":false},"gadgets":{"baseUri":"/system/app/pages/gadgets"}};
  webspace.page.breadcrumbs = breadcrumbs;

  
  var JOT_siteRelTimeStrs = ["a minute ago","__duration__ minutes ago","an hour ago","__duration__ hours ago"];

</script>
<script type="text/javascript">
                window.jstiming.load.tick('scl');
              </script>
<meta name="title" content="Building Factory Test Images - The Chromium Projects" />
<meta itemprop="name" content="Building Factory Test Images - The Chromium Projects" />
<meta property="og:title" content="Building Factory Test Images - The Chromium Projects" />
<meta name="description" content="Home of the Chromium Open Source Project" />
<meta itemprop="description" content="Home of the Chromium Open Source Project" />
<meta id="meta-tag-description" property="og:description" content="Home of the Chromium Open Source Project" />
<style type="text/css">
</style>
<link rel="stylesheet" type="text/css" href="https://ssl.gstatic.com/sites/p/56e332/system/app/themes/beigeandblue/standard-css-beigeandblue-ltr-ltr.css" />
<link rel="stylesheet" type="text/css" href="../../_/rsrc/1441580320000/system/app/css/overlay.css%3Fcb=beigeandblueundefineda100%2525%2525150goog-ws-leftthemedefaultstandard.css" />
<link rel="stylesheet" type="text/css" href="../../_/rsrc/1441580320000/system/app/css/camelot/allthemes-view.css" />
<!--[if IE]>
          <link rel="stylesheet" type="text/css" href="/system/app/css/camelot/allthemes%2die.css" />
        <![endif]-->
<title>Building Factory Test Images - The Chromium Projects</title>
<meta itemprop="image" content="/_/rsrc/1438879449147/config/customLogo.gif?revision=3" />
<meta property="og:image" content="/_/rsrc/1438879449147/config/customLogo.gif?revision=3" />
<script type="text/javascript">
                window.jstiming.load.tick('cl');
              </script>
</head>
<body xmlns="http://www.google.com/ns/jotspot" id="body" class=" en            ">
<div id="sites-page-toolbar" class="sites-header-divider">
<div xmlns="http://www.w3.org/1999/xhtml" id="sites-status" class="sites-status" style="display:none;"><div id="sites-notice" class="sites-notice" role="status" aria-live="assertive"> </div></div>
</div>
<div id="sites-chrome-everything-scrollbar">
<div id="sites-chrome-everything" class="">
<div id="sites-chrome-page-wrapper" style="direction: ltr">
<div id="sites-chrome-page-wrapper-inside">
<div xmlns="http://www.w3.org/1999/xhtml" id="sites-chrome-header-wrapper" style="height:auto;">
<table id="sites-chrome-header" class="sites-layout-hbox" cellspacing="0" style="height:auto;">
<tr class="sites-header-primary-row" id="sites-chrome-userheader">
<td id="sites-header-title" class="" role="banner"><div class="sites-header-cell-buffer-wrapper"><a href="../../index.html" id="sites-chrome-userheader-logo"><img id="logo-img-id" src="../../_/rsrc/1438879449147/config/customLogo.gif%3Frevision=3" alt="The Chromium Projects" class="sites-logo  " /></a><h2><a href="../../index.html" dir="ltr" id="sites-chrome-userheader-title">The Chromium Projects</a></h2></div></td><td class="sites-layout-searchbox  "><div class="sites-header-cell-buffer-wrapper"><form id="sites-searchbox-form" action="https://www.chromium.org/system/app/pages/search" role="search"><input type="hidden" id="sites-searchbox-scope" name="scope" value="search-site" /><input type="text" id="jot-ui-searchInput" name="q" size="20" value="" aria-label="Search this site" /><div id="sites-searchbox-button-set" class="goog-inline-block"><div role="button" id="sites-searchbox-search-button" class="goog-inline-block jfk-button jfk-button-standard" tabindex="0">Search this site</div></div></form></div></td>
</tr>
<tr class="sites-header-secondary-row" id="sites-chrome-horizontal-nav">
<td colspan="2" id="sites-chrome-header-horizontal-nav-container" role="navigation">
</td>
</tr>
</table>
</div>
<div id="sites-chrome-main-wrapper">
<div id="sites-chrome-main-wrapper-inside">
<table id="sites-chrome-main" class="sites-layout-hbox" cellspacing="0" cellpadding="{scmCellpadding}" border="0">
<tr>
<td id="sites-chrome-sidebar-left" class="sites-layout-sidebar-left initial" style="width:150px">
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_7648876402527094" class="sites-embed" role="navigation"><div class="sites-embed-content sites-sidebar-nav"><ul role="navigation" jotId="navList"><li class="nav-first "><div dir="ltr" style="padding-left: 5px;"><a href="../../chromium-projects.html" jotId="wuid:gx:10ae433dadbbab13" class="sites-navigation-link">Home</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="../../Home.1.html" jotId="wuid:gx:43582b9d2029d3af" class="sites-navigation-link">Chromium</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="../../chromium-os.1.html" jotId="wuid:gx:83df2ab1f8880ba" class="sites-navigation-link">Chromium OS</a></div></li></ul></div></div>
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_14720868319272995" class="sites-embed" role="navigation"><h4 class="sites-embed-title">Quick links</h4><div class="sites-embed-content sites-sidebar-nav"><ul role="navigation" jotId="navList"><li class="nav-first "><div dir="ltr" style="padding-left: 5px;"><a href="../../for-testers/bug-reporting-guidelines.html" class="sites-navigation-link">Report bugs</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="../../developers/discussion-groups.html" class="sites-navigation-link">Discuss</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="../../system/app/pages/sitemap/hierarchy.html" jotId="wuid:gx:4b58a9a350ad12f" class="sites-navigation-link">网站地图</a></div></li></ul></div></div>
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_19690813310444355" class="sites-embed" role="navigation"><h4 class="sites-embed-title">Other sites</h4><div class="sites-embed-content sites-sidebar-nav"><ul role="navigation" jotId="navList"><li class="nav-first "><div dir="ltr" style="padding-left: 5px;"><a href="http://blog.chromium.org/" class="sites-navigation-link">Chromium Blog</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="http://code.google.com/chrome/extensions/" class="sites-navigation-link">Google Chrome Extensions</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="https://developers.google.com/chrome/chrome-frame/" class="sites-navigation-link">Google Chrome Frame</a></div></li></ul></div></div>
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_19695218559354544" class="sites-embed" role="complementary"><h4 class="sites-embed-title"></h4><div class="sites-embed-content sites-embed-content-sidebar-textbox"><div dir="ltr"><span style="font-size:x-small">Except as otherwise </span><a href="http://developers.google.com/site-policies.html#restrictions"><span style="font-size:x-small">noted</span></a><span style="font-size:x-small">, the content of this page is licensed under a </span><a href="http://creativecommons.org/licenses/by/2.5/"><span style="font-size:x-small">Creative Commons Attribution 2.5 license</span></a><span style="font-size:x-small">, and examples are licensed under the </span><a href="http://src.chromium.org/viewvc/chrome/trunk/src/LICENSE" target="_blank"><span style="font-size:x-small">BSD License</span></a><span style="font-size:x-small">.<br /></span></div></div></div>
</td>
<td id="sites-canvas-wrapper">
<div id="sites-canvas" role="main">
<div id="goog-ws-editor-toolbar-container"> </div>
<div xmlns="http://www.w3.org/1999/xhtml" id="title-crumbs" style="">
<A href="../../chromium-os.1.html" dir="ltr">Chromium OS</A>‎ &gt; ‎<A href="../how-tos-and-troubleshooting.1.html" dir="ltr">How Tos and Troubleshooting</A>‎ &gt; ‎
  </div>
<h3 xmlns="http://www.w3.org/1999/xhtml" id="sites-page-title-header" style="" align="left">
<span id="sites-page-title" dir="ltr" tabindex="-1" style="outline: none">Building Factory Test Images</span>
</h3>
<div id="sites-canvas-main" class="sites-canvas-main">
<div id="sites-canvas-main-content">
<table xmlns="http://www.w3.org/1999/xhtml" cellspacing="0" class="sites-layout-name-one-column sites-layout-hbox"><tbody><tr><td class="sites-layout-tile sites-tile-name-content-1"><div dir="ltr"><div><div class="sites-embed-align-right-wrapping-on"><div class="sites-embed-border-off sites-embed" style="width:500px;"><div class="sites-embed-content sites-embed-type-toc"><div class="goog-toc sites-embed-toc-maxdepth-6"><p>Contents</p><ol class="goog-toc"><li class="goog-toc"><a href="building-factory-test-images.html#TOC-Overview"><strong>1 </strong>Overview</a></li><li class="goog-toc"><a href="building-factory-test-images.html#TOC-Building-the-factory-install-shim"><strong>2 </strong>Building the factory install shim</a></li><li class="goog-toc"><a href="building-factory-test-images.html#TOC-Building-a-factory-test-image"><strong>3 </strong>Building a factory test image</a></li><li class="goog-toc"><a href="building-factory-test-images.html#TOC-Booting-your-factory-test-image-via-USB"><strong>4 </strong>Booting your factory test image via USB</a></li><li class="goog-toc"><a href="building-factory-test-images.html#TOC-Preparing-a-factory-package-set"><strong>5 </strong>Preparing a factory package set</a><ol class="goog-toc"><li class="goog-toc"><a href="building-factory-test-images.html#TOC-For-branches-R16-and-later"><strong>5.1 </strong>For branches R16 and later</a></li><li class="goog-toc"><a href="building-factory-test-images.html#TOC-Example-with-variables"><strong>5.2 </strong>Example with variables</a><ol class="goog-toc"><li class="goog-toc"><a href="building-factory-test-images.html#TOC-x86-generic"><strong>5.2.1 </strong>x86-generic</a></li></ol></li><li class="goog-toc"><a href="building-factory-test-images.html#TOC-Example-with-multiple-configurations"><strong>5.3 </strong>Example with multiple configurations</a><ol class="goog-toc"><li class="goog-toc"><a href="building-factory-test-images.html#TOC-x86-generic-and-_3g"><strong>5.3.1 </strong>x86-generic and _3g</a></li></ol></li><li class="goog-toc"><a href="building-factory-test-images.html#TOC-Notes"><strong>5.4 </strong>Notes</a></li></ol></li><li class="goog-toc"><a href="building-factory-test-images.html#TOC-Setting-up-a-mini-Omaha-server-installation"><strong>6 </strong>Setting up a mini-Omaha server installation</a></li><li class="goog-toc"><a href="building-factory-test-images.html#TOC-Building-an-SSD-image"><strong>7 </strong>Building an SSD image</a></li><li class="goog-toc"><a href="building-factory-test-images.html#TOC-Modifying-the-factory-test-image-or-adding-test-cases"><strong>8 </strong>Modifying the factory test image or adding test cases</a></li></ol></div></div></div></div></div>
<h2><a name="TOC-Overview"></a>Overview</h2>
<p>The Chromium OS reference factory software provides a sample factory install
and test flow for manufacturing Chrome devices. It is available as part of the
public Chromium OS repository on chromium.org. This code is meant as a starting
point, to modify and adapt to different projects. The basic steps are:</p>
<ol>
<li> An initial/bootable version of the <a href="../ec-development.html">EC</a> and <a href="../2014-firmware-summit.html">firmware</a> is pre-flashed onto the Chromium EC chip and SPI-ROM before system assembly. 
  </li>
<li> After system assembly, insert the Factory Install Shim USB stick. After the
device boots and the DEV mode screen displays, press Ctrl-U to boot from USB.
The shim contacts a mini-Omaha server to request an install image. The firmware
also supports booting and installing from a network location using tftp,
without a USB stick.
  </li>
<li> A factory test image, signed release image, and EC/firmware is installed or
updated. Included on disk are two full Chrome OS images: the test image and the
shipping image.
  </li>
<li> The system automatically reboots using the factory test image and begins
manufacturing tests. This test suite is based on <a href="https://chromium.googlesource.com/chromiumos/platform/factory/+/master/py/test/pytests/">pytest</a>. The software supports sequencing tests, configuration, firmware and
configuration updates, reboots, and other events in a configurable sequence.
  </li>
<li> Functional, Run-In, and manual tests run as configured. Upon completion,
results are displayed on the screen. Results are also available as an
electronic pass/fail record with detailed logs for uploading to the shopfloor
server.
  </li>
<li> The factory test image is automatically erased, leaving the release image as
bootable.
  </li>
<li> On failure, the system continues running subsequent tests and reports failures
on completion. Alternatively you can configure it to halt on failure at
specific break points. For details, see the Options class in <code>src/platform/factory/py/test/factory.py</code> and generic test lists under <code>src/platform/factory/py/test/test_lists/*</code> .
  </li>
<li> The factory image and test image can be combined into an SSD image and imaged
onto the internal drive before assembly. The first time the device boots, the
sequence starts at step 4 above, using the factory test image.
</li>
</ol>
<h2><a name="TOC-Building-the-factory-install-shim"></a>Building the factory install shim</h2>
<p>To build a factory install shim, you need a <a href="../developer-guide.1.html">Chromium OS development environment</a>. After finishing the setup_board sequence and selecting the target board:</p>
<ol>
<li> From inside the cros-chroot:
  </li>
</ol>
<blockquote style="margin:0 0 0 40px;border:none;padding:0px"><span style="font-size:10pt;background-color:transparent"><code>(cros-chroot) ~/trunk/src/scripts $ ./setup_board --board x86-generic --default</code></span></blockquote>
<span style="font-size:10pt;background-color:transparent">
<ol start="2"><li><span style="font-size:10pt;background-color:transparent">Build all the packages, including the factory install shim package</span></li>
</ol>
</span>
<blockquote style="margin:0 0 0 40px;border:none;padding:0px"><span style="font-size:10pt;background-color:transparent"><code>./build_packages</code></span></blockquote>
<span style="font-size:10pt;background-color:transparent">
<ol start="3"><li><span style="font-size:10pt;background-color:transparent">Build a special factory install shim image (with special kernel and rootfs):</span></li>
</ol>
</span>
<blockquote style="margin:0 0 0 40px;border:none;padding:0px"><span style="font-size:10pt;background-color:transparent"><code>./build_image factory_install</code></span></blockquote>
<span style="font-size:10pt;background-color:transparent">
<ol start="4"><li><span style="font-size:10pt;background-color:transparent">The target URL to connect to the mini-Omaha server is stored in the factory
install shim image, in the first partition of the image file (</span><code style="font-size:10pt;background-color:transparent">/dev/sd?1:dev_image/etc/lsb-factory</code><span style="font-size:10pt;background-color:transparent">). You can modify this file using the following command:</span></li>
</ol>
</span>
<blockquote style="margin:0 0 0 40px;border:none;padding:0px">
<pre><code>edit_lsb_factory.sh</code></pre>
</blockquote>
<ol start="5">
<li> Follow the prompts to specify the host name or IP address of the mini_Omaha
server and save your changes. An image named <font face="courier new, monospace">factory_install_shim.bin</font> is created in your build directory (<font face="courier new, monospace">../builds/$BOARD/latest</font>). The following table describes the options:
</li>
</ol>
<table border="1" style="margin-left:20px">
<tbody>
<tr>
<td style="width:427.181818246841px;height:41.1818182468414px">
<p><strong>Option</strong></p>
</td>
<td style="width:1079.18181824684px;height:41.1818182468414px">
<p><strong>Description</strong></p>
</td>
</tr>
<tr>
<td style="width:427.181818246841px;height:51.1818182468414px">
<p>(1) Modify mini-Omaha server host.</p>
</td>
<td style="width:1079.18181824684px;height:51.1818182468414px">
<p>Type the host name (myserver.mydomain.com) or IP address of your mini-Omaha
server. The format of the new URL is http://&lt;<em>server</em>&gt;:8080/update.</p>
</td>
</tr>
<tr>
<td style="width:427.181818246841px;height:56.1818182468414px">
<p>(2) Enable/disable board prompt on download.</p>
</td>
<td style="width:1079.18181824684px;height:56.1818182468414px">
<p>By default, a user must type <code>i</code> to start the installation after the image is downloaded. Disable this prompt
if you want the installation to start automatically after download, without
user input.</p>
</td>
</tr>
<tr>
<td style="width:427.181818246841px;height:70.1818182468414px">
<p>(3) Enable/disable RELEASE-ONLY recovery download mode.</p>
</td>
<td style="width:1079.18181824684px;height:70.1818182468414px">
<p>By default, a factory test image is installed along with a release image.
Enable this option to install only a release image.</p>
</td>
</tr>
</tbody>
</table>
<ol start="6">
<li> Copy the image to your SD card or USB memory stick with the command:  
  </li>
</ol>
<div class="sites-codeblock sites-codesnippet-block">
<span style="font-size:10pt;background-color:transparent"><code>sudo dd bs=4M if=/path/to/image/factory_install_shim.bin of=/dev/sdX \</code></span><br />
<span style="font-size:10pt;background-color:transparent"><code>iflag=fullblock oflag=dsync</code></span></div>
<br />
<span style="font-size:10pt;background-color:transparent">On boot, the factory install shim displays a download status and downloads the
image from the server. On completion, the shim reboots. If you are using legacy
firmware (not Chrome OS firmware), you might need to remove the SD card to
allow booting the newly-installed image.</span><br />
<span style="font-size:10pt;background-color:transparent">After the image starts downloading and the status message turns green, you can
remove the SD card—it is not needed after that point.</span><br />
<ol>
</ol>
<h2><a name="TOC-Building-a-factory-test-image"></a>Building a factory test image</h2>
<p>To build a factory test image, you need a <a href="../developer-guide.1.html">Chromium OS development environment</a>.<em> </em>Also required are any files in private repos that are specific to the system
being manufactured. You can access upcoming board repositories in a <em>.repo/local_manifest.xml</em> file, which Google provides after the board repositories and authentication
are set up.</p>
<p>1. From inside the cros-chroot:</p>
<p><code>(cros-chroot)~/trunk/src/scripts $</code></p>
<p>2. Build all the packages, including the autotest package:</p>
<p><code>./build_packages</code></p>
<p>3. Build a test image. This step creates an image named <em>chromiumos_test_image.bin</em> in your build directory.</p>
<p><code>./build_image test</code></p>
<p>4. Build the factory toolkit. This step creates a file called <em>install_factory_toolkit.run</em>.</p>
<p><code>./make_factory_toolkit.sh</code></p>
<p>5. Run the factory toolkit, patching <em>chromiumos_test_image.bin</em>.</p>
<p><code>~/trunk/src/build/images/YOUR_BOARD_NAME/latest/install_factory_toolkit.run \</code></p>
<p><code>    /path/to/chromiumos_test_image.bin</code></p>
<p> Now when you image a device with <code>chromiumos_test_image.bin</code>, the factory tests are enabled.</p>
<h2><a name="TOC-Booting-your-factory-test-image-via-USB"></a>Booting your factory test image via USB</h2>
<p>For development and local testing, it is possible to boot the factory test
image from a USB memory stick rather than using a network install. The
following steps are optional:</p>
<ol>
<li> Copy the image binary to USB storage (for example, <code>/dev/sd1</code>).
  </li>
</ol>
<blockquote style="margin:0 0 0 40px;border:none;padding:0px"><span style="color:rgb(0,96,0);font-size:10pt;background-color:transparent"><code>cros flash usb:// chromiumos_factory_image.bin</code></span></blockquote>
<ol start="2">
<li> On your device, switch to developer mode,and enter VT2 by pressing Ctrl-Alt-F2.
  </li>
<li> Log in as root with password <code>test0000</code> if required.</li>
<li>Run the following command:</li>
</ol>
<blockquote style="margin:0 0 0 40px;border:none;padding:0px"><span style="color:rgb(0,96,0);font-size:10pt;background-color:transparent"><code>sudo chromeos-firmwareupdate --mode=todev</code></span></blockquote>
<ol start="5">
<li> Insert the USB memory stick and press <strong>Ctrl-U</strong> at the blue boot warning screen. You can also enter VT2 and install the image
to SSD using the <font face="courier new, monospace">chromeos_install</font> command.
  </li>
</ol>
<strong style="font-size:10pt;background-color:transparent">Note:</strong><span style="font-size:10pt;background-color:transparent"> This does not apply to CR48—on that system firmware write protection must be
disabled.</span><br />
<ol>
</ol>
<h2><a name="TOC-Preparing-a-factory-package-set"></a>Preparing a factory package set</h2>
<p>By default, a factory installation places the factory test image in the first
slot of Chrome OS image partitions (<a href="../chromiumos-design-docs/disk-format.html#TOC-Drive-partitions">#2 and #3</a>), and the release image in the second slot (#4 and #5).</p>
<h3><a name="TOC-For-branches-R16-and-later"></a>For branches R16 and later</h3>
<p>You can build a generic factory package from a release image and a factory
image as follows:</p>
<div class="sites-codeblock sites-codesnippet-block">
<p><code>(cros-chroot) ~/trunk/src/scripts/make_factory_package.sh \</code></p>
<p><code>  --factory=/path/to/chromiumos_factory_image.bin \</code></p>
<p><code>  --release=/path/to/chromiumos_image.bin \</code></p>
<p><code>  --hwid=/path/to/hwid_bundle.sh</code></p>
</div>
<p>This command generates a <em>miniomaha.conf</em> file and a partition update <em>.gz</em> set. Any existing configuration and partition update sets are erased.</p>
<p>Starting with R16, for running the same configuration multiple times, or
releasing a preconfigured setup for partners, <font face="courier new, monospace">make_factory_package</font> also
supports a <code>--config</code> mode:</p>
<p><code>(cros-chroot) ~/trunk/src/make_factory_package.sh \</code></p>
<p><code>  --config=path/to/config_file.conf</code></p>
<p>The configuration file is a text file with all parameters you want to assign.
The configuration file also supports variables for specifying a relative path
for the image file source. For example, $MFP_CONFIG_DIR refers to the directory
location of the configuration file. See <code>make_factory_package.sh --help</code> for more
information. </p>
<h3><a name="TOC-Example-with-variables"></a>Example with variables </h3>
<h4><a name="TOC-x86-generic"></a><strong>x86-generic</strong></h4>
<div class="sites-codeblock sites-codesnippet-block">
<p><code>--board x86-generic</code></p>
<p><code>--factory $MFP_CONFIG_DIR/../factory_test/chromiumos_factory_image.bin</code></p>
<p><code>--release $MFP_CONFIG_DIR/../release/*-generic_*.bin</code></p>
<p><code>--hwid $MFP_CONFIG_DIR/../hwid/hwid_bundle_generic_mp.sh</code></p>
</div>
<p>To configure multiple boards in the same file, use the syntax [<i>board-name</i>] to
separate the entries. Specify the <font face="courier new, monospace">--board</font> option for the first board and then
<font face="courier new, monospace">--subfolder</font> for all remaining boards, as follows:</p>
<pre><font face="courier new, monospace">[BOARD1]
 --board BOARD1 --factory FACTORY1 ....
[BOARD2]
 --subfolder BOARD2
--board BOARD2 ....
[BOARD3]
 --subfolder BOARD3 --board BOARD3 ....</font>
</pre>
<h3><a name="TOC-Example-with-multiple-configurations"></a><strong>Example with multiple configurations</strong></h3>
<h4><a name="TOC-x86-generic-and-_3g"></a><strong>x86-generic and _3g</strong></h4>
<div class="sites-codeblock sites-codesnippet-block">
<p><code>[x86-generic]</code></p>
<p><code>--board x86-generic</code></p>
<p><code>--factory $MFP_CONFIG_DIR/../factory_test/chromiumos_factory_image.bin</code></p>
<p><code>--release $MFP_CONFIG_DIR/../release/*-generic_*.bin</code></p>
<p><code>--hwid $MFP_CONFIG_DIR/../hwid/hwid_bundle_generic_mp.sh</code></p>
<p><code>[x86-generic_3g]</code></p>
<p><code>--subfolder x86-generic_3g --board x86-generic_3g</code></p>
<p><code>--factory $MFP_CONFIG_DIR/../factory_test/chromiumos_factory_image.bin </code></p>
<p><code>--release $MFP_CONFIG_DIR/../release/*-generic-3g_*.bin</code></p>
<p><code>--hwid $MFP_CONFIG_DIR/../hwid/hwid_bundle_generic_mp.sh</code></p>
</div>
<h3><a name="TOC-Notes"></a>Notes</h3>
<ul>
<li> After R16, the firmware is automatically extracted from the release image
(<code>--release</code>), unless you specify either a different updater (<code>--firmware
path/to/updater</code>) or none to skip overwriting the firmware. Before R16, the
default value of the <code>--firmware</code> parameter is <font face="courier new, monospace">none</font>. A value of none should be
used only for development and testing, not for actual mass production in the
factory.
  </li>
<li> The file <font face="courier new, monospace">hwid_bundle.sh</font> is located in the <em>hwid</em> subfolder of your factory test image (internal source tree), or in the factory
bundle archive (zip or tbz). If the goal is to run a few factory tests without
the finalize step, use <code>--hwid none</code> to skip the HWID steps.
  </li>
<li> The factory test image, factory install shim, and release image must be
compatible. Since boot, update, and partition formats are not yet final, all
images must currently be built from the same branch.
</li></ul>
<h2><a name="TOC-Setting-up-a-mini-Omaha-server-installation"></a>Setting up a mini-Omaha server installation</h2>
<p>To set up a mini-Omaha server installation, you need a <a href="../developer-guide.1.html">Chromium OS development environment.</a> The factory test image and release image update package set are required, as
described above. <span style="font-size:10pt;background-color:transparent">Python 2.6 is required, with module </span><strong style="font-size:10pt;background-color:transparent">cherrypy 3.0</strong><span style="font-size:10pt;background-color:transparent">. You can install this by running <code>sudo apt-get install python-cherrypy3</code> on
Ubuntu.</span></p>
<p>To prepare packages and start the mini-Omaha server:</p>
<div class="sites-codeblock sites-codesnippet-block">
<p><code>(cros-chroot) ~/trunk/src/make_factory_package.sh \</code></p>
<p><code>--factory=/path/to/chromiumos_factory_image.bin \</code></p>
<p><code>--release=/path/to/chromiumos_image.bin \</code></p>
<p><code>--hwid=/path/to/hwid_bundle.sh \</code></p>
<p><code>--run_omaha</code></p>
</div>
<p>or</p>
<p><code>~/trunk/src/make_factory_package.sh --config path/to/config --run</code></p>
<p>The <code>--run_omaha</code> parameter tells <font face="courier new, monospace">make_factory_setup.sh</font> to invoke <font face="courier new, monospace">miniomaha.py</font> (the mini-Omaha server) after packages have been prepared successfully.</p>
<ul>
<li> To manually start the server, change the working directory to <em>~/trunk/src/platform/factory-utils/factory_setup.</em>
</li>
<li> To check if the server is configured correctly:
  </li>
<li> python ./miniomaha.py --factory_config miniomaha.conf
--validate_factory_config
  </li>
<li> To start the server with prepared factory packages:
  </li>
<li> python ./miniomaha.py --factory_config miniomaha.conf
</li></ul>
<p>Output is logged to stdout, the server displays incoming requests, and files
are served.</p>
<p><strong>Note:</strong> Before R17, the path and file name of the mini-omaha server is different, and
the <code>--run</code> option is unsupported. You need to run the following:</p>
<div class="sites-codeblock sites-codesnippet-block">
<p><code>./make_factory_packages --release ... # all the params for packages</code></p>
<p><code>cd ../platform/dev</code></p>
<p><code>python ./devserver.py --factory_config miniomaha.conf</code></p>
</div>
<h2><a name="TOC-Building-an-SSD-image"></a>Building an SSD image</h2>
<p>To pre-image the machines rather than image them over the network, you can
generate the disk image from a factory test image and a release image.</p>
<p>A generic factory package can be built from a release image and a factory
image:</p>
<div class="sites-codeblock sites-codesnippet-block">
<p><code>./make_factory_package.sh --diskimg=ssd_image.bin \</code></p>
<p><code>--factory=/path/to/chromiumos_factory_image.bin \</code></p>
<p><code>--release=/path/to/chromiumos_image.bin \</code></p>
<p><code>--hwid=/path/to/hwid_bundle.sh</code></p>
</div>
<p>You can image directly to a device, or to a <font face="courier new, monospace">.bin</font> file. Available options are:</p>
<ul>
<li> <code>--diskimg=</code><em><code>XX</code></em> specifies the destination device or file
  </li>
<li> <code>--sectors=</code><em><code>XX</code></em> specifies the number of sectors in the bin file
  </li>
<li> <code>--preserve</code> prevents wiping of the unused space for faster imaging
</li></ul>
<h2><a name="TOC-Modifying-the-factory-test-image-or-adding-test-cases"></a>Modifying the factory test image or adding test cases</h2>
<p>The factory test image runs the series of <a href="https://chromium.googlesource.com/chromiumos/platform/factory/+/master/py/test/pytests/">pytests</a> located at <font face="courier new, monospace">src/platform/factory/py/test/pytests/* </font>(installed in <font face="courier new, monospace">/usr/local/factory/py/test/pytests/*</font> on the DUT). The sequence of pytest cases are determined by <font face="courier new, monospace">test_lists</font> files under <code>/usr/local/factory/py/test/test_lists/*.py</code><em>. </em>Status is logged to <font face="courier new, monospace">/var/log/factory.log</font><em> </em>and<em> </em>more details can be found under <font face="courier new, monospace">/var/factory/*</font>. </p>
<p>After modifying the source code, you can run the following commands to push
files to the DUT. The host machine and DUT must be on the same subnet.</p>
<p>1. From inside the cros-chroot:</p>
<p><code>(cros-chroot)~/trunk/src/platform/factory $</code></p>
<p>2. Update factory source code on DUT:</p>
<p><code>./bin/goofy_remote DUT_IP_ADDRESS</code></p>
<p>For more information on adding test cases, build the Chromium OS Factory SDK
documentation:</p>
<p>1. From inside the cros-chroot:</p>
<p><code>(cros-chroot)~/trunk/src/platform/factory $</code></p>
<p>2. Build the SDK documentation</p>
<p><code>make doc</code></p>
<p>3. Open the following file in a browser window:</p>
<p><code>~/trunk/src/platform/factory/build/doc/html/index.html</code></p></div></td></tr></tbody></table>
</div> 
</div> 
<div id="sites-canvas-bottom-panel">
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_page-subpages"> </div>
<div id="sites-attachments-container">
</div>
<a xmlns="http://www.w3.org/1999/xhtml" name="page-comments"></a>
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_page-comments"><div class="sites-comment-docos-wrapper"><div class="sites-comment-docos"><div class="sites-comment-docos-background"></div><div class="sites-comment-docos-header"><div class="sites-comment-docos-header-title">Comments</div></div><div id="sites-comment-docos-pane" class="sites-comment-docos-pane"></div></div></div></div>
</div>
</div> 
</td> 
</tr>
</table> 
</div> 
</div> 
<div id="sites-chrome-footer-wrapper">
<div id="sites-chrome-footer-wrapper-inside">
<div id="sites-chrome-footer">
</div>
</div>
</div>
</div> 
</div> 
<div id="sites-chrome-adminfooter-container">
<div xmlns="http://www.w3.org/1999/xhtml" class="sites-adminfooter" role="navigation"><p><a class="sites-system-link" href="https://www.google.com/a/UniversalLogin?service=jotspot&amp;continue=https://sites.google.com/a/chromium.org/dev/chromium-os/how-tos-and-troubleshooting/building-factory-test-images">Sign in</a><span aria-hidden="true">|</span><a class="sites-system-link" href="../../system/app/pages/recentChanges.html">Recent Site Activity</a><span aria-hidden="true">|</span><a class="sites-system-link" href="../../system/app/pages/reportAbuse.html" target="_blank">Report Abuse</a><span aria-hidden="true">|</span><a class="sites-system-link" href="javascript:;" onclick="window.open(webspace.printUrl)">Print Page</a><span aria-hidden="true">|</span><span class="sites-system-link">Powered By</span> <b class="powered-by"><a href="http://sites.google.com">Google Sites</a></b></p></div>
</div>
</div> 
</div> 
<div id="sites-chrome-onebar-footer">
</div>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
    window.jstiming.load.tick('sjl');
  </script>
<script xmlns="http://www.w3.org/1999/xhtml" src="https://ssl.gstatic.com/sites/p/56e332/system/js/jot_min_view__en.js"></script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
    window.jstiming.load.tick('jl');
  </script>
<script xmlns="http://www.w3.org/1999/xhtml">
      
          sites.core.Analytics.createTracker();
          sites.core.Analytics.trackPageview();
        
    </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
                    sites.Searchbox.initialize(
                        'sites-searchbox-search-button',
                        {"object":[]}['object'],
                        'search-site',
                        {"label":"Configure search options...","url":"/system/app/pages/admin/settings"});
                  </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
      gsites.HoverPopupMenu.createSiteDropdownMenus('sites-header-nav-dropdown', false);
    </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript" defer="true">
            JOT_setupNav("7648876402527094", "Navigation", false);
            JOT_addListener('titleChange', 'JOT_NAVIGATION_titleChange', 'COMP_7648876402527094');
          </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript" defer="true">
            JOT_setupNav("14720868319272995", "Quick links", false);
            JOT_addListener('titleChange', 'JOT_NAVIGATION_titleChange', 'COMP_14720868319272995');
          </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript" defer="true">
            JOT_setupNav("19690813310444355", "Other sites", false);
            JOT_addListener('titleChange', 'JOT_NAVIGATION_titleChange', 'COMP_19690813310444355');
          </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
              new sites.CommentPane('//docs.google.com/comments/d/AAHRpnXvrAwjAfmld0ObrebBiGRq9fCR-9iRQRc6F-E-Mx6Y1gkR8hG1Zn-RHS6Uq-GtSV43im98R1CsYNfSzGvmm_GnPFC-kIkhDiQ-sA0Qd1vRsXw1Yqqc6Bu1xnG1tuKKDy4f2GJYV/api/js?anon=true',
                  false, false);
            </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
  setTimeout(function() {
    var fingerprint = gsites.date.TimeZone.getFingerprint([]);
    gsites.Xhr.send('https://www.chromium.org/_/tz', null, null, 'GET', null, null, { afjstz: fingerprint });
  }, 500);
</script>
<script xmlns="http://www.w3.org/1999/xhtml">
                    window.onload = function() {
                      if (false) {
                        JOT_setMobilePreview();
                      }
                      var loadTimer = window.jstiming.load;
                      loadTimer.tick("ol");
                      loadTimer["name"] = "load," + webspace.page.type + ",user_page";
                      window.jstiming.report(loadTimer, {}, 'https://gg.google.com/csi');
                    }
                  </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
        JOT_insertAnalyticsCode(false,
            false);
      </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
    var maestroRunner = new gsites.pages.view.SitesMaestroRunner(
        webspace, "en");
    maestroRunner.initListeners();
    maestroRunner.installEditRender();
  </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript" defer="true">
  //<![CDATA[
    // Decorate any fastUI buttons on the page with a class of 'goog-button'.
    if (webspace.user.hasWriteAccess) {
      JOT_decorateButtons();
    }

    // Fires delayed events.
    (function() {
      JOT_fullyLoaded = true;
      var delayedEvents = JOT_delayedEvents;
      for (var x = 0; x < delayedEvents.length; x++) {
        var event = delayedEvents[x];
        JOT_postEvent(event.eventName, event.eventSrc, event.payload);
      }
      JOT_delayedEvents = null;
      JOT_postEvent('pageLoaded');
    })();
  //]]>
</script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
    JOT_postEvent('decorateGvizCharts');
  </script>
<script type="text/javascript">
          JOT_setupPostRenderingManager();
        </script>
<script type="text/javascript">
          JOT_postEvent('renderPlus', null, 'sites-chrome-main');
        </script>
<div id="server-timer-div" style="display:none"> </div>
<script type="text/javascript">
          window.jstiming.load.tick('render');
          JOT_postEvent('usercontentrendered', this);
        </script>
</body>
</html>
