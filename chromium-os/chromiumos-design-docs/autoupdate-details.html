<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/WebPage">
<head>
<meta http-equiv="X-UA-Compatible" content="chrome=1" />
<script type="text/javascript">/* Copyright 2008 Google. */ (function() { var e="wtsrt_",g="tbsd_",h="tbnd_",k="start",l="_wtsrt",m="_tbnd",n="CSI/";(function(){function f(a){this.t={};this.tick=function(a,c,b){this.t[a]=[void 0!=b?b:(new Date).getTime(),c];if(void 0==b)try{window.console.timeStamp(n+a)}catch(d){}};this.tick(k,null,a)}var a;window.performance&&(a=window.performance.timing);var p=a?new f(a.responseStart):new f;window.jstiming={Timer:f,load:p};if(a){var c=a.navigationStart,d=a.responseStart;0<c&&d>=c&&(window.jstiming.srt=d-c)}if(a){var b=window.jstiming.load;0<c&&d>=c&&(b.tick(l,void 0,c),b.tick(e,l,d),b.tick(g,e))}try{a=null,
window.chrome&&window.chrome.csi&&(a=Math.floor(window.chrome.csi().pageT),b&&0<c&&(b.tick(m,void 0,window.chrome.csi().startE),b.tick(h,m,c))),null==a&&window.gtbExternal&&(a=window.gtbExternal.pageT()),null==a&&window.external&&(a=window.external.pageT,b&&0<c&&(b.tick(m,void 0,window.external.startE),b.tick(h,m,c))),a&&(window.jstiming.pt=a)}catch(q){}})(); })()
</script>
<link rel="shortcut icon" href="http://www.chromium.org/_/rsrc/1354323194313/favicon.ico" type="image/x-icon" />
<link rel="apple-touch-icon" href="http://www.gstatic.com/sites/p/56e332/system/app/images/apple-touch-icon.png" type="image/png" />
<script type="text/javascript">/* Copyright 2008 Google. */ (function() { var d="",g="__duration__",h="function";function k(c){return document.getElementById(c)}window.byId=k;function l(c){return c.replace(/^\s+|\s+$/g,d)}window.trim=l;var m=[],n=0;window.JOT_addListener=function(c,a,b){var e=new String(n++);c={eventName:c,handler:a,compId:b,key:e};m.push(c);return e};window.JOT_removeListenerByKey=function(c){for(var a=0;a<m.length;a++)if(m[a].key==c){m.splice(a,1);break}};
window.JOT_removeAllListenersForName=function(c){for(var a=0;a<m.length;a++)m[a].eventName==c&&m.splice(a,1)};window.JOT_postEvent=function(c,a,b){var e={eventName:c,eventSrc:a||{},payload:b||{}};if(window.JOT_fullyLoaded)for(a=m.length,b=0;b<a&&b<m.length;b++){var f=m[b];f&&f.eventName==c&&(e.listenerCompId=f.compId||d,(f=typeof f.handler==h?f.handler:window[f.handler])&&f(e))}else window.JOT_delayedEvents.push({eventName:c,eventSrc:a,payload:b})};window.JOT_delayedEvents=[];
window.JOT_fullyLoaded=!1;window.JOT_formatRelativeToNow=function(c,a){var b=((new Date).getTime()-c)/6E4;if(1440<=b||0>b)return null;var e=0;60<=b&&(b/=60,e=2);2<=b&&e++;return a?window.JOT_siteRelTimeStrs[e].replace(g,Math.floor(b)):window.JOT_userRelTimeStrs[e].replace(g,Math.floor(b))}; })()
</script>
<script>

  

  var breadcrumbs = [{"path":"/chromium-os","deleted":false,"title":"Chromium OS","dir":"ltr"},{"path":"/chromium-os/chromiumos-design-docs","deleted":false,"title":"Design Documents","dir":"ltr"},{"path":"/chromium-os/chromiumos-design-docs/autoupdate-details","deleted":false,"title":"Autoupdate Details","dir":"ltr"}];
  var JOT_clearDotPath = 'http://www.gstatic.com/sites/p/56e332/system/app/images/cleardot.gif';

  
  var JOT_userRelTimeStrs = ["a minute ago","__duration__ minutes ago","an hour ago","__duration__ hours ago"];

  
  

  

  var webspace = {"enableAnalytics":true,"pageSharingId":"jotspot_page","enableUniversalAnalytics":false,"sharingPolicy":"OPENED_WITH_INDICATOR","siteTitle":"The Chromium Projects","isStartPageEnabled":true,"adsensePublisherId":null,"features":{"languageSelectDefaultTextSetToDefault":true,"validateClientGvizDataSourceUrls":true,"moreMobileStyleImprovements":true,"newInsertMenuIcons":true,"accessibleSortingButtons":true,"domainAnalyticsInGAOnly":true,"noCaptcha":true,"fileCabinetScreenReaderFix":true,"updatedTosAndPrivacyLinks":null,"pageDrafts":false,"mobileOrientationFix":true,"plusBadge":false,"pdfEmbedSupport":false,"jsClickFix":true},"isPublic":true,"isConsumer":false,"serverFlags":{"cajaBaseUrl":"//www.gstatic.com/caja","cajaDebugMode":false},"onepickBaseUrl":"https://docs.google.com","domainAnalyticsAccountId":"","plusPageId":"","signInUrl":"https://www.google.com/a/SelectSession?continue\u003dhttp://sites.google.com/a/chromium.org/dev/chromium-os/chromiumos-design-docs/autoupdate-details\u0026service\u003djotspot","analyticsAccountId":"UA-5484340-1","scottyUrl":"/_/upload","homePath":"/","siteNoticeUrlEnabled":null,"plusPageUrl":"","adsensePromoClickedOrSiteIneligible":true,"csiReportUri":"http://csi.gstatic.com/csi","sharingId":"jotspot","termsUrl":"//www.google.com/intl/en/policies/terms/","gvizVersion":1,"editorResources":{"sitelayout":["http://www.gstatic.com/sites/p/56e332/system/app/css/sitelayouteditor.css"],"text":["http://www.gstatic.com/sites/p/56e332/system/js/codemirror.js","http://www.gstatic.com/sites/p/56e332/system/app/css/codemirror_css.css","http://www.gstatic.com/sites/p/56e332/system/js/trog_edit__en.js","http://www.gstatic.com/sites/p/56e332/system/app/css/trogedit.css","/_/rsrc/1441580320000/system/app/css/editor.css","http://www.gstatic.com/sites/p/56e332/system/app/css/codeeditor.css","/_/rsrc/1441580320000/system/app/css/camelot/editor-jfk-wlb.css"]},"sharingUrlPrefix":"/_/sharing","isAdsenseEnabled":true,"domain":"chromium.org","baseUri":"","name":"dev","siteTemplateId":false,"siteNoticeRevision":null,"siteNoticeUrlAddress":null,"siteNoticeMessage":null,"page":{"isRtlLocale":false,"canDeleteWebspace":null,"isPageDraft":null,"parentPath":"/chromium-os/chromiumos-design-docs","parentWuid":"wuid:gx:2eb69dd73ece341e","siteLocale":"en","timeZone":"America/Los_Angeles","type":"text","title":"Autoupdate Details","locale":"en","wuid":"wuid:gx:7a4ac85052269a9d","revision":6,"path":"/chromium-os/chromiumos-design-docs/autoupdate-details","isSiteRtlLocale":false,"pageInheritsPermissions":null,"name":"autoupdate-details","canChangePath":true,"state":"","properties":{},"bidiEnabled":false,"currentTemplate":{"path":"/system/app/pagetemplates/text","title":"Web Page"}},"canPublishScriptToAnyone":true,"user":{"keyboardShortcuts":true,"sessionIndex":"","guest_":true,"displayNameOrEmail":"guest","userName":"guest","uid":"","renderMobile":false,"domain":"","namespace":"","hasWriteAccess":false,"namespaceUser":false,"primaryEmail":"guest","hasAdminAccess":false},"gadgets":{"baseUri":"/system/app/pages/gadgets"}};
  webspace.page.breadcrumbs = breadcrumbs;

  
  var JOT_siteRelTimeStrs = ["a minute ago","__duration__ minutes ago","an hour ago","__duration__ hours ago"];

</script>
<script type="text/javascript">
                window.jstiming.load.tick('scl');
              </script>
<meta name="title" content="Autoupdate Details - The Chromium Projects" />
<meta itemprop="name" content="Autoupdate Details - The Chromium Projects" />
<meta property="og:title" content="Autoupdate Details - The Chromium Projects" />
<meta name="description" content="Home of the Chromium Open Source Project" />
<meta itemprop="description" content="Home of the Chromium Open Source Project" />
<meta id="meta-tag-description" property="og:description" content="Home of the Chromium Open Source Project" />
<style type="text/css">
</style>
<link rel="stylesheet" type="text/css" href="http://www.gstatic.com/sites/p/56e332/system/app/themes/beigeandblue/standard-css-beigeandblue-ltr-ltr.css" />
<link rel="stylesheet" type="text/css" href="http://www.chromium.org/_/rsrc/1441580320000/system/app/css/overlay.css?cb=beigeandblueundefineda100%25%25150goog-ws-leftthemedefaultstandard" />
<link rel="stylesheet" type="text/css" href="http://www.chromium.org/_/rsrc/1441580320000/system/app/css/camelot/allthemes-view.css" />
<!--[if IE]>
          <link rel="stylesheet" type="text/css" href="/system/app/css/camelot/allthemes%2die.css" />
        <![endif]-->
<title>Autoupdate Details - The Chromium Projects</title>
<meta itemprop="image" content="http://www.chromium.org/_/rsrc/1268692643085/chromium-os/chromiumos-design-docs/autoupdate-details/cycle_break.png" />
<meta property="og:image" content="http://www.chromium.org/_/rsrc/1268692643085/chromium-os/chromiumos-design-docs/autoupdate-details/cycle_break.png" />
<script type="text/javascript">
                window.jstiming.load.tick('cl');
              </script>
</head>
<body xmlns="http://www.google.com/ns/jotspot" id="body" class=" en            ">
<div id="sites-page-toolbar" class="sites-header-divider">
<div xmlns="http://www.w3.org/1999/xhtml" id="sites-status" class="sites-status" style="display:none;"><div id="sites-notice" class="sites-notice" role="status" aria-live="assertive"> </div></div>
</div>
<div id="sites-chrome-everything-scrollbar">
<div id="sites-chrome-everything" class="">
<div id="sites-chrome-page-wrapper" style="direction: ltr">
<div id="sites-chrome-page-wrapper-inside">
<div xmlns="http://www.w3.org/1999/xhtml" id="sites-chrome-header-wrapper" style="height:auto;">
<table id="sites-chrome-header" class="sites-layout-hbox" cellspacing="0" style="height:auto;">
<tr class="sites-header-primary-row" id="sites-chrome-userheader">
<td id="sites-header-title" class="" role="banner"><div class="sites-header-cell-buffer-wrapper"><a href="http://www.chromium.org/" id="sites-chrome-userheader-logo"><img id="logo-img-id" src="http://www.chromium.org/_/rsrc/1438879449147/config/customLogo.gif?revision=3" alt="The Chromium Projects" class="sites-logo  " /></a><h2><a href="http://www.chromium.org/" dir="ltr" id="sites-chrome-userheader-title">The Chromium Projects</a></h2></div></td><td class="sites-layout-searchbox  "><div class="sites-header-cell-buffer-wrapper"><form id="sites-searchbox-form" action="http://www.chromium.org/system/app/pages/search" role="search"><input type="hidden" id="sites-searchbox-scope" name="scope" value="search-site" /><input type="text" id="jot-ui-searchInput" name="q" size="20" value="" aria-label="Search this site" /><div id="sites-searchbox-button-set" class="goog-inline-block"><div role="button" id="sites-searchbox-search-button" class="goog-inline-block jfk-button jfk-button-standard" tabindex="0">Search this site</div></div></form></div></td>
</tr>
<tr class="sites-header-secondary-row" id="sites-chrome-horizontal-nav">
<td colspan="2" id="sites-chrome-header-horizontal-nav-container" role="navigation">
</td>
</tr>
</table>
</div>
<div id="sites-chrome-main-wrapper">
<div id="sites-chrome-main-wrapper-inside">
<table id="sites-chrome-main" class="sites-layout-hbox" cellspacing="0" cellpadding="{scmCellpadding}" border="0">
<tr>
<td id="sites-chrome-sidebar-left" class="sites-layout-sidebar-left initial" style="width:150px">
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_7648876402527094" class="sites-embed" role="navigation"><div class="sites-embed-content sites-sidebar-nav"><ul role="navigation" jotId="navList"><li class="nav-first "><div dir="ltr" style="padding-left: 5px;"><a href="http://www.chromium.org/chromium-projects" jotId="wuid:gx:10ae433dadbbab13" class="sites-navigation-link">Home</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="../../Home.html" jotId="wuid:gx:43582b9d2029d3af" class="sites-navigation-link">Chromium</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="../../chromium-os.html" jotId="wuid:gx:83df2ab1f8880ba" class="sites-navigation-link">Chromium OS</a></div></li></ul></div></div>
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_14720868319272995" class="sites-embed" role="navigation"><h4 class="sites-embed-title">Quick links</h4><div class="sites-embed-content sites-sidebar-nav"><ul role="navigation" jotId="navList"><li class="nav-first "><div dir="ltr" style="padding-left: 5px;"><a href="../../for-testers/bug-reporting-guidelines.html" class="sites-navigation-link">Report bugs</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="../../developers/discussion-groups.html" class="sites-navigation-link">Discuss</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="http://www.chromium.org/system/app/pages/sitemap/hierarchy" jotId="wuid:gx:4b58a9a350ad12f" class="sites-navigation-link">网站地图</a></div></li></ul></div></div>
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_19690813310444355" class="sites-embed" role="navigation"><h4 class="sites-embed-title">Other sites</h4><div class="sites-embed-content sites-sidebar-nav"><ul role="navigation" jotId="navList"><li class="nav-first "><div dir="ltr" style="padding-left: 5px;"><a href="http://blog.chromium.org/" class="sites-navigation-link">Chromium Blog</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="http://code.google.com/chrome/extensions/" class="sites-navigation-link">Google Chrome Extensions</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="https://developers.google.com/chrome/chrome-frame/" class="sites-navigation-link">Google Chrome Frame</a></div></li></ul></div></div>
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_19695218559354544" class="sites-embed" role="complementary"><h4 class="sites-embed-title"></h4><div class="sites-embed-content sites-embed-content-sidebar-textbox"><div dir="ltr"><span style="font-size:x-small">Except as otherwise </span><a href="http://developers.google.com/site-policies.html#restrictions"><span style="font-size:x-small">noted</span></a><span style="font-size:x-small">, the content of this page is licensed under a </span><a href="http://creativecommons.org/licenses/by/2.5/"><span style="font-size:x-small">Creative Commons Attribution 2.5 license</span></a><span style="font-size:x-small">, and examples are licensed under the </span><a href="http://src.chromium.org/viewvc/chrome/trunk/src/LICENSE" target="_blank"><span style="font-size:x-small">BSD License</span></a><span style="font-size:x-small">.<br /></span></div></div></div>
</td>
<td id="sites-canvas-wrapper">
<div id="sites-canvas" role="main">
<div id="goog-ws-editor-toolbar-container"> </div>
<div xmlns="http://www.w3.org/1999/xhtml" id="title-crumbs" style="">
<A href="../../chromium-os.html" dir="ltr">Chromium OS</A>‎ &gt; ‎<A href="../chromiumos-design-docs.html" dir="ltr">Design Documents</A>‎ &gt; ‎
  </div>
<h3 xmlns="http://www.w3.org/1999/xhtml" id="sites-page-title-header" style="" align="left">
<span id="sites-page-title" dir="ltr" tabindex="-1" style="outline: none">Autoupdate Details</span>
</h3>
<div id="sites-canvas-main" class="sites-canvas-main">
<div id="sites-canvas-main-content">
<table xmlns="http://www.w3.org/1999/xhtml" cellspacing="0" class="sites-layout-name-one-column sites-layout-hbox"><tbody><tr><td class="sites-layout-tile sites-tile-name-content-1"><div dir="ltr"><span style="border-collapse:separate;color:rgb(0,0,0);font-family:Times;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:normal;line-height:normal;text-indent:0px;text-transform:none;white-space:normal;word-spacing:0px;font-size:medium"><span style="font-family:Verdana;font-size:13px">
<h2 style="font-size:14pt"><a name="TOC-Abstract"></a>Abstract</h2>
<p style="margin:0px">This document describes details about how the 
autoupdate system works. For a high-level view of autoupdate, and 
information about the filesystem, see<span> </span><a href="http://dev.chromium.org/chromium-os/chromiumos-design-docs/filesystem-autoupdate" title="File System/Autoupdate">File System/Autoupdate</a>.<br />
</p>
<p style="margin:0px"><br />
</p>
<p style="margin:0px">The autoupdate 
system provides bit-for-bit-exact in-place filesystem updates with 
file-level binary diffs.<span> </span><br />
</p>
<h2 style="font-size:14pt"><a name="TOC-Goals"></a><b>Goals</b></h2>
<ul style="margin-top:0px;margin-bottom:0px"><li style="margin-top:0px;margin-bottom:0px">Updates should be as small
 as we can reasonably make them.</li>
<li style="margin-top:0px;margin-bottom:0px">An update must result in a root-filesystem 
partition in which each disk block is exactly (bit-for-bit) as specified
 by the OS vendor, so that the update can be signed on the server (for 
verified boot). <br />
</li>
<li style="margin-top:0px;margin-bottom:0px">Updates must be applied in place, so that many delta updates can 
be installed without rebooting. For example: if a user is booted into 
version N, and N+1 is released, the user downloads the (N→N+1) update 
and installs. If the user is still booted into N when N+2 comes out, 
then the user downloads the (N+1→N+2) update and in-place installs it 
over N+1.</li></ul>
<h2 style="font-size:14pt"><a name="TOC-Overview-of-the-install-procedure"></a><b>Overview of the 
install procedure</b></h2>
<div style="margin-top:0px;margin-bottom:0px">The client will have a partition (which we'll call the "install 
partition") on which to install a delta update. This partition will 
already contain some version of the operating system.<span> </span><br />
<br />
<div style="margin-top:0px;margin-bottom:0px">The client will contact 
the autoupdate server to request an update, specifying the version 
number of the system installed on the install partition. The server may 
provide the client with a delta update which the client will download.<span> </span><br />
 <br />
<div style="margin-top:0px;margin-bottom:0px">The delta update file 
contains an ordered list of operations to perform on the install 
partition that will take it from the existing version to the new 
version.
<h2 style="font-size:14pt"><a name="TOC-Overview-of-the-delta-update-file-format"></a><b>Overview of the delta update 
file format</b></h2>
<div style="margin-top:0px;margin-bottom:0px">Note:
 The destination partition is composed of 4K blocks.[1]<br />
 <br />
<div style="margin-top:0px;margin-bottom:0px">The update file is an 
ordered list of operations to perform. Each operation operates on 
specific blocks on the partition. For each operation, there may be an 
optional data blob, also included in the update file.<span> </span><br />
<br />
<div style="margin-top:0px;margin-bottom:0px">The types of install 
operations are:<br />
 <br />
<ul style="margin-top:0px;margin-bottom:0px"><li style="margin-top:0px;margin-bottom:0px">Copy: copy some blocks in 
the install partition to other blocks in the install partition. This can
 be used to move a block to a new location, or to copy a block to 
temporary storage; for more information, see the example below.<br />
<br />
</li>
<li style="margin-top:0px;margin-bottom:0px">Bsdiff: read some blocks 
into memory from the existing install partition, perform a patch (binary
 diff) using the attached data blob, and write the resulting updated 
blocks to specified blocks in the install partition. (See below for more
 details.)<span> </span><br />
<br />
</li>
<li style="margin-top:0px;margin-bottom:0px">Replace: write the attached data blob to specified 
blocks in the install partition.<br />
<br />
</li>
<li style="margin-top:0px;margin-bottom:0px">Replace_bz: B-unzip the attached data blob and 
write the result to specified blocks in the install partition.</li></ul>
<br />
<div style="margin-top:0px;margin-bottom:0px">A traditional diff update 
to a file (using bsdiff) works like this: the old file and the patch 
file are read into memory. Next, a patch operation is performed in 
memory, resulting in the new file being in memory. Finally, the new file
 is written to disk.<span> </span><br />
<br />
We modify that operation 
slightly. We tell the patch program that the old file is the install 
partition. However, rather than have the program read the entire 
partition into memory, we tell it which blocks to read. Then the patch 
operation is performed in memory. Finally, the result is written 
directly to the install partition, but not at the beginning of the 
device: we will tell the program which blocks to write the result to.
<h2 style="font-size:14pt"><a name="TOC-Generating-delta-update-files"></a><b>Generating delta update files</b></h2>
This 
section describes how the OS vender creates an update file.<br />
 <br />
<div style="margin-top:0px;margin-bottom:0px">The update file format 
will be:<br />
<br />
<ol style="margin-top:0px;margin-bottom:0px"><li style="margin-top:0px;margin-bottom:0px">Magic number ('CrAU')</li>
<li style="margin-top:0px;margin-bottom:0px">Version number</li>
<li style="margin-top:0px;margin-bottom:0px">Eight bytes for protobuf 
length </li>
<li style="margin-top:0px;margin-bottom:0px">The 
protobuf</li>
<li style="margin-top:0px;margin-bottom:0px">Collection
 of data blobs</li>
<li style="margin-top:0px;margin-bottom:0px">EOF</li>
</ol>
 <br />
<div style="margin-top:0px;margin-bottom:0px">The protobuf is a series 
of instructions that the client must perform in order.<span> </span><br />
<br />
<div style="margin-top:0px;margin-bottom:0px">Note: To specify a set of 
blocks, we use an extent, which is simply a contiguous range of disk 
blocks. For example, rather than specify blocks {10, 11, 12, 13, 14, 15,
 17, 18}, it can be simpler to specify { (10, 6), (17, 2) } (a list of 
extents).<span> </span><br />
 <br />
<pre style="font-family:Courier New;white-space:pre-wrap;margin:0px">message Manifest {<br />  message InstallOperation {<br />    enum CompressionType {</pre>
<pre style="font-family:Courier New;white-space:pre-wrap;margin:0px">      COPY = 0,  // file is unchanged; just move data blocks</pre>
<pre style="font-family:Courier New;white-space:pre-wrap;margin:0px">      BSDIFF = 1,  // Read source data blocks as old file, included binary blob is diff, output to new blocks</pre>
<pre style="font-family:Courier New;white-space:pre-wrap;margin:0px">      REPLACE = 2,  // Output included binary blob to new blocks</pre>
<pre style="font-family:Courier New;white-space:pre-wrap;margin:0px">      REPLACE_BZ = 3  // Bunzip binary blob into new blocks</pre>
<pre style="font-family:Courier New;white-space:pre-wrap;margin:0px">    }</pre>
<pre style="font-family:Courier New;white-space:pre-wrap;margin:0px">    uint64 blob_offset;  // if present, the offset in the update image of the binary blob for this file</pre>
<pre style="font-family:Courier New;white-space:pre-wrap;margin:0px">    uint64 blob_length;  // if present, the length of the binary blob</pre>
<pre style="font-family:Courier New;white-space:pre-wrap;margin:0px">    message extent {</pre>
<pre style="font-family:Courier New;white-space:pre-wrap;margin:0px">      uint64 offset;  // in blocksize</pre>
<pre style="font-family:Courier New;white-space:pre-wrap;margin:0px">      uint64 length;  // in blocksize</pre>
<pre style="font-family:Courier New;white-space:pre-wrap;margin:0px">    }</pre>
<pre style="font-family:Courier New;white-space:pre-wrap;margin:0px">    repeated extent input_extents;</pre>
<pre style="font-family:Courier New;white-space:pre-wrap;margin:0px">    repeated extent output_extents;</pre>
<pre style="font-family:Courier New;white-space:pre-wrap;margin:0px">  }<br />  repeated InstallOperation install_operations;<br />}<br /></pre>
<br />
<div style="margin-top:0px;margin-bottom:0px">To generate a delta 
update, we iterate over each regular file on the new filesystem. We get 
an ordered list of all datablocks in the file, then store those in a 
File struct:<br />
 <br />
<pre style="font-family:Courier New;white-space:pre-wrap;margin:0px">struct Extent {<br />  uint64 start;<br />  uint64 length;<br />}<br /><br />struct File {<br />  string path;  // path within the filesystem<br />  vector&lt;Extent&gt; dst_extents;  // ordered list of all extents on the new filesystem<br />  vector&lt;Extent&gt; src_extents;  // Applies only for COPY and BSDIFF<br />  enum CompressionType; // one of: COPY, BSDIFF, REPLACE, REPLACE_BZ<br />}<br /></pre>
<br />
<div style="margin-top:0px;margin-bottom:0px">Note: eventually, each 
File object will be converted into an InstallOperation message in the 
protobuf.<span> </span><br />
<br />
For each file, we look for the optimal 
way to compress it. If the file has changed, then we compare the sizes 
of the binary-diff, uncompressed, and bzip options, and we pick 
whichever yields the smallest file size.<br />
<br />
<div style="margin-top:0px;margin-bottom:0px">We then create a vertex in a graph for each 
File object. Alongside the graph, we also create a vector to represent 
each block in the install partition:<br />
 <br />
<pre style="font-family:Courier New;white-space:pre-wrap;margin:0px">struct Block {<br />  File* reader;<br />  File* writer;<br />}<br /><br />vector&lt;Block&gt; blocks;  // length is the size of the install partition<br /></pre>
<br />
<div style="margin-top:0px;margin-bottom:0px">We then go 
through each block in each File object. For each block, we set the 
reader and writer parameters of the blocks vector.<br />
 <br />
<div style="margin-top:0px;margin-bottom:0px">Next, we iterate through 
the blocks array, and for each block with a different reader and writer 
(which are both non-null), we create an edge in the graph from the 
writer to the reader. An edge in the (directed) graph points to a file 
operation that must complete before the edge's source file operation 
starts. Thus, we are trying to ensure that if a block is both read and 
written by different file operations, the block is read before it's 
written. The edge represents blocks in the graph, so the edge's weight 
is the number of blocks.<br />
 <br />
<div style="margin-top:0px;margin-bottom:0px">At this point, we are likely to have a graph with 
cycles. We must break the cycles. We find the cycles with Johnson's 
circuit finding agorithm (<a href="http://dutta.csc.ncsu.edu/csc791_spring07/wrap/circuits_johnson.pdf" target="_blank" title="PDF">PDF</a>) and Tarjan's strongly connected 
components agorithm. For each cycle, we find the lowest-weight edge and 
cut it[2]. We cut an edge as follows: create a new node that represents 
an operation of copying some extents to scratch space. We then make the 
edge's source node point to the new node. We also modify the cut edge's 
destination node to read from the scratch space rather than from the 
blocks represented by the edge we're cutting.<br />
 <br />
<div style="margin-top:0px;margin-bottom:0px">Here's an example of 
cutting an edge to break a cycle. Operation A reads block 3 to write 
block 4. Operation B reads block 4 to write block 10.<span> </span><br />
<br />
<div style="display:block;text-align:left"><a href="autoupdate-details/cycle_break.png%3Fattredirects=0" imageanchor="1"><img border="0" src="../../_/rsrc/1268692643085/chromium-os/chromiumos-design-docs/autoupdate-details/cycle_break.png" /></a></div>
<br />
<br />
<br />
<span style="border-collapse:separate;color:rgb(0,0,0);font-family:Times;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:normal;line-height:normal;text-indent:0px;text-transform:none;white-space:normal;word-spacing:0px;font-size:medium"><span style="font-family:Verdana;font-size:13px">
<div style="margin-top:0px;margin-bottom:0px">Once the cycles are broken, we can use a 
topological sort to order all the nodes. Then we convert each node to an
 InstallOperation and add it to the Manifest structure. If the client 
were to download and install the Manifest at this point, all the blocks 
that contain filedata would be set correctly.<br />
<br />
However, we also 
need non-filedata blocks to be set correctly. To handle non-filedata 
blocks, we create a single final InstallOperation of type REPLACE_BZ 
which writes to all extents that don't contain filedata. The attached 
data blob contains the bzip2-compressed data to go into those blocks. In
 practice, this takes up about 2 megabytes compressed.<font size="3"><br />
</font></div>
<h2 style="font-size:14pt"><a name="TOC-Example"></a><b>Example</b></h2>
</span></span>
<div style="display:block;text-align:left"><a href="autoupdate-details/example.png%3Fattredirects=0" imageanchor="1"><img border="0" src="../../_/rsrc/1268692655838/chromium-os/chromiumos-design-docs/autoupdate-details/example.png" /></a></div>
<br />
<span style="border-collapse:separate;color:rgb(0,0,0);font-family:Times;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:normal;line-height:normal;text-indent:0px;text-transform:none;white-space:normal;word-spacing:0px;font-size:medium"><span style="font-family:Verdana;font-size:13px">
<h2 style="font-size:14pt"><a name="TOC-Streaming"></a><b>Streaming</b></h2>
<div style="margin-top:0px;margin-bottom:0px">Because the protobuf 
(which lists all operations) occurs at the beginning of the file, the 
update doesn't need to be saved to disk. It can be applied while 
streaming from the server.<br />
 <br />
<div style="margin-top:0px;margin-bottom:0px">We do need to make sure that the update is signed 
by the OS vendor. We can begin to apply the update and not mark it 
bootable until after the delta update signature is verified.
<h2 style="font-size:14pt"><a name="TOC-Alternatives-considered"></a><b>Alternatives considered</b></h2>
The solution
 presented here is not the only one we considered, but it is the only 
one we've found that gives the best compression ratio in practice. Other
 solutions considered were:</div>
<br />
<ul style="margin-top:0px;margin-bottom:0px"><li style="margin-top:0px;margin-bottom:0px">Delta-compress
 the entire partition<br />
<br />
Bsdiff can't delta-compress the entire 
partition because its memory requirements are too high. During patching,
 it needs enough memory to store the original and new files, which in 
our case could have been over 1 gigabyte.<br />
<br />
However, another delta 
compression program, Xdelta, uses a sliding window. In practice, this 
resulted in poor compression. On a test corpus, the diff was hundreds of
 megabytes.<br />
<br />
</li></ul>
<ul style="margin-top:0px;margin-bottom:0px"><li style="margin-top:0px;margin-bottom:0px">rdiff<br />
<br />
Rdiff
 works by storing only changed blocks in the delta file. It uses a 
sliding window so that blocks don't need to be aligned. When pointed at 
the testing corpus, an rdiff delta of the entire partition was 104M, 
well above the roughly 10M the proposed algorithm takes for the same 
corpus.<br />
<br />
In the future, we might consider using rdiff-style (that 
is, rsync-style) delta compression at the file level. We could drop that
 in alongside bsdiff in the future.<br />
</li></ul>
<h2 style="font-size:14pt"><a name="TOC-Footnotes"></a><b>Footnotes</b></h2>
[1] Some of these blocks contain file-data 
and some contain other data (metadata, for example). Since we are using 
ext4, which (at the time of writing) doesn't support fragments, we know 
that a block cannot contain file data for more than one file: a block 
either contains file data for one file or no files.<br />
<br />
[2] In our 
tests, with the greedy agorithm (cut an edge in each cycle as it's 
found), we cut about 28 MB worth of edges, which seems reasonable. 
Enumerating all cycles and cutting no edges, we found over 
5,000,000,000,000,000 cycles, so it's absolutely infeasible to consider 
all cycles before making cuts. To cut cycles more efficiently, though, 
we might consider more than 1 cycle before making cuts (perhaps 1000 
cycles or so).<br />
</div>
</span></span><br />
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</span></span></div></td></tr></tbody></table>
</div> 
</div> 
<div id="sites-canvas-bottom-panel">
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_page-subpages"> </div>
<div id="sites-attachments-container">
</div>
<a xmlns="http://www.w3.org/1999/xhtml" name="page-comments"></a>
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_page-comments"><div class="sites-comment-docos-wrapper"><div class="sites-comment-docos"><div class="sites-comment-docos-background"></div><div class="sites-comment-docos-header"><div class="sites-comment-docos-header-title">Comments</div></div><div id="sites-comment-docos-pane" class="sites-comment-docos-pane"></div></div></div></div>
</div>
</div> 
</td> 
</tr>
</table> 
</div> 
</div> 
<div id="sites-chrome-footer-wrapper">
<div id="sites-chrome-footer-wrapper-inside">
<div id="sites-chrome-footer">
</div>
</div>
</div>
</div> 
</div> 
<div id="sites-chrome-adminfooter-container">
<div xmlns="http://www.w3.org/1999/xhtml" class="sites-adminfooter" role="navigation"><p><a class="sites-system-link" href="https://www.google.com/a/UniversalLogin?service=jotspot&amp;continue=http://sites.google.com/a/chromium.org/dev/chromium-os/chromiumos-design-docs/autoupdate-details">Sign in</a><span aria-hidden="true">|</span><a class="sites-system-link" href="http://www.chromium.org/system/app/pages/recentChanges">Recent Site Activity</a><span aria-hidden="true">|</span><a class="sites-system-link" href="http://www.chromium.org/system/app/pages/reportAbuse" target="_blank">Report Abuse</a><span aria-hidden="true">|</span><a class="sites-system-link" href="javascript:;" onclick="window.open(webspace.printUrl)">Print Page</a><span aria-hidden="true">|</span><span class="sites-system-link">Powered By</span> <b class="powered-by"><a href="http://sites.google.com">Google Sites</a></b></p></div>
</div>
</div> 
</div> 
<div id="sites-chrome-onebar-footer">
</div>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
    window.jstiming.load.tick('sjl');
  </script>
<script xmlns="http://www.w3.org/1999/xhtml" src="http://www.gstatic.com/sites/p/56e332/system/js/jot_min_view__en.js"></script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
    window.jstiming.load.tick('jl');
  </script>
<script xmlns="http://www.w3.org/1999/xhtml">
      
          sites.core.Analytics.createTracker();
          sites.core.Analytics.trackPageview();
        
    </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
                    sites.Searchbox.initialize(
                        'sites-searchbox-search-button',
                        {"object":[]}['object'],
                        'search-site',
                        {"label":"Configure search options...","url":"/system/app/pages/admin/settings"});
                  </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
      gsites.HoverPopupMenu.createSiteDropdownMenus('sites-header-nav-dropdown', false);
    </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript" defer="true">
            JOT_setupNav("7648876402527094", "Navigation", false);
            JOT_addListener('titleChange', 'JOT_NAVIGATION_titleChange', 'COMP_7648876402527094');
          </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript" defer="true">
            JOT_setupNav("14720868319272995", "Quick links", false);
            JOT_addListener('titleChange', 'JOT_NAVIGATION_titleChange', 'COMP_14720868319272995');
          </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript" defer="true">
            JOT_setupNav("19690813310444355", "Other sites", false);
            JOT_addListener('titleChange', 'JOT_NAVIGATION_titleChange', 'COMP_19690813310444355');
          </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
              new sites.CommentPane('//docs.google.com/comments/d/AAHRpnXvrAwjAfmld0ObrebBiGRq9gEIVWCKtkzQIsFJWPWfyMOjG1EvXVujZ5Xr4nn9dC-kN1Gk8w7qK0niIz775w8_qfbESMn1U07y-2m_wNT2Q0qS_1tLl8CGmYxx3_a_O-IxPmGmg/api/js?anon=true',
                  false, false);
            </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
  setTimeout(function() {
    var fingerprint = gsites.date.TimeZone.getFingerprint([]);
    gsites.Xhr.send('http://www.chromium.org/_/tz', null, null, 'GET', null, null, { afjstz: fingerprint });
  }, 500);
</script>
<script xmlns="http://www.w3.org/1999/xhtml">
                    window.onload = function() {
                      if (false) {
                        JOT_setMobilePreview();
                      }
                      var loadTimer = window.jstiming.load;
                      loadTimer.tick("ol");
                      loadTimer["name"] = "load," + webspace.page.type + ",user_page";
                      window.jstiming.report(loadTimer, {}, 'http://csi.gstatic.com/csi');
                    }
                  </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
        JOT_insertAnalyticsCode(false,
            false);
      </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
    var maestroRunner = new gsites.pages.view.SitesMaestroRunner(
        webspace, "en");
    maestroRunner.initListeners();
    maestroRunner.installEditRender();
  </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript" defer="true">
  //<![CDATA[
    // Decorate any fastUI buttons on the page with a class of 'goog-button'.
    if (webspace.user.hasWriteAccess) {
      JOT_decorateButtons();
    }

    // Fires delayed events.
    (function() {
      JOT_fullyLoaded = true;
      var delayedEvents = JOT_delayedEvents;
      for (var x = 0; x < delayedEvents.length; x++) {
        var event = delayedEvents[x];
        JOT_postEvent(event.eventName, event.eventSrc, event.payload);
      }
      JOT_delayedEvents = null;
      JOT_postEvent('pageLoaded');
    })();
  //]]>
</script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
    JOT_postEvent('decorateGvizCharts');
  </script>
<script type="text/javascript">
          JOT_setupPostRenderingManager();
        </script>
<script type="text/javascript">
          JOT_postEvent('renderPlus', null, 'sites-chrome-main');
        </script>
<div id="server-timer-div" style="display:none"> </div>
<script type="text/javascript">
          window.jstiming.load.tick('render');
          JOT_postEvent('usercontentrendered', this);
        </script>
</body>
</html>
