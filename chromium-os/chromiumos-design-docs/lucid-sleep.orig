<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/WebPage">
<head>
<meta http-equiv="X-UA-Compatible" content="chrome=1" />
<script type="text/javascript">/* Copyright 2008 Google. */ (function() { var e="wtsrt_",g="tbsd_",h="tbnd_",k="start",l="_wtsrt",m="_tbnd",n="CSI/";(function(){function f(a){this.t={};this.tick=function(a,c,b){this.t[a]=[void 0!=b?b:(new Date).getTime(),c];if(void 0==b)try{window.console.timeStamp(n+a)}catch(d){}};this.tick(k,null,a)}var a;window.performance&&(a=window.performance.timing);var p=a?new f(a.responseStart):new f;window.jstiming={Timer:f,load:p};if(a){var c=a.navigationStart,d=a.responseStart;0<c&&d>=c&&(window.jstiming.srt=d-c)}if(a){var b=window.jstiming.load;0<c&&d>=c&&(b.tick(l,void 0,c),b.tick(e,l,d),b.tick(g,e))}try{a=null,
window.chrome&&window.chrome.csi&&(a=Math.floor(window.chrome.csi().pageT),b&&0<c&&(b.tick(m,void 0,window.chrome.csi().startE),b.tick(h,m,c))),null==a&&window.gtbExternal&&(a=window.gtbExternal.pageT()),null==a&&window.external&&(a=window.external.pageT,b&&0<c&&(b.tick(m,void 0,window.external.startE),b.tick(h,m,c))),a&&(window.jstiming.pt=a)}catch(q){}})(); })()
</script>
<link rel="shortcut icon" href="/_/rsrc/1354323194313/favicon.ico" type="image/x-icon" />
<link rel="apple-touch-icon" href="https://ssl.gstatic.com/sites/p/56e332/system/app/images/apple-touch-icon.png" type="image/png" />
<script type="text/javascript">/* Copyright 2008 Google. */ (function() { var d="",g="__duration__",h="function";function k(c){return document.getElementById(c)}window.byId=k;function l(c){return c.replace(/^\s+|\s+$/g,d)}window.trim=l;var m=[],n=0;window.JOT_addListener=function(c,a,b){var e=new String(n++);c={eventName:c,handler:a,compId:b,key:e};m.push(c);return e};window.JOT_removeListenerByKey=function(c){for(var a=0;a<m.length;a++)if(m[a].key==c){m.splice(a,1);break}};
window.JOT_removeAllListenersForName=function(c){for(var a=0;a<m.length;a++)m[a].eventName==c&&m.splice(a,1)};window.JOT_postEvent=function(c,a,b){var e={eventName:c,eventSrc:a||{},payload:b||{}};if(window.JOT_fullyLoaded)for(a=m.length,b=0;b<a&&b<m.length;b++){var f=m[b];f&&f.eventName==c&&(e.listenerCompId=f.compId||d,(f=typeof f.handler==h?f.handler:window[f.handler])&&f(e))}else window.JOT_delayedEvents.push({eventName:c,eventSrc:a,payload:b})};window.JOT_delayedEvents=[];
window.JOT_fullyLoaded=!1;window.JOT_formatRelativeToNow=function(c,a){var b=((new Date).getTime()-c)/6E4;if(1440<=b||0>b)return null;var e=0;60<=b&&(b/=60,e=2);2<=b&&e++;return a?window.JOT_siteRelTimeStrs[e].replace(g,Math.floor(b)):window.JOT_userRelTimeStrs[e].replace(g,Math.floor(b))}; })()
</script>
<script>

  

  var breadcrumbs = [{"path":"/chromium-os","deleted":false,"title":"Chromium OS","dir":"ltr"},{"path":"/chromium-os/chromiumos-design-docs","deleted":false,"title":"Design Documents","dir":"ltr"},{"path":"/chromium-os/chromiumos-design-docs/lucid-sleep","deleted":false,"title":"Lucid Sleep","dir":"ltr"}];
  var JOT_clearDotPath = 'https://ssl.gstatic.com/sites/p/56e332/system/app/images/cleardot.gif';

  
  var JOT_userRelTimeStrs = ["a minute ago","__duration__ minutes ago","an hour ago","__duration__ hours ago"];

  
  

  

  var webspace = {"enableAnalytics":true,"pageSharingId":"jotspot_page","enableUniversalAnalytics":false,"sharingPolicy":"OPENED_WITH_INDICATOR","siteTitle":"The Chromium Projects","isStartPageEnabled":true,"adsensePublisherId":null,"features":{"languageSelectDefaultTextSetToDefault":true,"validateClientGvizDataSourceUrls":true,"moreMobileStyleImprovements":true,"newInsertMenuIcons":true,"accessibleSortingButtons":true,"domainAnalyticsInGAOnly":true,"noCaptcha":true,"fileCabinetScreenReaderFix":true,"updatedTosAndPrivacyLinks":null,"pageDrafts":false,"mobileOrientationFix":true,"plusBadge":false,"pdfEmbedSupport":false,"jsClickFix":true},"isPublic":true,"isConsumer":false,"serverFlags":{"cajaBaseUrl":"//www.gstatic.com/caja","cajaDebugMode":false},"onepickBaseUrl":"https://docs.google.com","domainAnalyticsAccountId":"","plusPageId":"","signInUrl":"https://www.google.com/a/SelectSession?continue\u003dhttps://sites.google.com/a/chromium.org/dev/chromium-os/chromiumos-design-docs/lucid-sleep\u0026service\u003djotspot","analyticsAccountId":"UA-5484340-1","scottyUrl":"/_/upload","homePath":"/","siteNoticeUrlEnabled":null,"plusPageUrl":"","adsensePromoClickedOrSiteIneligible":true,"csiReportUri":"https://gg.google.com/csi","sharingId":"jotspot","termsUrl":"//www.google.com/intl/en/policies/terms/","gvizVersion":1,"editorResources":{"sitelayout":["https://ssl.gstatic.com/sites/p/56e332/system/app/css/sitelayouteditor.css"],"text":["https://ssl.gstatic.com/sites/p/56e332/system/js/codemirror.js","https://ssl.gstatic.com/sites/p/56e332/system/app/css/codemirror_css.css","https://ssl.gstatic.com/sites/p/56e332/system/js/trog_edit__en.js","https://ssl.gstatic.com/sites/p/56e332/system/app/css/trogedit.css","/_/rsrc/1441580320000/system/app/css/editor.css","https://ssl.gstatic.com/sites/p/56e332/system/app/css/codeeditor.css","/_/rsrc/1441580320000/system/app/css/camelot/editor-jfk-wlb.css"]},"sharingUrlPrefix":"/_/sharing","isAdsenseEnabled":true,"domain":"chromium.org","baseUri":"","name":"dev","siteTemplateId":false,"siteNoticeRevision":null,"siteNoticeUrlAddress":null,"siteNoticeMessage":null,"page":{"isRtlLocale":false,"canDeleteWebspace":null,"isPageDraft":null,"parentPath":"/chromium-os/chromiumos-design-docs","parentWuid":"wuid:gx:2eb69dd73ece341e","siteLocale":"en","timeZone":"America/Los_Angeles","type":"text","title":"Lucid Sleep","locale":"en","wuid":"wuid:gx:37d5b8859fd8b1ef","revision":4,"path":"/chromium-os/chromiumos-design-docs/lucid-sleep","isSiteRtlLocale":false,"pageInheritsPermissions":null,"name":"lucid-sleep","canChangePath":true,"state":"","properties":{},"bidiEnabled":false,"currentTemplate":{"path":"/system/app/pagetemplates/text","title":"Web Page"}},"canPublishScriptToAnyone":true,"user":{"keyboardShortcuts":true,"sessionIndex":"","guest_":true,"displayNameOrEmail":"guest","userName":"guest","uid":"","renderMobile":false,"domain":"","namespace":"","hasWriteAccess":false,"namespaceUser":false,"primaryEmail":"guest","hasAdminAccess":false},"gadgets":{"baseUri":"/system/app/pages/gadgets"}};
  webspace.page.breadcrumbs = breadcrumbs;

  
  var JOT_siteRelTimeStrs = ["a minute ago","__duration__ minutes ago","an hour ago","__duration__ hours ago"];

</script>
<script type="text/javascript">
                window.jstiming.load.tick('scl');
              </script>
<meta name="title" content="Lucid Sleep - The Chromium Projects" />
<meta itemprop="name" content="Lucid Sleep - The Chromium Projects" />
<meta property="og:title" content="Lucid Sleep - The Chromium Projects" />
<meta name="description" content="Home of the Chromium Open Source Project" />
<meta itemprop="description" content="Home of the Chromium Open Source Project" />
<meta id="meta-tag-description" property="og:description" content="Home of the Chromium Open Source Project" />
<style type="text/css">
</style>
<link rel="stylesheet" type="text/css" href="https://ssl.gstatic.com/sites/p/56e332/system/app/themes/beigeandblue/standard-css-beigeandblue-ltr-ltr.css" />
<link rel="stylesheet" type="text/css" href="/_/rsrc/1441580320000/system/app/css/overlay.css?cb=beigeandblueundefineda100%25%25150goog-ws-leftthemedefaultstandard" />
<link rel="stylesheet" type="text/css" href="/_/rsrc/1441580320000/system/app/css/camelot/allthemes-view.css" />
<!--[if IE]>
          <link rel="stylesheet" type="text/css" href="/system/app/css/camelot/allthemes%2die.css" />
        <![endif]-->
<title>Lucid Sleep - The Chromium Projects</title>
<meta itemprop="image" content="/_/rsrc/1438879449147/config/customLogo.gif?revision=3" />
<meta property="og:image" content="/_/rsrc/1438879449147/config/customLogo.gif?revision=3" />
<script type="text/javascript">
                window.jstiming.load.tick('cl');
              </script>
</head>
<body xmlns="http://www.google.com/ns/jotspot" id="body" class=" en            ">
<div id="sites-page-toolbar" class="sites-header-divider">
<div xmlns="http://www.w3.org/1999/xhtml" id="sites-status" class="sites-status" style="display:none;"><div id="sites-notice" class="sites-notice" role="status" aria-live="assertive"> </div></div>
</div>
<div id="sites-chrome-everything-scrollbar">
<div id="sites-chrome-everything" class="">
<div id="sites-chrome-page-wrapper" style="direction: ltr">
<div id="sites-chrome-page-wrapper-inside">
<div xmlns="http://www.w3.org/1999/xhtml" id="sites-chrome-header-wrapper" style="height:auto;">
<table id="sites-chrome-header" class="sites-layout-hbox" cellspacing="0" style="height:auto;">
<tr class="sites-header-primary-row" id="sites-chrome-userheader">
<td id="sites-header-title" class="" role="banner"><div class="sites-header-cell-buffer-wrapper"><a href="https://www.chromium.org/" id="sites-chrome-userheader-logo"><img id="logo-img-id" src="/_/rsrc/1438879449147/config/customLogo.gif?revision=3" alt="The Chromium Projects" class="sites-logo  " /></a><h2><a href="https://www.chromium.org/" dir="ltr" id="sites-chrome-userheader-title">The Chromium Projects</a></h2></div></td><td class="sites-layout-searchbox  "><div class="sites-header-cell-buffer-wrapper"><form id="sites-searchbox-form" action="/system/app/pages/search" role="search"><input type="hidden" id="sites-searchbox-scope" name="scope" value="search-site" /><input type="text" id="jot-ui-searchInput" name="q" size="20" value="" aria-label="Search this site" /><div id="sites-searchbox-button-set" class="goog-inline-block"><div role="button" id="sites-searchbox-search-button" class="goog-inline-block jfk-button jfk-button-standard" tabindex="0">Search this site</div></div></form></div></td>
</tr>
<tr class="sites-header-secondary-row" id="sites-chrome-horizontal-nav">
<td colspan="2" id="sites-chrome-header-horizontal-nav-container" role="navigation">
</td>
</tr>
</table>
</div>
<div id="sites-chrome-main-wrapper">
<div id="sites-chrome-main-wrapper-inside">
<table id="sites-chrome-main" class="sites-layout-hbox" cellspacing="0" cellpadding="{scmCellpadding}" border="0">
<tr>
<td id="sites-chrome-sidebar-left" class="sites-layout-sidebar-left initial" style="width:150px">
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_7648876402527094" class="sites-embed" role="navigation"><div class="sites-embed-content sites-sidebar-nav"><ul role="navigation" jotId="navList"><li class="nav-first "><div dir="ltr" style="padding-left: 5px;"><a href="/chromium-projects" jotId="wuid:gx:10ae433dadbbab13" class="sites-navigation-link">Home</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="/Home" jotId="wuid:gx:43582b9d2029d3af" class="sites-navigation-link">Chromium</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="/chromium-os" jotId="wuid:gx:83df2ab1f8880ba" class="sites-navigation-link">Chromium OS</a></div></li></ul></div></div>
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_14720868319272995" class="sites-embed" role="navigation"><h4 class="sites-embed-title">Quick links</h4><div class="sites-embed-content sites-sidebar-nav"><ul role="navigation" jotId="navList"><li class="nav-first "><div dir="ltr" style="padding-left: 5px;"><a href="http://www.chromium.org/for-testers/bug-reporting-guidelines" class="sites-navigation-link">Report bugs</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="http://www.chromium.org/developers/discussion-groups" class="sites-navigation-link">Discuss</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="/system/app/pages/sitemap/hierarchy" jotId="wuid:gx:571d8fbd499df20e" class="sites-navigation-link">Sitemap</a></div></li></ul></div></div>
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_19690813310444355" class="sites-embed" role="navigation"><h4 class="sites-embed-title">Other sites</h4><div class="sites-embed-content sites-sidebar-nav"><ul role="navigation" jotId="navList"><li class="nav-first "><div dir="ltr" style="padding-left: 5px;"><a href="http://blog.chromium.org/" class="sites-navigation-link">Chromium Blog</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="http://code.google.com/chrome/extensions/" class="sites-navigation-link">Google Chrome Extensions</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="https://developers.google.com/chrome/chrome-frame/" class="sites-navigation-link">Google Chrome Frame</a></div></li></ul></div></div>
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_19695218559354544" class="sites-embed" role="complementary"><h4 class="sites-embed-title"></h4><div class="sites-embed-content sites-embed-content-sidebar-textbox"><div dir="ltr"><span style="font-size:x-small">Except as otherwise </span><a href="http://developers.google.com/site-policies.html#restrictions"><span style="font-size:x-small">noted</span></a><span style="font-size:x-small">, the content of this page is licensed under a </span><a href="http://creativecommons.org/licenses/by/2.5/"><span style="font-size:x-small">Creative Commons Attribution 2.5 license</span></a><span style="font-size:x-small">, and examples are licensed under the </span><a href="http://src.chromium.org/viewvc/chrome/trunk/src/LICENSE" target="_blank"><span style="font-size:x-small">BSD License</span></a><span style="font-size:x-small">.<br /></span></div></div></div>
</td>
<td id="sites-canvas-wrapper">
<div id="sites-canvas" role="main">
<div id="goog-ws-editor-toolbar-container"> </div>
<div xmlns="http://www.w3.org/1999/xhtml" id="title-crumbs" style="">
<A href="/chromium-os" dir="ltr">Chromium OS</A>‎ &gt; ‎<A href="/chromium-os/chromiumos-design-docs" dir="ltr">Design Documents</A>‎ &gt; ‎
  </div>
<h3 xmlns="http://www.w3.org/1999/xhtml" id="sites-page-title-header" style="" align="left">
<span id="sites-page-title" dir="ltr" tabindex="-1" style="outline: none">Lucid Sleep</span>
</h3>
<div id="sites-canvas-main" class="sites-canvas-main">
<div id="sites-canvas-main-content">
<table xmlns="http://www.w3.org/1999/xhtml" cellspacing="0" class="sites-layout-name-one-column sites-layout-hbox"><tbody><tr><td class="sites-layout-tile sites-tile-name-content-1"><div dir="ltr"><div><div class="sites-embed-align-right-wrapping-on"><div class="sites-embed-border-off sites-embed" style="width:350px;"><div class="sites-embed-content sites-embed-type-toc"><div class="goog-toc sites-embed-toc-maxdepth-6"><p>Contents</p><ol class="goog-toc"><li class="goog-toc"><a href="#TOC-Overview"><strong>1 </strong>Overview</a></li><li class="goog-toc"><a href="#TOC-Kernel"><strong>2 </strong>Kernel</a></li><li class="goog-toc"><a href="#TOC-Power-Manager"><strong>3 </strong>Power Manager</a><ol class="goog-toc"><li class="goog-toc"><a href="#TOC-Handling-user-activity"><strong>3.1 </strong>Handling user activity</a></li></ol></li><li class="goog-toc"><a href="#TOC-Shill"><strong>4 </strong>Shill</a></li><li class="goog-toc"><a href="#TOC-Chrome"><strong>5 </strong>Chrome</a><ol class="goog-toc"><li class="goog-toc"><a href="#TOC-Freezing-Renderers"><strong>5.1 </strong>Freezing Renderers</a><ol class="goog-toc"><li class="goog-toc"><a href="#TOC-Properly-handling-the-lock-screen"><strong>5.1.1 </strong>Properly handling the lock screen</a></li><li class="goog-toc"><a href="#TOC-Dealing-with-renderers-that-may-receive-push-messages"><strong>5.1.2 </strong>Dealing with renderers that may receive push messages</a></li></ol></li><li class="goog-toc"><a href="#TOC-Interacting-with-the-GPU-process"><strong>5.2 </strong>Interacting with the GPU process</a></li></ol></li></ol></div></div></div></div></div><h1><a name="TOC-Overview"></a>Overview</h1>
<p>Some recent Chrome devices have the ability to wake up from a suspended state
to perform work. Potential tasks include:</p>
<ul>
<li> Associating with a known WiFi access point that has just come into range
  </li><li> Updating user data in response to a received push message
  </li><li> Synchronizing with app servers at the request of an app
  </li><li> Performing system maintenance like trimming SSDs or checking the battery level
</li></ul>
<p>To minimize power consumption while performing tasks and external indications
the device is performing work, the device uses a hybrid power state called
Lucid Sleep. Effectively using this state requires coordination between all
parts of the system, from the kernel to the system daemons to the Chrome
browser.  </p>
<p>This page describes the interactions between the system components to
coordinate Lucid Sleep. It is intended to help with firmware and kernel
implementations and troubleshooting of this feature on Chrome devices that
support it.</p>
<h1><a name="TOC-Kernel"></a>Kernel</h1>
<p>When a Chrome device is suspending, the kernel performs the following steps:</p>
<ol>
<li> Userspace processes are frozen. Every userspace process is removed from the
scheduler’s run queue and no more CPU cycles are allocated.
  </li><li> Select kernel threads are frozen, depending on the device. Exactly which
threads are frozen depends on the hardware configuration; in some cases, no
kernel threads are frozen.
  </li><li> Hardware components are suspended, for example the display panel is turned off,
the hard drive is stopped, and USB ports are powered down.
  </li><li> All non-boot CPUs are disabled.
  </li><li> The kernel programs the underlying hardware with a list of interrupt sources
that are allowed to wake up the system, for example the keyboard or power
button.
  </li><li> The kernel puts the boot CPU into a low-power state so that no code is running
on that CPU.
</li></ol>
<p>Resuming a Chrome device is essentially the reverse of the suspend sequence:</p>
<ol>
<li> The hardware determines that a wakeup event has occurred and delivers an
interrupt to the boot CPU.
  </li><li> The boot CPU starts running the kernel code.
  </li><li> Non-boot CPUs are re-enabled.
  </li><li> Hardware components are resumed.
  </li><li> Any frozen kernel threads are thawed.
  </li><li> Userspace processes are thawed and the system resumes normal activity.
</li></ol>
<p>To support Lucid Sleep, the kernel allows userspace to expand the list of
interrupt sources that can trigger wakeup events. It is also possible to
specify sources that trigger Lucid Sleep versus a full system resume. Hardware
components that can trigger wakeup events must run independently in a low-power
state without kernel support. Conversely, kernel drivers for components that do
not trigger wakeup events must not re-initialize the hardware during Lucid
Sleep.</p>
<p>For example, a device receives a push message over the network. The power
manager adds the Network Interface Card (NIC) to the list of hardware
components that can trigger a wakeup interrupt. It also adds the display panel
and USB ports to the list of components that must not re-initialize during
Lucid Sleep. At suspend time the NIC driver puts the NIC into a low-power state
rather than turning it off. Other suspend operations proceed as normal.</p>
<p>After a wakeup event is triggered and before hardware components are resumed,
the kernel determines if the wakeup event should trigger Lucid Sleep or a full
resume and saves this value. When the hardware components are resumed, the
device drivers query the kernel to determine whether the wakeup is for Lucid
Sleep. If so, and userspace has requested that that hardware remain off, the
driver skips the remainder of re-initialization steps. After userspace
processes thaw, a process can also query the kernel via the sysfs interface to
determine if the wakeup event triggered Lucid Sleep.</p>
<h1><a name="TOC-Power-Manager"></a>Power Manager</h1>
<p>The power manager provides a mechanism for notifying the system daemons and
Chrome when the device is in Lucid Sleep. This mirrors the mechanism used
for notifying the system daemons when the Chrome device is about to suspend. A
process can register with the power manager on start up. When the system enters
Lucid Sleep, the power manager notifies registered processes by sending out a
DarkSuspendImminent D-Bus signal. This signal is the only external indication
that the system is in Lucid Sleep. </p>
<p>When a device enters Lucid Sleep, the power manager also detects that the
wakeup event was not user-triggered and it should suspend the device again as
soon as possible. The DarkSuspendImminent signal both announces Lucid Sleep and
signals that suspension is imminent.</p>
<p>When a suspend operation successfully completes (and userspace processes have
been thawed by the kernel), the power manager queries the kernel to see if the
current resume operation is from Lucid Sleep. If so, it sends out a
DarkSuspendImminent signal and waits for all applications that have registered
to receive the signal to report on readiness to suspend. After all registered
applications have reported readiness or the maximum delay has passed, the power
manager again instructs the kernel to suspend the system.</p>
<h2><a name="TOC-Handling-user-activity"></a>Handling user activity</h2>
<p>Occasionally, a user may start to interact with the Chrome device while it is
in the middle of Lucid Sleep. To ensure that all hardware components are
properly resumed, in this case the power manager instructs the kernel to
perform a test suspend. The normal suspend sequence is interrupted after
suspending hardware components, and the kernel immediately jumps to the step of
resuming hardware components in the resume sequence. This ensures that all
hardware components are ready before the user starts interacting with the
system.</p>
<h1><a name="TOC-Shill"></a>Shill</h1>
<p>Shill, the connection manager, decides what WiFi-related actions—such as
programming the wireless NIC and setting RTC timers—to take before the system
goes into suspend, when the system wakes up in Lucid Sleep, and when the system
fully resumes. The primary goals of these actions are to maintain WiFi
connectivity while the system is suspended or in Lucid Sleep and to allow the
system to respond to important events (e.g. GCM push notifications).</p>
<p>Before the system suspends from a fully awake or Lucid Sleep state, shill
verifies whether the system’s WiFi interface is connected to a network. If the
system is connected, shill programs the wireless NIC to wake the system if the
NIC disconnects from that network, and starts an RTC timer to wake the system
in Lucid Sleep to renew its IPv4 DHCP lease (or obtain a new IPv6
configuration) when it is about to expire. If the system is not connected,
shill programs the wireless NIC to independently perform periodic scans while
the system is suspended, and wake the system if any of its preferred networks
are found. If the number of preferred networks is greater than the NIC
whitelist capacity, a separate RTC wake timer is started to wake the system in
Lucid Sleep to perform shill-initiated scans. Shill also programs the wireless
NIC to wake the system upon receiving packets from whitelisted IP addresses
registered by Chrome (more details in next section).</p>
<p>When the system wakes up in Lucid Sleep, shill receives a wakeup reason from
the kernel. If the reason is a disconnect or detection of a preferred network,
shill triggers a passive scan and attempts to establish a connection to any
networks found. If the reason is the receipt of a packet from a whitelisted IP
address (i.e. a GCM push notification), shill does nothing and allows Chrome to
handle the packet. For any other reason, including the aforementioned RTC
timers, shill either renews DHCP leases if the system is already connected, or
performs a scan and if the system is not connected, attempts to establish a
connection.</p>
<p>When the system fully resumes, shill deprograms all wake on WiFi triggers on
the wireless NIC, and stops any RTC timers that shill might have started before
suspend or during Lucid Sleep. Shill will then scan for networks if the system
wakes up not connected, and will resume its normal functionality thereafter.</p>
<h1><a name="TOC-Chrome"></a>Chrome</h1>
<p>The Chrome browser software handles push messages that arrive over the network.
It registers with the power manager so that the power manager will wait for it
to report readiness before suspending from Lucid Sleep. The progress of all
push messages is tracked from arrival to completion. If Chrome receives a
DarkSuspendImminent signal while one or more push messages are active, it waits
until no more active push messages remain before informing the power manager
that it is ready to suspend. Additionally, any network requests started by a
message consumer during processing can further delay Chrome before it reports
readiness to the power manager.</p>
<p>Chrome also tells the NIC which connections to watch for incoming messages.
Currently, connections to Google Cloud Messaging (GCM) servers are supported.
After Chrome establishes a connection to the GCM server, it informs the NIC of
its IP address. While the system is suspended the NIC continues listening for
network activity and when a packet arrives from the IP address of the GCM
server, the NIC sends an interrupt to the boot CPU to wake the system into
Lucid Sleep.</p>
<p>To maintain a connection with the GCM servers, Chrome sends a heartbeat message
to the server at regular intervals. A specialized timer (the <a href="https://code.google.com/p/chromium/codesearch#chromium/src/components/timers/alarm_timer_chromeos.h">AlarmTimer</a>) is used to set a Real Time Clock (RTC) alarm. The RTC is a hardware timer
that runs even while the system is suspended and sends an interrupt to the boot
CPU to wake the system into Lucid Sleep.</p>
<h2><a name="TOC-Freezing-Renderers"></a>Freezing Renderers</h2>
<p>If improperly handled, frequently waking up the system can consume a
significant amount of battery resources. In addition to conserving power by not
resuming power-hungry components like the display panel, while in Lucid Sleep
Chrome minimizes its usage of the CPU.</p>
<p>Chrome has a multi-process architecture (for more details see <a href="http://www.chromium.org/developers/design-documents/multi-process-architecture">here</a>.) All apps, extensions, and web pages run inside renderer processes, which
represent the biggest consumers of the CPU in the system. To minimize the power
they consume (for example by running the CPU at a high load), Chrome freezes
renderer processes at the initial suspend time and thaws them only after a full
resume. </p>
<p>The Linux kernel mechanism of control groups (<a href="https://www.kernel.org/doc/Documentation/cgroups/cgroups.txt">cgroups</a>) is used. Freezing processes in a cgroup works the same way as freezing
userspace processes at suspend time: the kernel simply removes the processes
from the scheduler’s run queue. Since Chrome freezes its renderer processes
before the system suspends, those processes remain frozen even after the system
resumes and are thawed only when Chrome explicitly thaws them. Processes stay
frozen for the duration of Lucid Sleep and CPU load is minimized.</p>
<h3><a name="TOC-Properly-handling-the-lock-screen"></a>Properly handling the lock screen</h3>
<p>Either users or an enterprise policy can set a Chrome preference that locks the
screen when the system suspends. Like most parts of the system user interface,
the lock screen runs inside a renderer process. Common side effects of freezing
the lock screen operation include a noticeable lag when the system fully
resumes and dropped keystrokes. In some cases, users may need to re-type their
passwords.</p>
<p>To address this, the lock screen renderer is given special treatment. If a user
requests locking  the screen when the system suspends, Chrome puts the lock
screen renderer process in a separate cgroup from the other renderers. The lock
screen renderer remains unfrozen and responsive when the system fully resumes.</p>
<h3><a name="TOC-Dealing-with-renderers-that-may-receive-push-messages"></a>Dealing with renderers that may receive push messages</h3>
<p>Since all web applications as well as Chrome apps and extensions run inside a
renderer, a push message cannot be fully handled if the destination renderer
has no CPU cycles. So some renderers do need to remain active during Lucid
Sleep.</p>
<p>Chrome decides whether or not to freeze a renderer
process when the renderer is first spawned. For example, for Chrome apps and
extensions, Chrome looks at the permissions that the app/extension has
requested in its manifest. If it has requested the “gcm” permission, Chrome
keeps the renderer out of the group of renderers to freeze at suspend time.
This ensures that when a push message arrives it can be handled as quickly as
possible.</p>
<h2><a name="TOC-Interacting-with-the-GPU-process"></a>Interacting with the GPU process</h2>
<p>Chrome uses a dedicated process to interact with the GPU on the system. This
process is not frozen during Lucid Sleep and can continue to respond to
requests to render objects to the screen. Though the renderers themselves may
be frozen and unable to make requests to the GPU process, the main browser
process remains active and can issue updates.</p>
<p>This has implications for the display panel component, which is off during
Lucid Sleep. Any attempts by the GPU process to update the contents of the
screen result in errors, causing loss of context and forced reallocation of
resources. In addition to affecting GPU performance, repeatedly losing and
allocating a context (often multiple times per second) add a significant load
to the CPU, increasing the amount of power consumed during Lucid Sleep and
reducing the system’s overall battery life.</p>
<p>To avoid consuming unnecessary resources, Chrome stops its compositor from
updating the screen and prevents rendering requests from reaching the GPU
process. If the user has configured the screen to lock when the system
suspends, Chrome waits until the contents of the lock screen are visible before
directing the compositor to stop rendering. The delay allows the contents of
the user’s screen to remain invisible and secure when the system resumes.</p>
<br /></div></td></tr></tbody></table>
</div> 
</div> 
<div id="sites-canvas-bottom-panel">
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_page-subpages"> </div>
<div id="sites-attachments-container">
</div>
<a xmlns="http://www.w3.org/1999/xhtml" name="page-comments"></a>
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_page-comments"><div class="sites-comment-docos-wrapper"><div class="sites-comment-docos"><div class="sites-comment-docos-background"></div><div class="sites-comment-docos-header"><div class="sites-comment-docos-header-title">Comments</div></div><div id="sites-comment-docos-pane" class="sites-comment-docos-pane"></div></div></div></div>
</div>
</div> 
</td> 
</tr>
</table> 
</div> 
</div> 
<div id="sites-chrome-footer-wrapper">
<div id="sites-chrome-footer-wrapper-inside">
<div id="sites-chrome-footer">
</div>
</div>
</div>
</div> 
</div> 
<div id="sites-chrome-adminfooter-container">
<div xmlns="http://www.w3.org/1999/xhtml" class="sites-adminfooter" role="navigation"><p><a class="sites-system-link" href="https://www.google.com/a/UniversalLogin?service=jotspot&amp;continue=https://sites.google.com/a/chromium.org/dev/chromium-os/chromiumos-design-docs/lucid-sleep">Sign in</a><span aria-hidden="true">|</span><a class="sites-system-link" href="/system/app/pages/recentChanges">Recent Site Activity</a><span aria-hidden="true">|</span><a class="sites-system-link" href="/system/app/pages/reportAbuse" target="_blank">Report Abuse</a><span aria-hidden="true">|</span><a class="sites-system-link" href="javascript:;" onclick="window.open(webspace.printUrl)">Print Page</a><span aria-hidden="true">|</span><span class="sites-system-link">Powered By</span> <b class="powered-by"><a href="http://sites.google.com">Google Sites</a></b></p></div>
</div>
</div> 
</div> 
<div id="sites-chrome-onebar-footer">
</div>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
    window.jstiming.load.tick('sjl');
  </script>
<script xmlns="http://www.w3.org/1999/xhtml" src="https://ssl.gstatic.com/sites/p/56e332/system/js/jot_min_view__en.js"></script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
    window.jstiming.load.tick('jl');
  </script>
<script xmlns="http://www.w3.org/1999/xhtml">
      
          sites.core.Analytics.createTracker();
          sites.core.Analytics.trackPageview();
        
    </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
                    sites.Searchbox.initialize(
                        'sites-searchbox-search-button',
                        {"object":[]}['object'],
                        'search-site',
                        {"label":"Configure search options...","url":"/system/app/pages/admin/settings"});
                  </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
      gsites.HoverPopupMenu.createSiteDropdownMenus('sites-header-nav-dropdown', false);
    </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript" defer="true">
            JOT_setupNav("7648876402527094", "Navigation", false);
            JOT_addListener('titleChange', 'JOT_NAVIGATION_titleChange', 'COMP_7648876402527094');
          </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript" defer="true">
            JOT_setupNav("14720868319272995", "Quick links", false);
            JOT_addListener('titleChange', 'JOT_NAVIGATION_titleChange', 'COMP_14720868319272995');
          </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript" defer="true">
            JOT_setupNav("19690813310444355", "Other sites", false);
            JOT_addListener('titleChange', 'JOT_NAVIGATION_titleChange', 'COMP_19690813310444355');
          </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
              new sites.CommentPane('//docs.google.com/comments/d/AAHRpnXvrAwjAfmld0ObrebBiGRq9YrjQruOI_QM5o0Uh-GN9XwmT3AmHzUBrqHM542m06o9dn-1kQZIreYcv9fVeUc0OmqNm9Pm4jBOHYpvC78a60K1OY2dVLRfhtdcJlm1W3-KxfAAw/api/js?anon=true',
                  false, false);
            </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
  setTimeout(function() {
    var fingerprint = gsites.date.TimeZone.getFingerprint([]);
    gsites.Xhr.send('https://www.chromium.org/_/tz', null, null, 'GET', null, null, { afjstz: fingerprint });
  }, 500);
</script>
<script xmlns="http://www.w3.org/1999/xhtml">
                    window.onload = function() {
                      if (false) {
                        JOT_setMobilePreview();
                      }
                      var loadTimer = window.jstiming.load;
                      loadTimer.tick("ol");
                      loadTimer["name"] = "load," + webspace.page.type + ",user_page";
                      window.jstiming.report(loadTimer, {}, 'https://gg.google.com/csi');
                    }
                  </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
        JOT_insertAnalyticsCode(false,
            false);
      </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
    var maestroRunner = new gsites.pages.view.SitesMaestroRunner(
        webspace, "en");
    maestroRunner.initListeners();
    maestroRunner.installEditRender();
  </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript" defer="true">
  //<![CDATA[
    // Decorate any fastUI buttons on the page with a class of 'goog-button'.
    if (webspace.user.hasWriteAccess) {
      JOT_decorateButtons();
    }

    // Fires delayed events.
    (function() {
      JOT_fullyLoaded = true;
      var delayedEvents = JOT_delayedEvents;
      for (var x = 0; x < delayedEvents.length; x++) {
        var event = delayedEvents[x];
        JOT_postEvent(event.eventName, event.eventSrc, event.payload);
      }
      JOT_delayedEvents = null;
      JOT_postEvent('pageLoaded');
    })();
  //]]>
</script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
    JOT_postEvent('decorateGvizCharts');
  </script>
<script type="text/javascript">
          JOT_setupPostRenderingManager();
        </script>
<script type="text/javascript">
          JOT_postEvent('renderPlus', null, 'sites-chrome-main');
        </script>
<div id="server-timer-div" style="display:none"> </div>
<script type="text/javascript">
          window.jstiming.load.tick('render');
          JOT_postEvent('usercontentrendered', this);
        </script>
</body>
</html>
