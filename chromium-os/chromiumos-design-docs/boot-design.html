<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/WebPage">
<head>
<meta http-equiv="X-UA-Compatible" content="chrome=1" />
<script type="text/javascript">/* Copyright 2008 Google. */ (function() { var e="wtsrt_",g="tbsd_",h="tbnd_",k="start",l="_wtsrt",m="_tbnd",n="CSI/";(function(){function f(a){this.t={};this.tick=function(a,c,b){this.t[a]=[void 0!=b?b:(new Date).getTime(),c];if(void 0==b)try{window.console.timeStamp(n+a)}catch(d){}};this.tick(k,null,a)}var a;window.performance&&(a=window.performance.timing);var p=a?new f(a.responseStart):new f;window.jstiming={Timer:f,load:p};if(a){var c=a.navigationStart,d=a.responseStart;0<c&&d>=c&&(window.jstiming.srt=d-c)}if(a){var b=window.jstiming.load;0<c&&d>=c&&(b.tick(l,void 0,c),b.tick(e,l,d),b.tick(g,e))}try{a=null,
window.chrome&&window.chrome.csi&&(a=Math.floor(window.chrome.csi().pageT),b&&0<c&&(b.tick(m,void 0,window.chrome.csi().startE),b.tick(h,m,c))),null==a&&window.gtbExternal&&(a=window.gtbExternal.pageT()),null==a&&window.external&&(a=window.external.pageT,b&&0<c&&(b.tick(m,void 0,window.external.startE),b.tick(h,m,c))),a&&(window.jstiming.pt=a)}catch(q){}})(); })()
</script>
<link rel="shortcut icon" href="http://www.chromium.org/_/rsrc/1354323194313/favicon.ico" type="image/x-icon" />
<link rel="apple-touch-icon" href="http://www.gstatic.com/sites/p/56e332/system/app/images/apple-touch-icon.png" type="image/png" />
<script type="text/javascript">/* Copyright 2008 Google. */ (function() { var d="",g="__duration__",h="function";function k(c){return document.getElementById(c)}window.byId=k;function l(c){return c.replace(/^\s+|\s+$/g,d)}window.trim=l;var m=[],n=0;window.JOT_addListener=function(c,a,b){var e=new String(n++);c={eventName:c,handler:a,compId:b,key:e};m.push(c);return e};window.JOT_removeListenerByKey=function(c){for(var a=0;a<m.length;a++)if(m[a].key==c){m.splice(a,1);break}};
window.JOT_removeAllListenersForName=function(c){for(var a=0;a<m.length;a++)m[a].eventName==c&&m.splice(a,1)};window.JOT_postEvent=function(c,a,b){var e={eventName:c,eventSrc:a||{},payload:b||{}};if(window.JOT_fullyLoaded)for(a=m.length,b=0;b<a&&b<m.length;b++){var f=m[b];f&&f.eventName==c&&(e.listenerCompId=f.compId||d,(f=typeof f.handler==h?f.handler:window[f.handler])&&f(e))}else window.JOT_delayedEvents.push({eventName:c,eventSrc:a,payload:b})};window.JOT_delayedEvents=[];
window.JOT_fullyLoaded=!1;window.JOT_formatRelativeToNow=function(c,a){var b=((new Date).getTime()-c)/6E4;if(1440<=b||0>b)return null;var e=0;60<=b&&(b/=60,e=2);2<=b&&e++;return a?window.JOT_siteRelTimeStrs[e].replace(g,Math.floor(b)):window.JOT_userRelTimeStrs[e].replace(g,Math.floor(b))}; })()
</script>
<script>

  

  var breadcrumbs = [{"path":"/chromium-os","deleted":false,"title":"Chromium OS","dir":"ltr"},{"path":"/chromium-os/chromiumos-design-docs","deleted":false,"title":"Design Documents","dir":"ltr"},{"path":"/chromium-os/chromiumos-design-docs/boot-design","deleted":false,"title":"Chrome OS User-Land Boot Design","dir":"ltr"}];
  var JOT_clearDotPath = 'http://www.gstatic.com/sites/p/56e332/system/app/images/cleardot.gif';

  
  var JOT_userRelTimeStrs = ["a minute ago","__duration__ minutes ago","an hour ago","__duration__ hours ago"];

  
  

  

  var webspace = {"enableAnalytics":true,"pageSharingId":"jotspot_page","enableUniversalAnalytics":false,"sharingPolicy":"OPENED_WITH_INDICATOR","siteTitle":"The Chromium Projects","isStartPageEnabled":true,"adsensePublisherId":null,"features":{"languageSelectDefaultTextSetToDefault":true,"validateClientGvizDataSourceUrls":true,"moreMobileStyleImprovements":true,"newInsertMenuIcons":true,"accessibleSortingButtons":true,"domainAnalyticsInGAOnly":true,"noCaptcha":true,"fileCabinetScreenReaderFix":true,"updatedTosAndPrivacyLinks":null,"pageDrafts":false,"mobileOrientationFix":true,"plusBadge":false,"pdfEmbedSupport":false,"jsClickFix":true},"isPublic":true,"isConsumer":false,"serverFlags":{"cajaBaseUrl":"//www.gstatic.com/caja","cajaDebugMode":false},"onepickBaseUrl":"https://docs.google.com","domainAnalyticsAccountId":"","plusPageId":"","signInUrl":"https://www.google.com/a/SelectSession?continue\u003dhttp://sites.google.com/a/chromium.org/dev/chromium-os/chromiumos-design-docs/boot-design\u0026service\u003djotspot","analyticsAccountId":"UA-5484340-1","scottyUrl":"/_/upload","homePath":"/","siteNoticeUrlEnabled":null,"plusPageUrl":"","adsensePromoClickedOrSiteIneligible":true,"csiReportUri":"http://csi.gstatic.com/csi","sharingId":"jotspot","termsUrl":"//www.google.com/intl/en/policies/terms/","gvizVersion":1,"editorResources":{"sitelayout":["http://www.gstatic.com/sites/p/56e332/system/app/css/sitelayouteditor.css"],"text":["http://www.gstatic.com/sites/p/56e332/system/js/codemirror.js","http://www.gstatic.com/sites/p/56e332/system/app/css/codemirror_css.css","http://www.gstatic.com/sites/p/56e332/system/js/trog_edit__en.js","http://www.gstatic.com/sites/p/56e332/system/app/css/trogedit.css","/_/rsrc/1441580320000/system/app/css/editor.css","http://www.gstatic.com/sites/p/56e332/system/app/css/codeeditor.css","/_/rsrc/1441580320000/system/app/css/camelot/editor-jfk-wlb.css"]},"sharingUrlPrefix":"/_/sharing","isAdsenseEnabled":true,"domain":"chromium.org","baseUri":"","name":"dev","siteTemplateId":false,"siteNoticeRevision":null,"siteNoticeUrlAddress":null,"siteNoticeMessage":null,"page":{"isRtlLocale":false,"canDeleteWebspace":null,"isPageDraft":null,"parentPath":"/chromium-os/chromiumos-design-docs","parentWuid":"wuid:gx:2eb69dd73ece341e","siteLocale":"en","timeZone":"America/Los_Angeles","type":"text","title":"Chrome OS User-Land Boot Design","locale":"en","wuid":"wuid:gx:7e66d79b2f58823d","revision":10,"path":"/chromium-os/chromiumos-design-docs/boot-design","isSiteRtlLocale":false,"pageInheritsPermissions":null,"name":"boot-design","canChangePath":true,"state":"","properties":{},"bidiEnabled":false,"currentTemplate":{"path":"/system/app/pagetemplates/text","title":"Web Page"}},"canPublishScriptToAnyone":true,"user":{"keyboardShortcuts":true,"sessionIndex":"","guest_":true,"displayNameOrEmail":"guest","userName":"guest","uid":"","renderMobile":false,"domain":"","namespace":"","hasWriteAccess":false,"namespaceUser":false,"primaryEmail":"guest","hasAdminAccess":false},"gadgets":{"baseUri":"/system/app/pages/gadgets"}};
  webspace.page.breadcrumbs = breadcrumbs;

  
  var JOT_siteRelTimeStrs = ["a minute ago","__duration__ minutes ago","an hour ago","__duration__ hours ago"];

</script>
<script type="text/javascript">
                window.jstiming.load.tick('scl');
              </script>
<meta name="title" content="Chrome OS User-Land Boot Design - The Chromium Projects" />
<meta itemprop="name" content="Chrome OS User-Land Boot Design - The Chromium Projects" />
<meta property="og:title" content="Chrome OS User-Land Boot Design - The Chromium Projects" />
<meta name="description" content="Home of the Chromium Open Source Project" />
<meta itemprop="description" content="Home of the Chromium Open Source Project" />
<meta id="meta-tag-description" property="og:description" content="Home of the Chromium Open Source Project" />
<style type="text/css">
</style>
<link rel="stylesheet" type="text/css" href="http://www.gstatic.com/sites/p/56e332/system/app/themes/beigeandblue/standard-css-beigeandblue-ltr-ltr.css" />
<link rel="stylesheet" type="text/css" href="http://www.chromium.org/_/rsrc/1441580320000/system/app/css/overlay.css?cb=beigeandblueundefineda100%25%25150goog-ws-leftthemedefaultstandard" />
<link rel="stylesheet" type="text/css" href="http://www.chromium.org/_/rsrc/1441580320000/system/app/css/camelot/allthemes-view.css" />
<!--[if IE]>
          <link rel="stylesheet" type="text/css" href="/system/app/css/camelot/allthemes%2die.css" />
        <![endif]-->
<title>Chrome OS User-Land Boot Design - The Chromium Projects</title>
<meta itemprop="image" content="http://www.chromium.org/_/rsrc/1418437692177/chromium-os/chromiumos-design-docs/boot-design/boot_design_diagram.png" />
<meta property="og:image" content="http://www.chromium.org/_/rsrc/1418437692177/chromium-os/chromiumos-design-docs/boot-design/boot_design_diagram.png" />
<script type="text/javascript">
                window.jstiming.load.tick('cl');
              </script>
</head>
<body xmlns="http://www.google.com/ns/jotspot" id="body" class=" en            ">
<div id="sites-page-toolbar" class="sites-header-divider">
<div xmlns="http://www.w3.org/1999/xhtml" id="sites-status" class="sites-status" style="display:none;"><div id="sites-notice" class="sites-notice" role="status" aria-live="assertive"> </div></div>
</div>
<div id="sites-chrome-everything-scrollbar">
<div id="sites-chrome-everything" class="">
<div id="sites-chrome-page-wrapper" style="direction: ltr">
<div id="sites-chrome-page-wrapper-inside">
<div xmlns="http://www.w3.org/1999/xhtml" id="sites-chrome-header-wrapper" style="height:auto;">
<table id="sites-chrome-header" class="sites-layout-hbox" cellspacing="0" style="height:auto;">
<tr class="sites-header-primary-row" id="sites-chrome-userheader">
<td id="sites-header-title" class="" role="banner"><div class="sites-header-cell-buffer-wrapper"><a href="http://www.chromium.org/" id="sites-chrome-userheader-logo"><img id="logo-img-id" src="http://www.chromium.org/_/rsrc/1438879449147/config/customLogo.gif?revision=3" alt="The Chromium Projects" class="sites-logo  " /></a><h2><a href="http://www.chromium.org/" dir="ltr" id="sites-chrome-userheader-title">The Chromium Projects</a></h2></div></td><td class="sites-layout-searchbox  "><div class="sites-header-cell-buffer-wrapper"><form id="sites-searchbox-form" action="http://www.chromium.org/system/app/pages/search" role="search"><input type="hidden" id="sites-searchbox-scope" name="scope" value="search-site" /><input type="text" id="jot-ui-searchInput" name="q" size="20" value="" aria-label="Search this site" /><div id="sites-searchbox-button-set" class="goog-inline-block"><div role="button" id="sites-searchbox-search-button" class="goog-inline-block jfk-button jfk-button-standard" tabindex="0">Search this site</div></div></form></div></td>
</tr>
<tr class="sites-header-secondary-row" id="sites-chrome-horizontal-nav">
<td colspan="2" id="sites-chrome-header-horizontal-nav-container" role="navigation">
</td>
</tr>
</table>
</div>
<div id="sites-chrome-main-wrapper">
<div id="sites-chrome-main-wrapper-inside">
<table id="sites-chrome-main" class="sites-layout-hbox" cellspacing="0" cellpadding="{scmCellpadding}" border="0">
<tr>
<td id="sites-chrome-sidebar-left" class="sites-layout-sidebar-left initial" style="width:150px">
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_7648876402527094" class="sites-embed" role="navigation"><div class="sites-embed-content sites-sidebar-nav"><ul role="navigation" jotId="navList"><li class="nav-first "><div dir="ltr" style="padding-left: 5px;"><a href="http://www.chromium.org/chromium-projects" jotId="wuid:gx:10ae433dadbbab13" class="sites-navigation-link">Home</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="../../Home.html" jotId="wuid:gx:43582b9d2029d3af" class="sites-navigation-link">Chromium</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="../../chromium-os.html" jotId="wuid:gx:83df2ab1f8880ba" class="sites-navigation-link">Chromium OS</a></div></li></ul></div></div>
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_14720868319272995" class="sites-embed" role="navigation"><h4 class="sites-embed-title">Quick links</h4><div class="sites-embed-content sites-sidebar-nav"><ul role="navigation" jotId="navList"><li class="nav-first "><div dir="ltr" style="padding-left: 5px;"><a href="../../for-testers/bug-reporting-guidelines.html" class="sites-navigation-link">Report bugs</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="../../developers/discussion-groups.html" class="sites-navigation-link">Discuss</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="http://www.chromium.org/system/app/pages/sitemap/hierarchy" jotId="wuid:gx:4b58a9a350ad12f" class="sites-navigation-link">网站地图</a></div></li></ul></div></div>
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_19690813310444355" class="sites-embed" role="navigation"><h4 class="sites-embed-title">Other sites</h4><div class="sites-embed-content sites-sidebar-nav"><ul role="navigation" jotId="navList"><li class="nav-first "><div dir="ltr" style="padding-left: 5px;"><a href="http://blog.chromium.org/" class="sites-navigation-link">Chromium Blog</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="http://code.google.com/chrome/extensions/" class="sites-navigation-link">Google Chrome Extensions</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="https://developers.google.com/chrome/chrome-frame/" class="sites-navigation-link">Google Chrome Frame</a></div></li></ul></div></div>
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_19695218559354544" class="sites-embed" role="complementary"><h4 class="sites-embed-title"></h4><div class="sites-embed-content sites-embed-content-sidebar-textbox"><div dir="ltr"><span style="font-size:x-small">Except as otherwise </span><a href="http://developers.google.com/site-policies.html#restrictions"><span style="font-size:x-small">noted</span></a><span style="font-size:x-small">, the content of this page is licensed under a </span><a href="http://creativecommons.org/licenses/by/2.5/"><span style="font-size:x-small">Creative Commons Attribution 2.5 license</span></a><span style="font-size:x-small">, and examples are licensed under the </span><a href="http://src.chromium.org/viewvc/chrome/trunk/src/LICENSE" target="_blank"><span style="font-size:x-small">BSD License</span></a><span style="font-size:x-small">.<br /></span></div></div></div>
</td>
<td id="sites-canvas-wrapper">
<div id="sites-canvas" role="main">
<div id="goog-ws-editor-toolbar-container"> </div>
<div xmlns="http://www.w3.org/1999/xhtml" id="title-crumbs" style="">
<A href="../../chromium-os.html" dir="ltr">Chromium OS</A>‎ &gt; ‎<A href="../chromiumos-design-docs.html" dir="ltr">Design Documents</A>‎ &gt; ‎
  </div>
<h3 xmlns="http://www.w3.org/1999/xhtml" id="sites-page-title-header" style="" align="left">
<span id="sites-page-title" dir="ltr" tabindex="-1" style="outline: none">Chrome OS User-Land Boot Design</span>
</h3>
<div id="sites-canvas-main" class="sites-canvas-main">
<div id="sites-canvas-main-content">
<table xmlns="http://www.w3.org/1999/xhtml" cellspacing="0" class="sites-layout-name-one-column sites-layout-hbox"><tbody><tr><td class="sites-layout-tile sites-tile-name-content-1"><div dir="ltr"><div></div><div><div class="sites-embed-align-left-wrapping-off"><div class="sites-embed-border-off sites-embed sites-embed-full-width" style="width:100%;"><div class="sites-embed-content sites-embed-type-toc"><div class="goog-toc sites-embed-toc-maxdepth-6"><p>Contents</p><ol class="goog-toc"><li class="goog-toc"><a href="boot-design.html#TOC-Introduction"><strong>1 </strong>Introduction</a><ol class="goog-toc"><li class="goog-toc"><a href="boot-design.html#TOC-Summary-of-Boot-Flow"><strong>1.1 </strong>Summary of Boot Flow</a><ol class="goog-toc"><li class="goog-toc"><a href="boot-design.html#TOC-Phases-of-Boot"><strong>1.1.1 </strong>Phases of Boot</a></li><li class="goog-toc"><a href="boot-design.html#TOC-Basic-Services-Startup"><strong>1.1.2 </strong>Basic Services Startup</a></li><li class="goog-toc"><a href="boot-design.html#TOC-System-Application-Startup"><strong>1.1.3 </strong>System Application Startup</a></li><li class="goog-toc"><a href="boot-design.html#TOC-System-Services-Startup"><strong>1.1.4 </strong>System Services Startup</a></li></ol></li><li class="goog-toc"><a href="boot-design.html#TOC-Filesystem-Initialization-and-Layout"><strong>1.2 </strong>Filesystem Initialization and Layout</a><ol class="goog-toc"><li class="goog-toc"><a href="boot-design.html#TOC-Creating-the-Stateful-File-System-the-chromeos_startup-script-"><strong>1.2.1 </strong>Creating the Stateful File System (the chromeos_startup script)</a></li><li class="goog-toc"><a href="boot-design.html#TOC-Encrypted-Stateful"><strong>1.2.2 </strong>Encrypted Stateful</a></li></ol></li><li class="goog-toc"><a href="boot-design.html#TOC-Special-Boot-Flows"><strong>1.3 </strong>Special Boot Flows</a><ol class="goog-toc"><li class="goog-toc"><a href="boot-design.html#TOC-Boot-Alert-Messages"><strong>1.3.1 </strong>Boot Alert Messages</a></li><li class="goog-toc"><a href="boot-design.html#TOC-Stateful-Wipe-a.k.a.-Powerwash-"><strong>1.3.2 </strong>Stateful Wipe (a.k.a. “Powerwash”)</a></li></ol></li><li class="goog-toc"><a href="boot-design.html#TOC-Interactions-with-Install-Recovery-and-Update"><strong>1.4 </strong>Interactions with Install, Recovery, and Update</a><ol class="goog-toc"><li class="goog-toc"><a href="boot-design.html#TOC-Rollback-Protection-After-Update"><strong>1.4.1 </strong>Rollback Protection After Update</a></li><li class="goog-toc"><a href="boot-design.html#TOC-Installation-and-Recovery"><strong>1.4.2 </strong>Installation and Recovery</a></li><li class="goog-toc"><a href="boot-design.html#TOC-Stateful-Update-and-Install"><strong>1.4.3 </strong>Stateful Update and Install</a></li></ol></li><li class="goog-toc"><a href="boot-design.html#TOC-Chrome-OS---Starting-Chrome-the-ui-Job-"><strong>1.5 </strong>Chrome OS - Starting Chrome (the “ui” Job)</a><ol class="goog-toc"><li class="goog-toc"><a href="boot-design.html#TOC-Job-Startup-Flow"><strong>1.5.1 </strong>Job Startup Flow</a></li><li class="goog-toc"><a href="boot-design.html#TOC-Handling-Chrome-Shutdown-Crashes-and-Restarts"><strong>1.5.2 </strong>Handling Chrome Shutdown, Crashes, and Restarts</a></li><li class="goog-toc"><a href="boot-design.html#TOC-Upstart-Events-During-Chrome-Startup"><strong>1.5.3 </strong>Upstart Events During Chrome Startup</a></li></ol></li><li class="goog-toc"><a href="boot-design.html#TOC-Performance-Considerations"><strong>1.6 </strong>Performance Considerations</a><ol class="goog-toc"><li class="goog-toc"><a href="boot-design.html#TOC-The-Boot-Critical-Path"><strong>1.6.1 </strong>The Boot Critical Path</a></li><li class="goog-toc"><a href="boot-design.html#TOC-ureadahead"><strong>1.6.2 </strong>ureadahead</a></li><li class="goog-toc"><a href="boot-design.html#TOC-Impact-of-Cached-Data"><strong>1.6.3 </strong>Impact of Cached Data</a></li><li class="goog-toc"><a href="boot-design.html#TOC-Measuring-Performance"><strong>1.6.4 </strong>Measuring Performance</a><ol class="goog-toc"><li class="goog-toc"><a href="boot-design.html#TOC-Kernel-Performance-Accounting-Anomalies"><strong>1.6.4.1 </strong>Kernel Performance Accounting Anomalies</a></li></ol></li><li class="goog-toc"><a href="boot-design.html#TOC-What-Matters-What-Doesn-t-Matter"><strong>1.6.5 </strong>What Matters, What Doesn’t Matter</a><ol class="goog-toc"><li class="goog-toc"><a href="boot-design.html#TOC-The-Critical-Path-Matters"><strong>1.6.5.1 </strong>The Critical Path Matters</a></li><li class="goog-toc"><a href="boot-design.html#TOC-Evaluating-Significance"><strong>1.6.5.2 </strong>Evaluating Significance</a></li></ol></li></ol></li><li class="goog-toc"><a href="boot-design.html#TOC-Design-Principles"><strong>1.7 </strong>Design Principles</a><ol class="goog-toc"><li class="goog-toc"><a href="boot-design.html#TOC-Put-Jobs-in-the-Right-Package"><strong>1.7.1 </strong>Put Jobs in the Right Package</a></li><li class="goog-toc"><a href="boot-design.html#TOC-Depend-on-the-Public-Events"><strong>1.7.2 </strong>Depend on the Public Events</a></li><li class="goog-toc"><a href="boot-design.html#TOC-Depend-on-Jobs-not-Events"><strong>1.7.3 </strong>Depend on Jobs, not Events</a></li><li class="goog-toc"><a href="boot-design.html#TOC-Create-Your-Own-Storage"><strong>1.7.4 </strong>Create Your Own Storage</a></li></ol></li><li class="goog-toc"><a href="boot-design.html#TOC-Navigating-the-Implementation"><strong>1.8 </strong>Navigating the Implementation</a><ol class="goog-toc"><li class="goog-toc"><a href="boot-design.html#TOC-Source-Code-and-ebuilds"><strong>1.8.1 </strong>Source Code and ebuilds</a></li><li class="goog-toc"><a href="boot-design.html#TOC-Simple-Upstart-Job-Recipes"><strong>1.8.2 </strong>Simple Upstart Job Recipes</a><ol class="goog-toc"><li class="goog-toc"><a href="boot-design.html#TOC-Simple-one-time-script"><strong>1.8.2.1 </strong>Simple one-time script</a></li><li class="goog-toc"><a href="boot-design.html#TOC-Simple-daemon"><strong>1.8.2.2 </strong>Simple daemon</a></li><li class="goog-toc"><a href="boot-design.html#TOC-Failsafe-service"><strong>1.8.2.3 </strong>Failsafe service</a></li><li class="goog-toc"><a href="boot-design.html#TOC-Service-Required-by-the-System-Application"><strong>1.8.2.4 </strong>Service Required by the System Application</a></li><li class="goog-toc"><a href="boot-design.html#TOC-File-System-Initialization-Required-by-Multiple-Services"><strong>1.8.2.5 </strong>File System Initialization Required by Multiple Services</a></li></ol></li></ol></li><li class="goog-toc"><a href="boot-design.html#h.n2wtm1ol8x1w"><strong>1.9 </strong>FAQ</a><ol class="goog-toc"><li class="goog-toc"><a href="boot-design.html#h.pc6h0t76brdq"><strong>1.9.1 </strong>Creating a New Chrome OS Core Platform</a></li><li class="goog-toc"><a href="boot-design.html#h.j0392y7kabqr"><strong>1.9.2 </strong>Adding a New Service</a></li></ol></li><li class="goog-toc"><a href="boot-design.html#TOC-References"><strong>1.10 </strong>References</a></li></ol></li></ol></div></div></div></div></div><h2><a name="TOC-Introduction"></a>Introduction</h2><div><p><span>This document gives an overview of the design of user-land boot processes for Chrome OS based systems. It covers what happens after </span><span>/sbin/init</span><span> first starts execution, until all services in the system are ready.</span></p><p><span>Chrome OS Cor</span><span>e uses </span><span><a href="http://www.google.com/url?q=http%3A%2F%2Fen.wikipedia.org%2Fwiki%2FUpstart&amp;sa=D&amp;sntz=1&amp;usg=AFQjCNEuUVRg10UCp5SZDMxMYm7uXUDFrQ">Upstart</a></span><span> for its </span><span>/sbin/init</span><span> package. Readers of this document should have some basic familiarity with Upstart concepts, such as the syntax of </span><span><a href="http://www.google.com/url?q=http%3A%2F%2Fmanpages.ubuntu.com%2Fmanpages%2Fprecise%2Fen%2Fman5%2Finit.5.html&amp;sa=D&amp;sntz=1&amp;usg=AFQjCNEcyrkvIZPDNeUDdOHLY7pQT9x6AQ">job configuration files</a></span><span>, and Upstart events, such as </span><span><a href="http://www.google.com/url?q=http%3A%2F%2Fmanpages.ubuntu.com%2Fmanpages%2Fprecise%2Fen%2Fman7%2Fstarting.7.html&amp;sa=D&amp;sntz=1&amp;usg=AFQjCNHlfSoGzcMEjfOaHUjsOhEwfBlRGw">starting</a></span><span> and </span><span><a href="http://www.google.com/url?q=http%3A%2F%2Fmanpages.ubuntu.com%2Fmanpages%2Fprecise%2Fen%2Fman7%2Fstarted.7.html&amp;sa=D&amp;sntz=1&amp;usg=AFQjCNGpa6z6Q1A7Q-WtTajYsx7etAqUPA">started</a></span><span>. </span><span>Readers should also have some understanding of Linux file system management concepts, like </span><span><a href="http://www.google.com/url?q=http%3A%2F%2Flinux.die.net%2Fman%2F8%2Fmount&amp;sa=D&amp;sntz=1&amp;usg=AFQjCNHWgzSgniJkKUaQX0F6aoV6tub_Zw">mounting</a></span><span> and </span><span><a href="http://www.google.com/url?q=http%3A%2F%2Flinux.die.net%2Fman%2F8%2Fmkfs&amp;sa=D&amp;sntz=1&amp;usg=AFQjCNHT-LvbDmluahoYo1skfkb28btuiA">creating</a></span><span> file systems.</span></p><p><span>If you want to go deeper and read the source code, you’ll need some understanding of shell programming. If you want to understand the initialization of an individual package, you’ll need to be familiar with that package’s basic operations. Neither of these topics is covered in this document.</span></p><h2><a name="TOC-Summary-of-Boot-Flow"></a><span>Summary of Boot Flow</span></h2><h1><a name="h.n56t7kdl7ejr"></a></h1><h3><a name="TOC-Phases-of-Boot"></a><span>Phases of Boot</span></h3><div><p><i>Boot est omnis divisa in partes tres.</i></p></div><h2><a name="h.imi18w37ozlv"></a></h2><p><a href="boot-design/boot_design_diagram.png%3Fattredirects=0" imageanchor="1" style="font-size:10pt"><img border="0" src="../../_/rsrc/1418437692177/chromium-os/chromiumos-design-docs/boot-design/boot_design_diagram.png" /></a></p><p><span style="font-size:10pt;background-color:transparent">The diagram above shows an outline of the Chrome OS Core boot flow. Boot divides into three sequential phases with four publicly defined Upstart events:</span></p><a href="boot-design.html#" name="895ae9e2de496451e6f83857e0147280690fe01e"></a><a href="boot-design.html#" name="0"></a><table cellpadding="0" cellspacing="0"><tbody><tr><td colspan="1" rowspan="1"><p><span>Upstart Event(s)</span></p></td><td colspan="1" rowspan="1"><p><span>Phase</span></p></td><td colspan="1" rowspan="1"><p><span>Description</span></p></td></tr><tr><td colspan="1" rowspan="1"><p><span>startup</span></p></td><td colspan="1" rowspan="1"><p><span><a href="boot-design.html#h.zhrd95efyszv">Basic Services</a></span></p></td><td colspan="1" rowspan="1"><p><span>Initialization of basic services needed by the rest of the system.</span></p></td></tr><tr><td colspan="1" rowspan="1"><p><span>started boot-services</span></p></td><td colspan="1" rowspan="1"><p><span><a href="boot-design.html#h.lpny9tz0qmud">System Application</a></span></p></td><td colspan="1" rowspan="1"><p><span>Initialization of the system application and other services critical to the product’s UX</span></p></td></tr><tr><td colspan="1" rowspan="1"><p><span>started system-services</span></p><p><span>started failsafe</span></p></td><td colspan="1" rowspan="1"><p><span><a href="boot-design.html#h.nm45bjel265c">System Services</a></span></p></td><td colspan="1" rowspan="1"><p><span>Initialization of all other services. The </span><span>failsafe</span><span> job is guaranteed to start even if the system application fails.</span></p></td></tr></tbody></table><h3><a name="TOC-Basic-Services-Startup"></a><span>Basic Services Startup</span></h3><h2><a name="h.zhrd95efyszv"></a></h2><p><span>“Basic services” are the indispensable services required by the system application and the rest of the system. Most services cannot operate until these basic services are running normally.</span></p><p><span>At the end of basic services startup (that is, when Upstart emits </span><span>started boot-services</span><span>), the following services are guaranteed available:</span></p><ul><li><span>A file system generally conforming to the </span><span><a href="http://www.google.com/url?q=http%3A%2F%2Fwww.pathname.com%2Ffhs%2F&amp;sa=D&amp;sntz=1&amp;usg=AFQjCNHWdZjRwe5FA0JKIi0EVckcCzGvaQ">Linux FHS</a></span><span>.</span></li><li><span>A logging service compatible with </span><span>rsyslogd</span><span>.</span></li><li><span>Device hotplug detection. User input devices or other devices necessary to the system application will be detected, with modules loaded. Detection of devices deemed non-critical may be delayed until after the system application starts.</span></li><li><span>dbus-daemon</span><span>.</span></li></ul><p><span>Note that jobs that run during this phase must by their nature work in an environment where the services above may not be available. At the beginning of this phase, there is</span><span> </span><span>no guarantee of writable storage</span><span>; jobs cannot log messages, write any files, or read </span><span>files </span><span>outside of the root filesystem</span><span>. Additionally, device availability is not guaranteed in all cases; devices may not be initialized, and their drivers may not even be loaded.</span></p><h3><a name="TOC-System-Application-Startup"></a><span>System Application Startup</span></h3><h2><a name="h.lpny9tz0qmud"></a></h2><p><span>Chrome OS Core is predicated on the existence of a single, dedicated application that is central to system startup. For Chrome OS, that application is the Chrome browser. The Chrome OS sources are structured to allow a platform to choose to use a different system application.</span></p><p><span>The system application starts in parallel with various critical services. Typically, “critical” means that the system application expects the service to be present, or that the user would perceive the system as not functional without it. For example, in Chrome OS these services include:</span></p><ul><li><span>A network.</span></li><li><span>The cryptohome daemon.</span></li><li><span>System power management</span><span>.</span></li></ul><p><span>The system application receives special treatment in the boot flow. The application is responsible for emitting the event which starts the </span><span>boot-complete</span><span> job, which allows system services startup to begin. The system application is responsible for this for two reasons:</span></p><ul><li><span>Delaying non-critical services allows the system application to start faster.</span></li><li><span>If the application fails during startup, the absence of running system services can be used to detect the failure.</span></li></ul><p><span>For Chrome OS, </span><span>boot-complete</span><span> starts when the Chrome browser has displayed the initial login screen.</span></p><h3><a name="TOC-System-Services-Startup"></a><span>System Services Startup</span></h3><h2><a name="h.nm45bjel265c"></a></h2><p><span>This phase of boot includes anything not required in the earlier phases of boot. Generally, all jobs in this phase run in parallel. Because the system is considered already booted, this phase is not performance critical.</span></p><p><span>After the </span><span>started system-services</span><span> event, services can rely on the following:</span></p><ul><li><span>All services required after </span><span>started boot-services</span><span> are available.</span></li><li><span>The udev events for all devices that were present at boot have been processed.</span></li><li><span>The system application is available.</span></li></ul><p><span>By design, system services only start if the system application announces its successful initialization. For most services, this is sufficient: without a system application, the system is in a failed state and many services have no useful purpose. However </span><span>some services</span><span> may require that they start eventually, even if the system as a whole has failed. To support this requirement, a service can depend on the </span><span>started failsafe</span><span> event. After </span><span>started boot-services</span><span>, the</span><span> failsafe-delay</span><span> job starts a 30 second timer.  The </span><span>started failsafe</span><span> event occurs at the earlier of </span><span>started system-services</span><span> or the expiration of the timer.</span></p><p><span>Failsafe jobs are commonly used in test and development images for services necessary to debug or recover from failures. Some examples:</span></p><ul><li><span>The </span><span>openssh-server</span><span> job, which allows logging in via </span><span>ssh</span><span>.</span></li><li><span>The </span><span>udev-trigger</span><span> job, which can sometimes be needed to detect and configure a network device.</span></li></ul><h2><a name="TOC-Filesystem-Initialization-and-Layout"></a><span>Filesystem Initialization and Layout</span></h2><h1><a name="h.gfhw9kpet5ar"></a></h1><h3><a name="TOC-Creating-the-Stateful-File-System-the-chromeos_startup-script-"></a><span>Creating the Stateful File System (the chromeos_startup script)</span></h3><h2><a name="h.z4jhloholo6z"></a></h2><p><span>At startup, there is no writable file system storage available. During basic services startup, the script </span><span>chromeos_startup</span><span> is responsible for mounting file systems, and creating the basic directory hierarchy. The script is invoked from the </span><span>startup</span><span> job, which starts with the </span><span>startup</span><span> event emitted by </span><span>/sbin/init</span><span> at the start of the userland boot process.</span></p><p><span>The script creates missing directories and mount points as necessary. This is done to support re-creating the filesystem after </span><span><a href="boot-design.html#h.no2bd2qbh52h">stateful wipe</a></span><span>, and also to protect the filesystem from inadvertent damage. </span><span>Below is a list of the principle directories, listed in the order they’re processed.</span></p><ul><li><span>/tmp</span><span> - mounted as a </span><span>tmpfs</span><span> filesystem</span></li><li><span>/sys/kernel/debug</span><span> - mounted as a </span><span>debugfs</span><span> filesystem.</span></li><li><span>/mnt/stateful_partition</span><span> - mounted as an </span><span>ext4</span><span> file system from GPT partition #1 (but for factory images, a </span><span>tmpfs</span><span> file system is used instead).</span></li><li><span>/home</span><span> and its subdirectories - created as necessary; </span><span>/home</span><span> itself is a bind mount on </span><span>/mnt/stateful_partition/home</span></li><li><span>/var</span><span> and </span><span>/home/chronos</span><span> - mounted as described below under </span><span><a href="boot-design.html#h.zdlxdrpbjmx9">Encrypted Stateful</a></span><span>.</span></li><li><span>Subdirectories of </span><span>/var</span><span> - created as called for by the Linux FHS.</span></li><li><span>/usr/local</span><span> - This directory is only mounted for developer and test systems. The directory is a bind mount over </span><span>/mnt/stateful_partition/dev_image</span><span>.</span></li></ul><h3><a name="TOC-Encrypted-Stateful"></a><span>Encrypted Stateful</span></h3><h2><a name="h.y4vr1c4hxx6o"></a></h2><p><span>As a security measure to protect private data, the portions of the stateful partition under </span><span>/var</span><span> and </span><span>/home/chronos</span><span> are mounted from an encrypted blob stored in the stateful partition. The encrypted storage is kept in </span><span>/mnt/stateful_partition/encrypted</span><span>. Mounting and unmounting the encrypted data is handled by the </span><span>mount-encrypted</span><span> command.</span></p><p><span>Not all Chrome OS Core platforms use this feature: The feature requires a TPM to be effective. Moreover, the feature presupposes some specific privacy requirements. For Chrome OS, these requirements apply; they may not be applicable on all platforms. When the feature is not used, </span><span>/var</span><span> and </span><span>/home/chronos</span><span> are simple bind mounts.</span></p><h2><a name="TOC-Special-Boot-Flows"></a><span>Special Boot Flows</span></h2><h1><a name="h.4dvb9ysiv46e"></a></h1><p><span>Chrome OS Core supports a number of special boot flows, many of which are designed to handle system behaviors across multiple boots. This includes special cases for installation, recovery, and update.</span></p><h3><a name="TOC-Boot-Alert-Messages"></a><span>Boot Alert Messages</span></h3><h2><a name="h.r32c28uwsj84"></a></h2><p><span>Some special flows involve presenting simple messages to the user prior during basic services startup. All such flows are detected and handled from </span><span>chromeos_startup</span><span>. The flows involve one of two use cases:</span></p><ul><li><span>During </span><span><a href="boot-design.html#h.no2bd2qbh52h">stateful wipe</a></span><span>, a message specific to the specific wipe use case will be presented.</span></li><li><span>From time to time, an update may contain new firmware for the device. These updates must be performed at the start of the first boot with the new update.</span></li></ul><p><span>Because these messages are presented during basi services startup, a special script called </span><span>chromeos-boot-alert</span><span> is used to accommodate the restricted operating environment:</span></p><ul><li><span>T</span><span>he X server is not running. The script uses </span><span>ply-image</span><span> to write directly to the frame buffer.</span></li><li><span>The </span><span>chromeos-boot-alert</span><span> script must wait for the boot splash screen animation to complete in order to guarantee exclusive access to the frame buffer.</span></li><li><span>The script must select a localized message text based on the user’s default locale.</span></li></ul><h3><a name="TOC-Stateful-Wipe-a.k.a.-Powerwash-"></a><span>Stateful Wipe (a.k.a. “Powerwash”)</span></h3><h2><a name="h.no2bd2qbh52h"></a></h2><p><span>In certain boot cases, </span><span>chromeos_startup</span><span> must erase and re-create the stateful partition. The script triggers stateful wipe for one of three conditions:</span></p><ul><li><span>The stateful partition failed to mount, or a bind mount on the stateful partition failed.</span></li><li><span>Wipe requested at the previous shutdown. The script will wipe the stateful partition if a file named </span><span>factory_install_reset</span><span> is present in the root of the stateful filesystem at boot time. This method is used for two use case:</span></li></ul><ul><li><span>Factory wipe. At the end of the manufacturing process, the device wipes the stateful partition in preparation for boxing and shipment.</span></li><li><span>Power wash. The user can request a wipe for purposes of restoring it to a clean state.</span></li></ul><ul><li><span>Wipe after changing from dev mode to verified mode, or vice versa. A file named </span><span>.developer_mode</span><span> in the root of the stateful partition flags whether the system was previously in dev mode:</span></li></ul><ul><li><span>If the file is absent and we’re currently in dev mode, we trigger a wipe for the verified-to-dev mode switch.</span></li><li><span>If the file is present and we’re currently in verified mode, we trigger a wipe for the dev-to-verified mode switch.</span></li></ul><p><span>Principally, wiping the stateful partition means re-creating an empty filesystem using </span><span>mkfs</span><span>. Prior to creating the file system, the wipe procedure will also erase data in the partition in order to prevent leaking any private data that was present prior to the wipe.</span></p><p><span>If the wipe procedure is performed while in dev mode, the </span><span>.developer_mode</span><span> file will be created after the wipe. This marks that the system has successfully wiped stateful after the conversion to dev mode.</span></p><p><span>After the wipe procedure is complete, the system reboots; on reboot the system will </span><span><a href="boot-design.html#h.z4jhloholo6z">rebuild directories and mount points</a></span><span> in the stateful file system.</span></p><h2><a name="TOC-Interactions-with-Install-Recovery-and-Update"></a><span>Interactions with Install, Recovery, and Update</span></h2><h1><a name="h.9poq88copsuj"></a></h1><p><span>After new software is installed by </span><span>chromeos-install</span><span> (including device recovery), or automatic update, a reboot is necessary for the new software to take effect. The first reboot after installing new software triggers special handling, depending on the specific installation use case.</span></p><h3><a name="TOC-Rollback-Protection-After-Update"></a><span>Rollback Protection After Update</span></h3><h2><a name="h.pgddr78r6iyt"></a></h2><p><span>If a catastrophic system failure manifests immediately after an automatic update, Chrome OS Core can detect the failure and roll back to the previously installed software. The mechanism relies on a three-way interaction with</span><span> the </span><span>update_engine</span><span> service, the firmware, and the system application.</span></p><p><span>Each kernel GPT partition on the boot disk contains three special attributes flags, which the firmware uses to select which kernel to boot. The flags are designated “priority”, “successful”, and “tries”. The firmware selects the kernel based on these flags; the full rules are described in the </span><span><a href="disk-format.html">design document for the disk format</a></span><span>. The </span><span>update_engine</span><span> service updates these flags with specific values after applying an update, and again with different values after the system boots without failure.</span></p><p><span>After </span><span>update_engine</span><span> has finished downloading and installed a new image, the update’s post-install phase marks the GPT flags for the new kernel to have the highest priority for boot, with “tries” set to 5, and “successful” set to 0. In this state, the partition will be selected by the firmware as the first kernel to boot.</span></p><p><span>On each boot, the firmware decrements the “tries” setting for the new kernel in the GPT. If “tries” is decremented to 0 and “successful” is never set to 1, the firmware will roll back to the previous working software. To prevent the rollback, the system must mark the kernel as good by setting the “tries” count to 0 and the “successful” flag to 1 sometime after booting.</span></p><p><span>Chrome OS Core does not automatically mark the kernel good immediately after boot. Instead, when the </span><span>update_engine</span><span> service starts, it sets a 45 second timer. When the timer expires, </span><span>update_engine</span><span> invokes a script called </span><span>chromeos-setgoodkernel</span><span>. That script marks the kernel as good, after which rollback is no longer possible.</span></p><p><span>The </span><span>update_engine</span><span> service depends on </span><span>started system-services</span><span>. Consequently, rollback will be triggered if a newly updated image consistently fails in any of the following ways:</span></p><ul><li><span>The kernel panics before </span><span>chromeos-setgoodkernel</span><span> can run.</span></li><li><span>The system hangs before </span><span>chromeos-setgoodkernel</span><span> can run.</span></li><li><span>The system application crashes before triggering </span><span>boot-complete</span><span>.</span></li></ul><p><span>Note that the user will typically have to forcibly power cycle a unit multiple times in any failure case other than a kernel panic.</span></p><p><span>A consequence of this design is that if the system application is crashing at startup, the system cannot receive new updates. This is a deliberate design choice: It is not a bug. The rationale is that if a system is failing in this way, rollback is by far the most preferable way to recover. Waiting for an update is unlikely to be useful in most cases:</span></p><ul><li><span>If users wait for an update and the next update contains the same bug, that new update will have overwritten the working previous version. In this case, rollback (by far the most preferable option) will be foreclosed.</span></li><li><span>It could be days before a problem of this sort can be recognized, diagnosed, fixed, and released. Many users will be unwilling to wait so long.</span></li><li><span>Even if users are willing to wait, most of them will not be easily able to determine when a fixed update is available.</span></li><li><span>Recovery is likely to be faster than waiting for an update.</span></li></ul><h3><a name="TOC-Installation-and-Recovery"></a><span>Installation and Recovery</span></h3><h2><a name="h.xu4oy15jvst"></a></h2><p><span>The </span><span>chromeos-install</span><span> script can be used to install an image from scratch on a device. The end-user </span><span><a href="https://www.google.com/chromeos/recovery">recovery procedure</a></span><span> is a wrapper around this script. Additionally, developers can run the script manually when they boot a custom image from USB in dev mode. Although the UX in the two cases is quite different, the system state after installation in either case is indistinguishable.</span></p><p><span>The installation process includes creating a stateful partition file system, similar to the process for stateful wipe. As with stateful wipe, installation is responsible for creating the </span><span>.developer_mode</span><span> file when installing in dev mode. Also as with stateful wipe, after rebooting the system will </span><span><a href="boot-design.html#h.z4jhloholo6z">rebuild directories and mount points</a></span><span> in the stateful file system</span><span>.</span></p><h3><a name="TOC-Stateful-Update-and-Install"></a><span>Stateful Update and Install</span></h3><h2><a name="h.wfqx46y7qbf"></a></h2><p><span>For developer and test builds of Chrome OS, substantial portions of the software are installed in </span><span>/usr/local</span><span>, a </span><span><a href="boot-design.html#h.gfhw9kpet5ar">bind mount</a></span><span> over </span><span>/mnt/stateful_partition/dev_image</span><span>.  This content is not delivered via the autoupdate mechanism.  Instead, a script called </span><span>stateful_update</span><span> is used to update it separately.</span></p><p><span>The stateful update procedure operates in two stages:</span></p><ul><li><span>The script downloads a tar file, and extracts new content for </span><span>/usr/local</span><span> and </span><span>/var </span><span>into temporary locations in the stateful partition.</span></li><li><span>After reboot, </span><span>chromeos_startup</span><span> replaces the old directories with the new ones prior to mounting </span><span>/usr/local</span><span>.</span></li></ul><h2><a name="TOC-Chrome-OS---Starting-Chrome-the-ui-Job-"></a><span>Chrome OS - Starting Chrome (the “ui” Job)</span></h2><h1><a name="h.vmi3dv1ygkj"></a></h1><p><span>The Chrome browser is the system application for Chrome OS.  The </span><span>ui</span><span> job is responsible for starting, managing, and restarting the Chrome OS </span><span>session_manager</span><span> process.  The </span><span>session_manager</span><span> process in turn is responsible for managing the Chrome browser process.</span></p><h3><a name="TOC-Job-Startup-Flow"></a><span>Job Startup Flow</span></h3><h2><a name="h.upoatdkj2wt"></a></h2><p><span>The </span><span>ui</span><span> job is responsible for starting </span><span>session_manager</span><span>.  That program is responsible for the following:</span></p><ul><li><span>Starting the X server process in the background.</span></li><li><span>Determining Chrome command-line options.</span></li><li><span>Initializing environment variables for the Chrome browser process.</span></li><li><span>Initializing the system resources (e.g. directories, files, cgroups) needed by the Chrome browser.</span></li><li><span>Starting the Chrome browser.</span></li></ul><p><span>Once Chrome has successfully displayed the initial startup screen, it kicks off the following sequence of events:</span></p><ul><li><span>Chrome calls </span><span>session_manager</span><span>’s </span><span>EmitLoginPromptVisible</span><span> interface over D-bus.</span></li><li><span>session_manager</span><span> emits the </span><span>login-prompt-visible</span><span> </span><span>Upstart event.</span></li></ul><ul><li><span>The </span><span>login-prompt-visible</span><span> event triggers the </span><span>boot-complete</span><span> job.</span></li></ul><h3><a name="TOC-Handling-Chrome-Shutdown-Crashes-and-Restarts"></a><span>Handling Chrome Shutdown, Crashes, and Restarts</span></h3><h2><a name="h.4pacfwwermo"></a></h2><p><span>When a user logs out of Chrome, the browser process terminates normally. In turn, </span><span>session_manager</span><span> terminates, which ends the </span><span>ui</span><span> job.  In normal operation, the ui job must respawn when this happens.  However, in the event of a Chrome crash, the automatic respawn logic is more complex than Upstart’s standard respawn behavior. Instead, whenever the </span><span>ui</span><span> job stops, a separate </span><span>ui-respawn</span><span> job determines what to do according to these rules:</span></p><ul><li><span>If the termination was for system shutdown or reboot, don’t respawn and allow the shutdown to proceed.</span></li><li><span>If the termination was for a simple log out, respawn the browser unconditionally.</span></li><li><span>For most abnormal termination cases, try respawning the browser.</span></li><li><span>If an abnormal termination was because </span><span>session_manager</span><span> tried to restart Chrome too many times, try rebooting the system.</span></li></ul><p><span>Special handling for abnormal termination is </span><span>subject to rate limitations</span><span>:</span></p><ul><li><span>Respawn is limited to no more than 6 times in one minute.</span></li><li><span>Rebooting is only attempted if the particular error termination happens more than once in 3 minutes; otherwise it just respawns.</span></li><li><span>Reboot is limited to no more than once every 9 minutes.</span></li></ul><p><span>If a failure isn’t handled by respawning or rebooting, the </span><span>ui</span><span> job stops, but the system stays up.  The user can manually force power-off, if desired.</span></p><h3><a name="TOC-Upstart-Events-During-Chrome-Startup"></a><span>Upstart Events During Chrome Startup</span></h3><h2><a name="h.bm3ca2v09tf2"></a></h2><p><span>Below is a list of various Upstart events triggered by Chrome browser startup, and when they happen:</span></p><a href="boot-design.html#" name="4514319ed107337dbdd7b518f8339c767c3ae3c9"></a><a href="boot-design.html#" name="1"></a><table cellpadding="0" cellspacing="0"><tbody><tr><td colspan="1" rowspan="1"><p><span>Event</span></p></td><td colspan="1" rowspan="1"><p><span>When it happens</span></p></td></tr><tr><td colspan="1" rowspan="1"><p><span>starting ui</span></p></td><td colspan="1" rowspan="1"><p><span>This first occurs at boot after </span><span>started boot-services</span><span>. After boot, the event will re-occur every time after a user logs out, or any time Chrome restarts after a crash.</span></p></td></tr><tr><td colspan="1" rowspan="1"><p><span>x-started</span></p></td><td colspan="1" rowspan="1"><p><span>session_manager</span><span> emits this event after the X server finishes initializing.  This happens after every Chrome restart.</span></p></td></tr><tr><td colspan="1" rowspan="1"><p><span>login-prompt-visible</span></p></td><td colspan="1" rowspan="1"><p><span>session_manager</span><span> emits this event after Chrome announces that has finished displaying its login screen.  This happens after every Chrome restart.</span></p></td></tr><tr><td colspan="1" rowspan="1"><p><span>started boot-complete</span></p></td><td colspan="1" rowspan="1"><p><span>This occurs the first time that </span><span>login-prompt-visible</span><span> is emitted after boot.</span></p></td></tr><tr><td colspan="1" rowspan="1"><p><span>start-user-session</span></p></td><td colspan="1" rowspan="1"><p><span>session_manager</span><span> emits this event after Chrome announces the start of a user session.</span></p></td></tr><tr><td colspan="1" rowspan="1"><p><span>stopping ui</span></p></td><td colspan="1" rowspan="1"><p><span>This occurs whenever a user logs out, if the Chrome browser crashes, or when the system is shutting down.</span></p></td></tr></tbody></table><h2><a name="TOC-Performance-Considerations"></a><span>Performance Considerations</span></h2><h1><a name="h.nkmqxx51v4sf"></a></h1><h3><a name="TOC-The-Boot-Critical-Path"></a><span>The Boot Critical Path</span></h3><h2><a name="h.kb7w2ickc8bc"></a></h2><p><span>Each phase of boot is dominated by one long running step. These steps must run sequentially, so together they make up a critical path. For Chrome OS, these are the longest running steps in the critical path:</span></p><p><span>chromeos_startup</span></p><p><span>X server startup until </span><span>session_manager</span><span> emits the </span><span>x-started</span><span> event.</span></p><p><span>Chrome browser startup, until </span><span>login-prompt-visible</span></p><p><span>Adding time directly to the critical path will result in delaying boot by an equivalent time. Whenever possible, initialization should run in parallel with the critical path.</span></p><h3><a name="TOC-ureadahead"></a><span>ureadahead</span></h3><h2><a name="h.4nqngmn6a9r9"></a></h2><p><span>System startup time is heavily influenced by the wait time required to read data that isn’t yet in the file buffer cache. The </span><span><a href="http://www.google.com/url?q=http%3A%2F%2Fmanpages.ubuntu.com%2Fmanpages%2Fprecise%2Fman8%2Fureadahead.8.html&amp;sa=D&amp;sntz=1&amp;usg=AFQjCNGq-lkbAxTEkiTp_Yc2moX8IPPY5g">ureadahead</a></span><span> program can improve boot time by requesting data in advance of when it’s needed, so that boot spends less time waiting for data from the boot device. Some key facts about ureadahead:</span></p><ul><li><span>Platforms that want to use this feature must depend on the </span><span>sys-apps/ureadahead</span><span> package.</span></li><li><span>Platforms that want to use ureadahead must configure some specific kernel tracing features.</span></li><li><span>The ureadahead program starts execution when </span><span>chromeos_startup</span><span> finishes, and terminates when </span><span>boot-complete</span><span> starts. So, ureadahead doesn’t provide any improvement after the system application has finished starting.</span></li><li><span>Auto-update removes the ureadahead pack file during its post-install phase. This means that the first boot after an update will be slower because ureadahead must regenerate the pack file.</span></li></ul><h3><a name="TOC-Impact-of-Cached-Data"></a><span>Impact of Cached Data</span></h3><h2><a name="h.nwxg1rphlevx"></a></h2><p><span>During boot, various processes may cache data under </span><span>/var</span><span>, in order to make the next time’s startup faster. However, from time to time these cached data may need to be invalidated (i.e. removed), resulting in a one-time slower boot. Below is a list of known caches affecting boot time, and a summary of what causes them to be invalidated.</span></p><ul><li><span>The </span><span><a href="boot-design.html#h.4nqngmn6a9r9">ureadahead</a></span><span> pack files - these live under </span><span>/var/lib/ureadahead</span><span>. The auto-update post-install phase invalidates the data whenever a new update is ready.</span></li><li><span>The xkb cache files</span><span> - these live under </span><span>/var/lib/xkb</span><span>. They’re created as needed during X server startup. They’re removed on the first boot after any update; this happens in </span><span>src/install-completed.conf</span><span> in </span><span>src/platform/installer</span><span>.</span></li><li><span>The VPD cache - this collection of files is created by </span><span>dump_vpd_logs</span><span> during basic services startup; see the sources under </span><span>src/platform/vpd</span><span> for more details. The cached data comes from read-only firmware and never needs to be invalidated. However, after powerwash, the read-only firmware must be re-read, and this can be expensive on some platforms.</span></li></ul><h3><a name="TOC-Measuring-Performance"></a><span>Measuring Performance</span></h3><h2><a name="h.bx6yq5xpw1c"></a></h2><p><span>There’s a </span><span><a href="http://www.chromium.org/chromium-os/how-tos-and-troubleshooting/measuring-boot-time-performance">web site</a></span><span> for this.</span></p><p><span>Boot performance is measured by capturing timestamps at specific moments during the boot flow.  These are some of the </span><span>key events</span><span> reported by the tools:</span></p><a href="boot-design.html#" name="b123123b89753407a56a40e65d3492c1911ae9bc"></a><a href="boot-design.html#" name="2"></a><table cellpadding="0" cellspacing="0"><tbody><tr><td colspan="1" rowspan="1"><p><span>bootstat name</span></p></td><td colspan="1" rowspan="1"><p><span>keyval name</span></p></td><td colspan="1" rowspan="1"><p><span>Meaning</span></p></td></tr><tr><td colspan="1" rowspan="1"><p><span>pre-startup</span></p></td><td colspan="1" rowspan="1"><p><span>seconds_kernel_to_startup</span></p></td><td colspan="1" rowspan="1"><p><span>Start of </span><span>chromeos_startup</span></p></td></tr><tr><td colspan="1" rowspan="1"><p><span>post-startup</span></p></td><td colspan="1" rowspan="1"><p><span>seconds_kernel_to_startup_done</span></p></td><td colspan="1" rowspan="1"><p><span>End of </span><span>chromeos_startup</span></p></td></tr><tr><td colspan="1" rowspan="1"><p><span>x-started</span></p></td><td colspan="1" rowspan="1"><p><span>seconds_kernel_to_x_started</span></p></td><td colspan="1" rowspan="1"><p><span>X server startup complete</span></p></td></tr><tr><td colspan="1" rowspan="1"><p><span>chrome-exec</span></p></td><td colspan="1" rowspan="1"><p><span>seconds_kernel_to_chrome_exec</span></p></td><td colspan="1" rowspan="1"><p><span>Session manager fork/exec of the Chrome browser process</span></p></td></tr><tr><td colspan="1" rowspan="1"><p><span>boot-complete</span></p></td><td colspan="1" rowspan="1"><p><span>seconds_kernel_to_login</span></p></td><td colspan="1" rowspan="1"><p><span>Start of the </span><span>boot-complete</span><span> Upstart job</span></p></td></tr></tbody></table><p><span>All of these events are part of the critical path.</span></p><h4><a name="TOC-Kernel-Performance-Accounting-Anomalies"></a><span>Kernel Performance Accounting Anomalies</span></h4><h3><a name="h.wn8xrflonmm2"></a></h3><p><span>For kernel startup, capturing a time stamp at the exact moment of some key transitions is inconvenient.  The result is that certain events that ought to be ascribed to one phase (e.g. kernel startup) are ascribed to the adjacent phase:</span></p><ul><li><span>Kernel startup begins with decompression of the kernel, and starting kernel time accounting. This work takes a few hundred milliseconds, the bulk which is spent on decompression. This time isn’t recorded as part of the </span><span>seconds_kernel_to_login</span><span> metric; to observe this time, you have to look at firmware performance numbers.</span></li><li><span>Kernel initialization is complete when it hands control to </span><span>/sbin/init</span><span>. However, the userland boot flow can’t mark the start time until </span><span>chromeos_startup</span><span> has mounted </span><span>/tmp</span><span> and </span><span>/sys/kernel/debug</span><span>. That work requires a few dozen milliseconds, and is attributed to kernel startup time.</span></li></ul><h3><a name="TOC-What-Matters-What-Doesn-t-Matter"></a><span>What Matters, What Doesn’t Matter</span></h3><h2><a name="h.wrovqelswjkw"></a></h2><p><span>Not every change to the boot flow matters to boot performance.  Changes may happen to flows that run in parallel with the critical path without slowing it down.  Even if a change measurably affects boot time, software engineering considerations such as maintainability or readability may matter more than performance.  Below are guidelines for evaluating whether a change might impact boot time, and whether the impact is truly significant.</span></p><h4><a name="TOC-The-Critical-Path-Matters"></a><span>The Critical Path Matters</span></h4><h3><a name="h.arrw6ojafvwm"></a></h3><p><span><a href="boot-design.html#h.kb7w2ickc8bc">As noted</a></span><span>, time added in sequence with the critical path is time added directly to boot time.  When work executes in parallel with the critical path, the boot time impact will be much smaller.  In the best case, work in parallel will consume resources that would otherwise be idle, meaning boot time is unaffected.  Even if jobs in parallel compete for resources with the critical path, the impact is typically smaller than the total resource requirement of the extra work.</span></p><h4><a name="TOC-Evaluating-Significance"></a><span>Evaluating Significance</span></h4><h3><a name="h.guhfhuicebkj"></a></h3><p><span>Performance tuning frequently requires trade-offs between a simpler, more maintainable design, and the best possible performance. Moreover, even when tuning doesn’t have a maintenance impact, the cost to make and test a code change may exceed the benefit of the performance improvement.  Finally, the boot time numbers tend to very noisy; small changes are likely not to be statistically significant.</span></p><p><span>Use these rules when evaluating what trade-offs may be necessary for performance:</span></p><ul><li><span>Unless you’re making firmware changes (or certain kernel changes), only changes to the </span><span>seconds_kernel_to_login</span><span> (a.k.a. </span><span>boot-complete</span><span>) event time matter.  The intermediate events are there to diagnose problems, not as performance metrics.</span></li><li><span>Changes less than 100ms (.1s) are too small to matter to a typical human and too small to be measured reliably. Below this threshold, the only considerations are the basic software engineering considerations of maintainable, easy-to-understood source code.</span></li><li><span>Changes more than 250ms (.25s) are significant.  Above this threshold, going out of your way to improve performance is justified.</span></li><li><span>In between these two thresholds, exercise careful judgment.</span></li></ul><p><span>Note that these guidelines apply equally to improvements and regressions:  Just as 50 ms slower isn’t a regression, 50 ms faster isn’t an improvement.</span></p><h2><a name="TOC-Design-Principles"></a><span>Design Principles</span></h2><h1><a name="h.kpi3xxpjqz51"></a></h1><p><span>The principles in this section are meant to improve the maintainability of packages that deliver Upstart jobs.</span></p><h3><a name="TOC-Put-Jobs-in-the-Right-Package"></a><span>Put Jobs in the Right Package</span></h3><h2><a name="h.k3tjqtbo7ol7"></a></h2><p><span>An Upstart job should ideally be associated with a specific service, live in the source code repository for that service, and be delivered in the same package as the service. This has multiple advantages:</span></p><ul><li><span>Not all services are required on all platforms/products.  Keeping the job with the service means the job won’t be present in systems where it doesn’t belong.</span></li><li><span>If the service becomes obsolete, the job will go away when the service’s package is deleted.</span></li><li><span>The service and the job frequently change together.  Keeping them together reduces the number of repositories you have to change.</span></li><li><span>Having the job live close to the program it starts makes it easier to read and understand the service as a whole; you don’t have to consult two source repositories at once.</span></li></ul><h3><a name="TOC-Depend-on-the-Public-Events"></a><span>Depend on the Public Events</span></h3><h2><a name="h.3zgiaippvuaz"></a></h2><p><span>For Chrome OS Core, there are four public Upstart events with well-defined, stable semantics.  In order of preference, from most to least preferred, they are </span><span>started system-services</span><span>, </span><span>started failsafe</span><span>, </span><span>started boot-services</span><span>, and </span><span>startup</span><span>.  A package that delivers an Upstart job should depend on the most preferred public job that will meet its requirements.</span></p><p><span>Note that a job should depend on only one of the four events; depending on more than one event is redundant:</span></p><ul><li><span>started system-services</span><span> implies </span><span>started failsafe</span><span>.</span></li><li><span>started failsafe</span><span> implies </span><span>started boot-services</span><span>.</span></li></ul><p><span>Other than the four public events, Upstart jobs and events generated by the </span><span>chromeos-base/chromeos-init</span><span> package should be considered private to the package, and subject to change at any time.  If your job depends on a private event, changes to </span><span>chromeos-init</span><span> could cause your job to start at the wrong time, or not start at all.</span></p><p><span>If your package depends on </span><span>chromeos-base/chromeos-login</span><span>, it can also depend on the standard </span><span><a href="boot-design.html#h.bm3ca2v09tf2">Chrome startup events</a></span><span>.</span></p><p><span>If your package delivers more than one job, it is safe and reasonable for some jobs to depend on others in the same package instead of depending on the public events.</span></p><p><span>Where possible, jobs should not depend jobs delivered by other packages, because the inter-package coupling can create maintenance hazards. However, if two packages are already coupled for sound technical reasons, it’s reasonable for one of the package to depend on the other’s Upstart jobs. For examples, look at the tree of jobs for starting the network (see </span><span>init/shill.conf</span><span> in </span><span>src/platform/shill</span><span>) or cryptohome services (see </span><span>init/cryptohomed.conf</span><span> in </span><span>src/platform/cryptohome</span><span>).</span></p><h3><a name="TOC-Depend-on-Jobs-not-Events"></a><span>Depend on Jobs, not Events</span></h3><h2><a name="h.mmrajiyga8rf"></a></h2><p><span>Generally, start and stop conditions for jobs should be based on job events like </span><span>started</span><span> and </span><span>stopped</span><span>, rather than starting or stopping jobs with </span><span>initctl emit</span><span>, </span><span>start</span><span>, or </span><span>stop</span><span>.  Depending on a job makes it easier to find the sources of events, and trace their flow through the source code.</span></p><p><span>If you must use </span><span>initctl emit</span><span>, </span><span>start</span><span>, or </span><span>stop</span><span>, follow these guidelines to help readability:</span></p><ul><li><span>Comments in the source where </span><span>initctl emit</span><span> is called should name what jobs are affected, and how.</span></li><li><span>In jobs affected by </span><span>initctl emit</span><span>, </span><span>start</span><span>, or </span><span>stop</span><span>, there should be comments detailing the callers that do the work.</span></li><li><span>There should be comments at the call source and/or job destination that explain why the problem has to be solved this way.</span></li><li><span>Both the caller and the affected job should be in the same source package.</span></li></ul><h3><a name="TOC-Create-Your-Own-Storage"></a><span>Create Your Own</span><span> Storage</span></h3><h2><a name="h.5kwzr6xzlqhd"></a></h2><p><span>If your service requires writable storage (e.g. a directory in </span><span>/var/lib</span><span>), your service is responsible for creating the files and directories.  Typically, this can happen in a </span><span>pre-start</span><span> script in the Upstart job for the service.  Work to create this storage should belong to the package that owns the service.  The work should not be handled in </span><span>chromeos_startup</span><span>, or an Upstart job not related to your package.  The work must happen at boot: In general, </span><span>there is no way to initialize writable storage at build time.</span></p><p><span>The objective is that if your package isn’t part of a distribution, it shouldn’t create vestiges in the file systems of distributions that don’t need it.</span></p><p><span>Note that packages can and should rely on directories specified in the Linux FHS.  If a location specified in the standard in the standard is missing, code to create it should be added to </span><span>chromeos_startup</span><span>.</span></p><h2><a name="TOC-Navigating-the-Implementation"></a><span>Navigating the Implementation</span></h2><h1><a name="h.8z1iorhd7ruj"></a></h1><h3><a name="TOC-Source-Code-and-ebuilds"></a><span>Source Code and ebuilds</span></h3><h2><a name="h.cija5au5rljh"></a></h2><p><span>The table below shows the package names and source code repository paths for key behaviors described in this document.</span></p><a href="boot-design.html#" name="87ce8c95f3a2f997433b60f7179faae52763d25b"></a><a href="boot-design.html#" name="3"></a><table cellpadding="0" cellspacing="0"><tbody><tr><td colspan="1" rowspan="1"><p><span>ebuild Package</span></p></td><td colspan="1" rowspan="1"><p><span>Source Repo</span></p></td><td colspan="1" rowspan="1"><p><span>Description</span></p></td></tr><tr><td colspan="1" rowspan="1"><p><span>chromeos-base/chromeos-init</span></p></td><td colspan="1" rowspan="1"><p><span> src/platform/init</span></p></td><td colspan="1" rowspan="1"><p><span><a href="boot-design.html#h.n56t7kdl7ejr">Basic boot flow</a></span></p></td></tr><tr><td colspan="1" rowspan="1"><p><span>chromeos-base/chromeos-login</span></p></td><td colspan="1" rowspan="1"><p><span>src/platform/login_manager</span></p></td><td colspan="1" rowspan="1"><p><span><a href="boot-design.html#h.vmi3dv1ygkj">Chrome startup</a></span></p></td></tr><tr><td colspan="1" rowspan="1"><p><span>chromeos-base/update_engine</span></p></td><td colspan="1" rowspan="1"><p><span>src/platform/update_engine</span></p></td><td colspan="1" rowspan="1"><p><span><a href="boot-design.html#h.pgddr78r6iyt">Rollback support</a></span></p></td></tr><tr><td colspan="1" rowspan="1"><p><span>chromeos-base/chromeos-installer</span></p></td><td colspan="1" rowspan="1"><p><span>src/platform/installer</span></p></td><td colspan="1" rowspan="1"><p><span><a href="boot-design.html#h.xu4oy15jvst">Install/Recovery</a></span></p></td></tr><tr><td colspan="1" rowspan="1"><p><span>chromeos-base/chromeos-assets</span></p></td><td colspan="1" rowspan="1"><p><span>src/platform/assets</span></p></td><td colspan="1" rowspan="1"><p><span><a href="boot-design.html#h.r32c28uwsj84">Boot message texts</a></span></p></td></tr></tbody></table><h3><a name="TOC-Simple-Upstart-Job-Recipes"></a><span>Simple Upstart Job Recipes</span></h3><h2><a name="h.ttx1idwwj8hb"></a></h2><h4><a name="TOC-Simple-one-time-script"></a><span>Simple one-time script</span></h4><h3><a name="h.3xtuqluq10bj"></a></h3><p><span>You need to run a short script once after boot. You don’t care about running the command if the system application fails at startup.</span></p><p><span>Pattern your job after this:</span></p><p><span>        start on started system-services</span></p><p><span>        script</span></p><p><span>          # … initialization commands ...</span></p><p><span>        end script</span></p><h4><a name="TOC-Simple-daemon"></a><span>Simple daemon</span></h4><h3><a name="h.gcckm29e4rl9"></a></h3><p><span>You need a daemon to start after boot. If the daemon dies it should restart. The daemon stores working data in a directory under </span><span>/var/lib</span><span>.</span></p><p><span>Pattern your job after this:</span></p><p><span>        start on started system-services</span></p><p><span>        stop on stopping system-services</span></p><p><span>        respawn</span></p><p><span>        pre-start script</span></p><p><span>          mkdir -p /var/lib/my-daemon</span></p><p><span>        end script</span></p><p><span>        exec my-daemon</span></p><p><span>Many daemons require</span><span> expect fork</span><span> or </span><span>expect daemon</span><span> in addition to </span><span>respawn</span><span>. Consult your friendly neighborhood Upstart guru for advice.</span></p><h4><a name="TOC-Failsafe-service"></a><span>Failsafe service</span></h4><h3><a name="h.6s5ickpqnkqg"></a></h3><p><span>You have a service that’s needed for administrative or debug access to your device. Your service can start after the system application, so that it won’t slow down boot. However, if the system applications fails, your service is vital to connecting to the failed unit in order to repair or debug it.</span></p><p><span>Pattern your job after this:</span></p><p><span>        start on started failsafe</span></p><p><span>stop on stopping failsafe</span></p><p><span>respawn</span></p><p><span>        exec my-important-administrative-daemon</span></p><h4><a name="TOC-Service-Required-by-the-System-Application"></a><span>Service Required by the System Application</span></h4><h3><a name="h.j260d46uu8ih"></a></h3><p><span>When your system application starts, it connects to a service provided by a separate daemon that must be started in its own job.  The system application can’t finish initialization without this second service, and will wait until it’s ready.</span></p><p><span>Pattern your job after this:</span></p><p><span>start on started boot-services</span></p><p><span>stop on stopping boot-services</span></p><p><span>respawn</span></p><p><span>exec my-important-daemon</span></p><h4><a name="TOC-File-System-Initialization-Required-by-Multiple-Services"></a><span>File System Initialization Required by Multiple Services</span></h4><h3><a name="h.3zxsffn1mher"></a></h3><p><span>You have a service that provides a shared resource in the file system (e.g. a directory, a named FIFO, etc.).  You need to make sure that the file system resource is created before any service depending on </span><span>started boot-services</span><span>.</span></p><p><span>Pattern your job after this:</span></p><p><span>start on starting boot-services</span></p><p><span>task</span></p><p><span>script</span></p><p><span>  create-my-important-resource</span></p><p><span>end script</span></p><h2><a name="h.n2wtm1ol8x1w"></a><span>FAQ</span></h2><h3><a name="h.pc6h0t76brdq"></a><span>Creating a New Chrome OS Core Platform</span></h3><p><span>Q: What Upstart jobs must my platform supply?</span></p><p><span>A: The platform must supply a </span><span>boot-complete</span><span> job conforming to certain basic requirements.</span></p><p><span>Q: What are the requirements for the </span><span>boot-complete</span><span> job?</span></p><p><span>A: The job must have a </span><span>start</span><span> stanza that will start once the </span><span>system application is up and providing service. Your platform can define “providing service” any way it wants, but generally the job shouldn’t start until these criteria are met:</span></p><ul><li><span>Performance critical startup is complete.</span></li><li><span>An ordinary user will perceive the device as fully functional.</span></li></ul><p><span>For reference, on Chrome OS, after stripping out comments and boilerplate, the </span><span>boot-complete</span><span> job consists of just this one line:</span></p><p><span> </span><span>start on login-prompt-visible</span></p><p><span>Q: How do I provide a </span><span>boot-complete.conf</span><span> for my board?</span></p><p><span>A: </span><span>boot-complete.conf</span><span> is provided by </span><span>virtual/chromeos-bootcomplete</span><span>. You can override this virtual in your board overlay.</span></p><p><span>Q: How do I disable/enable the </span><span><a href="boot-design.html#h.y4vr1c4hxx6o">encrypted stateful</a></span><span> feature?</span></p><p><span>A: The feature is enabled by default. To disable the feature, set USE=”-encrypted_stateful”.</span></p><h3><a name="h.j0392y7kabqr"></a><span>Adding a New Service</span></h3><p><span>Q: What repository should hold my Upstart job?</span></p><p><span>A: Ideally, the job should live in the source repository for the service it starts. </span><span>If there’s no such repository (e.g. your service is an upstream package), create a new package to install the job. For an example, see the </span><span>chromeos-base/openssh-server-init</span><span> package</span><span>.</span></p><p><span>Q: When should I use </span><span>start on started system-services</span><span>?</span></p><p><span>A: This is the preferred way to start any job that should run once at boot time. However, if your job is important to starting the system application, you may need to depend on </span><span>boot-services</span><span> instead.</span></p><p><span>Q: When should I use </span><span>start on started failsafe</span><span>?</span></p><p><span>A: Use this for a job that can start after the system application, but that must run eventually </span><span>even if the system application never starts</span><span>. </span><span>This start condition is most useful for services that are needed to debug or recover a failed unit.</span></p><p><span>Q: When should I use </span><span>start on started boot-services</span><span>?</span></p><p><span>A: Use this when the job must start in parallel with the system application. This is typically required for one of these reasons:</span></p><ul><li><span>The job is required before the system application can provide service, or</span></li><li><span>Until the job runs, the user may perceive the system as not functional.</span></li></ul><p><span>Note that by running in parallel with the system application, the job may slow down system boot.</span></p><p><span>Q: Can my service just use </span><span>start on startup</span><span>?</span></p><p><span>A: Most services should avoid doing this, because of the restrictions it imposes:</span></p><ul><li><span>There is no writable storage: directories like </span><span>/tmp</span><span>, </span><span>/home</span><span> and </span><span>/var</span><span> will not be mounted.</span></li><li><span>System logging is not available; the only way to debug is to write messages to a TTY device.</span></li><li><span>Not all devices will be available under </span><span>/dev</span><span>; no udev rules for any devices will have run.</span></li></ul><h2><a name="TOC-References"></a><span>References</span></h2><h1><a name="h.bbosx6272d19"></a></h1><p><span>Upstart reference: </span><span><a href="http://www.google.com/url?q=http%3A%2F%2Fupstart.ubuntu.com%2Fcookbook%2F&amp;sa=D&amp;sntz=1&amp;usg=AFQjCNGpjVTVPMdh6PDnB6VAAdvIshEqFQ">http://upstart.ubuntu.com/cookbook/</a></span></p><p><span>The ureadahead man page:  </span><span><a href="http://www.google.com/url?q=http%3A%2F%2Fmanpages.ubuntu.com%2Fmanpages%2Fprecise%2Fman8%2Fureadahead.8.html&amp;sa=D&amp;sntz=1&amp;usg=AFQjCNGq-lkbAxTEkiTp_Yc2moX8IPPY5g">http://manpages.ubuntu.com/manpages/precise/man8/ureadahead.8.html</a></span></p></div></div></td></tr></tbody></table>
</div> 
</div> 
<div id="sites-canvas-bottom-panel">
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_page-subpages"> </div>
<div id="sites-attachments-container">
</div>
<a xmlns="http://www.w3.org/1999/xhtml" name="page-comments"></a>
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_page-comments"><div class="sites-comment-docos-wrapper"><div class="sites-comment-docos"><div class="sites-comment-docos-background"></div><div class="sites-comment-docos-header"><div class="sites-comment-docos-header-title">Comments</div></div><div id="sites-comment-docos-pane" class="sites-comment-docos-pane"></div></div></div></div>
</div>
</div> 
</td> 
</tr>
</table> 
</div> 
</div> 
<div id="sites-chrome-footer-wrapper">
<div id="sites-chrome-footer-wrapper-inside">
<div id="sites-chrome-footer">
</div>
</div>
</div>
</div> 
</div> 
<div id="sites-chrome-adminfooter-container">
<div xmlns="http://www.w3.org/1999/xhtml" class="sites-adminfooter" role="navigation"><p><a class="sites-system-link" href="https://www.google.com/a/UniversalLogin?service=jotspot&amp;continue=http://sites.google.com/a/chromium.org/dev/chromium-os/chromiumos-design-docs/boot-design">Sign in</a><span aria-hidden="true">|</span><a class="sites-system-link" href="http://www.chromium.org/system/app/pages/recentChanges">Recent Site Activity</a><span aria-hidden="true">|</span><a class="sites-system-link" href="http://www.chromium.org/system/app/pages/reportAbuse" target="_blank">Report Abuse</a><span aria-hidden="true">|</span><a class="sites-system-link" href="javascript:;" onclick="window.open(webspace.printUrl)">Print Page</a><span aria-hidden="true">|</span><span class="sites-system-link">Powered By</span> <b class="powered-by"><a href="http://sites.google.com">Google Sites</a></b></p></div>
</div>
</div> 
</div> 
<div id="sites-chrome-onebar-footer">
</div>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
    window.jstiming.load.tick('sjl');
  </script>
<script xmlns="http://www.w3.org/1999/xhtml" src="http://www.gstatic.com/sites/p/56e332/system/js/jot_min_view__en.js"></script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
    window.jstiming.load.tick('jl');
  </script>
<script xmlns="http://www.w3.org/1999/xhtml">
      
          sites.core.Analytics.createTracker();
          sites.core.Analytics.trackPageview();
        
    </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
                    sites.Searchbox.initialize(
                        'sites-searchbox-search-button',
                        {"object":[]}['object'],
                        'search-site',
                        {"label":"Configure search options...","url":"/system/app/pages/admin/settings"});
                  </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
      gsites.HoverPopupMenu.createSiteDropdownMenus('sites-header-nav-dropdown', false);
    </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript" defer="true">
            JOT_setupNav("7648876402527094", "Navigation", false);
            JOT_addListener('titleChange', 'JOT_NAVIGATION_titleChange', 'COMP_7648876402527094');
          </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript" defer="true">
            JOT_setupNav("14720868319272995", "Quick links", false);
            JOT_addListener('titleChange', 'JOT_NAVIGATION_titleChange', 'COMP_14720868319272995');
          </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript" defer="true">
            JOT_setupNav("19690813310444355", "Other sites", false);
            JOT_addListener('titleChange', 'JOT_NAVIGATION_titleChange', 'COMP_19690813310444355');
          </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
              new sites.CommentPane('//docs.google.com/comments/d/AAHRpnXvrAwjAfmld0ObrebBiGRq974X02p8MGLRyfu8R3NTxlcRkNZlofYcv5fGPWZtTxSLEihk_lF4l6IZh6a8-D86bLLQcPId9lQUpeo9uIMbWXBoXOKkGFbT6rL_DGwhyxJujv905/api/js?anon=true',
                  false, false);
            </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
  setTimeout(function() {
    var fingerprint = gsites.date.TimeZone.getFingerprint([]);
    gsites.Xhr.send('http://www.chromium.org/_/tz', null, null, 'GET', null, null, { afjstz: fingerprint });
  }, 500);
</script>
<script xmlns="http://www.w3.org/1999/xhtml">
                    window.onload = function() {
                      if (false) {
                        JOT_setMobilePreview();
                      }
                      var loadTimer = window.jstiming.load;
                      loadTimer.tick("ol");
                      loadTimer["name"] = "load," + webspace.page.type + ",user_page";
                      window.jstiming.report(loadTimer, {}, 'http://csi.gstatic.com/csi');
                    }
                  </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
        JOT_insertAnalyticsCode(false,
            false);
      </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
    var maestroRunner = new gsites.pages.view.SitesMaestroRunner(
        webspace, "en");
    maestroRunner.initListeners();
    maestroRunner.installEditRender();
  </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript" defer="true">
  //<![CDATA[
    // Decorate any fastUI buttons on the page with a class of 'goog-button'.
    if (webspace.user.hasWriteAccess) {
      JOT_decorateButtons();
    }

    // Fires delayed events.
    (function() {
      JOT_fullyLoaded = true;
      var delayedEvents = JOT_delayedEvents;
      for (var x = 0; x < delayedEvents.length; x++) {
        var event = delayedEvents[x];
        JOT_postEvent(event.eventName, event.eventSrc, event.payload);
      }
      JOT_delayedEvents = null;
      JOT_postEvent('pageLoaded');
    })();
  //]]>
</script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
    JOT_postEvent('decorateGvizCharts');
  </script>
<script type="text/javascript">
          JOT_setupPostRenderingManager();
        </script>
<script type="text/javascript">
          JOT_postEvent('renderPlus', null, 'sites-chrome-main');
        </script>
<div id="server-timer-div" style="display:none"> </div>
<script type="text/javascript">
          window.jstiming.load.tick('render');
          JOT_postEvent('usercontentrendered', this);
        </script>
</body>
</html>
