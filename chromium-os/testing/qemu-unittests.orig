<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/WebPage">
<head>
<meta http-equiv="X-UA-Compatible" content="chrome=1" />
<script type="text/javascript">/* Copyright 2008 Google. */ (function() { var e="wtsrt_",g="tbsd_",h="tbnd_",k="start",l="_wtsrt",m="_tbnd",n="CSI/";(function(){function f(a){this.t={};this.tick=function(a,c,b){this.t[a]=[void 0!=b?b:(new Date).getTime(),c];if(void 0==b)try{window.console.timeStamp(n+a)}catch(d){}};this.tick(k,null,a)}var a;window.performance&&(a=window.performance.timing);var p=a?new f(a.responseStart):new f;window.jstiming={Timer:f,load:p};if(a){var c=a.navigationStart,d=a.responseStart;0<c&&d>=c&&(window.jstiming.srt=d-c)}if(a){var b=window.jstiming.load;0<c&&d>=c&&(b.tick(l,void 0,c),b.tick(e,l,d),b.tick(g,e))}try{a=null,
window.chrome&&window.chrome.csi&&(a=Math.floor(window.chrome.csi().pageT),b&&0<c&&(b.tick(m,void 0,window.chrome.csi().startE),b.tick(h,m,c))),null==a&&window.gtbExternal&&(a=window.gtbExternal.pageT()),null==a&&window.external&&(a=window.external.pageT,b&&0<c&&(b.tick(m,void 0,window.external.startE),b.tick(h,m,c))),a&&(window.jstiming.pt=a)}catch(q){}})(); })()
</script>
<link rel="shortcut icon" href="/_/rsrc/1354323194313/favicon.ico" type="image/x-icon" />
<link rel="apple-touch-icon" href="https://ssl.gstatic.com/sites/p/56e332/system/app/images/apple-touch-icon.png" type="image/png" />
<script type="text/javascript">/* Copyright 2008 Google. */ (function() { var d="",g="__duration__",h="function";function k(c){return document.getElementById(c)}window.byId=k;function l(c){return c.replace(/^\s+|\s+$/g,d)}window.trim=l;var m=[],n=0;window.JOT_addListener=function(c,a,b){var e=new String(n++);c={eventName:c,handler:a,compId:b,key:e};m.push(c);return e};window.JOT_removeListenerByKey=function(c){for(var a=0;a<m.length;a++)if(m[a].key==c){m.splice(a,1);break}};
window.JOT_removeAllListenersForName=function(c){for(var a=0;a<m.length;a++)m[a].eventName==c&&m.splice(a,1)};window.JOT_postEvent=function(c,a,b){var e={eventName:c,eventSrc:a||{},payload:b||{}};if(window.JOT_fullyLoaded)for(a=m.length,b=0;b<a&&b<m.length;b++){var f=m[b];f&&f.eventName==c&&(e.listenerCompId=f.compId||d,(f=typeof f.handler==h?f.handler:window[f.handler])&&f(e))}else window.JOT_delayedEvents.push({eventName:c,eventSrc:a,payload:b})};window.JOT_delayedEvents=[];
window.JOT_fullyLoaded=!1;window.JOT_formatRelativeToNow=function(c,a){var b=((new Date).getTime()-c)/6E4;if(1440<=b||0>b)return null;var e=0;60<=b&&(b/=60,e=2);2<=b&&e++;return a?window.JOT_siteRelTimeStrs[e].replace(g,Math.floor(b)):window.JOT_userRelTimeStrs[e].replace(g,Math.floor(b))}; })()
</script>
<script>

  

  var breadcrumbs = [{"path":"/chromium-os","deleted":false,"title":"Chromium OS","dir":"ltr"},{"path":"/chromium-os/testing","deleted":false,"title":"Testing Home","dir":"ltr"},{"path":"/chromium-os/testing/qemu-unittests","deleted":false,"title":"Running unittests via QEMU","dir":"ltr"}];
  var JOT_clearDotPath = 'https://ssl.gstatic.com/sites/p/56e332/system/app/images/cleardot.gif';

  
  var JOT_userRelTimeStrs = ["a minute ago","__duration__ minutes ago","an hour ago","__duration__ hours ago"];

  
  

  

  var webspace = {"enableAnalytics":true,"pageSharingId":"jotspot_page","enableUniversalAnalytics":false,"sharingPolicy":"OPENED_WITH_INDICATOR","siteTitle":"The Chromium Projects","isStartPageEnabled":true,"adsensePublisherId":null,"features":{"languageSelectDefaultTextSetToDefault":true,"validateClientGvizDataSourceUrls":true,"moreMobileStyleImprovements":true,"newInsertMenuIcons":true,"accessibleSortingButtons":true,"domainAnalyticsInGAOnly":true,"noCaptcha":true,"fileCabinetScreenReaderFix":true,"updatedTosAndPrivacyLinks":null,"pageDrafts":false,"mobileOrientationFix":true,"plusBadge":false,"pdfEmbedSupport":false,"jsClickFix":true},"isPublic":true,"isConsumer":false,"serverFlags":{"cajaBaseUrl":"//www.gstatic.com/caja","cajaDebugMode":false},"onepickBaseUrl":"https://docs.google.com","domainAnalyticsAccountId":"","plusPageId":"","signInUrl":"https://www.google.com/a/SelectSession?continue\u003dhttps://sites.google.com/a/chromium.org/dev/chromium-os/testing/qemu-unittests\u0026service\u003djotspot","analyticsAccountId":"UA-5484340-1","scottyUrl":"/_/upload","homePath":"/","siteNoticeUrlEnabled":null,"plusPageUrl":"","adsensePromoClickedOrSiteIneligible":true,"csiReportUri":"https://gg.google.com/csi","sharingId":"jotspot","termsUrl":"//www.google.com/intl/en/policies/terms/","gvizVersion":1,"editorResources":{"sitelayout":["https://ssl.gstatic.com/sites/p/56e332/system/app/css/sitelayouteditor.css"],"text":["https://ssl.gstatic.com/sites/p/56e332/system/js/codemirror.js","https://ssl.gstatic.com/sites/p/56e332/system/app/css/codemirror_css.css","https://ssl.gstatic.com/sites/p/56e332/system/js/trog_edit__en.js","https://ssl.gstatic.com/sites/p/56e332/system/app/css/trogedit.css","/_/rsrc/1441580320000/system/app/css/editor.css","https://ssl.gstatic.com/sites/p/56e332/system/app/css/codeeditor.css","/_/rsrc/1441580320000/system/app/css/camelot/editor-jfk-wlb.css"]},"sharingUrlPrefix":"/_/sharing","isAdsenseEnabled":true,"domain":"chromium.org","baseUri":"","name":"dev","siteTemplateId":false,"siteNoticeRevision":null,"siteNoticeUrlAddress":null,"siteNoticeMessage":null,"page":{"isRtlLocale":false,"canDeleteWebspace":null,"isPageDraft":null,"parentPath":"/chromium-os/testing","parentWuid":"wuid:gx:2e2ee5668f423109","siteLocale":"en","timeZone":"America/Los_Angeles","type":"text","title":"Running unittests via QEMU","locale":"en","wuid":"wuid:gx:2ee2fe463413ec28","revision":5,"path":"/chromium-os/testing/qemu-unittests","isSiteRtlLocale":false,"pageInheritsPermissions":null,"name":"qemu-unittests","canChangePath":true,"state":"","properties":{},"bidiEnabled":false,"currentTemplate":{"path":"/system/app/pagetemplates/text","title":"Web Page"}},"canPublishScriptToAnyone":true,"user":{"keyboardShortcuts":true,"sessionIndex":"","guest_":true,"displayNameOrEmail":"guest","userName":"guest","uid":"","renderMobile":false,"domain":"","namespace":"","hasWriteAccess":false,"namespaceUser":false,"primaryEmail":"guest","hasAdminAccess":false},"gadgets":{"baseUri":"/system/app/pages/gadgets"}};
  webspace.page.breadcrumbs = breadcrumbs;

  
  var JOT_siteRelTimeStrs = ["a minute ago","__duration__ minutes ago","an hour ago","__duration__ hours ago"];

</script>
<script type="text/javascript">
                window.jstiming.load.tick('scl');
              </script>
<meta name="title" content="Running unittests via QEMU - The Chromium Projects" />
<meta itemprop="name" content="Running unittests via QEMU - The Chromium Projects" />
<meta property="og:title" content="Running unittests via QEMU - The Chromium Projects" />
<meta name="description" content="Home of the Chromium Open Source Project" />
<meta itemprop="description" content="Home of the Chromium Open Source Project" />
<meta id="meta-tag-description" property="og:description" content="Home of the Chromium Open Source Project" />
<style type="text/css">
</style>
<link rel="stylesheet" type="text/css" href="https://ssl.gstatic.com/sites/p/56e332/system/app/themes/beigeandblue/standard-css-beigeandblue-ltr-ltr.css" />
<link rel="stylesheet" type="text/css" href="/_/rsrc/1441580320000/system/app/css/overlay.css?cb=beigeandblueundefineda100%25%25150goog-ws-leftthemedefaultstandard" />
<link rel="stylesheet" type="text/css" href="/_/rsrc/1441580320000/system/app/css/camelot/allthemes-view.css" />
<!--[if IE]>
          <link rel="stylesheet" type="text/css" href="/system/app/css/camelot/allthemes%2die.css" />
        <![endif]-->
<title>Running unittests via QEMU - The Chromium Projects</title>
<meta itemprop="image" content="/_/rsrc/1438879449147/config/customLogo.gif?revision=3" />
<meta property="og:image" content="/_/rsrc/1438879449147/config/customLogo.gif?revision=3" />
<script type="text/javascript">
                window.jstiming.load.tick('cl');
              </script>
</head>
<body xmlns="http://www.google.com/ns/jotspot" id="body" class=" en            ">
<div id="sites-page-toolbar" class="sites-header-divider">
<div xmlns="http://www.w3.org/1999/xhtml" id="sites-status" class="sites-status" style="display:none;"><div id="sites-notice" class="sites-notice" role="status" aria-live="assertive"> </div></div>
</div>
<div id="sites-chrome-everything-scrollbar">
<div id="sites-chrome-everything" class="">
<div id="sites-chrome-page-wrapper" style="direction: ltr">
<div id="sites-chrome-page-wrapper-inside">
<div xmlns="http://www.w3.org/1999/xhtml" id="sites-chrome-header-wrapper" style="height:auto;">
<table id="sites-chrome-header" class="sites-layout-hbox" cellspacing="0" style="height:auto;">
<tr class="sites-header-primary-row" id="sites-chrome-userheader">
<td id="sites-header-title" class="" role="banner"><div class="sites-header-cell-buffer-wrapper"><a href="https://www.chromium.org/" id="sites-chrome-userheader-logo"><img id="logo-img-id" src="/_/rsrc/1438879449147/config/customLogo.gif?revision=3" alt="The Chromium Projects" class="sites-logo  " /></a><h2><a href="https://www.chromium.org/" dir="ltr" id="sites-chrome-userheader-title">The Chromium Projects</a></h2></div></td><td class="sites-layout-searchbox  "><div class="sites-header-cell-buffer-wrapper"><form id="sites-searchbox-form" action="/system/app/pages/search" role="search"><input type="hidden" id="sites-searchbox-scope" name="scope" value="search-site" /><input type="text" id="jot-ui-searchInput" name="q" size="20" value="" aria-label="Search this site" /><div id="sites-searchbox-button-set" class="goog-inline-block"><div role="button" id="sites-searchbox-search-button" class="goog-inline-block jfk-button jfk-button-standard" tabindex="0">Search this site</div></div></form></div></td>
</tr>
<tr class="sites-header-secondary-row" id="sites-chrome-horizontal-nav">
<td colspan="2" id="sites-chrome-header-horizontal-nav-container" role="navigation">
</td>
</tr>
</table>
</div>
<div id="sites-chrome-main-wrapper">
<div id="sites-chrome-main-wrapper-inside">
<table id="sites-chrome-main" class="sites-layout-hbox" cellspacing="0" cellpadding="{scmCellpadding}" border="0">
<tr>
<td id="sites-chrome-sidebar-left" class="sites-layout-sidebar-left initial" style="width:150px">
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_7648876402527094" class="sites-embed" role="navigation"><div class="sites-embed-content sites-sidebar-nav"><ul role="navigation" jotId="navList"><li class="nav-first "><div dir="ltr" style="padding-left: 5px;"><a href="/chromium-projects" jotId="wuid:gx:10ae433dadbbab13" class="sites-navigation-link">Home</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="/Home" jotId="wuid:gx:43582b9d2029d3af" class="sites-navigation-link">Chromium</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="/chromium-os" jotId="wuid:gx:83df2ab1f8880ba" class="sites-navigation-link">Chromium OS</a></div></li></ul></div></div>
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_14720868319272995" class="sites-embed" role="navigation"><h4 class="sites-embed-title">Quick links</h4><div class="sites-embed-content sites-sidebar-nav"><ul role="navigation" jotId="navList"><li class="nav-first "><div dir="ltr" style="padding-left: 5px;"><a href="http://www.chromium.org/for-testers/bug-reporting-guidelines" class="sites-navigation-link">Report bugs</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="http://www.chromium.org/developers/discussion-groups" class="sites-navigation-link">Discuss</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="/system/app/pages/sitemap/hierarchy" jotId="wuid:gx:4c0f552cb393ed23" class="sites-navigation-link">Sitemap</a></div></li></ul></div></div>
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_19690813310444355" class="sites-embed" role="navigation"><h4 class="sites-embed-title">Other sites</h4><div class="sites-embed-content sites-sidebar-nav"><ul role="navigation" jotId="navList"><li class="nav-first "><div dir="ltr" style="padding-left: 5px;"><a href="http://blog.chromium.org/" class="sites-navigation-link">Chromium Blog</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="http://code.google.com/chrome/extensions/" class="sites-navigation-link">Google Chrome Extensions</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="https://developers.google.com/chrome/chrome-frame/" class="sites-navigation-link">Google Chrome Frame</a></div></li></ul></div></div>
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_19695218559354544" class="sites-embed" role="complementary"><h4 class="sites-embed-title"></h4><div class="sites-embed-content sites-embed-content-sidebar-textbox"><div dir="ltr"><span style="font-size:x-small">Except as otherwise </span><a href="http://developers.google.com/site-policies.html#restrictions"><span style="font-size:x-small">noted</span></a><span style="font-size:x-small">, the content of this page is licensed under a </span><a href="http://creativecommons.org/licenses/by/2.5/"><span style="font-size:x-small">Creative Commons Attribution 2.5 license</span></a><span style="font-size:x-small">, and examples are licensed under the </span><a href="http://src.chromium.org/viewvc/chrome/trunk/src/LICENSE" target="_blank"><span style="font-size:x-small">BSD License</span></a><span style="font-size:x-small">.<br /></span></div></div></div>
</td>
<td id="sites-canvas-wrapper">
<div id="sites-canvas" role="main">
<div id="goog-ws-editor-toolbar-container"> </div>
<div xmlns="http://www.w3.org/1999/xhtml" id="title-crumbs" style="">
<A href="/chromium-os" dir="ltr">Chromium OS</A>‎ &gt; ‎<A href="/chromium-os/testing" dir="ltr">Testing Home</A>‎ &gt; ‎
  </div>
<h3 xmlns="http://www.w3.org/1999/xhtml" id="sites-page-title-header" style="" align="left">
<span id="sites-page-title" dir="ltr" tabindex="-1" style="outline: none">Running unittests via QEMU</span>
</h3>
<div id="sites-canvas-main" class="sites-canvas-main">
<div id="sites-canvas-main-content">
<table xmlns="http://www.w3.org/1999/xhtml" cellspacing="0" class="sites-layout-name-one-column sites-layout-hbox"><tbody><tr><td class="sites-layout-tile sites-tile-name-content-1"><div dir="ltr"><div><div class="sites-embed-align-right-wrapping-on"><div class="sites-embed-border-off sites-embed" style="width:250px;"><div class="sites-embed-content sites-embed-type-toc"><div class="goog-toc sites-embed-toc-maxdepth-6"><p>Contents</p><ol class="goog-toc"><li class="goog-toc"><a href="#TOC-Preface"><strong>1 </strong>Preface</a></li><li class="goog-toc"><a href="#TOC-Introduction"><strong>2 </strong>Introduction</a></li><li class="goog-toc"><a href="#TOC-Technical-Details"><strong>3 </strong>Technical Details</a><ol class="goog-toc"><li class="goog-toc"><a href="#TOC-Sysroot-Setup"><strong>3.1 </strong>Sysroot Setup</a></li><li class="goog-toc"><a href="#TOC-QEMU-Setup"><strong>3.2 </strong>QEMU Setup</a></li><li class="goog-toc"><a href="#TOC-Registering-a-Binary-Format-Handler"><strong>3.3 </strong>Registering a Binary Format Handler</a><ol class="goog-toc"><li class="goog-toc"><a href="#TOC-Mount"><strong>3.3.1 </strong>Mount</a></li><li class="goog-toc"><a href="#TOC-Register"><strong>3.3.2 </strong>Register</a></li></ol></li><li class="goog-toc"><a href="#TOC-Bind-Mounts"><strong>3.4 </strong>Bind Mounts</a></li><li class="goog-toc"><a href="#TOC-Source-Tree-Setup"><strong>3.5 </strong>Source Tree Setup</a></li><li class="goog-toc"><a href="#TOC-Chroot-Execute"><strong>3.6 </strong>Chroot &amp; Execute</a></li></ol></li></ol></div></div></div></div></div><h2><a name="TOC-Preface"></a>Preface</h2><p>This doc covers technical details for how we run unittests for non-native architectures. It is geared towards people who want a deeper understanding of the overall system. If you simply want to execute your tests, see the <a href="https://www.chromium.org/chromium-os/testing/adding-unit-tests-to-the-build">Chromium OS Unit Testing</a> document instead.</p>
<h2><a name="TOC-Introduction"></a>Introduction</h2>
<p>Chromium OS has a number of interesting features:</p>
<ul><li>cross-compiling of everything (no native execution)</li>
<li>tests, both unit (API) and integration</li>
<li>support for a number of architectures (many of which are labeled as "embedded")</li></ul>
All of these taken together lead to an interesting state: we have a large code base and want to test it, but how can we do it without resorting to real hardware? Unit tests can be compiled and run using the SDK and gives us confidence in the API, but we're still not testing the code that'll run on the system (which has a number of implications). It also means we can't run fuller (integration) tests.

<p>The answers to our needs is <a href="http://qemu.org/">QEMU</a>. It allows us to run Linux programs compiled for a different architecture as if it were native code. It does mean we rely on QEMU's emulation of an architecture matching real hardware, but that's OK. If we find discrepancies, we can fix QEMU. In practice, the project is pretty stable.</p>
<p>There is also another semi-minor point that might occur to the more astute reader. What if the unittest wants to run another program itself? Say something as innocent as using the system() helper function? Won't that execute the host's /bin/sh and perhaps try to run target programs too? Indeed it will, but our system below accounts for it transparently! We certainly want to avoid having to modify code under test in ways that only get executed when testing.</p>
<p>Note that we are not doing full system emulation here. In that mode, we start off by booting a full kernel, and then userspace, and then running programs. Here we are just executing the unittests directly, and QEMU takes care of converting system calls from the target to the host and vice versa.</p>
<h2><a name="TOC-Technical-Details"></a>Technical Details</h2>
<p>The overall process boils down to:</p>
<ul><li>set up a full sysroot of libraries/programs</li>
<li>set up qemu inside of the chroot</li>
<li>register a handler for the target ELF</li>
<li>set up bind mounts for important file systems</li>
<li>make sure the unittests and necessary files are available inside the sysroot</li>
<li>chroot into the sysroot and use qemu to run the unittest</li></ul><p>
We also have to keep in mind that our testsuite might be running in parallel with other testsuites. And that a testsuite may have multiple unittests which also might be running in parallel. So we have to be careful to not mess with resources that are shared among the whole system otherwise things will be racy and randomly fail. Flaky tests are terrible.</p><p><span style="font-size:13.3333330154419px">Note: All of the setup described below is handled by chromite's </span><a href="https://chromium.googlesource.com/chromiumos/chromite/+/master/lib/qemu.py" style="font-size:13.3333330154419px">qemu python module</a><span style="font-size:13.3333330154419px"> now. The shell code below is more for reference.</span></p><div>
<h3><a name="TOC-Sysroot-Setup"></a>Sysroot Setup</h3>
<p>As part of the Chromium OS build system, we always have a full sysroot available for a target board (created by <code>build_packages</code>). This is usually found in the /board/$BOARD/ path inside of the sdk. We need this anyways in order to compile packages for the target.</p>
<p>The sysroot is not generally directly bootable, but that doesn't matter to us. We just need to be able to chroot into it.</p>
<h3><a name="TOC-QEMU-Setup"></a>QEMU Setup</h3>
<p>We ship a copy of QEMU inside the chroot already, and we make sure it is statically linked. This lets us easily copy it into a sysroot and run it inside of a chroot without having to copy any other files.</p>
<div class="sites-codeblock sites-codesnippet-block">
<code>arch="arm"</code><br />
<code>name="qemu-${arch}"</code><br />
<code>qemu_src_path="/usr/bin/${name}"</code><br />
<code>qemu_sysroot_path="/build/${BOARD}/build/bin/${name}"</code><br />
<br />
<code># Make sure the files are the same. This let's us easily update qemu in the</code><br />
<code># chroot without having to worry about keeping all the sysroots up-to-date.</code><br />
<code>if [ $(stat -c %i "${qemu_src_path}" 2&gt;/dev/null) != $(stat -c %i "${qemu_sysroot_path}" 2&gt;/dev/null) ]; then</code><br />
<code>    # Do the update atomically. We'll hardlink to a unique path, and then use `mv` to do</code><br />
<code>    # a rename() for us. Since it's on the same device, we know it'll be atomic.</code><br />
<code>    ln -fT "${qemu_src_path}" "${qemu_sysroot_path}.$$"</code><br />
<code>    mv -fT "${qemu_sysroot_path}.$$" "${qemu_sysroot_path}"</code><br />
<code>fi</code>
</div>
<h3><a name="TOC-Registering-a-Binary-Format-Handler"></a>Registering a Binary Format Handler</h3>
<p>The Linux kernel provides a nifty pseudo filesystems called <code><a href="https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/Documentation/binfmt_misc.txt">binfmt_misc</a></code>. This allows you to directly execute files that are normally not natively executable. For example, you could configure the system so that whenever you run a Windows exe program, it'll automatically invoke <a href="http://www.winehq.org/">Wine</a> for you. It simplifies the overall process. In our case, we'll register handlers so that QEMU is automatically executed whenever we try to run one of these target ELFs.</p>
<h4><a name="TOC-Mount"></a>Mount</h4>
<p>First we mount the filesystem if it is not yet mounted:</p>
<div class="sites-codeblock sites-codesnippet-block">
<code># mount -t binfmt_misc binfmt_misc /proc/sys/fs/binfmt_misc</code>
</div>
<p>If this errors out with EBUSY, we should check to see if it has been mounted already. This way parallel testsuites can safely execute this.</p>
<h4><a name="TOC-Register"></a>Register</h4>
<p>All handlers are registered by name (and the name is arbitrary). You can check by name by looking at <code>/proc/sys/fs/binfmt_misc/&lt;name&gt;</code>. If it already exists, we need to make sure it points to our interpreter. If it doesn't, we have to unregister &amp; re-register it. This phase is a little racy, but should rarely (if ever) happen, so we'll just ignore the issue here.</p>
<div class="sites-codeblock sites-codesnippet-block">
<code># This magic string registers the ARM ELF format and tells it to use qemu to run.<br />
arch="arm"<br />
name="qemu-${arch}"<br />
qemu_path="/build/bin/${name}"<br />
qemu_magic=":${arch}:M::\x7fELF\x01\x01\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x02\x00\x28\x00:\xff\xff\xff\xff\xff\xff\xff\x00\xff\xff\xff\xff\xff\xff\xff\xff\xfe\xff\xff\xff:${qemu_path}:"<br />
<br />
binfmt_path="/proc/sys/fs/binfmt_misc/${name}"<br />
<br />
if [[ -e ${binfmt_path} ]]; then<br />
    # Make sure the existing registration matches.<br />
    if [[ $(awk '$1 == "interpreter" {print $NF}' "${binfmt_path}") != "${qemu_path}" ]]; then<br />
    </code><code>    # Unregister it since there's a mismatch (maybe due to upgrade?).<br />
    </code><code>    echo -1 | sudo tee "${binfmt_path}"<br />
    fi<br />
fi<br />
<br />
if [[ -e ${binfmt_path} ]]; then<br />
    # Register it since it doesn't yet exist.<br />
    # We should ignore errors EBUSY at this point in case we run in parallel.<br />
    echo "${qemu_magic}" | sudo tee "/proc/sys/fs/binfmt_misc/register"<br />
fi</code>
</div>
<h3><a name="TOC-Bind-Mounts"></a>Bind Mounts</h3>
<p>Linux programs often want some basic filesystems available in order to run. We bind mount them here to simplify things.
</p>
<p>Normally the process would be to do these in a setup script that'd tail into running the unittests. That way we can use the unshare utility to run the unittest in its own mount namespace which allows us to create as many mounts as we want without impacting other processes (like unittests running in parallel).</p>
<div class="sites-codeblock sites-codesnippet-block"><code>#!/bin/sh<br />
</code><code># Make sure they've told us where to set things up.</code><br />
<code>if [ -z "${SYSROOT}" ]; then</code><br />
<code>    echo "You must set \$SYSROOT first"</code><br />
<code>    exit 1</code><br />
<code>fi</code><br />
<br />
<code># Re-exec ourselves as root in a new mount namespace.</code><br />
<code>[ -z "${_UNSHARE}" ] &amp;&amp; exec sudo unshare -m -- "$0" "$@"</code><br />
<br />
<code># Do all the bind mounts we need.</code><br />
<code>mount -n --bind /proc "${SYSROOT}"/proc</code><br />
<code>mount -n --bind /dev "${SYSROOT}"/dev</code><br />
<code>mount -n --bind /dev/pts "${SYSROOT}"/dev/pts</code><br />
<code>mount -n --bind /sys "${SYSROOT}"/sys</code><br />
<br />
<code># Run the unittest now.</code><br />
<code>exec chroot "${SYSROOT}" -- "$@"</code></div>
<h3><a name="TOC-Source-Tree-Setup"></a>Source Tree Setup</h3>
<p>Since the Chromium OS build system builds all packages inside of the sysroot already (typically /build/$BOARD/tmp/portage/...), we already have the files available to us. We simply need to use paths relative to inside the sysroot.</p>
<h3><a name="TOC-Chroot-Execute"></a>Chroot &amp; Execute</h3>
<p>Using the script from above, we can now run unittests inside the sysroot. It'll take care of the sysroots and stuff for us.</p>
<div class="sites-codeblock sites-codesnippet-block"><code># ./helper-script.sh /tmp/portage/.../unittest</code></div></div></div></td></tr></tbody></table>
</div> 
</div> 
<div id="sites-canvas-bottom-panel">
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_page-subpages"> </div>
<div id="sites-attachments-container">
</div>
<a xmlns="http://www.w3.org/1999/xhtml" name="page-comments"></a>
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_page-comments"><div class="sites-comment-docos-wrapper"><div class="sites-comment-docos"><div class="sites-comment-docos-background"></div><div class="sites-comment-docos-header"><div class="sites-comment-docos-header-title">Comments</div></div><div id="sites-comment-docos-pane" class="sites-comment-docos-pane"></div></div></div></div>
</div>
</div> 
</td> 
</tr>
</table> 
</div> 
</div> 
<div id="sites-chrome-footer-wrapper">
<div id="sites-chrome-footer-wrapper-inside">
<div id="sites-chrome-footer">
</div>
</div>
</div>
</div> 
</div> 
<div id="sites-chrome-adminfooter-container">
<div xmlns="http://www.w3.org/1999/xhtml" class="sites-adminfooter" role="navigation"><p><a class="sites-system-link" href="https://www.google.com/a/UniversalLogin?service=jotspot&amp;continue=https://sites.google.com/a/chromium.org/dev/chromium-os/testing/qemu-unittests">Sign in</a><span aria-hidden="true">|</span><a class="sites-system-link" href="/system/app/pages/recentChanges">Recent Site Activity</a><span aria-hidden="true">|</span><a class="sites-system-link" href="/system/app/pages/reportAbuse" target="_blank">Report Abuse</a><span aria-hidden="true">|</span><a class="sites-system-link" href="javascript:;" onclick="window.open(webspace.printUrl)">Print Page</a><span aria-hidden="true">|</span><span class="sites-system-link">Powered By</span> <b class="powered-by"><a href="http://sites.google.com">Google Sites</a></b></p></div>
</div>
</div> 
</div> 
<div id="sites-chrome-onebar-footer">
</div>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
    window.jstiming.load.tick('sjl');
  </script>
<script xmlns="http://www.w3.org/1999/xhtml" src="https://ssl.gstatic.com/sites/p/56e332/system/js/jot_min_view__en.js"></script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
    window.jstiming.load.tick('jl');
  </script>
<script xmlns="http://www.w3.org/1999/xhtml">
      
          sites.core.Analytics.createTracker();
          sites.core.Analytics.trackPageview();
        
    </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
                    sites.Searchbox.initialize(
                        'sites-searchbox-search-button',
                        {"object":[]}['object'],
                        'search-site',
                        {"label":"Configure search options...","url":"/system/app/pages/admin/settings"});
                  </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
      gsites.HoverPopupMenu.createSiteDropdownMenus('sites-header-nav-dropdown', false);
    </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript" defer="true">
            JOT_setupNav("7648876402527094", "Navigation", false);
            JOT_addListener('titleChange', 'JOT_NAVIGATION_titleChange', 'COMP_7648876402527094');
          </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript" defer="true">
            JOT_setupNav("14720868319272995", "Quick links", false);
            JOT_addListener('titleChange', 'JOT_NAVIGATION_titleChange', 'COMP_14720868319272995');
          </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript" defer="true">
            JOT_setupNav("19690813310444355", "Other sites", false);
            JOT_addListener('titleChange', 'JOT_NAVIGATION_titleChange', 'COMP_19690813310444355');
          </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
              new sites.CommentPane('//docs.google.com/comments/d/AAHRpnXvrAwjAfmld0ObrebBiGRq9Vmtb75pASWFZ_XXHaivUo2FPOMXvelkZbd3RrlG3hMAsy3GAUv3J1tMsK_Vmc32W7_QTK54sA9yCOjQUlLdCFbsLchvfM--1UBJYLvloLJtYfSXr/api/js?anon=true',
                  false, false);
            </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
  setTimeout(function() {
    var fingerprint = gsites.date.TimeZone.getFingerprint([]);
    gsites.Xhr.send('https://www.chromium.org/_/tz', null, null, 'GET', null, null, { afjstz: fingerprint });
  }, 500);
</script>
<script xmlns="http://www.w3.org/1999/xhtml">
                    window.onload = function() {
                      if (false) {
                        JOT_setMobilePreview();
                      }
                      var loadTimer = window.jstiming.load;
                      loadTimer.tick("ol");
                      loadTimer["name"] = "load," + webspace.page.type + ",user_page";
                      window.jstiming.report(loadTimer, {}, 'https://gg.google.com/csi');
                    }
                  </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
        JOT_insertAnalyticsCode(false,
            false);
      </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
    var maestroRunner = new gsites.pages.view.SitesMaestroRunner(
        webspace, "en");
    maestroRunner.initListeners();
    maestroRunner.installEditRender();
  </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript" defer="true">
  //<![CDATA[
    // Decorate any fastUI buttons on the page with a class of 'goog-button'.
    if (webspace.user.hasWriteAccess) {
      JOT_decorateButtons();
    }

    // Fires delayed events.
    (function() {
      JOT_fullyLoaded = true;
      var delayedEvents = JOT_delayedEvents;
      for (var x = 0; x < delayedEvents.length; x++) {
        var event = delayedEvents[x];
        JOT_postEvent(event.eventName, event.eventSrc, event.payload);
      }
      JOT_delayedEvents = null;
      JOT_postEvent('pageLoaded');
    })();
  //]]>
</script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
    JOT_postEvent('decorateGvizCharts');
  </script>
<script type="text/javascript">
          JOT_setupPostRenderingManager();
        </script>
<script type="text/javascript">
          JOT_postEvent('renderPlus', null, 'sites-chrome-main');
        </script>
<div id="server-timer-div" style="display:none"> </div>
<script type="text/javascript">
          window.jstiming.load.tick('render');
          JOT_postEvent('usercontentrendered', this);
        </script>
</body>
</html>
