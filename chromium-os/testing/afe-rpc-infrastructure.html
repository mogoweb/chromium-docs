<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" itemscope="" itemtype="http://schema.org/WebPage">
<head>
<meta http-equiv="X-UA-Compatible" content="chrome=1" />
<script type="text/javascript">/* Copyright 2008 Google. */ (function() { var e="wtsrt_",g="tbsd_",h="tbnd_",k="start",l="_wtsrt",m="_tbnd",n="CSI/";(function(){function f(a){this.t={};this.tick=function(a,c,b){this.t[a]=[void 0!=b?b:(new Date).getTime(),c];if(void 0==b)try{window.console.timeStamp(n+a)}catch(d){}};this.tick(k,null,a)}var a;window.performance&&(a=window.performance.timing);var p=a?new f(a.responseStart):new f;window.jstiming={Timer:f,load:p};if(a){var c=a.navigationStart,d=a.responseStart;0<c&&d>=c&&(window.jstiming.srt=d-c)}if(a){var b=window.jstiming.load;0<c&&d>=c&&(b.tick(l,void 0,c),b.tick(e,l,d),b.tick(g,e))}try{a=null,
window.chrome&&window.chrome.csi&&(a=Math.floor(window.chrome.csi().pageT),b&&0<c&&(b.tick(m,void 0,window.chrome.csi().startE),b.tick(h,m,c))),null==a&&window.gtbExternal&&(a=window.gtbExternal.pageT()),null==a&&window.external&&(a=window.external.pageT,b&&0<c&&(b.tick(m,void 0,window.external.startE),b.tick(h,m,c))),a&&(window.jstiming.pt=a)}catch(q){}})(); })()
</script>
<link rel="shortcut icon" href="../../_/rsrc/1354323194313/favicon.ico" type="image/x-icon" />
<link rel="apple-touch-icon" href="https://ssl.gstatic.com/sites/p/56e332/system/app/images/apple-touch-icon.png" type="image/png" />
<script type="text/javascript">/* Copyright 2008 Google. */ (function() { var d="",g="__duration__",h="function";function k(c){return document.getElementById(c)}window.byId=k;function l(c){return c.replace(/^\s+|\s+$/g,d)}window.trim=l;var m=[],n=0;window.JOT_addListener=function(c,a,b){var e=new String(n++);c={eventName:c,handler:a,compId:b,key:e};m.push(c);return e};window.JOT_removeListenerByKey=function(c){for(var a=0;a<m.length;a++)if(m[a].key==c){m.splice(a,1);break}};
window.JOT_removeAllListenersForName=function(c){for(var a=0;a<m.length;a++)m[a].eventName==c&&m.splice(a,1)};window.JOT_postEvent=function(c,a,b){var e={eventName:c,eventSrc:a||{},payload:b||{}};if(window.JOT_fullyLoaded)for(a=m.length,b=0;b<a&&b<m.length;b++){var f=m[b];f&&f.eventName==c&&(e.listenerCompId=f.compId||d,(f=typeof f.handler==h?f.handler:window[f.handler])&&f(e))}else window.JOT_delayedEvents.push({eventName:c,eventSrc:a,payload:b})};window.JOT_delayedEvents=[];
window.JOT_fullyLoaded=!1;window.JOT_formatRelativeToNow=function(c,a){var b=((new Date).getTime()-c)/6E4;if(1440<=b||0>b)return null;var e=0;60<=b&&(b/=60,e=2);2<=b&&e++;return a?window.JOT_siteRelTimeStrs[e].replace(g,Math.floor(b)):window.JOT_userRelTimeStrs[e].replace(g,Math.floor(b))}; })()
</script>
<script>

  

  var breadcrumbs = [{"path":"/chromium-os","deleted":false,"title":"Chromium OS","dir":"ltr"},{"path":"/chromium-os/testing","deleted":false,"title":"Testing Home","dir":"ltr"},{"path":"/chromium-os/testing/afe-rpc-infrastructure","deleted":false,"title":"AFE RPC Infrastructure","dir":"ltr"}];
  var JOT_clearDotPath = 'https://ssl.gstatic.com/sites/p/56e332/system/app/images/cleardot.gif';

  
  var JOT_userRelTimeStrs = ["a minute ago","__duration__ minutes ago","an hour ago","__duration__ hours ago"];

  
  

  

  var webspace = {"enableAnalytics":true,"pageSharingId":"jotspot_page","enableUniversalAnalytics":false,"sharingPolicy":"OPENED_WITH_INDICATOR","siteTitle":"The Chromium Projects","isStartPageEnabled":true,"adsensePublisherId":null,"features":{"languageSelectDefaultTextSetToDefault":true,"validateClientGvizDataSourceUrls":true,"moreMobileStyleImprovements":true,"newInsertMenuIcons":true,"accessibleSortingButtons":true,"domainAnalyticsInGAOnly":true,"noCaptcha":true,"fileCabinetScreenReaderFix":true,"updatedTosAndPrivacyLinks":null,"pageDrafts":false,"mobileOrientationFix":true,"plusBadge":false,"pdfEmbedSupport":false,"jsClickFix":true},"isPublic":true,"isConsumer":false,"serverFlags":{"cajaBaseUrl":"//www.gstatic.com/caja","cajaDebugMode":false},"onepickBaseUrl":"https://docs.google.com","domainAnalyticsAccountId":"","plusPageId":"","signInUrl":"https://www.google.com/a/SelectSession?continue\u003dhttps://sites.google.com/a/chromium.org/dev/chromium-os/testing/afe-rpc-infrastructure\u0026service\u003djotspot","analyticsAccountId":"UA-5484340-1","scottyUrl":"/_/upload","homePath":"/","siteNoticeUrlEnabled":null,"plusPageUrl":"","adsensePromoClickedOrSiteIneligible":true,"csiReportUri":"https://gg.google.com/csi","sharingId":"jotspot","termsUrl":"//www.google.com/intl/en/policies/terms/","gvizVersion":1,"editorResources":{"sitelayout":["https://ssl.gstatic.com/sites/p/56e332/system/app/css/sitelayouteditor.css"],"text":["https://ssl.gstatic.com/sites/p/56e332/system/js/codemirror.js","https://ssl.gstatic.com/sites/p/56e332/system/app/css/codemirror_css.css","https://ssl.gstatic.com/sites/p/56e332/system/js/trog_edit__en.js","https://ssl.gstatic.com/sites/p/56e332/system/app/css/trogedit.css","/_/rsrc/1441580320000/system/app/css/editor.css","https://ssl.gstatic.com/sites/p/56e332/system/app/css/codeeditor.css","/_/rsrc/1441580320000/system/app/css/camelot/editor-jfk-wlb.css"]},"sharingUrlPrefix":"/_/sharing","isAdsenseEnabled":true,"domain":"chromium.org","baseUri":"","name":"dev","siteTemplateId":false,"siteNoticeRevision":null,"siteNoticeUrlAddress":null,"siteNoticeMessage":null,"page":{"isRtlLocale":false,"canDeleteWebspace":null,"isPageDraft":null,"parentPath":"/chromium-os/testing","parentWuid":"wuid:gx:2e2ee5668f423109","siteLocale":"en","timeZone":"America/Los_Angeles","type":"text","title":"AFE RPC Infrastructure","locale":"en","wuid":"wuid:gx:6195c25db010754d","revision":2,"path":"/chromium-os/testing/afe-rpc-infrastructure","isSiteRtlLocale":false,"pageInheritsPermissions":null,"name":"afe-rpc-infrastructure","canChangePath":true,"state":"","properties":{},"bidiEnabled":false,"currentTemplate":{"path":"/system/app/pagetemplates/text","title":"Web Page"}},"canPublishScriptToAnyone":true,"user":{"keyboardShortcuts":true,"sessionIndex":"","guest_":true,"displayNameOrEmail":"guest","userName":"guest","uid":"","renderMobile":false,"domain":"","namespace":"","hasWriteAccess":false,"namespaceUser":false,"primaryEmail":"guest","hasAdminAccess":false},"gadgets":{"baseUri":"/system/app/pages/gadgets"}};
  webspace.page.breadcrumbs = breadcrumbs;

  
  var JOT_siteRelTimeStrs = ["a minute ago","__duration__ minutes ago","an hour ago","__duration__ hours ago"];

</script>
<script type="text/javascript">
                window.jstiming.load.tick('scl');
              </script>
<meta name="title" content="AFE RPC Infrastructure - The Chromium Projects" />
<meta itemprop="name" content="AFE RPC Infrastructure - The Chromium Projects" />
<meta property="og:title" content="AFE RPC Infrastructure - The Chromium Projects" />
<meta name="description" content="Home of the Chromium Open Source Project" />
<meta itemprop="description" content="Home of the Chromium Open Source Project" />
<meta id="meta-tag-description" property="og:description" content="Home of the Chromium Open Source Project" />
<style type="text/css">
</style>
<link rel="stylesheet" type="text/css" href="https://ssl.gstatic.com/sites/p/56e332/system/app/themes/beigeandblue/standard-css-beigeandblue-ltr-ltr.css" />
<link rel="stylesheet" type="text/css" href="../../_/rsrc/1441580320000/system/app/css/overlay.css%3Fcb=beigeandblueundefineda100%2525%2525150goog-ws-leftthemedefaultstandard.css" />
<link rel="stylesheet" type="text/css" href="../../_/rsrc/1441580320000/system/app/css/camelot/allthemes-view.css" />
<!--[if IE]>
          <link rel="stylesheet" type="text/css" href="/system/app/css/camelot/allthemes%2die.css" />
        <![endif]-->
<title>AFE RPC Infrastructure - The Chromium Projects</title>
<meta itemprop="image" content="/_/rsrc/1438879449147/config/customLogo.gif?revision=3" />
<meta property="og:image" content="/_/rsrc/1438879449147/config/customLogo.gif?revision=3" />
<script type="text/javascript">
                window.jstiming.load.tick('cl');
              </script>
</head>
<body xmlns="http://www.google.com/ns/jotspot" id="body" class=" en            ">
<div id="sites-page-toolbar" class="sites-header-divider">
<div xmlns="http://www.w3.org/1999/xhtml" id="sites-status" class="sites-status" style="display:none;"><div id="sites-notice" class="sites-notice" role="status" aria-live="assertive"> </div></div>
</div>
<div id="sites-chrome-everything-scrollbar">
<div id="sites-chrome-everything" class="">
<div id="sites-chrome-page-wrapper" style="direction: ltr">
<div id="sites-chrome-page-wrapper-inside">
<div xmlns="http://www.w3.org/1999/xhtml" id="sites-chrome-header-wrapper" style="height:auto;">
<table id="sites-chrome-header" class="sites-layout-hbox" cellspacing="0" style="height:auto;">
<tr class="sites-header-primary-row" id="sites-chrome-userheader">
<td id="sites-header-title" class="" role="banner"><div class="sites-header-cell-buffer-wrapper"><a href="../../index.html" id="sites-chrome-userheader-logo"><img id="logo-img-id" src="../../_/rsrc/1438879449147/config/customLogo.gif%3Frevision=3" alt="The Chromium Projects" class="sites-logo  " /></a><h2><a href="../../index.html" dir="ltr" id="sites-chrome-userheader-title">The Chromium Projects</a></h2></div></td><td class="sites-layout-searchbox  "><div class="sites-header-cell-buffer-wrapper"><form id="sites-searchbox-form" action="https://www.chromium.org/system/app/pages/search" role="search"><input type="hidden" id="sites-searchbox-scope" name="scope" value="search-site" /><input type="text" id="jot-ui-searchInput" name="q" size="20" value="" aria-label="Search this site" /><div id="sites-searchbox-button-set" class="goog-inline-block"><div role="button" id="sites-searchbox-search-button" class="goog-inline-block jfk-button jfk-button-standard" tabindex="0">Search this site</div></div></form></div></td>
</tr>
<tr class="sites-header-secondary-row" id="sites-chrome-horizontal-nav">
<td colspan="2" id="sites-chrome-header-horizontal-nav-container" role="navigation">
</td>
</tr>
</table>
</div>
<div id="sites-chrome-main-wrapper">
<div id="sites-chrome-main-wrapper-inside">
<table id="sites-chrome-main" class="sites-layout-hbox" cellspacing="0" cellpadding="{scmCellpadding}" border="0">
<tr>
<td id="sites-chrome-sidebar-left" class="sites-layout-sidebar-left initial" style="width:150px">
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_7648876402527094" class="sites-embed" role="navigation"><div class="sites-embed-content sites-sidebar-nav"><ul role="navigation" jotId="navList"><li class="nav-first "><div dir="ltr" style="padding-left: 5px;"><a href="../../chromium-projects.html" jotId="wuid:gx:10ae433dadbbab13" class="sites-navigation-link">Home</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="../../Home.1.html" jotId="wuid:gx:43582b9d2029d3af" class="sites-navigation-link">Chromium</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="../../chromium-os.1.html" jotId="wuid:gx:83df2ab1f8880ba" class="sites-navigation-link">Chromium OS</a></div></li></ul></div></div>
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_14720868319272995" class="sites-embed" role="navigation"><h4 class="sites-embed-title">Quick links</h4><div class="sites-embed-content sites-sidebar-nav"><ul role="navigation" jotId="navList"><li class="nav-first "><div dir="ltr" style="padding-left: 5px;"><a href="../../for-testers/bug-reporting-guidelines.html" class="sites-navigation-link">Report bugs</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="../../developers/discussion-groups.html" class="sites-navigation-link">Discuss</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="../../system/app/pages/sitemap/hierarchy.html" jotId="wuid:gx:4b58a9a350ad12f" class="sites-navigation-link">网站地图</a></div></li></ul></div></div>
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_19690813310444355" class="sites-embed" role="navigation"><h4 class="sites-embed-title">Other sites</h4><div class="sites-embed-content sites-sidebar-nav"><ul role="navigation" jotId="navList"><li class="nav-first "><div dir="ltr" style="padding-left: 5px;"><a href="http://blog.chromium.org/" class="sites-navigation-link">Chromium Blog</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="http://code.google.com/chrome/extensions/" class="sites-navigation-link">Google Chrome Extensions</a></div></li><li class=""><div dir="ltr" style="padding-left: 5px;"><a href="https://developers.google.com/chrome/chrome-frame/" class="sites-navigation-link">Google Chrome Frame</a></div></li></ul></div></div>
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_19695218559354544" class="sites-embed" role="complementary"><h4 class="sites-embed-title"></h4><div class="sites-embed-content sites-embed-content-sidebar-textbox"><div dir="ltr"><span style="font-size:x-small">Except as otherwise </span><a href="http://developers.google.com/site-policies.html#restrictions"><span style="font-size:x-small">noted</span></a><span style="font-size:x-small">, the content of this page is licensed under a </span><a href="http://creativecommons.org/licenses/by/2.5/"><span style="font-size:x-small">Creative Commons Attribution 2.5 license</span></a><span style="font-size:x-small">, and examples are licensed under the </span><a href="http://src.chromium.org/viewvc/chrome/trunk/src/LICENSE" target="_blank"><span style="font-size:x-small">BSD License</span></a><span style="font-size:x-small">.<br /></span></div></div></div>
</td>
<td id="sites-canvas-wrapper">
<div id="sites-canvas" role="main">
<div id="goog-ws-editor-toolbar-container"> </div>
<div xmlns="http://www.w3.org/1999/xhtml" id="title-crumbs" style="">
<A href="../../chromium-os.1.html" dir="ltr">Chromium OS</A>‎ &gt; ‎<A href="../testing.1.html" dir="ltr">Testing Home</A>‎ &gt; ‎
  </div>
<h3 xmlns="http://www.w3.org/1999/xhtml" id="sites-page-title-header" style="" align="left">
<span id="sites-page-title" dir="ltr" tabindex="-1" style="outline: none">AFE RPC Infrastructure</span>
</h3>
<div id="sites-canvas-main" class="sites-canvas-main">
<div id="sites-canvas-main-content">
<table xmlns="http://www.w3.org/1999/xhtml" cellspacing="0" class="sites-layout-name-one-column sites-layout-hbox"><tbody><tr><td class="sites-layout-tile sites-tile-name-content-1"><div dir="ltr"><span style="font-family:Times New Roman;font-size:medium"><h1 dir="ltr" style="line-height:1.575;margin-top:23pt;margin-bottom:23pt"><a name="TOC-Infrastructure"></a><span style="font-family:Arial;font-size:15px;white-space:pre-wrap;line-height:1.575">Infrastructure</span></h1><p dir="ltr" style="line-height:1.575;margin-top:0pt;margin-bottom:10pt"><span style="font-size:13px;font-family:Arial;vertical-align:baseline;white-space:pre-wrap">Our RPCs are served by apache running on cautotest using django's ability to map python's functions to URLs. In </span><span style="font-size:13px;font-family:Courier New;vertical-align:baseline;white-space:pre-wrap">frontend/afe/urls.py</span><span style="font-size:13px;font-family:Arial;vertical-align:baseline;white-space:pre-wrap"> we end up mapping </span><span style="font-size:13px;font-family:Courier New;vertical-align:baseline;white-space:pre-wrap">/rpc/</span><span style="font-size:13px;font-family:Arial;vertical-align:baseline;white-space:pre-wrap"> to </span><span style="font-size:13px;font-family:Courier New;vertical-align:baseline;white-space:pre-wrap">frontend/afe/views.py:handle_rpc()</span><span style="font-size:13px;font-family:Arial;vertical-align:baseline;white-space:pre-wrap"> via the </span><span style="font-size:13px;font-family:Courier New;vertical-align:baseline;white-space:pre-wrap">generate_patterns()</span><span style="font-size:13px;font-family:Arial;vertical-align:baseline;white-space:pre-wrap"> call in </span><span style="font-size:13px;font-family:Courier New;vertical-align:baseline;white-space:pre-wrap">frontend/urls_common.py</span><span style="font-size:13px;font-family:Arial;vertical-align:baseline;white-space:pre-wrap">. The </span><span style="font-size:13px;font-family:Courier New;vertical-align:baseline;white-space:pre-wrap">handle_rpc</span><span style="font-size:13px;font-family:Arial;vertical-align:baseline;white-space:pre-wrap"> view very quickly bails out to the code in </span><span style="font-size:13px;font-family:Courier New;vertical-align:baseline;white-space:pre-wrap">frontend/afe/rpc_handler.py</span><span style="font-size:13px;font-family:Arial;vertical-align:baseline;white-space:pre-wrap">, which pulls all functions defined in  </span><span style="font-size:13px;font-family:Courier New;vertical-align:baseline;white-space:pre-wrap">frontend/afe/rpc_interface.py</span><span style="font-size:13px;font-family:Arial;vertical-align:baseline;white-space:pre-wrap"> or </span><span style="font-size:13px;font-family:Courier New;vertical-align:baseline;white-space:pre-wrap">frontend/afe/site_rpc_interface.py</span><span style="font-size:13px;font-family:Arial;vertical-align:baseline;white-space:pre-wrap">, and then exposes them as RPCs.</span></p><p dir="ltr" style="line-height:1.575;margin-top:0pt;margin-bottom:10pt"><span style="font-size:13px;font-family:Arial;vertical-align:baseline;white-space:pre-wrap">Any changes done to the RPC infrastructure will require a restart of apache, since all of the python code is loaded only once when apache first starts.  This means that any updates to the code done after apache is started won’t be used or seen.  To solve this, one can gracefully restart apache by running </span><span style="font-size:13px;font-family:Courier New;vertical-align:baseline;white-space:pre-wrap">sudo /etc/init.d/apache2 reload</span><span style="font-size:13px;font-family:Arial;vertical-align:baseline;white-space:pre-wrap">.  Any CLs that you write that touch RPC-related code should include the line </span><span style="font-size:13px;font-family:Courier New;vertical-align:baseline;white-space:pre-wrap">DEPLOY=apache </span><span style="font-size:13px;font-family:Arial;vertical-align:baseline;white-space:pre-wrap">to indicate to whoever is pushing that this step needs to be done.</span></p><p dir="ltr" style="line-height:1.575;margin-top:0pt;margin-bottom:10pt"><span style="font-size:13px;font-family:Arial;vertical-align:baseline;white-space:pre-wrap">Data being sent and received by an RPC is serialized in json format, as can be seen in </span><span style="font-size:13px;font-family:Courier New;vertical-align:baseline;white-space:pre-wrap">frontend/afe/json_rpc/serviceHandler.py</span><span style="font-size:13px;font-family:Arial;vertical-align:baseline;white-space:pre-wrap">. The RPCs expect a JSON object of the form </span><span style="font-size:13px;font-family:Courier New;vertical-align:baseline;white-space:pre-wrap">{'id':int, 'method':string, 'params':[JSON]}</span><span style="font-size:13px;font-family:Arial;vertical-align:baseline;white-space:pre-wrap">. A response is sent back in the form </span><span style="font-size:13px;font-family:Courier New;vertical-align:baseline;white-space:pre-wrap">{'id':int, 'result':JSON, 'error':{'name':string, 'message':string, 'traceback':string}}</span><span style="font-size:13px;font-family:Arial;vertical-align:baseline;white-space:pre-wrap">.</span></p><p dir="ltr" style="line-height:1.575;margin-top:0pt;margin-bottom:10pt"><span style="font-size:13px;font-family:Arial;vertical-align:baseline;white-space:pre-wrap">As a client, to call an RPC it is preferable to use the wrapper declared in </span><span style="font-size:13px;font-family:Courier New;vertical-align:baseline;white-space:pre-wrap">autotest_lib.server.frontend.AFE</span><span style="font-size:13px;font-family:Arial;vertical-align:baseline;white-space:pre-wrap">. It automatically deduces the correct server from your global/shadow config, and wraps around the more bare client-side RPC interface in </span><span style="font-size:13px;font-family:Courier New;vertical-align:baseline;white-space:pre-wrap">frontend/afe/json_rpc/proxy.py</span><span style="font-size:13px;font-family:Arial;vertical-align:baseline;white-space:pre-wrap">.</span></p><h3 dir="ltr" style="line-height:1.575;margin-top:13pt;margin-bottom:13pt"><a name="TOC-RPCs"></a><span style="font-size:15px;font-family:Arial;vertical-align:baseline;white-space:pre-wrap">RPCs</span></h3><p dir="ltr" style="line-height:1.575;margin-top:0pt;margin-bottom:10pt"><span style="font-size:13px;font-family:Arial;vertical-align:baseline;white-space:pre-wrap">We use RPCs to provide a layer between database access and data querying. This allows use to enforce ACLs, centralize logic to ensure that the operation that is about to be done is sane, and to allow the underlying data representation to change without having to change code everywhere.</span></p><p dir="ltr" style="line-height:1.575;margin-top:0pt;margin-bottom:10pt"><span style="font-size:13px;font-family:Arial;vertical-align:baseline;white-space:pre-wrap">The RPCs that we have allow for create/get/update/delete operations to be done on most data that one would find important (hosts, labels, jobs, host queue entries, etc.). Very straightforward examples of these can be found by looking at the ./cli/atest source code.</span></p><p dir="ltr" style="line-height:1.575;margin-top:0pt;margin-bottom:10pt"><span style="font-size:13px;font-family:Arial;vertical-align:baseline;white-space:pre-wrap">If you take a look at the functions defined in </span><span style="font-size:13px;font-family:Courier New;vertical-align:baseline;white-space:pre-wrap">rpc_interface.py</span><span style="font-size:13px;font-family:Arial;vertical-align:baseline;white-space:pre-wrap">, you'll see that most of the get methods take an argument of </span><span style="font-size:13px;font-family:Courier New;vertical-align:baseline;white-space:pre-wrap">filter_data</span><span style="font-size:13px;font-family:Arial;vertical-align:baseline;white-space:pre-wrap">. This argument is then passed directly to the django models call, so everything that is allowed as a parameter on a django </span><span style="font-size:13px;font-family:Courier New;vertical-align:baseline;white-space:pre-wrap">filter()</span><span style="font-size:13px;font-family:Arial;vertical-align:baseline;white-space:pre-wrap"> call (ie.</span><span style="font-size:13px;font-family:Courier New;vertical-align:baseline;white-space:pre-wrap">__startswith</span><span style="font-size:13px;font-family:Arial;vertical-align:baseline;white-space:pre-wrap">, </span><span style="font-size:13px;font-family:Courier New;vertical-align:baseline;white-space:pre-wrap">__in</span><span style="font-size:13px;font-family:Arial;vertical-align:baseline;white-space:pre-wrap">, etc.) is valid to pass here. Slightly sadly though, this does mean that the RPCs do not completely abstract one from the underlying schema of the database tables.</span></p><p dir="ltr" style="line-height:1.575;margin-top:0pt;margin-bottom:10pt"><span style="font-size:13px;font-family:Arial;vertical-align:baseline;white-space:pre-wrap">Two very notable RPCs are the </span><span style="font-size:13px;font-family:Courier New;vertical-align:baseline;white-space:pre-wrap">create_job</span><span style="font-size:13px;font-family:Arial;vertical-align:baseline;white-space:pre-wrap"> call in </span><span style="font-size:13px;font-family:Courier New;vertical-align:baseline;white-space:pre-wrap">rpc_interface</span><span style="font-size:13px;font-family:Arial;vertical-align:baseline;white-space:pre-wrap"> and </span><span style="font-size:13px;font-family:Courier New;vertical-align:baseline;white-space:pre-wrap">create_suite_job</span><span style="font-size:13px;font-family:Arial;vertical-align:baseline;white-space:pre-wrap"> in</span><span style="font-size:13px;font-family:Courier New;vertical-align:baseline;white-space:pre-wrap">site_rpc_interface</span><span style="font-size:13px;font-family:Arial;vertical-align:baseline;white-space:pre-wrap">. This is the only place in autotest where jobs are created. Any special handling of job creation, such as parsing out METAVARs, or ensuring control file sanity, can be done at this point to enforce that only correctly formed control files will make it into the system.</span></p><p dir="ltr" style="line-height:1.575;margin-top:0pt;margin-bottom:10pt"><span style="font-size:13px;font-family:Arial;vertical-align:baseline;white-space:pre-wrap">The set of RPCs exposed doesn't have much functionality beyond just asking for a piece of data to be immediately returned or modified. This means that we have large parts of the system that sit and poll to see if an event has happened, instead of being able to wait for the completion of an event. Attempting to create a synchronous RPC, for example, one that creates a job, and returns once the job is done would be much more difficult, as everything goes down to MySQL in the end, and MySQL has no way to support notifying a piece of python code that a value has changed. (Or, at least, I don't know how to use triggers to do this.)</span></p><p dir="ltr" style="line-height:1.575;margin-top:0pt;margin-bottom:10pt"><span style="font-size:13px;font-family:Arial;vertical-align:baseline;white-space:pre-wrap">It should be noted that TKO has its own set of RPCs, generally used to access data in </span><span style="font-size:13px;font-family:Courier New;vertical-align:baseline;white-space:pre-wrap">tko_*</span><span style="font-size:13px;font-family:Arial;vertical-align:baseline;white-space:pre-wrap"> tables, uses of these don't come up quite as frequently in the code, but a notable case is </span><span style="font-size:13px;font-family:Courier New;vertical-align:baseline;white-space:pre-wrap">run_suite.py</span><span style="font-size:13px;font-family:Arial;vertical-align:baseline;white-space:pre-wrap">, which gets is information about the suite that ran by querying the </span><span style="font-size:13px;font-family:Courier New;vertical-align:baseline;white-space:pre-wrap">get_detailed_test_view</span><span style="font-size:13px;font-family:Arial;vertical-align:baseline;white-space:pre-wrap"> TKO RPC.</span></p><p dir="ltr" style="line-height:1.575;margin-top:0pt;margin-bottom:10pt"><span style="font-size:13px;font-family:Arial;vertical-align:baseline;white-space:pre-wrap">To add a new RPC, one would simply just add a new normal python function to </span><span style="font-size:13px;font-family:Courier New;vertical-align:baseline;white-space:pre-wrap">site_rpc_interface.py</span><span style="font-size:13px;font-family:Arial;vertical-align:baseline;white-space:pre-wrap">. The only restriction is that the return value of the function must be JSON serializable. It'd be a good idea to look at </span><span style="font-size:13px;font-family:Courier New;vertical-align:baseline;white-space:pre-wrap">frontend/afe/rpc_utils.py</span><span style="font-size:13px;font-family:Arial;vertical-align:baseline;white-space:pre-wrap"> to see if there's any relevant functionality that'd be useful. Specifically, if you're just wrapping around a django model query, you can use the </span><span style="font-size:13px;font-family:Courier New;vertical-align:baseline;white-space:pre-wrap">prepare_for_serialization</span><span style="font-size:13px;font-family:Arial;vertical-align:baseline;white-space:pre-wrap"> function to massage the returned django model objects into JSON.</span></p><div><span style="font-size:13px;font-family:Arial;vertical-align:baseline;white-space:pre-wrap"><br /></span></div></span></div></td></tr></tbody></table>
</div> 
</div> 
<div id="sites-canvas-bottom-panel">
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_page-subpages"> </div>
<div id="sites-attachments-container">
</div>
<a xmlns="http://www.w3.org/1999/xhtml" name="page-comments"></a>
<div xmlns="http://www.w3.org/1999/xhtml" id="COMP_page-comments"><div class="sites-comment-docos-wrapper"><div class="sites-comment-docos"><div class="sites-comment-docos-background"></div><div class="sites-comment-docos-header"><div class="sites-comment-docos-header-title">Comments</div></div><div id="sites-comment-docos-pane" class="sites-comment-docos-pane"></div></div></div></div>
</div>
</div> 
</td> 
</tr>
</table> 
</div> 
</div> 
<div id="sites-chrome-footer-wrapper">
<div id="sites-chrome-footer-wrapper-inside">
<div id="sites-chrome-footer">
</div>
</div>
</div>
</div> 
</div> 
<div id="sites-chrome-adminfooter-container">
<div xmlns="http://www.w3.org/1999/xhtml" class="sites-adminfooter" role="navigation"><p><a class="sites-system-link" href="https://www.google.com/a/UniversalLogin?service=jotspot&amp;continue=https://sites.google.com/a/chromium.org/dev/chromium-os/testing/afe-rpc-infrastructure">Sign in</a><span aria-hidden="true">|</span><a class="sites-system-link" href="../../system/app/pages/recentChanges.html">Recent Site Activity</a><span aria-hidden="true">|</span><a class="sites-system-link" href="../../system/app/pages/reportAbuse.html" target="_blank">Report Abuse</a><span aria-hidden="true">|</span><a class="sites-system-link" href="javascript:;" onclick="window.open(webspace.printUrl)">Print Page</a><span aria-hidden="true">|</span><span class="sites-system-link">Powered By</span> <b class="powered-by"><a href="http://sites.google.com">Google Sites</a></b></p></div>
</div>
</div> 
</div> 
<div id="sites-chrome-onebar-footer">
</div>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
    window.jstiming.load.tick('sjl');
  </script>
<script xmlns="http://www.w3.org/1999/xhtml" src="https://ssl.gstatic.com/sites/p/56e332/system/js/jot_min_view__en.js"></script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
    window.jstiming.load.tick('jl');
  </script>
<script xmlns="http://www.w3.org/1999/xhtml">
      
          sites.core.Analytics.createTracker();
          sites.core.Analytics.trackPageview();
        
    </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
                    sites.Searchbox.initialize(
                        'sites-searchbox-search-button',
                        {"object":[]}['object'],
                        'search-site',
                        {"label":"Configure search options...","url":"/system/app/pages/admin/settings"});
                  </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
      gsites.HoverPopupMenu.createSiteDropdownMenus('sites-header-nav-dropdown', false);
    </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript" defer="true">
            JOT_setupNav("7648876402527094", "Navigation", false);
            JOT_addListener('titleChange', 'JOT_NAVIGATION_titleChange', 'COMP_7648876402527094');
          </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript" defer="true">
            JOT_setupNav("14720868319272995", "Quick links", false);
            JOT_addListener('titleChange', 'JOT_NAVIGATION_titleChange', 'COMP_14720868319272995');
          </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript" defer="true">
            JOT_setupNav("19690813310444355", "Other sites", false);
            JOT_addListener('titleChange', 'JOT_NAVIGATION_titleChange', 'COMP_19690813310444355');
          </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
              new sites.CommentPane('//docs.google.com/comments/d/AAHRpnXvrAwjAfmld0ObrebBiGRq9inGavgwuQOADI3_kzbapXgcF1DQLNDrhm5X76RLZHnXnW2TwAS5pyQuv-iz3_asliZjRhTTB61K5ym9p8uV6XlLiBnQA_L5huc90c6ftZYitwqIC/api/js?anon=true',
                  false, false);
            </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
  setTimeout(function() {
    var fingerprint = gsites.date.TimeZone.getFingerprint([]);
    gsites.Xhr.send('https://www.chromium.org/_/tz', null, null, 'GET', null, null, { afjstz: fingerprint });
  }, 500);
</script>
<script xmlns="http://www.w3.org/1999/xhtml">
                    window.onload = function() {
                      if (false) {
                        JOT_setMobilePreview();
                      }
                      var loadTimer = window.jstiming.load;
                      loadTimer.tick("ol");
                      loadTimer["name"] = "load," + webspace.page.type + ",user_page";
                      window.jstiming.report(loadTimer, {}, 'https://gg.google.com/csi');
                    }
                  </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
        JOT_insertAnalyticsCode(false,
            false);
      </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
    var maestroRunner = new gsites.pages.view.SitesMaestroRunner(
        webspace, "en");
    maestroRunner.initListeners();
    maestroRunner.installEditRender();
  </script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript" defer="true">
  //<![CDATA[
    // Decorate any fastUI buttons on the page with a class of 'goog-button'.
    if (webspace.user.hasWriteAccess) {
      JOT_decorateButtons();
    }

    // Fires delayed events.
    (function() {
      JOT_fullyLoaded = true;
      var delayedEvents = JOT_delayedEvents;
      for (var x = 0; x < delayedEvents.length; x++) {
        var event = delayedEvents[x];
        JOT_postEvent(event.eventName, event.eventSrc, event.payload);
      }
      JOT_delayedEvents = null;
      JOT_postEvent('pageLoaded');
    })();
  //]]>
</script>
<script xmlns="http://www.w3.org/1999/xhtml" type="text/javascript">
    JOT_postEvent('decorateGvizCharts');
  </script>
<script type="text/javascript">
          JOT_setupPostRenderingManager();
        </script>
<script type="text/javascript">
          JOT_postEvent('renderPlus', null, 'sites-chrome-main');
        </script>
<div id="server-timer-div" style="display:none"> </div>
<script type="text/javascript">
          window.jstiming.load.tick('render');
          JOT_postEvent('usercontentrendered', this);
        </script>
</body>
</html>
